console.error("failed to init wizAssets");
window.wizAssets = null;
e();
window.isoEngine = new e();
window.actorManager = window.isoEngine.actorManager;
window.background = window.isoEngine.background;
window.performanceMonitor = new g();
i(1);
i(2);
i(3);
i(4);
i(5);
i(6);
window.developmentMode = !1;
window.buildVersion = "1.57.11";
console.log("Production variant is active");
a.isAndroid && window.MobileAccessibility && window.MobileAccessibility.usePreferredTextZoom(!1);
Event.prototype.oldPreventDefault || (Event.prototype.oldPreventDefault = Event.prototype.preventDefault, Event.prototype.preventDefault = function () {
  this.cancelable && this.oldPreventDefault();
});
window.assetPreloader = i(12);
window.dofus = i(34);
u.id = "resizableBody";
document.body.appendChild(u);
h.id = "dofusBody";
u.appendChild(h);
window.gui = new m();
window.foreground = new p();
a.capacity = e.capacity;
n(o);
this.map = {};
e instanceof a ? e.forEach(function (e, t) {
  this.append(t, e);
}, this) : Array.isArray(e) ? e.forEach(function (e) {
  this.append(e[0], e[1]);
}, this) : e && Object.getOwnPropertyNames(e).forEach(function (t) {
  this.append(t, e[t]);
}, this);
e.onload = function () {
  t(e.result);
};
e.onerror = function () {
  i(e.error);
};
this._bodyInit = e;
e ? "string" == typeof e ? this._bodyText = e : y.blob && Blob.prototype.isPrototypeOf(e) ? this._bodyBlob = e : y.formData && FormData.prototype.isPrototypeOf(e) ? this._bodyFormData = e : y.searchParams && URLSearchParams.prototype.isPrototypeOf(e) ? this._bodyText = e.toString() : y.arrayBuffer && y.blob && t(e) ? (this._bodyArrayBuffer = u(e.buffer), this._bodyInit = new Blob([this._bodyArrayBuffer])) : y.arrayBuffer && (ArrayBuffer.prototype.isPrototypeOf(e) || b(e)) ? this._bodyArrayBuffer = u(e) : this._bodyText = e = Object.prototype.toString.call(e) : this._bodyText = "";
this.headers.get("content-type") || ("string" == typeof e ? this.headers.set("content-type", "text/plain;charset=UTF-8") : this._bodyBlob && this._bodyBlob.type ? this.headers.set("content-type", this._bodyBlob.type) : y.searchParams && URLSearchParams.prototype.isPrototypeOf(e) && this.headers.set("content-type", "application/x-www-form-urlencoded;charset=UTF-8"));
this.url = e.url;
this.credentials = e.credentials;
t.headers || (this.headers = new a(e.headers));
this.method = e.method;
this.mode = e.mode;
this.signal = e.signal;
i || null == e._bodyInit || (i = e._bodyInit, e.bodyUsed = !0);
t || (t = {});
this.type = "default";
this.status = void 0 === t.status ? 200 : t.status;
this.ok = this.status >= 200 && this.status < 300;
this.statusText = "statusText" in t ? t.statusText : "OK";
this.headers = new a(t.headers);
this.url = t.url || "";
this._initBody(e);
r.onload = function () {
  var e = {
    status: r.status,
    statusText: r.statusText,
    headers: g(r.getAllResponseHeaders() || "")
  };
  e.url = "responseURL" in r ? r.responseURL : e.headers.get("X-Request-URL");
  var t = "response" in r ? r.response : r.responseText;
  n(new _(t, e));
};
r.onerror = function () {
  o(new TypeError("Network request failed"));
};
r.ontimeout = function () {
  o(new TypeError("Network request failed"));
};
r.onabort = function () {
  o(new e.DOMException("Aborted", "AbortError"));
};
r.open(s.method, s.url, !0);
"include" === s.credentials ? r.withCredentials = !0 : "omit" === s.credentials && (r.withCredentials = !1);
"responseType" in r && y.blob && (r.responseType = "blob");
s.headers.forEach(function (e, t) {
  r.setRequestHeader(t, e);
});
s.signal && (s.signal.addEventListener("abort", a), r.onreadystatechange = function () {
  4 === r.readyState && s.signal.removeEventListener("abort", a);
});
r.send("undefined" == typeof s._bodyInit ? null : s._bodyInit);
a.prototype.append = function (e, t) {
  e = i(e);
  t = n(t);
  var o = this.map[e];
  this.map[e] = o ? o + ", " + t : t;
};
a.prototype["delete"] = function (e) {
  delete this.map[i(e)];
};
a.prototype.get = function (e) {
  return e = i(e), this.has(e) ? this.map[e] : null;
};
a.prototype.has = function (e) {
  return this.map.hasOwnProperty(i(e));
};
a.prototype.set = function (e, t) {
  this.map[i(e)] = n(t);
};
a.prototype.forEach = function (e, t) {
  for (var i in this.map) {
    this.map.hasOwnProperty(i) && e.call(t, this.map[i], i, this);
  }
};
a.prototype.keys = function () {
  var e = [];
  return this.forEach(function (t, i) {
    e.push(i);
  }), o(e);
};
a.prototype.values = function () {
  var e = [];
  return this.forEach(function (t) {
    e.push(t);
  }), o(e);
};
a.prototype.entries = function () {
  var e = [];
  return this.forEach(function (t, i) {
    e.push([i, t]);
  }), o(e);
};
y.iterable && (a.prototype[Symbol.iterator] = a.prototype.entries);
e = i(e);
t = n(t);
m.prototype.clone = function () {
  return new m(this, {
    body: this._bodyInit
  });
};
h.call(m.prototype);
h.call(_.prototype);
_.prototype.clone = function () {
  return new _(this._bodyInit, {
    status: this.status,
    statusText: this.statusText,
    headers: new a(this.headers),
    url: this.url
  });
};
_.error = function () {
  var e = new _(null, {
    status: 0,
    statusText: ""
  });
  return e.type = "error", e;
};
_.redirect = function (e, t) {
  if (T.indexOf(t) === -1) {
    throw new RangeError("Invalid status code");
  }
  return new _(null, {
    status: t,
    headers: {
      location: e
    }
  });
};
e.DOMException = self.DOMException;
e.DOMException = function (e, t) {
  this.message = e;
  this.name = t;
  var i = Error(e);
  this.stack = i.stack;
};
e.DOMException.prototype = Object.create(Error.prototype);
e.DOMException.prototype.constructor = e.DOMException;
this.message = e;
this.name = t;
v.polyfill = !0;
self.fetch || (self.fetch = v, self.Headers = a, self.Request = m, self.Response = _);
e.Headers = a;
e.Request = m;
e.Response = _;
e.fetch = v;
Object.defineProperty(e, "__esModule", {
  value: !0
});
"function" != typeof String.prototype.startsWith && (String.prototype.startsWith = function (e, t) {
  return void 0 === t && (t = 0), this.slice(t, e.length + t) === e;
});
"function" != typeof String.prototype.endsWith && (String.prototype.endsWith = function (e, t) {
  var i = this.toString();
  (void 0 === t || t > i.length) && (t = i.length);
  t -= e.length;
  var n = i.indexOf(e, t);
  return n !== -1 && n === t;
});
"function" != typeof Number.isInteger && (Number.isInteger = function (e) {
  return "number" == typeof e && isFinite(e) && Math.floor(e) === e;
});
(void 0 === t || t > i.length) && (t = i.length);
t -= e.length;
d <= 65535 ? s.push(d) : (d -= 65536, n = (d >> 10) + 55296, o = d % 1024 + 56320, s.push(n, o));
(r + 1 == l || s.length > a) && (c += t.apply(null, s), s.length = 0);
t.identifier = [c.cordova || "", c.isVirtual || "", c.model || "", d, c.version || "", c.uuid || "", c.serial || ""].join("|");
t.osName = d || r.name || "";
t.isIOS = "iOS" === t.osName;
t.isAndroid = "Android" === t.osName;
t.isDevice = t.isIOS || t.isAndroid;
t.isCordova = Boolean(window.cordova || window.PhoneGap || window.phonegap);
t.isPhoneGap = t.isCordova;
t.isIpad2 = l && "iPad2," === window.device.model.substr(0, 6);
t.os = t.osName.toLowerCase();
t.isIOSApp = "iOS" === d;
t.isAndroidApp = "Android" === d;
t.isAndroidSoonDeprecatedVersion = o.isItThatModel("Android", "5.0", a, window.device);
t.isIosSoonDeprecatedVersion = o.isItThatModel("iOS", "9", a, window.device) || o.isItThatModel("iOS", "10", a, window.device);
l = r[++n];
s = p[o];
typeof s === u && s.length > 0 ? 2 == s.length ? typeof s[1] == c ? this[s[0]] = s[1].call(this, l) : this[s[0]] = s[1] : 3 == s.length ? typeof s[1] !== c || s[1].exec && s[1].test ? this[s[0]] = l ? l.replace(s[1], s[2]) : a : this[s[0]] = l ? s[1].call(this, l, s[2]) : a : 4 == s.length && (this[s[0]] = l ? s[3].call(this, l.replace(s[1], s[2])) : a) : this[s] = l ? l : a;
x.VERSION = s;
x.BROWSER = {
  NAME: f,
  MAJOR: p,
  VERSION: v
};
x.CPU = {
  ARCHITECTURE: y
};
x.DEVICE = {
  MODEL: m,
  VENDOR: _,
  TYPE: g,
  CONSOLE: w,
  MOBILE: b,
  SMARTTV: T,
  TABLET: M,
  WEARABLE: C,
  EMBEDDED: I
};
x.ENGINE = {
  NAME: f,
  VERSION: v
};
x.OS = {
  NAME: f,
  VERSION: v
};
typeof t !== d ? (typeof e !== d && e.exports && (t = e.exports = x), t.UAParser = x) : (n = function () {
  return x;
}.call(t, i, t, e), !(n !== a && (e.exports = n)));
L.ua = O.getResult();
L.ua.get = function () {
  return O.getUA();
};
L.ua.set = function (e) {
  O.setUA(e);
  var t = O.getResult();
  for (var i in t) {
    L.ua[i] = t[i];
  }
};
K("SemVer", e, t);
this.loose = t;
i[4] ? this.prerelease = i[4].split(".").map(function (e) {
  if (/^[0-9]+$/.test(e)) {
    var t = +e;
    if (t >= 0 && t < Z) {
      return t;
    }
  }
  return e;
}) : this.prerelease = [];
this.build = i[5] ? i[5].split(".") : [];
this.format();
"object" == typeof e && (e = e.version);
"object" == typeof i && (i = i.version);
o = e === i;
"object" == typeof e && (e = e.version);
"object" == typeof i && (i = i.version);
o = e !== i;
e = new s(e, n);
t = new S(t, n);
o = y;
a = C;
r = w;
l = ">";
c = ">=";
o = w;
a = T;
r = y;
l = "<";
c = "<=";
e.semver === Ye && (e = new A(">=0.0.0"));
h = h || e;
p = p || e;
o(e.semver, h.semver, n) ? h = e : r(e.semver, p.semver, n) && (p = e);
K = "object" == typeof i && i.env && i.env.NODE_DEBUG && /\bsemver\b/i.test(i.env.NODE_DEBUG) ? function () {
  var e = Array.prototype.slice.call(arguments, 0);
  e.unshift("SEMVER");
  console.log.apply(console, e);
} : function () {};
t.SEMVER_SPEC_VERSION = "2.0.0";
e.unshift("SEMVER");
console.log.apply(console, e);
te[Se] = "(\\s*)" + te[Ae] + "\\s+";
ee[Se] = new RegExp(te[Se], "g");
te[Oe] = "(\\s*)" + te[Le] + "\\s+";
ee[Oe] = new RegExp(te[Oe], "g");
te[Fe] = "(\\s*)" + te[ve] + "\\s*(" + ge + "|" + te[be] + ")";
ee[Fe] = new RegExp(te[Fe], "g");
K(Ue, te[Ue]);
ee[Ue] || (ee[Ue] = new RegExp(te[Ue]));
t.parse = n;
t.valid = o;
t.clean = a;
t.SemVer = s;
s.prototype.format = function () {
  return this.version = this.major + "." + this.minor + "." + this.patch, this.prerelease.length && (this.version += "-" + this.prerelease.join(".")), this.version;
};
s.prototype.toString = function () {
  return this.version;
};
s.prototype.compare = function (e) {
  return K("SemVer.compare", this.version, this.loose, e), e instanceof s || (e = new s(e, this.loose)), this.compareMain(e) || this.comparePre(e);
};
s.prototype.compareMain = function (e) {
  return e instanceof s || (e = new s(e, this.loose)), c(this.major, e.major) || c(this.minor, e.minor) || c(this.patch, e.patch);
};
s.prototype.comparePre = function (e) {
  if (e instanceof s || (e = new s(e, this.loose)), this.prerelease.length && !e.prerelease.length) {
    return -1;
  }
  if (!this.prerelease.length && e.prerelease.length) {
    return 1;
  }
  if (!this.prerelease.length && !e.prerelease.length) {
    return 0;
  }
  var t = 0;
  do {
    var i = this.prerelease[t],
      n = e.prerelease[t];
    if (K("prerelease compare", t, i, n), void 0 === i && void 0 === n) {
      return 0;
    }
    if (void 0 === n) {
      return 1;
    }
    if (void 0 === i) {
      return -1;
    }
    if (i !== n) {
      return c(i, n);
    }
  } while (++t);
};
s.prototype.inc = function (e, t) {
  switch (e) {
    case "premajor":
      this.prerelease.length = 0;
      this.patch = 0;
      this.minor = 0;
      this.major++;
      this.inc("pre", t);
      break;
    case "preminor":
      this.prerelease.length = 0;
      this.patch = 0;
      this.minor++;
      this.inc("pre", t);
      break;
    case "prepatch":
      this.prerelease.length = 0;
      this.inc("patch", t);
      this.inc("pre", t);
      break;
    case "prerelease":
      0 === this.prerelease.length && this.inc("patch", t);
      this.inc("pre", t);
      break;
    case "major":
      0 === this.minor && 0 === this.patch && 0 !== this.prerelease.length || this.major++;
      this.minor = 0;
      this.patch = 0;
      this.prerelease = [];
      break;
    case "minor":
      0 === this.patch && 0 !== this.prerelease.length || this.minor++;
      this.patch = 0;
      this.prerelease = [];
      break;
    case "patch":
      0 === this.prerelease.length && this.patch++;
      this.prerelease = [];
      break;
    case "pre":
      if (0 === this.prerelease.length) {
        this.prerelease = [0];
      } else {
        for (var i = this.prerelease.length; --i >= 0;) {
          "number" == typeof this.prerelease[i] && (this.prerelease[i]++, i = -2);
        }
        i === -1 && this.prerelease.push(0);
      }
      t && (this.prerelease[0] === t ? isNaN(this.prerelease[1]) && (this.prerelease = [t, 0]) : this.prerelease = [t, 0]);
      break;
    default:
      throw new Error("invalid increment argument: " + e);
  }
  return this.format(), this.raw = this.version, this;
};
t.inc = r;
t.diff = l;
t.compareIdentifiers = c;
this.prerelease.length = 0;
this.patch = 0;
this.minor = 0;
this.major++;
this.inc("pre", t);
this.prerelease.length = 0;
this.patch = 0;
this.minor++;
this.inc("pre", t);
this.prerelease.length = 0;
this.inc("patch", t);
this.inc("pre", t);
0 === this.prerelease.length && this.inc("patch", t);
this.inc("pre", t);
0 === this.minor && 0 === this.patch && 0 !== this.prerelease.length || this.major++;
this.minor = 0;
this.patch = 0;
this.prerelease = [];
0 === this.patch && 0 !== this.prerelease.length || this.minor++;
this.patch = 0;
this.prerelease = [];
0 === this.prerelease.length && this.patch++;
this.prerelease = [];
t.rcompareIdentifiers = d;
t.major = u;
t.minor = h;
t.patch = p;
t.compare = m;
t.compareLoose = f;
t.rcompare = g;
t.sort = _;
t.rsort = v;
t.gt = y;
t.lt = w;
t.eq = b;
t.neq = M;
t.gte = T;
t.lte = C;
t.cmp = I;
t.Comparator = A;
A.prototype.parse = function (e) {
  var t = this.loose ? ee[Be] : ee[ke],
    i = e.match(t);
  if (!i) {
    throw new TypeError("Invalid comparator: " + e);
  }
  this.operator = i[1];
  "=" === this.operator && (this.operator = "");
  i[2] ? this.semver = new s(i[2], this.loose) : this.semver = Ye;
};
A.prototype.toString = function () {
  return this.value;
};
A.prototype.test = function (e) {
  return K("Comparator.test", e, this.loose), this.semver === Ye || ("string" == typeof e && (e = new s(e, this.loose)), I(e, this.operator, this.semver, this.loose));
};
A.prototype.intersects = function (e, t) {
  if (!(e instanceof A)) {
    throw new TypeError("a Comparator is required");
  }
  var i;
  if ("" === this.operator) {
    return i = new S(e.value, t), z(this.value, i, t);
  }
  if ("" === e.operator) {
    return i = new S(this.value, t), z(e.semver, i, t);
  }
  var n = !(">=" !== this.operator && ">" !== this.operator || ">=" !== e.operator && ">" !== e.operator),
    o = !("<=" !== this.operator && "<" !== this.operator || "<=" !== e.operator && "<" !== e.operator),
    a = this.semver.version === e.semver.version,
    s = !(">=" !== this.operator && "<=" !== this.operator || ">=" !== e.operator && "<=" !== e.operator),
    r = I(this.semver, "<", e.semver, t) && (">=" === this.operator || ">" === this.operator) && ("<=" === e.operator || "<" === e.operator),
    l = I(this.semver, ">", e.semver, t) && ("<=" === this.operator || "<" === this.operator) && (">=" === e.operator || ">" === e.operator);
  return n || o || a && s || r || l;
};
t.Range = S;
S.prototype.format = function () {
  return this.range = this.set.map(function (e) {
    return e.join(" ").trim();
  }).join("||").trim(), this.range;
};
S.prototype.toString = function () {
  return this.range;
};
S.prototype.parseRange = function (e) {
  var t = this.loose;
  e = e.trim();
  K("range", e, t);
  var i = t ? ee[We] : ee[ze];
  e = e.replace(i, F);
  K("hyphen replace", e);
  e = e.replace(ee[Fe], He);
  K("comparator trim", e, ee[Fe]);
  e = e.replace(ee[Se], Ee);
  e = e.replace(ee[Oe], Re);
  e = e.split(/\s+/).join(" ");
  var n = t ? ee[Be] : ee[ke],
    o = e.split(" ").map(function (e) {
      return N(e, t);
    }).join(" ").split(/\s+/);
  return this.loose && (o = o.filter(function (e) {
    return !!e.match(n);
  })), o = o.map(function (e) {
    return new A(e, t);
  });
};
S.prototype.intersects = function (e, t) {
  if (!(e instanceof S)) {
    throw new TypeError("a Range is required");
  }
  return this.set.some(function (i) {
    return i.every(function (i) {
      return e.set.some(function (e) {
        return e.every(function (e) {
          return i.intersects(e, t);
        });
      });
    });
  });
};
t.toComparators = E;
S.prototype.test = function (e) {
  if (!e) {
    return !1;
  }
  "string" == typeof e && (e = new s(e, this.loose));
  for (var t = 0; t < this.set.length; t++) {
    if (H(this.set[t], e)) {
      return !0;
    }
  }
  return !1;
};
t.satisfies = z;
t.maxSatisfying = W;
t.minSatisfying = G;
t.validRange = U;
t.ltr = q;
t.gtr = Y;
t.outside = j;
t.prerelease = V;
t.intersects = X;
t.coerce = Q;
this.operator = i[1];
"=" === this.operator && (this.operator = "");
i[2] ? this.semver = new s(i[2], this.loose) : this.semver = Ye;
e = e.trim();
K("range", e, t);
e = e.replace(i, F);
K("hyphen replace", e);
e = e.replace(ee[Fe], He);
K("comparator trim", e, ee[Fe]);
e = e.replace(ee[Se], Ee);
e = e.replace(ee[Oe], Re);
e = e.split(/\s+/).join(" ");
g = -1;
t = m.length;
p = null;
f = !1;
a(e);
this.fun = e;
this.array = t;
h.nextTick = function (e) {
  var t = new Array(arguments.length - 1);
  if (arguments.length > 1) {
    for (var i = 1; i < arguments.length; i++) {
      t[i - 1] = arguments[i];
    }
  }
  m.push(new l(e, t));
  1 !== m.length || f || o(r);
};
l.prototype.run = function () {
  this.fun.apply(null, this.array);
};
h.title = "browser";
h.browser = !0;
h.env = {};
h.argv = [];
h.version = "";
h.versions = {};
h.on = c;
h.addListener = c;
h.once = c;
h.off = c;
h.removeListener = c;
h.removeAllListeners = c;
h.emit = c;
h.prependListener = c;
h.prependOnceListener = c;
h.listeners = function (e) {
  return [];
};
h.binding = function (e) {
  throw new Error("process.binding is not supported");
};
h.cwd = function () {
  return "/";
};
h.chdir = function (e) {
  throw new Error("process.chdir is not supported");
};
h.umask = function () {
  return 0;
};
m.push(new l(e, t));
1 !== m.length || f || o(r);
this.url = e;
this.cssFormat = t;
this.callback = i;
this.loadBatchIndex = n;
a = i ? s.cssFormat ? w(i) : i : null;
r && r(a, l);
delete A[t];
E -= 1;
u();
0 === N && x(n, 0);
N < C ? (N += 1, e(t, i, o, a)) : x(function () {
  m(e, t, i, o, a);
}, 0);
a.onload = function () {
  return this.onload = null, this.onerror = null, i(this, n);
};
a.onerror = function () {
  return s -= 1, s > 0 ? void (this.src = t) : (this.onload = null, this.onerror = null, r(e) && (console.error("loadAndCreateImage: Image not found: " + t), window.wizAssets.deleteFile(e, function () {}, function (e) {
    console.error("loadAndCreateImage: Image could not be deleted: " + t + " with error: " + e);
  })), i(_.EMPTY_IMAGE, n));
};
a.src = t;
a.onreadystatechange = function () {
  if (4 === ~~a.readyState) {
    if (200 !== ~~a.status && 0 !== ~~a.status) {
      return o -= 1, o > 0 ? (a.open("GET", t, !0), void a.send()) : (s(e) || console.error("loadAndParseJson: Failed to load json " + t + ": " + a.status), i(_.EMPTY_JSON, n));
    }
    var l;
    try {
      l = JSON.parse(a.response);
    } catch (c) {
      return r(e) && (console.error("loadAndParseJson: Could not parse json " + t + ": " + c), window.wizAssets.deleteFile(e, function () {}, function (e) {
        console.error("loadAndParseJson: json could not be deleted: " + t + " with error: " + e);
      })), i(_.EMPTY_JSON, n);
    }
    return i(l, n);
  }
};
a.open("GET", t, !0);
a.send();
t.preloadAsset = h;
t.preloadAssets = p;
t.preloadImages = function (e, t) {
  return p(e, !0, null, t);
};
t.preloadImage = function (e, t) {
  return h(e, !0, t);
};
t.preloadImageUrls = function (e, t) {
  return p(e, !1, null, t);
};
t.preloadImageUrl = function (e, t) {
  return h(e, !1, t);
};
t.loadImages = function (e, t, i) {
  function n(e, n) {
    if (o[n] = e, a += 1, t && t(e, n), a === s) {
      return i && i(o);
    }
  }
  var o = [],
    a = 0,
    s = e.length;
  return 0 === s ? i && i(o) : void p(e, !1, function (t, i) {
    m(f, e[i], t, n, i);
  }, null);
};
t.loadImage = function (e, t) {
  h(e, !1, function (i) {
    m(f, e, i, t);
  });
};
t.loadJsons = function (e, t, i) {
  p(e, !1, function (i, n) {
    m(g, e[n], i, t, n);
  }, i);
};
t.loadJson = function (e, t) {
  h(e, !1, function (i) {
    m(g, e, i, t);
  });
};
t.MAP_PATH = "maps/";
t.IMG_PATH = "gfx/world/";
t.SKIN_PATH = "skins/";
t.BONE_PATH = "bones/";
t.ICON_PATH = "gfx/icons/";
t.ORNAMENT_PATH = "gfx/ornaments/";
t.EMBEDDED_PATH = "ui/embedded/";
t.BACKGROUND_PATH = "backgrounds/";
t.FOREGROUND_PATH = "foregrounds/";
t.BITMAP_FONTS = "ui/bitmapFonts/";
t.WORLDMAP_PATH = "gfx/maps/";
t.LOADER_PATH = "ui/loader/";
t.MISSING_ANIM_PATH = "bones/missingAnimList.json";
t.CDV_PATH = "cdvfile://localhost/persistent/data/assets";
t.ITEM_DIR = "gfx/items/";
t.SPELL_DIR = "gfx/spells/";
t.MAP_SCENE_WIDTH_IN_CELLS = 14.5;
t.MAP_SCENE_HEIGHT_IN_CELLS = 20.5;
t.CELL_WIDTH = 86;
t.CELL_HEIGHT = 43;
t.CELL_SIDE = Math.sqrt(2 * t.CELL_HEIGHT * t.CELL_HEIGHT);
t.NB_CELLS = 560;
t.MAP_WIDTH = 14;
t.MAP_HEIGHT = 20;
t.ELEMENT_TYPE_ID = {
  UNSPECIFIED: -1,
  ZAAP: 16,
  PADDOCK: 120
};
t.BETA_SUFFIX = "beta.";
t.BETA_CACHE_FOLDER = "beta/";
t.HORIZONTAL_OFFSET = 53;
t.VERTICAL_OFFSET = 15;
t.WIDTH_PADDING = 20;
t.HEIGHT_PADDING = -16;
t.MAP_BORDER_H = 30;
t.MAP_BORDER_V = 20;
t.GRID_ALTITUDE_OFFSET = 22;
t.ICONBAR_CORNER_HEIGHT = 19;
t.ICONBAR_CORNER_WIDTH = 36;
t.ICONBAR_TAB_WIDTH = 42;
t.ICONBAR_TAB_HEIGHT = 35;
t.SHORTCUT_ICON_SIZE = 50;
t.MENU_ICON_SIZE = 42;
t.SHORTCUT_GAUGE_SIZE = 13;
t.CHAT_BTN_MIN_WIDTH = 68;
t.CHAT_BTN_MIN_HEIGHT = 50;
t.BONUS_PACK_XP = 150;
t.BONUS_PACK_DROP = 150;
t.BONUS_PACK_XPJOB = 50;
t.MARKETING_POPUP_LEVEL_LIMIT = 25;
t.BP_ELITE_LATAM = 14158;
t.BP_ELITE_ROW = 14346;
t.CATALYST_ITEM = 18516;
t.ALBUERA_VILLAGE_ACHIEVEMENT = 1250;
t.ALBUERA_FOREST_ACHIEVEMENT = 1252;
t.ALBUERA_DUNGEON_ACHIEVEMENT = 1258;
t.ASTRUB_ACHIEVEMENT = 341;
t.DEFAULT_ACTOR_X = 5 * -t.CELL_WIDTH;
t.DEFAULT_ACTOR_Y = 5 * -t.CELL_HEIGHT;
t.DEFAULT_ACTOR_SPEED = 5;
t.MAX_CHARACTER_LEVEL_FOR_TUTORIAL = 49;
t.WEAPON_SPELL_ID = 0;
t.INFINITE_CHARACTER = "∞";
t.PING_EMOTE_BTN_NARROW_MIN_WIDTH = 50;
t.PING_EMOTE_BTN_WIDE_MIN_HEIGHT = 50;
t.PING_EMOTE_BTN_WIDE_MIN_WIDTH = 60;
t.MAP_SCENE_WIDTH = t.CELL_WIDTH * t.MAP_SCENE_WIDTH_IN_CELLS + t.WIDTH_PADDING;
t.MAP_SCENE_HEIGHT = t.CELL_HEIGHT * t.MAP_SCENE_HEIGHT_IN_CELLS + t.HEIGHT_PADDING;
t.PIXEL_RATIO = a.devicePixelRatio ? Math.min(a.devicePixelRatio, 2) : 1;
t.CHARACTER_COLORS = 5;
t.FPS = 60;
t.TIME_UNITS_PER_SECOND = 25;
t.ANIM_SYMETRY = [!1, !1, !1, !0, !0, !1, !1, !0];
t.ANIM_SYMBOLS = [0, 1, 2, 1, 0, 5, 6, 5];
t.ANGLE_PER_DIRECTION = [0, Math.PI / 8, Math.PI / 2, Math.PI - Math.PI / 8, Math.PI, Math.PI + Math.PI / 8, -Math.PI / 2, -Math.PI / 8];
t.MISSING_TEXTURE_IMAGE_SRC = "data:image/gif;base64,R0lGODlhAQABAIAAAOAv/wAAACwAAAAAAQABAAACAkQBADs=";
t.EMPTY_IMAGE = new a.Image();
t.EMPTY_IMAGE.src = t.MISSING_TEXTURE_IMAGE_SRC;
t.EMPTY_JSON = {};
t.MAP_LAYER_BACKGROUND = -1;
t.MAP_LAYER_PLAYGROUND = 0;
t.MAP_LAYER_FOREGROUND = 1;
t.MAP_LAYER_TRANSPARENT = 2;
t.MAP_LAYER_ICONS = 3;
t.MAP_LAYER_POINT_LABELS = 4;
t.MAP_LAYER_TAP_FEEDBACK = 5;
t.MAP_LAYER_TARGET_INDICATOR = 6;
t.TRANSPARENT_MODE_ALPHA = .725;
t.MAX_MUSIC_SFX_MEMORY = Math.round(.43 * u / s);
t.MAX_TEXTURE_MEMORY_MAP = Math.round(.25 * u);
t.MAX_TEXTURE_MEMORY_WORLDMAP = Math.round(.1 * u);
t.MAX_TEXTURE_MEMORY_CHARACTER_DISPLAY = Math.round(.05 * u);
t.MAX_SPRITES_BUFFER_MAP = Math.max(Math.round(.04 * u / l), 2e4);
t.MAX_SPRITES_BUFFER_WORLDMAP = Math.max(Math.round(.005 * u / l), 1e4);
t.MAX_SPRITES_BUFFER_CHARACTER_DISPLAY = Math.max(Math.round(.005 * u / l), 4e3);
t.MAX_ANIMATIONS = Math.round(.12 * u / r);
t.MAX_MUSIC_SFX_MEMORY = 1e3;
t.MAX_TEXTURE_MEMORY_MAP = 104857600;
t.MAX_TEXTURE_MEMORY_WORLDMAP = 52428800;
t.MAX_TEXTURE_MEMORY_CHARACTER_DISPLAY = 20971520;
t.MAX_SPRITES_BUFFER_MAP = 8e4;
t.MAX_SPRITES_BUFFER_WORLDMAP = 1e4;
t.MAX_SPRITES_BUFFER_CHARACTER_DISPLAY = 9e3;
t.MAX_ANIMATIONS = 30;
t.MAX_ZOOM_MAP = 1.1;
t.PRERENDER_RATIO_MAP = t.PIXEL_RATIO;
t.PRERENDER_RATIO_WORLDMAP = t.PIXEL_RATIO;
t.PRERENDER_RATIO_CHARACTER_DISPLAY = 2 * t.PIXEL_RATIO;
t.TOTAL_MAP_ASSETS_SIZE_IN_GB = 2;
t.GRANDAPAN_SERVERID = 401;
t.TOURNAMENT_TEST_SERVERID = 310;
t.TOURNAMENT_PROD_SERVERID = 411;
t.NEXT_SERVERID = 300;
t.WARN_INVENTORY_YELLOW_MIN = .75;
t.WARN_INVENTORY_RED_MIN = 1;
t.TOA_RETRY_HC_PRICE = 200;
t.REROLL_DQ_HC_PRICE = 100;
t.REROLL_DQ_PACK_ID = 12827;
t.REROLL_DQ_ITEM_ID = 17890;
t.TOA_RETRY_TIMEOUT = 6e4;
t.TOA_RETRY_ITEM_ID = 15824;
t.TOA_QUEST_ID = 1496;
t.NB_PLAYER_PER_LADDER_PAGE = 50;
t.BASE_MONSTER_LEVEL = 75;
t.MAX_MONSTER_LEVEL = 325;
t.NB_SCALE_LEVEL = 100;
t.deleteFiles = function (e, t, i) {
  if (!a.wizAssets) {
    var o = new Error("deleteFiles called despite wizAssets not available");
    return i ? i(o) : console.error(o);
  }
  return e && (e = e.map(function (e) {
    return n.getCacheFolder() + e;
  })), a.wizAssets.deleteFiles(e, t, i);
};
t.downloadFile = function (e, t, i, o) {
  if (!a.wizAssets) {
    var s = new Error("downloadFile called despite wizAssets not available");
    return o ? o(s) : console.error(s);
  }
  return a.wizAssets.downloadFile(e, n.getCacheFolder() + t, i, o);
};
n = Object.keys(i);
n = n.map(function (e) {
  return window.parseInt(e, 10);
});
t.getEnvName = function () {
  var e = "";
  return e;
};
t.getCacheFolder = function () {
  var e = "";
  return e;
};
t.sortObjectInArray = function (e, t, i) {
  var n = i ? 1 : -1,
    o = i ? -1 : 1;
  e.sort(function (e, i) {
    return e[t] < i[t] ? n : e[t] > i[t] ? o : 0;
  });
};
t.getObjectInArrayIndexById = function (e, t, i) {
  if (!Array.isArray(e)) {
    return console.error("Input not an array.", e);
  }
  for (var n = 0; n < e.length; n += 1) {
    var o = e[n];
    if (o.hasOwnProperty(t) && o[t] === i) {
      return n;
    }
  }
  return -1;
};
t.getObjectInArrayById = function (t, i, n) {
  var o = e.exports.getObjectInArrayIndexById(t, i, n);
  if (o >= 0) {
    return t[o];
  }
};
t.removeObjectInArrayById = function (e, t, i) {
  if (!Array.isArray(e)) {
    return console.error("Input not an array.", e);
  }
  for (var n = !1, o = e.length - 1; o >= 0; o -= 1) {
    var a = e[o];
    a.hasOwnProperty(t) && a[t] === i && (e.splice(o, 1), n = !0);
  }
  return n;
};
t.mergeObjects = function (e) {
  for (var t = e || arguments, i = {}, n = 0, o = t.length; n < o; n += 1) {
    var a = t[n];
    for (var s in a) {
      a.hasOwnProperty(s) && (i[s] = a[s]);
    }
  }
  return i;
};
t.encodeSpecialChars = function (e) {
  return e ? e = e.replace(/[<>"']/g, function (e) {
    return C[e];
  }) : e;
};
t.kamasToString = function (e, t) {
  t || "" === t || (t = l("ui.common.short.kama"));
  var i = this.intToString(e);
  return t ? i + " " + t : i;
};
t.stringToKamas = function (e) {
  return Number(e.replace(w, ""));
};
t.intToString = function (e) {
  return isNaN(e) || null === e ? "" : (T = null !== T ? T : l("ui.common.numberSeparator"), e.toString().replace(b, T));
};
t.stringToInt = function (e) {
  return M || (T = null !== T ? T : l("ui.common.numberSeparator"), M = new RegExp(n(T), "g")), Number(e.replace(M, ""));
};
t.hardAndSoftToString = function (e, i) {
  var n = e ? t.kamasToString(e, "G") + " / " : "";
  return n + t.kamasToString(i, "K");
};
t.storeMapAndEmit = function (e, t, i, n) {
  var o = !1;
  for (var a in i) {
    t[a] !== i[a] && (t[a] = i[a], o = !0);
  }
  o && e.emit(n);
};
t.storeValueAndEmit = function (e, t, i, n, o) {
  t[i] !== n && (t[i] = n, e.emit(o, n));
};
t.hexToRgb = function (e) {
  for (var t = 6 - e.length, i = 0; i < t; i++) {
    e = "0" + e;
  }
  var n = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);
  return n ? [parseInt(n[1], 16), parseInt(n[2], 16), parseInt(n[3], 16)] : null;
};
t.mod = function (e, t) {
  return 0 === t ? 0 : (e % t + t) % t;
};
t.durationToString = function (e) {
  var t = ~~e % 60;
  t < 10 && (t = "0" + t);
  var i = ~~(e / 60) % 60;
  i < 10 && (i = "0" + i);
  var n = ~~(e / 3600);
  return n < 10 && (n = "0" + n), n + ":" + i + ":" + t;
};
t.durationToHuman = function (e) {
  var t = e / y;
  if (t >= 1) {
    var i = Math.floor(t / 365.25);
    if (i >= 1) {
      return i + " " + l("ui.time.years", i);
    }
    var n = Math.floor(t / 30.5);
    return n >= 1 ? n + " " + l("ui.time.months", n) : (t = Math.floor(t), t + " " + l("ui.time.days", t));
  }
  var o = Math.floor(e / 3600);
  if (o >= 1) {
    return o + " " + l("ui.time.hours", o);
  }
  var a = Math.floor(e / 60);
  if (a >= 1) {
    return a + " " + l("ui.time.minutes", a);
  }
  var s = Math.ceil(e);
  return s + " " + l("ui.time.seconds", s);
};
t.getAlmanaxDate = function (e, t) {
  e = e ? new Date(e) : new Date();
  var i = t ? e.getFullYear() : e.getUTCFullYear(),
    n = t ? e.getMonth() : e.getUTCMonth(),
    o = t ? e.getDate() : e.getUTCDate(),
    a = t ? e.getHours() : e.getUTCHours(),
    s = t ? e.getMinutes() : e.getUTCMinutes();
  return {
    year: i + d,
    month: n + 1,
    day: o,
    monthName: window.gui.databases.Months[n].nameId,
    hour: a < 10 ? "0" + a : a,
    minute: s < 10 ? "0" + s : s
  };
};
t.simplifyString = function (e) {
  if (!e) {
    return console.error(new Error("missing word to simplify")), "";
  }
  e = e.split("");
  for (var t = [], i = e.length, n = "ÀÁÂÃÄÅàáâãäåÒÓÔÕÕÖØòóôõöøÈÉÊËèéêëðÇçÐÌÍÎÏìíîïÙÚÛÜùúûüÑñŠšŸÿýŽž", o = "AAAAAAaaaaaaOOOOOOOooooooEEEEeeeeeCcDIIIIiiiiUUUUuuuuNnSsYyyZz", a = 0; a < i; a++) {
    n.indexOf(e[a]) !== -1 ? t[a] = o.substr(n.indexOf(e[a]), 1) : t[a] = e[a];
  }
  return t = t.join(""), t.toLowerCase();
};
t.createFifo = function () {
  return c.queue(function (e, t) {
    try {
      e(function (e) {
        if (e) {
          throw new Error(e);
        }
        t();
      });
    } catch (i) {
      return console.error(i), t(i);
    }
  });
};
t.getObjectInstanceName = function (e) {
  if (!e) {
    return null;
  }
  var t = /function ([^(]+)/.exec(String(Object.getPrototypeOf(e).constructor)) || [];
  return t[1];
};
t.differenceBetweenTwoArrays = function (e, t) {
  if (e.length !== t.length) {
    return !0;
  }
  for (var i = 0; i < e.length; i++) {
    if (e[i] !== t[i]) {
      return !0;
    }
  }
  return !1;
};
t.mapToArray = function (e, t) {
  for (var i = Object.keys(e), n = i.length, o = new Array(n), a = 0; a < n; a++) {
    o[a] = e[i[a]];
  }
  if (t && t.sortBy) {
    var s = t.sortBy;
    o.sort(function (e, t) {
      return e[s] - t[s];
    });
  }
  return o;
};
t.forceReflow = function (e, t) {
  e.rootElement.offsetWidth;
  t && window.setTimeout(t, 100);
};
t.showProgressively = function (e, i, n, o) {
  function a() {
    o && u.tween(o, {
      opacity: 0
    }, {
      time: i || 250
    });
    e && u.tween(e, {
      opacity: 1
    }, {
      time: i || 250
    });
  }
  e && (e.setStyle("opacity", 0), e.show(), t.forceReflow(e));
  n ? window.setTimeout(a, n) : a();
};
t.allLinksOnTargetBlank = function (e) {
  function t(e, t) {
    e.addEventListener("click", function (e) {
      e.preventDefault();
    });
    e.addEventListener(h.end, function (e) {
      t = encodeURI(t);
      i.openUrlInAppBrowser(t);
      e.preventDefault();
    });
  }
  for (var i = this, n = e.rootElement.getElementsByTagName("a"), o = 0; o < n.length; o++) {
    n[o].href && t(n[o], n[o].href);
  }
};
t.openUrlInDeviceBrowser = function (e) {
  window.open(e, "_system");
};
o && u.tween(o, {
  opacity: 0
}, {
  time: i || 250
});
e && u.tween(e, {
  opacity: 1
}, {
  time: i || 250
});
e && (e.setStyle("opacity", 0), e.show(), t.forceReflow(e));
n ? window.setTimeout(a, n) : a();
e.addEventListener("click", function (e) {
  e.preventDefault();
});
e.addEventListener(h.end, function (e) {
  t = encodeURI(t);
  i.openUrlInAppBrowser(t);
  e.preventDefault();
});
t = encodeURI(t);
i.openUrlInAppBrowser(t);
e.preventDefault();
A.removeEventListener("exit", E);
A = null;
t.openUrlInAppBrowser = I;
t.cssTransform = function (e, t) {
  e.setStyles({
    transform: t,
    oTransform: t,
    msTransform: t,
    mozTransform: t,
    webkitTransform: t
  });
};
t.cssTransition = function (e, t) {
  e.setStyles({
    transition: t,
    oTransition: t,
    msTransition: t,
    mozTransition: t,
    webkitTransition: t
  });
};
t.createPropertyNameCompareFunc = function (e) {
  return function (t, i) {
    return t[e] < i[e] ? -1 : t[e] > i[e] ? 1 : 0;
  };
};
t.createStringCompareFunc = function (e) {
  e = e || "nameId";
  var t = window.Config.language;
  return function (i, n) {
    var o = i[e];
    return "string" != typeof o ? -1 : o.localeCompare(n[e], t);
  };
};
t.jeffVersionDowngrader = function (e, i) {
  if (i || e.meta && e.meta.version) {
    if (void 0 !== e.x && (e.x *= -1), void 0 !== e.y && (e.y *= -1), void 0 !== e.transforms && (e.matrices = e.transforms, delete e.transforms), void 0 !== e.isAnimation && (e.isAnim = e.isAnimation, delete e.isAnimation), e.symbols) {
      for (var n in e.symbols) {
        t.jeffVersionDowngrader(e.symbols[n], !0);
      }
    }
    if (e.children) {
      for (var o in e.children) {
        t.jeffVersionDowngrader(e.children[o], !0);
      }
    }
  }
};
t.checkBidHouseCategoriesAddendumIntegrity = o;
t.randomIntFromInterval = a;
t.getXpPreview = s;
t.isConnectedToDom = r;
null !== d && void 0 !== d || (d = "null");
s += "arg" + r + ': "' + d.toString() + '" ';
u += " with args: " + s + "and modifier: " + n;
o && (u += " from caller: " + o);
a.error(new Error(u));
void 0 === n && (s = p);
void 0 !== p && null !== p ? r += p : l && (!a || a && !a.isPreview) && i("arg " + h.toString() + " is null/undefined", e, t, n, o);
c++;
f ? r += e.substring(c + 3, m) : l = !1;
c = m;
t.initialize = function (e, t, i, n) {
  return a = t, s = i, r && c === e.language && u === e.chaseText ? n() : (e.language && (c = e.language), u = Boolean(e.chaseText), d = e.failoverLanguage || d, void s.initializeDictionariesAndDiskCache(c, d, function (e, t, i) {
    return e ? n(e) : (r = t, l = i, void n());
  }));
};
t.findText = function (e) {
  return u ? c + "[" + e + "]" : e;
};
t.getText = function (e) {
  var i = r && r[e];
  return i ? o(i, arguments) : (a.error("getText: no getText was found for", e, "in", c), t.getTextFailover.apply(null, arguments));
};
t.getTextFailover = function (e) {
  var t = l && l[e];
  return t ? o(t, arguments) : (a.error("getTextFailover: no failover getText was found for", e, "in", d), c + "[?" + e + "]");
};
t.hasText = function (e) {
  return Boolean(r && r[e] || l && l[e]);
};
t.processText = function (e) {
  return n(e, arguments);
};
t.processTextWithCallerInfo = function (e, t, i, o) {
  if (!e) {
    return a.error(new Error("text is missing for " + i)), "";
  }
  var s = t;
  s || (a.error(new Error('params is missing for "' + e + '"')), s = []);
  var r = [null].concat(s);
  return n(e, r, null, i, o);
};
t.processTextWithModifier = function (e, t) {
  return n(e, Array.prototype.slice.call(arguments, 1), t);
};
e = null;
t.apply(this, arguments);
e = null;
t.apply(this, arguments);
r = !0;
n(e);
l += 1;
i(t.value, t.key, H(o));
n = n || b;
t = t || [];
o[n] = t;
i(e);
t < 0 && (t = -t > o ? 0 : o + t);
i = i > o ? o : i;
i < 0 && (i += o);
o = t > i ? 0 : i - t >>> 0;
t >>>= 0;
Q(e, function (e, t) {
  function n(t, i) {
    var n = ee(o, function (e) {
      return t[e];
    });
    n.push(i);
    p(e).apply(null, n);
  }
  var o,
    a = h(e),
    s = !a && 1 === e.length || a && 0 === e.length;
  if (Wt(e)) {
    o = e.slice(0, -1);
    e = e[e.length - 1];
    i[t] = o.concat(o.length > 0 ? n : e);
  } else if (s) {
    i[t] = e;
  } else {
    if (o = pe(e), 0 === e.length && !a && 0 === o.length) {
      throw new Error("autoInject task functions require explicit parameters.");
    }
    a || o.pop();
    i[t] = o.concat(n);
  }
});
Gi(i, t);
n.push(i);
p(e).apply(null, n);
o = e.slice(0, -1);
e = e[e.length - 1];
i[t] = o.concat(o.length > 0 ? n : e);
a || o.pop();
i[t] = o.concat(n);
this.head = this.tail = null;
this.length = 0;
e.length = 1;
e.head = e.tail = t;
l = !1;
d.process();
0 === a ? r.shift() : a > 0 && r.splice(a, 1);
o.callback.apply(o, arguments);
null != t && d.error(t, o.data);
s <= d.concurrency - d.buffer && d.unsaturated();
d.idle() && d.drain();
d.process();
d.drain = b;
d._tasks.empty();
e.push(l);
r.push(l);
t.push(l.data);
s += 1;
0 === d._tasks.length && d.empty();
s === d.concurrency && d.saturated();
t = i;
n(e);
"function" == typeof n ? t.pop() : n = b;
ye(e, t, function (e, t, n) {
  t.apply(i, e.concat(function (e) {
    var t = a(arguments, 1);
    n(e, t);
  }));
}, function (e, t) {
  n.apply(i, [e].concat(t));
});
i.push(function (t) {
  var i = a(arguments, 1);
  "object" == typeof console && (t ? console.error && console.error(t) : console[e] && V(i, function (t) {
    console[e](t);
  }));
});
p(t).apply(null, i);
t.push(o);
r.apply(this, t);
t.push(function () {
  var e = arguments;
  n ? pt(function () {
    i.apply(null, e);
  }) : i.apply(null, e);
});
e.apply(this, t);
n = !1;
o[t] = !!i;
n(e);
arguments.length > 2 && (o = a(arguments, 1));
n[t] = o;
i(e);
n = arguments.length <= 2 ? t : a(arguments, 1);
i(null, {
  value: n
});
e.times = +t.times || a;
e.intervalFunc = "function" == typeof t.interval ? t.interval : Ke(+t.interval || s);
e.errorFilter = t.errorFilter;
n.code = "ETIMEDOUT";
i && (n.info = i);
l = !0;
a(n);
o.push(function () {
  l || (a.apply(null, arguments), clearTimeout(r));
});
r = setTimeout(s, t);
n.apply(null, o);
s[n ? a : ++o] = e;
e += i;
arguments.length <= 3 && (n = i, i = t, t = Wt(e) ? [] : {});
n = M(n || b);
t = t || b;
Hn(e, function (e, t) {
  p(e)(function (e, o) {
    i = arguments.length > 2 ? a(arguments, 1) : o;
    n = e;
    t(!e);
  });
}, function () {
  t(n, i);
});
i = arguments.length > 2 ? a(arguments, 1) : o;
n = e;
t(!e);
wi[ui] = wi[hi] = wi[pi] = wi[mi] = wi[fi] = wi[gi] = wi[_i] = wi[vi] = wi[yi] = !0;
wi[Kt] = wi[Jt] = wi[ci] = wi[Zt] = wi[di] = wi[$t] = wi[ei] = wi[ti] = wi[ii] = wi[ni] = wi[oi] = wi[ai] = wi[si] = wi[ri] = wi[li] = !1;
i || (i = _[e] = []);
i.push(t);
V(t, function (e) {
  e();
});
o();
Q(m, function (e, t) {
  o[t] = e;
});
o[e] = n;
g = !0;
_ = Object.create(null);
i(t, o);
m[e] = n;
r(e);
e = y.pop();
t++;
V(d(e), function (e) {
  0 === --w[e] && y.push(e);
});
"function" == typeof t && (i = t, t = null);
i = M(i || b);
Q(e, function (t, i) {
  if (!Wt(t)) {
    return n(i, [t]), void y.push(i);
  }
  var o = t.slice(0, t.length - 1),
    a = o.length;
  return 0 === a ? (n(i, t), void y.push(i)) : (w[i] = a, void V(o, function (r) {
    if (!e[r]) {
      throw new Error("async.auto task `" + i + "` has a non-existent dependency `" + r + "` in " + o.join(", "));
    }
    s(r, function () {
      a--;
      0 === a && n(i, t);
    });
  }));
});
c();
o();
a--;
0 === a && n(i, t);
fe.prototype.removeLink = function (e) {
  return e.prev ? e.prev.next = e.next : this.head = e.next, e.next ? e.next.prev = e.prev : this.tail = e.prev, e.prev = e.next = null, this.length -= 1, e;
};
fe.prototype.empty = function () {
  for (; this.head;) {
    this.shift();
  }
  return this;
};
fe.prototype.insertAfter = function (e, t) {
  t.prev = e;
  t.next = e.next;
  e.next ? e.next.prev = t : this.tail = t;
  e.next = t;
  this.length += 1;
};
fe.prototype.insertBefore = function (e, t) {
  t.prev = e.prev;
  t.next = e;
  e.prev ? e.prev.next = t : this.head = t;
  e.prev = t;
  this.length += 1;
};
fe.prototype.unshift = function (e) {
  this.head ? this.insertBefore(this.head, e) : ge(this, e);
};
fe.prototype.push = function (e) {
  this.tail ? this.insertAfter(this.tail, e) : ge(this, e);
};
fe.prototype.shift = function () {
  return this.head && this.removeLink(this.head);
};
fe.prototype.pop = function () {
  return this.tail && this.removeLink(this.tail);
};
fe.prototype.toArray = function () {
  for (var e = Array(this.length), t = this.head, i = 0; i < this.length; i++) {
    e[i] = t.data;
    t = t.next;
  }
  return e;
};
fe.prototype.remove = function (e) {
  for (var t = this.head; t;) {
    var i = t.next;
    e(t) && this.removeLink(t);
    t = i;
  }
  return this;
};
t.prev = e;
t.next = e.next;
e.next ? e.next.prev = t : this.tail = t;
e.next = t;
this.length += 1;
t.prev = e.prev;
t.next = e;
e.prev ? e.prev.next = t : this.head = t;
e.prev = t;
this.length += 1;
e[i] = t.data;
t = t.next;
e(t) && this.removeLink(t);
t = i;
t.push(H(n));
i.apply(null, t);
t["default"] = mo;
t.apply = ct;
t.applyEach = ki;
t.applyEachSeries = zi;
t.asyncify = c;
t.auto = Gi;
t.autoInject = me;
t.cargo = ve;
t.compose = Nn;
t.concat = On;
t.concatLimit = Ln;
t.concatSeries = Rn;
t.constant = Dn;
t.detect = Pn;
t.detectLimit = Bn;
t.detectSeries = kn;
t.dir = Fn;
t.doDuring = Ie;
t.doUntil = Se;
t.doWhilst = Ae;
t.during = Ee;
t.each = xe;
t.eachLimit = Le;
t.eachOf = Pi;
t.eachOfLimit = W;
t.eachOfSeries = En;
t.eachSeries = Hn;
t.ensureAsync = Oe;
t.every = zn;
t.everyLimit = Wn;
t.everySeries = Gn;
t.filter = Un;
t.filterLimit = qn;
t.filterSeries = Yn;
t.forever = Fe;
t.groupBy = Vn;
t.groupByLimit = jn;
t.groupBySeries = Xn;
t.log = Qn;
t.map = Bi;
t.mapLimit = Fi;
t.mapSeries = Hi;
t.mapValues = Kn;
t.mapValuesLimit = He;
t.mapValuesSeries = Jn;
t.memoize = We;
t.nextTick = Zn;
t.parallel = Ue;
t.parallelLimit = qe;
t.priorityQueue = eo;
t.queue = $n;
t.race = Ye;
t.reduce = ye;
t.reduceRight = je;
t.reflect = Ve;
t.reflectAll = Xe;
t.reject = to;
t.rejectLimit = io;
t.rejectSeries = no;
t.retry = Je;
t.retryable = oo;
t.seq = we;
t.series = Ze;
t.setImmediate = pt;
t.some = ao;
t.someLimit = so;
t.someSeries = ro;
t.sortBy = $e;
t.timeout = et;
t.times = uo;
t.timesLimit = it;
t.timesSeries = ho;
t.transform = nt;
t.tryEach = ot;
t.unmemoize = at;
t.until = rt;
t.waterfall = po;
t.whilst = st;
t.all = zn;
t.allLimit = Wn;
t.allSeries = Gn;
t.any = ao;
t.anyLimit = so;
t.anySeries = ro;
t.find = Pn;
t.findLimit = Bn;
t.findSeries = kn;
t.forEach = xe;
t.forEachSeries = Hn;
t.forEachLimit = Le;
t.forEachOf = Pi;
t.forEachOfSeries = En;
t.forEachOfLimit = W;
t.inject = ye;
t.foldl = ye;
t.foldr = je;
t.select = Un;
t.selectLimit = qn;
t.selectSeries = Yn;
t.wrapSync = c;
Object.defineProperty(t, "__esModule", {
  value: !0
});
this._id = e;
this._clearFn = t;
t.setTimeout = function () {
  return new o(s.call(setTimeout, window, arguments), clearTimeout);
};
t.setInterval = function () {
  return new o(s.call(setInterval, window, arguments), clearInterval);
};
t.clearTimeout = t.clearInterval = function (e) {
  e.close();
};
o.prototype.unref = o.prototype.ref = function () {};
o.prototype.close = function () {
  this._clearFn.call(window, this._id);
};
t.enroll = function (e, t) {
  clearTimeout(e._idleTimeoutId);
  e._idleTimeout = t;
};
t.unenroll = function (e) {
  clearTimeout(e._idleTimeoutId);
  e._idleTimeout = -1;
};
t._unrefActive = t.active = function (e) {
  clearTimeout(e._idleTimeoutId);
  var t = e._idleTimeout;
  t >= 0 && (e._idleTimeoutId = setTimeout(function () {
    e._onTimeout && e._onTimeout();
  }, t));
};
t.setImmediate = "function" == typeof e ? e : function (e) {
  var i = c++,
    n = !(arguments.length < 2) && r.call(arguments, 1);
  return l[i] = !0, a(function () {
    l[i] && (n ? e.apply(null, n) : e.call(null), t.clearImmediate(i));
  }), i;
};
t.clearImmediate = "function" == typeof n ? n : function (e) {
  delete l[e];
};
clearTimeout(e._idleTimeoutId);
e._idleTimeout = t;
clearTimeout(e._idleTimeoutId);
e._idleTimeout = -1;
t.leadWithZero = i;
t.initialize = function (e, i, n) {
  o = i;
  n && (a = n);
  e.on("BasicTimeMessage", function (e) {
    var i = a(),
      n = t.time;
    n.serverTimeLag = 1e3 * (e.timestamp + 60 * e.timezoneOffset) - i;
    n.serverUtcTimeLag = 1e3 * e.timestamp - i;
    n.timezoneOffset = 60 * e.timezoneOffset * 1e3;
  });
};
t.now = function () {
  return a() + t.time.serverUtcTimeLag;
};
t.DofusDate = n;
n.prototype.getLocalDate = function (e) {
  var i = new Date(this.baseTimestamp);
  return this.dofusDate = e, this.date = i, this.year = i.getFullYear() + (e ? t.time.dofusTimeYearLag : 0), this.month = i.getMonth(), this.day = i.getDate(), this.hour = i.getHours(), this.minute = i.getMinutes(), this.timestamp = i.getTime(), this;
};
n.prototype.getServerDate = function (e) {
  var i = new Date(this.baseTimestamp + t.time.timezoneOffset);
  return this.dofusDate = e, this.date = i, this.year = i.getUTCFullYear() + (e ? t.time.dofusTimeYearLag : 0), this.month = i.getUTCMonth(), this.day = i.getUTCDate(), this.hour = i.getUTCHours(), this.minute = i.getUTCMinutes(), this.timestamp = i.getTime(), this;
};
n.prototype.toString = function (e) {
  if (!this.date) {
    return {};
  }
  var n = !this.dofusDate && e,
    a = this.year + (n ? t.time.dofusTimeYearLag : 0),
    s = i(this.day),
    r = i(this.month + 1),
    l = i(this.hour),
    c = i(this.minute);
  return {
    date: o("ui.time.dateNumbers", s, r, a),
    time: l + ":" + c,
    year: a,
    month: r,
    monthName: window.gui.databases.Months[this.month].nameId,
    day: s,
    hour: l,
    minute: c
  };
};
o = i;
n && (a = n);
e.on("BasicTimeMessage", function (e) {
  var i = a(),
    n = t.time;
  n.serverTimeLag = 1e3 * (e.timestamp + 60 * e.timezoneOffset) - i;
  n.serverUtcTimeLag = 1e3 * e.timestamp - i;
  n.timezoneOffset = 60 * e.timezoneOffset * 1e3;
});
n.serverTimeLag = 1e3 * (e.timestamp + 60 * e.timezoneOffset) - i;
n.serverUtcTimeLag = 1e3 * e.timestamp - i;
n.timezoneOffset = 60 * e.timezoneOffset * 1e3;
t.tween = function (e, t, n, o) {
  function a() {
    window.clearTimeout(p);
    d.removeEventListener("webkitTransitionEnd", m);
    p = null;
    d.style.webkitTransition = u;
    e._tween = null;
  }
  function s() {
    f || g || (f = g = !0, a(), o = null);
  }
  i(e);
  n = n || {};
  var r = n.time || 500,
    l = n.delay || 0,
    c = n.easing || "ease-in-out",
    d = e.rootElement;
  if (!d) {
    return void console.error(new Error("The dom is gone"));
  }
  var u = d.style.webkitTransition,
    h = "all " + r + "ms " + c;
  l && (h += " " + l + "ms");
  var p,
    m,
    f = !1,
    g = !1;
  return m = function (t) {
    g || (g = !0, t && t.stopPropagation(), a(), o && (o.call(e, t), o = null));
  }, window.setTimeout(function () {
    if (!f) {
      d.style.webkitTransition = h;
      for (var e in t) {
        d.style[e] = t[e];
      }
      d.addEventListener("webkitTransitionEnd", m);
      p = window.setTimeout(m, l + r);
    }
  }, 0), e._tween = {
    cancel: s
  }, e._tween;
};
t.cancelTween = i;
window.clearTimeout(p);
d.removeEventListener("webkitTransitionEnd", m);
p = null;
d.style.webkitTransition = u;
e._tween = null;
i(e);
n = n || {};
d.addEventListener("webkitTransitionEnd", m);
p = window.setTimeout(m, l + r);
n = i ? function (e, t) {
  t = t || {};
  var i = e.touches || [],
    n = i.length;
  if (0 === n) {
    return {
      x: o.x,
      y: o.y,
      touches: [],
      touchCount: 0
    };
  }
  for (var a = [], s = 0; s < n; s += 1) {
    a.push({
      x: i[s].clientX,
      y: i[s].clientY
    });
  }
  o.x = i[0].clientX;
  o.y = i[0].clientY;
  var r = document.getElementById("resizableBody");
  return r && t.useScrollValue && (o.y += r.scrollTop || 0), {
    x: o.x,
    y: o.y,
    touches: a,
    touchCount: n
  };
} : function (e, t) {
  t = t || {};
  o.x = e.clientX;
  o.y = e.clientY;
  var i = document.getElementById("resizableBody");
  return i && t.useScrollValue && (o.y += i.scrollTop || 0), {
    x: o.x,
    y: o.y,
    touchCount: "mouseup" === e.type ? 0 : 1,
    touches: [{
      x: o.x,
      y: o.y
    }]
  };
};
e.exports = {
  canTouch: i,
  getPosition: n,
  position: o,
  events: {
    start: i ? "touchstart" : "mousedown",
    move: i ? "touchmove" : "mousemove",
    end: i ? "touchend" : "mouseup"
  }
};
o.x = i[0].clientX;
o.y = i[0].clientY;
t = t || {};
o.x = e.clientX;
o.y = e.clientY;
e = e || {};
r = r || 0;
s = s || [e];
Array.isArray(s) || (s = [e]);
c += e.level;
e.level > d && (d = e.level);
l = i(f * y / c);
l = i(l * e.wisdom / 100 + l);
l = Math.max(1, l);
i = i || !1;
n = n || "id";
e = e.map(function (e) {
  return e.toString();
});
s++;
l = 0;
l = i(e, n, s);
l && (r = l.requiredXp);
delete f[e];
t.apply(this, i);
s();
h = !1;
e.on("connected", function () {
  p = !0;
  r();
});
e.on("disconnect", function () {
  p = !1;
  d();
});
e.on("appGoBackground", function () {
  c();
});
e.on("connectedAfterAppLeaveBackground", function () {
  h && l();
});
p = !0;
r();
p = !1;
d();
t.setTimeout = function (e, t) {
  var i = [];
  if (arguments.length > g) {
    for (var n = 0; n < arguments.length - g; n++) {
      i[n] = arguments[n + g];
    }
  }
  return o(u.TYPES.TIMEOUT, e, t, i);
};
t.setInterval = function (e, t) {
  var i = [];
  if (arguments.length > g) {
    for (var n = 0; n < arguments.length - g; n++) {
      i[n] = arguments[n + g];
    }
  }
  return o(u.TYPES.INTERVAL, e, t, i);
};
t.clearTimeout = t.clearInterval = function (e) {
  return a(e), null;
};
this._type = e;
this._delay = i;
this._action = t;
this._arguments = n;
this._startedAtTime = null;
this._timeout = null;
this._interval = null;
e._startedAtTime = Date.now();
e._action.apply(this, e._arguments);
e._timeout = null;
e._interval = window.setInterval(o(e), e._delay);
e._startedAtTime = Date.now();
e._action.apply(this, e._arguments);
i.TYPES = s;
i.prototype.start = function () {
  this._startedAtTime || (this._startedAtTime = Date.now(), this._type === s.TIMEOUT ? this._timeout = window.setTimeout(n(this), this._delay) : this._type === s.INTERVAL && (this._interval = window.setInterval(o(this), this._delay)));
};
i.prototype.suspend = function () {
  this._startedAtTime && (this._type === s.TIMEOUT ? this._timeout = window.clearTimeout(this._timeout) : this._type === s.INTERVAL && (this._timeout = window.clearTimeout(this._timeout), this._interval = window.clearInterval(this._interval)));
};
i.prototype["continue"] = function () {
  if (this._startedAtTime && !this._timeout && !this._interval) {
    var e = Date.now() - this._startedAtTime,
      t = Math.max(0, this._delay - e);
    this._type === s.TIMEOUT ? this._timeout = window.setTimeout(n(this), t) : this._type === s.INTERVAL && (this._timeout = window.setTimeout(a(this), t));
  }
};
i.prototype.clear = function () {
  this.suspend();
  this._startedAtTime = null;
};
this.suspend();
this._startedAtTime = null;
t.isEmptyObject = function (e) {
  var t;
  for (t in e) {
    return !1;
  }
  return !0;
};
t.getOwnProperties = function (e) {
  var t = [];
  if (e && "object" == typeof e) {
    for (var i in e) {
      e.hasOwnProperty(i) && t.push(i);
    }
  }
  return t;
};
t.shallowCopyProperties = function (e, t, i) {
  if (e && "object" == typeof e && t && "object" == typeof t && Array.isArray(i)) {
    for (var n = 0; n < i.length; n++) {
      var o = i[n];
      t[o] = e[o];
    }
  }
};
t.shallowCopyArray = function (e) {
  return e.slice();
};
t.formatUrlToCssUrl = function (e) {
  return 'url("' + e + '")';
};
f.setup(window.Config);
v.initialize(window.Config);
t();
b.setupChannels(_.getValue("soundPreferences", {}, !0));
b.playLoopSound("music", "20000", .8);
b.stopAllLoopSounds();
b.release();
window.gui.splashScreen.hide();
window.location.reload();
t = e.exports = new m();
t.logger = f;
t.connectionManager = g;
t.sessionId = null;
t.setLanguage = function (e, t) {
  if (!window.Config || e && window.Config.language === e) {
    return t();
  }
  var i = o() + "/getLanguage.json?lang=" + e;
  p.loadJson(i, function (e, i) {
    return e ? t(e) : (window.Config.language = i.language, void t());
  });
};
t.start = function () {
  window.gui.initialize();
  var e = _.getValue("lang");
  r(e, window.gui, function (e) {
    return e ? t.reloadAppOnFatalError(e) : (E.initHaapiModule(t.logger, t.connectionManager), C.init(window.Config.analytics, E), I.initialize(t.logger, window.Config.adjust, window.Adjust, window.AdjustConfig, window.AdjustEvent), w.backToLogin(), window.gui.initialize(window.Config), void (window.isoEngine && window.isoEngine.initialize()));
  });
};
t.reloadAppOnFatalError = function (e, t) {
  t = t || "Server busy";
  console.error("Reloading on fatal error: " + e);
  navigator.notification ? navigator.notification.alert(t, d, "Dofus Touch", "Reload") : (window.alert(t), d());
};
t = t || "Server busy";
console.error("Reloading on fatal error: " + e);
navigator.notification ? navigator.notification.alert(t, d, "Dofus Touch", "Reload") : (window.alert(t), d());
t.setCredentials = function (e, t) {
  G.username = e;
  G.token = t;
  G.salt = null;
  G.key = null;
};
t.login = function (e) {
  if (W === F) {
    return console.warn("Already logged in"), e();
  }
  if (W === k) {
    return console.warn("Already logging in"), t.once("loginEnd", e);
  }
  W === z && g.disconnect("SWITCHING_TO_LOGIN");
  W = k;
  G.salt = null;
  G.key = null;
  D = !1;
  var i = T(g, function (i) {
    i ? (this.disconnect("LOGIN_ERROR"), W = B, t.emit("loginEnd", i)) : (W = F, t.emit("loginEnd"));
    e(i);
  });
  i("disconnect", function () {
    throw D = !0, new Error("Disconnect during login");
  });
  i("open", function () {
    this.send("connecting", u("login"));
  });
  i("serverDisconnecting", function (e) {
    D || (D = !0, i.done(e));
  });
  i("ProtocolRequired", function (e) {
    console.log("[Login server protocol] requiredVersion:", e.requiredVersion, "currentVersion:", e.currentVersion);
  });
  i("HelloConnectMessage", function (e) {
    G.salt = e.salt;
    G.key = e.key;
    this.send("login", G);
  });
  i("IdentificationSuccessMessage", "IdentificationSuccessWithLoginTokenMessage", function (e) {
    var n = e.uniqueNickname,
      o = window.gui.playerData.loginName;
    if (o) {
      if (/^\[GUEST]/.test(o)) {
        if (window.Config.disabledFeatures.guest) {
          return i.done(new Error("identification: no guests"));
        }
        var a = _.getValue("guestAccount", {}, !0);
        a.nickname = n.toString();
      }
    } else {
      console.error("dofus.login: loginName is empty");
    }
    _.setAccount(n.toString());
    l();
    M.start();
    e.wasAlreadyConnected && t.emit("wasAlreadyConnected");
  });
  i("ConnectionFailedMessage", "IdentificationFailedMessage", "IdentificationFailedForBadVersionMessage", "IdentificationFailedBannedMessage", function (e) {
    i.done(e);
  });
  i("ServersListMessage", function (e) {
    R = e.servers;
    i.done();
  });
  g.connect(t.logger, n(o()));
};
t.accessGameServer = function (e, i) {
  if (W === k) {
    return t.once("loginEnd", function (n) {
      return n ? i(n) : void t.accessGameServer(e, i);
    });
  }
  if (W === H) {
    return e === P ? (console.warn("Already accessing this game server (" + e + ")"), t.once("accessGameEnd", i)) : i(new Error("Already accessing game server " + P + " (while trying to access " + e + ")"));
  }
  if (P = e, W !== F) {
    return t.login(function (n) {
      return n ? i(n) : void t.accessGameServer(e, i);
    });
  }
  var o,
    s,
    r,
    l = a(e);
  if (!l) {
    return i(new Error("Unknown server: " + e));
  }
  W = H;
  var c = T(g, function (e) {
    e ? (this.disconnect("GAME_HANDSHAKE_ERROR"), W = B, t.emit("accessGameEnd", e)) : (W = z, t.emit("accessGameEnd"));
    P = null;
    i(e);
  });
  c("SelectedServerDataMessage", function (e) {
    o = e.ticket;
    s = e.address;
    r = e.port;
    g.switchToGame(n(e._access));
  });
  c("SelectedServerRefusedMessage", function (e) {
    throw new Error("serverId " + e.serverId + " not accessible, error: " + e.error + ", serverStatus: " + e.serverStatus);
  });
  c("open", function () {
    this.send("connecting", u({
      address: s,
      port: r,
      id: e
    }));
  });
  c("serverDisconnecting", function (e) {
    c.done(e);
  });
  c("ProtocolRequired", function (e) {
    console.log("[Game server protocol] requiredVersion:", e.requiredVersion, "currentVersion:", e.currentVersion);
  });
  c("HelloGameMessage", function () {
    this.sendMessage("AuthenticationTicketMessage", {
      ticket: o,
      lang: window.Config.language
    });
  });
  c("AuthenticationTicketAcceptedMessage", function () {
    c.done();
  });
  c("AuthenticationTicketRefusedMessage", function () {
    console.error(new Error("Server " + e + " Authentication failed"));
    c.done();
  });
  g.sendMessage("ServerSelectionMessage", {
    serverId: e
  });
};
g.on("HelloConnectMessage", function () {
  window.gui.connectionSplashScreen.onStateChange("CONNECTED");
});
g.on("offline", function () {
  window.gui.connectionSplashScreen.onStateChange("UNSTABLE");
});
g.on("reconnecting", function (e, t) {
  console.info("Reconnecting to " + t + " (attempt #" + e + ")");
  window.gui.connectionSplashScreen.onStateChange("RECONNECTING", e);
});
g.on("open", function (e) {
  e && g.send("reconnecting");
});
g.on("sessionReconnected", function () {
  return window.isoEngine.onQuickReconnection(function () {
    window.gui.connectionSplashScreen.onStateChange("CONNECTED");
  });
});
g.on("sessionTimedOut", function () {
  console.info("Session timed out");
  g.disconnect("SESSION_TIMED_OUT");
});
g.on("serverDisconnecting", function (e) {
  console.info("Server disconnecting, reason:", e.reason);
  g.disconnect("SOCKET_LOST");
});
g.on("disconnect", function (e) {
  W = B;
  e.match(/^SWITCHING_/) || (c(), M.stop(), window.gui.disconnect(e), window.isoEngine && window.isoEngine.disconnect(), window.gui.connectionSplashScreen.onStateChange("RELOAD" === e ? "RELOADING" : "DISCONNECTED"));
});
t.send = function (e, t) {
  g.send(e, t);
};
t.sendMessage = function (e, t) {
  g.sendMessage(e, t);
};
t.disconnect = function (e) {
  g.disconnect(e);
};
window.addEventListener("beforeunload", function () {
  g.disconnect("RELOAD");
});
G.username = e;
G.token = t;
G.salt = null;
G.key = null;
W === z && g.disconnect("SWITCHING_TO_LOGIN");
W = k;
G.salt = null;
G.key = null;
D = !1;
i ? (this.disconnect("LOGIN_ERROR"), W = B, t.emit("loginEnd", i)) : (W = F, t.emit("loginEnd"));
e(i);
i("disconnect", function () {
  throw D = !0, new Error("Disconnect during login");
});
i("open", function () {
  this.send("connecting", u("login"));
});
i("serverDisconnecting", function (e) {
  D || (D = !0, i.done(e));
});
i("ProtocolRequired", function (e) {
  console.log("[Login server protocol] requiredVersion:", e.requiredVersion, "currentVersion:", e.currentVersion);
});
i("HelloConnectMessage", function (e) {
  G.salt = e.salt;
  G.key = e.key;
  this.send("login", G);
});
i("IdentificationSuccessMessage", "IdentificationSuccessWithLoginTokenMessage", function (e) {
  var n = e.uniqueNickname,
    o = window.gui.playerData.loginName;
  if (o) {
    if (/^\[GUEST]/.test(o)) {
      if (window.Config.disabledFeatures.guest) {
        return i.done(new Error("identification: no guests"));
      }
      var a = _.getValue("guestAccount", {}, !0);
      a.nickname = n.toString();
    }
  } else {
    console.error("dofus.login: loginName is empty");
  }
  _.setAccount(n.toString());
  l();
  M.start();
  e.wasAlreadyConnected && t.emit("wasAlreadyConnected");
});
i("ConnectionFailedMessage", "IdentificationFailedMessage", "IdentificationFailedForBadVersionMessage", "IdentificationFailedBannedMessage", function (e) {
  i.done(e);
});
i("ServersListMessage", function (e) {
  R = e.servers;
  i.done();
});
g.connect(t.logger, n(o()));
G.salt = e.salt;
G.key = e.key;
this.send("login", G);
_.setAccount(n.toString());
l();
M.start();
e.wasAlreadyConnected && t.emit("wasAlreadyConnected");
R = e.servers;
i.done();
e ? (this.disconnect("GAME_HANDSHAKE_ERROR"), W = B, t.emit("accessGameEnd", e)) : (W = z, t.emit("accessGameEnd"));
P = null;
i(e);
c("SelectedServerDataMessage", function (e) {
  o = e.ticket;
  s = e.address;
  r = e.port;
  g.switchToGame(n(e._access));
});
c("SelectedServerRefusedMessage", function (e) {
  throw new Error("serverId " + e.serverId + " not accessible, error: " + e.error + ", serverStatus: " + e.serverStatus);
});
c("open", function () {
  this.send("connecting", u({
    address: s,
    port: r,
    id: e
  }));
});
c("serverDisconnecting", function (e) {
  c.done(e);
});
c("ProtocolRequired", function (e) {
  console.log("[Game server protocol] requiredVersion:", e.requiredVersion, "currentVersion:", e.currentVersion);
});
c("HelloGameMessage", function () {
  this.sendMessage("AuthenticationTicketMessage", {
    ticket: o,
    lang: window.Config.language
  });
});
c("AuthenticationTicketAcceptedMessage", function () {
  c.done();
});
c("AuthenticationTicketRefusedMessage", function () {
  console.error(new Error("Server " + e + " Authentication failed"));
  c.done();
});
g.sendMessage("ServerSelectionMessage", {
  serverId: e
});
o = e.ticket;
s = e.address;
r = e.port;
g.switchToGame(n(e._access));
console.error(new Error("Server " + e + " Authentication failed"));
c.done();
console.info("Reconnecting to " + t + " (attempt #" + e + ")");
window.gui.connectionSplashScreen.onStateChange("RECONNECTING", e);
console.info("Session timed out");
g.disconnect("SESSION_TIMED_OUT");
console.info("Server disconnecting, reason:", e.reason);
g.disconnect("SOCKET_LOST");
W = B;
e.match(/^SWITCHING_/) || (c(), M.stop(), window.gui.disconnect(e), window.isoEngine && window.isoEngine.disconnect(), window.gui.connectionSplashScreen.onStateChange("RELOAD" === e ? "RELOADING" : "DISCONNECTED"));
t.loadScript = function (e, t) {
  var i = document.getElementsByTagName("head")[0],
    n = document.createElement("script");
  n.setAttribute("crossorigin", "anonymous");
  n.onload = function () {
    return this.onload = null, this.onerror = null, t();
  };
  n.onerror = function () {
    return this.onload = null, this.onerror = null, t(new Error("Error loading script: " + e));
  };
  n.type = "text/javascript";
  n.src = e;
  i.appendChild(n);
};
t.loadJson = function (e, t) {
  var i = new XMLHttpRequest();
  i.overrideMimeType("application/json");
  i.onreadystatechange = function () {
    if (4 === ~~i.readyState) {
      if (i.onreadystatechange = null, 200 !== ~~i.status) {
        return t(new Error("Error loading json: " + e));
      }
      var n;
      try {
        n = JSON.parse(i.responseText);
      } catch (o) {
        return t(o);
      }
      return t(null, n);
    }
  };
  i.open("GET", e, !0);
  i.send(null);
};
n.setAttribute("crossorigin", "anonymous");
n.onload = function () {
  return this.onload = null, this.onerror = null, t();
};
n.onerror = function () {
  return this.onload = null, this.onerror = null, t(new Error("Error loading script: " + e));
};
n.type = "text/javascript";
n.src = e;
i.appendChild(n);
i.overrideMimeType("application/json");
i.onreadystatechange = function () {
  if (4 === ~~i.readyState) {
    if (i.onreadystatechange = null, 200 !== ~~i.status) {
      return t(new Error("Error loading json: " + e));
    }
    var n;
    try {
      n = JSON.parse(i.responseText);
    } catch (o) {
      return t(o);
    }
    return t(null, n);
  }
};
i.open("GET", e, !0);
i.send(null);
i.EventEmitter = i;
e.exports = i;
i.listenerCount = function (e, t) {
  var i = e.eventHandlers[t];
  return i ? i.length : 0;
};
i.prototype.on = function (e, t) {
  if ("function" != typeof t) {
    return console.warn("Tried to register non-function", t, "as event handler for event:", e), this;
  }
  this.emit("newListener", e, t);
  var i = this.eventHandlers,
    n = i[e];
  return void 0 === n ? (i[e] = [t], this) : (n.push(t), this);
};
i.prototype.addListener = i.prototype.on;
i.prototype.once = function (e, t) {
  return t.once ? t.once += 1 : t.once = 1, this.on(e, t);
};
i.prototype.setMaxListeners = function () {
  console.warn("Method setMaxListeners not supported, there is no limit to the number of listeners");
};
i.prototype.removeListener = function (e, t) {
  var i = this.eventHandlers[e];
  if (void 0 !== i) {
    var n = i.indexOf(t);
    n !== -1 && (i.splice(n, 1), this.emit("removeListener", e, t), 0 === i.length && delete this.eventHandlers[e]);
  }
  return this;
};
i.prototype.removeAllListeners = function (e) {
  return e ? delete this.eventHandlers[e] : this.eventHandlers = {}, this;
};
i.prototype.hasListeners = function (e) {
  return void 0 !== this.eventHandlers[e];
};
i.prototype.listeners = function (e) {
  var t = this.eventHandlers[e];
  return void 0 !== t ? t.slice() : [];
};
Object.keys(I).forEach(function (e) {
  "function" == typeof w[e] ? w["_" + e] = w[e] : "object" == typeof w[e] && (w["_" + e] = Function.prototype.bind.call(w[e], w));
});
a.prototype.addChannel = function (e) {
  var t,
    i = Array.prototype.slice,
    n = "%c[" + e + "]",
    o = "background-color: transparent;",
    a = v[e] || 0;
  A[e] && (o = A[e]);
  a > v.warning && (t = w._error);
  !t && a >= v.warning && (t = w._warn);
  !t && w._info && a >= v.info && (t = w._info);
  !t && w._debug && a >= v.debug && (t = w._debug);
  t || (t = w._log);
  y.on(e, function (e) {
    var a = i.call(e),
      s = n;
    return w.group && y.groups ? (w.group(s, o), t.apply(w, a), void w.groupEnd()) : ("string" == typeof a[0] && (s = s + " " + a.shift()), e = [s, o].concat(a), void t.apply(w, e));
  });
};
s.prototype.addChannel = function (e) {
  var t = window.navigator || {},
    i = window.fetch || {},
    n = i.polyfill,
    a = {
      userAgent: t.userAgent || "unknown",
      clientConfig: d,
      isFetchPolyfill: n,
      identifier: _.identifier
    };
  y.on(e, function (t) {
    var i = p(t);
    i.data || (i.data = {});
    Array.isArray(i.data.error) && i.data.error.length > b && (i.data.error.length = b);
    a.characterInfo = o();
    i.data.clientInfo = a;
    var n = window.Config && window.Config.dataUrl || "",
      s = {};
    s.Accept = "application/json";
    s["Content-Type"] = "application/json";
    window.fetch(n + "/logger", {
      method: "post",
      headers: s,
      body: JSON.stringify({
        channelName: e,
        message: i.message,
        data: i.data,
        report: i
      })
    });
  });
};
A[e] && (o = A[e]);
a > v.warning && (t = w._error);
!t && a >= v.warning && (t = w._warn);
!t && w._info && a >= v.info && (t = w._info);
!t && w._debug && a >= v.debug && (t = w._debug);
t || (t = w._log);
y.on(e, function (e) {
  var a = i.call(e),
    s = n;
  return w.group && y.groups ? (w.group(s, o), t.apply(w, a), void w.groupEnd()) : ("string" == typeof a[0] && (s = s + " " + a.shift()), e = [s, o].concat(a), void t.apply(w, e));
});
i.data || (i.data = {});
Array.isArray(i.data.error) && i.data.error.length > b && (i.data.error.length = b);
a.characterInfo = o();
i.data.clientInfo = a;
s.Accept = "application/json";
s["Content-Type"] = "application/json";
window.fetch(n + "/logger", {
  method: "post",
  headers: s,
  body: JSON.stringify({
    channelName: e,
    message: i.message,
    data: i.data,
    report: i
  })
});
y.setup = function (e) {
  e = e || {};
  var t = e.logging || {};
  c(e);
  v = t.logLevels || {};
  y.groups = t.groups;
  l(t.config);
  t.disableOverride || (y.overrideConsole(), y.logUncaughtExceptions("error", !1));
  window.gui.on("disconnect", function () {
    T = g.now();
  });
  f.on("CharacterSelectedSuccessMessage", function () {
    C = g.now();
  });
};
y.overrideConsole = function () {
  Object.keys(I).forEach(function (e) {
    var t = I[e];
    w[e] = function () {
      y.emit(t, arguments);
    };
  });
};
y.logUncaughtExceptions = function (e, t) {
  var i = window.ErrorEvent;
  window.onerror && y.debug("window.onerror was already assigned, overwriting.");
  window.onerror = function (n, o, a, s, r) {
    if (i && n instanceof i) {
      y.emit(e, [n, r]);
    } else if (i && window.event instanceof i) {
      y.emit(e, [window.event, r]);
    } else {
      var l = [{
        message: n,
        url: o,
        lineno: a,
        colno: s
      }];
      r && l.push(r);
      y.emit(e, l);
    }
    if (!t) {
      return !0;
    }
  };
};
e.exports = y;
c(e);
v = t.logLevels || {};
y.groups = t.groups;
l(t.config);
t.disableOverride || (y.overrideConsole(), y.logUncaughtExceptions("error", !1));
window.gui.on("disconnect", function () {
  T = g.now();
});
f.on("CharacterSelectedSuccessMessage", function () {
  C = g.now();
});
window.onerror && y.debug("window.onerror was already assigned, overwriting.");
window.onerror = function (n, o, a, s, r) {
  if (i && n instanceof i) {
    y.emit(e, [n, r]);
  } else if (i && window.event instanceof i) {
    y.emit(e, [window.event, r]);
  } else {
    var l = [{
      message: n,
      url: o,
      lineno: a,
      colno: s
    }];
    r && l.push(r);
    y.emit(e, l);
  }
  if (!t) {
    return !0;
  }
};
r && l.push(r);
y.emit(e, l);
t.setAccountInfo = function (e, t) {
  n = {};
  var o = t % 10,
    a = !1;
  1 === o && (e += "1", a = !0);
  var s = e.indexOf("W") !== -1,
    r = e.indexOf("Q") !== -1;
  n.decoRecoResend = s || r || a;
  n.scrollerBoundToWrapper = s || r;
  n.singleTooltip = s || r;
  i = e;
};
t.isFeatureOn = function (e) {
  return void 0 === i && console.warn("isFeatureOn(" + e + ") called before we can tell"), !!n[e];
};
t.getGroupFlags = function () {
  return i;
};
n.decoRecoResend = s || r || a;
n.scrollerBoundToWrapper = s || r;
n.singleTooltip = s || r;
i = e;
o = [i(41)];
n = r;
a = "function" == typeof n ? n.apply(t, o) : n;
!(void 0 !== a && (e.exports = a));
o = [];
n = s;
a = "function" == typeof n ? n.apply(t, o) : n;
!(void 0 !== a && (e.exports = a));
n.prototype = {
  getArgs: function () {
    return this.args;
  },
  setArgs: function (e) {
    if ("[object Array]" !== Object.prototype.toString.call(e)) {
      throw new TypeError("Args must be an Array");
    }
    this.args = e;
  },
  getEvalOrigin: function () {
    return this.evalOrigin;
  },
  setEvalOrigin: function (e) {
    if (e instanceof n) {
      this.evalOrigin = e;
    } else {
      if (!(e instanceof Object)) {
        throw new TypeError("Eval Origin must be an Object or StackFrame");
      }
      this.evalOrigin = new n(e);
    }
  },
  toString: function () {
    var e = this.getFileName() || "",
      t = this.getLineNumber() || "",
      i = this.getColumnNumber() || "",
      n = this.getFunctionName() || "";
    return this.getIsEval() ? e ? "[eval] (" + e + ":" + t + ":" + i + ")" : "[eval]:" + t + ":" + i : n ? n + " (" + e + ":" + t + ":" + i + ")" : e + ":" + t + ":" + i;
  }
};
n.fromString = function (e) {
  var t = e.indexOf("("),
    i = e.lastIndexOf(")"),
    o = e.substring(0, t),
    a = e.substring(t + 1, i).split(","),
    s = e.substring(i + 1);
  if (0 === s.indexOf("@")) {
    var r = /@(.+?)(?::(\d+))?(?::(\d+))?$/.exec(s, ""),
      l = r[1],
      c = r[2],
      d = r[3];
  }
  return new n({
    functionName: o,
    args: a || void 0,
    fileName: l,
    lineNumber: c || void 0,
    columnNumber: d || void 0
  });
};
n.prototype["get" + t(o[d])] = i(o[d]);
n.prototype["set" + t(o[d])] = function (e) {
  return function (t) {
    this[e] = Boolean(t);
  };
}(o[d]);
n.prototype["get" + t(a[u])] = i(a[u]);
n.prototype["set" + t(a[u])] = function (t) {
  return function (i) {
    if (!e(i)) {
      throw new TypeError(t + " must be a Number");
    }
    this[t] = Number(i);
  };
}(a[u]);
n.prototype["get" + t(s[h])] = i(s[h]);
n.prototype["set" + t(s[h])] = function (e) {
  return function (t) {
    this[e] = String(t);
  };
}(s[h]);
d = !0;
u = w;
h = !0;
p = w;
T = !0;
C = w;
Object.defineProperty(t, "__esModule", {
  value: !0
});
t["default"] = l;
Object.defineProperty(t, "__esModule", {
  value: !0
});
t.getID = i;
Object.defineProperty(t, "__esModule", {
  value: !0
});
t.getClasses = i;
t.getClassSelectors = n;
n[s] = t[l];
i(e, t, n, l + 1, a, s + 1, r);
Object.defineProperty(t, "__esModule", {
  value: !0
});
t.getCombinations = n;
Object.defineProperty(t, "__esModule", {
  value: !0
});
t.getAttributes = n;
Object.defineProperty(t, "__esModule", {
  value: !0
});
t.getNthChild = n;
Object.defineProperty(t, "__esModule", {
  value: !0
});
t.getTag = i;
Object.defineProperty(t, "__esModule", {
  value: !0
});
t.isUnique = i;
t.push(i);
i = i.parentNode;
Object.defineProperty(t, "__esModule", {
  value: !0
});
t.getParents = n;
delete e.closingTweener;
e.hide();
e.emit("closed", t);
v.emit("closed", {
  id: e.id
});
e.id.indexOf("#") !== -1 && (y[e.id].destroy(), delete y[e.id]);
i || (e.emit("opened", t), v.emit("opened", {
  id: e.id
}));
delete e.openingTweener;
T.splice(a, 1);
i === b && (b = null);
i.openState = !1;
M = e;
i.emit("close", t);
v.emit("close", {
  id: e
});
w = null;
window.foreground.unlock("windowsManagerDialog");
v.makeMovable = function (e, t) {
  function i() {
    e.position.x = n;
    e.position.y = o;
    e.emit("positioned");
  }
  t = t || e.windowHeadWrapper;
  u(t);
  var n, o, a, s, l, c;
  t.on("slideStart", function (i, r) {
    if (!e.openState) {
      return t.cancelSlide();
    }
    var d = f(e.rootElement),
      u = r.left - d.left,
      h = r.top - d.top;
    l = d.width;
    c = r.height + h;
    a = i.x - r.left + u;
    s = i.y - r.top + h;
    n = e.position.x;
    o = e.position.y;
  });
  t.on("slideEnd", i);
  t.on("slideCancel", i);
  t.on("slide", function (t) {
    n = t.x - a;
    o = t.y - s;
    n < 0 ? n = 0 : n + l > r.windowFullScreenWidth && (n = r.windowFullScreenWidth - l);
    o < 0 ? o = 0 : o + c > r.windowFullScreenHeight && (o = r.windowFullScreenHeight - c);
    e.setStyle("webkitTransform", "translate3d(" + n + "px, " + o + "px, 0)");
  });
};
v.initialize = function (e) {
  e.on("disconnect", function () {
    w = null;
    M = null;
  });
  e.on("ExchangeLeaveMessage", s);
  e.on("LeaveDialogMessage", s);
};
v.addWindow = function (e, t, i) {
  function n() {
    v.focusWindow(e);
  }
  i = i || {};
  y[e] = t;
  t.windowManager = v;
  t.id = e;
  i.group && (t.group = i.group);
  t.hide();
  t.openState = !1;
  var o = i.container || window.gui.windowsContainer;
  o.appendChild(t);
  t.allowDomEvents();
  t.on("dom.touchstart", n);
  d(t.header);
  t.header.on("doubletap", function () {
    v.positionWindow(e);
  });
  i.fixed || v.makeMovable(t);
};
v.open = function (e, t) {
  if (t = t || {}, t.forceToOpen || !window.gui.uiLocker || !window.gui.uiLocker.isFeatureLockedByWindow(e, t.tabId)) {
    if (("market" === e || "DailyQuestRerollWindow" === e) && window.gui.playerData.isShopDisabled() && window.gui.scenarioManager.isBehaviourEnabled(g.DISABLE_FAKE_SHOP)) {
      return void window.gui.openPopup({
        title: h("tablet.window.shop.title"),
        message: h("ui.popup.accessDenied.serviceUnavailable")
      });
    }
    if ("register" === e && window.Config.disabledFeatures.guest) {
      return window.gui.openPopup({
        title: h("ui.login.createAccount"),
        message: h("ui.popup.accessDenied.serviceUnavailable")
      }), console.error(new Error("windowsManager: register should not open"));
    }
    var i = y[e];
    if (!i) {
      return console.error("Invalid window: " + e);
    }
    i.closingTweener && (i.closingTweener.cancel(), n(i));
    var a = i.group;
    if (a) {
      for (var s in y) {
        var l = y[s];
        a === l.group && l.openState && e !== s && this.close(s);
      }
    }
    var d = i.positionInfo,
      u = i.position;
    if (d && !u && (i.position = u = m.buildWindowStyleFromInfo(d), i.setStyles({
      webkitTransform: "translate3d(" + u.x + "px," + u.y + "px,0) scale(0.8)",
      width: u.width + "px",
      height: u.height + "px",
      opacity: 0
    })), d && d.isModal || t.isModal) {
      i.addClassNames("modal");
      var p = window.gui.windowsContainer.createChild("div", {
        className: "modalWindowOverlay"
      });
      i.once("close", function () {
        p.destroy();
      });
    }
    i.openState = !0;
    i.show();
    this.emit("open", {
      id: e,
      extraParams: t
    });
    i.emit("open", t);
    v.focusWindow(e);
    u = i.position;
    var f = d && d.isDefault;
    return f || i.initialPosition || (i.initialPosition = {
      x: u.x,
      y: u.y,
      width: u.width,
      height: u.height
    }), u.x = Math.min(r.windowFullScreenWidth - u.width, Math.max(0, u.x)), u.y = Math.max(0, Math.min(r.windowFullScreenHeight - _, u.y)), i.openingTweener = c.tween(i, {
      opacity: 1,
      webkitTransform: "translate3d(" + u.x + "px," + u.y + "px,0) scale(1)"
    }, {
      time: 150,
      delay: 0,
      easing: "ease-out"
    }, function () {
      o(i, t);
    }), window.gui.splashScreen.hide(), i;
  }
};
v.focusWindow = function (e) {
  var t = y[e];
  if (t.openState && b !== t) {
    var i = T.indexOf(e);
    i !== -1 && T.splice(i, 1);
    T.unshift(e);
    b = t;
    t.getParent().appendChild(t);
    t.emit("focus");
  }
};
v.positionWindow = function (e, t) {
  var i,
    n = y[e];
  if (t) {
    i = m.buildWindowStyleFromInfo(t);
  } else if (n.initialPosition) {
    var o = n.initialPosition;
    i = {
      x: o.x,
      y: o.y,
      width: o.width,
      height: o.height
    };
  } else {
    i = m.buildWindowStyleFromInfo(n.positionInfo);
  }
  n.position = i;
  n.setStyles({
    width: i.width + "px",
    height: i.height + "px",
    webkitTransform: "translate3d(" + i.x + "px," + i.y + "px,0) scale(1)"
  });
  t ? n.emit("positioned") : n.emit("repositioned");
};
v.openDialog = function (e, t) {
  if (!w) {
    Array.isArray(e) || (e = [e]);
    w = e;
    for (var i = 0, n = e.length; i < n; i += 1) {
      v.open(e[i], t);
    }
    window.foreground.lock("windowsManagerDialog");
  }
};
v.continueDialog = function (e, t) {
  w = null;
  this.openDialog(e, t);
};
v.isDialogActive = function () {
  return !!w;
};
v.getLastFocusedWindowId = function () {
  return T.length > 0 ? T[0] : null;
};
v.isModalWindow = function (e) {
  var t = y[e];
  return t ? t.hasClassName("modal") : null;
};
v.close = function (e, t) {
  var i = t && t.keepDialog;
  return !i && w && w.indexOf(e) !== -1 ? (window.dofus.sendMessage("LeaveDialogRequestMessage", null), s()) : void a(e, t);
};
v._forceClose = function (e) {
  return w && w.indexOf(e) !== -1 ? (window.gui.isConnected && window.dofus.sendMessage("LeaveDialogRequestMessage", null), s()) : void a(e);
};
v.closeAll = function () {
  for (var e in y) {
    "popup" !== e && y[e].openState && this._forceClose(e);
  }
};
v["switch"] = function (e, t) {
  var i = y[e];
  i.openState ? i === b ? this.close(e) : v.focusWindow(e) : this.open(e, t);
};
v.getWindow = function (e) {
  return y[e];
};
v.moveAndResizeWindow = function (e, t, i, n, o) {
  var a = v.getWindow(e);
  if (a && a.openState) {
    var s = a.position.x,
      r = a.position.y,
      l = a.position.width,
      d = a.position.height;
    null !== t && void 0 !== t || (t = s);
    null !== i && void 0 !== i || (i = r);
    null !== n && void 0 !== n || (n = l);
    null !== o && void 0 !== o || (o = d);
    var u = "translate3d(" + t + "px, " + i + "px,0)";
    c.tween(a, {
      opacity: 1,
      webkitTransform: u,
      width: n + "px",
      height: o + "px"
    }, {
      time: 150,
      delay: 0,
      easing: "ease-out"
    }, function () {
      v.positionWindow(e, {
        left: t,
        top: i,
        width: n,
        height: o
      });
    });
  }
};
v.arrangeOpeningWindow = function (e, t) {
  var i = t.leftOf || t.rightOf,
    n = v.getWindow(e),
    o = v.getWindow(i);
  if (n && o.openState) {
    var a,
      s,
      l,
      c = n.position.width,
      d = o.position.width,
      u = o.position.x,
      h = u;
    t.leftOf ? (a = u - c, a < 0 && (a = 0, h = Math.min(c, r.screenWidth - d))) : t.rightOf && (a = u + d, a + c > r.screenWidth && (a = r.screenWidth - c, h = Math.max(0, a - d)));
    t.sameHeight && (s = n.position.height, l = n.position.y);
    n.position.x = a;
    t.height && (n.position.height = t.height);
    v.positionWindow(e, n.position);
    (h !== u || s) && v.moveAndResizeWindow(i, h, l, null, s);
  }
};
v.arrangeOpeningWindowVertically = function (e, t) {
  var i = t.below,
    n = v.getWindow(e),
    o = v.getWindow(i);
  if (n && o.openState) {
    var a;
    t.below && (a = o.position.y + o.position.height, t.fullHeight && (n.position.height = r.windowFullScreenHeight - a));
    n.position.x = o.position.x;
    n.position.y = a;
    t.height && (n.position.height = t.height);
    v.positionWindow(e, n.position);
  }
};
v.getOpenWindows = function () {
  var e = [];
  for (var t in y) {
    "popup" !== t && y[t].openState && ("function" == typeof y[t].getOpenedTabId ? e.push(t + " > " + y[t].getOpenedTabId()) : e.push(t));
  }
  return e;
};
v.getLastClosedWindow = function () {
  return M;
};
v.isWindowOpen = function (e) {
  if (this.getWindow(e)) {
    return this.getWindow(e).openState;
  }
};
v.createPanel = function (e, t, i) {
  i = i || {};
  for (var n, o = 1; n = e + "#" + o, y[n]; o++) {
    ;
  }
  var a;
  return t instanceof p ? a = t : (a = new p({
    className: e,
    title: i.title,
    positionInfo: {
      left: i.left || "c",
      top: i.top || "c",
      width: i.width || 250,
      height: i.height || 200
    },
    isModal: i.isModal,
    noCloseButton: i.noCloseButton
  }), a.windowBody.appendChild(t)), v.addWindow(n, a), v.open(n, i), a;
};
v.getPanel = function (e, t) {
  return y[e + "#" + t];
};
v.getWindowsReferences = function () {
  return y;
};
e.exports = v;
e.position.x = n;
e.position.y = o;
e.emit("positioned");
t = t || e.windowHeadWrapper;
u(t);
t.on("slideStart", function (i, r) {
  if (!e.openState) {
    return t.cancelSlide();
  }
  var d = f(e.rootElement),
    u = r.left - d.left,
    h = r.top - d.top;
  l = d.width;
  c = r.height + h;
  a = i.x - r.left + u;
  s = i.y - r.top + h;
  n = e.position.x;
  o = e.position.y;
});
t.on("slideEnd", i);
t.on("slideCancel", i);
t.on("slide", function (t) {
  n = t.x - a;
  o = t.y - s;
  n < 0 ? n = 0 : n + l > r.windowFullScreenWidth && (n = r.windowFullScreenWidth - l);
  o < 0 ? o = 0 : o + c > r.windowFullScreenHeight && (o = r.windowFullScreenHeight - c);
  e.setStyle("webkitTransform", "translate3d(" + n + "px, " + o + "px, 0)");
});
l = d.width;
c = r.height + h;
a = i.x - r.left + u;
s = i.y - r.top + h;
n = e.position.x;
o = e.position.y;
n = t.x - a;
o = t.y - s;
n < 0 ? n = 0 : n + l > r.windowFullScreenWidth && (n = r.windowFullScreenWidth - l);
o < 0 ? o = 0 : o + c > r.windowFullScreenHeight && (o = r.windowFullScreenHeight - c);
e.setStyle("webkitTransform", "translate3d(" + n + "px, " + o + "px, 0)");
e.on("disconnect", function () {
  w = null;
  M = null;
});
e.on("ExchangeLeaveMessage", s);
e.on("LeaveDialogMessage", s);
w = null;
M = null;
i = i || {};
y[e] = t;
t.windowManager = v;
t.id = e;
i.group && (t.group = i.group);
t.hide();
t.openState = !1;
o.appendChild(t);
t.allowDomEvents();
t.on("dom.touchstart", n);
d(t.header);
t.header.on("doubletap", function () {
  v.positionWindow(e);
});
i.fixed || v.makeMovable(t);
i.openState = !0;
i.show();
this.emit("open", {
  id: e,
  extraParams: t
});
i.emit("open", t);
v.focusWindow(e);
u = i.position;
i !== -1 && T.splice(i, 1);
T.unshift(e);
b = t;
t.getParent().appendChild(t);
t.emit("focus");
n.position = i;
n.setStyles({
  width: i.width + "px",
  height: i.height + "px",
  webkitTransform: "translate3d(" + i.x + "px," + i.y + "px,0) scale(1)"
});
t ? n.emit("positioned") : n.emit("repositioned");
Array.isArray(e) || (e = [e]);
w = e;
w = null;
this.openDialog(e, t);
null !== t && void 0 !== t || (t = s);
null !== i && void 0 !== i || (i = r);
null !== n && void 0 !== n || (n = l);
null !== o && void 0 !== o || (o = d);
t.leftOf ? (a = u - c, a < 0 && (a = 0, h = Math.min(c, r.screenWidth - d))) : t.rightOf && (a = u + d, a + c > r.screenWidth && (a = r.screenWidth - c, h = Math.max(0, a - d)));
t.sameHeight && (s = n.position.height, l = n.position.y);
n.position.x = a;
t.height && (n.position.height = t.height);
v.positionWindow(e, n.position);
(h !== u || s) && v.moveAndResizeWindow(i, h, l, null, s);
t.below && (a = o.position.y + o.position.height, t.fullHeight && (n.position.height = r.windowFullScreenHeight - a));
n.position.x = o.position.x;
n.position.y = a;
t.height && (n.position.height = t.height);
v.positionWindow(e, n.position);
m.mapWidth = ~~(s.MAP_SCENE_WIDTH * t);
m.mapHeight = ~~(s.MAP_SCENE_HEIGHT * t);
m.zoom = s.PIXEL_RATIO * t;
m.sideBarWidth = m.screenWidth - m.mapWidth;
m.bottomBarHeight = m.screenHeight - m.mapHeight;
"narrow" === e ? (m.posChatBtn = a, a += n, m.pingEmoteBtnSize = o, m.posPingEmoteBtn = a, a += o) : (m.pingEmoteBtnSize = o, o = 0);
m.posMainControlBar = a;
a += m.mainControlBarSize;
m.menuBarSize = p + _;
m.shortcutBarSize = g;
m.posShortcutBar = a;
a += m.shortcutBarSize;
m.posMenuBar = a;
a += m.menuBarSize;
"wide" === e && (m.posChatBtn = a, m.posPingEmoteBtn = a);
t.dimensions = m;
t.updateScreen = function () {
  m.bodyPaddingLeft = parseInt(p.getPropertyValue("padding-left"), 10);
  m.bodyPaddingRight = parseInt(p.getPropertyValue("padding-right"), 10);
  m.viewportWidth = m.viewportWidth || c.document.documentElement.clientWidth;
  m.viewportHeight = m.viewportHeight || c.document.documentElement.clientHeight;
  m.screenWidth = m.viewportWidth - m.bodyPaddingLeft - m.bodyPaddingRight;
  m.screenHeight = m.viewportHeight;
  m.windowFullScreenWidth = m.screenWidth;
  m.windowFullScreenHeight = m.screenHeight;
  m.physicalToViewportRatio = m.viewportWidth / m.physicalScreenWidth;
};
t.updateScreen();
t.resizeNarrowScreen = function (e) {
  var t = "narrow",
    i = m.screenHeight - a(t, e),
    r = i / s.MAP_SCENE_HEIGHT,
    l = ~~(s.MAP_SCENE_WIDTH * r);
  l > m.screenWidth && (r = m.screenWidth / s.MAP_SCENE_WIDTH, i = ~~(s.MAP_SCENE_HEIGHT * r));
  n(i);
  m.bottomBarHeight = Math.min(m.bottomBarHeight, d);
  o(t, e);
  m.mapLeft = Math.round(m.sideBarWidth / 2);
  m.mapTop = m.screenHeight - m.bottomBarHeight - m.mapHeight;
  m.mapRight = m.mapLeft + m.mapWidth;
  m.mapBottom = m.mapTop + m.mapHeight;
  m.windowFullScreenWidth = m.screenWidth;
  m.windowFullScreenHeight = m.mapBottom;
  m.screenExceptToolbar = {
    left: 0,
    top: 0,
    width: m.screenWidth,
    height: m.screenHeight - m.bottomBarHeight
  };
};
t.resizeWideScreen = function (e) {
  var t = "wide",
    i = m.screenWidth - a(t, e),
    l = i / s.MAP_SCENE_WIDTH,
    c = ~~(s.MAP_SCENE_HEIGHT * l);
  n(Math.min(c, m.screenHeight));
  m.sideBarWidth = r.fullscreen ? m.sideBarWidth : Math.min(m.sideBarWidth, u);
  o(t, e);
  m.mapLeft = r.fullscreen ? 0 : m.screenWidth - m.sideBarWidth - m.mapWidth;
  m.mapTop = Math.round(m.bottomBarHeight / 2);
  m.mapRight = m.mapLeft + m.mapWidth;
  m.mapBottom = m.mapTop + m.mapHeight;
  m.windowFullScreenWidth = m.screenWidth;
  m.windowFullScreenHeight = m.screenHeight;
  m.screenExceptToolbar = {
    left: 0,
    top: 0,
    width: m.screenWidth - m.sideBarWidth,
    height: m.screenHeight
  };
};
m.bodyPaddingLeft = parseInt(p.getPropertyValue("padding-left"), 10);
m.bodyPaddingRight = parseInt(p.getPropertyValue("padding-right"), 10);
m.viewportWidth = m.viewportWidth || c.document.documentElement.clientWidth;
m.viewportHeight = m.viewportHeight || c.document.documentElement.clientHeight;
m.screenWidth = m.viewportWidth - m.bodyPaddingLeft - m.bodyPaddingRight;
m.screenHeight = m.viewportHeight;
m.windowFullScreenWidth = m.screenWidth;
m.windowFullScreenHeight = m.screenHeight;
m.physicalToViewportRatio = m.viewportWidth / m.physicalScreenWidth;
l > m.screenWidth && (r = m.screenWidth / s.MAP_SCENE_WIDTH, i = ~~(s.MAP_SCENE_HEIGHT * r));
n(i);
m.bottomBarHeight = Math.min(m.bottomBarHeight, d);
o(t, e);
m.mapLeft = Math.round(m.sideBarWidth / 2);
m.mapTop = m.screenHeight - m.bottomBarHeight - m.mapHeight;
m.mapRight = m.mapLeft + m.mapWidth;
m.mapBottom = m.mapTop + m.mapHeight;
m.windowFullScreenWidth = m.screenWidth;
m.windowFullScreenHeight = m.mapBottom;
m.screenExceptToolbar = {
  left: 0,
  top: 0,
  width: m.screenWidth,
  height: m.screenHeight - m.bottomBarHeight
};
n(Math.min(c, m.screenHeight));
m.sideBarWidth = r.fullscreen ? m.sideBarWidth : Math.min(m.sideBarWidth, u);
o(t, e);
m.mapLeft = r.fullscreen ? 0 : m.screenWidth - m.sideBarWidth - m.mapWidth;
m.mapTop = Math.round(m.bottomBarHeight / 2);
m.mapRight = m.mapLeft + m.mapWidth;
m.mapBottom = m.mapTop + m.mapHeight;
m.windowFullScreenWidth = m.screenWidth;
m.windowFullScreenHeight = m.screenHeight;
m.screenExceptToolbar = {
  left: 0,
  top: 0,
  width: m.screenWidth - m.sideBarWidth,
  height: m.screenHeight
};
a.call(this);
this.optionDefs = null;
this.menubarSizeInFight = null;
this.menubarSize = null;
this.toolbarThicknessInFight = null;
this.isEmitting = null;
o(n, a);
e.exports = new n();
n.prototype.initialize = function (e) {
  this.optionDefs = {
    showAllMonsters: {
      init: !0
    },
    maxTitlesOrnaments: {
      init: 1
    },
    maxActorsBeforeCreatureMode: {
      init: 9999,
      onChange: window.actorManager.onMaxActorsBeforeCreatureModeChange.bind(window.actorManager)
    },
    hideDeadFighters: {
      init: !0
    },
    showMountsInFight: {
      init: !0
    },
    allowSpellEffects: {
      init: !0
    },
    autoGpsFlags: {
      init: !0
    },
    autoGpsPhoenixes: {
      init: !0
    },
    limitToNotch: {
      init: !0
    },
    monsterInfoFirstPosition: {
      init: !1
    },
    menubarSize: {
      init: e.ipadRatio ? 6 : 3
    },
    menubarSizeInFight: {
      init: e.ipadRatio ? 3 : 2
    },
    toolbarThicknessInFight: {
      init: 1
    },
    censorship: {
      init: !0
    },
    chatTimestamp: {
      init: !1
    },
    topChatBar: {
      init: !0
    },
    tutorialTips: {
      init: !0
    },
    soundOnPlayerTurnStart: {
      init: !0
    },
    alwaysShowGrid: {
      init: !1
    },
    fightAlwaysShowGrid: {
      init: !0
    },
    regroupDamages: {
      init: !0
    },
    allowDamagePreview: {
      init: !0
    },
    spellTooltipName: {
      init: !0
    },
    spellTooltipApRange: {
      init: !0
    },
    spellTooltipCritical: {
      init: !1
    },
    spellTooltipEffect: {
      init: !0
    },
    spellTooltipDescription: {
      init: !0
    },
    confirmBoxAllowDoubleTap: {
      init: !1
    },
    confirmBoxWhenDragCasting: {
      init: r.ALWAYS
    },
    confirmBoxWhenClickCasting: {
      init: r.ALWAYS
    },
    confirmBoxWhenWalking: {
      init: !0
    },
    showSpeechBubbleInFight: {
      init: !0
    },
    fullscreen: {
      init: !1
    },
    orderFighters: {
      init: !1
    },
    showApMpUsed: {
      init: !1
    },
    offlineOptionTimestamp: {
      init: 0
    },
    systemNotificationsEnabled: {
      init: !1
    },
    wantPromoNotif: {
      init: !0
    },
    wantPrismAttackedNotif: {
      init: !0
    },
    wantPrismVulnerableNotif: {
      init: !0
    },
    petFeedingNotifTime: {
      init: "19:00"
    }
  };
  this._loadAllOptions();
};
n.prototype._loadAllOptions = function () {
  for (var e in this.optionDefs) {
    var t = this.optionDefs[e];
    this[e] = s.getValue(l + e, t.init);
  }
};
n.prototype.changeValue = function (e, t, i) {
  var n = this[e];
  if (t !== n) {
    this[e] = t;
    s.setValue(l + e, t);
    var o = this.optionDefs[e];
    o.onChange && o.onChange(t, n);
    this.isEmitting && console.error("GameOptions: change " + e + " is reentering change " + this.isEmitting);
    this.isEmitting = e;
    this.emit(e, t, n, i);
    this.isEmitting = null;
  }
};
this.optionDefs = {
  showAllMonsters: {
    init: !0
  },
  maxTitlesOrnaments: {
    init: 1
  },
  maxActorsBeforeCreatureMode: {
    init: 9999,
    onChange: window.actorManager.onMaxActorsBeforeCreatureModeChange.bind(window.actorManager)
  },
  hideDeadFighters: {
    init: !0
  },
  showMountsInFight: {
    init: !0
  },
  allowSpellEffects: {
    init: !0
  },
  autoGpsFlags: {
    init: !0
  },
  autoGpsPhoenixes: {
    init: !0
  },
  limitToNotch: {
    init: !0
  },
  monsterInfoFirstPosition: {
    init: !1
  },
  menubarSize: {
    init: e.ipadRatio ? 6 : 3
  },
  menubarSizeInFight: {
    init: e.ipadRatio ? 3 : 2
  },
  toolbarThicknessInFight: {
    init: 1
  },
  censorship: {
    init: !0
  },
  chatTimestamp: {
    init: !1
  },
  topChatBar: {
    init: !0
  },
  tutorialTips: {
    init: !0
  },
  soundOnPlayerTurnStart: {
    init: !0
  },
  alwaysShowGrid: {
    init: !1
  },
  fightAlwaysShowGrid: {
    init: !0
  },
  regroupDamages: {
    init: !0
  },
  allowDamagePreview: {
    init: !0
  },
  spellTooltipName: {
    init: !0
  },
  spellTooltipApRange: {
    init: !0
  },
  spellTooltipCritical: {
    init: !1
  },
  spellTooltipEffect: {
    init: !0
  },
  spellTooltipDescription: {
    init: !0
  },
  confirmBoxAllowDoubleTap: {
    init: !1
  },
  confirmBoxWhenDragCasting: {
    init: r.ALWAYS
  },
  confirmBoxWhenClickCasting: {
    init: r.ALWAYS
  },
  confirmBoxWhenWalking: {
    init: !0
  },
  showSpeechBubbleInFight: {
    init: !0
  },
  fullscreen: {
    init: !1
  },
  orderFighters: {
    init: !1
  },
  showApMpUsed: {
    init: !1
  },
  offlineOptionTimestamp: {
    init: 0
  },
  systemNotificationsEnabled: {
    init: !1
  },
  wantPromoNotif: {
    init: !0
  },
  wantPrismAttackedNotif: {
    init: !0
  },
  wantPrismVulnerableNotif: {
    init: !0
  },
  petFeedingNotifTime: {
    init: "19:00"
  }
};
this._loadAllOptions();
this[e] = t;
s.setValue(l + e, t);
o.onChange && o.onChange(t, n);
this.isEmitting && console.error("GameOptions: change " + e + " is reentering change " + this.isEmitting);
this.isEmitting = e;
this.emit(e, t, n, i);
this.isEmitting = null;
s = JSON.stringify("" + o);
s.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/) ? (s = s.substr(1, s.length - 2), s = e.stylize(s, "name")) : (s = s.replace(/'/g, "\\'").replace(/\\"/g, '"').replace(/(^"|"$)/g, "'"), s = e.stylize(s, "string"));
t.format = function (e) {
  if (!y(e)) {
    for (var t = [], i = 0; i < arguments.length; i++) {
      t.push(o(arguments[i]));
    }
    return t.join(" ");
  }
  for (var i = 1, n = arguments, a = n.length, s = String(e).replace(O, function (e) {
      if ("%%" === e) {
        return "%";
      }
      if (i >= a) {
        return e;
      }
      switch (e) {
        case "%s":
          return String(n[i++]);
        case "%d":
          return Number(n[i++]);
        case "%j":
          try {
            return JSON.stringify(n[i++]);
          } catch (t) {
            return "[Circular]";
          }
        default:
          return e;
      }
    }), r = n[i]; i < a; r = n[++i]) {
    s += g(r) || !T(r) ? " " + r : " " + o(r);
  }
  return s;
};
t.deprecate = function (i, o) {
  function a() {
    if (!s) {
      if (n.throwDeprecation) {
        throw new Error(o);
      }
      n.traceDeprecation ? console.trace(o) : console.error(o);
      s = !0;
    }
    return i.apply(this, arguments);
  }
  if (b(e.process)) {
    return function () {
      return t.deprecate(i, o).apply(this, arguments);
    };
  }
  if (n.noDeprecation === !0) {
    return i;
  }
  var s = !1;
  return a;
};
n.traceDeprecation ? console.trace(o) : console.error(o);
s = !0;
t.debuglog = function (e) {
  if (b(R) && (R = n.env.NODE_DEBUG || ""), e = e.toUpperCase(), !D[e]) {
    if (new RegExp("\\b" + e + "\\b", "i").test(R)) {
      var i = n.pid;
      D[e] = function () {
        var n = t.format.apply(t, arguments);
        console.error("%s %d: %s", e, i, n);
      };
    } else {
      D[e] = function () {};
    }
  }
  return D[e];
};
t.inspect = o;
o.colors = {
  bold: [1, 22],
  italic: [3, 23],
  underline: [4, 24],
  inverse: [7, 27],
  white: [37, 39],
  grey: [90, 39],
  black: [30, 39],
  blue: [34, 39],
  cyan: [36, 39],
  green: [32, 39],
  magenta: [35, 39],
  red: [31, 39],
  yellow: [33, 39]
};
o.styles = {
  special: "cyan",
  number: "yellow",
  "boolean": "yellow",
  undefined: "grey",
  "null": "bold",
  string: "green",
  date: "magenta",
  regexp: "red"
};
t.isArray = m;
t.isBoolean = f;
t.isNull = g;
t.isNullOrUndefined = _;
t.isNumber = v;
t.isString = y;
t.isSymbol = w;
t.isUndefined = b;
t.isRegExp = M;
t.isObject = T;
t.isDate = C;
t.isError = I;
t.isFunction = A;
t.isPrimitive = S;
t.isBuffer = i(57);
t.log = function () {
  console.log("%s - %s", x(), t.format.apply(t, arguments));
};
t.inherits = i(58);
t._extend = function (e, t) {
  if (!t || !T(t)) {
    return e;
  }
  for (var i = Object.keys(t), n = i.length; n--;) {
    e[i[n]] = t[i[n]];
  }
  return e;
};
e.super_ = t;
e.prototype = Object.create(t.prototype, {
  constructor: {
    value: e,
    enumerable: !1,
    writable: !0,
    configurable: !0
  }
});
i.prototype = t.prototype;
e.prototype = new i();
e.prototype.constructor = e;
this._events = this._events || {};
this._maxListeners = this._maxListeners || void 0;
e.exports = i;
i.EventEmitter = i;
i.prototype._events = void 0;
i.prototype._maxListeners = void 0;
i.defaultMaxListeners = 10;
i.prototype.setMaxListeners = function (e) {
  if (!o(e) || e < 0 || isNaN(e)) {
    throw TypeError("n must be a positive number");
  }
  return this._maxListeners = e, this;
};
i.prototype.emit = function (e) {
  var t, i, o, r, l, c;
  if (this._events || (this._events = {}), "error" === e && (!this._events.error || a(this._events.error) && !this._events.error.length)) {
    if (t = arguments[1], t instanceof Error) {
      throw t;
    }
    var d = new Error('Uncaught, unspecified "error" event. (' + t + ")");
    throw d.context = t, d;
  }
  if (i = this._events[e], s(i)) {
    return !1;
  }
  if (n(i)) {
    switch (arguments.length) {
      case 1:
        i.call(this);
        break;
      case 2:
        i.call(this, arguments[1]);
        break;
      case 3:
        i.call(this, arguments[1], arguments[2]);
        break;
      default:
        r = Array.prototype.slice.call(arguments, 1);
        i.apply(this, r);
    }
  } else if (a(i)) {
    for (r = Array.prototype.slice.call(arguments, 1), c = i.slice(), o = c.length, l = 0; l < o; l++) {
      c[l].apply(this, r);
    }
  }
  return !0;
};
i.prototype.addListener = function (e, t) {
  var o;
  if (!n(t)) {
    throw TypeError("listener must be a function");
  }
  return this._events || (this._events = {}), this._events.newListener && this.emit("newListener", e, n(t.listener) ? t.listener : t), this._events[e] ? a(this._events[e]) ? this._events[e].push(t) : this._events[e] = [this._events[e], t] : this._events[e] = t, a(this._events[e]) && !this._events[e].warned && (o = s(this._maxListeners) ? i.defaultMaxListeners : this._maxListeners, o && o > 0 && this._events[e].length > o && (this._events[e].warned = !0, console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.", this._events[e].length), "function" == typeof console.trace && console.trace())), this;
};
i.prototype.on = i.prototype.addListener;
i.prototype.once = function (e, t) {
  function i() {
    this.removeListener(e, i);
    o || (o = !0, t.apply(this, arguments));
  }
  if (!n(t)) {
    throw TypeError("listener must be a function");
  }
  var o = !1;
  return i.listener = t, this.on(e, i), this;
};
i.prototype.removeListener = function (e, t) {
  var i, o, s, r;
  if (!n(t)) {
    throw TypeError("listener must be a function");
  }
  if (!this._events || !this._events[e]) {
    return this;
  }
  if (i = this._events[e], s = i.length, o = -1, i === t || n(i.listener) && i.listener === t) {
    delete this._events[e];
    this._events.removeListener && this.emit("removeListener", e, t);
  } else if (a(i)) {
    for (r = s; r-- > 0;) {
      if (i[r] === t || i[r].listener && i[r].listener === t) {
        o = r;
        break;
      }
    }
    if (o < 0) {
      return this;
    }
    1 === i.length ? (i.length = 0, delete this._events[e]) : i.splice(o, 1);
    this._events.removeListener && this.emit("removeListener", e, t);
  }
  return this;
};
i.prototype.removeAllListeners = function (e) {
  var t, i;
  if (!this._events) {
    return this;
  }
  if (!this._events.removeListener) {
    return 0 === arguments.length ? this._events = {} : this._events[e] && delete this._events[e], this;
  }
  if (0 === arguments.length) {
    for (t in this._events) {
      "removeListener" !== t && this.removeAllListeners(t);
    }
    return this.removeAllListeners("removeListener"), this._events = {}, this;
  }
  if (i = this._events[e], n(i)) {
    this.removeListener(e, i);
  } else if (i) {
    for (; i.length;) {
      this.removeListener(e, i[i.length - 1]);
    }
  }
  return delete this._events[e], this;
};
i.prototype.listeners = function (e) {
  var t;
  return t = this._events && this._events[e] ? n(this._events[e]) ? [this._events[e]] : this._events[e].slice() : [];
};
i.prototype.listenerCount = function (e) {
  if (this._events) {
    var t = this._events[e];
    if (n(t)) {
      return 1;
    }
    if (t) {
      return t.length;
    }
  }
  return 0;
};
i.listenerCount = function (e, t) {
  return e.listenerCount(t);
};
r = Array.prototype.slice.call(arguments, 1);
i.apply(this, r);
this.removeListener(e, i);
o || (o = !0, t.apply(this, arguments));
delete this._events[e];
this._events.removeListener && this.emit("removeListener", e, t);
1 === i.length ? (i.length = 0, delete this._events[e]) : i.splice(o, 1);
this._events.removeListener && this.emit("removeListener", e, t);
this._hasListeners = !1;
this.autosave = null;
this.nextSaveTime = 0;
this.accountName = null;
this.prefs = {};
this._load();
n.prototype.close = function () {
  this.setAccount(null);
};
n.prototype._setupListeners = function () {
  if (!this._hasListeners) {
    var e = this;
    window.gui.on("appGoBackground", function () {
      null !== e.accountName && e.autosave && e._save();
    });
    this._hasListeners = !0;
  }
};
n.prototype.setAccount = function (e) {
  this.autosave && this._save();
  this.accountName = e;
  this._setupListeners();
};
n.prototype._load = function () {
  try {
    var e = o.getItem(a);
    e && (this.prefs = JSON.parse(e));
  } catch (t) {
    console.warn("Failed to load user preferences: " + t);
  }
};
n.prototype._scheduleNextSave = function (e) {
  var t = this;
  e || (e = s);
  var i = Date.now() + 1e3 * e;
  this.autosave && this.nextSaveTime <= i || (this.autosave && window.clearTimeout(this.autosave), this.nextSaveTime = i, this.autosave = window.setTimeout(function () {
    t.autosave = null;
    t._save();
  }, 1e3 * e));
};
n.prototype._save = function () {
  this.autosave && (window.clearTimeout(this.autosave), this.autosave = null);
  var e;
  try {
    var t = JSON.stringify(this.prefs);
    e = t.length;
    o.setItem(a, t);
    console.info("Saved " + e + " char string into local storage");
    e > 2e4 && console.error("userPref size is " + e);
  } catch (i) {
    console.error("Failed to save user preferences of size " + e + ": " + i);
  }
};
n.prototype.saveNow = function () {
  this._save();
};
n.prototype.getValue = function (e, t, i) {
  e = (this.accountName && !i ? this.accountName : r) + "#" + e;
  var n = this.prefs[e];
  return void 0 === n ? t : n;
};
n.prototype.setValue = function (e, t, i, n) {
  e = (this.accountName && !n ? this.accountName : r) + "#" + e;
  this.prefs[e] = t;
  this._scheduleNextSave(i);
};
n.prototype.delValue = function (e, t, i) {
  e = (this.accountName && !i ? this.accountName : r) + "#" + e;
  delete this.prefs[e];
  this._scheduleNextSave(t);
};
window.gui.on("appGoBackground", function () {
  null !== e.accountName && e.autosave && e._save();
});
this._hasListeners = !0;
this.autosave && this._save();
this.accountName = e;
this._setupListeners();
t.autosave = null;
t._save();
e = t.length;
o.setItem(a, t);
console.info("Saved " + e + " char string into local storage");
e > 2e4 && console.error("userPref size is " + e);
e = (this.accountName && !n ? this.accountName : r) + "#" + e;
this.prefs[e] = t;
this._scheduleNextSave(i);
e = (this.accountName && !i ? this.accountName : r) + "#" + e;
delete this.prefs[e];
this._scheduleNextSave(t);
t.getItem = function (e) {
  return a.localStorage.getItem(n.getEnvName() + e);
};
t.setItem = function (e, t) {
  return a.localStorage.setItem(n.getEnvName() + e, t);
};
t.removeItem = function (e) {
  return a.localStorage.removeItem(n.getEnvName() + e);
};
(i.x < b.left || i.x > b.left + b.width || i.y < b.top || i.y > b.top + b.height) && s(i);
e.emit("tapmove", i);
M = null;
w = c(t);
!I || w.touchCount > 1 || (f.push(e), b = h(e.rootElement), e.emit("tapstart", w, b), window.clearTimeout(y), y = window.setTimeout(function () {
  A ? u(A) : e.emit("longtap", w) && r();
}, p), l.on("dom.touchmove", g), l.on("dom.touchend", v), d.recordActivity());
!A && C && T >= o - C ? e.emit("doubletap", n) : e.emit("tap", n) && r();
C = o;
t = t || {};
e._tapBehavior = !0;
e.allowDomEvents();
e.enable = n;
e.disable = o;
e.tap = a;
e.cancelTap = s;
e.on("dom.touchstart", _);
e.setEnable = function (t) {
  "boolean" != typeof t && console.error(new Error("tapBehavior: setEnable has been called with an undefined param"));
  I = t;
  e.emit("enable", t);
};
e.isEnable = function () {
  return I;
};
"boolean" != typeof t && console.error(new Error("tapBehavior: setEnable has been called with an undefined param"));
I = t;
e.emit("enable", t);
e.exports = s;
s.initialize = function (e) {
  l = e;
  u.on("handleTaken", r);
};
l = e;
u.on("handleTaken", r);
o.call(this);
this.isListening = !1;
this.isConnected = !1;
this.pingInterval = null;
this.activityInterval = null;
this.isInactive = !1;
this.hasSeenActivity = !1;
this.lastActivityTime = null;
s(n, o);
e.exports = new n();
n.prototype.initialize = function (e) {
  var t = this,
    i = window.dofus.connectionManager;
  i.on("ServersListMessage", function () {
    t._start();
  });
  e.on("connected", function () {
    t.isConnected = !0;
  });
  e.on("disconnect", function () {
    t.isConnected = !1;
    t._stop();
  });
  e.on("appGoBackground", function () {
    t._stop();
  });
  e.on("connectedAfterAppLeaveBackground", function () {
    t.isListening || t._start();
  });
};
n.prototype._start = function () {
  this.isListening || (this.isListening = !0, this.activityInterval = window.setInterval(function (e) {
    e._checkActivity();
  }, d, this), this.pingInterval = window.setInterval(function (e) {
    e._pingServer();
  }, r, this), this.isInactive = !1, this.hasSeenActivity = !1, this.lastActivityTime = Date.now());
};
n.prototype._stop = function () {
  this.isListening && (this.isListening = !1, window.clearInterval(this.activityInterval), window.clearInterval(this.pingInterval));
};
n.prototype.recordActivity = function () {
  this.hasSeenActivity = !0;
  this.lastActivityTime = Date.now();
  this.isInactive && this.isListening && this._leaveInactiveMode();
};
n.prototype.isActiveSince = function (e) {
  return this.lastActivityTime >= e;
};
n.prototype._checkActivity = function () {
  var e = Date.now() - this.lastActivityTime + u;
  e < l || (this.isInactive ? e >= c && !window.gui.playerData.isModeratorOrMore() && window.dofus.disconnect("INACTIVITY") : this._enterInactiveMode());
};
n.prototype._pingServer = function () {
  this.hasSeenActivity && (this.hasSeenActivity = !1, window.dofus.sendMessage("BasicPingMessage", {
    quiet: !0
  }));
};
n.prototype._enterInactiveMode = function () {
  this.isInactive = !0;
  this.isConnected && this.emit("inactive", !0);
  window.gui.openSimplePopup(a("ui.common.inactivityWarning"), a("ui.popup.warning"));
};
n.prototype._leaveInactiveMode = function () {
  this.isInactive = !1;
  this.isConnected ? this.emit("inactive", !1) : this._pingServer();
};
i.on("ServersListMessage", function () {
  t._start();
});
e.on("connected", function () {
  t.isConnected = !0;
});
e.on("disconnect", function () {
  t.isConnected = !1;
  t._stop();
});
e.on("appGoBackground", function () {
  t._stop();
});
e.on("connectedAfterAppLeaveBackground", function () {
  t.isListening || t._start();
});
t.isConnected = !1;
t._stop();
this.hasSeenActivity = !0;
this.lastActivityTime = Date.now();
this.isInactive && this.isListening && this._leaveInactiveMode();
this.isInactive = !0;
this.isConnected && this.emit("inactive", !0);
window.gui.openSimplePopup(a("ui.common.inactivityWarning"), a("ui.popup.warning"));
this.isInactive = !1;
this.isConnected ? this.emit("inactive", !1) : this._pingServer();
document.body.addEventListener(c.start, function () {
  o || (o = !0, n = null, s = null);
}, !0);
document.body.addEventListener(c.start, function () {
  n && h.emit("handleTaken", n);
}, !1);
document.body.addEventListener(c.end, function (e) {
  0 === d(e).touchCount && (n = null, s = null, o = !1);
});
h.isHandleFree = function () {
  return null === n;
};
h.hasHandle = function (e) {
  return n === e;
};
h.requestInteractionHandle = function (e, t) {
  return n ? (n !== t && console.info(e, "interaction REFUSED: owned by", a), n === t) : s && e !== s && r.isFeatureOn("scrollerBoundToWrapper") ? void console.info(e, "interaction REFUSED: priorityBehavior is", s) : (a = e, n = t, h.emit("handleTaken", n), !0);
};
h.abortInteraction = function () {
  n = null;
  s = null;
};
h.setPriorityBehavior = function (e) {
  s = e;
};
n = null;
s = null;
t.getCoordinatesFromNotch = function (e, t) {
  return {
    x: e + a.bodyPaddingLeft,
    y: t
  };
};
t.getCoordinatesRelativeToBody = function (e, t) {
  return {
    x: e - a.bodyPaddingLeft,
    y: t
  };
};
t.positionNextTo = function (e, t, i) {
  e.setStyle("opacity", 0);
  e.show();
  var o = n(t.rootElement.getBoundingClientRect()),
    s = n(e.rootElement.getBoundingClientRect()),
    r = 0,
    l = 0;
  if (i && i.padding) {
    var c = i.padding;
    s.width += 2 * c;
    s.height += 2 * c;
  }
  o.left > s.width ? r = o.left - s.width : a.screenWidth - o.right > s.width && (r = o.left + o.width);
  l = a.screenHeight - o.bottom + o.height > s.height ? o.top : o.top + o.height > s.height ? o.top + o.height - s.height : a.screenHeight - s.height;
  e.setStyles({
    left: Math.round(r) + "px",
    top: Math.round(l) + "px"
  });
  e.setStyle("opacity", 1);
};
t.getElementPositionAt = function (e, i, n) {
  var a = t.getCoordinatesRelativeToBody(i, n);
  return i = a.x, n = a.y, o(e.rootElement.clientWidth, e.rootElement.clientHeight, i - l, i + l, n - l);
};
e.setStyle("opacity", 0);
e.show();
s.width += 2 * c;
s.height += 2 * c;
o.left > s.width ? r = o.left - s.width : a.screenWidth - o.right > s.width && (r = o.left + o.width);
l = a.screenHeight - o.bottom + o.height > s.height ? o.top : o.top + o.height > s.height ? o.top + o.height - s.height : a.screenHeight - s.height;
e.setStyles({
  left: Math.round(r) + "px",
  top: Math.round(l) + "px"
});
e.setStyle("opacity", 1);
t.getElementPositionCenteredAt = function (e, i, n) {
  var o = e.rootElement.clientWidth,
    a = e.rootElement.clientHeight;
  return t.getCenteredTooltipPosition(o, a, i, n, d);
};
t.getCenteredTooltipPosition = function (e, i, n, o, s) {
  var r = t.getCoordinatesRelativeToBody(n, o);
  n = r.x;
  o = r.y;
  var l = n - e / 2;
  l < c ? l = c : l + e > a.screenWidth - c && (l = a.screenWidth - c - e);
  var d;
  return s ? (d = o - i - s, d < c && (d = o + s)) : d = Math.max(o - i / 2, c), {
    x: Math.round(l),
    y: Math.round(d)
  };
};
t.getElementPositionAround = function (e, t) {
  var i, a;
  a = e && e.rootElement ? {
    width: e.rootElement.clientWidth,
    height: e.rootElement.clientHeight
  } : {
    width: 0,
    height: 0
  };
  i = t && t.rootElement ? n(t.rootElement.getBoundingClientRect()) : {
    width: 0,
    height: 0,
    left: 0,
    top: 0
  };
  var s = i.width / 2,
    r = i.height / 2,
    c = i.left + s,
    d = i.top + r;
  return s = s < l ? l : s, r = r < l ? l : r, o(a.width, a.height, c - s, c + s, d - r);
};
t.getTargetRect = function (e) {
  return e.rootElement.getBoundingClientRect();
};
t.newTargetRect = function (e, t, i, n) {
  return {
    left: e - i / 2,
    top: t - n / 2,
    width: i,
    height: n
  };
};
t.getBestTooltipPosition = function (e, t, i, o) {
  i = n(i);
  var s,
    r,
    l = i.left + i.width / 2,
    d = i.top + i.height / 2;
  return r = i.top - o - t, r >= c ? s = l - e / 2 : (s = l > a.screenWidth / 2 ? i.left - o - e : l + i.width / 2 + o, r = d - t / 2), s < c ? s = c : s + e > a.screenWidth - c && (s = a.screenWidth - c - e), r < c ? r = c : r + t > a.screenHeight - c && (r = a.screenHeight - c - t), {
    x: Math.round(s),
    y: Math.round(r)
  };
};
n = r.x;
o = r.y;
a = e && e.rootElement ? {
  width: e.rootElement.clientWidth,
  height: e.rootElement.clientHeight
} : {
  width: 0,
  height: 0
};
i = t && t.rootElement ? n(t.rootElement.getBoundingClientRect()) : {
  width: 0,
  height: 0,
  left: 0,
  top: 0
};
t.FINGER_OFFSET = 42;
t.OFFSET_FROM_SCREEN = 10;
O = s(e);
O.x -= C.left;
O.y -= C.top;
e.isSliding = !0;
e.emit("slideStart", O, C);
E = N = 0;
o.isIOS && (R = l.setInterval(_, 100));
n(e);
O.touchCount > 0 || (T && m(), y());
e.isSliding = !1;
T && e.emit("slideCancel");
y();
r.abortInteraction();
window.gui.wBody.on("dom.touchmove", h);
window.gui.wBody.on("dom.touchend", p);
window.gui.wBody.on("dom.touchcancel", f);
window.gui.wBody.removeListener("dom.touchmove", h);
window.gui.wBody.removeListener("dom.touchend", p);
window.gui.wBody.removeListener("dom.touchcancel", f);
l.clearInterval(R);
M = T = !1;
e._slideBehavior = !0;
e.allowDomEvents();
t && i(t);
e.setSlideDirection = i;
e.setSwipeMinimum = function (e) {
  D = e;
};
e.isSliding = !1;
e.slideOut = !1;
e.lockSlide = function (e) {
  L = e;
};
e.cancelSlide = f;
e = e || {};
d.call(this, "div", {
  className: "window",
  hidden: !0
});
this.addClassNames(e.className);
this.exchangeType = -1;
this.positionInfo = e.positionInfo;
this.freeContentDelay = e.freeContentDelay;
this.freeContentTimeout = null;
this.position = null;
this.windowManager = null;
this.openState = !1;
this.isReadyForUserInteraction = !1;
this.windowBorder = this.createChild("div", {
  className: "windowBorder"
});
this.windowContent = this.createChild("div", {
  className: "windowContent"
});
this.header = this.windowHeadWrapper = this.windowContent.createChild("div", {
  className: "windowHeadWrapper"
});
e.noTitle || (this.windowTitle = this.windowHeadWrapper.createChild("div", {
  className: "windowTitle"
}), this.windowTitle.setText(e.title || ""));
e.plusButton && (this.plusButton = this.windowHeadWrapper.appendChild(new u({
  className: "plusButton",
  scaleOnPress: !0
})), this.plusButton.myWindow = this);
e.minusButton && (this.minusButton = this.windowHeadWrapper.appendChild(new u({
  className: "minusButton",
  scaleOnPress: !0
})), this.minusButton.myWindow = this);
e.noCloseButton || (this.closeButton = this.windowHeadWrapper.appendChild(new h({
  scaleOnPress: !0
})), this.closeButton.myWindow = this, e.customClose || this.closeButton.on("tap", o));
this.openingSound = e.openingSound;
this.closingSound = e.closingSound;
this.windowBodyWrapper = this.windowContent.createChild("div", {
  className: "windowBodyWrapper"
});
this.windowBody = this.windowBodyWrapper.createChild("div", {
  className: "windowBody"
});
this.on("open", a);
this.on("opened", s);
this.on("close", r);
this.on("resize", function () {
  t.position.width = t.windowWidth || 0;
  t.position.height = t.windowHeight || 0;
});
t.position.width = t.windowWidth || 0;
t.position.height = t.windowHeight || 0;
window.clearTimeout(this.freeContentTimeout);
this.openingSound && p(this.openingSound || "WINDOW_OPEN");
this.isReadyForUserInteraction = !0;
this._initWindowKPI();
c(n, d);
e.exports = n;
n.prototype.startWaitingForContent = function () {
  this.isReadyForUserInteraction = !1;
};
n.prototype.finishedWaitingForContent = function () {
  this.isReadyForUserInteraction = !0;
  this.emit("contentReady");
};
n.prototype.setTitle = function (e) {
  this.windowTitle.setText(e);
};
n.prototype.localizeEvent = function (e) {
  var t = this;
  return function () {
    t.openState && e.apply(this, arguments);
  };
};
n.prototype.close = function (e) {
  this.windowManager.close(this.id, e);
};
n.prototype.changePosition = function (e, t) {
  if (this.position) {
    var i = y(this.rootElement),
      n = y(this.header.rootElement),
      o = i.width,
      a = n.height + (n.top - i.top);
    e = Math.max(0, e);
    t = Math.max(0, t);
    e + o > v.windowFullScreenWidth && (e = v.windowFullScreenWidth - o);
    t + a > v.windowFullScreenHeight && (t = v.windowFullScreenHeight - a);
    this.setStyle("webkitTransform", "translate3d(" + e + "px, " + t + "px, 0)");
    this.position.x = e;
    this.position.y = t;
    this.emit("positioned");
  }
};
n.prototype.backButtonClose = function (e) {
  this.close(e);
};
n.prototype.prepareKPI = function (e, t, i, n) {
  var o = ~~((_.now() - t) / 1e3),
    a = window.gui.playerData,
    s = a.inventory.kamas - i,
    r = a.inventory.goultines - n;
  l(e, o, s, r);
};
n.prototype._initWindowKPI = function () {
  if (!this.tabs) {
    var e = window.gui.playerData;
    this._openedTimestamp = _.now();
    this._scBalanceWhenOpen = e.inventory.kamas;
    this._hcBalanceWhenOpen = e.inventory.goultines;
  }
};
n.prototype._sendWindowKPI = function () {
  this.prepareKPI(this.id, this._openedTimestamp, this._scBalanceWhenOpen, this._hcBalanceWhenOpen);
  this._resetWindowKPI();
};
n.prototype._resetWindowKPI = function (e) {
  return e ? void (this._openedTimestampTabs[e] = this._scBalanceWhenOpenTabs[e] = this._hcBalanceWhenOpenTabs[e] = 0) : this._openedTimestamp = this._scBalanceWhenOpen = this._hcBalanceWhenOpen = 0;
};
this.isReadyForUserInteraction = !0;
this.emit("contentReady");
e = Math.max(0, e);
t = Math.max(0, t);
e + o > v.windowFullScreenWidth && (e = v.windowFullScreenWidth - o);
t + a > v.windowFullScreenHeight && (t = v.windowFullScreenHeight - a);
this.setStyle("webkitTransform", "translate3d(" + e + "px, " + t + "px, 0)");
this.position.x = e;
this.position.y = t;
this.emit("positioned");
this._openedTimestamp = _.now();
this._scBalanceWhenOpen = e.inventory.kamas;
this._hcBalanceWhenOpen = e.inventory.goultines;
this.prepareKPI(this.id, this._openedTimestamp, this._scBalanceWhenOpen, this._hcBalanceWhenOpen);
this._resetWindowKPI();
r.call(this);
this._elementIsVisible = !0;
this._currentTextContent = null;
this.rootElement = null;
this._text = null;
this._name = null;
this._childrenList = [];
this._childrenMap = {};
this._contentType = c.EMPTY;
this._parent = null;
e && this._assign(e, t);
s(a, r);
e.exports = a;
a.prototype._assign = function (e, t) {
  if (this.rootElement) {
    throw new Error("WuiDom has already an element assigned");
  }
  if ("string" == typeof e) {
    this.rootElement = o(e, t);
    t && t.hasOwnProperty("text") && this.setText(t.text);
  } else {
    if (!(e instanceof window.Element)) {
      throw new Error("WuiDom.assign requires the given argument to be a DOM Element or tagName.");
    }
    this.rootElement = e;
  }
  t = t || {};
  t.hidden && this.hide();
  "name" in t && (this._name = String(t.name));
  "className" in t && this.addClassNames(t.className);
  "style" in t && this.setStyles(t.style || {});
};
a.prototype.assign = function (e, t) {
  this._assign(e, t);
};
a.prototype.getWuiName = function () {
  return this._name;
};
a.prototype.removeChild = function (e) {
  var t = e instanceof a;
  if (!t && (e = this._childrenMap[e], !e)) {
    throw new Error("WuiDom: Given name is not a current child");
  }
  var i = this._childrenList.indexOf(e);
  if (i === -1) {
    throw new Error("WuiDom: Not a current child");
  }
  return this.rootElement.removeChild(e.rootElement), this._childrenList.splice(i, 1), this._childrenMap.hasOwnProperty(e._name) && delete this._childrenMap[e._name], e._parent = null, e;
};
a.prototype._unsetParent = function () {
  this._parent && this._parent.removeChild(this);
};
a.prototype._setParent = function (e) {
  if (e !== this._parent) {
    if (this._name) {
      if (e._childrenMap[this._name]) {
        throw new Error("WuiDom: Parent already has a child with this name");
      }
      e._childrenMap[this._name] = this;
    }
    this._parent = e;
  }
};
a.prototype.getParent = function () {
  return this._parent;
};
a.prototype.appendChild = function (e) {
  if (this._contentType && this._contentType !== c.WUI && this._clearLinearContent(), this === e._parent) {
    var t = this._childrenList.indexOf(e);
    t !== -1 && this._childrenList.splice(t, 1);
  } else {
    e._unsetParent();
    e._setParent(this);
  }
  return this._childrenList.push(e), this.rootElement.appendChild(e.rootElement), e.rebindTouchListeners(), this._contentType = c.WUI, e;
};
a.prototype.createChild = function (e, t) {
  return this.appendChild(new a(e, t));
};
a.prototype.appendTo = function (e) {
  e.appendChild(this);
};
a.prototype.insertChildBefore = function (e, t) {
  this._contentType && this._contentType !== c.WUI && this._clearLinearContent();
  var i;
  if (this === e._parent) {
    var n = this._childrenList.indexOf(e);
    n !== -1 && this._childrenList.splice(n, 1);
  } else {
    e._unsetParent();
  }
  if (t) {
    if (i = this._childrenList.indexOf(t), i === -1) {
      throw new Error("WuiDom: Wanted sibling is not a child");
    }
  } else {
    i = this._childrenList.length;
  }
  return e._setParent(this), this.rootElement.insertBefore(e.rootElement, t && t.rootElement), e.rebindTouchListeners(), this._childrenList.splice(i, 0, e), this._contentType = c.WUI, e;
};
a.prototype.insertBefore = function (e) {
  if (!e._parent) {
    throw new Error("WuiDom: sibling has no parent");
  }
  return e._parent.insertChildBefore(this, e), e;
};
a.prototype.insertAsFirstChild = function (e) {
  var t = this._childrenList[0];
  return t ? this.insertChildBefore(e, t) : this.appendChild(e);
};
a.prototype.getChildren = function () {
  return this._childrenList.concat();
};
a.prototype.getChildCount = function () {
  return this._childrenList.length;
};
a.prototype.getChild = function (e) {
  return this._childrenMap[e];
};
a.prototype._clearLinearContent = function () {
  this._text = null;
  this._currentTextContent = null;
  this.rootElement.innerHTML = "";
};
a.prototype.setHtml = function (e) {
  this._contentType === c.WUI && this._destroyChildren();
  this._contentType === c.TEXT && this._clearLinearContent();
  this.rootElement.innerHTML = e;
  this._contentType = c.HTML;
};
a.prototype.setText = function (e) {
  this._contentType === c.WUI && this._destroyChildren();
  this._contentType === c.HTML && this._clearLinearContent();
  null !== e && void 0 !== e && (e = e.valueOf(), this._text || (this._text = document.createTextNode(""), this.rootElement.appendChild(this._text)), e !== this._currentTextContent && (this._currentTextContent = e, this._text.nodeValue = e), this._contentType = c.TEXT);
};
a.prototype.getText = function () {
  return this._currentTextContent;
};
a.prototype.setStyle = function (e, t) {
  this.rootElement.style[e] = t;
};
a.prototype.setStyles = function (e) {
  var t = this.rootElement.style;
  for (var i in e) {
    t[i] = e[i];
  }
};
a.prototype.unsetStyle = function (e) {
  this.rootElement.style[e] = "";
};
a.prototype.getStyle = function (e) {
  return this.rootElement.style[e];
};
a.prototype.getComputedStyle = function (e) {
  var t = window.getComputedStyle(this.rootElement);
  return t ? t.getPropertyValue(e) : null;
};
a.prototype.getComputedStyles = function () {
  var e = window.getComputedStyle(this.rootElement);
  if (!e) {
    return {};
  }
  for (var t = {}, i = 0, n = arguments.length; i < n; i += 1) {
    var o = arguments[i];
    t[o] = e.getPropertyValue(o);
  }
  return t;
};
a.prototype.getClassNames = function () {
  return n(this.rootElement.classList);
};
a.prototype.hasClassName = function (e) {
  return this.rootElement.classList.contains(e);
};
a.prototype.setClassNames = function () {
  this.rootElement.className = "";
  var e = this.rootElement.classList;
  e.add.apply(e, n(arguments));
};
a.prototype.addClassNames = function () {
  var e = this.rootElement.classList;
  e.add.apply(e, n(arguments));
};
a.prototype.replaceClassNames = function (e, t) {
  var i = this.rootElement.classList;
  i.remove.apply(i, n(e));
  i.add.apply(i, n(t));
};
a.prototype.delClassNames = function () {
  var e = this.rootElement.classList;
  e.remove.apply(e, n(arguments));
};
a.prototype.toggleClassNames = function (e, t) {
  for (var i = 0; i < e.length; i += 1) {
    this.toggleClassName(e[i], t);
  }
};
a.prototype.toggleClassName = function (e, t) {
  return t === !0 || t === !1 ? this.rootElement.classList.toggle(e, t) : this.rootElement.classList.toggle(e);
};
a.prototype._removeDom = function () {
  var e = this.rootElement;
  e && (e.remove(), this.rootElement = null);
};
a.prototype._destroyChildren = function () {
  var e = this._childrenList.concat();
  this._childrenList = [];
  this._childrenMap = {};
  for (var t = 0, i = e.length; t < i; t += 1) {
    var n = e[t];
    n.emit("destroy");
    n._parent = null;
    n._destroyChildren();
    n._removeDom();
    n.removeAllListeners();
  }
};
a.prototype.clearContent = function () {
  switch (this._contentType) {
    case c.HTML:
    case c.TEXT:
      this._clearLinearContent();
      break;
    case c.WUI:
      this._destroyChildren();
  }
  this._contentType = c.EMPTY;
  this.emit("cleared");
};
a.prototype.destroy = function () {
  this.emit("destroy");
  this._unsetParent();
  this._destroyChildren();
  this._removeDom();
  this.removeAllListeners();
};
a.prototype.showMethod = function () {
  this.rootElement.style.display = "";
};
a.prototype.hideMethod = function () {
  this.rootElement.style.display = "none";
};
a.prototype.show = function () {
  this._elementIsVisible || (this._elementIsVisible = !0, this.showMethod(), this.emit("show"));
};
a.prototype.hide = function () {
  this._elementIsVisible && (this._elementIsVisible = !1, this.hideMethod(), this.emit("hide"));
};
a.prototype.toggleDisplay = function (e) {
  return void 0 === e && (e = !this._elementIsVisible), e ? this.show() : this.hide(), !!e;
};
a.prototype.isVisible = function (e) {
  return !!this._elementIsVisible && (!e || !this._parent || this._parent.isVisible(!0));
};
a.prototype.rebindTouchListeners = function () {
  if (this.domListeners) {
    var e = this.rootElement;
    for (var t in this.domListeners) {
      if (t.match(/^touch/)) {
        var i = this.domListeners[t];
        for (var n in i) {
          var o = i[n];
          e.removeEventListener(n, o);
          e.addEventListener(n, o);
        }
      }
    }
  }
};
a.prototype.bindToTome = function (e, t) {
  function i(e) {
    t(this.valueOf(), e);
  }
  var n = this;
  t || (t = function (e) {
    n.setText(e);
  });
  e.on("readable", i);
  t(e.valueOf());
  this.on("destroy", function () {
    e.removeListener("readable", i);
  });
};
a.prototype.allowDomEvents = function () {
  this.domListeners || (this.domListeners = {}, this.on("newListener", l["new"]), this.on("removeListener", l.remove), this.on("destroy", l.destroy));
};
this.rootElement = o(e, t);
t && t.hasOwnProperty("text") && this.setText(t.text);
t = t || {};
t.hidden && this.hide();
"name" in t && (this._name = String(t.name));
"className" in t && this.addClassNames(t.className);
"style" in t && this.setStyles(t.style || {});
e._unsetParent();
e._setParent(this);
this._text = null;
this._currentTextContent = null;
this.rootElement.innerHTML = "";
this._contentType === c.WUI && this._destroyChildren();
this._contentType === c.TEXT && this._clearLinearContent();
this.rootElement.innerHTML = e;
this._contentType = c.HTML;
this._contentType === c.WUI && this._destroyChildren();
this._contentType === c.HTML && this._clearLinearContent();
null !== e && void 0 !== e && (e = e.valueOf(), this._text || (this._text = document.createTextNode(""), this.rootElement.appendChild(this._text)), e !== this._currentTextContent && (this._currentTextContent = e, this._text.nodeValue = e), this._contentType = c.TEXT);
i.remove.apply(i, n(e));
i.add.apply(i, n(t));
this._childrenList = [];
this._childrenMap = {};
n.emit("destroy");
n._parent = null;
n._destroyChildren();
n._removeDom();
n.removeAllListeners();
this._contentType = c.EMPTY;
this.emit("cleared");
this.emit("destroy");
this._unsetParent();
this._destroyChildren();
this._removeDom();
this.removeAllListeners();
e.removeEventListener(n, o);
e.addEventListener(n, o);
t || (t = function (e) {
  n.setText(e);
});
e.on("readable", i);
t(e.valueOf());
this.on("destroy", function () {
  e.removeListener("readable", i);
});
s = JSON.stringify("" + o);
s.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/) ? (s = s.substr(1, s.length - 2), s = e.stylize(s, "name")) : (s = s.replace(/'/g, "\\'").replace(/\\"/g, '"').replace(/(^"|"$)/g, "'"), s = e.stylize(s, "string"));
t.format = function (e) {
  if (!y(e)) {
    for (var t = [], i = 0; i < arguments.length; i++) {
      t.push(o(arguments[i]));
    }
    return t.join(" ");
  }
  for (var i = 1, n = arguments, a = n.length, s = String(e).replace(O, function (e) {
      if ("%%" === e) {
        return "%";
      }
      if (i >= a) {
        return e;
      }
      switch (e) {
        case "%s":
          return String(n[i++]);
        case "%d":
          return Number(n[i++]);
        case "%j":
          try {
            return JSON.stringify(n[i++]);
          } catch (t) {
            return "[Circular]";
          }
        default:
          return e;
      }
    }), r = n[i]; i < a; r = n[++i]) {
    s += g(r) || !T(r) ? " " + r : " " + o(r);
  }
  return s;
};
t.deprecate = function (i, o) {
  function a() {
    if (!s) {
      if (n.throwDeprecation) {
        throw new Error(o);
      }
      n.traceDeprecation ? console.trace(o) : console.error(o);
      s = !0;
    }
    return i.apply(this, arguments);
  }
  if (b(e.process)) {
    return function () {
      return t.deprecate(i, o).apply(this, arguments);
    };
  }
  if (n.noDeprecation === !0) {
    return i;
  }
  var s = !1;
  return a;
};
n.traceDeprecation ? console.trace(o) : console.error(o);
s = !0;
t.debuglog = function (e) {
  if (b(R) && (R = n.env.NODE_DEBUG || ""), e = e.toUpperCase(), !D[e]) {
    if (new RegExp("\\b" + e + "\\b", "i").test(R)) {
      var i = n.pid;
      D[e] = function () {
        var n = t.format.apply(t, arguments);
        console.error("%s %d: %s", e, i, n);
      };
    } else {
      D[e] = function () {};
    }
  }
  return D[e];
};
t.inspect = o;
o.colors = {
  bold: [1, 22],
  italic: [3, 23],
  underline: [4, 24],
  inverse: [7, 27],
  white: [37, 39],
  grey: [90, 39],
  black: [30, 39],
  blue: [34, 39],
  cyan: [36, 39],
  green: [32, 39],
  magenta: [35, 39],
  red: [31, 39],
  yellow: [33, 39]
};
o.styles = {
  special: "cyan",
  number: "yellow",
  "boolean": "yellow",
  undefined: "grey",
  "null": "bold",
  string: "green",
  date: "magenta",
  regexp: "red"
};
t.isArray = m;
t.isBoolean = f;
t.isNull = g;
t.isNullOrUndefined = _;
t.isNumber = v;
t.isString = y;
t.isSymbol = w;
t.isUndefined = b;
t.isRegExp = M;
t.isObject = T;
t.isDate = C;
t.isError = I;
t.isFunction = A;
t.isPrimitive = S;
t.isBuffer = i(74);
t.log = function () {
  console.log("%s - %s", x(), t.format.apply(t, arguments));
};
t.inherits = i(75);
t._extend = function (e, t) {
  if (!t || !T(t)) {
    return e;
  }
  for (var i = Object.keys(t), n = i.length; n--;) {
    e[i[n]] = t[i[n]];
  }
  return e;
};
e.super_ = t;
e.prototype = Object.create(t.prototype, {
  constructor: {
    value: e,
    enumerable: !1,
    writable: !0,
    configurable: !0
  }
});
i.prototype = t.prototype;
e.prototype = new i();
e.prototype.constructor = e;
this._events = this._events || {};
this._maxListeners = this._maxListeners || void 0;
e.exports = i;
i.EventEmitter = i;
i.prototype._events = void 0;
i.prototype._maxListeners = void 0;
i.defaultMaxListeners = 10;
i.prototype.setMaxListeners = function (e) {
  if (!o(e) || e < 0 || isNaN(e)) {
    throw TypeError("n must be a positive number");
  }
  return this._maxListeners = e, this;
};
i.prototype.emit = function (e) {
  var t, i, o, r, l, c;
  if (this._events || (this._events = {}), "error" === e && (!this._events.error || a(this._events.error) && !this._events.error.length)) {
    if (t = arguments[1], t instanceof Error) {
      throw t;
    }
    throw TypeError('Uncaught, unspecified "error" event.');
  }
  if (i = this._events[e], s(i)) {
    return !1;
  }
  if (n(i)) {
    switch (arguments.length) {
      case 1:
        i.call(this);
        break;
      case 2:
        i.call(this, arguments[1]);
        break;
      case 3:
        i.call(this, arguments[1], arguments[2]);
        break;
      default:
        r = Array.prototype.slice.call(arguments, 1);
        i.apply(this, r);
    }
  } else if (a(i)) {
    for (r = Array.prototype.slice.call(arguments, 1), c = i.slice(), o = c.length, l = 0; l < o; l++) {
      c[l].apply(this, r);
    }
  }
  return !0;
};
i.prototype.addListener = function (e, t) {
  var o;
  if (!n(t)) {
    throw TypeError("listener must be a function");
  }
  return this._events || (this._events = {}), this._events.newListener && this.emit("newListener", e, n(t.listener) ? t.listener : t), this._events[e] ? a(this._events[e]) ? this._events[e].push(t) : this._events[e] = [this._events[e], t] : this._events[e] = t, a(this._events[e]) && !this._events[e].warned && (o = s(this._maxListeners) ? i.defaultMaxListeners : this._maxListeners, o && o > 0 && this._events[e].length > o && (this._events[e].warned = !0, console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.", this._events[e].length), "function" == typeof console.trace && console.trace())), this;
};
i.prototype.on = i.prototype.addListener;
i.prototype.once = function (e, t) {
  function i() {
    this.removeListener(e, i);
    o || (o = !0, t.apply(this, arguments));
  }
  if (!n(t)) {
    throw TypeError("listener must be a function");
  }
  var o = !1;
  return i.listener = t, this.on(e, i), this;
};
i.prototype.removeListener = function (e, t) {
  var i, o, s, r;
  if (!n(t)) {
    throw TypeError("listener must be a function");
  }
  if (!this._events || !this._events[e]) {
    return this;
  }
  if (i = this._events[e], s = i.length, o = -1, i === t || n(i.listener) && i.listener === t) {
    delete this._events[e];
    this._events.removeListener && this.emit("removeListener", e, t);
  } else if (a(i)) {
    for (r = s; r-- > 0;) {
      if (i[r] === t || i[r].listener && i[r].listener === t) {
        o = r;
        break;
      }
    }
    if (o < 0) {
      return this;
    }
    1 === i.length ? (i.length = 0, delete this._events[e]) : i.splice(o, 1);
    this._events.removeListener && this.emit("removeListener", e, t);
  }
  return this;
};
i.prototype.removeAllListeners = function (e) {
  var t, i;
  if (!this._events) {
    return this;
  }
  if (!this._events.removeListener) {
    return 0 === arguments.length ? this._events = {} : this._events[e] && delete this._events[e], this;
  }
  if (0 === arguments.length) {
    for (t in this._events) {
      "removeListener" !== t && this.removeAllListeners(t);
    }
    return this.removeAllListeners("removeListener"), this._events = {}, this;
  }
  if (i = this._events[e], n(i)) {
    this.removeListener(e, i);
  } else if (i) {
    for (; i.length;) {
      this.removeListener(e, i[i.length - 1]);
    }
  }
  return delete this._events[e], this;
};
i.prototype.listeners = function (e) {
  var t;
  return t = this._events && this._events[e] ? n(this._events[e]) ? [this._events[e]] : this._events[e].slice() : [];
};
i.prototype.listenerCount = function (e) {
  if (this._events) {
    var t = this._events[e];
    if (n(t)) {
      return 1;
    }
    if (t) {
      return t.length;
    }
  }
  return 0;
};
i.listenerCount = function (e, t) {
  return e.listenerCount(t);
};
r = Array.prototype.slice.call(arguments, 1);
i.apply(this, r);
this.removeListener(e, i);
o || (o = !0, t.apply(this, arguments));
delete this._events[e];
this._events.removeListener && this.emit("removeListener", e, t);
1 === i.length ? (i.length = 0, delete this._events[e]) : i.splice(o, 1);
this._events.removeListener && this.emit("removeListener", e, t);
t["new"] = function (e) {
  var t = this,
    s = e.split(".");
  if (s[0] === r) {
    var l = s[1];
    if (l && !this.domListeners[l]) {
      switch (l) {
        case "touchstart":
          var c = function (e) {
              o() || 1 !== e.which || t.emit("dom.touchstart", e);
            },
            d = function (e) {
              i();
              t.emit("dom.touchstart", e);
            };
          this.domListeners.touchstart = {
            mousedown: c,
            touchstart: d
          };
          this.rootElement.addEventListener("mousedown", c);
          this.rootElement.addEventListener("touchstart", d);
          break;
        case "touchmove":
          var u = function (e) {
              a || 1 !== e.which || t.emit("dom.touchmove", e);
            },
            h = function (e) {
              t.emit("dom.touchmove", e);
            };
          this.domListeners.touchmove = {
            mousemove: u,
            touchmove: h
          };
          this.rootElement.addEventListener("mousemove", u);
          this.rootElement.addEventListener("touchmove", h);
          break;
        case "touchend":
          var p = function (e) {
              return o() || 1 !== e.which ? void n() : void t.emit("dom.touchend", e);
            },
            m = function (e) {
              i();
              t.emit("dom.touchend", e);
              e.preventDefault();
            };
          this.domListeners.touchend = {
            mouseup: p,
            touchend: m
          };
          this.rootElement.addEventListener("mouseup", p);
          this.rootElement.addEventListener("touchend", m);
          break;
        default:
          var f = function (i) {
            t.emit(e, i);
          };
          this.domListeners[l] = f;
          this.rootElement.addEventListener(l, f);
      }
    }
  }
};
t.remove = function (e) {
  if (0 === this.listeners(e).length) {
    var t = e.split(".");
    if (t[0] === r) {
      var i = t[1],
        n = this.domListeners[i];
      if (n) {
        if (null !== n && "object" == typeof n) {
          for (var o in n) {
            var a = n[o];
            this.rootElement.removeEventListener(o, a);
          }
          return void delete this.domListeners[i];
        }
        this.rootElement.removeEventListener(i, n);
        delete this.domListeners[i];
      }
    }
  }
};
t.destroy = function () {
  for (var e in this.domListeners) {
    var t = this.domListeners[e];
    if (null === t || "object" != typeof t) {
      this.rootElement.removeEventListener(e, t);
    } else {
      for (var i in t) {
        var n = t[i];
        this.rootElement.removeEventListener(i, n);
      }
    }
  }
  this.domListeners = {};
};
i();
t.emit("dom.touchstart", e);
this.domListeners.touchstart = {
  mousedown: c,
  touchstart: d
};
this.rootElement.addEventListener("mousedown", c);
this.rootElement.addEventListener("touchstart", d);
this.domListeners.touchmove = {
  mousemove: u,
  touchmove: h
};
this.rootElement.addEventListener("mousemove", u);
this.rootElement.addEventListener("touchmove", h);
i();
t.emit("dom.touchend", e);
e.preventDefault();
this.domListeners.touchend = {
  mouseup: p,
  touchend: m
};
this.rootElement.addEventListener("mouseup", p);
this.rootElement.addEventListener("touchend", m);
this.domListeners[l] = f;
this.rootElement.addEventListener(l, f);
this.rootElement.removeEventListener(i, n);
delete this.domListeners[i];
i(79);
i(80);
i(81);
i(82);
i(83);
i(84);
a.add = s(a.add);
a.remove = s(a.remove);
a.toggle = function (t, i) {
  return 1 in arguments && this.contains(t) === i ? i : e.prototype.toggle.call(this, t, i);
};
this._getString = function () {
  return e.getAttribute(t) || "";
};
this._setString = function (i) {
  e.setAttribute(t, i);
};
n(this, o(this));
i.prototype = {
  add: function (e) {
    for (var t, i = 0, s = arguments.length, r = o(this), l = !1; i < s; i++) {
      t = arguments[i];
      a(t);
      r.indexOf(t) < 0 && (r.push(t), l = !0);
    }
    l && (this._setString(r.join(" ").trim()), n(this, r));
  },
  contains: function (e) {
    return a(e), o(this).indexOf(e) > -1;
  },
  item: function (e) {
    return o(this)[e] || null;
  },
  get length() {
    return o(this).length;
  },
  remove: function (e) {
    for (var t, i, s = 0, r = arguments.length, l = o(this), c = !1; s < r; s++) {
      for (i = arguments[s], a(i); (t = l.indexOf(i)) > -1;) {
        l.splice(t, 1);
        c = !0;
      }
    }
    c && (this._setString(l.join(" ").trim()), n(this, l));
  },
  toggle: function (e, t) {
    var i = this.contains(e),
      n = i ? t !== !0 && "remove" : t !== !1 && "add";
    return n && this[n](e), "boolean" == typeof t ? t : !i;
  },
  toString: function () {
    return this._getString();
  }
};
e.exports = i;
t = arguments[i];
a(t);
r.indexOf(t) < 0 && (r.push(t), l = !0);
l.splice(t, 1);
c = !0;
e = e || {};
r.call(this, "div", e);
this.addClassNames("Button");
l(this, {
  repeatDelay: e.repeatDelay,
  doubletapTimeout: 1
});
"before" === i && this.appendChild(n);
e.text && this.createChild("div", {
  className: "btnText",
  text: e.text
});
"after" !== i && i !== !0 || this.appendChild(n);
(e.scaleOnPress || void 0 === e.scaleOnPress) && this.addClassNames("scaleOnPress");
e.tooltip && a(this, e.tooltip);
"function" == typeof t && this.on("tap", t);
this.on("tap", function () {
  c(e.sound || "GEN_BUTTON");
});
this.on("tapstart", function () {
  this.addClassNames("pressed");
});
this.on("tapend", function () {
  this.delClassNames("pressed");
});
this.on("enable", function (e) {
  this.toggleClassName("disabled", !e);
});
e.disable && this.disable();
t = t || {};
t.text = e;
n.call(this, t, i);
this.addClassNames("button");
s(n, r);
e.exports = n;
s(o, n);
n.DofusButton = o;
e.name && (t.name = e.name);
g.call(this, "div", t);
this.content = this.createChild("div", {
  className: "content"
});
this.computedPosition = {
  TL: {
    x: 0,
    y: 0
  },
  BR: {
    x: 0,
    y: 0
  }
};
this.openState = !1;
this.setStyle("opacity", 0);
e.content && this._setContent(e.content);
this.delClassNames("transition");
this.hide();
d && (d.emit("tooltipOut"), d = null);
clearTimeout(h);
h = null;
c._closeTooltip(!1);
d && (d.emit("tooltipOut"), d = null);
clearTimeout(h);
h = setTimeout(s, 500);
n.prototype.updateAndAppearAt = function (e, t, i) {
  i = i || {
    margin: S
  };
  this._updateAndAppear(e, p.getTargetRect(t), i);
};
n.prototype._setContent = function (e) {
  for (var t = this.content.getChildren(), i = 0; i < t.length; i++) {
    this.content.removeChild(t[i]);
  }
  e && this.content.appendChild(e);
};
n.prototype._prepareForNewContent = function () {
  var e = this.content.rootElement.clientWidth + T,
    t = this.content.rootElement.clientHeight + T;
  return _.cancelTween(this), this.delClassNames("transition"), this.setStyles({
    width: I + "px",
    overflow: "hidden"
  }), this.content.setStyles({
    width: null,
    height: null
  }), [e, t];
};
n.prototype.getComputedPosition = function () {
  return this.computedPosition;
};
n.prototype._updateAndAppear = function (e, t, i) {
  i = i || {};
  var n = this._prepareForNewContent();
  e && this._setContent(e);
  this.show();
  var a,
    s = this.content.rootElement.clientWidth + C,
    r = this.content.rootElement.clientHeight,
    l = s + T,
    c = r + T,
    d = i.margin || 0;
  if (i.centerOnTarget) {
    var u = t.left + t.width / 2,
      h = t.top + t.height / 2;
    a = p.getCenteredTooltipPosition(l, c, u, h);
  } else {
    a = p.getBestTooltipPosition(l, c, t, d);
  }
  this.computedPosition = {
    TL: {
      x: a.x,
      y: a.y
    },
    BR: {
      x: a.x + l,
      y: a.y + c
    }
  };
  var f = "translate3d(" + a.x + "px," + a.y + "px,0)";
  this.content.setStyles({
    width: s + "px",
    height: r + "px"
  });
  this.openState ? (this.setStyles({
    width: n[0] + "px",
    height: n[1] + "px",
    overflow: null
  }), m.forceReflow(this), this.addClassNames("transition"), _.tween(this, {
    width: l + "px",
    height: c + "px",
    webkitTransform: f
  }, {
    time: 150,
    easing: "ease-out"
  }, o)) : (this.openState = !0, this.setStyles({
    width: l + "px",
    height: c + "px",
    overflow: null,
    webkitTransform: f,
    opacity: 1
  }), b("ROLLOVER"));
};
n.prototype.closeForRecomputing = function () {
  c._closeTooltip(!0);
};
n.prototype.closeTooltip = function () {
  this._closeTooltip(!1);
};
n.prototype._closeTooltip = function (e) {
  this.openState && (this.openState = !1, e ? (this.setStyle("opacity", 0), a.call(this)) : _.tween(this, {
    opacity: 0
  }, {
    time: 150,
    easing: "ease-out"
  }, a));
};
t.initialiseTooltipBehavior = function (e) {
  return c = new n(), e.on("dom.touchend", function () {
    u && y.stop();
    u = !1;
    s();
  }), c;
};
t.addTooltip = function (e, t, i) {
  function n() {
    var i = t;
    return "function" == typeof t && (i = t.call(e), i = "string" == typeof i ? new g("div", {
      text: i
    }) : i), i;
  }
  function o() {
    if (e._tooltipEnabled && !window.gui.pingSystem.isActive() && w.requestInteractionHandle("TOOLTIP", c) && (clearTimeout(h), h = null, !d || d !== e)) {
      var t = n(),
        i = t instanceof g;
      if (d && d.emit("tooltipOut"), !i) {
        return c._closeTooltip(!0), void c._setContent(!1);
      }
      c._updateAndAppear(t, p.getTargetRect(e), {
        margin: A / 2
      });
      c.delClassNames("noBackground");
      d = e;
      e.emit("tooltipOn");
    }
  }
  function a() {
    s.showNotification(M("tablet.common.longTapForTooltip"), this);
  }
  if (!e.hasOwnProperty("_tooltipEnabled")) {
    e._tooltipEnabled = !0;
    i = i || {};
    t = "string" == typeof t ? new g("div", {
      text: t
    }) : t;
    v(e);
    y(e);
    e.on("longtap", function () {
      y.start();
      o();
      u = !0;
    });
    e.on("touchenter", function () {
      u && o();
    });
    var s = this;
    i.openOnTap ? e.on("tap", o) : i.longTapExplanation && e.on("tap", a);
    e.on("touchleave", r);
  }
};
n.prototype.hideBackgroundOnce = function () {
  this.addClassNames("noBackground");
};
n.prototype.resetBackground = function () {
  this.delClassNames("noBackground");
};
n.prototype.openTooltipAt = function (e, t, i, n, o) {
  var a = p.newTargetRect(e, t, i || A, n || A);
  this._updateAndAppear(o || null, a);
};
t.enableTooltip = function (e, t) {
  e.hasOwnProperty("_tooltipEnabled") && e._tooltipEnabled !== t && (e._tooltipEnabled = t);
};
i = i || {
  margin: S
};
this._updateAndAppear(e, p.getTargetRect(t), i);
e && this._setContent(e);
this.show();
this.content.setStyles({
  width: s + "px",
  height: r + "px"
});
this.openState ? (this.setStyles({
  width: n[0] + "px",
  height: n[1] + "px",
  overflow: null
}), m.forceReflow(this), this.addClassNames("transition"), _.tween(this, {
  width: l + "px",
  height: c + "px",
  webkitTransform: f
}, {
  time: 150,
  easing: "ease-out"
}, o)) : (this.openState = !0, this.setStyles({
  width: l + "px",
  height: c + "px",
  overflow: null,
  webkitTransform: f,
  opacity: 1
}), b("ROLLOVER"));
u && y.stop();
u = !1;
s();
c._updateAndAppear(t, p.getTargetRect(e), {
  margin: A / 2
});
c.delClassNames("noBackground");
d = e;
e.emit("tooltipOn");
e._tooltipEnabled = !0;
i = i || {};
t = "string" == typeof t ? new g("div", {
  text: t
}) : t;
v(e);
y(e);
e.on("longtap", function () {
  y.start();
  o();
  u = !0;
});
e.on("touchenter", function () {
  u && o();
});
y.start();
o();
u = !0;
i.openOnTap ? e.on("tap", o) : i.longTapExplanation && e.on("tap", a);
e.on("touchleave", r);
t.computeNotificationDisplayTime = l;
t.showNotification = function (e, t, i) {
  "string" == typeof e ? (i = i || l(e.length), e = c.createChild("div", {
    text: e
  })) : i = i || E;
  c._updateAndAppear(e, p.getTargetRect(t));
  clearTimeout(h);
  h = setTimeout(s, i);
};
"string" == typeof e ? (i = i || l(e.length), e = c.createChild("div", {
  text: e
})) : i = i || E;
c._updateAndAppear(e, p.getTargetRect(t));
clearTimeout(h);
h = setTimeout(s, i);
p = b.x = t.x;
m = b.y = t.y;
b.touchCount = t.touchCount;
v = e;
g = b.touchedElements = [];
t.initEvent("touching", !0, !0);
e.dispatchEvent(t);
n(e);
(Math.abs(p - T) > 15 || Math.abs(m - C) > 15 || e.timeStamp - I > 50) && (T = p, C = m, a());
I = e.timeStamp;
b.touchCount = t.touchCount;
0 === t.touchCount && d();
g.push(y);
_ = b.topElement = g[0];
n !== o && (n && n.emit("touchleave", b), o && o.emit("touchenter", b));
t -= 1;
e -= 1;
f = g;
M = !0;
e.exports = u;
u.start = c;
u.stop = d;
u.initialize = function (e) {
  return window._hoverBehavior ? console.error("hover behavior initialised more than one time.") : (window._hoverBehavior = !0, y = e, void y.on("dom.touching", l));
};
window.gui.on("appGoBackground", function () {
  T.setMute(!0);
});
window.gui.on("appLeaveBackground", function () {
  T.setMute(!1);
});
f.on("gameContextChanged", function () {
  s();
});
C.error(function (e) {
  console.error("fifo sound experienced an error " + e);
});
window.wizAssets ? T.settings.getFileUri = function (e, t, i) {
  return n("audio/" + t + ".mp3") ? i("FROM_MISSING_AUDIO_LIST") : void C.push(function (n) {
    c.downloadFile(e + t + ".mp3", "audio/" + t + ".mp3", function (e) {
      return n(), i(null, e);
    }, function (e) {
      return n(), i(e);
    });
  });
} : T.settings.getFileUri = function (e, t) {
  return n("audio/" + t + ".mp3") ? "FROM_MISSING_AUDIO_LIST" : e + t + ".mp3";
};
h.isCordova && (T.settings.getSoundConstructor = function (e) {
  return h.isIOSApp && p.isAvailable() ? p : h.isAndroidApp && m.isAvailable() ? "music" === e || "ambient" === e ? m.LoopYanap : "sfx" === e || "ui" === e ? m.SoundYanap : void 0 === e ? m.SoundYanap : void console.error(new Error("audioManager: unknown channelId `" + e + "`")) : null;
});
t.initialize = function () {
  T.init();
  o();
};
t.createUiSound = function (e) {
  T.createSoundPermanent(d[e], "ui");
};
t.playUiSound = function (e) {
  if (!T.channels.ui.muted) {
    var t = d[e];
    if (!t) {
      return console.warn("Incorrect UI sound id: " + e);
    }
    M || a();
    T.playSound("ui", t);
  }
};
t.mapChange = function (e, t) {
  var i = {
    music: null,
    ambient: null,
    fight: null,
    boss: null
  };
  t = e.concat(t);
  for (var n = 0; n < t.length; n++) {
    var o = t[n],
      a = _[o.type_id];
    a && (i[a] = o);
  }
  v = i.music || v;
  b = i.ambient || b;
  y = i.fight;
  w = i.boss;
  s();
};
t.createAnimSoundGroups = function (e, t) {
  var i = void 0 !== t && T.channels[t].muted;
  for (var n in e) {
    if (e.hasOwnProperty(n)) {
      for (var o = e[n], a = [], s = 0; s < o.vol.length; s++) {
        a.push(o.vol[s] / 100);
      }
      T.createSoundGroup(n, {
        id: o.id,
        vol: a
      }, i);
    }
  }
};
t.setChannelVolume = function (e, t, i) {
  T.setVolume(e, t, i);
  "sfx" === e && this.setChannelVolume("ambient", t, i);
};
t.setupChannels = function (e) {
  T.setVolume("ambient", 0, !0);
  for (var t in e) {
    if ("ambient" !== t) {
      var i = e[t];
      this.setChannelVolume(t, i.volume, i.muted);
    }
  }
};
t.getDefaultParams = function () {
  var e = {};
  for (var t in T.channels) {
    if ("ambient" !== t) {
      var i = "music" === t && h.isIpad2,
        n = i ? 0 : 1;
      e[t] = {
        muted: i,
        volume: n
      };
    }
  }
  return e;
};
t.getMemoryInformation = function () {
  return {
    maxUsedMemory: T.settings.maxUsedMemory,
    totalUsedMemory: T.totalUsedMemory
  };
};
T.init();
o();
M || a();
T.playSound("ui", t);
v = i.music || v;
b = i.ambient || b;
y = i.fight;
w = i.boss;
s();
T.setVolume(e, t, i);
"sfx" === e && this.setChannelVolume("ambient", t, i);
this.soundsById = {};
this.soundGroupsById = {};
this.permanentSounds = {};
this.freeSoundPool = [];
this.soundArchive = new a(function () {
  return 1;
});
this.soundGroupArchive = new a(function () {
  return 1;
});
this.soundArchiveById = {};
this.soundGroupArchiveById = {};
this.totalUsedMemory = 0;
this.channels = {};
this.audioContext = null;
this.muted = !1;
this.settings = {
  audioPath: "",
  maxSoundGroup: 500,
  maxUsedMemory: 300,
  defaultFade: 2,
  maxPlayLatency: 1e3,
  crossFading: !1,
  getFileUri: function (e, t) {
    return e + t + ".mp3";
  },
  getSoundConstructor: function () {
    return null;
  }
};
c.prototype.audioManager = this;
r.prototype.audioManager = this;
l.prototype.audioManager = this;
e.exports = n;
n.prototype.init = function () {
  if (!this.audioContext && o) {
    this.audioContext = new o();
    s.prototype.audioContext = this.audioContext;
    for (var e in this.soundsById) {
      this.soundsById.hasOwnProperty(e) && this.soundsById[e].init();
    }
  }
};
n.prototype.getEmptySound = function (e, t) {
  var i,
    n = this.settings.getSoundConstructor(e, t);
  return n ? i = new n() : (this.freeSoundPool.length > 0 ? (i = this.freeSoundPool.pop(), i.init()) : i = new s(), i);
};
n.prototype.setup = function (e) {
  for (var t in e) {
    if (e.hasOwnProperty(t)) {
      var i = e[t];
      this.setVolume(t, i.volume, i.muted);
    }
  }
};
n.prototype.addChannel = function (e) {
  this.channels[e] || (this.channels[e] = new l(e));
};
n.prototype.setVolume = function (e, t, i) {
  var n = this.channels[e];
  n && n.setVolume(t, i);
};
n.prototype.setMute = function (e) {
  void 0 === e && (e = !this.muted);
  this.muted = Boolean(e);
  for (var t in this.channels) {
    if (this.channels.hasOwnProperty(t)) {
      var i = this.channels[t];
      if (!i.loopSound) {
        continue;
      }
      if (e) {
        i.loopSound.stop();
      } else {
        var n = i.muted;
        i.muted = !0;
        i.setVolume(null, n);
      }
    }
  }
};
n.prototype.loadSound = function (e, t, i) {
  t = t || {};
  var n = this.createSound(e);
  n.load(function (n) {
    if (n && "FROM_MISSING_AUDIO_LIST" !== n) {
      var o = "";
      switch (typeof n) {
        case "string":
          o = n;
          break;
        case "object":
          try {
            o = JSON.stringify(n);
          } catch (a) {
            o = "failed stringify: " + a;
          }
          break;
        default:
          console.error("loadSound: UNKNOWN typeof " + typeof n + " for " + n);
      }
      console.error("loadSound: error " + o + ' for "audio/' + e + '.mp3": "' + t.soundGroupId + '",');
    }
    if (i) {
      return i();
    }
  });
};
n.prototype.createSound = function (e, t) {
  var i = this.getSound(e);
  return i ? i : (i = this.getEmptySound(t, e), this.soundsById[e] = i, i.setId(e), i);
};
n.prototype._calculateMem = function () {
  var e = 0;
  for (var t in this.permanentSounds) {
    if (this.permanentSounds.hasOwnProperty(t)) {
      var i = this.permanentSounds[t];
      e += i.usedMemory;
    }
  }
  for (var n in this.soundsById) {
    if (this.soundsById.hasOwnProperty(n)) {
      var o = this.soundsById[n];
      e += o.usedMemory;
    }
  }
  return this.totalUsedMemory = e, e;
};
n.prototype.createSoundPermanent = function (e, t) {
  var i = this.getSound(e);
  if (i) {
    return i;
  }
  var n = this.settings.getSoundConstructor(t, e) || s;
  return i = this.permanentSounds[e] = new n(), i.setId(e), i;
};
n.prototype.getSound = function (e) {
  var t = this.permanentSounds[e];
  return t ? t : (t = this.soundsById[e]) ? t : (t = this.soundArchiveById[e]) ? (this.soundArchive.removeByRef(t.poolRef), t.poolRef = null, delete this.soundArchiveById[e], this.soundsById[e] = t, t) : null;
};
n.prototype.getSoundGroup = function (e) {
  var t = this.soundGroupsById[e];
  return t ? t : (t = this.soundGroupArchiveById[e]) ? (this.soundGroupArchive.removeByRef(t.poolRef), t.poolRef = null, delete this.soundGroupArchiveById[e], t.verifySounds(), this.soundGroupsById[e] = t, t) : null;
};
n.prototype.freeSound = function (e) {
  var t = e.id;
  this.soundsById[t] && delete this.soundsById[t];
  this.soundArchiveById[t] && (this.soundArchive.removeByRef(e.poolRef), e.poolRef = null, delete this.soundArchiveById[t]);
  e.unload();
  e instanceof s && this.freeSoundPool.push(e);
};
n.prototype.playLoopSound = function (e, t, i, n, o, a, s) {
  var r = this.channels[e];
  return r ? void r.playLoopSound(t, i, n, o, a, s) : console.warn('Channel id "' + e + '" does not exist.');
};
n.prototype.stopLoopSound = function (e) {
  var t = this,
    i = this.channels[e];
  if (!i) {
    return console.warn('Channel id "' + e + '" does not exist.');
  }
  var n = i.loopSound;
  i.loopId = null;
  n && n.stop(function () {
    t.freeSound(n);
    i.loopSound = null;
  });
};
n.prototype.stopAllLoopSounds = function () {
  for (var e in this.channels) {
    this.stopLoopSound(e);
  }
};
n.prototype.release = function () {
  var e,
    t,
    i,
    n = this.settings.maxSoundGroup,
    o = this.settings.maxUsedMemory,
    a = {};
  for (e in this.channels) {
    var s = this.channels[e];
    s.loopSound && (a[s.loopSound.id] = !0);
  }
  for (e in this.soundGroupsById) {
    t = this.soundGroupsById[e];
    t.poolRef = this.soundGroupArchive.add(t);
    this.soundGroupArchiveById[e] = t;
    delete this.soundGroupsById[e];
  }
  for (e in this.soundsById) {
    a[e] || (i = this.soundsById[e], i.poolRef = this.soundArchive.add(i), this.soundArchiveById[e] = i, delete this.soundsById[e]);
  }
  for (var r = this.soundGroupArchive.getCount(); r > n && (t = this.soundGroupArchive.popFirst());) {
    t.poolRef = null;
    delete this.soundGroupArchiveById[t.id];
    r -= 1;
  }
  for (this._calculateMem(); this.totalUsedMemory > o;) {
    if (i = this.soundArchive.popFirst(), !i) {
      this._calculateMem();
      this.totalUsedMemory > o && console.error("No more sound to release but " + this.totalUsedMemory + " used out of " + o);
      break;
    }
    i.poolRef = null;
    delete this.soundArchiveById[i.id];
    this.freeSound(i);
    this._calculateMem();
  }
};
n.prototype.playSound = function (e, t, i, n, o) {
  if (this.muted) {
    return d;
  }
  var a = this.channels[e];
  if (a.muted) {
    return d;
  }
  var s = this.getSound(t);
  return s || (s = this.createSound(t, e)), i = i || 1, s.play(a.volume * i, n, o), s;
};
n.prototype.playSoundGroup = function (e, t, i, n, o) {
  if (!this.muted) {
    var a = this.channels[e];
    if (a && !a.muted) {
      var s = this.getSoundGroup(t);
      if (!s) {
        return console.error(new Error('SoundGroup "' + t + '" does not exist.'));
      }
      i = i || 1;
      s.play(i * a.volume, n, o);
    }
  }
};
n.prototype.createSoundGroup = function (e, t, i) {
  this.getSoundGroup(e) || (this.soundGroupsById[e] = new r(e, t.id, t.vol, t.pitch, i));
};
n.prototype.createSoundGroups = function (e, t) {
  var i = void 0 !== t && this.channels[t].muted;
  for (var n in e) {
    this.createSoundGroup(n, e[n], i);
  }
};
this.audioContext = new o();
s.prototype.audioContext = this.audioContext;
void 0 === e && (e = !this.muted);
this.muted = Boolean(e);
i.muted = !0;
i.setVolume(null, n);
this.soundsById[t] && delete this.soundsById[t];
this.soundArchiveById[t] && (this.soundArchive.removeByRef(e.poolRef), e.poolRef = null, delete this.soundArchiveById[t]);
e.unload();
e instanceof s && this.freeSoundPool.push(e);
i.loopId = null;
n && n.stop(function () {
  t.freeSound(n);
  i.loopSound = null;
});
t.freeSound(n);
i.loopSound = null;
t = this.soundGroupsById[e];
t.poolRef = this.soundGroupArchive.add(t);
this.soundGroupArchiveById[e] = t;
delete this.soundGroupsById[e];
t.poolRef = null;
delete this.soundGroupArchiveById[t.id];
r -= 1;
this._calculateMem();
this.totalUsedMemory > o && console.error("No more sound to release but " + this.totalUsedMemory + " used out of " + o);
i.poolRef = null;
delete this.soundArchiveById[i.id];
this.freeSound(i);
this._calculateMem();
i = i || 1;
s.play(i * a.volume, n, o);
this.count = 0;
this.first = null;
this.last = null;
this.cmpFunc = e;
this.object = e;
this.previous = t;
this.next = i;
this.container = n;
i.prototype.add = function (e) {
  var t = new n(e, null, null, this);
  if (this.count += 1, null === this.first) {
    return this.first = t, this.last = t, t;
  }
  var i = this.cmpFunc(e, this.first.object);
  if (i < 0) {
    return t.next = this.first, this.first.previous = t, this.first = t, t;
  }
  var o = this.cmpFunc(e, this.last.object);
  if (o >= 0) {
    return t.previous = this.last, this.last.next = t, this.last = t, t;
  }
  var a;
  if (i + o < 0) {
    for (a = this.first.next; this.cmpFunc(e, a.object) >= 0;) {
      a = a.next;
    }
    t.next = a;
    t.previous = a.previous;
    t.previous.next = t;
    a.previous = t;
  } else {
    for (a = this.last.previous; this.cmpFunc(e, a.object) < 0;) {
      a = a.previous;
    }
    t.previous = a;
    t.next = a.next;
    t.next.previous = t;
    a.next = t;
  }
  return t;
};
i.prototype.removeByRef = function (e) {
  return !(!e || e.container !== this) && (this.count -= 1, null === e.previous ? this.first = e.next : e.previous.next = e.next, null === e.next ? this.last = e.previous : e.next.previous = e.previous, e.previous = null, e.next = null, e.container = null, !0);
};
i.prototype.moveToTheBeginning = function (e) {
  return !(!e || e.container !== this) && (null === e.previous || (e.previous.next = e.next, this.last === e ? this.last = e.previous : e.next.previous = e.previous, e.previous = null, e.next = this.first, e.next.previous = e, this.first = e, !0));
};
i.prototype.moveToTheEnd = function (e) {
  return !(!e || e.container !== this) && (null === e.next || (e.next.previous = e.previous, this.first === e ? this.first = e.next : e.previous.next = e.next, e.next = null, e.previous = this.last, e.previous.next = e, this.last = e, !0));
};
i.prototype.possess = function (e) {
  return e && e.container === this;
};
i.prototype.popFirst = function () {
  var e = this.first;
  if (!e) {
    return null;
  }
  this.count -= 1;
  var t = e.object;
  return this.first = e.next, null !== this.first && (this.first.previous = null), e.next = null, e.container = null, t;
};
i.prototype.popLast = function () {
  var e = this.last;
  if (!e) {
    return null;
  }
  this.count -= 1;
  var t = e.object;
  return this.last = e.previous, null !== this.last && (this.last.next = null), e.previous = null, e.container = null, t;
};
i.prototype.getFirst = function () {
  return this.first && this.first.object;
};
i.prototype.getLast = function () {
  return this.last && this.last.object;
};
i.prototype.clear = function () {
  for (var e = this.first; e; e = e.next) {
    e.container = null;
  }
  this.count = 0;
  this.first = null;
  this.last = null;
};
i.prototype.getCount = function () {
  return this.count;
};
i.prototype.toArray = function () {
  for (var e = [], t = this.first; t; t = t.next) {
    e.push(t.object);
  }
  return e;
};
i.prototype.forEach = function (e, t) {
  for (var i = this.first; i; i = i.next) {
    e(i.object, t);
  }
};
i.prototype.forEachReverse = function (e, t) {
  for (var i = this.last; i; i = i.previous) {
    e(i.object, t);
  }
};
i.prototype.reposition = function (e) {
  if (e.container !== this) {
    return this.add(e.object);
  }
  var t = e.previous,
    i = e.next,
    n = e.object;
  for (null === i ? this.last = t : i.previous = t, null === t ? this.first = i : t.next = i; null !== t && this.cmpFunc(n, t.object) < 0;) {
    i = t;
    t = t.previous;
  }
  for (; null !== i && this.cmpFunc(n, i.object) >= 0;) {
    t = i;
    i = i.next;
  }
  return e.next = i, null === i ? this.last = e : i.previous = e, e.previous = t, null === t ? this.first = e : t.next = e, e;
};
e.exports = i;
t.next = a;
t.previous = a.previous;
t.previous.next = t;
a.previous = t;
t.previous = a;
t.next = a.next;
t.next.previous = t;
a.next = t;
this.count = 0;
this.first = null;
this.last = null;
i = t;
t = t.previous;
t = i;
i = i.next;
a.call(this);
this.buffer = null;
this.source = null;
this.sourceConnector = null;
this.gain = null;
this.panNode = null;
this.rawAudioData = null;
this._playPitch = 0;
this._fadeTimeout = null;
this._onStopCallback = null;
this._audioNodeReady = !1;
this._loopStart = 0;
this._loopEnd = 0;
this.init();
o(n, a);
e.exports = n;
n.prototype._createAudioNodes = function () {
  if (!this._audioNodeReady && this.audioContext) {
    var e,
      t = this.audioContext,
      i = t.createGain();
    e = t.createStereoPanner ? t.createStereoPanner() : t.createPanner();
    i.connect(e);
    e.connect(t.destination);
    i.gain.value = 0;
    this.sourceConnector = i;
    this.gain = i.gain;
    this.panNode = e;
    this._audioNodeReady = !0;
  }
};
n.prototype._destroyAudioNodes = function () {
  if (this._audioNodeReady) {
    var e = this.audioContext,
      t = this.panNode,
      i = this.sourceConnector;
    i.disconnect(t);
    t.disconnect(e.destination);
    this.source && (this.source.disconnect(i), this.source.onended = null, this.source = null);
    this.sourceConnector = null;
    this.gain = null;
    this.panNode = null;
    this.rawAudioData = null;
    this._audioNodeReady = !1;
  }
};
n.prototype.init = function () {
  function e(e) {
    i.buffer = e;
    i.usedMemory = e.duration;
    i.rawAudioData = null;
    i._loaded && i._playTriggered && ((i.loop || Date.now() - i._playTriggered < n) && i._play(), i._playTriggered = 0);
  }
  function t() {
    console.error("decode audio failed for sound ", i.id);
  }
  if (this._createAudioNodes(), this.rawAudioData) {
    var i = this,
      n = this.audioManager.settings.maxPlayLatency,
      o = this.audioContext;
    o.decodeAudioData(this.rawAudioData, e, t);
  }
};
n.prototype.setVolume = function (e) {
  if (this.volume = e, this.playing) {
    if (!this.fade) {
      return void (this.gain.value = e);
    }
    e <= 0 && (e = s);
    var t = this.audioContext.currentTime;
    this.gain.cancelScheduledValues(t);
    this.gain.setValueAtTime(this.gain.value || s, t);
    this.gain.linearRampToValueAtTime(e, t + this.fade);
  }
};
n.prototype.setPan = function (e) {
  this.pan = e;
  this.panNode && (this.panNode.pan ? this.panNode.pan.value = e : this.panNode.setPosition(e, 0, .2));
};
n.prototype.setLoop = function (e, t, i) {
  this.loop = !!e;
  this._loopStart = t || 0;
  this._loopEnd = i || 0;
  this.source && this.buffer && (this.source.loop = e, this._setLoopPoints());
};
n.prototype._setLoopPoints = function () {
  this.source.loopStart = this._loopStart || 0;
  var e = this._loopEnd;
  e < 0 && (e = this.buffer.duration + e);
  e < 0 && (e = 0);
  this.source.loopEnd = e || this.buffer.duration;
};
n.prototype.setPitch = function (e, t) {
  this.pitch = e;
  this._setPlaybackRate(t);
};
n.prototype._updatePlayPitch = function (e) {
  !e && 0 !== e || e === this._playPitch || (this._playPitch = e, this._setPlaybackRate(0));
};
n.prototype._setPlaybackRate = function (e) {
  if (this.source) {
    var t = Math.pow(2, (this._playPitch + this.pitch) / 12);
    if (!e) {
      return void (this.source.playbackRate.value = t);
    }
    var i = this.audioContext.currentTime;
    this.source.playbackRate.cancelScheduledValues(i);
    this.source.playbackRate.setValueAtTime(this.source.playbackRate.value || s, i);
    this.source.playbackRate.linearRampToValueAtTime(t, i + e);
  }
};
n.prototype._load = function () {
  function e(e) {
    n._finalizeLoad(e);
  }
  function t(e) {
    n.buffer = e;
    n.usedMemory = e.duration;
    n._finalizeLoad(null);
  }
  function i(i) {
    var o = new XMLHttpRequest();
    o.responseType = "arraybuffer";
    o.onreadystatechange = function () {
      if (4 === ~~o.readyState) {
        return 200 !== ~~o.status && 0 !== ~~o.status ? e("xhrError:" + o.status) : void (n.audioContext ? n.audioContext.decodeAudioData(o.response, t, e) : (n.rawAudioData = o.response, n._finalizeLoad(null)));
      }
    };
    o.open("GET", i, !0);
    o.send();
  }
  var n = this;
  this._createAudioNodes();
  var o = this.audioManager.settings.getFileUri,
    a = this.audioManager.settings.audioPath;
  if (o.length > 2) {
    o(a, this.id, function (t, n) {
      return t ? e(t) : void i(n);
    });
  } else {
    try {
      var s = o(a, this.id);
      if ("FROM_MISSING_AUDIO_LIST" === s) {
        return e(s);
      }
      i(s);
    } catch (r) {
      e(r);
    }
  }
};
n.prototype.unload = function () {
  a.prototype.unload.call(this) && (this._fadeTimeout && (this._onStopCallback = null, this._stopAndClear()), this.buffer = null, this.source && (this.source.onended = null, this.source.stop(0), this.source = null), this._destroyAudioNodes());
};
n.prototype._play = function (e) {
  if (!this.buffer) {
    return void (this._playTriggered = Date.now());
  }
  this.playing = !0;
  var t = this.audioContext.currentTime;
  if (this.gain.cancelScheduledValues(t), this.fade ? (this.gain.setValueAtTime(this.gain.value || s, t), this.gain.linearRampToValueAtTime(this.volume || s, t + this.fade)) : this.gain.value = this.volume, this._fadeTimeout) {
    return this._onStopCallback = null, this.source.onended = null, this.stopping = !1, window.clearTimeout(this._fadeTimeout), void (this._fadeTimeout = null);
  }
  this.source && (this.source.disconnect(this.sourceConnector), this.source.onended = null);
  var i = this.source = this.audioContext.createBufferSource();
  i.connect(this.sourceConnector);
  var n = this;
  i.onended = function () {
    n.playing = !1;
    i.onended = null;
    n.source = null;
    n.onEnd && n.onEnd();
  };
  this._playPitch = e || 0;
  (e || this.pitch) && this._setPlaybackRate(0);
  i.loop = this.loop;
  i.buffer = this.buffer;
  this._setLoopPoints();
  i.start(0);
};
n.prototype._stopAndClear = function () {
  this.stopping = !1;
  this.source.onended = null;
  this.source.stop(0);
  this.source = null;
  this._fadeTimeout && (window.clearTimeout(this._fadeTimeout), this._fadeTimeout = null);
  this._onStopCallback && (this._onStopCallback(), this._onStopCallback = null);
};
n.prototype.stop = function (e) {
  if (!this.playing && !this.stopping) {
    return e && e();
  }
  if (this._playTriggered = 0, this.stopping = !0, this.playing = !1, !this.source) {
    return e && e();
  }
  if (this._onStopCallback = e, !this._fadeTimeout) {
    if (this.fade) {
      var t = this,
        i = this.audioContext.currentTime;
      return this.gain.cancelScheduledValues(i), this.gain.setValueAtTime(this.gain.value || s, i), this.gain.linearRampToValueAtTime(s, i + this.fade), void (this._fadeTimeout = window.setTimeout(function () {
        t._fadeTimeout = null;
        t._stopAndClear();
      }, 1e3 * this.fade));
    }
    this._stopAndClear();
  }
};
e = t.createStereoPanner ? t.createStereoPanner() : t.createPanner();
i.connect(e);
e.connect(t.destination);
i.gain.value = 0;
this.sourceConnector = i;
this.gain = i.gain;
this.panNode = e;
this._audioNodeReady = !0;
i.disconnect(t);
t.disconnect(e.destination);
this.source && (this.source.disconnect(i), this.source.onended = null, this.source = null);
this.sourceConnector = null;
this.gain = null;
this.panNode = null;
this.rawAudioData = null;
this._audioNodeReady = !1;
i.buffer = e;
i.usedMemory = e.duration;
i.rawAudioData = null;
i._loaded && i._playTriggered && ((i.loop || Date.now() - i._playTriggered < n) && i._play(), i._playTriggered = 0);
this.gain.cancelScheduledValues(t);
this.gain.setValueAtTime(this.gain.value || s, t);
this.gain.linearRampToValueAtTime(e, t + this.fade);
this.pan = e;
this.panNode && (this.panNode.pan ? this.panNode.pan.value = e : this.panNode.setPosition(e, 0, .2));
this.loop = !!e;
this._loopStart = t || 0;
this._loopEnd = i || 0;
this.source && this.buffer && (this.source.loop = e, this._setLoopPoints());
e < 0 && (e = this.buffer.duration + e);
e < 0 && (e = 0);
this.source.loopEnd = e || this.buffer.duration;
this.pitch = e;
this._setPlaybackRate(t);
this.source.playbackRate.cancelScheduledValues(i);
this.source.playbackRate.setValueAtTime(this.source.playbackRate.value || s, i);
this.source.playbackRate.linearRampToValueAtTime(t, i + e);
n.buffer = e;
n.usedMemory = e.duration;
n._finalizeLoad(null);
o.responseType = "arraybuffer";
o.onreadystatechange = function () {
  if (4 === ~~o.readyState) {
    return 200 !== ~~o.status && 0 !== ~~o.status ? e("xhrError:" + o.status) : void (n.audioContext ? n.audioContext.decodeAudioData(o.response, t, e) : (n.rawAudioData = o.response, n._finalizeLoad(null)));
  }
};
o.open("GET", i, !0);
o.send();
i.onended = function () {
  n.playing = !1;
  i.onended = null;
  n.source = null;
  n.onEnd && n.onEnd();
};
this._playPitch = e || 0;
(e || this.pitch) && this._setPlaybackRate(0);
i.loop = this.loop;
i.buffer = this.buffer;
this._setLoopPoints();
i.start(0);
n.playing = !1;
i.onended = null;
n.source = null;
n.onEnd && n.onEnd();
this.stopping = !1;
this.source.onended = null;
this.source.stop(0);
this.source = null;
this._fadeTimeout && (window.clearTimeout(this._fadeTimeout), this._fadeTimeout = null);
this._onStopCallback && (this._onStopCallback(), this._onStopCallback = null);
t._fadeTimeout = null;
t._stopAndClear();
this.playing = !1;
this.stopping = !1;
this.fade = 0;
this.usedMemory = 0;
this.poolRef = null;
this.onEnd = null;
this.id = null;
this.volume = 1;
this.pan = 0;
this.loop = !1;
this.pitch = 0;
this._loaded = !1;
this._loading = !1;
this._unloading = !1;
this._playTriggered = 0;
this._onLoadQueuedCallback = [];
e.exports = i;
i.prototype.setId = function (e) {
  this.id = e;
  this._loaded = !1;
};
i.prototype.load = function (e) {
  return this.id ? this._loaded ? e && e(null, this) : (e && this._onLoadQueuedCallback.push(e), this._loading ? void 0 : (this._loading = !0, this._load())) : e && e(new Error("noId"));
};
i.prototype._finalizeLoad = function (e) {
  var t = this.audioManager.settings.maxPlayLatency;
  this._loaded = !e;
  this._loading = !1;
  for (var i = 0; i < this._onLoadQueuedCallback.length; i++) {
    this._onLoadQueuedCallback[i](e, this);
  }
  return this._onLoadQueuedCallback = [], this._unloading ? (this._unloading = !1, void this.unload()) : void (this._loaded && this._playTriggered && ((this.loop || Date.now() - this._playTriggered < t) && this._play(), this._playTriggered = 0));
};
i.prototype.cancelOnLoadCallbacks = function () {
  this._onLoadQueuedCallback = [];
};
i.prototype.play = function (e, t, i) {
  return void 0 !== e && null !== e && this.setVolume(e), void 0 !== t && null !== t && this.setPan(t), this._loaded ? this.loop && this.playing ? void this._updatePlayPitch(i) : void this._play(i) : (this._playTriggered = Date.now(), void this.load());
};
i.prototype.init = function () {};
i.prototype.setVolume = function (e) {
  this.volume = e;
};
i.prototype.setPan = function (e) {
  this.pan = e;
};
i.prototype.setLoop = function (e) {
  this.loop = e;
};
i.prototype.setPitch = function (e) {
  this.pitch = e;
};
i.prototype._updatePlayPitch = function () {};
i.prototype._play = function () {
  this.playing = !0;
  console.log('ISound play call: "' + this.id + '"');
};
i.prototype.stop = function (e) {
  return this.playing = !1, e && e();
};
i.prototype._load = function () {
  return console.log("ISound load call: " + this.id), this._finalizeLoad(null);
};
i.prototype.unload = function () {
  return this._playTriggered = 0, this.setLoop(!1), this.fade = 0, this.pitch = 0, this.stop(), this._loading ? (this._unloading = !0, !1) : (this.setVolume(1), this.setPan(0), this.id = null, this._loaded = !1, this.usedMemory = 0, !0);
};
this.id = e;
this._loaded = !1;
this._loaded = !e;
this._loading = !1;
this.playing = !0;
console.log('ISound play call: "' + this.id + '"');
this.id = e;
this.soundIds = t;
this.volumes = i || [];
this.pitches = n || [];
this.soundIndex = 0;
this.volIndex = 0;
this.pitchIndex = 0;
this.poolRef = null;
this._ready = !1;
0 === this.volumes.length && this.volumes.push(1);
0 === this.pitches.length && this.pitches.push(0);
o || this._createSounds();
e.exports = i;
i.prototype._createSounds = function () {
  for (var e = this.soundIds, t = 0; t < e.length; t++) {
    this.audioManager.loadSound(e[t], {
      soundGroupId: this.id
    });
  }
  this._ready = !0;
};
i.prototype.play = function (e, t, i) {
  if (0 !== this.soundIds.length) {
    this._ready || this._createSounds();
    this.soundIndex = Math.trunc(Math.random() * this.soundIds.length);
    this.volIndex = this.soundIndex;
    this.pitchIndex = this.soundIndex;
    var n = this.soundIds[this.soundIndex],
      o = this.audioManager.getSound(n);
    if (!o) {
      return console.warn("[Sound Group: " + this.id + "] sound id " + n + "  cannot be played.");
    }
    e = e || 1;
    i = i || 0;
    e *= this.volumes[this.volIndex];
    i += this.pitches[this.pitchIndex];
    o.play(e, t, i);
  }
};
i.prototype.verifySounds = function () {
  for (var e = 0; e < this.soundIds.length; e++) {
    var t = this.soundIds[e];
    this.audioManager.createSound(t);
  }
};
this._ready || this._createSounds();
this.soundIndex = Math.trunc(Math.random() * this.soundIds.length);
this.volIndex = this.soundIndex;
this.pitchIndex = this.soundIndex;
e = e || 1;
i = i || 0;
e *= this.volumes[this.volIndex];
i += this.pitches[this.pitchIndex];
o.play(e, t, i);
this.id = e;
this.volume = 1;
this.muted = !0;
this.loopSound = null;
this.loopId = null;
this.loopVol = 0;
this.nextLoop = null;
e.exports = i;
i.prototype.setVolume = function (e, t) {
  var i = this.muted;
  this.muted = 0 === e || t || !1;
  void 0 !== e && null !== e ? this.volume = e : e = this.volume;
  this.loopId && (this.loopSound && this.muted ? this.loopSound.stop() : this.loopSound && this.loopSound.id === this.loopId ? (this.loopSound.setVolume(Math.max(0, Math.min(1, e * this.loopVol))), i && this.loopSound.play()) : this.muted || this.audioManager.playLoopSound(this.id, this.loopId, this.loopVol));
};
i.prototype.setMute = function (e) {
  this.setVolume(null, e);
};
i.prototype.playLoopSound = function (e, t, i, n, o, a) {
  function s(e, t) {
    return e ? void (e.stopping || e.stop(function () {
      return c.freeSound(e), e = null, t && t();
    })) : t && t();
  }
  function r() {
    var e = m.loopSound = m.nextLoop;
    m.nextLoop = null;
    e && (e.setLoop(!0, o, a), e.fade = d, e.load(function (o) {
      return o ? (e.unload(), void (m.loopSound = null)) : void e.play(t * m.volume, i, n);
    }));
  }
  function l() {
    m.loopSound = null;
    window.setTimeout(r, 0);
  }
  var c = this.audioManager,
    d = c.settings.defaultFade,
    u = c.settings.crossFading,
    h = this.loopSound,
    p = h && h.id;
  if (t = Math.max(0, Math.min(1, t || 1)), this.loopId = e, this.loopVol = t, !c.muted && !this.muted) {
    if (e === p && h) {
      return h.play(t * this.volume, i, n), void (this.nextLoop && (this.nextLoop.cancelOnLoadCallbacks(), this.nextLoop = null));
    }
    if (h = null, !this.nextLoop || this.nextLoop.id !== e) {
      var m = this;
      u ? (this.nextLoop && this.nextLoop.cancelOnLoadCallbacks(), this.nextLoop = c.createSound(e, this.id), this.nextLoop.load(function (e) {
        return e ? (m.nextLoop.unload(), void (m.nextLoop = null)) : (s(m.loopSound), void l());
      })) : (this.nextLoop = c.createSound(e, this.id), s(this.loopSound, l));
    }
  }
};
this.muted = 0 === e || t || !1;
void 0 !== e && null !== e ? this.volume = e : e = this.volume;
this.loopId && (this.loopSound && this.muted ? this.loopSound.stop() : this.loopSound && this.loopSound.id === this.loopId ? (this.loopSound.setVolume(Math.max(0, Math.min(1, e * this.loopVol))), i && this.loopSound.play()) : this.muted || this.audioManager.playLoopSound(this.id, this.loopId, this.loopVol));
m.nextLoop = null;
e && (e.setLoop(!0, o, a), e.fade = d, e.load(function (o) {
  return o ? (e.unload(), void (m.loopSound = null)) : void e.play(t * m.volume, i, n);
}));
m.loopSound = null;
window.setTimeout(r, 0);
e.loop = !1;
e.type = "audio/mpeg";
this._audio = e;
this._onEnd = null;
this.audioContext && (this.source = this.audioContext.createMediaElementSource(e), this.source.connect(this.audioContext.destination));
o(n, a);
e.exports = n;
n.prototype.setVolume = function (e) {
  this.volume = this._audio.volume = e;
};
n.prototype.setLoop = function (e) {
  this.loop = this._audio.loop = e;
};
n.prototype._load = function () {
  function e(e) {
    o._finalizeLoad(e);
  }
  function t() {
    this.removeEventListener("canplaythrough", t);
    this.removeEventListener("error", i);
    o.usedMemory = this.duration;
    o._finalizeLoad(null);
  }
  function i(n) {
    this.removeEventListener("canplaythrough", t);
    this.removeEventListener("error", i);
    e(n);
  }
  function n(e) {
    o._loading = !0;
    o._audio.addEventListener("canplaythrough", t);
    o._audio.addEventListener("error", i);
    o._audio.src = e;
    o._audio.load();
  }
  var o = this,
    a = this.audioManager.settings.getFileUri,
    s = this.audioManager.settings.audioPath;
  if (a.length > 2) {
    a(s, this.id, function (t, i) {
      return t ? e(t) : void n(i);
    });
  } else {
    try {
      var r = a(s, this.id);
      if ("FROM_MISSING_AUDIO_LIST" === r) {
        return e(r);
      }
      n(r);
    } catch (l) {
      e(l);
    }
  }
};
n.prototype.unload = function () {
  a.prototype.unload.call(this) && (this._audio.volume = 1, this._audio.src = "", this._audio.load());
};
n.prototype._play = function () {
  if (this._audio.volume = this.volume, this._audio.pause(), this._audio.currentTime = 0, this._audio.play(s), this.playing = !0, !this.loop) {
    var e = 1e3 * this._audio.duration;
    if (!(isNaN(e) || e <= 0)) {
      var t = this;
      this._onEnd = window.setTimeout(function () {
        t._onEnd = null;
        t._playing = !1;
        t.onEnd && t.onEnd();
      }, e);
    }
  }
};
n.prototype.stop = function (e) {
  return null !== this._onEnd && (window.clearTimeout(this._onEnd), this._onEnd = null), this._audio.pause(), this._audio.currentTime = 0, this._playTriggered = 0, this.playing = !1, e && e();
};
this.removeEventListener("canplaythrough", t);
this.removeEventListener("error", i);
o.usedMemory = this.duration;
o._finalizeLoad(null);
this.removeEventListener("canplaythrough", t);
this.removeEventListener("error", i);
e(n);
o._loading = !0;
o._audio.addEventListener("canplaythrough", t);
o._audio.addEventListener("error", i);
o._audio.src = e;
o._audio.load();
t._onEnd = null;
t._playing = !1;
t.onEnd && t.onEnd();
o(n, a);
e.exports = n;
n.isAvailable = function () {
  return s.isCordova && window.Media;
};
n.prototype.setVolume = function (e) {
  a.prototype.setVolume.call(this, e);
  this.media && this.media.setVolume(e);
};
n.prototype._load = function () {
  function e() {}
  function t(e) {
    var t = !o.errorOccured,
      i = s.isIOSApp && window.navigator.userAgent.indexOf("iPad; CPU OS 8_0") !== -1;
    3 === e.code && i && (l && (t = !1), l = !0);
    o._loading && o._finalizeLoad(e);
    o.errorOccured || o.unload();
    o.errorOccured = !0;
    t && console.error("SoundCordova: " + JSON.stringify(e) + ", file: " + o.uri);
  }
  function i() {
    if (!o.usedMemory) {
      var e = Number(o.media.getDuration());
      !e || e < 0 || (o.usedMemory = e);
    }
  }
  function n(n) {
    o.uri = n;
    o.media = new window.Media(n, e, t, i);
    o._loading && !o.errorOccured && o._finalizeLoad(null);
  }
  var o = this;
  if (o.errorOccured) {
    return this._finalizeLoad("previouslyFailed");
  }
  var a = o.audioManager.settings.getFileUri,
    r = o.audioManager.settings.audioPath;
  if (a.length > 2) {
    a(r, o.id, function (e, t) {
      return e ? o._finalizeLoad(e) : void n(t);
    });
  } else {
    try {
      var c = a(r, o.id);
      if ("FROM_MISSING_AUDIO_LIST" === c) {
        return o._finalizeLoad(c);
      }
      n(c);
    } catch (d) {
      o._finalizeLoad(d);
    }
  }
};
n.prototype.unload = function () {
  if (a.prototype.unload.call(this)) {
    if (!this.media) {
      return;
    }
    this.media.stop();
    this.media.release();
  }
};
n.prototype._play = function () {
  this.media && (this.errorOccured || (this.media.setVolume(this.volume), this.loop && this.playing || (this.media.seekTo(0), this.media.play({
    numberOfLoops: this.loop ? 0 : 1,
    playAudioWhenScreenIsLocked: !1
  }), this.playing = !0)));
};
n.prototype.stop = function (e) {
  return this.media ? (this.media.stop(), a.prototype.stop.call(this, e)) : e && e();
};
a.prototype.setVolume.call(this, e);
this.media && this.media.setVolume(e);
3 === e.code && i && (l && (t = !1), l = !0);
o._loading && o._finalizeLoad(e);
o.errorOccured || o.unload();
o.errorOccured = !0;
t && console.error("SoundCordova: " + JSON.stringify(e) + ", file: " + o.uri);
o.uri = n;
o.media = new window.Media(n, e, t, i);
o._loading && !o.errorOccured && o._finalizeLoad(null);
this.media.stop();
this.media.release();
o.call(this);
this.audioMode = window.cordova.plugins.Yanap.AUDIO_TYPE.LOOP;
o.call(this);
this.audioMode = window.cordova.plugins.Yanap.AUDIO_TYPE.MUSIC;
o.call(this);
this.audioMode = window.cordova.plugins.Yanap.AUDIO_TYPE.SOUND;
l(o, c);
o.prototype.setVolume = function (e) {
  c.prototype.setVolume.call(this, e);
  this.media && this.media.setVolume(e, e);
};
o.prototype._load = function () {
  function e(e) {
    var t = !n.errorOccured;
    n._loading && n._finalizeLoad(e);
    n.errorOccured || n.unload();
    n.errorOccured = !0;
    t && console.error("SoundYanap: " + JSON.stringify(e) + ", file: " + n.uri);
  }
  function t(t, i) {
    if (t === window.cordova.plugins.Yanap.AUDIO_INSTANCE_STATUS.ERROR) {
      return e(i);
    }
    if (!n.usedMemory && n.media && n.media.fileLength) {
      var o = ~~n.media.fileLength / u;
      o <= 0 || (n.usedMemory = o);
    }
  }
  function i(e) {
    n.uri = e;
    n.media = new window.cordova.plugins.Yanap.AudioInstance(n.audioMode, t);
    window.wizAssets && !window.wizAssets.initialize && (e = e.substr(e.indexOf("/audio/") + 1));
    n.media.load(e);
    n._finalizeLoad(null);
  }
  var n = this;
  if (n.errorOccured) {
    return this._finalizeLoad("previouslyFailed");
  }
  var o = n.audioManager.settings.getFileUri,
    a = n.audioManager.settings.audioPath;
  if (o.length > 2) {
    o(a, n.id, function (e, t) {
      return e ? n._finalizeLoad(e) : void i(t);
    });
  } else {
    try {
      var s = o(a, n.id);
      if ("FROM_MISSING_AUDIO_LIST" === s) {
        return n._finalizeLoad(s);
      }
      i(s);
    } catch (r) {
      n._finalizeLoad(r);
    }
  }
};
o.prototype.unload = function () {
  if (c.prototype.unload.call(this)) {
    if (!this.media) {
      return;
    }
    this.media.stop();
    this.media.release();
  }
};
o.prototype._play = function () {
  this.media && (this.errorOccured || (this.media.setVolume(this.volume, this.volume), this.media.play(), this.playing = !0));
};
o.prototype.stop = function (e) {
  return this.media ? (this.media.stop(), c.prototype.stop.call(this, e)) : e && e();
};
l(a, o);
l(s, o);
l(r, o);
e.exports = {
  LoopYanap: a,
  MusicYanap: s,
  SoundYanap: r,
  isAvailable: n
};
c.prototype.setVolume.call(this, e);
this.media && this.media.setVolume(e, e);
n._loading && n._finalizeLoad(e);
n.errorOccured || n.unload();
n.errorOccured = !0;
t && console.error("SoundYanap: " + JSON.stringify(e) + ", file: " + n.uri);
n.uri = e;
n.media = new window.cordova.plugins.Yanap.AudioInstance(n.audioMode, t);
window.wizAssets && !window.wizAssets.initialize && (e = e.substr(e.indexOf("/audio/") + 1));
n.media.load(e);
n._finalizeLoad(null);
this.media.stop();
this.media.release();
a.call(this);
this._context = s.ROLE_PLAY;
this._setMode();
r.on("GameContextCreateMessage", this.changeGameContext.bind(this));
o(n, a);
n.prototype.changeGameContext = function (e) {
  this._context = e.context;
  this._setMode();
  this.emit("gameContextChanged", this._context);
};
n.prototype._setMode = function () {
  this.isRoleplayMode = this._context === s.ROLE_PLAY;
  this.isFightMode = this._context === s.FIGHT;
};
e.exports = new n();
this._context = e.context;
this._setMode();
this.emit("gameContextChanged", this._context);
this.isRoleplayMode = this._context === s.ROLE_PLAY;
this.isFightMode = this._context === s.FIGHT;
o(e);
n(t);
t = e.exports = new a();
t.setMaxListeners(0);
t.lockMessages = function () {
  I = !0;
};
t.lastReceivedMessage = null;
t.unlockMessages = function () {
  if (I !== !1) {
    I = !1;
    var e = C.slice();
    o(e);
    C.length = 0;
  }
};
t.connect = function (e, i) {
  if (c = e, d) {
    return d.destroy(), d = null, void setTimeout(function () {
      t.connect(c, i);
    }, 0);
  }
  var o = window.Primus,
    a = window.Config.maxReconnectionAttempt || 10;
  g = !1;
  _ = !1;
  v = null;
  h = !0;
  u = !1;
  f = !0;
  d = new o(i, {
    manual: !0,
    strategy: "disconnect,timeout",
    reconnect: {
      max: 5e3,
      min: 500,
      retries: a
    }
  });
  r.startListening();
  d.on("open", function () {
    if (d !== this) {
      return console.warn("onOpen - Ignoring event: possible missing call to Primus#destroy");
    }
    if (g = !1, t.emit("open", u), u && p && Date.now() < m) {
      for (var e = {}, i = 0, n = {}, o = 0; o < p.length; o++) {
        var a = p[o];
        if ("message" === a.type) {
          try {
            var s = JSON.parse(a.data);
            if ("sendMessage" !== s.call) {
              n["call-" + s.call] = 1;
              continue;
            }
            var r = s.data.type;
            if (w[r]) {
              continue;
            }
            i++;
            e[r] = 1;
          } catch (l) {
            console.error("Message to be resent is not JSON: " + a.data.toString().substring(0, 100));
          }
          d.socket.write(a.data, a.options);
        } else {
          n[a.type] = 1;
        }
      }
      i && console.error("Resent " + p.length + " previously unsent messages. Types: {" + Object.keys(e).join(",") + "} Skipped: {" + Object.keys(n).join(",") + "}");
    }
    p = null;
    u = !0;
  });
  d.on("offline", function () {
    f && (f = !1, h && t.emit("offline"));
  });
  d.on("online", function () {
    return d !== this ? console.warn("onOnline - Ignoring event: possible missing call to Primus#destroy") : void (f || (f = !0, h && (t.emit("online"), d.readyState !== o.CLOSED || d.recovery.reconnecting() || window.setTimeout(function () {
      d.readyState !== o.CLOSED || d.recovery.reconnecting() || d.open();
    }, 0))));
  });
  d.on("end", function () {
    f && (d = null, g ? v && t.connect(c, v) : (h = !1, t.disconnect("SOCKET_LOST")));
  });
  d.on("reconnect scheduled", function (e) {
    if (p = null, s.isFeatureOn("decoRecoResend")) {
      var n = h && d.socket && d.socket.writeBuffer;
      n && n.length && (p = n, m = Date.now() + y);
    }
    t.emit("reconnecting", e.attempt, i);
  });
  d.on("data", function (e) {
    if (!_) {
      if (r.receiving(), "SequenceStartMessage" === e._messageType && (T += 1), T > 0) {
        if (M.push(e), "SequenceEndMessage" === e._messageType && (T -= 1, T <= 0)) {
          var i = {
            _messageType: "messageSequence",
            sequence: M
          };
          I ? C.push(i) : t.emit("messageSequence", i);
          M = [];
          T = 0;
        }
      } else {
        t.emit("data", e);
        b[e._messageType] || (t.lastReceivedMessage = e._messageType);
        I ? C.push(e) : n(e);
      }
    }
  });
  d.on("error", function (e) {
    t.emit("error", e);
  });
  d.open();
};
t.close = function () {
  g = !0;
  h = !1;
  p = null;
  d && (d.destroy(), d = null);
};
t.switchToGame = function (e) {
  t.disconnect("SWITCHING_TO_GAME");
  v = e;
};
t.disconnect = function (e) {
  _ || (e = e || "CLIENT_CLOSING", console.info("connectionManager.disconnect: reason=" + e), "SOCKET_LOST" !== e && d && (t.send("disconnecting", e), g = !0), "SWITCHING_TO_GAME" !== e && (_ = !0, t.close(), t.emit("disconnect", e)));
};
t.sendMessage = function (e, i) {
  t.send("sendMessage", {
    type: e,
    data: i
  });
};
t.send = function (e, i) {
  if (!d) {
    return console.warn("Client trying to send while primus is null for call: " + e);
  }
  r.sending(e, i);
  var n = {
    call: e,
    data: i
  };
  d.write(n);
  t.emit("send", {
    call: e,
    data: n
  });
  t.emit("send:" + e, n);
};
o(e);
C.length = 0;
g = !1;
_ = !1;
v = null;
h = !0;
u = !1;
f = !0;
d = new o(i, {
  manual: !0,
  strategy: "disconnect,timeout",
  reconnect: {
    max: 5e3,
    min: 500,
    retries: a
  }
});
r.startListening();
d.on("open", function () {
  if (d !== this) {
    return console.warn("onOpen - Ignoring event: possible missing call to Primus#destroy");
  }
  if (g = !1, t.emit("open", u), u && p && Date.now() < m) {
    for (var e = {}, i = 0, n = {}, o = 0; o < p.length; o++) {
      var a = p[o];
      if ("message" === a.type) {
        try {
          var s = JSON.parse(a.data);
          if ("sendMessage" !== s.call) {
            n["call-" + s.call] = 1;
            continue;
          }
          var r = s.data.type;
          if (w[r]) {
            continue;
          }
          i++;
          e[r] = 1;
        } catch (l) {
          console.error("Message to be resent is not JSON: " + a.data.toString().substring(0, 100));
        }
        d.socket.write(a.data, a.options);
      } else {
        n[a.type] = 1;
      }
    }
    i && console.error("Resent " + p.length + " previously unsent messages. Types: {" + Object.keys(e).join(",") + "} Skipped: {" + Object.keys(n).join(",") + "}");
  }
  p = null;
  u = !0;
});
d.on("offline", function () {
  f && (f = !1, h && t.emit("offline"));
});
d.on("online", function () {
  return d !== this ? console.warn("onOnline - Ignoring event: possible missing call to Primus#destroy") : void (f || (f = !0, h && (t.emit("online"), d.readyState !== o.CLOSED || d.recovery.reconnecting() || window.setTimeout(function () {
    d.readyState !== o.CLOSED || d.recovery.reconnecting() || d.open();
  }, 0))));
});
d.on("end", function () {
  f && (d = null, g ? v && t.connect(c, v) : (h = !1, t.disconnect("SOCKET_LOST")));
});
d.on("reconnect scheduled", function (e) {
  if (p = null, s.isFeatureOn("decoRecoResend")) {
    var n = h && d.socket && d.socket.writeBuffer;
    n && n.length && (p = n, m = Date.now() + y);
  }
  t.emit("reconnecting", e.attempt, i);
});
d.on("data", function (e) {
  if (!_) {
    if (r.receiving(), "SequenceStartMessage" === e._messageType && (T += 1), T > 0) {
      if (M.push(e), "SequenceEndMessage" === e._messageType && (T -= 1, T <= 0)) {
        var i = {
          _messageType: "messageSequence",
          sequence: M
        };
        I ? C.push(i) : t.emit("messageSequence", i);
        M = [];
        T = 0;
      }
    } else {
      t.emit("data", e);
      b[e._messageType] || (t.lastReceivedMessage = e._messageType);
      I ? C.push(e) : n(e);
    }
  }
});
d.on("error", function (e) {
  t.emit("error", e);
});
d.open();
i++;
e[r] = 1;
p = null;
u = !0;
I ? C.push(i) : t.emit("messageSequence", i);
M = [];
T = 0;
t.emit("data", e);
b[e._messageType] || (t.lastReceivedMessage = e._messageType);
I ? C.push(e) : n(e);
g = !0;
h = !1;
p = null;
d && (d.destroy(), d = null);
t.disconnect("SWITCHING_TO_GAME");
v = e;
d.write(n);
t.emit("send", {
  call: e,
  data: n
});
t.emit("send:" + e, n);
this.lastReceivingTime = 0;
this.lastPingSent = 0;
this.isListening = !1;
this.timeout = null;
this.alarmLevel = c;
e.timeout = null;
e._sendPing();
t.monitor = new n();
t.WARNING = d;
t.BLOCKING = u;
n.prototype.startListening = function () {
  if (!this.isListening) {
    var e = this;
    this._connectionLatency = new a(window.dofus.connectionManager);
    this._connectionLatency.startListening();
    this.isListening = !0;
    window.dofus.connectionManager.on("BasicPongMessage", this._gotPong.bind(this));
    window.gui.on("connected", function () {
      e._connectionLatency.startPingLoop();
    });
    window.gui.on("appLeaveBackground", function () {
      e._connectionLatency.startPingLoop();
    });
    window.gui.on("disconnect", function () {
      e._connectionLatency.stopPingLoop();
    });
    window.gui.on("appGoBackground", function () {
      e._connectionLatency.stopPingLoop();
    });
  }
};
n.prototype.receiving = function () {
  this.lastReceivingTime = Date.now();
  this._connectionLatency.startPingLoop();
  this.timeout && (this.alarmLevel = c, this.timeout = window.clearTimeout(this.timeout));
};
n.prototype.sending = function (e, t) {
  var i;
  i = "sendMessage" === e ? h[t.type] : p[e];
  i && this._monitorCommandDelay(i);
  this._connectionLatency.startPingLoop();
};
n.prototype._monitorCommandDelay = function (e) {
  this.alarmLevel = Math.max(e, this.alarmLevel);
  this.timeout || (this.timeout = window.setTimeout(o, s, this));
};
n.prototype._sendPing = function () {
  Date.now() - this.lastPingSent >= l && (this._connectionLatency.sendPing(), this.lastPingSent = Date.now());
};
n.prototype._gotPong = function () {
  this.lastPingSent = 0;
  window.gui.connectionSplashScreen.onStateChange("CONNECTED");
};
this._connectionLatency = new a(window.dofus.connectionManager);
this._connectionLatency.startListening();
this.isListening = !0;
window.dofus.connectionManager.on("BasicPongMessage", this._gotPong.bind(this));
window.gui.on("connected", function () {
  e._connectionLatency.startPingLoop();
});
window.gui.on("appLeaveBackground", function () {
  e._connectionLatency.startPingLoop();
});
window.gui.on("disconnect", function () {
  e._connectionLatency.stopPingLoop();
});
window.gui.on("appGoBackground", function () {
  e._connectionLatency.stopPingLoop();
});
this.lastReceivingTime = Date.now();
this._connectionLatency.startPingLoop();
this.timeout && (this.alarmLevel = c, this.timeout = window.clearTimeout(this.timeout));
i = "sendMessage" === e ? h[t.type] : p[e];
i && this._monitorCommandDelay(i);
this._connectionLatency.startPingLoop();
this.alarmLevel = Math.max(e, this.alarmLevel);
this.timeout || (this.timeout = window.setTimeout(o, s, this));
this.lastPingSent = 0;
window.gui.connectionSplashScreen.onStateChange("CONNECTED");
this._connectionManager = e;
this._pingLoopTimeout = null;
this._isListening = !1;
this._latencyBuffer = [];
this._lastPingSent = 0;
e.exports = i;
i.prototype._getLatencyAvg = function () {
  var e = 0;
  if (0 === this._latencyBuffer.length) {
    return e;
  }
  for (var t = 0; t < this._latencyBuffer.length; t += 1) {
    e += this._latencyBuffer[t];
  }
  return Math.round(e / this._getLatencySamplesCount());
};
i.prototype._getLatencySamplesCount = function () {
  return this._latencyBuffer.length;
};
i.prototype._getLatencySamplesMax = function () {
  return o;
};
i.prototype._addSample = function () {
  if (this._lastPingSent) {
    var e = Date.now() - this._lastPingSent;
    this._lastPingSent = 0;
    this.startPingLoop();
    this._latencyBuffer.push(e);
    this._getLatencySamplesCount() > o && this._latencyBuffer.shift();
  }
};
i.prototype.startListening = function () {
  if (!this._isListening) {
    this._isListening = !0;
    var e = this;
    this._connectionManager.on("BasicLatencyStatsRequestMessage", function () {
      e._connectionManager.sendMessage("BasicLatencyStatsMessage", {
        latency: e._getLatencyAvg(),
        sampleCount: e._getLatencySamplesCount(),
        max: e._getLatencySamplesMax()
      });
    });
    this._connectionManager.on("BasicPongMessage", function () {
      e._addSample();
    });
  }
};
i.prototype.startPingLoop = function () {
  if (!this._pingLoopTimeout) {
    var e = this;
    this._pingLoopTimeout = window.setTimeout(function () {
      e.sendPing();
      e.stopPingLoop();
    }, n);
  }
};
i.prototype.stopPingLoop = function () {
  clearTimeout(this._pingLoopTimeout);
  this._pingLoopTimeout = 0;
  this._lastPingSent = 0;
};
i.prototype.sendPing = function () {
  this._connectionManager.sendMessage("BasicPingMessage", {
    quiet: !0
  });
  this._lastPingSent = Date.now();
};
this._lastPingSent = 0;
this.startPingLoop();
this._latencyBuffer.push(e);
this._getLatencySamplesCount() > o && this._latencyBuffer.shift();
this._connectionManager.on("BasicLatencyStatsRequestMessage", function () {
  e._connectionManager.sendMessage("BasicLatencyStatsMessage", {
    latency: e._getLatencyAvg(),
    sampleCount: e._getLatencySamplesCount(),
    max: e._getLatencySamplesMax()
  });
});
this._connectionManager.on("BasicPongMessage", function () {
  e._addSample();
});
e.sendPing();
e.stopPingLoop();
clearTimeout(this._pingLoopTimeout);
this._pingLoopTimeout = 0;
this._lastPingSent = 0;
this._connectionManager.sendMessage("BasicPingMessage", {
  quiet: !0
});
this._lastPingSent = Date.now();
this._type = "CharacterCharacteristicsInformations";
r = e;
this.alignmentInfos = t.alignmentInfos;
this.agility = new o(t.agility);
this.chance = new o(t.chance);
this.intelligence = new o(t.intelligence);
this.strength = new o(t.strength);
this.wisdom = new o(t.wisdom);
this.actionPoints = new o(t.actionPoints);
this.airDamageBonus = new o(t.airDamageBonus);
this.airElementReduction = new o(t.airElementReduction);
this.airElementResistPercent = new o(t.airElementResistPercent);
this.allDamagesBonus = new o(t.allDamagesBonus);
this.criticalDamageBonus = new o(t.criticalDamageBonus);
this.criticalDamageReduction = new o(t.criticalDamageReduction);
this.criticalHit = new o(t.criticalHit);
this.criticalHitWeapon = new o(t.criticalHitWeapon);
this.criticalMiss = new o(t.criticalMiss);
this.damagesBonusPercent = new o(t.damagesBonusPercent);
this.dodgePALostProbability = new o(t.dodgePALostProbability);
this.dodgePMLostProbability = new o(t.dodgePMLostProbability);
this.earthDamageBonus = new o(t.earthDamageBonus);
this.earthElementReduction = new o(t.earthElementReduction);
this.earthElementResistPercent = new o(t.earthElementResistPercent);
this.fireDamageBonus = new o(t.fireDamageBonus);
this.fireElementReduction = new o(t.fireElementReduction);
this.fireElementResistPercent = new o(t.fireElementResistPercent);
this.healBonus = new o(t.healBonus);
this.initiative = new o(t.initiative);
this.movementPoints = new o(t.movementPoints);
this.neutralDamageBonus = new o(t.neutralDamageBonus);
this.neutralElementReduction = new o(t.neutralElementReduction);
this.neutralElementResistPercent = new o(t.neutralElementResistPercent);
this.PAAttack = new o(t.PAAttack);
this.permanentDamagePercent = new o(t.permanentDamagePercent);
this.PMAttack = new o(t.PMAttack);
this.probationTime = new o(t.probationTime);
this.prospecting = new o(t.prospecting);
this.pushDamageBonus = new o(t.pushDamageBonus);
this.pushDamageReduction = new o(t.pushDamageReduction);
this.pvpAirElementReduction = new o(t.pvpAirElementReduction);
this.pvpAirElementResistPercent = new o(t.pvpAirElementResistPercent);
this.pvpEarthElementReduction = new o(t.pvpEarthElementReduction);
this.pvpEarthElementResistPercent = new o(t.pvpEarthElementResistPercent);
this.pvpFireElementReduction = new o(t.pvpFireElementReduction);
this.pvpFireElementResistPercent = new o(t.pvpFireElementResistPercent);
this.pvpNeutralElementReduction = new o(t.pvpNeutralElementReduction);
this.pvpNeutralElementResistPercent = new o(t.pvpNeutralElementResistPercent);
this.pvpWaterElementReduction = new o(t.pvpWaterElementReduction);
this.pvpWaterElementResistPercent = new o(t.pvpWaterElementResistPercent);
this.range = new o(t.range);
this.reflect = new o(t.reflect);
this.summonableCreaturesBoost = new o(t.summonableCreaturesBoost);
this.summonableMaximumBombs = new o(t.summonableMaximumBombs);
this.tackleBlock = new o(t.tackleBlock);
this.tackleEvade = new o(t.tackleEvade);
this.trapBonus = new o(t.trapBonus);
this.trapBonusPercent = new o(t.trapBonusPercent);
this.vitality = new o(t.vitality);
this.waterDamageBonus = new o(t.waterDamageBonus);
this.waterElementReduction = new o(t.waterElementReduction);
this.waterElementResistPercent = new o(t.waterElementResistPercent);
this.weaponDamagesBonusPercent = new o(t.weaponDamagesBonusPercent);
this.dealtDamageMultiplierMelee = new o(t.dealtDamageMultiplierMelee);
this.receivedDamageMultiplierMelee = new o(t.receivedDamageMultiplierMelee);
this.dealtDamageMultiplierDistance = new o(t.dealtDamageMultiplierDistance);
this.receivedDamageMultiplierDistance = new o(t.receivedDamageMultiplierDistance);
this.dealtDamageMultiplierWeapon = new o(t.dealtDamageMultiplierWeapon);
this.receivedDamageMultiplierWeapon = new o(t.receivedDamageMultiplierWeapon);
this.dealtDamageMultiplierSpells = new o(t.dealtDamageMultiplierSpells);
this.receivedDamageMultiplierSpells = new o(t.receivedDamageMultiplierSpells);
this.spellModifications = [];
e.exports = n;
n.prototype.getRemainingAdditionalPts = function () {
  if (this.additionnalPoints <= 0) {
    return 0;
  }
  for (var e = !1, t = 0; t < l.length; t += 1) {
    var i = l[t],
      n = this[i];
    if (n) {
      if (n.getAdditionalPts() < s.MAX_ADDITIONNAL_PER_CARAC) {
        e = !0;
        break;
      }
    } else {
      r.error("stat missing for", i);
    }
  }
  return e ? this.additionnalPoints : 0;
};
this._type = "CharacterBaseCharacteristic";
this._base = 0;
this._objectsAndMountBonus = 0;
this._alignGiftBonus = 0;
this._contextModif = 0;
this._additionnal = 0;
e && this.setPts(e);
e.exports = i;
i.prototype.setPts = function (e) {
  void 0 !== e.base && (this._base = e.base || 0);
  void 0 !== e.objectsAndMountBonus && (this._objectsAndMountBonus = e.objectsAndMountBonus || 0);
  void 0 !== e.alignGiftBonus && (this._alignGiftBonus = e.alignGiftBonus || 0);
  void 0 !== e.contextModif && (this._contextModif = e.contextModif || 0);
  void 0 !== e.additionnal && (this._additionnal = e.additionnal || 0);
};
i.prototype.getContextModif = function () {
  return this._contextModif || 0;
};
i.prototype.getBasePts = function () {
  return (this._base || 0) + (this._additionnal || 0);
};
i.prototype.getBaseWithoutAdditionalPts = function () {
  return this._base || 0;
};
i.prototype.getEquipmentPts = function () {
  return this._objectsAndMountBonus || 0;
};
i.prototype.getAlignGiftPts = function () {
  return this._alignGiftBonus || 0;
};
i.prototype.getAdditionalPts = function () {
  return this._additionnal || 0;
};
i.prototype.getAllValues = function () {
  return {
    base: this.getBaseWithoutAdditionalPts(),
    objectsAndMountBonus: this.getEquipmentPts(),
    alignGiftBonus: this.getAlignGiftPts(),
    contextModif: this.getContextModif(),
    additionnal: this.getAdditionalPts()
  };
};
i.prototype.getBonusPts = function () {
  return (this._alignGiftBonus || 0) + (this._contextModif || 0);
};
i.prototype.getTotalStat = function () {
  return this.getBasePts() + this.getEquipmentPts() + this.getBonusPts();
};
void 0 !== e.base && (this._base = e.base || 0);
void 0 !== e.objectsAndMountBonus && (this._objectsAndMountBonus = e.objectsAndMountBonus || 0);
void 0 !== e.alignGiftBonus && (this._alignGiftBonus = e.alignGiftBonus || 0);
void 0 !== e.contextModif && (this._contextModif = e.contextModif || 0);
void 0 !== e.additionnal && (this._additionnal = e.additionnal || 0);
e = e || {};
this._type = "CharacterSpellModification";
this.spellId = e.spellId || 0;
this.modificationType = e.modificationType || 0;
this.value = new o(e.value);
e.exports = i;
i.prototype.getNickname = function () {
  return this._nickname;
};
i.prototype.getToken = function () {
  return this._token;
};
i.prototype.toString = function () {
  var e = this.getNickname();
  return this.getToken() && (e += n + this.getToken()), e;
};
i.prototype.getForDisplay = function () {
  return this._isOffi ? this.getNickname() + n + o : this.toString();
};
o(n, a);
e.exports = n;
r.length > 50 && (console.error("The stackEvent exceed 50 events, the stack is trash"), r = []);
i.override && r.forEach(function (t, i) {
  e === t.name && r.splice(i, 1);
});
r.push({
  name: e,
  data: t,
  options: i
});
t.init = function (e, t) {
  e = e || {};
  a.init(e, t);
  i(123);
};
t.register = function (e) {
  a.register(e);
  l = !0;
  o();
};
t.unregister = function () {
  l = !1;
  a.unregister();
};
t.log = function (e, t, i) {
  return t = t || {}, i = i || {}, l ? (i.withPlayerInfo !== !1 && s.addCharacterInfo(t), i.withEquipment && s.addEquippedItem(t, window.gui.playerData), void a.send(e, t)) : void n(e, t, i);
};
e = e || {};
a.init(e, t);
i(123);
a.register(e);
l = !0;
o();
l = !1;
a.unregister();
t.init = function (e, t) {
  c = window.dofus.logger;
  d = t;
  e && (e.debug && (h = !0), e.analog && (u = !0), f = !0);
};
t.register = function (e) {
  f && (m = e || -1);
};
t.unregister = function () {
  m = -1;
};
t.send = function (e, t) {
  if (f) {
    t = t || {};
    t.date && c.error(new Error("Do not use the date."));
    var i = n(e);
    window.developmentMode && h && o(e, t);
    var a = r(l.now(), "yyyy-mm-dd'T'HH:MM:ssp"),
      s = {
        game_id: p,
        event_id: i,
        session_id: m,
        date: a,
        data: t
      };
    u && c.info("ankAnalytics.send: " + e, JSON.stringify(s));
    d.sendKPIEvent(m, i, a, t);
  }
};
c = window.dofus.logger;
d = t;
e && (e.debug && (h = !0), e.analog && (u = !0), f = !0);
t = t || {};
t.date && c.error(new Error("Do not use the date."));
u && c.info("ankAnalytics.send: " + e, JSON.stringify(s));
d.sendKPIEvent(m, i, a, t);
r.masks = {
  "default": "ddd mmm dd yyyy HH:MM:ss",
  shortDate: "m/d/yy",
  paddedShortDate: "mm/dd/yyyy",
  mediumDate: "mmm d, yyyy",
  longDate: "mmmm d, yyyy",
  fullDate: "dddd, mmmm d, yyyy",
  shortTime: "h:MM TT",
  mediumTime: "h:MM:ss TT",
  longTime: "h:MM:ss TT Z",
  isoDate: "yyyy-mm-dd",
  isoTime: "HH:MM:ss",
  isoDateTime: "yyyy-mm-dd'T'HH:MM:sso",
  isoUtcDateTime: "UTC:yyyy-mm-dd'T'HH:MM:ss'Z'",
  expiresHeaderFormat: "ddd, dd mmm yyyy HH:MM:ss Z"
};
r.i18n = {
  dayNames: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
  monthNames: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
  timeNames: ["a", "p", "am", "pm", "A", "P", "AM", "PM"]
};
o = function () {
  return r;
}.call(t, i, t, e);
!(void 0 !== o && (e.exports = o));
t.addEquippedItem = function (e, t) {
  var n = t.inventory.equippedItems;
  for (var o in i) {
    var a = n[o],
      s = i[o];
    if (a) {
      if (a.getProperty) {
        e[s] = a.getProperty("objectGID");
      } else {
        var r = "analytics#addEquippedItem: getProperty is not a function. posId: " + o + ", itemName: ";
        r += s + ", objectGID: " + a.objectGID + ", id: " + a.id;
        console.error(new Error(r));
        e[s] = void 0;
      }
    } else {
      e[s] = void 0;
    }
  }
  e.comp_id = void 0;
  var l = t.equippedMount;
  t.isRiding && l && l.model ? e.ride_id = l.model : e.ride_id = void 0;
};
t.addCharacterInfo = function (e) {
  if (window.gui.playerData) {
    var t = window.gui.playerData,
      i = t.characterBaseInformations || {},
      n = t.position || {};
    e.server_id = window.gui.serversData.connectedServerId;
    e.character_id = t.id;
    e.character_level = i.level;
    e.soft_currency_balance = t.inventory.kamas;
    e.hard_currency_balance = t.inventory.goultines;
    e.breed = i.breed;
    e.map_id = n.mapId;
  }
};
r += s + ", objectGID: " + a.objectGID + ", id: " + a.id;
console.error(new Error(r));
e[s] = void 0;
e.server_id = window.gui.serversData.connectedServerId;
e.character_id = t.id;
e.character_level = i.level;
e.soft_currency_balance = t.inventory.kamas;
e.hard_currency_balance = t.inventory.goultines;
e.breed = i.breed;
e.map_id = n.mapId;
d = !1;
h = e.login;
r.logIn();
a.log("Session_Info.Login", {
  account_session_id: h
});
window.gui.on("disconnect", function () {
  a.unregister();
  p = 0;
  m = !1;
  f = !1;
});
window.gui.on("initialized", function () {
  c.initFightEvents(window.gui.fightManager);
});
l.on("NicknameAcceptedMessage", function () {
  a.log("F_T_U_E.Step0000_Chose_Nickname");
});
l.on("ServersListMessage", function (e) {
  for (var t = 0, i = e.servers || [], n = 0, o = i.length; n < o; n += 1) {
    var a = i[n];
    t += a.charactersCount;
  }
  d = !t;
});
l.on("IdentificationSuccessMessage", n);
l.on("IdentificationSuccessWithLoginTokenMessage", n);
l.on("SelectedServerDataMessage", function (e) {
  a.log("Session_Info.Choose_Server", {
    account_session_id: h
  });
  d && a.log("F_T_U_E.Step0100_Chose_Server", {
    server_id: e.serverId
  });
});
l.on("CharacterCreationResultMessage", function (e) {
  d && e.result === s.OK && a.log("F_T_U_E.Step0200_Create_First_Character");
});
window.gui.playerData.on("characterSelectedSuccess", function () {
  u = window.gui.playerData.characterBaseInformations.level;
  m = !0;
  o();
  a.log("Session_Info.Choose_Character");
});
l.on("ServerKpiSessionStartedMessage", function (e) {
  p = e.kpiSessionId;
  o();
});
l.on("CharacterLevelUpMessage", function (e) {
  a.log("User_Life_Cycle.Level_Up", {
    old_level: u
  });
  r.trackLevelGrowth(u, e.newLevel);
  u = e.newLevel;
});
l.on("AchievementFinishedMessage", function (e) {
  a.log("User_Life_Cycle.Achievement_Achieved", {
    achievement_id: e.id
  });
});
l.on("AchievementRewardSuccessMessage", function (e) {
  a.log("User_Life_Cycle.Achievement_Get_Reward", {
    achievement_id: e.achievementId
  });
});
window.gui.playerData.quests.on("questStarted", function (e) {
  a.log("User_Life_Cycle.Quest_Start", {
    quest_id: e
  });
});
window.gui.playerData.quests.on("QuestFinished", function (e) {
  a.log("User_Life_Cycle.Quest_End", {
    quest_id: e
  });
});
window.gui.playerData.quests.on("DQStarted", function (e) {
  a.log("User_Life_Cycle.daily_quest_start", {
    quest_id: e
  });
});
window.gui.playerData.quests.on("mainDQStarted", function (e) {
  a.log("User_Life_Cycle.daily_quest_start", {
    quest_id: e
  });
});
window.gui.playerData.quests.on("DQFinished", function (e) {
  a.log("User_Life_Cycle.daily_quest_end", {
    quest_id: e
  });
});
l.on("QuestObjectiveValidatedMessage", function (e) {
  var t = window.gui.playerData.quests.all[e.questId] || {},
    i = t.stepId || 0;
  a.log("User_Life_Cycle.Quest_Step_Objective_Success", {
    quest_id: e.questId,
    objective_id: e.objectiveId,
    step_id: i
  });
});
l.on("QuestStepValidatedMessage", function (e) {
  a.log("User_Life_Cycle.Quest_Step_Success", {
    quest_id: e.questId,
    step_id: e.stepId
  });
});
l.on("DungeonEnteredMessage", function (e) {
  a.log("User_Life_Cycle.Donjon_Start", {
    dungeon_id: e.dungeonId
  });
});
l.on("JobLevelUpMessage", function (e) {
  a.log("User_Life_Cycle.Profession_Level_Up", {
    job_id: e.jobsDescription.jobId,
    new_level: e.newLevel
  });
});
l.on("GameRolePlayPlayerLifeStatusMessage", function (e) {
  e.state > 0 && a.log("User_Life_Cycle.Death");
});
l.on("PartyJoinMessage", function (e) {
  a.log("social.fight_group_join", {
    group_id: e.partyId
  });
});
l.on("PartyDeletedMessage", function (e) {
  a.log("social.fight_group_quit", {
    group_id: e.partyId
  });
});
l.on("PartyLeaveMessage", function (e) {
  a.log("social.fight_group_quit", {
    group_id: e.partyId
  });
});
l.on("PartyKickedByMessage", function (e) {
  a.log("social.fight_group_quit", {
    group_id: e.partyId
  });
});
a.unregister();
p = 0;
m = !1;
f = !1;
a.log("Session_Info.Choose_Server", {
  account_session_id: h
});
d && a.log("F_T_U_E.Step0100_Chose_Server", {
  server_id: e.serverId
});
u = window.gui.playerData.characterBaseInformations.level;
m = !0;
o();
a.log("Session_Info.Choose_Character");
p = e.kpiSessionId;
o();
a.log("User_Life_Cycle.Level_Up", {
  old_level: u
});
r.trackLevelGrowth(u, e.newLevel);
u = e.newLevel;
l.on("GuildMembershipMessage", function (e) {
  g = e.guildInfo.guildId;
});
l.on("GuildJoinedMessage", function (e) {
  g = e.guildInfo.guildId;
  a.log("social.guild_join", {
    guild_id: g
  });
});
l.on("GuildLeftMessage", function () {
  a.log("social.guild_quit", {
    guild_id: g
  });
});
g = e.guildInfo.guildId;
a.log("social.guild_join", {
  guild_id: g
});
t.trackIAPBought = function (e, t, i, o) {
  switch (e) {
    case "com.ankama.dofustouch.starterpack":
    case "com.ankama.dofustouchnext.starterpack":
      n("6re6in", {
        revenue: {
          price: t,
          currency: i
        },
        transactionId: o
      });
      break;
    default:
      n("m38gxs", {
        revenue: {
          price: t,
          currency: i
        },
        transactionId: o
      });
  }
};
t.trackLevelGrowth = function (e, t) {
  for (var i in d) {
    var o = ~~i,
      a = d[i];
    e < o && t >= o && n(a);
  }
};
t.trackJoinGuild = function () {
  n("scgd8m");
};
t.trackJoinGroup = function () {
  n("bg9eww");
};
t.trackAddFriend = function () {
  n("gaquy8");
};
t.trackBonusPack = function () {
  n("85vyax");
};
t.characterCreation = function () {
  n("xidrfp");
};
t.logIn = function () {
  n("fqg6wn");
};
t.landedAstrub = function () {
  n("os77oz");
};
t.appOpen = function () {
  n("83t7fq");
};
s = i;
r = n;
l = a;
u.setLogLevel(h);
s.create(u);
o();
c = !0;
t.initialize = a;
t.trackIAPBought = i;
t.trackLevelGrowth = i;
t.trackJoinGuild = i;
t.trackJoinGroup = i;
t.trackAddFriend = i;
t.trackBonusPack = i;
t.characterCreation = i;
t.logIn = i;
t.landedAstrub = i;
t.appOpen = i;
this._monsterMap = {};
this._isSpectator = !1;
this._currentFightId = null;
this._teamHPMap = {
  0: {},
  1: {}
};
e.on("GameFightJoinMessage", function (e) {
  return e.isSpectator ? void (t._isSpectator = !0) : (t._monsterMap = {}, t._isSpectator = !1, void (t._currentFightId = null));
});
e.on("GameFightTurnReadyRequestMessage", function () {
  if (!t._isSpectator) {
    var e = t._fightManager.getAvailableFighters();
    for (var i in e) {
      t._updateMonsterLife(e[i]);
    }
  }
});
e.on("messageSequence", function (e) {
  null === t._currentFightId && (t._currentFightId = t._fightManager.fightId);
  for (var i = 0; i < e.sequence.length; i += 1) {
    t._logSpellCast(e.sequence[i]);
  }
});
e.on("GameActionFightSpellCastMessage", function (e) {
  t._logSpellCast(e);
});
e.on("GameActionFightCloseCombatMessage", function (e) {
  t._logSpellCast(e);
});
e.on("GameFightShowFighterMessage", function (e) {
  if (!t._isSpectator) {
    var i = e.informations;
    t._addTeamHP(i.teamId, i.contextualId, i.stats.lifePoints);
    t._addMonster(i);
  }
});
e.on("GameFightRemoveTeamMemberMessage", function (e) {
  t._isSpectator || t._removeTeamHP(e.teamId, e.charId);
});
e.on("GameFightStartMessage", function () {
  t._isSpectator || (t._currentFightId = t._fightManager.fightId, a.log("Fight_Report.Fight_Start", {
    fight_id: t._currentFightId,
    fight_type: t._fightManager.fightType,
    team_0_hp: n(t._teamHPMap[0]),
    team_1_hp: n(t._teamHPMap[1])
  }, {
    noSessionId: !0
  }), t._sendMonsterReport(), t._sendCharacterReport());
});
e.on("GameFightEndMessage", function (e) {
  if (!t._isSpectator) {
    t._sendAliveMonsterReport(e);
    var i = t._getWinnerTeamId(e);
    a.log("Fight_Report.Fight_End", {
      nb_turns: t._fightManager.getTurnCount() + 1,
      fight_id: t._currentFightId,
      time_spent_on_action: ~~(e.duration / 1e3),
      tactical_used: t._fightManager.wasTacticalUsed(),
      winner_team_id: i
    }, {
      noSessionId: !0
    });
    t._teamHPMap = {
      0: {},
      1: {}
    };
    t._monsterMap = {};
    t._isSpectator = !1;
    t._currentFightId = null;
    t._fightManager.resetTacticInfo();
  }
});
t._addTeamHP(i.teamId, i.contextualId, i.stats.lifePoints);
t._addMonster(i);
a.log("Fight_Report.Fight_End", {
  nb_turns: t._fightManager.getTurnCount() + 1,
  fight_id: t._currentFightId,
  time_spent_on_action: ~~(e.duration / 1e3),
  tactical_used: t._fightManager.wasTacticalUsed(),
  winner_team_id: i
}, {
  noSessionId: !0
});
t._teamHPMap = {
  0: {},
  1: {}
};
t._monsterMap = {};
t._isSpectator = !1;
t._currentFightId = null;
t._fightManager.resetTacticInfo();
e.exports = function (e) {
  return new o(e);
};
o.prototype.initFightEvents = function (e) {
  this._fightManager = e;
};
o.prototype._addMonster = function (e) {
  if (!(e.contextualId >= 0)) {
    var t = {};
    this._monsterMap[e.contextualId] = t;
    t.monster_id = e.creatureGenericId;
    t.monster_level = e.monsterLevel;
    t.monster_grade = e.creatureGrade;
    t.team_id = e.teamId;
  }
};
o.prototype._updateMonsterLife = function (e) {
  if (!(e.id >= 0)) {
    var t = this._monsterMap[e.id];
    t || (t = this._monsterMap[e.id] = {});
    var i = e.data.stats;
    t.ratio_life_remaining = Math.ceil(100 * i.lifePoints / i.maxLifePoints) / 100;
    1 === t.ratio_life_remaining && i.lifePoints !== i.maxLifePoints && (t.ratio_life_remaining = .99);
  }
};
o.prototype._sendAliveMonsterReport = function (e) {
  for (var t = 0; t < e.results.length; t += 1) {
    var i = e.results[t];
    if (i.alive && !(i.id >= 0)) {
      var n = this._monsterMap[i.id];
      if (!n) {
        return;
      }
      void 0 === n.ratio_life_remaining && (n.ratio_life_remaining = 1);
      a.log("fight_report.fight_end_alive_monster_description", {
        fight_id: this._currentFightId,
        team_id: n.team_id,
        monster_id: n.monster_id,
        monster_level: n.monster_level,
        monster_grade: n.monster_grade,
        ratio_life_remaining: n.ratio_life_remaining
      }, {
        noSessionId: !0
      });
    }
  }
};
o.prototype._sendMonsterReport = function () {
  for (var e in this._monsterMap) {
    var t = this._monsterMap[e];
    a.log("Fight_Report.Fight_Monster_Description", {
      fight_id: this._currentFightId,
      team_id: t.team_id,
      monster_id: t.monster_id,
      monster_level: t.monster_level,
      monster_grade: t.monster_grade
    }, {
      noSessionId: !0
    });
  }
};
o.prototype._sendCharacterReport = function () {
  var e = s(),
    t = this._fightManager.getAvailableFighters(),
    i = t[e.gui.playerData.id];
  i && a.log("Fight_Report.Fight_Character_Description", {
    fight_id: this._currentFightId,
    is_incarnation: e.gui.playerData.isIncarnation(),
    team_id: i.data.teamId
  }, {
    withEquipment: !0
  });
};
o.prototype._logSpellCast = function (e) {
  if (!this._isSpectator) {
    var t = s(),
      i = t.gui.playerData.id,
      n = "GameActionFightSpellCastMessage" === e._messageType || "GameActionFightCloseCombatMessage" === e._messageType;
    if (n && e.sourceId === i) {
      var o = e.spellId ? e.spellId : 0,
        r = e.spellLevel ? e.spellLevel : 1;
      a.log("Fight_Action.Spell_Cast_By_User", {
        spell_id: o,
        spell_level: r,
        fight_id: this._currentFightId,
        breed_id: t.gui.playerData.characterBreed.id
      });
    }
  }
};
o.prototype._addTeamHP = function (e, t, i) {
  0 !== e && 1 !== e || (this._teamHPMap[e][t] = i);
};
o.prototype._removeTeamHP = function (e, t) {
  0 !== e && 1 !== e || (this._teamHPMap[e][t] = 0);
};
o.prototype._getWinnerTeamId = function (e) {
  for (var t = null, i = 0, n = e.results.length; i < n; i += 1) {
    var o = e.results[i];
    if (o.alive) {
      t = o.id;
      break;
    }
  }
  return this._teamHPMap[0][t] ? 0 : this._teamHPMap[1][t] ? 1 : -1;
};
this._monsterMap[e.contextualId] = t;
t.monster_id = e.creatureGenericId;
t.monster_level = e.monsterLevel;
t.monster_grade = e.creatureGrade;
t.team_id = e.teamId;
t.ratio_life_remaining = Math.ceil(100 * i.lifePoints / i.maxLifePoints) / 100;
1 === t.ratio_life_remaining && i.lifePoints !== i.maxLifePoints && (t.ratio_life_remaining = .99);
void 0 === n.ratio_life_remaining && (n.ratio_life_remaining = 1);
a.log("fight_report.fight_end_alive_monster_description", {
  fight_id: this._currentFightId,
  team_id: n.team_id,
  monster_id: n.monster_id,
  monster_level: n.monster_level,
  monster_grade: n.monster_grade,
  ratio_life_remaining: n.ratio_life_remaining
}, {
  noSessionId: !0
});
t.initialize = function (e) {
  y = e.dataUrl;
};
t.initializeDiskCache = n;
t.eraseDiskCache = function (e) {
  for (var t = window.Config.serverLanguages, i = [], n = 0; n < t.length; n++) {
    i.push(t[n]);
    i.push(p.BETA_SUFFIX + t[n]);
  }
  m.eachSeries(i, function (e, t) {
    return g["delete"](e + f.cacheDatabaseSuffix, t);
  }, e);
};
t.changeLanguage = function (e) {
  w = e;
};
t.initializeDictionariesAndDiskCache = function (e, t, i) {
  u = null;
  h = null;
  var a = [];
  w = null;
  m.series([function (i) {
    return e === t ? i() : void o("dictionary", {
      lang: e
    }, function (e, t) {
      e ? a.push(e) : u = t;
      i();
    });
  }, function (e) {
    o("dictionary", {
      lang: t
    }, function (t, i) {
      t ? a.push(t) : h = i;
      e();
    });
  }], function () {
    var o = a.join(", ");
    return u || h ? (o && console.error("Failed getting dictionaries: " + o), u ? w = e : (u = h, w = t), h || (h = u), void n(function () {
      i(null, u, h);
    })) : window.dofus.reloadAppOnFatalError("No " + e + "/" + t + " dictionary: " + o);
  });
};
t.getText = function (e, t) {
  var i = {};
  Array.isArray(e) ? i.ids = e : i.id = e;
  o("text", i, function (e, i) {
    return e ? t(e) : void t(null, i);
  });
};
t.getDataMap = function (e, t, i) {
  return Array.isArray(t) ? void g.request(e, t, function (t, n, a) {
    if (t) {
      return i(t);
    }
    var s = {};
    for (var r in n) {
      n[r][v] || (s[r] = n[r]);
    }
    if (0 === a.length) {
      return i(null, s);
    }
    var l = {
      "class": e,
      ids: a
    };
    o("map", l, function (t, n) {
      if (t) {
        return i(t);
      }
      for (var o = 0, r = a.length; o < r; o++) {
        var l = a[o],
          c = n[l];
        c ? s[l] = c : n[l] = g.newDummyRecord(f.getKey(e), l);
      }
      return g.put(e, n, function (e) {
        e && console.warn("getDataMap put: Caching data on disk failed with error:", e);
      }), i(null, s);
    });
  }) : i(new TypeError("Data ids should be passed as an array"));
};
t.getDataArray = function (e, i, n, o) {
  "function" == typeof n && (o = n, n = null);
  t.getDataMap(e, i, function (e, t) {
    return e ? o(e) : void o(null, a(t, n));
  });
};
t.searchDataMap = function (e, t, i) {
  var n = {
    "class": e,
    match: t.match,
    matchProp: t.matchProp
  };
  o("map", n, function (t, n) {
    return t ? i(t) : (g.put(e, n, function (e) {
      e && console.warn("searchDataMap put: Caching search results on disk failed with error: " + e);
    }), i(null, n));
  });
};
t.getObject = function (e, i, n) {
  return i || 0 === i ? void t.getDataMap(e, [i], function (t, o) {
    if (t) {
      return n(t);
    }
    var a = o[i];
    return a ? n(null, a) : n("Missing ID #" + i + " in static data " + e);
  }) : n(new Error("You must pass an ID"));
};
t.getData = function (e, i, n) {
  return Array.isArray(i) ? t.getDataArray(e, i, null, n) : i || 0 === i ? void t.getDataMap(e, [i], function (e, t) {
    return e ? n(e) : n(null, t[i]);
  }) : n(new Error("You must pass an ID"));
};
t.getAllDataTable = function (e, t) {
  return Array.isArray(e) ? d(e, !0, t) : c(e, !0, t);
};
t.getAllDataBulk = function (e, t) {
  return Array.isArray(e) ? d(e, !1, t) : c(e, !1, t);
};
t.getAllDataMap = function (e, t) {
  return Array.isArray(e) ? l(e, t) : r(e, t);
};
i.push(t[n]);
i.push(p.BETA_SUFFIX + t[n]);
u = null;
h = null;
w = null;
m.series([function (i) {
  return e === t ? i() : void o("dictionary", {
    lang: e
  }, function (e, t) {
    e ? a.push(e) : u = t;
    i();
  });
}, function (e) {
  o("dictionary", {
    lang: t
  }, function (t, i) {
    t ? a.push(t) : h = i;
    e();
  });
}], function () {
  var o = a.join(", ");
  return u || h ? (o && console.error("Failed getting dictionaries: " + o), u ? w = e : (u = h, w = t), h || (h = u), void n(function () {
    i(null, u, h);
  })) : window.dofus.reloadAppOnFatalError("No " + e + "/" + t + " dictionary: " + o);
});
e ? a.push(e) : u = t;
i();
t ? a.push(t) : h = i;
e();
Array.isArray(e) ? i.ids = e : i.id = e;
o("text", i, function (e, i) {
  return e ? t(e) : void t(null, i);
});
"function" == typeof n && (o = n, n = null);
t.getDataMap(e, i, function (e, t) {
  return e ? o(e) : void o(null, a(t, n));
});
e.exports.cacheCompletion = i;
e.exports.typeNames = ["AbuseReasons", "AchievementCategories", "AchievementObjectives", "AchievementRewards", "Achievements", "ActionDescriptions", "AlignmentBalance", "AlignmentEffect", "AlignmentGift", "AlignmentOrder", "AlignmentRank", "AlignmentRankJntGift", "AlignmentSides", "AlignmentTitles", "AlmanaxCalendars", "Appearances", "Areas", "BidHouseCategories", "Breeds", "CensoredContents", "CensoredWords", "Challenge", "ChatChannels", "Companions", "Documents", "Dungeons", "Effects", "SpellEffects", "EmblemBackgrounds", "EmblemSymbolCategories", "EmblemSymbols", "Emoticons", "ExternalNotifications", "Heads", "HintCategory", "Hints", "Houses", "Incarnation", "IncarnationLevels", "InfoMessages", "Interactives", "Items", "ItemSets", "ItemTypes", "Jobs", "LivingObjectSkinJntMood", "MapCoordinates", "MapPositions", "MapReferences", "MonsterMiniBoss", "MonsterRaces", "Monsters", "MonsterSuperRaces", "Months", "MountBehaviors", "MountBones", "Mounts", "Notifications", "NpcActions", "NpcMessages", "Npcs", "OptionalFeatures", "Ornaments", "Pack", "Pets", "PresetIcons", "QuestCategory", "QuestObjectives", "QuestObjectiveTypes", "Quests", "QuestStepRewards", "QuestSteps", "RankNames", "Recipes", "RideFood", "ServerCommunities", "ServerGameTypes", "ServerPopulations", "Servers", "ShieldModelsLevels", "SkillNames", "Skills", "SkinMappings", "Smileys", "SoundBones", "SoundUi", "SoundUiHook", "SpeakingItemsText", "SpeakingItemsTriggers", "SpellBombs", "SpellLevels", "Spells", "SpellStates", "SpellTypes", "StealthBones", "SubAreas", "SubAreaIdPerCoordinate", "SubAreasWorldMapData", "SuperAreas", "TaxCollectorFirstnames", "TaxCollectorNames", "Tips", "TitleCategories", "Titles", "ToaRank", "TypeActions", "UniqueDrops", "UpgradeTemplates", "Url", "WorldMaps"];
o[i] = !0;
e.exports.hasStringId = function (e) {
  return o[e] || !1;
};
t > 1 && (e += ", ");
e += r(arguments[t]);
a.oncomplete = function () {
  if (console.info("Object store creation completed for: " + i), !w) {
    return y++, y === v ? (p = e, w = !0, t()) : void 0;
  }
};
a.onabort = function () {
  w || (w = !0, t(s("Object store creation aborted for " + i + ": ", a.error)));
};
a.onerror = function () {
  w || (w = !0, t(s("Object store creation failed for " + i + ": ", a.error)));
};
i.onsuccess = function (e) {
  e.target.result ? o[t] = e.target.result : r.push(t);
};
i.onerror = function () {
  s("Requesting id: " + t + ", in store: " + e + ", failed: ", i.error);
  r.push(t);
};
s("Requesting id: " + t + ", in store: " + e + ", failed: ", i.error);
r.push(t);
l.oncomplete = function () {
  i(null, o, r);
};
l.onabort = function () {
  i(s("IndexedDB request transaction aborted with error: ", l.error));
};
l.onerror = function () {
  i(s("IndexedDB request transaction failed with error: ", l.error));
};
i.onsuccess = function () {};
i.onerror = function () {
  s("IndexedDB put object in store: " + e + ", failed: ", i.error);
};
l.oncomplete = function () {
  i();
};
l.onabort = function () {
  i(s("IndexedDB put transaction aborted with error: ", l.error));
};
l.onerror = function () {
  i(s("IndexedDB put transaction failed with error: ", l.error));
};
r.onsuccess = function (e) {
  var t = e.target.result;
  if (t) {
    var n = t.value;
    n[_] || (i[n[a]] = n);
    t["continue"]();
  }
};
r.onerror = function () {
  s("IndexedDB opening cursor on object store: " + e + " failed: ", r.error);
};
n.oncomplete = function () {
  t(null, i);
};
n.onabort = function () {
  t(s("IndexedDB requestAll transaction aborted with error: ", n.error));
};
n.onerror = function () {
  t(s("IndexedDB requestAll transaction failed with error: ", n.error));
};
n[_] || (i[n[a]] = n);
t["continue"]();
void 0 === g.READ_ONLY && (g.READ_ONLY = "readonly");
void 0 === g.READ_WRITE && (g.READ_WRITE = "readwrite");
t.initialize = function (e, t, i) {
  if (!f) {
    return i(s("IDB_NOT_SUPPORTED"));
  }
  p && (p.close(), p = null);
  m = t;
  w = !1;
  var n = f.open(e);
  n.onupgradeneeded = function (e) {
    console.info("IDB request.onupgradeneeded");
    var t = e.target.result;
    t.onerror = function () {
      s("IndexedDB post-upgrade request error: ", t.error);
    };
    l(t, i);
  };
  n.onsuccess = function () {
    console.info("open request.onsuccess; create count: " + y + "/" + v);
    v > 0 && 0 === y || w || (p = n.result, p.onerror = function () {
      s("IndexedDB database error: ", p.error);
    }, w = !0, i());
  };
  n.onerror = function () {
    w || i(s("IndexedDB open error: ", n.error));
  };
};
t["delete"] = function (e, t) {
  console.info("IDB.delete called for " + e + " current: " + (p && p.name));
  p && p.name === e && (p.close(), p = null);
  var i = f.deleteDatabase(e);
  i.onsuccess = function () {
    return console.info("IDB successfully deleted " + e), t();
  };
  i.onerror = function () {
    return t(s("Could not delete database: ", i.error));
  };
  i.onblocked = function () {
    return t(s("Delete database operation was blocked"));
  };
};
t.request = function (e, t, i) {
  return p ? p.objectStoreNames.contains(e) ? void c(e, t, i) : void i(new Error("IndexedDB request failed: object store: " + e + " not found in disk cache")) : void i(new Error("IndexedDB request failed: disk cache not yet initialized"));
};
t.put = h;
t.requestAll = function (e, t) {
  if (!p) {
    return void t(new Error("IndexedDB request failed: disk cache not yet initialized"));
  }
  var i = m.cacheCompletion;
  return i && p.objectStoreNames.contains(i) ? void c(i, [e], function (i, n) {
    if (i) {
      return t(i);
    }
    var o = n[e];
    return o ? p.objectStoreNames.contains(e) ? void u(e, t) : void t(new Error("IndexedDB request all failed: object store: " + e + " not found in disk cache")) : t(null, null);
  }) : void t(new Error("IndexedDB isCacheComplete failed: cache completion not initialized"));
};
t.putAll = function (e, t, i) {
  h(e, t, function (t) {
    if (t) {
      return i(t);
    }
    var n = m.cacheCompletion;
    if (!n || !p.objectStoreNames.contains(n)) {
      return void i(new Error("IndexedDB putAll operation called but cache completion is not set up"));
    }
    var o = {
      completedType: {
        id: e
      }
    };
    h(n, o, function (e) {
      return e ? i(e) : i();
    });
  });
};
p && (p.close(), p = null);
m = t;
w = !1;
n.onupgradeneeded = function (e) {
  console.info("IDB request.onupgradeneeded");
  var t = e.target.result;
  t.onerror = function () {
    s("IndexedDB post-upgrade request error: ", t.error);
  };
  l(t, i);
};
n.onsuccess = function () {
  console.info("open request.onsuccess; create count: " + y + "/" + v);
  v > 0 && 0 === y || w || (p = n.result, p.onerror = function () {
    s("IndexedDB database error: ", p.error);
  }, w = !0, i());
};
n.onerror = function () {
  w || i(s("IndexedDB open error: ", n.error));
};
t.onerror = function () {
  s("IndexedDB post-upgrade request error: ", t.error);
};
l(t, i);
console.info("open request.onsuccess; create count: " + y + "/" + v);
v > 0 && 0 === y || w || (p = n.result, p.onerror = function () {
  s("IndexedDB database error: ", p.error);
}, w = !0, i());
console.info("IDB.delete called for " + e + " current: " + (p && p.name));
p && p.name === e && (p.close(), p = null);
i.onsuccess = function () {
  return console.info("IDB successfully deleted " + e), t();
};
i.onerror = function () {
  return t(s("Could not delete database: ", i.error));
};
i.onblocked = function () {
  return t(s("Delete database operation was blocked"));
};
!function () {
  var e = {
    test: !0
  };
  if (Object.defineProperty) {
    try {
      Object.defineProperty(e, "test", {
        enumerable: !1
      });
      e.test && (cleanInterface = !0);
    } catch (t) {}
  }
}();
(function (e) {
  function t(e, t, i, n) {
    i.target = t;
    "function" == typeof t[e] && t[e].apply(t, [i]);
    "function" == typeof n && n();
  }
  function i(t, i, n) {
    var o = {};
    throw o.name = t, o.message = i, e.DEBUG && (console.log(t, i, n, o), console.trace && console.trace()), o;
  }
  var n = function () {
    this.length = 0;
    this._items = [];
    cleanInterface && Object.defineProperty(this, "_items", {
      enumerable: !1
    });
  };
  if (n.prototype = {
    contains: function (e) {
      return -1 !== this._items.indexOf(e);
    },
    item: function (e) {
      return this._items[e];
    },
    indexOf: function (e) {
      return this._items.indexOf(e);
    },
    push: function (e) {
      this._items.push(e);
      this.length += 1;
      for (var t = 0; this._items.length > t; t++) {
        this[t] = this._items[t];
      }
    },
    splice: function () {
      this._items.splice.apply(this._items, arguments);
      this.length = this._items.length;
      for (var e in this) {
        e === parseInt(e, 10) + "" && delete this[e];
      }
      for (e = 0; this._items.length > e; e++) {
        this[e] = this._items[e];
      }
    }
  }, cleanInterface) {
    for (var o in {
      indexOf: !1,
      push: !1,
      splice: !1
    }) {
      Object.defineProperty(n.prototype, o, {
        enumerable: !1
      });
    }
  }
  e.util = {
    throwDOMException: i,
    callback: t,
    quote: function (e) {
      return "'" + e + "'";
    },
    StringList: n
  };
})(idbModules);
(function (idbModules) {
  var Sca = function () {
    return {
      decycle: function (object, callback) {
        function checkForCompletion() {
          0 === queuedObjects.length && returnCallback(derezObj);
        }
        function readBlobAsDataURL(e, t) {
          var i = new FileReader();
          i.onloadend = function (e) {
            var i = e.target.result,
              n = "blob";
            updateEncodedBlob(i, t, n);
          };
          i.readAsDataURL(e);
        }
        function updateEncodedBlob(dataURL, path, blobtype) {
          var encoded = queuedObjects.indexOf(path);
          path = path.replace("$", "derezObj");
          eval(path + '.$enc="' + dataURL + '"');
          eval(path + '.$type="' + blobtype + '"');
          queuedObjects.splice(encoded, 1);
          checkForCompletion();
        }
        function derez(e, t) {
          var i, n, o;
          if (!("object" != typeof e || null === e || e instanceof Boolean || e instanceof Date || e instanceof Number || e instanceof RegExp || e instanceof Blob || e instanceof String)) {
            for (i = 0; objects.length > i; i += 1) {
              if (objects[i] === e) {
                return {
                  $ref: paths[i]
                };
              }
            }
            if (objects.push(e), paths.push(t), "[object Array]" === Object.prototype.toString.apply(e)) {
              for (o = [], i = 0; e.length > i; i += 1) {
                o[i] = derez(e[i], t + "[" + i + "]");
              }
            } else {
              o = {};
              for (n in e) {
                Object.prototype.hasOwnProperty.call(e, n) && (o[n] = derez(e[n], t + "[" + JSON.stringify(n) + "]"));
              }
            }
            return o;
          }
          return e instanceof Blob ? (queuedObjects.push(t), readBlobAsDataURL(e, t)) : e instanceof Boolean ? e = {
            $type: "bool",
            $enc: "" + e
          } : e instanceof Date ? e = {
            $type: "date",
            $enc: e.getTime()
          } : e instanceof Number ? e = {
            $type: "num",
            $enc: "" + e
          } : e instanceof RegExp && (e = {
            $type: "regex",
            $enc: "" + e
          }), e;
        }
        var objects = [],
          paths = [],
          queuedObjects = [],
          returnCallback = callback,
          derezObj = derez(object, "$");
        checkForCompletion();
      },
      retrocycle: function retrocycle($) {
        function dataURLToBlob(e) {
          var t,
            i,
            n,
            o = ";base64,";
          if (-1 === e.indexOf(o)) {
            return i = e.split(","), t = i[0].split(":")[1], n = i[1], new Blob([n], {
              type: t
            });
          }
          i = e.split(o);
          t = i[0].split(":")[1];
          n = window.atob(i[1]);
          for (var a = n.length, s = new Uint8Array(a), r = 0; a > r; ++r) {
            s[r] = n.charCodeAt(r);
          }
          return new Blob([s.buffer], {
            type: t
          });
        }
        function rez(value) {
          var i, item, name, path;
          if (value && "object" == typeof value) {
            if ("[object Array]" === Object.prototype.toString.apply(value)) {
              for (i = 0; value.length > i; i += 1) {
                item = value[i];
                item && "object" == typeof item && (path = item.$ref, value[i] = "string" == typeof path && px.test(path) ? eval(path) : rez(item));
              }
            } else if (void 0 !== value.$type) {
              switch (value.$type) {
                case "blob":
                case "file":
                  value = dataURLToBlob(value.$enc);
                  break;
                case "bool":
                  value = Boolean("true" === value.$enc);
                  break;
                case "date":
                  value = new Date(value.$enc);
                  break;
                case "num":
                  value = Number(value.$enc);
                  break;
                case "regex":
                  value = eval(value.$enc);
              }
            } else {
              for (name in value) {
                "object" == typeof value[name] && (item = value[name], item && (path = item.$ref, value[name] = "string" == typeof path && px.test(path) ? eval(path) : rez(item)));
              }
            }
          }
          return value;
        }
        var px = /^\$(?:\[(?:\d+|\"(?:[^\\\"\u0000-\u001f]|\\([\\\"\/bfnrt]|u[0-9a-zA-Z]{4}))*\")\])*$/;
        return rez($), $;
      },
      encode: function (e, t) {
        function i(e) {
          t(JSON.stringify(e));
        }
        this.decycle(e, i);
      },
      decode: function (e) {
        return this.retrocycle(JSON.parse(e));
      }
    };
  }();
  idbModules.Sca = Sca;
})(idbModules);
(function (e) {
  var t = ["", "number", "string", "boolean", "object", "undefined"],
    i = function () {
      return {
        encode: function (e) {
          return t.indexOf(typeof e) + "-" + JSON.stringify(e);
        },
        decode: function (e) {
          return void 0 === e ? void 0 : JSON.parse(e.substring(2));
        }
      };
    },
    n = {
      number: i("number"),
      "boolean": i(),
      object: i(),
      string: {
        encode: function (e) {
          return t.indexOf("string") + "-" + e;
        },
        decode: function (e) {
          return "" + e.substring(2);
        }
      },
      undefined: {
        encode: function () {
          return t.indexOf("undefined") + "-undefined";
        },
        decode: function () {}
      }
    },
    o = function () {
      return {
        encode: function (e) {
          return n[typeof e].encode(e);
        },
        decode: function (e) {
          return n[t[e.substring(0, 1)]].decode(e);
        }
      };
    }();
  e.Key = o;
})(idbModules);
(function (e) {
  var t = function (e, t) {
    return {
      type: e,
      debug: t,
      bubbles: !1,
      cancelable: !1,
      eventPhase: 0,
      timeStamp: new Date()
    };
  };
  e.Event = t;
})(idbModules);
(function (e) {
  var t = function () {
      this.onsuccess = this.onerror = this.result = this.error = this.source = this.transaction = null;
      this.readyState = "pending";
    },
    i = function () {
      this.onblocked = this.onupgradeneeded = null;
    };
  i.prototype = t;
  e.IDBRequest = t;
  e.IDBOpenRequest = i;
})(idbModules);
(function (e, t) {
  var i = function (e, t, i, n) {
    this.lower = e;
    this.upper = t;
    this.lowerOpen = i;
    this.upperOpen = n;
  };
  i.only = function (e) {
    return new i(e, e, !1, !1);
  };
  i.lowerBound = function (e, n) {
    return new i(e, t, n, t);
  };
  i.upperBound = function (e) {
    return new i(t, e, t, open);
  };
  i.bound = function (e, t, n, o) {
    return new i(e, t, n, o);
  };
  e.IDBKeyRange = i;
})(idbModules);
(function (e, t) {
  function i(i, n, o, a, s, r) {
    !i || i instanceof e.IDBKeyRange || (i = new e.IDBKeyRange(i, i, !1, !1));
    this.__range = i;
    this.source = this.__idbObjectStore = o;
    this.__req = a;
    this.key = t;
    this.direction = n;
    this.__keyColumnName = s;
    this.__valueColumnName = r;
    this.__valueDecoder = "value" === r ? e.Sca : e.Key;
    this.source.transaction.__active || e.util.throwDOMException("TransactionInactiveError - The transaction this IDBObjectStore belongs to is not active.");
    this.__offset = -1;
    this.__lastKeyContinued = t;
    this["continue"]();
  }
  i.prototype.__find = function (i, n, o, a, s) {
    s = s || 1;
    var r = this,
      l = ["SELECT * FROM ", e.util.quote(r.__idbObjectStore.name)],
      c = [];
    l.push("WHERE ", r.__keyColumnName, " NOT NULL");
    r.__range && (r.__range.lower || r.__range.upper) && (l.push("AND"), r.__range.lower && (l.push(r.__keyColumnName + (r.__range.lowerOpen ? " >" : " >= ") + " ?"), c.push(e.Key.encode(r.__range.lower))), r.__range.lower && r.__range.upper && l.push("AND"), r.__range.upper && (l.push(r.__keyColumnName + (r.__range.upperOpen ? " < " : " <= ") + " ?"), c.push(e.Key.encode(r.__range.upper))));
    i !== t && (r.__lastKeyContinued = i, r.__offset = 0);
    r.__lastKeyContinued !== t && (l.push("AND " + r.__keyColumnName + " >= ?"), c.push(e.Key.encode(r.__lastKeyContinued)));
    l.push("ORDER BY ", r.__keyColumnName);
    l.push("LIMIT " + s + " OFFSET " + r.__offset);
    e.DEBUG && console.log(l.join(" "), c);
    r.__prefetchedData = null;
    n.executeSql(l.join(" "), c, function (i, n) {
      n.rows.length > 1 ? (r.__prefetchedData = n.rows, r.__prefetchedIndex = 0, e.DEBUG && console.log("Preloaded " + r.__prefetchedData.length + " records for cursor"), r.__decode(n.rows.item(0), o)) : 1 === n.rows.length ? r.__decode(n.rows.item(0), o) : (e.DEBUG && console.log("Reached end of cursors"), o(t, t));
    }, function (t, i) {
      e.DEBUG && console.log("Could not execute Cursor.continue");
      a(i);
    });
  };
  i.prototype.__decode = function (t, i) {
    var n = e.Key.decode(t[this.__keyColumnName]),
      o = this.__valueDecoder.decode(t[this.__valueColumnName]),
      a = e.Key.decode(t.key);
    i(n, o, a);
  };
  i.prototype["continue"] = function (i) {
    var n = e.cursorPreloadPackSize || 100,
      o = this;
    this.__idbObjectStore.transaction.__addToTransactionQueue(function (e, a, s, r) {
      o.__offset++;
      var l = function (e, i, n) {
        o.key = e;
        o.value = i;
        o.primaryKey = n;
        s(o.key !== t ? o : t, o.__req);
      };
      return o.__prefetchedData && (o.__prefetchedIndex++, o.__prefetchedIndex < o.__prefetchedData.length) ? (o.__decode(o.__prefetchedData.item(o.__prefetchedIndex), l), t) : (o.__find(i, e, l, r, n), t);
    });
  };
  i.prototype.advance = function (i) {
    0 >= i && e.util.throwDOMException("Type Error - Count is invalid - 0 or negative", i);
    var n = this;
    this.__idbObjectStore.transaction.__addToTransactionQueue(function (e, o, a, s) {
      n.__offset += i;
      n.__find(t, e, function (e, i) {
        n.key = e;
        n.value = i;
        a(n.key !== t ? n : t, n.__req);
      }, s);
    });
  };
  i.prototype.update = function (i) {
    var n = this,
      o = this.__idbObjectStore.transaction.__createRequest(function () {});
    return e.Sca.encode(i, function (i) {
      n.__idbObjectStore.transaction.__pushToQueue(o, function (o, a, s, r) {
        n.__find(t, o, function (t, a, l) {
          var c = "UPDATE " + e.util.quote(n.__idbObjectStore.name) + " SET value = ? WHERE key = ?";
          e.DEBUG && console.log(c, i, t, l);
          o.executeSql(c, [i, e.Key.encode(l)], function (e, i) {
            n.__prefetchedData = null;
            1 === i.rowsAffected ? s(t) : r("No rows with key found" + t);
          }, function (e, t) {
            r(t);
          });
        }, r);
      });
    }), o;
  };
  i.prototype["delete"] = function () {
    var i = this;
    return this.__idbObjectStore.transaction.__addToTransactionQueue(function (n, o, a, s) {
      i.__find(t, n, function (o, r, l) {
        var c = "DELETE FROM  " + e.util.quote(i.__idbObjectStore.name) + " WHERE key = ?";
        e.DEBUG && console.log(c, o, l);
        n.executeSql(c, [e.Key.encode(l)], function (e, n) {
          i.__prefetchedData = null;
          1 === n.rowsAffected ? (i.__offset--, a(t)) : s("No rows with key found" + o);
        }, function (e, t) {
          s(t);
        });
      }, s);
    });
  };
  e.IDBCursor = i;
})(idbModules);
(function (idbModules, undefined) {
  function IDBIndex(e, t) {
    this.indexName = this.name = e;
    this.__idbObjectStore = this.objectStore = this.source = t;
    var i = t.__storeProps && t.__storeProps.indexList;
    i && (i = JSON.parse(i));
    this.keyPath = i && i[e] && i[e].keyPath || e;
    ["multiEntry", "unique"].forEach(function (t) {
      this[t] = !!(i && i[e] && i[e].optionalParams && i[e].optionalParams[t]);
    }, this);
  }
  IDBIndex.prototype.__createIndex = function (indexName, keyPath, optionalParameters) {
    var me = this,
      transaction = me.__idbObjectStore.transaction;
    transaction.__addToTransactionQueue(function (tx, args, success, failure) {
      me.__idbObjectStore.__getStoreProps(tx, function () {
        function error() {
          idbModules.util.throwDOMException(0, "Could not create new index", arguments);
        }
        2 !== transaction.mode && idbModules.util.throwDOMException(0, "Invalid State error, not a version transaction", me.transaction);
        var idxList = JSON.parse(me.__idbObjectStore.__storeProps.indexList);
        idxList[indexName] !== undefined && idbModules.util.throwDOMException(0, "Index already exists on store", idxList);
        var columnName = indexName;
        idxList[indexName] = {
          columnName: columnName,
          keyPath: keyPath,
          optionalParams: optionalParameters
        };
        me.__idbObjectStore.__storeProps.indexList = JSON.stringify(idxList);
        var sql = ["ALTER TABLE", idbModules.util.quote(me.__idbObjectStore.name), "ADD", columnName, "BLOB"].join(" ");
        idbModules.DEBUG && console.log(sql);
        tx.executeSql(sql, [], function (tx, data) {
          tx.executeSql("SELECT * FROM " + idbModules.util.quote(me.__idbObjectStore.name), [], function (tx, data) {
            !function initIndexForRow(i) {
              if (data.rows.length > i) {
                try {
                  var value = idbModules.Sca.decode(data.rows.item(i).value),
                    indexKey = eval("value['" + keyPath + "']");
                  tx.executeSql("UPDATE " + idbModules.util.quote(me.__idbObjectStore.name) + " set " + columnName + " = ? where key = ?", [idbModules.Key.encode(indexKey), data.rows.item(i).key], function () {
                    initIndexForRow(i + 1);
                  }, error);
                } catch (e) {
                  initIndexForRow(i + 1);
                }
              } else {
                idbModules.DEBUG && console.log("Updating the indexes in table", me.__idbObjectStore.__storeProps);
                tx.executeSql("UPDATE __sys__ set indexList = ? where name = ?", [me.__idbObjectStore.__storeProps.indexList, me.__idbObjectStore.name], function () {
                  me.__idbObjectStore.__setReadyState("createIndex", !0);
                  success(me);
                }, error);
              }
            }(0);
          }, error);
        }, error);
      }, "createObjectStore");
    });
  };
  IDBIndex.prototype.openCursor = function (e, t) {
    var i = new idbModules.IDBRequest();
    return new idbModules.IDBCursor(e, t, this.source, i, this.indexName, "value"), i;
  };
  IDBIndex.prototype.openKeyCursor = function (e, t) {
    var i = new idbModules.IDBRequest();
    return new idbModules.IDBCursor(e, t, this.source, i, this.indexName, "key"), i;
  };
  IDBIndex.prototype.__fetchIndexData = function (e, t) {
    var i = this;
    return i.__idbObjectStore.transaction.__addToTransactionQueue(function (n, o, a, s) {
      var r = ["SELECT * FROM ", idbModules.util.quote(i.__idbObjectStore.name), " WHERE", i.indexName, "NOT NULL"],
        l = [];
      e !== undefined && (r.push("AND", i.indexName, " = ?"), l.push(idbModules.Key.encode(e)));
      idbModules.DEBUG && console.log("Trying to fetch data for Index", r.join(" "), l);
      n.executeSql(r.join(" "), l, function (e, i) {
        var n;
        n = "count" === t ? i.rows.length : 0 === i.rows.length ? undefined : "key" === t ? idbModules.Key.decode(i.rows.item(0).key) : idbModules.Sca.decode(i.rows.item(0).value);
        a(n);
      }, s);
    });
  };
  IDBIndex.prototype.get = function (e) {
    return this.__fetchIndexData(e, "value");
  };
  IDBIndex.prototype.getKey = function (e) {
    return this.__fetchIndexData(e, "key");
  };
  IDBIndex.prototype.count = function (e) {
    return this.__fetchIndexData(e, "count");
  };
  idbModules.IDBIndex = IDBIndex;
})(idbModules);
(function (idbModules) {
  var IDBObjectStore = function (e, t, i) {
    this.name = e;
    this.transaction = t;
    this.__ready = {};
    this.__setReadyState("createObjectStore", void 0 === i || i);
    this.indexNames = new idbModules.util.StringList();
  };
  IDBObjectStore.prototype.__setReadyState = function (e, t) {
    this.__ready[e] = t;
  };
  IDBObjectStore.prototype.__waitForReady = function (e, t) {
    var i = !0;
    if (void 0 !== t) {
      i = void 0 === this.__ready[t] || this.__ready[t];
    } else {
      for (var n in this.__ready) {
        this.__ready[n] || (i = !1);
      }
    }
    if (i) {
      e();
    } else {
      idbModules.DEBUG && console.log("Waiting for to be ready", t);
      var o = this;
      window.setTimeout(function () {
        o.__waitForReady(e, t);
      }, 100);
    }
  };
  IDBObjectStore.prototype.__getStoreProps = function (e, t, i) {
    var n = this;
    this.__waitForReady(function () {
      n.__storeProps ? (idbModules.DEBUG && console.log("Store properties - cached", n.__storeProps), t(n.__storeProps)) : e.executeSql("SELECT * FROM __sys__ where name = ?", [n.name], function (e, i) {
        1 !== i.rows.length ? t() : (n.__storeProps = {
          name: i.rows.item(0).name,
          indexList: i.rows.item(0).indexList,
          autoInc: i.rows.item(0).autoInc,
          keyPath: i.rows.item(0).keyPath
        }, idbModules.DEBUG && console.log("Store properties", n.__storeProps), t(n.__storeProps));
      }, function () {
        t();
      });
    }, i);
  };
  IDBObjectStore.prototype.__deriveKey = function (tx, value, key, callback) {
    function getNextAutoIncKey() {
      tx.executeSql("SELECT * FROM sqlite_sequence where name like ?", [me.name], function (e, t) {
        callback(1 !== t.rows.length ? 0 : t.rows.item(0).seq);
      }, function (e, t) {
        idbModules.util.throwDOMException(0, "Data Error - Could not get the auto increment value for key", t);
      });
    }
    var me = this;
    me.__getStoreProps(tx, function (props) {
      if (props || idbModules.util.throwDOMException(0, "Data Error - Could not locate defination for this table", props), props.keyPath) {
        if (void 0 !== key && idbModules.util.throwDOMException(0, "Data Error - The object store uses in-line keys and the key parameter was provided", props), value) {
          try {
            var primaryKey = eval("value['" + props.keyPath + "']");
            void 0 === primaryKey ? "true" === props.autoInc ? getNextAutoIncKey() : idbModules.util.throwDOMException(0, "Data Error - Could not eval key from keyPath") : callback(primaryKey);
          } catch (e) {
            idbModules.util.throwDOMException(0, "Data Error - Could not eval key from keyPath", e);
          }
        } else {
          idbModules.util.throwDOMException(0, "Data Error - KeyPath was specified, but value was not");
        }
      } else {
        void 0 !== key ? callback(key) : "false" === props.autoInc ? idbModules.util.throwDOMException(0, "Data Error - The object store uses out-of-line keys and has no key generator and the key parameter was not provided. ", props) : getNextAutoIncKey();
      }
    });
  };
  IDBObjectStore.prototype.__insertData = function (tx, encoded, value, primaryKey, success, error) {
    var paramMap = {};
    void 0 !== primaryKey && (paramMap.key = idbModules.Key.encode(primaryKey));
    var indexes = JSON.parse(this.__storeProps.indexList);
    for (var key in indexes) {
      try {
        paramMap[indexes[key].columnName] = idbModules.Key.encode(eval("value['" + indexes[key].keyPath + "']"));
      } catch (e) {
        error(e);
      }
    }
    var sqlStart = ["INSERT INTO ", idbModules.util.quote(this.name), "("],
      sqlEnd = [" VALUES ("],
      sqlValues = [];
    for (key in paramMap) {
      sqlStart.push(key + ",");
      sqlEnd.push("?,");
      sqlValues.push(paramMap[key]);
    }
    sqlStart.push("value )");
    sqlEnd.push("?)");
    sqlValues.push(encoded);
    var sql = sqlStart.join(" ") + sqlEnd.join(" ");
    idbModules.DEBUG && console.log("SQL for adding", sql, sqlValues);
    tx.executeSql(sql, sqlValues, function () {
      success(primaryKey);
    }, function (e, t) {
      error(t);
    });
  };
  IDBObjectStore.prototype.add = function (e, t) {
    var i = this,
      n = i.transaction.__createRequest(function () {});
    return idbModules.Sca.encode(e, function (o) {
      i.transaction.__pushToQueue(n, function (n, a, s, r) {
        i.__deriveKey(n, e, t, function (t) {
          i.__insertData(n, o, e, t, s, r);
        });
      });
    }), n;
  };
  IDBObjectStore.prototype.put = function (e, t) {
    var i = this,
      n = i.transaction.__createRequest(function () {});
    return idbModules.Sca.encode(e, function (o) {
      i.transaction.__pushToQueue(n, function (n, a, s, r) {
        i.__deriveKey(n, e, t, function (t) {
          var a = "DELETE FROM " + idbModules.util.quote(i.name) + " where key = ?";
          n.executeSql(a, [idbModules.Key.encode(t)], function (n, a) {
            idbModules.DEBUG && console.log("Did the row with the", t, "exist? ", a.rowsAffected);
            i.__insertData(n, o, e, t, s, r);
          }, function (e, t) {
            r(t);
          });
        });
      });
    }), n;
  };
  IDBObjectStore.prototype.get = function (e) {
    var t = this;
    return t.transaction.__addToTransactionQueue(function (i, n, o, a) {
      t.__waitForReady(function () {
        var n = idbModules.Key.encode(e);
        idbModules.DEBUG && console.log("Fetching", t.name, n);
        i.executeSql("SELECT * FROM " + idbModules.util.quote(t.name) + " where key = ?", [n], function (e, t) {
          idbModules.DEBUG && console.log("Fetched data", t);
          try {
            if (0 === t.rows.length) {
              return o();
            }
            o(idbModules.Sca.decode(t.rows.item(0).value));
          } catch (i) {
            idbModules.DEBUG && console.log(i);
            o(void 0);
          }
        }, function (e, t) {
          a(t);
        });
      });
    });
  };
  IDBObjectStore.prototype["delete"] = function (e) {
    var t = this;
    return t.transaction.__addToTransactionQueue(function (i, n, o, a) {
      t.__waitForReady(function () {
        var n = idbModules.Key.encode(e);
        idbModules.DEBUG && console.log("Fetching", t.name, n);
        i.executeSql("DELETE FROM " + idbModules.util.quote(t.name) + " where key = ?", [n], function (e, t) {
          idbModules.DEBUG && console.log("Deleted from database", t.rowsAffected);
          o();
        }, function (e, t) {
          a(t);
        });
      });
    });
  };
  IDBObjectStore.prototype.clear = function () {
    var e = this;
    return e.transaction.__addToTransactionQueue(function (t, i, n, o) {
      e.__waitForReady(function () {
        t.executeSql("DELETE FROM " + idbModules.util.quote(e.name), [], function (e, t) {
          idbModules.DEBUG && console.log("Cleared all records from database", t.rowsAffected);
          n();
        }, function (e, t) {
          o(t);
        });
      });
    });
  };
  IDBObjectStore.prototype.count = function (e) {
    var t = this;
    return t.transaction.__addToTransactionQueue(function (i, n, o, a) {
      t.__waitForReady(function () {
        var n = "SELECT * FROM " + idbModules.util.quote(t.name) + (void 0 !== e ? " WHERE key = ?" : ""),
          s = [];
        void 0 !== e && s.push(idbModules.Key.encode(e));
        i.executeSql(n, s, function (e, t) {
          o(t.rows.length);
        }, function (e, t) {
          a(t);
        });
      });
    });
  };
  IDBObjectStore.prototype.openCursor = function (e, t) {
    var i = new idbModules.IDBRequest();
    return new idbModules.IDBCursor(e, t, this, i, "key", "value"), i;
  };
  IDBObjectStore.prototype.index = function (e) {
    var t = new idbModules.IDBIndex(e, this);
    return t;
  };
  IDBObjectStore.prototype.createIndex = function (e, t, i) {
    var n = this;
    i = i || {};
    n.__setReadyState("createIndex", !1);
    var o = new idbModules.IDBIndex(e, n);
    return n.__waitForReady(function () {
      o.__createIndex(e, t, i);
    }, "createObjectStore"), n.indexNames.push(e), o;
  };
  IDBObjectStore.prototype.deleteIndex = function (e) {
    var t = new idbModules.IDBIndex(e, this, !1);
    return t.__deleteIndex(e), t;
  };
  idbModules.IDBObjectStore = IDBObjectStore;
})(idbModules);
(function (e) {
  var t = 0,
    i = 1,
    n = 2,
    o = function (n, o, a) {
      if ("number" == typeof o) {
        this.mode = o;
        2 !== o && e.DEBUG && console.log("Mode should be a string, but was specified as ", o);
      } else if ("string" == typeof o) {
        switch (o) {
          case "readwrite":
            this.mode = i;
            break;
          case "readonly":
            this.mode = t;
            break;
          default:
            this.mode = t;
        }
      }
      this.storeNames = "string" == typeof n ? [n] : n;
      for (var s = 0; this.storeNames.length > s; s++) {
        a.objectStoreNames.contains(this.storeNames[s]) || e.util.throwDOMException(0, "The operation failed because the requested database object could not be found. For example, an object store did not exist but was being opened.", this.storeNames[s]);
      }
      this.__active = !0;
      this.__running = !1;
      this.__requests = [];
      this.__aborted = !1;
      this.db = a;
      this.error = null;
      this.onabort = this.onerror = this.oncomplete = null;
    };
  o.prototype.__executeRequests = function () {
    if (this.__running && this.mode !== n) {
      return void (e.DEBUG && console.log("Looks like the request set is already running", this.mode));
    }
    this.__running = !0;
    var t = this;
    window.setTimeout(function () {
      2 === t.mode || t.__active || e.util.throwDOMException(0, "A request was placed against a transaction which is currently not active, or which is finished", t.__active);
      t.db.__db.transaction(function (i) {
        function n(t, i) {
          i && (s.req = i);
          s.req.readyState = "done";
          s.req.result = t;
          delete s.req.error;
          var n = e.Event("success");
          e.util.callback("onsuccess", s.req, n);
          r++;
          a();
        }
        function o() {
          s.req.readyState = "done";
          s.req.error = "DOMError";
          var t = e.Event("error", arguments);
          e.util.callback("onerror", s.req, t);
          r++;
          a();
        }
        function a() {
          return r >= t.__requests.length ? (t.__active = !1, void (t.__requests = [])) : (s = t.__requests[r], void s.op(i, s.args, n, o));
        }
        t.__tx = i;
        var s = null,
          r = 0;
        try {
          a();
        } catch (l) {
          e.DEBUG && console.log("An exception occured in transaction", arguments);
          "function" == typeof t.onerror && t.onerror();
        }
      }, function () {
        e.DEBUG && console.log("An error in transaction", arguments);
        "function" == typeof t.onerror && t.onerror();
      }, function () {
        e.DEBUG && console.log("Transaction completed", arguments);
        "function" == typeof t.oncomplete && t.oncomplete();
      });
    }, 1);
  };
  o.prototype.__addToTransactionQueue = function (t, i) {
    this.__active || this.mode === n || e.util.throwDOMException(0, "A request was placed against a transaction which is currently not active, or which is finished.", this.__mode);
    var o = this.__createRequest();
    return this.__pushToQueue(o, t, i), o;
  };
  o.prototype.__createRequest = function () {
    var t = new e.IDBRequest();
    return t.source = this.db, t.transaction = this, t;
  };
  o.prototype.__pushToQueue = function (e, t, i) {
    this.__requests.push({
      op: t,
      args: i,
      req: e
    });
    this.__executeRequests();
  };
  o.prototype.objectStore = function (t) {
    return new e.IDBObjectStore(t, this);
  };
  o.prototype.abort = function () {
    !this.__active && e.util.throwDOMException(0, "A request was placed against a transaction which is currently not active, or which is finished", this.__active);
  };
  o.prototype.READ_ONLY = 0;
  o.prototype.READ_WRITE = 1;
  o.prototype.VERSION_CHANGE = 2;
  e.IDBTransaction = o;
})(idbModules);
(function (e) {
  var t = function (t, i, n, o) {
    this.__db = t;
    this.version = n;
    this.__storeProperties = o;
    this.objectStoreNames = new e.util.StringList();
    for (var a = 0; o.rows.length > a; a++) {
      this.objectStoreNames.push(o.rows.item(a).name);
    }
    this.name = i;
    this.onabort = this.onerror = this.onversionchange = null;
  };
  t.prototype.createObjectStore = function (t, i) {
    var n = this;
    i = i || {};
    i.keyPath = i.keyPath || null;
    var o = new e.IDBObjectStore(t, n.__versionTransaction, !1),
      a = n.__versionTransaction;
    return a.__addToTransactionQueue(function (a, s, r) {
      function l() {
        e.util.throwDOMException(0, "Could not create new object store", arguments);
      }
      n.__versionTransaction || e.util.throwDOMException(0, "Invalid State error", n.transaction);
      var c = ["CREATE TABLE", e.util.quote(t), "(key BLOB", i.autoIncrement ? ", inc INTEGER PRIMARY KEY AUTOINCREMENT" : "PRIMARY KEY", ", value BLOB)"].join(" ");
      e.DEBUG && console.log(c);
      a.executeSql(c, [], function (e) {
        e.executeSql("INSERT INTO __sys__ VALUES (?,?,?,?)", [t, i.keyPath, !!i.autoIncrement, "{}"], function () {
          o.__setReadyState("createObjectStore", !0);
          r(o);
        }, l);
      }, l);
    }), n.objectStoreNames.push(t), o;
  };
  t.prototype.deleteObjectStore = function (t) {
    var i = function () {
        e.util.throwDOMException(0, "Could not delete ObjectStore", arguments);
      },
      n = this;
    !n.objectStoreNames.contains(t) && i("Object Store does not exist");
    n.objectStoreNames.splice(n.objectStoreNames.indexOf(t), 1);
    var o = n.__versionTransaction;
    o.__addToTransactionQueue(function () {
      n.__versionTransaction || e.util.throwDOMException(0, "Invalid State error", n.transaction);
      n.__db.transaction(function (n) {
        n.executeSql("SELECT * FROM __sys__ where name = ?", [t], function (n, o) {
          o.rows.length > 0 && n.executeSql("DROP TABLE " + e.util.quote(t), [], function () {
            n.executeSql("DELETE FROM __sys__ WHERE name = ?", [t], function () {}, i);
          }, i);
        });
      });
    });
  };
  t.prototype.close = function () {};
  t.prototype.transaction = function (t, i) {
    var n = new e.IDBTransaction(t, i || 1, this);
    return n;
  };
  e.IDBDatabase = t;
})(idbModules);
(function (e) {
  var t = 4194304;
  if (window.openDatabase) {
    var i = window.openDatabase("__sysdb__", 1, "System Database", t);
    i.transaction(function (e) {
      e.executeSql("CREATE TABLE IF NOT EXISTS dbVersions (name VARCHAR(255), version INT);", []);
    }, function () {
      e.DEBUG && console.log("Error in sysdb transaction - when creating dbVersions", arguments);
    });
    var n = {
      open: function (n, o) {
        function a() {
          if (!l) {
            var t = e.Event("error", arguments);
            r.readyState = "done";
            r.error = "DOMError";
            e.util.callback("onerror", r, t);
            l = !0;
          }
        }
        function s(s) {
          var l = window.openDatabase(n, 1, n, t);
          r.readyState = "done";
          void 0 === o && (o = s || 1);
          (0 >= o || s > o) && e.util.throwDOMException(0, "An attempt was made to open a database using a lower version than the existing version.", o);
          l.transaction(function (t) {
            t.executeSql("CREATE TABLE IF NOT EXISTS __sys__ (name VARCHAR(255), keyPath VARCHAR(255), autoInc BOOLEAN, indexList BLOB)", [], function () {
              t.executeSql("SELECT * FROM __sys__", [], function (t, c) {
                var d = e.Event("success");
                r.source = r.result = new e.IDBDatabase(l, n, o, c);
                o > s ? i.transaction(function (t) {
                  t.executeSql("UPDATE dbVersions set version = ? where name = ?", [o, n], function () {
                    var t = e.Event("upgradeneeded");
                    t.oldVersion = s;
                    t.newVersion = o;
                    r.transaction = r.result.__versionTransaction = new e.IDBTransaction([], 2, r.source);
                    e.util.callback("onupgradeneeded", r, t, function () {
                      var t = e.Event("success");
                      e.util.callback("onsuccess", r, t);
                    });
                  }, a);
                }, a) : e.util.callback("onsuccess", r, d);
              }, a);
            }, a);
          }, a);
        }
        var r = new e.IDBOpenRequest(),
          l = !1;
        return i.transaction(function (e) {
          e.executeSql("SELECT * FROM dbVersions where name = ?", [n], function (e, t) {
            0 === t.rows.length ? e.executeSql("INSERT INTO dbVersions VALUES (?,?)", [n, o || 1], function () {
              s(0);
            }, a) : s(t.rows.item(0).version);
          }, a);
        }, a), r;
      },
      deleteDatabase: function (n) {
        function o(t) {
          if (!r) {
            s.readyState = "done";
            s.error = "DOMError";
            var i = e.Event("error");
            i.message = t;
            i.debug = arguments;
            e.util.callback("onerror", s, i);
            r = !0;
          }
        }
        function a() {
          i.transaction(function (t) {
            t.executeSql("DELETE FROM dbVersions where name = ? ", [n], function () {
              s.result = void 0;
              var t = e.Event("success");
              t.newVersion = null;
              t.oldVersion = l;
              e.util.callback("onsuccess", s, t);
            }, o);
          }, o);
        }
        var s = new e.IDBOpenRequest(),
          r = !1,
          l = null;
        return i.transaction(function (i) {
          i.executeSql("SELECT * FROM dbVersions where name = ?", [n], function (i, r) {
            if (0 === r.rows.length) {
              s.result = void 0;
              var c = e.Event("success");
              return c.newVersion = null, c.oldVersion = l, void e.util.callback("onsuccess", s, c);
            }
            l = r.rows.item(0).version;
            var d = window.openDatabase(n, 1, n, t);
            d.transaction(function (t) {
              t.executeSql("SELECT * FROM __sys__", [], function (t, i) {
                var n = i.rows;
                !function s(i) {
                  i >= n.length ? t.executeSql("DROP TABLE __sys__", [], function () {
                    a();
                  }, o) : t.executeSql("DROP TABLE " + e.util.quote(n.item(i).name), [], function () {
                    s(i + 1);
                  }, function () {
                    s(i + 1);
                  });
                }(0);
              }, function () {
                a();
              });
            }, o);
          });
        }, o), s;
      },
      cmp: function (t, i) {
        return e.Key.encode(t) > e.Key.encode(i) ? 1 : t === i ? 0 : -1;
      }
    };
    e.shimIndexedDB = n;
  }
})(idbModules);
(function (e, t) {
  void 0 !== e.openDatabase && (e.shimIndexedDB = t.shimIndexedDB, e.shimIndexedDB && (e.shimIndexedDB.__useShim = function () {
    e.indexedDB = t.shimIndexedDB;
    e.IDBDatabase = t.IDBDatabase;
    e.IDBTransaction = t.IDBTransaction;
    e.IDBCursor = t.IDBCursor;
    e.IDBKeyRange = t.IDBKeyRange;
    e.indexedDB !== t.shimIndexedDB && Object.defineProperty && Object.defineProperty(e, "indexedDB", {
      value: t.shimIndexedDB
    });
  }, e.shimIndexedDB.__debug = function (e) {
    t.DEBUG = e;
  }));
  "indexedDB" in e || (e.indexedDB = e.indexedDB || e.webkitIndexedDB || e.mozIndexedDB || e.oIndexedDB || e.msIndexedDB);
  var i = !1;
  if ((navigator.userAgent.match(/Android 2/) || navigator.userAgent.match(/Android 3/) || navigator.userAgent.match(/Android 4\.[0-3]/)) && (navigator.userAgent.match(/Chrome/) || (i = !0)), void 0 !== e.indexedDB && !i || void 0 === e.openDatabase) {
    e.IDBDatabase = e.IDBDatabase || e.webkitIDBDatabase;
    e.IDBTransaction = e.IDBTransaction || e.webkitIDBTransaction;
    e.IDBCursor = e.IDBCursor || e.webkitIDBCursor;
    e.IDBKeyRange = e.IDBKeyRange || e.webkitIDBKeyRange;
    e.IDBTransaction || (e.IDBTransaction = {});
    try {
      e.IDBTransaction.READ_ONLY = e.IDBTransaction.READ_ONLY || "readonly";
      e.IDBTransaction.READ_WRITE = e.IDBTransaction.READ_WRITE || "readwrite";
    } catch (n) {}
  } else {
    e.shimIndexedDB.__useShim();
  }
})(window, idbModules);
Object.defineProperty(e, "test", {
  enumerable: !1
});
e.test && (cleanInterface = !0);
i.target = t;
"function" == typeof t[e] && t[e].apply(t, [i]);
"function" == typeof n && n();
this.length = 0;
this._items = [];
cleanInterface && Object.defineProperty(this, "_items", {
  enumerable: !1
});
this._items.push(e);
this.length += 1;
this._items.splice.apply(this._items, arguments);
this.length = this._items.length;
i.onloadend = function (e) {
  var i = e.target.result,
    n = "blob";
  updateEncodedBlob(i, t, n);
};
i.readAsDataURL(e);
path = path.replace("$", "derezObj");
eval(path + '.$enc="' + dataURL + '"');
eval(path + '.$type="' + blobtype + '"');
queuedObjects.splice(encoded, 1);
checkForCompletion();
i = e.split(o);
t = i[0].split(":")[1];
n = window.atob(i[1]);
item = value[i];
item && "object" == typeof item && (path = item.$ref, value[i] = "string" == typeof path && px.test(path) ? eval(path) : rez(item));
this.onsuccess = this.onerror = this.result = this.error = this.source = this.transaction = null;
this.readyState = "pending";
i.prototype = t;
e.IDBRequest = t;
e.IDBOpenRequest = i;
this.lower = e;
this.upper = t;
this.lowerOpen = i;
this.upperOpen = n;
i.only = function (e) {
  return new i(e, e, !1, !1);
};
i.lowerBound = function (e, n) {
  return new i(e, t, n, t);
};
i.upperBound = function (e) {
  return new i(t, e, t, open);
};
i.bound = function (e, t, n, o) {
  return new i(e, t, n, o);
};
e.IDBKeyRange = i;
!i || i instanceof e.IDBKeyRange || (i = new e.IDBKeyRange(i, i, !1, !1));
this.__range = i;
this.source = this.__idbObjectStore = o;
this.__req = a;
this.key = t;
this.direction = n;
this.__keyColumnName = s;
this.__valueColumnName = r;
this.__valueDecoder = "value" === r ? e.Sca : e.Key;
this.source.transaction.__active || e.util.throwDOMException("TransactionInactiveError - The transaction this IDBObjectStore belongs to is not active.");
this.__offset = -1;
this.__lastKeyContinued = t;
this["continue"]();
i.prototype.__find = function (i, n, o, a, s) {
  s = s || 1;
  var r = this,
    l = ["SELECT * FROM ", e.util.quote(r.__idbObjectStore.name)],
    c = [];
  l.push("WHERE ", r.__keyColumnName, " NOT NULL");
  r.__range && (r.__range.lower || r.__range.upper) && (l.push("AND"), r.__range.lower && (l.push(r.__keyColumnName + (r.__range.lowerOpen ? " >" : " >= ") + " ?"), c.push(e.Key.encode(r.__range.lower))), r.__range.lower && r.__range.upper && l.push("AND"), r.__range.upper && (l.push(r.__keyColumnName + (r.__range.upperOpen ? " < " : " <= ") + " ?"), c.push(e.Key.encode(r.__range.upper))));
  i !== t && (r.__lastKeyContinued = i, r.__offset = 0);
  r.__lastKeyContinued !== t && (l.push("AND " + r.__keyColumnName + " >= ?"), c.push(e.Key.encode(r.__lastKeyContinued)));
  l.push("ORDER BY ", r.__keyColumnName);
  l.push("LIMIT " + s + " OFFSET " + r.__offset);
  e.DEBUG && console.log(l.join(" "), c);
  r.__prefetchedData = null;
  n.executeSql(l.join(" "), c, function (i, n) {
    n.rows.length > 1 ? (r.__prefetchedData = n.rows, r.__prefetchedIndex = 0, e.DEBUG && console.log("Preloaded " + r.__prefetchedData.length + " records for cursor"), r.__decode(n.rows.item(0), o)) : 1 === n.rows.length ? r.__decode(n.rows.item(0), o) : (e.DEBUG && console.log("Reached end of cursors"), o(t, t));
  }, function (t, i) {
    e.DEBUG && console.log("Could not execute Cursor.continue");
    a(i);
  });
};
i.prototype.__decode = function (t, i) {
  var n = e.Key.decode(t[this.__keyColumnName]),
    o = this.__valueDecoder.decode(t[this.__valueColumnName]),
    a = e.Key.decode(t.key);
  i(n, o, a);
};
i.prototype["continue"] = function (i) {
  var n = e.cursorPreloadPackSize || 100,
    o = this;
  this.__idbObjectStore.transaction.__addToTransactionQueue(function (e, a, s, r) {
    o.__offset++;
    var l = function (e, i, n) {
      o.key = e;
      o.value = i;
      o.primaryKey = n;
      s(o.key !== t ? o : t, o.__req);
    };
    return o.__prefetchedData && (o.__prefetchedIndex++, o.__prefetchedIndex < o.__prefetchedData.length) ? (o.__decode(o.__prefetchedData.item(o.__prefetchedIndex), l), t) : (o.__find(i, e, l, r, n), t);
  });
};
i.prototype.advance = function (i) {
  0 >= i && e.util.throwDOMException("Type Error - Count is invalid - 0 or negative", i);
  var n = this;
  this.__idbObjectStore.transaction.__addToTransactionQueue(function (e, o, a, s) {
    n.__offset += i;
    n.__find(t, e, function (e, i) {
      n.key = e;
      n.value = i;
      a(n.key !== t ? n : t, n.__req);
    }, s);
  });
};
i.prototype.update = function (i) {
  var n = this,
    o = this.__idbObjectStore.transaction.__createRequest(function () {});
  return e.Sca.encode(i, function (i) {
    n.__idbObjectStore.transaction.__pushToQueue(o, function (o, a, s, r) {
      n.__find(t, o, function (t, a, l) {
        var c = "UPDATE " + e.util.quote(n.__idbObjectStore.name) + " SET value = ? WHERE key = ?";
        e.DEBUG && console.log(c, i, t, l);
        o.executeSql(c, [i, e.Key.encode(l)], function (e, i) {
          n.__prefetchedData = null;
          1 === i.rowsAffected ? s(t) : r("No rows with key found" + t);
        }, function (e, t) {
          r(t);
        });
      }, r);
    });
  }), o;
};
i.prototype["delete"] = function () {
  var i = this;
  return this.__idbObjectStore.transaction.__addToTransactionQueue(function (n, o, a, s) {
    i.__find(t, n, function (o, r, l) {
      var c = "DELETE FROM  " + e.util.quote(i.__idbObjectStore.name) + " WHERE key = ?";
      e.DEBUG && console.log(c, o, l);
      n.executeSql(c, [e.Key.encode(l)], function (e, n) {
        i.__prefetchedData = null;
        1 === n.rowsAffected ? (i.__offset--, a(t)) : s("No rows with key found" + o);
      }, function (e, t) {
        s(t);
      });
    }, s);
  });
};
e.IDBCursor = i;
l.push("WHERE ", r.__keyColumnName, " NOT NULL");
r.__range && (r.__range.lower || r.__range.upper) && (l.push("AND"), r.__range.lower && (l.push(r.__keyColumnName + (r.__range.lowerOpen ? " >" : " >= ") + " ?"), c.push(e.Key.encode(r.__range.lower))), r.__range.lower && r.__range.upper && l.push("AND"), r.__range.upper && (l.push(r.__keyColumnName + (r.__range.upperOpen ? " < " : " <= ") + " ?"), c.push(e.Key.encode(r.__range.upper))));
i !== t && (r.__lastKeyContinued = i, r.__offset = 0);
r.__lastKeyContinued !== t && (l.push("AND " + r.__keyColumnName + " >= ?"), c.push(e.Key.encode(r.__lastKeyContinued)));
l.push("ORDER BY ", r.__keyColumnName);
l.push("LIMIT " + s + " OFFSET " + r.__offset);
e.DEBUG && console.log(l.join(" "), c);
r.__prefetchedData = null;
n.executeSql(l.join(" "), c, function (i, n) {
  n.rows.length > 1 ? (r.__prefetchedData = n.rows, r.__prefetchedIndex = 0, e.DEBUG && console.log("Preloaded " + r.__prefetchedData.length + " records for cursor"), r.__decode(n.rows.item(0), o)) : 1 === n.rows.length ? r.__decode(n.rows.item(0), o) : (e.DEBUG && console.log("Reached end of cursors"), o(t, t));
}, function (t, i) {
  e.DEBUG && console.log("Could not execute Cursor.continue");
  a(i);
});
e.DEBUG && console.log("Could not execute Cursor.continue");
a(i);
o.key = e;
o.value = i;
o.primaryKey = n;
s(o.key !== t ? o : t, o.__req);
n.__offset += i;
n.__find(t, e, function (e, i) {
  n.key = e;
  n.value = i;
  a(n.key !== t ? n : t, n.__req);
}, s);
n.key = e;
n.value = i;
a(n.key !== t ? n : t, n.__req);
e.DEBUG && console.log(c, i, t, l);
o.executeSql(c, [i, e.Key.encode(l)], function (e, i) {
  n.__prefetchedData = null;
  1 === i.rowsAffected ? s(t) : r("No rows with key found" + t);
}, function (e, t) {
  r(t);
});
n.__prefetchedData = null;
1 === i.rowsAffected ? s(t) : r("No rows with key found" + t);
e.DEBUG && console.log(c, o, l);
n.executeSql(c, [e.Key.encode(l)], function (e, n) {
  i.__prefetchedData = null;
  1 === n.rowsAffected ? (i.__offset--, a(t)) : s("No rows with key found" + o);
}, function (e, t) {
  s(t);
});
i.__prefetchedData = null;
1 === n.rowsAffected ? (i.__offset--, a(t)) : s("No rows with key found" + o);
this.indexName = this.name = e;
this.__idbObjectStore = this.objectStore = this.source = t;
i && (i = JSON.parse(i));
this.keyPath = i && i[e] && i[e].keyPath || e;
["multiEntry", "unique"].forEach(function (t) {
  this[t] = !!(i && i[e] && i[e].optionalParams && i[e].optionalParams[t]);
}, this);
IDBIndex.prototype.__createIndex = function (indexName, keyPath, optionalParameters) {
  var me = this,
    transaction = me.__idbObjectStore.transaction;
  transaction.__addToTransactionQueue(function (tx, args, success, failure) {
    me.__idbObjectStore.__getStoreProps(tx, function () {
      function error() {
        idbModules.util.throwDOMException(0, "Could not create new index", arguments);
      }
      2 !== transaction.mode && idbModules.util.throwDOMException(0, "Invalid State error, not a version transaction", me.transaction);
      var idxList = JSON.parse(me.__idbObjectStore.__storeProps.indexList);
      idxList[indexName] !== undefined && idbModules.util.throwDOMException(0, "Index already exists on store", idxList);
      var columnName = indexName;
      idxList[indexName] = {
        columnName: columnName,
        keyPath: keyPath,
        optionalParams: optionalParameters
      };
      me.__idbObjectStore.__storeProps.indexList = JSON.stringify(idxList);
      var sql = ["ALTER TABLE", idbModules.util.quote(me.__idbObjectStore.name), "ADD", columnName, "BLOB"].join(" ");
      idbModules.DEBUG && console.log(sql);
      tx.executeSql(sql, [], function (tx, data) {
        tx.executeSql("SELECT * FROM " + idbModules.util.quote(me.__idbObjectStore.name), [], function (tx, data) {
          !function initIndexForRow(i) {
            if (data.rows.length > i) {
              try {
                var value = idbModules.Sca.decode(data.rows.item(i).value),
                  indexKey = eval("value['" + keyPath + "']");
                tx.executeSql("UPDATE " + idbModules.util.quote(me.__idbObjectStore.name) + " set " + columnName + " = ? where key = ?", [idbModules.Key.encode(indexKey), data.rows.item(i).key], function () {
                  initIndexForRow(i + 1);
                }, error);
              } catch (e) {
                initIndexForRow(i + 1);
              }
            } else {
              idbModules.DEBUG && console.log("Updating the indexes in table", me.__idbObjectStore.__storeProps);
              tx.executeSql("UPDATE __sys__ set indexList = ? where name = ?", [me.__idbObjectStore.__storeProps.indexList, me.__idbObjectStore.name], function () {
                me.__idbObjectStore.__setReadyState("createIndex", !0);
                success(me);
              }, error);
            }
          }(0);
        }, error);
      }, error);
    }, "createObjectStore");
  });
};
IDBIndex.prototype.openCursor = function (e, t) {
  var i = new idbModules.IDBRequest();
  return new idbModules.IDBCursor(e, t, this.source, i, this.indexName, "value"), i;
};
IDBIndex.prototype.openKeyCursor = function (e, t) {
  var i = new idbModules.IDBRequest();
  return new idbModules.IDBCursor(e, t, this.source, i, this.indexName, "key"), i;
};
IDBIndex.prototype.__fetchIndexData = function (e, t) {
  var i = this;
  return i.__idbObjectStore.transaction.__addToTransactionQueue(function (n, o, a, s) {
    var r = ["SELECT * FROM ", idbModules.util.quote(i.__idbObjectStore.name), " WHERE", i.indexName, "NOT NULL"],
      l = [];
    e !== undefined && (r.push("AND", i.indexName, " = ?"), l.push(idbModules.Key.encode(e)));
    idbModules.DEBUG && console.log("Trying to fetch data for Index", r.join(" "), l);
    n.executeSql(r.join(" "), l, function (e, i) {
      var n;
      n = "count" === t ? i.rows.length : 0 === i.rows.length ? undefined : "key" === t ? idbModules.Key.decode(i.rows.item(0).key) : idbModules.Sca.decode(i.rows.item(0).value);
      a(n);
    }, s);
  });
};
IDBIndex.prototype.get = function (e) {
  return this.__fetchIndexData(e, "value");
};
IDBIndex.prototype.getKey = function (e) {
  return this.__fetchIndexData(e, "key");
};
IDBIndex.prototype.count = function (e) {
  return this.__fetchIndexData(e, "count");
};
idbModules.IDBIndex = IDBIndex;
idxList[indexName] = {
  columnName: columnName,
  keyPath: keyPath,
  optionalParams: optionalParameters
};
me.__idbObjectStore.__storeProps.indexList = JSON.stringify(idxList);
idbModules.DEBUG && console.log(sql);
tx.executeSql(sql, [], function (tx, data) {
  tx.executeSql("SELECT * FROM " + idbModules.util.quote(me.__idbObjectStore.name), [], function (tx, data) {
    !function initIndexForRow(i) {
      if (data.rows.length > i) {
        try {
          var value = idbModules.Sca.decode(data.rows.item(i).value),
            indexKey = eval("value['" + keyPath + "']");
          tx.executeSql("UPDATE " + idbModules.util.quote(me.__idbObjectStore.name) + " set " + columnName + " = ? where key = ?", [idbModules.Key.encode(indexKey), data.rows.item(i).key], function () {
            initIndexForRow(i + 1);
          }, error);
        } catch (e) {
          initIndexForRow(i + 1);
        }
      } else {
        idbModules.DEBUG && console.log("Updating the indexes in table", me.__idbObjectStore.__storeProps);
        tx.executeSql("UPDATE __sys__ set indexList = ? where name = ?", [me.__idbObjectStore.__storeProps.indexList, me.__idbObjectStore.name], function () {
          me.__idbObjectStore.__setReadyState("createIndex", !0);
          success(me);
        }, error);
      }
    }(0);
  }, error);
}, error);
idbModules.DEBUG && console.log("Updating the indexes in table", me.__idbObjectStore.__storeProps);
tx.executeSql("UPDATE __sys__ set indexList = ? where name = ?", [me.__idbObjectStore.__storeProps.indexList, me.__idbObjectStore.name], function () {
  me.__idbObjectStore.__setReadyState("createIndex", !0);
  success(me);
}, error);
me.__idbObjectStore.__setReadyState("createIndex", !0);
success(me);
e !== undefined && (r.push("AND", i.indexName, " = ?"), l.push(idbModules.Key.encode(e)));
idbModules.DEBUG && console.log("Trying to fetch data for Index", r.join(" "), l);
n.executeSql(r.join(" "), l, function (e, i) {
  var n;
  n = "count" === t ? i.rows.length : 0 === i.rows.length ? undefined : "key" === t ? idbModules.Key.decode(i.rows.item(0).key) : idbModules.Sca.decode(i.rows.item(0).value);
  a(n);
}, s);
n = "count" === t ? i.rows.length : 0 === i.rows.length ? undefined : "key" === t ? idbModules.Key.decode(i.rows.item(0).key) : idbModules.Sca.decode(i.rows.item(0).value);
a(n);
this.name = e;
this.transaction = t;
this.__ready = {};
this.__setReadyState("createObjectStore", void 0 === i || i);
this.indexNames = new idbModules.util.StringList();
IDBObjectStore.prototype.__setReadyState = function (e, t) {
  this.__ready[e] = t;
};
IDBObjectStore.prototype.__waitForReady = function (e, t) {
  var i = !0;
  if (void 0 !== t) {
    i = void 0 === this.__ready[t] || this.__ready[t];
  } else {
    for (var n in this.__ready) {
      this.__ready[n] || (i = !1);
    }
  }
  if (i) {
    e();
  } else {
    idbModules.DEBUG && console.log("Waiting for to be ready", t);
    var o = this;
    window.setTimeout(function () {
      o.__waitForReady(e, t);
    }, 100);
  }
};
IDBObjectStore.prototype.__getStoreProps = function (e, t, i) {
  var n = this;
  this.__waitForReady(function () {
    n.__storeProps ? (idbModules.DEBUG && console.log("Store properties - cached", n.__storeProps), t(n.__storeProps)) : e.executeSql("SELECT * FROM __sys__ where name = ?", [n.name], function (e, i) {
      1 !== i.rows.length ? t() : (n.__storeProps = {
        name: i.rows.item(0).name,
        indexList: i.rows.item(0).indexList,
        autoInc: i.rows.item(0).autoInc,
        keyPath: i.rows.item(0).keyPath
      }, idbModules.DEBUG && console.log("Store properties", n.__storeProps), t(n.__storeProps));
    }, function () {
      t();
    });
  }, i);
};
IDBObjectStore.prototype.__deriveKey = function (tx, value, key, callback) {
  function getNextAutoIncKey() {
    tx.executeSql("SELECT * FROM sqlite_sequence where name like ?", [me.name], function (e, t) {
      callback(1 !== t.rows.length ? 0 : t.rows.item(0).seq);
    }, function (e, t) {
      idbModules.util.throwDOMException(0, "Data Error - Could not get the auto increment value for key", t);
    });
  }
  var me = this;
  me.__getStoreProps(tx, function (props) {
    if (props || idbModules.util.throwDOMException(0, "Data Error - Could not locate defination for this table", props), props.keyPath) {
      if (void 0 !== key && idbModules.util.throwDOMException(0, "Data Error - The object store uses in-line keys and the key parameter was provided", props), value) {
        try {
          var primaryKey = eval("value['" + props.keyPath + "']");
          void 0 === primaryKey ? "true" === props.autoInc ? getNextAutoIncKey() : idbModules.util.throwDOMException(0, "Data Error - Could not eval key from keyPath") : callback(primaryKey);
        } catch (e) {
          idbModules.util.throwDOMException(0, "Data Error - Could not eval key from keyPath", e);
        }
      } else {
        idbModules.util.throwDOMException(0, "Data Error - KeyPath was specified, but value was not");
      }
    } else {
      void 0 !== key ? callback(key) : "false" === props.autoInc ? idbModules.util.throwDOMException(0, "Data Error - The object store uses out-of-line keys and has no key generator and the key parameter was not provided. ", props) : getNextAutoIncKey();
    }
  });
};
IDBObjectStore.prototype.__insertData = function (tx, encoded, value, primaryKey, success, error) {
  var paramMap = {};
  void 0 !== primaryKey && (paramMap.key = idbModules.Key.encode(primaryKey));
  var indexes = JSON.parse(this.__storeProps.indexList);
  for (var key in indexes) {
    try {
      paramMap[indexes[key].columnName] = idbModules.Key.encode(eval("value['" + indexes[key].keyPath + "']"));
    } catch (e) {
      error(e);
    }
  }
  var sqlStart = ["INSERT INTO ", idbModules.util.quote(this.name), "("],
    sqlEnd = [" VALUES ("],
    sqlValues = [];
  for (key in paramMap) {
    sqlStart.push(key + ",");
    sqlEnd.push("?,");
    sqlValues.push(paramMap[key]);
  }
  sqlStart.push("value )");
  sqlEnd.push("?)");
  sqlValues.push(encoded);
  var sql = sqlStart.join(" ") + sqlEnd.join(" ");
  idbModules.DEBUG && console.log("SQL for adding", sql, sqlValues);
  tx.executeSql(sql, sqlValues, function () {
    success(primaryKey);
  }, function (e, t) {
    error(t);
  });
};
IDBObjectStore.prototype.add = function (e, t) {
  var i = this,
    n = i.transaction.__createRequest(function () {});
  return idbModules.Sca.encode(e, function (o) {
    i.transaction.__pushToQueue(n, function (n, a, s, r) {
      i.__deriveKey(n, e, t, function (t) {
        i.__insertData(n, o, e, t, s, r);
      });
    });
  }), n;
};
IDBObjectStore.prototype.put = function (e, t) {
  var i = this,
    n = i.transaction.__createRequest(function () {});
  return idbModules.Sca.encode(e, function (o) {
    i.transaction.__pushToQueue(n, function (n, a, s, r) {
      i.__deriveKey(n, e, t, function (t) {
        var a = "DELETE FROM " + idbModules.util.quote(i.name) + " where key = ?";
        n.executeSql(a, [idbModules.Key.encode(t)], function (n, a) {
          idbModules.DEBUG && console.log("Did the row with the", t, "exist? ", a.rowsAffected);
          i.__insertData(n, o, e, t, s, r);
        }, function (e, t) {
          r(t);
        });
      });
    });
  }), n;
};
IDBObjectStore.prototype.get = function (e) {
  var t = this;
  return t.transaction.__addToTransactionQueue(function (i, n, o, a) {
    t.__waitForReady(function () {
      var n = idbModules.Key.encode(e);
      idbModules.DEBUG && console.log("Fetching", t.name, n);
      i.executeSql("SELECT * FROM " + idbModules.util.quote(t.name) + " where key = ?", [n], function (e, t) {
        idbModules.DEBUG && console.log("Fetched data", t);
        try {
          if (0 === t.rows.length) {
            return o();
          }
          o(idbModules.Sca.decode(t.rows.item(0).value));
        } catch (i) {
          idbModules.DEBUG && console.log(i);
          o(void 0);
        }
      }, function (e, t) {
        a(t);
      });
    });
  });
};
IDBObjectStore.prototype["delete"] = function (e) {
  var t = this;
  return t.transaction.__addToTransactionQueue(function (i, n, o, a) {
    t.__waitForReady(function () {
      var n = idbModules.Key.encode(e);
      idbModules.DEBUG && console.log("Fetching", t.name, n);
      i.executeSql("DELETE FROM " + idbModules.util.quote(t.name) + " where key = ?", [n], function (e, t) {
        idbModules.DEBUG && console.log("Deleted from database", t.rowsAffected);
        o();
      }, function (e, t) {
        a(t);
      });
    });
  });
};
IDBObjectStore.prototype.clear = function () {
  var e = this;
  return e.transaction.__addToTransactionQueue(function (t, i, n, o) {
    e.__waitForReady(function () {
      t.executeSql("DELETE FROM " + idbModules.util.quote(e.name), [], function (e, t) {
        idbModules.DEBUG && console.log("Cleared all records from database", t.rowsAffected);
        n();
      }, function (e, t) {
        o(t);
      });
    });
  });
};
IDBObjectStore.prototype.count = function (e) {
  var t = this;
  return t.transaction.__addToTransactionQueue(function (i, n, o, a) {
    t.__waitForReady(function () {
      var n = "SELECT * FROM " + idbModules.util.quote(t.name) + (void 0 !== e ? " WHERE key = ?" : ""),
        s = [];
      void 0 !== e && s.push(idbModules.Key.encode(e));
      i.executeSql(n, s, function (e, t) {
        o(t.rows.length);
      }, function (e, t) {
        a(t);
      });
    });
  });
};
IDBObjectStore.prototype.openCursor = function (e, t) {
  var i = new idbModules.IDBRequest();
  return new idbModules.IDBCursor(e, t, this, i, "key", "value"), i;
};
IDBObjectStore.prototype.index = function (e) {
  var t = new idbModules.IDBIndex(e, this);
  return t;
};
IDBObjectStore.prototype.createIndex = function (e, t, i) {
  var n = this;
  i = i || {};
  n.__setReadyState("createIndex", !1);
  var o = new idbModules.IDBIndex(e, n);
  return n.__waitForReady(function () {
    o.__createIndex(e, t, i);
  }, "createObjectStore"), n.indexNames.push(e), o;
};
IDBObjectStore.prototype.deleteIndex = function (e) {
  var t = new idbModules.IDBIndex(e, this, !1);
  return t.__deleteIndex(e), t;
};
idbModules.IDBObjectStore = IDBObjectStore;
sqlStart.push(key + ",");
sqlEnd.push("?,");
sqlValues.push(paramMap[key]);
sqlStart.push("value )");
sqlEnd.push("?)");
sqlValues.push(encoded);
idbModules.DEBUG && console.log("SQL for adding", sql, sqlValues);
tx.executeSql(sql, sqlValues, function () {
  success(primaryKey);
}, function (e, t) {
  error(t);
});
idbModules.DEBUG && console.log("Did the row with the", t, "exist? ", a.rowsAffected);
i.__insertData(n, o, e, t, s, r);
idbModules.DEBUG && console.log("Fetching", t.name, n);
i.executeSql("SELECT * FROM " + idbModules.util.quote(t.name) + " where key = ?", [n], function (e, t) {
  idbModules.DEBUG && console.log("Fetched data", t);
  try {
    if (0 === t.rows.length) {
      return o();
    }
    o(idbModules.Sca.decode(t.rows.item(0).value));
  } catch (i) {
    idbModules.DEBUG && console.log(i);
    o(void 0);
  }
}, function (e, t) {
  a(t);
});
idbModules.DEBUG && console.log(i);
o(void 0);
idbModules.DEBUG && console.log("Fetching", t.name, n);
i.executeSql("DELETE FROM " + idbModules.util.quote(t.name) + " where key = ?", [n], function (e, t) {
  idbModules.DEBUG && console.log("Deleted from database", t.rowsAffected);
  o();
}, function (e, t) {
  a(t);
});
idbModules.DEBUG && console.log("Deleted from database", t.rowsAffected);
o();
idbModules.DEBUG && console.log("Cleared all records from database", t.rowsAffected);
n();
void 0 !== e && s.push(idbModules.Key.encode(e));
i.executeSql(n, s, function (e, t) {
  o(t.rows.length);
}, function (e, t) {
  a(t);
});
i = i || {};
n.__setReadyState("createIndex", !1);
this.mode = o;
2 !== o && e.DEBUG && console.log("Mode should be a string, but was specified as ", o);
this.__active = !0;
this.__running = !1;
this.__requests = [];
this.__aborted = !1;
this.db = a;
this.error = null;
this.onabort = this.onerror = this.oncomplete = null;
o.prototype.__executeRequests = function () {
  if (this.__running && this.mode !== n) {
    return void (e.DEBUG && console.log("Looks like the request set is already running", this.mode));
  }
  this.__running = !0;
  var t = this;
  window.setTimeout(function () {
    2 === t.mode || t.__active || e.util.throwDOMException(0, "A request was placed against a transaction which is currently not active, or which is finished", t.__active);
    t.db.__db.transaction(function (i) {
      function n(t, i) {
        i && (s.req = i);
        s.req.readyState = "done";
        s.req.result = t;
        delete s.req.error;
        var n = e.Event("success");
        e.util.callback("onsuccess", s.req, n);
        r++;
        a();
      }
      function o() {
        s.req.readyState = "done";
        s.req.error = "DOMError";
        var t = e.Event("error", arguments);
        e.util.callback("onerror", s.req, t);
        r++;
        a();
      }
      function a() {
        return r >= t.__requests.length ? (t.__active = !1, void (t.__requests = [])) : (s = t.__requests[r], void s.op(i, s.args, n, o));
      }
      t.__tx = i;
      var s = null,
        r = 0;
      try {
        a();
      } catch (l) {
        e.DEBUG && console.log("An exception occured in transaction", arguments);
        "function" == typeof t.onerror && t.onerror();
      }
    }, function () {
      e.DEBUG && console.log("An error in transaction", arguments);
      "function" == typeof t.onerror && t.onerror();
    }, function () {
      e.DEBUG && console.log("Transaction completed", arguments);
      "function" == typeof t.oncomplete && t.oncomplete();
    });
  }, 1);
};
o.prototype.__addToTransactionQueue = function (t, i) {
  this.__active || this.mode === n || e.util.throwDOMException(0, "A request was placed against a transaction which is currently not active, or which is finished.", this.__mode);
  var o = this.__createRequest();
  return this.__pushToQueue(o, t, i), o;
};
o.prototype.__createRequest = function () {
  var t = new e.IDBRequest();
  return t.source = this.db, t.transaction = this, t;
};
o.prototype.__pushToQueue = function (e, t, i) {
  this.__requests.push({
    op: t,
    args: i,
    req: e
  });
  this.__executeRequests();
};
o.prototype.objectStore = function (t) {
  return new e.IDBObjectStore(t, this);
};
o.prototype.abort = function () {
  !this.__active && e.util.throwDOMException(0, "A request was placed against a transaction which is currently not active, or which is finished", this.__active);
};
o.prototype.READ_ONLY = 0;
o.prototype.READ_WRITE = 1;
o.prototype.VERSION_CHANGE = 2;
e.IDBTransaction = o;
2 === t.mode || t.__active || e.util.throwDOMException(0, "A request was placed against a transaction which is currently not active, or which is finished", t.__active);
t.db.__db.transaction(function (i) {
  function n(t, i) {
    i && (s.req = i);
    s.req.readyState = "done";
    s.req.result = t;
    delete s.req.error;
    var n = e.Event("success");
    e.util.callback("onsuccess", s.req, n);
    r++;
    a();
  }
  function o() {
    s.req.readyState = "done";
    s.req.error = "DOMError";
    var t = e.Event("error", arguments);
    e.util.callback("onerror", s.req, t);
    r++;
    a();
  }
  function a() {
    return r >= t.__requests.length ? (t.__active = !1, void (t.__requests = [])) : (s = t.__requests[r], void s.op(i, s.args, n, o));
  }
  t.__tx = i;
  var s = null,
    r = 0;
  try {
    a();
  } catch (l) {
    e.DEBUG && console.log("An exception occured in transaction", arguments);
    "function" == typeof t.onerror && t.onerror();
  }
}, function () {
  e.DEBUG && console.log("An error in transaction", arguments);
  "function" == typeof t.onerror && t.onerror();
}, function () {
  e.DEBUG && console.log("Transaction completed", arguments);
  "function" == typeof t.oncomplete && t.oncomplete();
});
i && (s.req = i);
s.req.readyState = "done";
s.req.result = t;
delete s.req.error;
e.util.callback("onsuccess", s.req, n);
r++;
a();
s.req.readyState = "done";
s.req.error = "DOMError";
e.util.callback("onerror", s.req, t);
r++;
a();
e.DEBUG && console.log("An exception occured in transaction", arguments);
"function" == typeof t.onerror && t.onerror();
e.DEBUG && console.log("An error in transaction", arguments);
"function" == typeof t.onerror && t.onerror();
e.DEBUG && console.log("Transaction completed", arguments);
"function" == typeof t.oncomplete && t.oncomplete();
this.__requests.push({
  op: t,
  args: i,
  req: e
});
this.__executeRequests();
this.__db = t;
this.version = n;
this.__storeProperties = o;
this.objectStoreNames = new e.util.StringList();
this.name = i;
this.onabort = this.onerror = this.onversionchange = null;
t.prototype.createObjectStore = function (t, i) {
  var n = this;
  i = i || {};
  i.keyPath = i.keyPath || null;
  var o = new e.IDBObjectStore(t, n.__versionTransaction, !1),
    a = n.__versionTransaction;
  return a.__addToTransactionQueue(function (a, s, r) {
    function l() {
      e.util.throwDOMException(0, "Could not create new object store", arguments);
    }
    n.__versionTransaction || e.util.throwDOMException(0, "Invalid State error", n.transaction);
    var c = ["CREATE TABLE", e.util.quote(t), "(key BLOB", i.autoIncrement ? ", inc INTEGER PRIMARY KEY AUTOINCREMENT" : "PRIMARY KEY", ", value BLOB)"].join(" ");
    e.DEBUG && console.log(c);
    a.executeSql(c, [], function (e) {
      e.executeSql("INSERT INTO __sys__ VALUES (?,?,?,?)", [t, i.keyPath, !!i.autoIncrement, "{}"], function () {
        o.__setReadyState("createObjectStore", !0);
        r(o);
      }, l);
    }, l);
  }), n.objectStoreNames.push(t), o;
};
t.prototype.deleteObjectStore = function (t) {
  var i = function () {
      e.util.throwDOMException(0, "Could not delete ObjectStore", arguments);
    },
    n = this;
  !n.objectStoreNames.contains(t) && i("Object Store does not exist");
  n.objectStoreNames.splice(n.objectStoreNames.indexOf(t), 1);
  var o = n.__versionTransaction;
  o.__addToTransactionQueue(function () {
    n.__versionTransaction || e.util.throwDOMException(0, "Invalid State error", n.transaction);
    n.__db.transaction(function (n) {
      n.executeSql("SELECT * FROM __sys__ where name = ?", [t], function (n, o) {
        o.rows.length > 0 && n.executeSql("DROP TABLE " + e.util.quote(t), [], function () {
          n.executeSql("DELETE FROM __sys__ WHERE name = ?", [t], function () {}, i);
        }, i);
      });
    });
  });
};
t.prototype.close = function () {};
t.prototype.transaction = function (t, i) {
  var n = new e.IDBTransaction(t, i || 1, this);
  return n;
};
e.IDBDatabase = t;
i = i || {};
i.keyPath = i.keyPath || null;
e.DEBUG && console.log(c);
a.executeSql(c, [], function (e) {
  e.executeSql("INSERT INTO __sys__ VALUES (?,?,?,?)", [t, i.keyPath, !!i.autoIncrement, "{}"], function () {
    o.__setReadyState("createObjectStore", !0);
    r(o);
  }, l);
}, l);
o.__setReadyState("createObjectStore", !0);
r(o);
!n.objectStoreNames.contains(t) && i("Object Store does not exist");
n.objectStoreNames.splice(n.objectStoreNames.indexOf(t), 1);
n.__versionTransaction || e.util.throwDOMException(0, "Invalid State error", n.transaction);
n.__db.transaction(function (n) {
  n.executeSql("SELECT * FROM __sys__ where name = ?", [t], function (n, o) {
    o.rows.length > 0 && n.executeSql("DROP TABLE " + e.util.quote(t), [], function () {
      n.executeSql("DELETE FROM __sys__ WHERE name = ?", [t], function () {}, i);
    }, i);
  });
});
r.readyState = "done";
r.error = "DOMError";
e.util.callback("onerror", r, t);
l = !0;
r.readyState = "done";
void 0 === o && (o = s || 1);
(0 >= o || s > o) && e.util.throwDOMException(0, "An attempt was made to open a database using a lower version than the existing version.", o);
l.transaction(function (t) {
  t.executeSql("CREATE TABLE IF NOT EXISTS __sys__ (name VARCHAR(255), keyPath VARCHAR(255), autoInc BOOLEAN, indexList BLOB)", [], function () {
    t.executeSql("SELECT * FROM __sys__", [], function (t, c) {
      var d = e.Event("success");
      r.source = r.result = new e.IDBDatabase(l, n, o, c);
      o > s ? i.transaction(function (t) {
        t.executeSql("UPDATE dbVersions set version = ? where name = ?", [o, n], function () {
          var t = e.Event("upgradeneeded");
          t.oldVersion = s;
          t.newVersion = o;
          r.transaction = r.result.__versionTransaction = new e.IDBTransaction([], 2, r.source);
          e.util.callback("onupgradeneeded", r, t, function () {
            var t = e.Event("success");
            e.util.callback("onsuccess", r, t);
          });
        }, a);
      }, a) : e.util.callback("onsuccess", r, d);
    }, a);
  }, a);
}, a);
r.source = r.result = new e.IDBDatabase(l, n, o, c);
o > s ? i.transaction(function (t) {
  t.executeSql("UPDATE dbVersions set version = ? where name = ?", [o, n], function () {
    var t = e.Event("upgradeneeded");
    t.oldVersion = s;
    t.newVersion = o;
    r.transaction = r.result.__versionTransaction = new e.IDBTransaction([], 2, r.source);
    e.util.callback("onupgradeneeded", r, t, function () {
      var t = e.Event("success");
      e.util.callback("onsuccess", r, t);
    });
  }, a);
}, a) : e.util.callback("onsuccess", r, d);
t.oldVersion = s;
t.newVersion = o;
r.transaction = r.result.__versionTransaction = new e.IDBTransaction([], 2, r.source);
e.util.callback("onupgradeneeded", r, t, function () {
  var t = e.Event("success");
  e.util.callback("onsuccess", r, t);
});
s.readyState = "done";
s.error = "DOMError";
i.message = t;
i.debug = arguments;
e.util.callback("onerror", s, i);
r = !0;
t.newVersion = null;
t.oldVersion = l;
e.util.callback("onsuccess", s, t);
void 0 !== e.openDatabase && (e.shimIndexedDB = t.shimIndexedDB, e.shimIndexedDB && (e.shimIndexedDB.__useShim = function () {
  e.indexedDB = t.shimIndexedDB;
  e.IDBDatabase = t.IDBDatabase;
  e.IDBTransaction = t.IDBTransaction;
  e.IDBCursor = t.IDBCursor;
  e.IDBKeyRange = t.IDBKeyRange;
  e.indexedDB !== t.shimIndexedDB && Object.defineProperty && Object.defineProperty(e, "indexedDB", {
    value: t.shimIndexedDB
  });
}, e.shimIndexedDB.__debug = function (e) {
  t.DEBUG = e;
}));
"indexedDB" in e || (e.indexedDB = e.indexedDB || e.webkitIndexedDB || e.mozIndexedDB || e.oIndexedDB || e.msIndexedDB);
e.indexedDB = t.shimIndexedDB;
e.IDBDatabase = t.IDBDatabase;
e.IDBTransaction = t.IDBTransaction;
e.IDBCursor = t.IDBCursor;
e.IDBKeyRange = t.IDBKeyRange;
e.indexedDB !== t.shimIndexedDB && Object.defineProperty && Object.defineProperty(e, "indexedDB", {
  value: t.shimIndexedDB
});
e.IDBDatabase = e.IDBDatabase || e.webkitIDBDatabase;
e.IDBTransaction = e.IDBTransaction || e.webkitIDBTransaction;
e.IDBCursor = e.IDBCursor || e.webkitIDBCursor;
e.IDBKeyRange = e.IDBKeyRange || e.webkitIDBKeyRange;
e.IDBTransaction || (e.IDBTransaction = {});
e.IDBTransaction.READ_ONLY = e.IDBTransaction.READ_ONLY || "readonly";
e.IDBTransaction.READ_WRITE = e.IDBTransaction.READ_WRITE || "readwrite";
l.open("POST", d, !0);
l.setRequestHeader("Content-type", "application/json");
l.send(JSON.stringify(i));
t.decode = t.parse = i(135);
t.encode = t.stringify = i(136);
t = t || "&";
n = n || "=";
f >= 0 ? (d = m.substr(0, f), u = m.substr(f + 1)) : (d = m, u = "");
h = decodeURIComponent(d);
p = decodeURIComponent(u);
i(a, h) ? Array.isArray(a[h]) ? a[h].push(p) : a[h] = [a[h], p] : a[h] = p;
t.operation = function (e) {
  var i = t.timeouts(e);
  return new n(i, {
    forever: e && (e.forever || e.retries === 1 / 0),
    unref: e && e.unref,
    maxRetryTime: e && e.maxRetryTime
  });
};
t.timeouts = function (e) {
  if (e instanceof Array) {
    return [].concat(e);
  }
  var t = {
    retries: 10,
    factor: 2,
    minTimeout: 1e3,
    maxTimeout: 1 / 0,
    randomize: !1
  };
  for (var i in e) {
    t[i] = e[i];
  }
  if (t.minTimeout > t.maxTimeout) {
    throw new Error("minTimeout is greater than maxTimeout");
  }
  for (var n = [], o = 0; o < t.retries; o++) {
    n.push(this.createTimeout(o, t));
  }
  return e && e.forever && !n.length && n.push(this.createTimeout(o, t)), n.sort(function (e, t) {
    return e - t;
  }), n;
};
t.createTimeout = function (e, t) {
  var i = t.randomize ? Math.random() + 1 : 1,
    n = Math.round(i * Math.max(t.minTimeout, 1) * Math.pow(t.factor, e));
  return n = Math.min(n, t.maxTimeout);
};
t.wrap = function (e, i, n) {
  if (i instanceof Array && (n = i, i = null), !n) {
    n = [];
    for (var o in e) {
      "function" == typeof e[o] && n.push(o);
    }
  }
  for (var a = 0; a < n.length; a++) {
    var s = n[a],
      r = e[s];
    e[s] = function (n) {
      var o = t.operation(i),
        a = Array.prototype.slice.call(arguments, 1),
        s = a.pop();
      a.push(function (e) {
        o.retry(e) || (e && (arguments[0] = o.mainError()), s.apply(this, arguments));
      });
      o.attempt(function () {
        n.apply(e, a);
      });
    }.bind(e, r);
    e[s].options = i;
  }
};
e[s] = function (n) {
  var o = t.operation(i),
    a = Array.prototype.slice.call(arguments, 1),
    s = a.pop();
  a.push(function (e) {
    o.retry(e) || (e && (arguments[0] = o.mainError()), s.apply(this, arguments));
  });
  o.attempt(function () {
    n.apply(e, a);
  });
}.bind(e, r);
e[s].options = i;
a.push(function (e) {
  o.retry(e) || (e && (arguments[0] = o.mainError()), s.apply(this, arguments));
});
o.attempt(function () {
  n.apply(e, a);
});
"boolean" == typeof t && (t = {
  forever: t
});
this._originalTimeouts = JSON.parse(JSON.stringify(e));
this._timeouts = e;
this._options = t || {};
this._maxRetryTime = t && t.maxRetryTime || 1 / 0;
this._fn = null;
this._errors = [];
this._attempts = 1;
this._operationTimeout = null;
this._operationTimeoutCb = null;
this._timeout = null;
this._operationStart = null;
this._timer = null;
this._options.forever && (this._cachedTimeouts = this._timeouts.slice(0));
e.exports = i;
i.prototype.reset = function () {
  this._attempts = 1;
  this._timeouts = this._originalTimeouts.slice(0);
};
i.prototype.stop = function () {
  this._timeout && clearTimeout(this._timeout);
  this._timer && clearTimeout(this._timer);
  this._timeouts = [];
  this._cachedTimeouts = null;
};
i.prototype.retry = function (e) {
  if (this._timeout && clearTimeout(this._timeout), !e) {
    return !1;
  }
  var t = new Date().getTime();
  if (e && t - this._operationStart >= this._maxRetryTime) {
    return this._errors.push(e), this._errors.unshift(new Error("RetryOperation timeout occurred")), !1;
  }
  this._errors.push(e);
  var i = this._timeouts.shift();
  if (void 0 === i) {
    if (!this._cachedTimeouts) {
      return !1;
    }
    this._errors.splice(0, this._errors.length - 1);
    i = this._cachedTimeouts.slice(-1);
  }
  var n = this;
  return this._timer = setTimeout(function () {
    n._attempts++;
    n._operationTimeoutCb && (n._timeout = setTimeout(function () {
      n._operationTimeoutCb(n._attempts);
    }, n._operationTimeout), n._options.unref && n._timeout.unref());
    n._fn(n._attempts);
  }, i), this._options.unref && this._timer.unref(), !0;
};
i.prototype.attempt = function (e, t) {
  this._fn = e;
  t && (t.timeout && (this._operationTimeout = t.timeout), t.cb && (this._operationTimeoutCb = t.cb));
  var i = this;
  this._operationTimeoutCb && (this._timeout = setTimeout(function () {
    i._operationTimeoutCb();
  }, i._operationTimeout));
  this._operationStart = new Date().getTime();
  this._fn(this._attempts);
};
i.prototype["try"] = function (e) {
  console.log("Using RetryOperation.try() is deprecated");
  this.attempt(e);
};
i.prototype.start = function (e) {
  console.log("Using RetryOperation.start() is deprecated");
  this.attempt(e);
};
i.prototype.start = i.prototype["try"];
i.prototype.errors = function () {
  return this._errors;
};
i.prototype.attempts = function () {
  return this._attempts;
};
i.prototype.mainError = function () {
  if (0 === this._errors.length) {
    return null;
  }
  for (var e = {}, t = null, i = 0, n = 0; n < this._errors.length; n++) {
    var o = this._errors[n],
      a = o.message,
      s = (e[a] || 0) + 1;
    e[a] = s;
    s >= i && (t = o, i = s);
  }
  return t;
};
this._attempts = 1;
this._timeouts = this._originalTimeouts.slice(0);
this._timeout && clearTimeout(this._timeout);
this._timer && clearTimeout(this._timer);
this._timeouts = [];
this._cachedTimeouts = null;
this._errors.splice(0, this._errors.length - 1);
i = this._cachedTimeouts.slice(-1);
n._attempts++;
n._operationTimeoutCb && (n._timeout = setTimeout(function () {
  n._operationTimeoutCb(n._attempts);
}, n._operationTimeout), n._options.unref && n._timeout.unref());
n._fn(n._attempts);
this._fn = e;
t && (t.timeout && (this._operationTimeout = t.timeout), t.cb && (this._operationTimeoutCb = t.cb));
this._operationTimeoutCb && (this._timeout = setTimeout(function () {
  i._operationTimeoutCb();
}, i._operationTimeout));
this._operationStart = new Date().getTime();
this._fn(this._attempts);
console.log("Using RetryOperation.try() is deprecated");
this.attempt(e);
console.log("Using RetryOperation.start() is deprecated");
this.attempt(e);
e[a] = s;
s >= i && (t = o, i = s);
window.gui.openSimplePopup(h("ui.popup.connectionFailed.text"));
console.warn("login error without reason:", e);
t.characterId = null;
t.connectMethod = null;
t.startLoginProcessWithPassword = function (e, t, i, n, o) {
  return l(e, {
    account: t,
    password: i,
    save: n
  }, o);
};
t.startLoginProcessWithoutPassword = function (e, t, i) {
  return t = t || {}, l(e, t, i);
};
t.reconnectByCharId = function (e, i) {
  i = i || n;
  t.characterId = e;
  g = !0;
  var o = window.gui.playerData.forcedAccount;
  window.dofus.disconnect();
  window.gui._shutDownUI();
  t.startLoginProcessWithoutPassword("characterId", {
    forcedAccount: o
  }, function (e) {
    return e ? (g = !1, t.backToLogin(), i(e)) : i();
  });
};
t.backToLogin = function () {
  g || window.gui.loginScreen.backToLogin();
};
t.goBackToSelectionOf = function (e, i) {
  i = i || n;
  window.gui.splashScreen.show();
  window.gui.loginScreen.hide();
  g = !0;
  var o = window.gui.playerData.forcedAccount;
  window.dofus.disconnect();
  var a = "character" === e ? "lastServer" : null;
  t.startLoginProcessWithoutPassword(a, {
    forcedAccount: o
  }, function (e) {
    return e ? (g = !1, t.backToLogin(), i(e)) : i();
  });
};
t.onFullReconnection = function () {
  window.gui.splashScreen.show();
  window.gui.loginScreen.hide();
  t.connectMethod = "lastCharacter";
};
i = i || n;
t.characterId = e;
g = !0;
window.dofus.disconnect();
window.gui._shutDownUI();
t.startLoginProcessWithoutPassword("characterId", {
  forcedAccount: o
}, function (e) {
  return e ? (g = !1, t.backToLogin(), i(e)) : i();
});
i = i || n;
window.gui.splashScreen.show();
window.gui.loginScreen.hide();
g = !0;
window.gui.splashScreen.show();
window.gui.loginScreen.hide();
t.connectMethod = "lastCharacter";
t.initHaapiModule = function (e, t) {
  g = e;
  v = new m(g, window.Config);
  _ = new h(g, t, v, u.postDirectly, c);
  M.verbose(_.describe());
};
t.getHaapiConfig = function () {
  return v || M.error("Config not ready yet."), v;
};
t.hasKeyFromStorage = function () {
  return Boolean(u.getHaapiKeyFromStorage());
};
t.hasKey = function () {
  return Boolean(u.getHaapiKey());
};
t.resetHaapiKey = function () {
  u.resetHaapiKey();
};
t.getHaapiUsername = function () {
  return a ? a : a = r.getItem("HAAPI_USERNAME") || "";
};
t.createGuest = function (e, t) {
  if (window.Config.disabledFeatures.guest) {
    return t({
      error: new Error("createGuest: guest is disabled")
    });
  }
  if (f) {
    return _.account.createGuest(window, s, t);
  }
  var i = {
    game: v.getGameId(),
    lang: window.Config.language,
    "web_params[]": "",
    captcha_token: e
  };
  l.open({
    uri: v.getBaseUrl() + "/Ankama/v5/Account/CreateGuest",
    requestType: "GET",
    timeout: w,
    resultHeaders: [y],
    params: i
  }, function (e, i) {
    var n = {};
    if (i.content) {
      try {
        n = JSON.parse(i.content);
      } catch (o) {
        return t({
          error: new Error("createGuest: unable to parse JSON (" + i.content + ")")
        });
      }
    }
    if (e) {
      return t({
        error: new Error(e + " (status code: " + i.xhr.status + ")"),
        userError: i.xhr.status && i.xhr.status >= 600 && n ? n.text : null
      });
    }
    var a = {
      login: n.login,
      password: i.headers && i.headers[y]
    };
    return a.login && a.password ? (s.setValue("guestAccount", a, 1), t(null, a)) : t({
      error: new Error("createGuest: wrong credential (login:" + a.login + "/password:" + a.password + ")")
    });
  });
};
t.validateGuest = function (e, i) {
  return e ? e.guestLogin ? e.guestPassword ? void t.createApiKey({
    login: e.guestLogin,
    password: e.guestPassword,
    long_life_token: !1
  }, {
    saveKey: !0
  }, function (n) {
    return n ? i(n) : _.account.validateGuestWithApiKey(window, u.postDirectly, e, function (e) {
      return t.resetHaapiKey(), e ? i(e) : i();
    });
  }) : i(new Error("Missing password")) : i(new Error("Missing login")) : i(new Error("Missing data"));
};
t.registerOpenRequest = function (e) {
  var t = {
    lang: window.Config.language
  };
  u.fetch("/haapi/registerOpenRequest", t, e);
};
t.createApiKey = function (e, t, i) {
  var n = {};
  n.game_id = v.getGameId();
  n.long_life_token = e.long_life_token;
  n.login = e.login;
  n.password = e.password;
  var o = v.getBaseUrl() + "/Ankama/v5/Api/CreateApiKey";
  u.postDirectly(o, n, function (e, n) {
    if (e) {
      return i(e);
    }
    var o = new Date(n.expiration_date).getTime();
    return u.setHaapiKey(n.key, {
      save: t.saveKey,
      timeout: o
    }), i();
  });
};
t.createToken = function (e) {
  u.fetchDirectly(v.getBaseUrl() + "/Ankama/v5/Account/CreateToken", {
    game: v.getGameId()
  }, e);
};
t.login = function (e, i, o, a) {
  function s(t, i) {
    return t ? a(t) : (n(e), i.username = e, a(null, i));
  }
  return 1 === arguments.length ? (a = e, e = t.getHaapiUsername(), u.getHaapiKey() ? t.createToken(s) : a({
    reason: "NOKEY"
  })) : (e = e.trim(), void t.createApiKey({
    login: e,
    password: i,
    long_life_token: o
  }, {
    saveKey: o
  }, function (e) {
    return e ? a(e) : t.createToken(s);
  }));
};
t.getForumTopicsList = function (e) {
  var t = window.Config.language;
  u.fetch("/haapi/getForumTopicsList", {
    lang: t
  }, e);
};
t.getForumPostsList = function (e, t) {
  var i = window.Config.language;
  u.fetch("/haapi/getForumPostsList", {
    lang: i,
    topicId: e
  }, t);
};
t.getNewsList = function (e, t) {
  _.cmsItems.get(u.fetchDirectly, window.Config.language, e, Date.now(), t);
};
t.getAlmanax = function (e) {
  var t = {
    fetchFn: u.fetchDirectly,
    assetPreloading: p,
    getText: d,
    timeManager: c
  };
  _.almanax.getEvent(t, window.Config.language, e);
};
t.getMarketingPopups = function (e) {
  if (window.gui.playerData.isShopDisabled()) {
    return e(new Error("SHOP_DISABLE"));
  }
  var t = window.gui.playerData.characterBaseInformations.level;
  _.shop.getHighLightsList(window.dofus.send, t, _.shop.type.POPUP, e);
};
t.sendKPIEvent = function (e, t, i, n) {
  _.game.sendEvent(e, t, n, i, function (e) {
    if (e) {
      return void M.error("sendKPIEvent: Error on event id: " + t + ", error: " + e);
    }
  });
};
g = e;
v = new m(g, window.Config);
_ = new h(g, t, v, u.postDirectly, c);
M.verbose(_.describe());
n.game_id = v.getGameId();
n.long_life_token = e.long_life_token;
n.login = e.login;
n.password = e.password;
"GET" === c && h && (u = u + "?" + h, h = null);
d.timeout = p;
d.onreadystatechange = i;
d.open(c, u, !0);
d.send(h);
t.setHaapiKey = function (e, t) {
  if (t = t || {}, l = e, !t.save) {
    return e;
  }
  try {
    if (!e) {
      return d.removeItem("HAAPI_KEY"), d.removeItem("HAAPI_KEY_TIMEOUT"), e;
    }
    var i = e ? Date.now() + p : null;
    d.setItem("HAAPI_KEY", e);
    d.setItem("HAAPI_KEY_TIMEOUT", t.timeout || i);
  } catch (n) {
    return c.warning("Failed to store HAAPI_KEY in local storage:", n), null;
  }
  return e;
};
t.resetHaapiKey = function () {
  t.setHaapiKey(null, {
    save: !0
  });
};
t.getHaapiKeyFromStorage = function () {
  var e = Date.now(),
    i = d.getItem("HAAPI_KEY"),
    n = d.getItem("HAAPI_KEY_TIMEOUT");
  return !i || !n || n < e ? t.resetHaapiKey() : t.setHaapiKey(i, {
    save: !1
  });
};
t.getHaapiKey = function () {
  return l ? l : t.getHaapiKeyFromStorage();
};
t.fetch = function (e, t, i) {
  var n = window.Config.dataUrl;
  e = n + e;
  var o = u.stringify(t);
  r(window.fetch([e, o].join("?")), i);
};
t.fetchDirectly = function (e, i, n) {
  var o = {
      Accept: "application/json"
    },
    a = t.getHaapiKey();
  a && (o.APIKEY = a);
  var s = u.stringify(i);
  r(window.fetch([e, s].join("?"), {
    headers: o
  }), n);
};
t.postDirectly = function (e, i, n) {
  var o = {
      Accept: "application/json"
    },
    a = t.getHaapiKey();
  a && (o.apikey = a);
  r(window.fetch(e, {
    method: "post",
    headers: o,
    body: u.stringify(i)
  }), n);
};
d.setItem("HAAPI_KEY", e);
d.setItem("HAAPI_KEY_TIMEOUT", t.timeout || i);
a && (o.apikey = a);
r(window.fetch(e, {
  method: "post",
  headers: o,
  body: u.stringify(i)
}), n);
this.protocol = null;
this.slashes = null;
this.auth = null;
this.host = null;
this.port = null;
this.hostname = null;
this.hash = null;
this.search = null;
this.query = null;
this.pathname = null;
this.path = null;
this.href = null;
t.parse = o;
t.resolve = s;
t.resolveObject = r;
t.format = a;
t.Url = n;
n.prototype.parse = function (e, t, i) {
  if (!l(e)) {
    throw new TypeError("Parameter 'url' must be a string, not " + typeof e);
  }
  var n = e;
  n = n.trim();
  var o = p.exec(n);
  if (o) {
    o = o[0];
    var a = o.toLowerCase();
    this.protocol = a;
    n = n.substr(o.length);
  }
  if (i || o || n.match(/^\/\/[^@\/]+@[^@\/]+/)) {
    var s = "//" === n.substr(0, 2);
    !s || o && C[o] || (n = n.substr(2), this.slashes = !0);
  }
  if (!C[o] && (s || o && !I[o])) {
    for (var r = -1, c = 0; c < y.length; c++) {
      var d = n.indexOf(y[c]);
      d !== -1 && (r === -1 || d < r) && (r = d);
    }
    var u, m;
    m = r === -1 ? n.lastIndexOf("@") : n.lastIndexOf("@", r);
    m !== -1 && (u = n.slice(0, m), n = n.slice(m + 1), this.auth = decodeURIComponent(u));
    r = -1;
    for (var c = 0; c < v.length; c++) {
      var d = n.indexOf(v[c]);
      d !== -1 && (r === -1 || d < r) && (r = d);
    }
    r === -1 && (r = n.length);
    this.host = n.slice(0, r);
    n = n.slice(r);
    this.parseHost();
    this.hostname = this.hostname || "";
    var f = "[" === this.hostname[0] && "]" === this.hostname[this.hostname.length - 1];
    if (!f) {
      for (var g = this.hostname.split(/\./), c = 0, S = g.length; c < S; c++) {
        var E = g[c];
        if (E && !E.match(b)) {
          for (var N = "", x = 0, L = E.length; x < L; x++) {
            N += E.charCodeAt(x) > 127 ? "x" : E[x];
          }
          if (!N.match(b)) {
            var O = g.slice(0, c),
              R = g.slice(c + 1),
              D = E.match(M);
            D && (O.push(D[1]), R.unshift(D[2]));
            R.length && (n = "/" + R.join(".") + n);
            this.hostname = O.join(".");
            break;
          }
        }
      }
    }
    if (this.hostname.length > w ? this.hostname = "" : this.hostname = this.hostname.toLowerCase(), !f) {
      for (var P = this.hostname.split("."), B = [], c = 0; c < P.length; ++c) {
        var k = P[c];
        B.push(k.match(/[^A-Za-z0-9_-]/) ? "xn--" + h.encode(k) : k);
      }
      this.hostname = B.join(".");
    }
    var F = this.port ? ":" + this.port : "",
      H = this.hostname || "";
    this.host = H + F;
    this.href += this.host;
    f && (this.hostname = this.hostname.substr(1, this.hostname.length - 2), "/" !== n[0] && (n = "/" + n));
  }
  if (!T[a]) {
    for (var c = 0, S = _.length; c < S; c++) {
      var z = _[c],
        W = encodeURIComponent(z);
      W === z && (W = escape(z));
      n = n.split(z).join(W);
    }
  }
  var G = n.indexOf("#");
  G !== -1 && (this.hash = n.substr(G), n = n.slice(0, G));
  var U = n.indexOf("?");
  if (U !== -1 ? (this.search = n.substr(U), this.query = n.substr(U + 1), t && (this.query = A.parse(this.query)), n = n.slice(0, U)) : t && (this.search = "", this.query = {}), n && (this.pathname = n), I[a] && this.hostname && !this.pathname && (this.pathname = "/"), this.pathname || this.search) {
    var F = this.pathname || "",
      k = this.search || "";
    this.path = F + k;
  }
  return this.href = this.format(), this;
};
n.prototype.format = function () {
  var e = this.auth || "";
  e && (e = encodeURIComponent(e), e = e.replace(/%3A/i, ":"), e += "@");
  var t = this.protocol || "",
    i = this.pathname || "",
    n = this.hash || "",
    o = !1,
    a = "";
  this.host ? o = e + this.host : this.hostname && (o = e + (this.hostname.indexOf(":") === -1 ? this.hostname : "[" + this.hostname + "]"), this.port && (o += ":" + this.port));
  this.query && c(this.query) && Object.keys(this.query).length && (a = A.stringify(this.query));
  var s = this.search || a && "?" + a || "";
  return t && ":" !== t.substr(-1) && (t += ":"), this.slashes || (!t || I[t]) && o !== !1 ? (o = "//" + (o || ""), i && "/" !== i.charAt(0) && (i = "/" + i)) : o || (o = ""), n && "#" !== n.charAt(0) && (n = "#" + n), s && "?" !== s.charAt(0) && (s = "?" + s), i = i.replace(/[?#]/g, function (e) {
    return encodeURIComponent(e);
  }), s = s.replace("#", "%23"), t + o + i + s + n;
};
n.prototype.resolve = function (e) {
  return this.resolveObject(o(e, !1, !0)).format();
};
n.prototype.resolveObject = function (e) {
  if (l(e)) {
    var t = new n();
    t.parse(e, !1, !0);
    e = t;
  }
  var i = new n();
  if (Object.keys(this).forEach(function (e) {
    i[e] = this[e];
  }, this), i.hash = e.hash, "" === e.href) {
    return i.href = i.format(), i;
  }
  if (e.slashes && !e.protocol) {
    return Object.keys(e).forEach(function (t) {
      "protocol" !== t && (i[t] = e[t]);
    }), I[i.protocol] && i.hostname && !i.pathname && (i.path = i.pathname = "/"), i.href = i.format(), i;
  }
  if (e.protocol && e.protocol !== i.protocol) {
    if (!I[e.protocol]) {
      return Object.keys(e).forEach(function (t) {
        i[t] = e[t];
      }), i.href = i.format(), i;
    }
    if (i.protocol = e.protocol, e.host || C[e.protocol]) {
      i.pathname = e.pathname;
    } else {
      for (var o = (e.pathname || "").split("/"); o.length && !(e.host = o.shift());) {
        ;
      }
      e.host || (e.host = "");
      e.hostname || (e.hostname = "");
      "" !== o[0] && o.unshift("");
      o.length < 2 && o.unshift("");
      i.pathname = o.join("/");
    }
    if (i.search = e.search, i.query = e.query, i.host = e.host || "", i.auth = e.auth, i.hostname = e.hostname || e.host, i.port = e.port, i.pathname || i.search) {
      var a = i.pathname || "",
        s = i.search || "";
      i.path = a + s;
    }
    return i.slashes = i.slashes || e.slashes, i.href = i.format(), i;
  }
  var r = i.pathname && "/" === i.pathname.charAt(0),
    c = e.host || e.pathname && "/" === e.pathname.charAt(0),
    h = c || r || i.host && e.pathname,
    p = h,
    m = i.pathname && i.pathname.split("/") || [],
    o = e.pathname && e.pathname.split("/") || [],
    f = i.protocol && !I[i.protocol];
  if (f && (i.hostname = "", i.port = null, i.host && ("" === m[0] ? m[0] = i.host : m.unshift(i.host)), i.host = "", e.protocol && (e.hostname = null, e.port = null, e.host && ("" === o[0] ? o[0] = e.host : o.unshift(e.host)), e.host = null), h = h && ("" === o[0] || "" === m[0])), c) {
    i.host = e.host || "" === e.host ? e.host : i.host;
    i.hostname = e.hostname || "" === e.hostname ? e.hostname : i.hostname;
    i.search = e.search;
    i.query = e.query;
    m = o;
  } else if (o.length) {
    m || (m = []);
    m.pop();
    m = m.concat(o);
    i.search = e.search;
    i.query = e.query;
  } else if (!u(e.search)) {
    if (f) {
      i.hostname = i.host = m.shift();
      var g = !!(i.host && i.host.indexOf("@") > 0) && i.host.split("@");
      g && (i.auth = g.shift(), i.host = i.hostname = g.shift());
    }
    return i.search = e.search, i.query = e.query, d(i.pathname) && d(i.search) || (i.path = (i.pathname ? i.pathname : "") + (i.search ? i.search : "")), i.href = i.format(), i;
  }
  if (!m.length) {
    return i.pathname = null, i.search ? i.path = "/" + i.search : i.path = null, i.href = i.format(), i;
  }
  for (var _ = m.slice(-1)[0], v = (i.host || e.host) && ("." === _ || ".." === _) || "" === _, y = 0, w = m.length; w >= 0; w--) {
    _ = m[w];
    "." == _ ? m.splice(w, 1) : ".." === _ ? (m.splice(w, 1), y++) : y && (m.splice(w, 1), y--);
  }
  if (!h && !p) {
    for (; y--; y) {
      m.unshift("..");
    }
  }
  !h || "" === m[0] || m[0] && "/" === m[0].charAt(0) || m.unshift("");
  v && "/" !== m.join("/").substr(-1) && m.push("");
  var b = "" === m[0] || m[0] && "/" === m[0].charAt(0);
  if (f) {
    i.hostname = i.host = b ? "" : m.length ? m.shift() : "";
    var g = !!(i.host && i.host.indexOf("@") > 0) && i.host.split("@");
    g && (i.auth = g.shift(), i.host = i.hostname = g.shift());
  }
  return h = h || i.host && m.length, h && !b && m.unshift(""), m.length ? i.pathname = m.join("/") : (i.pathname = null, i.path = null), d(i.pathname) && d(i.search) || (i.path = (i.pathname ? i.pathname : "") + (i.search ? i.search : "")), i.auth = e.auth || i.auth, i.slashes = i.slashes || e.slashes, i.href = i.format(), i;
};
n.prototype.parseHost = function () {
  var e = this.host,
    t = m.exec(e);
  t && (t = t[0], ":" !== t && (this.port = t.substr(1)), e = e.substr(0, e.length - t.length));
  e && (this.hostname = e);
};
this.protocol = a;
n = n.substr(o.length);
m = r === -1 ? n.lastIndexOf("@") : n.lastIndexOf("@", r);
m !== -1 && (u = n.slice(0, m), n = n.slice(m + 1), this.auth = decodeURIComponent(u));
r = -1;
r === -1 && (r = n.length);
this.host = n.slice(0, r);
n = n.slice(r);
this.parseHost();
this.hostname = this.hostname || "";
D && (O.push(D[1]), R.unshift(D[2]));
R.length && (n = "/" + R.join(".") + n);
this.hostname = O.join(".");
this.host = H + F;
this.href += this.host;
f && (this.hostname = this.hostname.substr(1, this.hostname.length - 2), "/" !== n[0] && (n = "/" + n));
W === z && (W = escape(z));
n = n.split(z).join(W);
this.host ? o = e + this.host : this.hostname && (o = e + (this.hostname.indexOf(":") === -1 ? this.hostname : "[" + this.hostname + "]"), this.port && (o += ":" + this.port));
this.query && c(this.query) && Object.keys(this.query).length && (a = A.stringify(this.query));
t.parse(e, !1, !0);
e = t;
e.host || (e.host = "");
e.hostname || (e.hostname = "");
"" !== o[0] && o.unshift("");
o.length < 2 && o.unshift("");
i.pathname = o.join("/");
i.host = e.host || "" === e.host ? e.host : i.host;
i.hostname = e.hostname || "" === e.hostname ? e.hostname : i.hostname;
i.search = e.search;
i.query = e.query;
m = o;
m || (m = []);
m.pop();
m = m.concat(o);
i.search = e.search;
i.query = e.query;
_ = m[w];
"." == _ ? m.splice(w, 1) : ".." === _ ? (m.splice(w, 1), y++) : y && (m.splice(w, 1), y--);
!h || "" === m[0] || m[0] && "/" === m[0].charAt(0) || m.unshift("");
v && "/" !== m.join("/").substr(-1) && m.push("");
t && (t = t[0], ":" !== t && (this.port = t.substr(1)), e = e.substr(0, e.length - t.length));
e && (this.hostname = e);
i.length > 1 && (n = i[0] + "@", e = i[1]);
e = e.replace(L, ".");
t = e.charCodeAt(o++);
t >= 55296 && t <= 56319 && o < a ? (i = e.charCodeAt(o++), 56320 == (64512 & i) ? n.push(((1023 & t) << 10) + (1023 & i) + 65536) : (n.push(t), o--)) : n.push(t);
e.charCodeAt(n) >= 128 && s("not-basic");
f.push(e.charCodeAt(n));
m = b - h;
r > D(w / m) && s("overflow");
r *= m;
t = f.length + 1;
y = p(_ - a, t, 0 == a);
D(_ / t) > w - v && s("overflow");
v += D(_ / t);
_ %= t;
f.splice(_++, 0, v);
f = e[r];
f < 128 && C.push(P(f));
f = e[r];
f >= t && f < l && (l = f);
y = d - m;
v = b - m;
C.push(P(h(m + y % v, 0)));
d = D(y / v);
C.push(P(h(d, 0)));
a = p(i, _, n == o);
i = 0;
++n;
++i;
++t;
y = {
  version: "1.3.2",
  ucs2: {
    decode: c,
    encode: d
  },
  decode: m,
  encode: f,
  toASCII: _,
  toUnicode: g
};
n = function () {
  return y;
}.call(t, i, t, e);
!(void 0 !== n && (e.exports = n));
this.cmsItems = new o(e, i);
this.account = new a(e, i);
this.almanax = new s(e, i);
this.game = new l(e, i, n, c);
this.shop = new r(e, t);
e.exports = n;
n.prototype.describe = function () {
  var e = "";
  return e += this.cmsItems.describe() + "\n", e += this.account.describe() + "\n", e += this.almanax.describe() + "\n", e += this.shop.describe() + "\n", e += this.game.describe() + "\n";
};
s.call(this, e);
this._haapiConfig = t;
this._paths = {
  get: "/Ankama/v5/Cms/Items/Get"
};
e.exports = o;
a(o, s);
o.prototype.describe = function () {
  return this.formatHaapiPaths("Ankama/Cms/Items", this._paths);
};
o.prototype.get = function (e, t, i, o, a) {
  var s = this._haapiConfig.getBaseUrl() + this._paths.get,
    r = n(t),
    l = {
      template_key: c,
      site: d,
      lang: r,
      page: 1,
      count: i,
      v: o
    };
  e(s, l, a);
};
e.exports = i;
i.prototype.formatHaapiPaths = function (e, t) {
  var i = [];
  for (var n in t) {
    if (t.hasOwnProperty(n)) {
      var o = t[n];
      i.push("- " + o);
    }
  }
  return "## " + e + "\n" + i.join("\n");
};
i.prototype.describe = function () {
  return "";
};
l.call(this, e);
this._haapiConfig = t;
this._paths = {
  validateGuestWithApiKey: "/Ankama/v5/Account/ValidateGuestWithApiKey"
};
e.exports = a;
s(a, l);
a.prototype.describe = function () {
  return this.formatHaapiPaths("Ankama/Account", this._paths);
};
a.prototype.createGuest = function (e, t, i) {
  function n(t, i) {
    d && (d.close(), d.removeEventListener("message", a), d.removeEventListener("loaderror", s), d.removeEventListener("exit", n), d = null);
    u && (u.close(), e.removeEventListener("message", a), u = null);
    r && (r(t, i), r = null);
  }
  function o() {
    var e = {
      error: new Error("View has exit.")
    };
    n(e);
  }
  function a(e) {
    if (!e || !e.origin || "https://account.ankama.tst" === e.origin || "https://account.ankama.lan" === e.origin || "https://account.ankama.com" === e.origin) {
      if (e && e.data && e.data.success) {
        var i = {
          login: e.data.login,
          password: e.data.password
        };
        return t.setValue("guestAccount", i, 1), void n(null, i);
      }
      var o = {
        error: new Error("View gave no data.")
      };
      n(o);
    }
  }
  function s(e) {
    var t = {
      error: new Error("View had a load error. " + (e && e.message || "no messages."))
    };
    n(t);
  }
  var r = i,
    l = "https://account." + this._haapiConfig.getHostname() + "/" + e.Config.language,
    c = l + "/dofus-touch-create-guest",
    d = null,
    u = null;
  if (e.cordova && e.cordova.InAppBrowser ? d = e.cordova.InAppBrowser.open(c, "_blank", "location=yes,hidden=no") : u = e.open(c, "_blank"), !d && !u) {
    var h = {
      error: new Error("Cannot get the view.")
    };
    n(h);
  }
  d && (d.addEventListener("message", a), d.addEventListener("loaderror", s), d.addEventListener("exit", o));
  u && e.addEventListener("message", a);
};
a.prototype.validateGuestWithApiKey = function (e, t, i, a) {
  var s = e.Config || {},
    r = s.disabledFeatures || {};
  if (r.guest) {
    return a(new Error("validateGuest: guest is disabled"));
  }
  var l = this._haapiConfig.getBaseUrl() + this._paths.validateGuestWithApiKey,
    c = {};
  c.lang = e.Config.language;
  c.nickname = i.nickname;
  c.email = i.email;
  c.password = i.password;
  c.firstname = i.firstname;
  c.lastname = i.lastname;
  c.parent_email = i.parentEmail || "";
  var d = o(i.birthDateTimestamp);
  if (d.error) {
    return a(d.error);
  }
  c.birth_date = d.birthDate;
  var u = n(c);
  return u ? a(u) : t(l, c, a);
};
d && (d.close(), d.removeEventListener("message", a), d.removeEventListener("loaderror", s), d.removeEventListener("exit", n), d = null);
u && (u.close(), e.removeEventListener("message", a), u = null);
r && (r(t, i), r = null);
d && (d.addEventListener("message", a), d.addEventListener("loaderror", s), d.addEventListener("exit", o));
u && e.addEventListener("message", a);
c.lang = e.Config.language;
c.nickname = i.nickname;
c.email = i.email;
c.password = i.password;
c.firstname = i.firstname;
c.lastname = i.lastname;
c.parent_email = i.parentEmail || "";
r.call(this, e);
this._haapiConfig = t;
this._lastUpdate = "";
this._cachedResult = null;
this._paths = {
  getEvent: "/Ankama/v5/Almanax/GetEvent"
};
e.exports = n;
s(n, r);
n.prototype.describe = function () {
  return this.formatHaapiPaths("Ankama/Almanax", this._paths);
};
n.prototype.getEvent = function (e, t, i) {
  var n = e.fetchFn,
    o = e.assetPreloading,
    s = e.getText,
    r = e.timeManager,
    c = this,
    d = this._haapiConfig.getBaseUrl() + this._paths.getEvent,
    u = !1,
    h = l(r.now()),
    p = h.tz("Europe/Paris").format("YYYY-MM-DD");
  if (this._lastUpdate === p) {
    return u = !0, i(null, this._cachedResult, u);
  }
  var m = {
    lang: t
  };
  n(d, m, function (e, t) {
    return e ? i(e) : (c._lastUpdate = p, c._cachedResult = t, a(o, s, t, function (e, t) {
      return e ? i(e) : i(null, t, u);
    }));
  });
};
i = t(a.charCodeAt(n));
l = 60 * l + i;
r /= 60;
i = t(s.charCodeAt(n));
l += i * r;
this.name = e;
this.zones = t;
i && i[0] ? (i = i[0].match(/[A-Z]/g), i = i ? i.join("") : void 0) : (i = t.match(/[A-Z]{3,5}/g), i = i ? i[0] : void 0);
"GMT" === i && (i = void 0);
this.at = +e;
this.abbr = i;
this.offset = e.getTimezoneOffset();
this.zone = e;
this.offsetScore = 0;
this.abbrScore = 0;
i = new c(new Date(e.at + n));
i.offset === e.offset ? e = i : t = i;
t = new c(new Date(n, i, 1));
t.offset !== o.offset && (e = u(o, t), a.push(e), a.push(new c(new Date(e.at + 6e4))));
o = t;
a.push(new c(new Date(n + i, 0, 1)));
a.push(new c(new Date(n + i, 6, 1)));
o = t[i];
W[o] = W[o] || {};
W[o][e] = !0;
n = e[t].split("|");
i = n[0];
o = v(i);
k[o] = e[t];
z[o] = i;
m(o, n[2].split(" "));
i = e[t].split("|");
n = v(i[0]);
o = v(i[1]);
F[n] = o;
z[n] = i[0];
F[o] = n;
z[o] = i[1];
o = e[t].split("|");
i = o[0].toUpperCase();
n = o[1].split(" ");
H[i] = new l(i, n);
y(e.zones);
T(e.links);
C(e.countries);
L.dataVersion = e.version;
(U < 2 || 2 === U && q < 6) && x("Moment Timezone requires Moment.js >= 2.6.0. You are using Moment.js " + e.version + ". See momentjs.com");
r.prototype = {
  _set: function (e) {
    this.name = e.name;
    this.abbrs = e.abbrs;
    this.untils = e.untils;
    this.offsets = e.offsets;
    this.population = e.population;
  },
  _index: function (e) {
    var t,
      i = +e,
      n = this.untils;
    for (t = 0; t < n.length; t++) {
      if (i < n[t]) {
        return t;
      }
    }
  },
  countries: function () {
    var e = this.name;
    return Object.keys(H).filter(function (t) {
      return H[t].zones.indexOf(e) !== -1;
    });
  },
  parse: function (e) {
    var t,
      i,
      n,
      o,
      a = +e,
      s = this.offsets,
      r = this.untils,
      l = r.length - 1;
    for (o = 0; o < l; o++) {
      if (t = s[o], i = s[o + 1], n = s[o ? o - 1 : o], t < i && L.moveAmbiguousForward ? t = i : t > n && L.moveInvalidForward && (t = n), a < r[o] - 6e4 * t) {
        return s[o];
      }
    }
    return s[l];
  },
  abbr: function (e) {
    return this.abbrs[this._index(e)];
  },
  offset: function (e) {
    return x("zone.offset has been deprecated in favor of zone.utcOffset"), this.offsets[this._index(e)];
  },
  utcOffset: function (e) {
    return this.offsets[this._index(e)];
  }
};
d.prototype.scoreOffsetAt = function (e) {
  this.offsetScore += Math.abs(this.zone.utcOffset(e.at) - e.offset);
  this.zone.abbr(e.at).replace(/[^A-Z]/g, "") !== e.abbr && this.abbrScore++;
};
L.version = B;
L.dataVersion = "";
L._zones = k;
L._links = F;
L._names = z;
L._countries = H;
L.add = y;
L.link = T;
L.load = S;
L.zone = w;
L.zoneExists = E;
L.guess = _;
L.names = b;
L.Zone = r;
L.unpack = s;
L.unpackBase60 = i;
L.needsOffset = N;
L.moveInvalidForward = !0;
L.moveAmbiguousForward = !1;
L.countries = M;
L.zonesForCountry = A;
this.name = e.name;
this.abbrs = e.abbrs;
this.untils = e.untils;
this.offsets = e.offsets;
this.population = e.population;
this.offsetScore += Math.abs(this.zone.utcOffset(e.at) - e.offset);
this.zone.abbr(e.at).replace(/[^A-Z]/g, "") !== e.abbr && this.abbrScore++;
e.tz = L;
e.defaultZone = null;
e.updateOffset = function (t, i) {
  var n,
    o = e.defaultZone;
  if (void 0 === t._z && (o && N(t) && !t._isUTC && (t._d = e.utc(t._a)._d, t.utc().add(o.parse(t), "minutes")), t._z = o), t._z) {
    if (n = t._z.utcOffset(t), Math.abs(n) < 16 && (n /= 60), void 0 !== t.utcOffset) {
      var a = t._z;
      t.utcOffset(-n, i);
      t._z = a;
    } else {
      t.zone(n, i);
    }
  }
};
Y.tz = function (t, i) {
  if (t) {
    if ("string" != typeof t) {
      throw new Error("Time zone name must be a string, got " + t + " [" + typeof t + "]");
    }
    return this._z = w(t), this._z ? e.updateOffset(this, i) : x("Moment Timezone has no data for " + t + ". See http://momentjs.com/timezone/docs/#/data-loading/."), this;
  }
  if (this._z) {
    return this._z.name;
  }
};
Y.zoneName = O(Y.zoneName);
Y.zoneAbbr = O(Y.zoneAbbr);
Y.utc = R(Y.utc);
Y.local = R(Y.local);
Y.utcOffset = D(Y.utcOffset);
e.tz.setDefault = function (t) {
  return (U < 2 || 2 === U && q < 9) && x("Moment Timezone setDefault() requires Moment.js >= 2.9.0. You are using Moment.js " + e.version + "."), e.defaultZone = t ? w(t) : null, e;
};
t.utcOffset(-n, i);
t._z = a;
n = so[i];
o = t[n];
c(o) || (e[n] = o);
y(this, e);
this._d = new Date(null != e._d ? e._d.getTime() : NaN);
this.isValid() || (this._d = new Date(NaN));
ro === !1 && (ro = !0, t.updateOffset(this), ro = !1);
M(e + "\nArguments: " + Array.prototype.slice.call(l).join("") + "\n" + new Error().stack);
n = !1;
null != t.deprecationHandler && t.deprecationHandler(e, i);
lo[e] || (M(i), lo[e] = !0);
this._config = e;
this._dayOfMonthOrdinalParseLenient = new RegExp((this._dayOfMonthOrdinalParse.source || this._ordinalParse.source) + "|" + /\d{1,2}/.source);
"string" == typeof n && (o = function () {
  return this[n]();
});
e && (go[e] = o);
t && (go[t[0]] = function () {
  return x(o.apply(this, arguments), t[1], t[2]);
});
i && (go[i] = function () {
  return this.localeData().ordinal(o.apply(this, arguments), e);
});
e = e.replace(mo, i);
mo.lastIndex = 0;
n -= 1;
n._w = n._w || {};
t(e, n._w, n, o);
a = m([2e3, n]);
this._shortMonthsParse[n] = this.monthsShort(a, "").toLocaleLowerCase();
this._longMonthsParse[n] = this.months(a, "").toLocaleLowerCase();
i = m([2e3, t]);
n.push(this.monthsShort(i, ""));
o.push(this.months(i, ""));
a.push(this.months(i, ""));
a.push(this.monthsShort(i, ""));
n[t] = ne(n[t]);
o[t] = ne(o[t]);
this._monthsRegex = new RegExp("^(" + a.join("|") + ")", "i");
this._monthsShortRegex = this._monthsRegex;
this._monthsStrictRegex = new RegExp("^(" + o.join("|") + ")", "i");
this._monthsShortStrictRegex = new RegExp("^(" + n.join("|") + ")", "i");
a = m([2e3, 1]).day(n);
this._minWeekdaysParse[n] = this.weekdaysMin(a, "").toLocaleLowerCase();
this._shortWeekdaysParse[n] = this.weekdaysShort(a, "").toLocaleLowerCase();
this._weekdaysParse[n] = this.weekdays(a, "").toLocaleLowerCase();
i = m([2e3, 1]).day(t);
n = ne(this.weekdaysMin(i, ""));
o = ne(this.weekdaysShort(i, ""));
a = ne(this.weekdays(i, ""));
s.push(n);
r.push(o);
l.push(a);
c.push(n);
c.push(o);
c.push(a);
s.sort(e);
r.sort(e);
l.sort(e);
c.sort(e);
this._weekdaysRegex = new RegExp("^(" + c.join("|") + ")", "i");
this._weekdaysShortRegex = this._weekdaysRegex;
this._weekdaysMinRegex = this._weekdaysRegex;
this._weekdaysStrictRegex = new RegExp("^(" + l.join("|") + ")", "i");
this._weekdaysShortStrictRegex = new RegExp("^(" + r.join("|") + ")", "i");
this._weekdaysMinStrictRegex = new RegExp("^(" + s.join("|") + ")", "i");
a = ua._abbr;
o = n;
i(154)("./" + t);
ot(a);
C("defineLocaleOverride", "use moment.updateLocale(localeName, config) to change an existing locale. moment.defineLocale(localeName, config) should only be used for creating a new locale See http://momentjs.com/guides/#/warnings/define-locale/ for more info.");
n = fa[e]._config;
null != fa[e] && null != fa[e].parentLocale ? fa[e].set(S(fa[e]._config, t)) : (n = nt(e), null != n && (o = n._config), t = S(o, t), null == n && (t.abbr = e), i = new E(t), i.parentLocale = fa[e], fa[e] = i);
ot(e);
o = wa[t][0];
n = wa[t][2] !== !1;
e._f = o + (a || "") + (s || "");
Mt(e);
e._a = t;
e._tzm = ft(i[8], i[9], i[10]);
e._d = Me.apply(null, e._a);
e._d.setUTCMinutes(e._d.getUTCMinutes() - e._tzm);
g(e).rfc2822 = !0;
24 === e._a[jo] && 0 === e._a[Vo] && 0 === e._a[Xo] && 0 === e._a[Qo] && (e._nextDay = !0, e._a[jo] = 0);
e._d = (e._useUTC ? Me : be).apply(null, s);
o = e._useUTC ? e._d.getUTCDay() : e._d.getDay();
null != e._tzm && e._d.setUTCMinutes(e._d.getUTCMinutes() - e._tzm);
e._nextDay && (e._a[jo] = 24);
e._w && "undefined" != typeof e._w.d && e._w.d !== o && (g(e).weekdayMismatch = !0);
t = e._w;
null != t.GG || null != t.W || null != t.E ? (a = 1, s = 4, i = vt(t.GG, e._a[Uo], Ie(xt(), 1, 4).year), n = vt(t.W, 1), o = vt(t.E, 1), (o < 1 || o > 7) && (l = !0)) : (a = e._locale._week.dow, s = e._locale._week.doy, c = Ie(xt(), a, s), i = vt(t.gg, e._a[Uo], c.year), n = vt(t.w, c.week), null != t.d ? (o = t.d, (o < 0 || o > 6) && (l = !0)) : null != t.e ? (o = t.e + a, (t.e < 0 || t.e > 6) && (l = !0)) : o = a);
n < 1 || n > Ae(i, a, s) ? g(e)._overflowWeeks = !0 : null != l ? g(e)._overflowWeekday = !0 : (r = Ce(i, n, o, a, s), e._a[Uo] = r.year, e._dayOfYear = r.dayOfYear);
e._a = [];
g(e).empty = !0;
a = o[i];
n = (c.match(te(a, e)) || [])[0];
n && (s = c.substr(0, c.indexOf(n)), s.length > 0 && g(e).unusedInput.push(s), c = c.slice(c.indexOf(n) + n.length), u += n.length);
go[a] ? (n ? g(e).empty = !1 : g(e).unusedTokens.push(a), se(a, n, e)) : e._strict && !n && g(e).unusedTokens.push(a);
g(e).charsLeftOver = d - u;
c.length > 0 && g(e).unusedInput.push(c);
e._a[jo] <= 12 && g(e).bigHour === !0 && e._a[jo] > 0 && (g(e).bigHour = void 0);
g(e).parsedDateParts = e._a.slice(0);
g(e).meridiem = e._meridiem;
e._a[jo] = Tt(e._locale, e._a[jo], e._meridiem);
r = g(e).era;
null !== r && (e._a[Uo] = e._locale.erasConvertYear(r, e._a[Uo]));
wt(e);
ct(e);
a = 0;
s = !1;
t = y({}, e);
null != e._useUTC && (t._useUTC = e._useUTC);
t._f = e._f[o];
Mt(t);
_(t) && (s = !0);
a += g(t).charsLeftOver;
a += 10 * g(t).unusedTokens.length;
g(t).score = a;
r ? a < n && (n = a, i = t) : (null == n || a < n || s) && (n = a, i = t, s && (r = !0));
e._a = h([t.year, t.month, i, t.hour, t.minute, t.second, t.millisecond], function (e) {
  return e && parseInt(e, 10);
});
wt(e);
this._isValid = Dt(t);
this._milliseconds = +d + 1e3 * c + 6e4 * l + 1e3 * r * 60 * 60;
this._days = +s + 7 * a;
this._months = +o + 3 * n + 12 * i;
this._data = {};
this._locale = rt();
this._bubble();
i = a[t];
o = o || r(e, i);
i = a[t];
o = o || r(e, i);
i = this._d.valueOf();
i -= Di(i + (this._isUTC ? 0 : this.utcOffset() * Ba), ka);
i = this._d.valueOf();
i -= Di(i, Ba);
i = this._d.valueOf();
i -= Di(i, Pa);
i = this._d.valueOf();
i += ka - Di(i + (this._isUTC ? 0 : this.utcOffset() * Ba), ka) - 1;
i = this._d.valueOf();
i += Ba - Di(i, Ba) - 1;
i = this._d.valueOf();
i += Pa - Di(i, Pa) - 1;
a = t(s[n].since).startOf("day");
s[n].since = a.valueOf();
a = t(s[n].until).startOf("day").valueOf();
s[n].until = a.valueOf();
n.push(ne(s[e].name));
i.push(ne(s[e].abbr));
o.push(ne(s[e].narrow));
a.push(ne(s[e].name));
a.push(ne(s[e].abbr));
a.push(ne(s[e].narrow));
this._erasRegex = new RegExp("^(" + a.join("|") + ")", "i");
this._erasNameRegex = new RegExp("^(" + n.join("|") + ")", "i");
this._erasAbbrRegex = new RegExp("^(" + i.join("|") + ")", "i");
this._erasNarrowRegex = new RegExp("^(" + o.join("|") + ")", "i");
t.suppressDeprecationWarnings = !1;
t.deprecationHandler = null;
Wo = Array.prototype.indexOf ? Array.prototype.indexOf : function (e) {
  var t;
  for (t = 0; t < this.length; ++t) {
    if (this[t] === e) {
      return t;
    }
  }
  return -1;
};
L("M", ["MM", 2], "Mo", function () {
  return this.month() + 1;
});
L("MMM", 0, 0, function (e) {
  return this.localeData().monthsShort(this, e);
});
L("MMMM", 0, 0, function (e) {
  return this.localeData().months(this, e);
});
W("month", "M");
q("month", 8);
ee("M", No);
ee("MM", No, Io);
ee("MMM", function (e, t) {
  return t.monthsShortRegex(e);
});
ee("MMMM", function (e, t) {
  return t.monthsRegex(e);
});
oe(["M", "MM"], function (e, t) {
  t[qo] = X(e) - 1;
});
oe(["MMM", "MMMM"], function (e, t, i, n) {
  var o = i._locale.monthsParse(e, n, i._strict);
  null != o ? t[qo] = o : g(i).invalidMonth = e;
});
L("Y", 0, 0, function () {
  var e = this.year();
  return e <= 9999 ? x(e, 4) : "+" + e;
});
L(0, ["YY", 2], 0, function () {
  return this.year() % 100;
});
L(0, ["YYYY", 4], 0, "year");
L(0, ["YYYYY", 5], 0, "year");
L(0, ["YYYYYY", 6, !0], 0, "year");
W("year", "y");
q("year", 1);
ee("Y", Bo);
ee("YY", No, Io);
ee("YYYY", Ro, So);
ee("YYYYY", Do, Eo);
ee("YYYYYY", Do, Eo);
oe(["YYYYY", "YYYYYY"], Uo);
oe("YYYY", function (e, i) {
  i[Uo] = 2 === e.length ? t.parseTwoDigitYear(e) : X(e);
});
oe("YY", function (e, i) {
  i[Uo] = t.parseTwoDigitYear(e);
});
oe("Y", function (e, t) {
  t[Uo] = parseInt(e, 10);
});
t.parseTwoDigitYear = function (e) {
  return X(e) + (X(e) > 68 ? 1900 : 2e3);
};
L("w", ["ww", 2], "wo", "week");
L("W", ["WW", 2], "Wo", "isoWeek");
W("week", "w");
W("isoWeek", "W");
q("week", 5);
q("isoWeek", 5);
ee("w", No);
ee("ww", No, Io);
ee("W", No);
ee("WW", No, Io);
ae(["w", "ww", "W", "WW"], function (e, t, i, n) {
  t[n.substr(0, 1)] = X(e);
});
L("d", 0, "do", "day");
L("dd", 0, 0, function (e) {
  return this.localeData().weekdaysMin(this, e);
});
L("ddd", 0, 0, function (e) {
  return this.localeData().weekdaysShort(this, e);
});
L("dddd", 0, 0, function (e) {
  return this.localeData().weekdays(this, e);
});
L("e", 0, 0, "weekday");
L("E", 0, 0, "isoWeekday");
W("day", "d");
W("weekday", "e");
W("isoWeekday", "E");
q("day", 11);
q("weekday", 11);
q("isoWeekday", 11);
ee("d", No);
ee("e", No);
ee("E", No);
ee("dd", function (e, t) {
  return t.weekdaysMinRegex(e);
});
ee("ddd", function (e, t) {
  return t.weekdaysShortRegex(e);
});
ee("dddd", function (e, t) {
  return t.weekdaysRegex(e);
});
ae(["dd", "ddd", "dddd"], function (e, t, i, n) {
  var o = i._locale.weekdaysParse(e, n, i._strict);
  null != o ? t.d = o : g(i).invalidWeekday = e;
});
ae(["d", "e", "E"], function (e, t, i, n) {
  t[n] = X(e);
});
L("H", ["HH", 2], 0, "hour");
L("h", ["hh", 2], 0, Ve);
L("k", ["kk", 2], 0, Xe);
L("hmm", 0, 0, function () {
  return "" + Ve.apply(this) + x(this.minutes(), 2);
});
L("hmmss", 0, 0, function () {
  return "" + Ve.apply(this) + x(this.minutes(), 2) + x(this.seconds(), 2);
});
L("Hmm", 0, 0, function () {
  return "" + this.hours() + x(this.minutes(), 2);
});
L("Hmmss", 0, 0, function () {
  return "" + this.hours() + x(this.minutes(), 2) + x(this.seconds(), 2);
});
Qe("a", !0);
Qe("A", !1);
W("hour", "h");
q("hour", 13);
ee("a", Ke);
ee("A", Ke);
ee("H", No);
ee("h", No);
ee("k", No);
ee("HH", No, Io);
ee("hh", No, Io);
ee("kk", No, Io);
ee("hmm", xo);
ee("hmmss", Lo);
ee("Hmm", xo);
ee("Hmmss", Lo);
oe(["H", "HH"], jo);
oe(["k", "kk"], function (e, t, i) {
  var n = X(e);
  t[jo] = 24 === n ? 0 : n;
});
oe(["a", "A"], function (e, t, i) {
  i._isPm = i._locale.isPM(e);
  i._meridiem = e;
});
oe(["h", "hh"], function (e, t, i) {
  t[jo] = X(e);
  g(i).bigHour = !0;
});
oe("hmm", function (e, t, i) {
  var n = e.length - 2;
  t[jo] = X(e.substr(0, n));
  t[Vo] = X(e.substr(n));
  g(i).bigHour = !0;
});
oe("hmmss", function (e, t, i) {
  var n = e.length - 4,
    o = e.length - 2;
  t[jo] = X(e.substr(0, n));
  t[Vo] = X(e.substr(n, 2));
  t[Xo] = X(e.substr(o));
  g(i).bigHour = !0;
});
oe("Hmm", function (e, t, i) {
  var n = e.length - 2;
  t[jo] = X(e.substr(0, n));
  t[Vo] = X(e.substr(n));
});
oe("Hmmss", function (e, t, i) {
  var n = e.length - 4,
    o = e.length - 2;
  t[jo] = X(e.substr(0, n));
  t[Vo] = X(e.substr(n, 2));
  t[Xo] = X(e.substr(o));
});
i._isPm = i._locale.isPM(e);
i._meridiem = e;
t[jo] = X(e);
g(i).bigHour = !0;
t[jo] = X(e.substr(0, n));
t[Vo] = X(e.substr(n));
g(i).bigHour = !0;
t[jo] = X(e.substr(0, n));
t[Vo] = X(e.substr(n, 2));
t[Xo] = X(e.substr(o));
g(i).bigHour = !0;
t[jo] = X(e.substr(0, n));
t[Vo] = X(e.substr(n));
t[jo] = X(e.substr(0, n));
t[Vo] = X(e.substr(n, 2));
t[Xo] = X(e.substr(o));
t.createFromInputFallback = T("value provided is not in a recognized RFC2822 or ISO format. moment construction falls back to js Date(), which is not reliable across all browsers and versions. Non RFC2822/ISO date formats are discouraged. Please refer to http://momentjs.com/guides/#/warnings/js-date/ for more info.", function (e) {
  e._d = new Date(e._i + (e._useUTC ? " UTC" : ""));
});
t.ISO_8601 = function () {};
t.RFC_2822 = function () {};
Wt("Z", ":");
Wt("ZZ", "");
ee("Z", Fo);
ee("ZZ", Fo);
oe(["Z", "ZZ"], function (e, t, i) {
  i._useUTC = !0;
  i._tzm = Gt(Fo, e);
});
i._useUTC = !0;
i._tzm = Gt(Fo, e);
ii.fn = kt.prototype;
ii.invalid = Bt;
t.defaultFormat = "YYYY-MM-DDTHH:mm:ssZ";
t.defaultFormatUtc = "YYYY-MM-DDTHH:mm:ss[Z]";
L("N", 0, 0, "eraAbbr");
L("NN", 0, 0, "eraAbbr");
L("NNN", 0, 0, "eraAbbr");
L("NNNN", 0, 0, "eraName");
L("NNNNN", 0, 0, "eraNarrow");
L("y", ["y", 1], "yo", "eraYear");
L("y", ["yy", 2], 0, "eraYear");
L("y", ["yyy", 3], 0, "eraYear");
L("y", ["yyyy", 4], 0, "eraYear");
ee("N", sn);
ee("NN", sn);
ee("NNN", sn);
ee("NNNN", rn);
ee("NNNNN", ln);
oe(["N", "NN", "NNN", "NNNN", "NNNNN"], function (e, t, i, n) {
  var o = i._locale.erasParse(e, n, i._strict);
  o ? g(i).era = o : g(i).invalidEra = e;
});
ee("y", Po);
ee("yy", Po);
ee("yyy", Po);
ee("yyyy", Po);
ee("yo", cn);
oe(["y", "yy", "yyy", "yyyy"], Uo);
oe(["yo"], function (e, t, i, n) {
  var o;
  i._locale._eraYearOrdinalRegex && (o = e.match(i._locale._eraYearOrdinalRegex));
  i._locale.eraYearOrdinalParse ? t[Uo] = i._locale.eraYearOrdinalParse(e, o) : t[Uo] = parseInt(e, 10);
});
L(0, ["gg", 2], 0, function () {
  return this.weekYear() % 100;
});
L(0, ["GG", 2], 0, function () {
  return this.isoWeekYear() % 100;
});
un("gggg", "weekYear");
un("ggggg", "weekYear");
un("GGGG", "isoWeekYear");
un("GGGGG", "isoWeekYear");
W("weekYear", "gg");
W("isoWeekYear", "GG");
q("weekYear", 1);
q("isoWeekYear", 1);
ee("G", Bo);
ee("g", Bo);
ee("GG", No, Io);
ee("gg", No, Io);
ee("GGGG", Ro, So);
ee("gggg", Ro, So);
ee("GGGGG", Do, Eo);
ee("ggggg", Do, Eo);
ae(["gggg", "ggggg", "GGGG", "GGGGG"], function (e, t, i, n) {
  t[n.substr(0, 2)] = X(e);
});
ae(["gg", "GG"], function (e, i, n, o) {
  i[o] = t.parseTwoDigitYear(e);
});
L("Q", 0, "Qo", "quarter");
W("quarter", "Q");
q("quarter", 7);
ee("Q", Co);
oe("Q", function (e, t) {
  t[qo] = 3 * (X(e) - 1);
});
L("D", ["DD", 2], "Do", "date");
W("date", "D");
q("date", 9);
ee("D", No);
ee("DD", No, Io);
ee("Do", function (e, t) {
  return e ? t._dayOfMonthOrdinalParse || t._ordinalParse : t._dayOfMonthOrdinalParseLenient;
});
oe(["D", "DD"], Yo);
oe("Do", function (e, t) {
  t[Yo] = X(e.match(No)[0]);
});
i._locale._eraYearOrdinalRegex && (o = e.match(i._locale._eraYearOrdinalRegex));
i._locale.eraYearOrdinalParse ? t[Uo] = i._locale.eraYearOrdinalParse(e, o) : t[Uo] = parseInt(e, 10);
L("DDD", ["DDDD", 3], "DDDo", "dayOfYear");
W("dayOfYear", "DDD");
q("dayOfYear", 4);
ee("DDD", Oo);
ee("DDDD", Ao);
oe(["DDD", "DDDD"], function (e, t, i) {
  i._dayOfYear = X(e);
});
L("m", ["mm", 2], 0, "minute");
W("minute", "m");
q("minute", 14);
ee("m", No);
ee("mm", No, Io);
oe(["m", "mm"], Vo);
L("s", ["ss", 2], 0, "second");
W("second", "s");
q("second", 15);
ee("s", No);
ee("ss", No, Io);
oe(["s", "ss"], Xo);
L("S", 0, 0, function () {
  return ~~(this.millisecond() / 100);
});
L(0, ["SS", 2], 0, function () {
  return ~~(this.millisecond() / 10);
});
L(0, ["SSS", 3], 0, "millisecond");
L(0, ["SSSS", 4], 0, function () {
  return 10 * this.millisecond();
});
L(0, ["SSSSS", 5], 0, function () {
  return 100 * this.millisecond();
});
L(0, ["SSSSSS", 6], 0, function () {
  return 1e3 * this.millisecond();
});
L(0, ["SSSSSSS", 7], 0, function () {
  return 1e4 * this.millisecond();
});
L(0, ["SSSSSSSS", 8], 0, function () {
  return 1e5 * this.millisecond();
});
L(0, ["SSSSSSSSS", 9], 0, function () {
  return 1e6 * this.millisecond();
});
W("millisecond", "ms");
q("millisecond", 16);
ee("S", Oo, Co);
ee("SS", Oo, Io);
ee("SSS", Oo, Ao);
Ua = Q("Milliseconds", !1);
L("z", 0, 0, "zoneAbbr");
L("zz", 0, 0, "zoneName");
qa.add = Oa;
qa.calendar = mi;
qa.clone = fi;
qa.diff = Mi;
qa.endOf = Fi;
qa.format = Si;
qa.from = Ei;
qa.fromNow = Ni;
qa.to = xi;
qa.toNow = Li;
qa.get = Z;
qa.invalidAt = Vi;
qa.isAfter = gi;
qa.isBefore = _i;
qa.isBetween = vi;
qa.isSame = yi;
qa.isSameOrAfter = wi;
qa.isSameOrBefore = bi;
qa.isValid = Yi;
qa.lang = Da;
qa.locale = Oi;
qa.localeData = Ri;
qa.max = Aa;
qa.min = Ia;
qa.parsingFlags = ji;
qa.set = $;
qa.startOf = ki;
qa.subtract = Ra;
qa.toArray = Gi;
qa.toObject = Ui;
qa.toDate = Wi;
qa.toISOString = Ii;
qa.inspect = Ai;
"undefined" != typeof Symbol && null != Symbol["for"] && (qa[Symbol["for"]("nodejs.util.inspect.custom")] = function () {
  return "Moment<" + this.format() + ">";
});
qa.toJSON = qi;
qa.toString = Ci;
qa.unix = zi;
qa.valueOf = Hi;
qa.creationData = Xi;
qa.eraName = Zi;
qa.eraNarrow = $i;
qa.eraAbbr = en;
qa.eraYear = tn;
qa.year = na;
qa.isLeapYear = we;
qa.weekYear = hn;
qa.isoWeekYear = pn;
qa.quarter = qa.quarters = wn;
qa.month = me;
qa.daysInMonth = fe;
qa.week = qa.weeks = xe;
qa.isoWeek = qa.isoWeeks = Le;
qa.weeksInYear = gn;
qa.weeksInWeekYear = _n;
qa.isoWeeksInYear = mn;
qa.isoWeeksInISOWeekYear = fn;
qa.date = Ha;
qa.day = qa.days = ze;
qa.weekday = We;
qa.isoWeekday = Ge;
qa.dayOfYear = bn;
qa.hour = qa.hours = pa;
qa.minute = qa.minutes = za;
qa.second = qa.seconds = Wa;
qa.millisecond = qa.milliseconds = Ua;
qa.utcOffset = Yt;
qa.utc = Vt;
qa.local = Xt;
qa.parseZone = Qt;
qa.hasAlignedHourOffset = Kt;
qa.isDST = Jt;
qa.isLocal = $t;
qa.isUtcOffset = ei;
qa.isUtc = ti;
qa.isUTC = ti;
qa.zoneAbbr = Tn;
qa.zoneName = Cn;
qa.dates = T("dates accessor is deprecated. Use date instead.", Ha);
qa.months = T("months accessor is deprecated. Use month instead", me);
qa.years = T("years accessor is deprecated. Use year instead", na);
qa.zone = T("moment().zone is deprecated, use moment().utcOffset instead. http://momentjs.com/guides/#/warnings/zone/", jt);
qa.isDSTShifted = T("isDSTShifted is deprecated. See http://momentjs.com/guides/#/warnings/dst-shifted/ for more information", Zt);
Ya.calendar = N;
Ya.longDateFormat = B;
Ya.invalidDate = k;
Ya.ordinal = F;
Ya.preparse = Sn;
Ya.postformat = Sn;
Ya.relativeTime = H;
Ya.pastFuture = z;
Ya.set = A;
Ya.eras = Qi;
Ya.erasParse = Ki;
Ya.erasConvertYear = Ji;
Ya.erasAbbrRegex = on;
Ya.erasNameRegex = nn;
Ya.erasNarrowRegex = an;
Ya.months = ce;
Ya.monthsShort = de;
Ya.monthsParse = he;
Ya.monthsRegex = _e;
Ya.monthsShortRegex = ge;
Ya.week = Se;
Ya.firstDayOfYear = Ne;
Ya.firstDayOfWeek = Ee;
Ya.weekdays = Pe;
Ya.weekdaysMin = ke;
Ya.weekdaysShort = Be;
Ya.weekdaysParse = He;
Ya.weekdaysRegex = Ue;
Ya.weekdaysShortRegex = qe;
Ya.weekdaysMinRegex = Ye;
Ya.isPM = Je;
Ya.meridiem = Ze;
ot("en", {
  eras: [{
    since: "0001-01-01",
    until: +(1 / 0),
    offset: 1,
    name: "Anno Domini",
    narrow: "AD",
    abbr: "AD"
  }, {
    since: "0000-12-31",
    until: -(1 / 0),
    offset: 1,
    name: "Before Christ",
    narrow: "BC",
    abbr: "BC"
  }],
  dayOfMonthOrdinalParse: /\d{1,2}(th|st|nd|rd)/,
  ordinal: function (e) {
    var t = e % 10,
      i = 1 === X(e % 100 / 10) ? "th" : 1 === t ? "st" : 2 === t ? "nd" : 3 === t ? "rd" : "th";
    return e + i;
  }
});
t.lang = T("moment.lang is deprecated. Use moment.locale instead.", ot);
t.langData = T("moment.langData is deprecated. Use moment.localeData instead.", rt);
n.keys = function () {
  return Object.keys(a);
};
n.resolve = o;
e.exports = n;
n.id = 154;
this._highLightsListCb = null;
t.on("shopHighLightsListSuccess", function (e) {
  i._highLightsListCb(null, e.popups);
  i._highLightsListCb = null;
});
t.on("shopHighLightsListError", function () {
  i._highLightsListCb(new Error("shopHighLightsListError"));
  i._highLightsListCb = null;
});
i._highLightsListCb(null, e.popups);
i._highLightsListCb = null;
i._highLightsListCb(new Error("shopHighLightsListError"));
i._highLightsListCb = null;
e.exports = n;
o(n, a);
n.prototype.describe = function () {
  return this.formatHaapiPaths("Ankama/Shop", {});
};
n.prototype.type = {
  IMAGE: "IMAGE",
  CAROUSEL: "CAROUSEL",
  POPUP: "POPUP"
};
n.prototype.getHighLightsList = function (e, t, i, n) {
  if (!this._highLightsListCb) {
    var o = "shopHighLightsListRequest";
    this._highLightsListCb = n;
    var a = {
      type: i
    };
    e(o, a);
  }
};
s.call(this, e);
this._haapiConfig = t;
this._timeManager = n;
this._eventFlushMs = 1e3;
this._eventFlushRetries = 4;
this._fetchFnForEvents = i;
this._paths = {
  sendEvents: "/Ankama/v5/Game/SendEvents"
};
this._stack = {
  current: [],
  buffer: []
};
this._lastTimestamp = 0;
this._cbs = {
  current: [],
  buffer: []
};
this._eventsProcessing = !1;
this._nextTimeout = 0;
e.exports = n;
o(n, s);
n.prototype._next = function (e) {
  var t = this,
    i = this._timeManager.now(),
    n = i - this._lastTimestamp;
  if (!this._nextTimeout) {
    if (n <= this._eventFlushMs) {
      var o = this._eventFlushMs - n + 10;
      return void (this._nextTimeout = setTimeout(function () {
        t._nextTimeout = 0;
        t._next(e);
      }, o));
    }
    this._stack.current.length <= 0 || n > this._eventFlushMs && (this._flushEvents(e), this._lastTimestamp = i);
  }
};
n.prototype._flushEvents = function (e) {
  var t = a.operation({
    retries: this._eventFlushRetries,
    randomize: !0
  });
  this._eventsProcessing = !0;
  var i = this,
    n = this._haapiConfig.getBaseUrl() + this._paths.sendEvents,
    o = null,
    s = "";
  try {
    s = JSON.stringify(this._stack.current);
  } catch (r) {
    o = r;
    s = "";
  }
  if (this._stack.current = [], o) {
    return void this._callbackAndLeave(o, e);
  }
  var l = {
    game: this._haapiConfig.getGameId(),
    session_id: e,
    events: s
  };
  t.attempt(function () {
    i._fetchFnForEvents(n, l, function (o) {
      return t.retry(o) ? void i._logger.warning("sendEvents: on the url", n, "will retry...") : o ? i._callbackAndLeave(t.mainError(), e) : i._callbackAndLeave(null, e);
    });
  });
};
n.prototype._callbackAndLeave = function (e, t) {
  this._cbs.current.length > 0 && (this._cbs.current.forEach(function (t) {
    return t(e);
  }), this._cbs.current = []);
  this._stack.buffer.length > 0 ? (this._stack.current = this._stack.buffer, this._stack.buffer = [], this._cbs.current = this._cbs.buffer, this._cbs.buffer = [], this._eventsProcessing = !1, this._nextTimeout || this._next(t)) : this._eventsProcessing = !1;
};
n.prototype._addEventToStack = function (e, t, i) {
  this._eventsProcessing ? (this._stack.buffer.push(t), this._cbs.buffer.push(i)) : (this._stack.current.push(t), this._cbs.current.push(i));
  this._next(e);
};
n.prototype.describe = function () {
  return this.formatHaapiPaths("Ankama/Game", this._paths);
};
n.prototype.setEventFlushMs = function (e) {
  this._eventFlushMs = e;
};
n.prototype.setRetries = function (e) {
  this._eventFlushRetries = e;
};
n.prototype.sendEvent = function (e, t, i, n, o) {
  this._addEventToStack(e, {
    event_id: t,
    data: i || {},
    date: n
  }, o);
};
t._nextTimeout = 0;
t._next(e);
o = r;
s = "";
this._cbs.current.length > 0 && (this._cbs.current.forEach(function (t) {
  return t(e);
}), this._cbs.current = []);
this._stack.buffer.length > 0 ? (this._stack.current = this._stack.buffer, this._stack.buffer = [], this._cbs.current = this._cbs.buffer, this._cbs.buffer = [], this._eventsProcessing = !1, this._nextTimeout || this._next(t)) : this._eventsProcessing = !1;
this._eventsProcessing ? (this._stack.buffer.push(t), this._cbs.buffer.push(i)) : (this._stack.current.push(t), this._cbs.current.push(i));
this._next(e);
this._gameId = i.id;
this._hostname = i.hostname;
this._gameId && this._hostname || (e.error(new Error("Config malformed")), this._gameId || (this._gameId = 0), this._hostname || (this._hostname = ""));
e.exports = i;
i.prototype.getGameId = function () {
  return this._gameId;
};
i.prototype.getHostname = function () {
  return this._hostname;
};
i.prototype.getBaseUrl = function () {
  return n + "://haapi." + this._hostname + "/json";
};
i(299);
i(300);
i(301);
i(302);
i(303);
i(304);
i(305);
i(308);
i(309);
i(310);
i(311);
i(312);
i(313);
i(314);
i(315);
i(316);
i(317);
i(318);
i(319);
i(320);
i(321);
i(321);
i(322);
i(323);
i(324);
i(325);
i(326);
i(327);
i(328);
i(329);
i(330);
i(331);
i(332);
i(333);
i(334);
i(335);
i(336);
i(337);
i(338);
i(339);
i(340);
i(341);
i(342);
i(343);
i(344);
i(345);
i(346);
i(347);
i(348);
i(350);
i(351);
i(352);
i(353);
i(354);
i(355);
i(356);
i(357);
i(358);
i(359);
i(360);
i(361);
i(362);
i(363);
i(364);
i(365);
i(366);
i(367);
i(368);
i(369);
i(370);
i(371);
i(372);
i(373);
i(374);
i(375);
i(376);
i(377);
i(378);
n.on("ConsoleMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ConsoleCommandsListMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("IdentificationSuccessMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("IdentificationSuccessWithLoginTokenMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ServersListMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ServerStatusUpdateMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("SelectedServerRefusedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AuthenticationTicketAcceptedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("NicknameRegistrationMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("NicknameRefusedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("NicknameAcceptedMessage", function (e) {
  window.gui.transmitMessage(e);
});
s.on("DebugHighlightCellsMessage", function (e) {
  for (var t = {}, i = 0, s = 0; s < e.cells.length; s++) {
    var l = e.cells[s];
    t[l] = new o(l, i, a.fullRed);
  }
  n();
  r = window.background.addGridAnimation(t);
  window.setTimeout(function () {
    n();
  }, 5e3);
});
s.on("DebugClearHighlightCellsMessage", function () {
  n();
});
s.on("DebugInClientMessage", function (e) {
  window.gui.transmitMessage(e);
});
n();
r = window.background.addGridAnimation(t);
window.setTimeout(function () {
  n();
}, 5e3);
this.cellId = e;
this.distanceToPlayer = t;
this.transformState = i;
this.sx = e;
this.sy = t;
this.r = i;
this.g = n;
this.b = o;
this.a = a;
t.empty = new i(.1, .1, .5, .5, .5, 0);
t.fullRed = new i(.78, .78, .8, .12, .08, .8);
t.fullGreen = new i(.78, .78, 0, 1, .22, .7);
t.fullBlue = new i(.78, .78, 0, .51, .91, .8);
t.walkable = new i(.9, .9, 1, .92, 0, .5);
t.unwalkable = new i(.9, .9, .9, 0, 0, .8);
t.walkableLast = new i(.9, .9, 1, 1, 0, .8);
t.inSight = new i(.78, .78, 0, 0, 1, .5);
t.outSight = new i(.78, .78, .6, .6, 1, .5);
t.areaOfEffect = new i(.78, .78, 1, 0, 0, .9);
t.inSightEnemyTurn = new i(.78, .78, .3, .3, .3, .8);
t.outSightEnemyTurn = new i(.78, .78, .5, .5, .5, .7);
t.areaOfEffectEnemyTurn = new i(.78, .78, 1, 1, 1, 1);
t.blueTeamStart = new i(1, 1, 0, 0, 1, .5);
t.blueTeamEnd = new i(.95, 1, .1, .4, .8, .45);
t.redTeamStart = new i(1, 1, 1, 0, 0, .5);
t.redTeamEnd = new i(.95, 1, .8, .4, .1, .45);
t.walkArea = new i(1, 1, 0, .9, .02, .3);
t.walkAreaRequiresAP = new i(1, 1, 0, .43, .4, .4);
t.walkAreaRestricted = new i(1, 1, 1, 0, 0, .4);
t.enemyWalkArea = new i(1, 1, .1, .9, .032, .6);
t.enemyWalkAreaRequiresAP = new i(1, 1, .1, .435, .4, .6);
t.enemyWalkAreaRestricted = new i(.9, .9, 1, 0, 0, .6);
t.TransformState = i;
n.on("AchievementListMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AchievementDetailsMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AchievementDetailedListMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AchievementFinishedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AchievementRewardSuccessMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AchievementRewardErrorMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GameActionFightNoSpellCastMessage", function (e) {
  window.isoEngine.sendToFightSequence(e);
});
n.on("GameActionFightPointsVariationMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GameActionFightDeathMessage", function (e) {
  window.isoEngine.transmitMessage(e);
});
n.on("GameActionFightKillMessage", function (e) {
  window.isoEngine.transmitMessage(e);
});
n.on("GameActionFightLifePointsGainMessage", function (e) {
  window.isoEngine.transmitMessage(e);
});
n.on("GameActionFightLifePointsLostMessage", function (e) {
  window.isoEngine.transmitMessage(e);
});
n.on("GameActionFightLifeAndShieldPointsLostMessage", function (e) {
  window.isoEngine.transmitMessage(e);
});
n.on("GameActionFightDispellableEffectMessage", function (e) {
  console.error("GameActionFightDispellableEffectMessage received outside of sequence:", e);
});
n.on("GameActionFightSlideMessage", function (e) {
  window.actorManager.actorMovement({
    actorId: e.targetId,
    keyMovements: [e.startCellId, e.endCellId],
    slide: !0
  });
});
n.on("GameActionFightTeleportOnSameMapMessage", function (e) {
  window.actorManager.setActorsDisposition([{
    id: e.targetId,
    cellId: e.cellId
  }]);
});
n.on("GameActionFightExchangePositionsMessage", function (e) {
  window.actorManager.setActorsDisposition([{
    id: e.sourceId,
    cellId: e.casterCellId
  }, {
    id: e.targetId,
    cellId: e.targetCellId
  }]);
});
n.on("GameActionFightSummonMessage", function (e) {
  window.actorManager.addActor(e.summon);
});
window.isoEngine.transmitMessage(e);
window.gui.emit("checkServerLag", "fightAction", "stop");
n.on("AllianceCreationStartedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AllianceModificationStartedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AllianceCreationResultMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AllianceInvitedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AllianceInvitationStateRecruterMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AllianceInvitationStateRecrutedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AllianceJoinedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AllianceGuildLeavingMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AllianceLeftMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AllianceMembershipMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("KohUpdateMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AllianceFactsErrorMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AllianceFactsMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AllianceInsiderInfoMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AccountLoggingKickedMessage", function () {
  window.gui.disconnect("AccountLoggingKickedMessage");
  window.isoEngine.disconnect();
});
n.on("ServerSettingsMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ServerSessionConstantsMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ServerOptionalFeaturesMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AccountCapabilitiesMessage", function (e) {
  window.gui.transmitMessage(e);
});
window.gui.disconnect("AccountLoggingKickedMessage");
window.isoEngine.disconnect();
n.on("CompassResetMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("CompassUpdateMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("CompassUpdatePartyMemberMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("BasicTimeMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("BasicWhoIsNoMatchMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("send:login", function () {
  o = 0;
});
n.on("SequenceNumberRequestMessage", function () {
  o += 1;
  n.sendMessage("SequenceNumberMessage", {
    number: o
  });
});
o += 1;
n.sendMessage("SequenceNumberMessage", {
  number: o
});
n.on("CharacterCreationResultMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("CharacterNameSuggestionSuccessMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("CharacterNameSuggestionFailureMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("FighterStatsListMessage", function (e) {
  window.isoEngine.sendToFightSequence(e);
});
n.on("CharacterLevelUpMessage", function (e) {
  window.gui.transmitMessage(e);
  window.isoEngine.playLevelUpAnimation(window.gui.playerData.id);
});
n.on("CharacterLevelUpInformationMessage", function (e) {
  var t = e.id;
  t !== window.gui.playerData.id && window.isoEngine.playLevelUpAnimation(t);
});
n.on("UpdateLifePointsMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("LifePointsRegenBeginMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("LifePointsRegenEndMessage", function (e) {
  window.gui.transmitMessage(e);
});
window.gui.transmitMessage(e);
window.isoEngine.playLevelUpAnimation(window.gui.playerData.id);
n.on("ChatSmileyMessage", function (e) {
  window.gui.playerData.socialData.isIgnored(e.accountId) || window.actorManager.addSmileyOnActor(e.entityId, e.smileyId);
});
n.on("MoodSmileyResultMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("MoodSmileyUpdateMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GameContextDestroyMessage", function (e) {
  window.isoEngine.transmitMessage(e);
  window.actorManager.resetActors();
  window.gui.transmitMessage(e);
});
n.on("GameContextRemoveElementMessage", function (e) {
  window.actorManager.removeActor(e.id);
});
n.on("GameContextRemoveMultipleElementsMessage", function (e) {
  window.actorManager.removeActors(e.id);
});
n.on("GameContextRemoveElementWithEventMessage", function (e) {
  window.actorManager.removeActor(e.id);
});
n.on("GameContextRemoveMultipleElementsWithEventsMessage", function (e) {
  window.actorManager.removeActors(e.id);
});
n.on("GameContextRefreshEntityLookMessage", function (e) {
  window.actorManager.setActorLook(e.id, e.look, {}, null);
  window.gui.transmitMessage(e);
});
n.on("GameMapNoMovementMessage", function () {
  window.isoEngine.noMovement();
});
n.on("GameMapMovementMessage", function (e) {
  window.actorManager.actorMovement(e);
});
n.on("GameMapChangeOrientationMessage", function (e) {
  window.actorManager.setActorsDisposition([e.orientation]);
});
n.on("GameMapChangeOrientationsMessage", function (e) {
  window.actorManager.setActorsDisposition(e.orientations);
});
n.on("GameEntityDispositionMessage", function (e) {
  window.actorManager.setActorsDisposition([e.disposition]);
});
n.on("GameEntitiesDispositionMessage", function (e) {
  window.actorManager.setActorsDisposition(e.dispositions, !0);
});
n.on("ShowCellMessage", function (e) {
  var t = {},
    i = 0;
  t[e.cellId] = new o(e.cellId, i, a.fullRed);
  var n = window.background.addGridAnimation(t);
  window.setTimeout(function () {
    window.background.removeGridLayer(n);
  }, 5e3);
});
n.on("ShowCellSpectatorMessage", function (e) {
  for (var t = {}, i = 0, n = 0; n < e.cells.length; n++) {
    var s = e.cells[n];
    t[s] = new o(s, i, a.fullRed);
  }
  var r = window.background.addGridAnimation(t);
  window.setTimeout(function () {
    window.background.removeGridLayer(r);
  }, 5e3);
});
window.isoEngine.transmitMessage(e);
window.actorManager.resetActors();
window.gui.transmitMessage(e);
window.actorManager.setActorLook(e.id, e.look, {}, null);
window.gui.transmitMessage(e);
o.on("DisplayNumericalValueMessage", n);
o.on("DisplayNumericalValueWithAgeBonusMessage", n);
window.gui.transmitMessage(e);
window.isoEngine.transmitMessage(e);
o.on("GameFightStartingMessage", function (e) {
  window.gui.transmitMessage(e);
});
o.on("GameFightJoinMessage", function (e) {
  window.isoEngine.transmitMessage(e);
  window.gui.transmitMessage(e);
});
o.on("GameFightPlacementPossiblePositionsMessage", function (e) {
  window.isoEngine.displayFightPositions(e);
  window.gui.transmitMessage(e);
});
o.on("GameFightOptionStateUpdateMessage", function (e) {
  window.isoEngine.challengeOptionChange(e.fightId, e.teamId, e.option, e.state);
  window.gui.transmitMessage(e);
});
o.on("GameFightUpdateTeamMessage", function (e) {
  window.isoEngine.updateFightTeam(e);
  window.gui.transmitMessage(e);
});
o.on("GameFightRemoveTeamMemberMessage", function (e) {
  window.gui.transmitMessage(e);
});
o.on("GameFightHumanReadyStateMessage", function (e) {
  window.gui.transmitMessage(e);
});
o.on("GameFightLeaveMessage", function (e) {
  window.isoEngine.transmitMessage(e);
});
o.on("GameFightStartMessage", function (e) {
  window.gui.transmitMessage(e);
  window.isoEngine.transmitMessage(e);
});
o.on("GameFightSpectateMessage", n);
o.on("GameFightResumeMessage", n);
o.on("GameFightResumeWithSlavesMessage", n);
o.on("GameFightEndMessage", function (e) {
  window.isoEngine.transmitMessage(e);
});
o.on("GameFightNewRoundMessage", function (e) {
  window.gui.transmitMessage(e);
});
o.on("GameFightTurnListMessage", function (e) {
  window.gui.transmitMessage(e);
});
o.on("GameFightTurnStartMessage", function (e) {
  window.gui.transmitMessage(e);
});
o.on("GameFightTurnStartPlayingMessage", function (e) {
  window.gui.transmitMessage(e);
});
o.on("GameFightTurnResumeMessage", function (e) {
  window.gui.transmitMessage(e);
});
o.on("GameFightTurnStartSlaveMessage", function (e) {
  window.gui.transmitMessage(e);
});
o.on("GameFightTurnReadyRequestMessage", function (e) {
  window.isoEngine.transmitMessage(e);
});
o.on("GameFightSynchronizeMessage", function (e) {
  window.isoEngine.transmitMessage(e);
});
o.on("GameFightTurnEndMessage", function (e) {
  window.gui.transmitMessage(e);
});
window.isoEngine.transmitMessage(e);
window.gui.transmitMessage(e);
window.isoEngine.displayFightPositions(e);
window.gui.transmitMessage(e);
window.isoEngine.challengeOptionChange(e.fightId, e.teamId, e.option, e.state);
window.gui.transmitMessage(e);
window.isoEngine.updateFightTeam(e);
window.gui.transmitMessage(e);
window.gui.transmitMessage(e);
window.isoEngine.transmitMessage(e);
n.on("ChallengeInfoMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ChallengeResultMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GameFightShowFighterMessage", function (e) {
  window.gui.transmitMessage(e);
  e.informations.alive ? window.actorManager.addActor(e.informations) : window.actorManager.userActor.actorId === e.informations.contextualId && window.actorManager.userActor.loadAndPlayAnimation({
    base: "AnimMort"
  }, {
    loop: !1
  }, function () {
    window.actorManager.userActor.death();
  });
});
n.on("GameFightRefreshFighterMessage", function (e) {
  window.gui.transmitMessage(e);
  window.actorManager.refreshFighter(e);
});
n.on("GameFightShowFighterRandomStaticPoseMessage", function (e) {
  window.gui.transmitMessage(e);
  window.actorManager.addActor(e.informations);
});
window.gui.transmitMessage(e);
e.informations.alive ? window.actorManager.addActor(e.informations) : window.actorManager.userActor.actorId === e.informations.contextualId && window.actorManager.userActor.loadAndPlayAnimation({
  base: "AnimMort"
}, {
  loop: !1
}, function () {
  window.actorManager.userActor.death();
});
window.gui.transmitMessage(e);
window.actorManager.refreshFighter(e);
window.gui.transmitMessage(e);
window.actorManager.addActor(e.informations);
o.on("MountEmoteIconUsedOkMessage", function (e) {
  var t = window.actorManager.getActor(e.mountId);
  if (t) {
    var i,
      n = e.reactionType;
    switch (n) {
      case 1:
        i = "AnimEmoteRest_Statique_0";
        break;
      case 2:
        i = "AnimAttaque0";
        break;
      case 3:
        i = "AnimEmoteCaresse";
        break;
      case 4:
        i = "AnimEmoteReproductionF";
        break;
      case 5:
        i = "AnimEmoteReproductionM";
        break;
      default:
        return;
    }
    t.loadAndPlayAnimation({
      base: i
    }, {
      loop: !1
    });
  }
});
window.connectionManager = o;
o.on("GameDataPaddockObjectAddMessage", function (e) {
  n(e.paddockItemDescription);
});
o.on("GameDataPaddockObjectListAddMessage", function (e) {
  for (var t = e.paddockItemDescription, i = 0; i < t.length; i++) {
    n(t[i]);
  }
});
o.on("GameDataPaddockObjectRemoveMessage", function (e) {
  window.actorManager.removeActor("paddockItem:" + e.cellId);
});
n.on("NotificationListMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("NotificationByServerMessage", function (e) {
  console.info("NotificationByServerMessage: ", "id:" + e.id, e.parameters);
});
window.gui.transmitMessage(e);
s === e.mapId ? window.isoEngine.reloadMap(e) : (o.lockMessages(), window.isoEngine.loadMap(e));
s = e.mapId;
o.on("disconnect", function () {
  s = null;
});
o.on("CurrentMapMessage", function (e) {
  o.sendMessage("MapInformationsRequestMessage", {
    mapId: e.mapId
  });
  e.mapId !== s && (window.foreground.lock("loadMap"), window.gui.transmitMessage(e), a.release());
});
o.on("TeleportOnSameMapMessage", function (e) {
  window.actorManager.setActorsDisposition([{
    id: e.targetId,
    cellId: e.cellId
  }]);
});
o.on("MapFightCountMessage", function (e) {
  window.gui.transmitMessage(e);
});
o.on("MapRunningFightListMessage", function (e) {
  window.gui.transmitMessage(e);
});
o.on("MapRunningFightDetailsMessage", function (e) {
  window.gui.transmitMessage(e);
});
o.on("MapObstacleUpdateMessage", function (e) {
  window.isoEngine.updateObstacles(e.obstacles);
});
o.on("MapComplementaryInformationsDataMessage", n);
o.on("MapComplementaryInformationsDataInHouseMessage", n);
o.on("MapComplementaryInformationsWithCoordsMessage", n);
o.on("MapComplementaryInformationsWithObstacleOverride", n);
o.on("GameRolePlayShowActorMessage", function (e) {
  window.actorManager.addActor(e.informations);
});
o.sendMessage("MapInformationsRequestMessage", {
  mapId: e.mapId
});
e.mapId !== s && (window.foreground.lock("loadMap"), window.gui.transmitMessage(e), a.release());
n.on("GameRolePlayPlayerLifeStatusMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GameRolePlayGameOverMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("EmoteListMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("EmoteAddMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("EmoteRemoveMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("EmotePlayMessage", function (e) {
  window.isoEngine.playEmote(e);
});
n.on("EmotePlayRelookedMessage", function (e) {
  window.isoEngine.playRelookedEmote(e);
});
n.on("GameRolePlayAggressionMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GameRolePlayPlayerFightFriendlyRequestedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GameRolePlayPlayerFightFriendlyAnsweredMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GameRolePlayShowChallengeMessage", function (e) {
  window.isoEngine.showChallenge(e.commonsInfos);
});
n.on("GameRolePlayRemoveChallengeMessage", function (e) {
  window.gui.transmitMessage(e);
  window.isoEngine.removeChallenge(e.fightId);
});
window.gui.transmitMessage(e);
window.isoEngine.removeChallenge(e.fightId);
n.on("GameRolePlayArenaRegistrationStatusMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GameRolePlayArenaFightPropositionMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GameRolePlayArenaFighterStatusMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GameRolePlayArenaUpdatePlayerInfosMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AccountHouseMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("HousePropertiesMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("HouseBuyResultMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("HouseSoldMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("HouseToSellListMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("HouseGuildNoneMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("HouseGuildRightsMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("JobDescriptionMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("JobLevelUpMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("JobUnlearntMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("JobExperienceMultiUpdateMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("JobExperienceUpdateMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("JobAllowMultiCraftRequestMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("JobMultiCraftAvailableSkillsMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("JobCrafterDirectoryListMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("JobCrafterDirectorySettingsMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("JobListedUpdateMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("JobCrafterDirectoryRemoveMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("JobCrafterDirectoryAddMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("JobCrafterDirectoryEntryMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("LockableShowCodeDialogMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("LockableCodeResultMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("LockableStateUpdateHouseDoorMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("TaxCollectorDialogQuestionBasicMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("TaxCollectorDialogQuestionExtendedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AllianceTaxCollectorDialogQuestionExtendedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AlliancePrismDialogQuestionMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ObjectGroundAddedMessage", function (e) {
  var t = {
    cellId: e.cellId,
    objectGID: e.objectGID
  };
  o.loadImage(s + e._iconId + ".png", function (e) {
    t.img = e;
    window.isoEngine.addObjects([t]);
  });
});
n.on("ObjectGroundListAddedMessage", function (e) {
  for (var t = [], i = [], n = 0, a = e.cells.length; n < a; n++) {
    t.push({
      cellId: e.cells[n],
      objectGID: e.referenceIds[n]
    });
    i.push(s + e._iconIds[n] + ".png");
    var r = window.isoEngine.mapRenderer.objects[e.cells[n]];
    r && r.remove();
  }
  o.loadImages(i, null, function (e) {
    for (var i = 0; i < e.length; i++) {
      t[i].img = e[i];
    }
    window.isoEngine.addObjects(t);
  });
});
n.on("ObjectGroundRemovedMessage", function (e) {
  window.isoEngine.removeObjects([e.cell]);
});
n.on("ObjectGroundRemovedMultipleMessage", function (e) {
  window.isoEngine.removeObjects(e.cells);
});
t.img = e;
window.isoEngine.addObjects([t]);
t.push({
  cellId: e.cells[n],
  objectGID: e.referenceIds[n]
});
i.push(s + e._iconIds[n] + ".png");
n.on("PaddockPropertiesMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PaddockSellBuyDialogMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GameDataPlayFarmObjectAnimationMessage", function (e) {
  for (var t = 0; t < e.cellId.length; t++) {
    var i = "paddockItem:" + e.cellId[t],
      n = window.actorManager.getActor(i);
    n && n.loadAndPlayAnimation({
      base: "AnimHit",
      direction: 1
    }, {
      loop: !1
    });
  }
});
n.on("PaddockToSellListMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PartyInvitationDetailsMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PartyCannotJoinErrorMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PartyJoinMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PartyNewGuestMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PartyUpdateMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PartyNewMemberMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PartyUpdateLightMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PartyFollowStatusUpdateMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PartyMemberInFightMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("SpellForgetUIMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("SpellForgottenMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("SpellChangeSuccessMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("SpellChangeFailureMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GameRolePlaySpellAnimMessage", function (e) {
  window.isoEngine.playRoleplaySpellAnim(e, function (e) {
    if (e) {
      return console.error("GameRolePlaySpellAnimMessage error", e);
    }
  });
});
n.on("FriendsListMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("IgnoredListMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("FriendAddedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("FriendUpdateMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("IgnoredAddedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("IgnoredDeleteResultMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("SpouseStatusMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("SpouseInformationsMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("FriendWarnOnConnectionStateMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildCreationStartedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildModificationStartedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildCreationResultMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildInvitedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildInvitationStateRecruterMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildInvitationStateRecrutedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildJoinedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildMemberOnlineStatusMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildInformationsMembersMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildMemberWarnOnConnectionStateMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildInformationsPaddocksMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildMemberLeavingMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildLeftMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildMembershipMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildInfosUpgradeMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildHousesInformationMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildHouseUpdateInformationMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildHouseRemoveMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildPaddockBoughtMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildPaddockRemovedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildFactsMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildInAllianceFactsMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ChallengeFightJoinRefusedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("TaxCollectorMovementMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("TaxCollectorErrorMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("TaxCollectorListMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("TaxCollectorMovementAddMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("TaxCollectorMovementRemoveMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("TaxCollectorAttackedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("TaxCollectorAttackedResultMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildFightPlayersHelpersJoinMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildFightPlayersHelpersLeaveMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildFightPlayersEnemiesListMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("GuildFightPlayersEnemyRemoveMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("SetCharacterRestrictionsMessage", function (e) {
  window.isoEngine.actorManager.userActor.updateRestrictions(e.restrictions);
});
n.on("ServerExperienceModificatorMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("InteractiveUseErrorMessage", function (e) {
  window.isoEngine.onInteractiveUseErrorMessage(e);
});
n.on("InteractiveUsedMessage", function (e) {
  window.isoEngine.interactiveUseStart(e);
  window.gui.transmitMessage(e);
});
n.on("InteractiveUseEndedMessage", function (e) {
  window.isoEngine.interactiveUseEndedMessage(e);
  window.gui.transmitMessage(e);
});
n.on("InteractiveMapUpdateMessage", function (e) {
  window.isoEngine.updateInteractiveElements(e.interactiveElements);
});
n.on("InteractiveElementUpdatedMessage", function (e) {
  window.isoEngine.updateInteractiveElements([e.interactiveElement]);
});
n.on("StatedMapUpdateMessage", function (e) {
  window.isoEngine.updateStatedElements(e.statedElements);
});
n.on("StatedElementUpdatedMessage", function (e) {
  window.isoEngine.updateStatedElements([e.statedElement]);
});
window.isoEngine.interactiveUseStart(e);
window.gui.transmitMessage(e);
window.isoEngine.interactiveUseEndedMessage(e);
window.gui.transmitMessage(e);
n.on("TeleportDestinationsListMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ZaapListMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("KamasUpdateMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ObjectAveragePricesMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeReplayCountModifiedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeObjectAddedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeRequestedTradeMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeStartedWithPodsMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeCraftSlotCountIncreasedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeIsReadyMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeLeaveMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeStartOkNpcTradeMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeOkMultiCraftMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeCraftResultMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeCraftResultWithObjectIdMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeCraftResultWithObjectDescMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeCraftResultMagicWithObjectDescMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeCraftInformationObjectMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeGuildTaxCollectorGetMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeMountStableErrorMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeMountStableAddMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeMountPaddockAddMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeMountStableBornAddMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeMountStableRemoveMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeMountPaddockRemoveMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeMountTakenFromPaddockMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeMountFreeFromPaddockMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeMountSterilizeFromPaddockMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeItemAutoCraftStopedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeItemAutoCraftRemainingMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeStartOkCraftWithInformationMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeStartOkMulticraftCrafterMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeStartOkMulticraftCustomerMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeStartOkJobIndexMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeGoldPaymentForCraftMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeItemPaymentForCraftMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeModifiedPaymentForCraftMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeRemovedPaymentForCraftMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeClearPaymentForCraftMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("InventoryContentMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("SetUpdateMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ObjectMovementMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ObjectAddedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ObjectsAddedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ObjectModifiedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("InventoryContentAndPresetMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeObjectRemovedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeObjectModifiedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeObjectPutInBagMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeObjectRemovedFromBagMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeObjectModifiedInBagMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeKamaModifiedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("ExchangeMultiCraftCrafterCanUseHisRessourcesMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("InventoryPresetUpdateMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("InventoryPresetItemUpdateErrorMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("InventoryPresetItemUpdateMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("InventoryPresetSaveResultMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("InventoryPresetDeleteResultMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("InventoryPresetUseResultMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PrismFightDefenderAddMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PrismFightDefenderLeaveMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PrismFightAttackerAddMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PrismFightAttackerRemoveMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PrismsListMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PrismsListUpdateMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PrismsInfoValidMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PrismFightAddedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PrismFightRemovedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PrismFightStateUpdateMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("PrismSettingsErrorMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("UpdateMapPlayersAgressableStatusMessage", function (e) {
  window.gui.transmitMessage(e);
  window.actorManager.updateActorsAggressableStatus(e.playerIds, e.enable);
});
n.on("UpdateSelfAgressableStatusMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("AlignmentRankUpdateMessage", function (e) {
  window.gui.transmitMessage(e);
});
window.gui.transmitMessage(e);
window.actorManager.updateActorsAggressableStatus(e.playerIds, e.enable);
n.on("TitlesAndOrnamentsListMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("TitleGainedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("TitleLostMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("OrnamentGainedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("TitleSelectedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("TitleSelectErrorMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("OrnamentSelectedMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.on("OrnamentSelectErrorMessage", function (e) {
  window.gui.transmitMessage(e);
});
n.sendMessage("CharactersListRequestMessage");
window.gui.transmitMessage(e);
window.gui.openSimplePopup(e.text, e.title);
e.hangUp && (window.gui.disconnect(), window.isoEngine.disconnect());
t.start = function () {
  if (window.powerManagement) {
    return i ? console.warn("PowerManager already active") : void window.powerManagement.dim(function () {
      i = !0;
    }, function (e) {
      console.warn("PowerManager failed to acquire wakelock", e);
    });
  }
};
t.stop = function () {
  if (window.powerManagement) {
    return i ? void window.powerManagement.release(function () {
      i = !1;
    }, function (e) {
      console.warn("PowerManager failed to release wakelock", e);
    }) : console.warn("PowerManager was not active");
  }
};
e.on(s, t);
o.push({
  eventName: s,
  callback: t
});
n.on("data", function (e) {
  if (null !== o[e._messageType]) {
    var t = "background-color: #BFA;";
    e._messageType && e._messageType.indexOf("ErrorMessage") === -1 || (t = "background-color: #F00; color: #FFF;");
    console.log("[DOFUS PROXY] received: %c" + e._messageType, t, e);
  }
});
n.on("messageSequence", function (e) {
  var t = "background-color: #CB98E7;";
  console.log("[DOFUS PROXY] received: %cmessageSequence", t, e);
});
n.on("open", function () {
  console.log("[DOFUS PROXY] %c Connected to remote server ", "background-color: #FF0;");
});
n.on("reconnecting", function () {
  console.log("[DOFUS PROXY] %c Reconnecting to remote server... ", "background-color: #FF0;");
});
n.on("reconnected", function () {
  console.log("[DOFUS PROXY] %c Reconnected to remote server ", "background-color: #FF0;");
});
n.on("error", function (e) {
  console.error("[DOFUS PROXY] ", e);
});
n.on("disconnect", function () {
  console.log("[DOFUS PROXY] %c disconnecting ", "background-color: #FF0;");
});
n.on("send", function (e) {
  if ("sendMessage" === e.call) {
    if (a[e.data.data.type]) {
      return;
    }
    return void console.log("[DOFUS PROXY]     send: %c" + e.data.data.type, "background-color: #6DF;", e.data.data.data);
  }
  console.log("[DOFUS PROXY]     send: %c" + e.call, "background-color: #6DF;", e.data);
});
e._messageType && e._messageType.indexOf("ErrorMessage") === -1 || (t = "background-color: #F00; color: #FFF;");
console.log("[DOFUS PROXY] received: %c" + e._messageType, t, e);
i(383);
e.exports = i(384);
i(393);
i(394);
i(395);
i(484);
i(485);
u.call(this, "div", {
  className: "foreground",
  hidden: !0
});
this.tapOptions = {};
this.fightIsUserTurn = !1;
this.isTacticMode = !1;
this.locked = !1;
this.lockMap = {};
m.on("gameContextChanged", this.onGameContextChanged.bind(this));
i.once("connected", function () {
  t._setupInfoBox();
  t._createConfirmBox();
  t._setupDrop();
  t._setupTouchInteraction();
  t._setupBorderArrow();
  t._setupMonsterGroupTooltips();
  e();
  i.timeline.setStyles({
    top: o.mapHeight - 150 + "px",
    left: o.mapWidth + "px"
  });
  t._initHandlers(this);
  this.on("disconnect", function () {
    t.tapOptions = {};
    t.fightIsUserTurn = !1;
    t.locked = !1;
    t.lockMap = {};
    t.hideInfobox();
    t.confirmBox.close();
    t.minMaxSelector.hide();
    t.hide();
    t.removeAllMonsterGroupTooltips();
  });
});
i.on("resize", e);
t._setupInfoBox();
t._createConfirmBox();
t._setupDrop();
t._setupTouchInteraction();
t._setupBorderArrow();
t._setupMonsterGroupTooltips();
e();
i.timeline.setStyles({
  top: o.mapHeight - 150 + "px",
  left: o.mapWidth + "px"
});
t._initHandlers(this);
this.on("disconnect", function () {
  t.tapOptions = {};
  t.fightIsUserTurn = !1;
  t.locked = !1;
  t.lockMap = {};
  t.hideInfobox();
  t.confirmBox.close();
  t.minMaxSelector.hide();
  t.hide();
  t.removeAllMonsterGroupTooltips();
});
t.tapOptions = {};
t.fightIsUserTurn = !1;
t.locked = !1;
t.lockMap = {};
t.hideInfobox();
t.confirmBox.close();
t.minMaxSelector.hide();
t.hide();
t.removeAllMonsterGroupTooltips();
r(n, u);
e.exports = n;
n.prototype._setupDrop = function () {
  function e(e) {
    var i = window.gui.playerData.inventory.objects[t],
      n = i ? i.getName() : t;
    window.gui.openConfirmPopup({
      title: h("ui.common.confirm"),
      message: p(h("ui.common.confirmationDropItem"), e, n),
      cb: function (i) {
        i && (window.dofus.sendMessage("ObjectDropMessage", {
          objectUID: t,
          quantity: e
        }), c("DROP_ITEM_1"));
      }
    });
  }
  var t,
    i = this,
    n = this.minMaxSelector = window.gui.windowsContainer.appendChild(new l());
  n.on("confirm", e);
  a.setDroppable(this, ["itemContextMenu", "equipment"]);
  this.on("drop", function (o, a, s) {
    switch (a) {
      case "itemContextMenu":
        var r = i.convertScreenToCanvasCoordinate(s.x, s.y);
        window.isoEngine.useItem(r.x, r.y, o.item.objectUID);
        break;
      case "equipment":
        t = o.itemInstance.objectUID;
        var l = o.itemInstance.quantity;
        1 === l ? e(1) : n.open({
          min: 1,
          max: l,
          x: s.x,
          y: s.y
        });
    }
  });
};
n.prototype._initHandlers = function (e) {
  function t() {
    o.tapOptions.mode = "fight";
    o.tapOptions.possiblePlacements && delete o.tapOptions.possiblePlacements;
  }
  function i() {
    o.fightIsUserTurn && (o.fightIsUserTurn = !1, o.confirmBox.hide(), window.gui.damagePreview.hide(), window.isoEngine.clearUserMovementZone());
  }
  function n(t) {
    var i = o.fightIsUserTurn = e.playerData.characters.canControlCharacterId(t.id),
      n = window.isoEngine;
    if (n.fightTurnStart(i), n.clearHighlights(), i && s.soundOnPlayerTurnStart && c("PLAYER_TURN"), !n.mapRenderer.isReady) {
      return n.mapRenderer.once("ready", function () {
        o._displayUserZones();
      });
    }
  }
  var o = this;
  e.on("sendAllFightEvent", function () {
    o._displayUserZones();
  });
  e.on("GameFightPlacementPossiblePositionsMessage", function (e) {
    o.tapOptions.mode = "fightPlacement";
    e.teamNumber === d.TEAM_CHALLENGER ? o.tapOptions.possiblePlacements = e.positionsForChallengers : e.teamNumber === d.TEAM_DEFENDER ? o.tapOptions.possiblePlacements = e.positionsForDefenders : o.tapOptions.possiblePlacements && delete o.tapOptions.possiblePlacements;
    o.emit("fightPlacementPosition");
  });
  e.on("GameFightJoinMessage", function (e) {
    return e.isFightStarted ? t() : void (o.tapOptions.mode = "fightPlacement");
  });
  e.on("GameFightStartMessage", t);
  e.on("GameFightResumeMessage", t);
  e.on("GameFightResumeWithSlavesMessage", t);
  e.on("GameFightTurnStartPlayingMessage", function () {
    o.fightIsUserTurn = !0;
  });
  e.on("GameFightTurnStartMessage", n);
  e.on("GameFightTurnResumeMessage", n);
  e.on("GameFightTurnStartSlaveMessage", n);
  e.on("GameFightTurnEndMessage", i);
  e.on("GameFightEndMessage", i);
  e.on("spellSlotSelected", function (e) {
    o.selectSpell(e);
  });
  e.on("spellSlotDeselected", function () {
    o.deselectSpell();
  });
  e.playerData.characters.on("specificCharacteristicsUpdated", function (t) {
    "movementPointsCurrent" === t && e.playerData.isFighting && o.fightIsUserTurn && (o.isSpellSelected() || window.isoEngine.displayUserMovementZone());
  });
};
n.prototype._displayUserZones = function () {
  var e = this.isSpellSelected();
  this.fightIsUserTurn ? e ? this._displaySpellRange() : window.isoEngine.displayUserMovementZone() : e && this._displaySpellRange();
};
n.prototype._displaySpellRange = function () {
  var e = this.tapOptions,
    t = e.spellId,
    i = window.gui.playerData.characters.getControlledCharacter(),
    n = i.spellData.spells[t],
    o = n.getZoneEffectWhenCasting(),
    a = {
      spellId: t,
      castInDiagonal: n.getProperty("castInDiagonal"),
      castInLine: n.getProperty("castInLine"),
      castTestLos: n.getProperty("castTestLos"),
      minRange: n.getProperty("minRange"),
      range: n.getProperty("range"),
      apCost: n.getProperty("apCost", n.level),
      needFreeCell: n.getProperty("needFreeCell"),
      needFreeTrapCell: n.getProperty("needFreeTrapCell"),
      needTakenCell: n.getProperty("needTakenCell"),
      name: n.getName(),
      zoneEffect: o
    };
  e.spell = n;
  window.isoEngine.setCurrentSpell(a);
  window.isoEngine.displaySpellRange();
};
n.prototype.refreshSpellRange = function () {
  this.isSpellSelected() && this._displaySpellRange();
};
n.prototype.selectSpell = function (e) {
  this.tapOptions.spellId = e;
  this.tapOptions.characterId = window.gui.playerData.characters.controlledCharacterId;
  "fight" === this.tapOptions.mode && this._displayUserZones();
  this.emit("spellSelected");
};
n.prototype.deselectSpell = function () {
  void 0 !== this.tapOptions.spellId && (this.emit("spellCanceled"), this.confirmBox.close(), delete this.tapOptions.spellId);
  "fight" === this.tapOptions.mode && this._displayUserZones();
};
n.prototype.isSpellSelected = function () {
  return !!this.tapOptions.spellId || 0 === this.tapOptions.spellId;
};
n.prototype.lock = function (e) {
  return e ? (this.lockMap[e] = !0, this.locked = !0, void this.cancelTransform()) : console.error(new Error("Foreground.lock: no reason provided"));
};
n.prototype.unlock = function (e) {
  if (!e) {
    return console.error(new Error("Foreground.unlock: no reason provided"));
  }
  this.lockMap[e] = !1;
  for (var t = Object.keys(this.lockMap), i = 0; i < t.length; i++) {
    if (this.lockMap[t[i]]) {
      return;
    }
  }
  this.locked = !1;
};
n.prototype.onGameContextChanged = function () {
  m.isRoleplayMode ? this.tapOptions.mode = "roleplay" : (delete this.tapOptions.mode, this.hideBorderArrow());
};
n.on("confirm", e);
a.setDroppable(this, ["itemContextMenu", "equipment"]);
this.on("drop", function (o, a, s) {
  switch (a) {
    case "itemContextMenu":
      var r = i.convertScreenToCanvasCoordinate(s.x, s.y);
      window.isoEngine.useItem(r.x, r.y, o.item.objectUID);
      break;
    case "equipment":
      t = o.itemInstance.objectUID;
      var l = o.itemInstance.quantity;
      1 === l ? e(1) : n.open({
        min: 1,
        max: l,
        x: s.x,
        y: s.y
      });
  }
});
o.tapOptions.mode = "fight";
o.tapOptions.possiblePlacements && delete o.tapOptions.possiblePlacements;
e.on("sendAllFightEvent", function () {
  o._displayUserZones();
});
e.on("GameFightPlacementPossiblePositionsMessage", function (e) {
  o.tapOptions.mode = "fightPlacement";
  e.teamNumber === d.TEAM_CHALLENGER ? o.tapOptions.possiblePlacements = e.positionsForChallengers : e.teamNumber === d.TEAM_DEFENDER ? o.tapOptions.possiblePlacements = e.positionsForDefenders : o.tapOptions.possiblePlacements && delete o.tapOptions.possiblePlacements;
  o.emit("fightPlacementPosition");
});
e.on("GameFightJoinMessage", function (e) {
  return e.isFightStarted ? t() : void (o.tapOptions.mode = "fightPlacement");
});
e.on("GameFightStartMessage", t);
e.on("GameFightResumeMessage", t);
e.on("GameFightResumeWithSlavesMessage", t);
e.on("GameFightTurnStartPlayingMessage", function () {
  o.fightIsUserTurn = !0;
});
e.on("GameFightTurnStartMessage", n);
e.on("GameFightTurnResumeMessage", n);
e.on("GameFightTurnStartSlaveMessage", n);
e.on("GameFightTurnEndMessage", i);
e.on("GameFightEndMessage", i);
e.on("spellSlotSelected", function (e) {
  o.selectSpell(e);
});
e.on("spellSlotDeselected", function () {
  o.deselectSpell();
});
e.playerData.characters.on("specificCharacteristicsUpdated", function (t) {
  "movementPointsCurrent" === t && e.playerData.isFighting && o.fightIsUserTurn && (o.isSpellSelected() || window.isoEngine.displayUserMovementZone());
});
o.tapOptions.mode = "fightPlacement";
e.teamNumber === d.TEAM_CHALLENGER ? o.tapOptions.possiblePlacements = e.positionsForChallengers : e.teamNumber === d.TEAM_DEFENDER ? o.tapOptions.possiblePlacements = e.positionsForDefenders : o.tapOptions.possiblePlacements && delete o.tapOptions.possiblePlacements;
o.emit("fightPlacementPosition");
e.spell = n;
window.isoEngine.setCurrentSpell(a);
window.isoEngine.displaySpellRange();
this.tapOptions.spellId = e;
this.tapOptions.characterId = window.gui.playerData.characters.controlledCharacterId;
"fight" === this.tapOptions.mode && this._displayUserZones();
this.emit("spellSelected");
void 0 !== this.tapOptions.spellId && (this.emit("spellCanceled"), this.confirmBox.close(), delete this.tapOptions.spellId);
"fight" === this.tapOptions.mode && this._displayUserZones();
m = !1;
M = T = null;
_ = v = w = null;
void 0 !== _.customScale && null !== _.customScale && (i = _.customScale);
void 0 !== _.customXOffset && null !== _.customXOffset && (n = _.customXOffset);
void 0 !== _.customYOffset && null !== _.customYOffset && (o = _.customYOffset);
void 0 !== _.customRotation && null !== _.customRotation && (a = _.customRotation);
e = s.x;
t = s.y;
s.removeListener("dragMove", o);
p.isDragging = !1;
b && (b.delClassNames("dragOver", "notAllowed"), b = null);
S.x = e;
S.y = t;
a.initEvent("drop", !0, !0);
i.dispatchEvent(a);
w.onDragClassName && _.delClassNames(w.onDragClassName);
p.isLostDrop = !0;
_ !== y ? (v.appendChild(_), _.delClassNames("customDragElement"), _.setStyles(I), _.emit("dragEnd", S.x, S.y)) : (y.hide(), M.emit("dragEnd", S.x, S.y));
p.emit("dragEnd", M, M._dragManager.source, T);
y.hide();
n();
p.init = function (e) {
  y = new d("div", {
    className: "dragElement"
  });
  y.icon = y.createChild("div", {
    className: "icon"
  });
  e.appendChild(y);
  y.hide();
  window.gui.wBody.on("dom.drop", function () {
    c.tween(_, {
      webkitTransform: "translate3d(0,0,0) scale(1)"
    }, {
      time: 100,
      easing: "ease-out"
    }, function () {
      w.onDragClassName && _.delClassNames(w.onDragClassName);
      p.isLostDrop = !0;
      _ !== y ? (v.appendChild(_), _.delClassNames("customDragElement"), _.setStyles(I), _.emit("dragEnd", S.x, S.y)) : (y.hide(), M.emit("dragEnd", S.x, S.y));
      p.emit("dragEnd", M, M._dragManager.source, T);
      y.hide();
      n();
    });
  });
};
p.setElementSource = function (e, t) {
  e._dragManager && (e._dragManager.source = t);
};
p.isDraggable = function (e) {
  return e._dragManager && e._dragManager.draggable;
};
p.setDraggable = function (e, t, i, n, r) {
  e._dragManager = e._dragManager || {};
  e._dragManager.draggable || (e._dragManager.draggable = !0, e._dragManager.source = i, r = r || {}, t = t || {}, s.initializeListeners(e, r), e.on("_dragStart", function (i, d) {
    if (_ = r.dragElement ? e : y, !m && (!t.prepareForDrag || t.prepareForDrag(n, _, e))) {
      var b = u.getCoordinatesRelativeToBody(i, d);
      i = b.x;
      d = b.y;
      m = !0;
      p.isDragging = !0;
      M = e;
      T = n;
      w = t;
      var S = h(e.rootElement),
        E = {
          left: S.x,
          top: S.y,
          width: r.containerWidth || S.width,
          height: r.containerHeight || S.height
        };
      if (C.x = E.left, C.y = E.top, r.dragElement) {
        v = e.getParent();
        window.gui.gameGuiContainer.appendChild(e);
        I.left = e.getStyle("left");
        I.top = e.getStyle("top");
        _.setStyles({
          left: E.left + "px",
          top: E.top + "px",
          webkitTransform: "translate3d(0,0,0)"
        });
        _.addClassNames("customDragElement");
      } else {
        I.left = I.top = 0;
        _.setStyles({
          left: E.left + "px",
          top: E.top + "px",
          width: E.width + "px",
          height: E.height + "px",
          webkitTransform: "translate3d(0,0,0)"
        });
        var N = w.styles || {};
        N.backgroundImage = w.backgroundImage || N.backgroundImage || "none";
        _.icon.setStyles(N);
      }
      w.onDragClassName && _.addClassNames(w.onDragClassName);
      _.show();
      f = E.left + Math.floor(E.width / 2) - i;
      g = E.top + Math.floor(E.height / 2) - d;
      A.x = i;
      A.y = d;
      c.tween(_, {
        webkitTransform: "translate3d(" + -f + "px," + -g + "px,0) scale(1.5)"
      }, {
        time: 100,
        easing: "ease-out"
      }, function () {
        s.on("dragMove", o);
        r.noHover || l.start();
        e.emit("dragStart");
        p.emit("dragStart", M, M._dragManager.source, T);
      });
      s.once("dragEnd", a);
    }
  }));
};
p.setDragEnable = function (e, t) {
  e._dragManager && (e._dragManager.enable = t);
};
p.enableDrag = function (e) {
  p.setDragEnable(e, !0);
};
p.disableDrag = function (e) {
  p.setDragEnable(e, !1);
};
p.cancelDragFromSource = function (e) {
  M && e === M._dragManager.source && p.cancelDrag();
};
p.cancelDrag = function () {
  w && w.onDragClassName && _.delClassNames(w.onDragClassName);
  s.cancel();
};
p.setDroppable = function (e, t, i) {
  function o() {
    var n = M._dragManager.source;
    return !(i.isDropAllowed && !i.isDropAllowed.call(e, T, _, n)) && t.indexOf(n) !== -1;
  }
  e._dragManager = e._dragManager || {};
  e._dragManager.droppable || (e._dragManager.droppable = !0, i = i || {}, l(e), e.on("touchenter", function () {
    p.isDragging && o() && (b = e, e.addClassNames("dragOver"), e.emit("dragEnter", M, M._dragManager.source, T));
  }), e.on("touchleave", function () {
    p.isDragging && o() && (b = null, e.delClassNames("dragOver"), e.emit("dragLeave"));
  }), e.on("dom.drop", function (t) {
    if (o()) {
      t.stopPropagation();
      var a, s;
      if (i.matchPositionOnDrop) {
        var r = h(e.rootElement);
        a = r.x - A.x + Math.floor(r.width / 2) - f;
        s = r.y - A.y + Math.floor(r.height / 2) - g;
      } else {
        a = S.x - A.x;
        s = S.y - A.y;
      }
      e.emit("beforeDragEnd");
      c.tween(_, {
        webkitTransform: "translate3d(" + a + "px," + s + "px,0) scale(1)"
      }, {
        time: 100,
        easing: "ease-out"
      }, function () {
        T = T || {};
        T.x = S.x;
        T.y = S.y;
        w.onDragClassName && _.delClassNames(w.onDragClassName);
        _ !== y ? (v.appendChild(_), _.delClassNames("customDragElement"), _.setStyles({
          left: I.left,
          top: I.top,
          webkitTransform: "translate3d(0px,0px, 0)"
        }), _.emit("dragEnd", a, s)) : M.emit("dragEnd", a, s);
        p.isLostDrop = !1;
        p.emit("dragEnd", M, M._dragManager.source, T);
        e.delClassNames("dragOver");
        e.emit("drop", M, M._dragManager.source, T);
        y.hide();
        n();
      });
    }
  }));
};
p.getDraggedElement = function () {
  return _;
};
e.exports = p;
y = new d("div", {
  className: "dragElement"
});
y.icon = y.createChild("div", {
  className: "icon"
});
e.appendChild(y);
y.hide();
window.gui.wBody.on("dom.drop", function () {
  c.tween(_, {
    webkitTransform: "translate3d(0,0,0) scale(1)"
  }, {
    time: 100,
    easing: "ease-out"
  }, function () {
    w.onDragClassName && _.delClassNames(w.onDragClassName);
    p.isLostDrop = !0;
    _ !== y ? (v.appendChild(_), _.delClassNames("customDragElement"), _.setStyles(I), _.emit("dragEnd", S.x, S.y)) : (y.hide(), M.emit("dragEnd", S.x, S.y));
    p.emit("dragEnd", M, M._dragManager.source, T);
    y.hide();
    n();
  });
});
w.onDragClassName && _.delClassNames(w.onDragClassName);
p.isLostDrop = !0;
_ !== y ? (v.appendChild(_), _.delClassNames("customDragElement"), _.setStyles(I), _.emit("dragEnd", S.x, S.y)) : (y.hide(), M.emit("dragEnd", S.x, S.y));
p.emit("dragEnd", M, M._dragManager.source, T);
y.hide();
n();
e._dragManager = e._dragManager || {};
e._dragManager.draggable || (e._dragManager.draggable = !0, e._dragManager.source = i, r = r || {}, t = t || {}, s.initializeListeners(e, r), e.on("_dragStart", function (i, d) {
  if (_ = r.dragElement ? e : y, !m && (!t.prepareForDrag || t.prepareForDrag(n, _, e))) {
    var b = u.getCoordinatesRelativeToBody(i, d);
    i = b.x;
    d = b.y;
    m = !0;
    p.isDragging = !0;
    M = e;
    T = n;
    w = t;
    var S = h(e.rootElement),
      E = {
        left: S.x,
        top: S.y,
        width: r.containerWidth || S.width,
        height: r.containerHeight || S.height
      };
    if (C.x = E.left, C.y = E.top, r.dragElement) {
      v = e.getParent();
      window.gui.gameGuiContainer.appendChild(e);
      I.left = e.getStyle("left");
      I.top = e.getStyle("top");
      _.setStyles({
        left: E.left + "px",
        top: E.top + "px",
        webkitTransform: "translate3d(0,0,0)"
      });
      _.addClassNames("customDragElement");
    } else {
      I.left = I.top = 0;
      _.setStyles({
        left: E.left + "px",
        top: E.top + "px",
        width: E.width + "px",
        height: E.height + "px",
        webkitTransform: "translate3d(0,0,0)"
      });
      var N = w.styles || {};
      N.backgroundImage = w.backgroundImage || N.backgroundImage || "none";
      _.icon.setStyles(N);
    }
    w.onDragClassName && _.addClassNames(w.onDragClassName);
    _.show();
    f = E.left + Math.floor(E.width / 2) - i;
    g = E.top + Math.floor(E.height / 2) - d;
    A.x = i;
    A.y = d;
    c.tween(_, {
      webkitTransform: "translate3d(" + -f + "px," + -g + "px,0) scale(1.5)"
    }, {
      time: 100,
      easing: "ease-out"
    }, function () {
      s.on("dragMove", o);
      r.noHover || l.start();
      e.emit("dragStart");
      p.emit("dragStart", M, M._dragManager.source, T);
    });
    s.once("dragEnd", a);
  }
}));
i = b.x;
d = b.y;
m = !0;
p.isDragging = !0;
M = e;
T = n;
w = t;
v = e.getParent();
window.gui.gameGuiContainer.appendChild(e);
I.left = e.getStyle("left");
I.top = e.getStyle("top");
_.setStyles({
  left: E.left + "px",
  top: E.top + "px",
  webkitTransform: "translate3d(0,0,0)"
});
_.addClassNames("customDragElement");
I.left = I.top = 0;
_.setStyles({
  left: E.left + "px",
  top: E.top + "px",
  width: E.width + "px",
  height: E.height + "px",
  webkitTransform: "translate3d(0,0,0)"
});
N.backgroundImage = w.backgroundImage || N.backgroundImage || "none";
_.icon.setStyles(N);
w.onDragClassName && _.addClassNames(w.onDragClassName);
_.show();
f = E.left + Math.floor(E.width / 2) - i;
g = E.top + Math.floor(E.height / 2) - d;
A.x = i;
A.y = d;
c.tween(_, {
  webkitTransform: "translate3d(" + -f + "px," + -g + "px,0) scale(1.5)"
}, {
  time: 100,
  easing: "ease-out"
}, function () {
  s.on("dragMove", o);
  r.noHover || l.start();
  e.emit("dragStart");
  p.emit("dragStart", M, M._dragManager.source, T);
});
s.once("dragEnd", a);
s.on("dragMove", o);
r.noHover || l.start();
e.emit("dragStart");
p.emit("dragStart", M, M._dragManager.source, T);
w && w.onDragClassName && _.delClassNames(w.onDragClassName);
s.cancel();
e._dragManager = e._dragManager || {};
e._dragManager.droppable || (e._dragManager.droppable = !0, i = i || {}, l(e), e.on("touchenter", function () {
  p.isDragging && o() && (b = e, e.addClassNames("dragOver"), e.emit("dragEnter", M, M._dragManager.source, T));
}), e.on("touchleave", function () {
  p.isDragging && o() && (b = null, e.delClassNames("dragOver"), e.emit("dragLeave"));
}), e.on("dom.drop", function (t) {
  if (o()) {
    t.stopPropagation();
    var a, s;
    if (i.matchPositionOnDrop) {
      var r = h(e.rootElement);
      a = r.x - A.x + Math.floor(r.width / 2) - f;
      s = r.y - A.y + Math.floor(r.height / 2) - g;
    } else {
      a = S.x - A.x;
      s = S.y - A.y;
    }
    e.emit("beforeDragEnd");
    c.tween(_, {
      webkitTransform: "translate3d(" + a + "px," + s + "px,0) scale(1)"
    }, {
      time: 100,
      easing: "ease-out"
    }, function () {
      T = T || {};
      T.x = S.x;
      T.y = S.y;
      w.onDragClassName && _.delClassNames(w.onDragClassName);
      _ !== y ? (v.appendChild(_), _.delClassNames("customDragElement"), _.setStyles({
        left: I.left,
        top: I.top,
        webkitTransform: "translate3d(0px,0px, 0)"
      }), _.emit("dragEnd", a, s)) : M.emit("dragEnd", a, s);
      p.isLostDrop = !1;
      p.emit("dragEnd", M, M._dragManager.source, T);
      e.delClassNames("dragOver");
      e.emit("drop", M, M._dragManager.source, T);
      y.hide();
      n();
    });
  }
}));
a = r.x - A.x + Math.floor(r.width / 2) - f;
s = r.y - A.y + Math.floor(r.height / 2) - g;
a = S.x - A.x;
s = S.y - A.y;
e.emit("beforeDragEnd");
c.tween(_, {
  webkitTransform: "translate3d(" + a + "px," + s + "px,0) scale(1)"
}, {
  time: 100,
  easing: "ease-out"
}, function () {
  T = T || {};
  T.x = S.x;
  T.y = S.y;
  w.onDragClassName && _.delClassNames(w.onDragClassName);
  _ !== y ? (v.appendChild(_), _.delClassNames("customDragElement"), _.setStyles({
    left: I.left,
    top: I.top,
    webkitTransform: "translate3d(0px,0px, 0)"
  }), _.emit("dragEnd", a, s)) : M.emit("dragEnd", a, s);
  p.isLostDrop = !1;
  p.emit("dragEnd", M, M._dragManager.source, T);
  e.delClassNames("dragOver");
  e.emit("drop", M, M._dragManager.source, T);
  y.hide();
  n();
});
T = T || {};
T.x = S.x;
T.y = S.y;
w.onDragClassName && _.delClassNames(w.onDragClassName);
_ !== y ? (v.appendChild(_), _.delClassNames("customDragElement"), _.setStyles({
  left: I.left,
  top: I.top,
  webkitTransform: "translate3d(0px,0px, 0)"
}), _.emit("dragEnd", a, s)) : M.emit("dragEnd", a, s);
p.isLostDrop = !1;
p.emit("dragEnd", M, M._dragManager.source, T);
e.delClassNames("dragOver");
e.emit("drop", M, M._dragManager.source, T);
y.hide();
n();
g = !1;
d = null;
g = !0;
d.emit("_dragStart", t.x, t.y);
d.emit("dragMove", t.x, t.y);
m.emit("dragMove", t.x, t.y);
s();
g && (n(), m.emit("dragEnd", t.x, t.y));
m.cancel = function () {
  s();
  g && (n(), m.emit("dragEnd", 0, 0), p.abortInteraction());
};
m.initializeListeners = function (e, t) {
  e.allowDomEvents();
  var i = t.hasOwnProperty("sensitivity") ? t.sensitiviy : f;
  e.on("dom.touchstart", function (n) {
    if (e._dragManager.enable && !_) {
      v = i;
      var s = h(n);
      l = s.x;
      c = s.y;
      a();
      d = e;
      t.dragOnTouchstart ? (v = 0, o(n)) : t.dragInsteadOfScroll && p.setPriorityBehavior("DRAG");
    }
  });
  e._dragManager.enable = !0;
};
s();
g && (n(), m.emit("dragEnd", 0, 0), p.abortInteraction());
e.on("dom.touchstart", function (n) {
  if (e._dragManager.enable && !_) {
    v = i;
    var s = h(n);
    l = s.x;
    c = s.y;
    a();
    d = e;
    t.dragOnTouchstart ? (v = 0, o(n)) : t.dragInsteadOfScroll && p.setPriorityBehavior("DRAG");
  }
});
e._dragManager.enable = !0;
l = s.x;
c = s.y;
a();
d = e;
t.dragOnTouchstart ? (v = 0, o(n)) : t.dragInsteadOfScroll && p.setPriorityBehavior("DRAG");
this.decrButton = t.appendChild(new r({
  className: ["simpleButton", "arrow", "decrButton"],
  repeatDelay: m
}));
this.numberInput = t.appendChild(new c({
  className: "numberInput"
}));
this.incrButton = t.appendChild(new r({
  className: ["simpleButton", "arrow", "incrButton"],
  repeatDelay: m
}));
this.minButton = i.appendChild(new l(a("ui.common.minWord"), {
  className: "minButton"
}));
this.maxButton = i.appendChild(new l(a("ui.common.maxWord"), {
  className: "maxButton"
}));
this.close = i.appendChild(new r({
  className: ["simpleButton", "closeBtn"]
}));
this.confirm = i.appendChild(new r({
  className: ["simpleButton", "confirmBtn"]
}));
this.currentValue = 0;
this.minButton.on("tap", function () {
  e.currentValue = e.min;
  e.numberInput.setValue(e.currentValue);
});
this.maxButton.on("tap", function () {
  e.currentValue = e.max;
  e.numberInput.setValue(e.currentValue);
});
this.decrButton.on("tap", function () {
  e.currentValue <= e.min || (e.currentValue--, e.numberInput.setValue(e.currentValue));
});
this.incrButton.on("tap", function () {
  e.currentValue >= e.max || (e.currentValue++, e.numberInput.setValue(e.currentValue));
});
this.confirm.on("tap", function () {
  e.closeMinMax();
  e.emit("confirm", e.currentValue);
});
this.close.on("tap", function () {
  e.closeMinMax();
});
this.numberInput.on("change", function (t) {
  e.currentValue = t;
});
e.currentValue = e.min;
e.numberInput.setValue(e.currentValue);
e.currentValue = e.max;
e.numberInput.setValue(e.currentValue);
e.closeMinMax();
e.emit("confirm", e.currentValue);
s(n, h);
e.exports = n;
n.prototype.position = function (e, t) {
  var i = o(this, e, t);
  this.setStyles({
    left: i.x + "px",
    top: i.y + "px"
  });
};
n.prototype.open = function (e) {
  function t() {
    delete i.openTweener;
    i.emit("opened");
  }
  var i = this;
  e = e || {};
  this.min = e.min || 0;
  this.max = e.max || p;
  var n;
  return n = void 0 !== e.defaultValue ? Math.max(this.min, Math.min(this.max, e.defaultValue)) : this.min, void 0 !== e.placeholder && void 0 === e.defaultValue ? (this.numberInput.setPlaceholder(e.placeholder), this.currentValue = "") : this.currentValue = n, this.numberInput.setValue(this.currentValue), this.numberInput.minValue = this.min, this.numberInput.maxValue = this.max, this.show(), e.hasOwnProperty("x") && e.hasOwnProperty("y") && this.position(e.x, e.y), this.setStyles(f), this.openTweener ? (this.openTweener.cancel(), t()) : void (this.openTweener = u.tween(this, g, {
    time: 150,
    delay: 0,
    easing: "ease-out"
  }, t));
};
n.prototype.openAround = function (e, t) {
  var i = e.rootElement.getBoundingClientRect();
  t.x = i.left;
  t.y = i.top;
  this.open(t);
};
n.prototype.closeMinMax = function () {
  function e() {
    delete t.closeTweener;
    t.hide();
    t.emit("closed");
    t.numberInput.rootElement.blur();
  }
  var t = this;
  return this.closeTweener ? (this.closeTweener.cancel(), e()) : void (this.closeTweener = u.tween(this, f, {
    time: 150,
    delay: 0,
    easing: "ease-out"
  }, e));
};
delete i.openTweener;
i.emit("opened");
e = e || {};
this.min = e.min || 0;
this.max = e.max || p;
t.x = i.left;
t.y = i.top;
this.open(t);
delete t.closeTweener;
t.hide();
t.emit("closed");
t.numberInput.rootElement.blur();
e = e || {};
this.title = e.title;
this.minValue = void 0 !== e.minValue ? e.minValue : d;
this.maxValue = e.maxValue || c;
e.attr = t;
l.call(this, "input", e);
this.addClassNames("NumberInputBox");
r(this);
this.on("tap", this._tapOnNumberInputBox);
a(n, l);
e.exports = n;
n.prototype._parseNumber = function (e) {
  var t = o.stringToInt(e);
  return Math.min(Math.max(t, this.minValue), this.maxValue);
};
n.prototype._tapOnNumberInputBox = function () {
  this.emit("focus");
  void 0 === this.minValue && (this.minValue = d);
  void 0 === this.maxValue && (this.maxValue = c);
  window.gui.numberInputPad.open(this, this.title, this.minValue, this.maxValue);
};
n.prototype.promptForValue = function (e) {
  function t() {
    n = !0;
  }
  if (this._tapOnNumberInputBox(), e) {
    var i = this,
      n = !1;
    this.on("change", t);
    window.gui.numberInputPad.once("hide", function () {
      return i.removeListener("change", t), e(n);
    });
  }
};
n.prototype.getValue = function () {
  return o.stringToInt(this.rootElement.value);
};
n.prototype.getRawValue = function () {
  return this.rootElement.value;
};
n.prototype.getFormattedValue = function () {
  return o.intToString(o.stringToInt(this.rootElement.value));
};
n.prototype.setValue = function (e, t) {
  var i, n;
  "number" == typeof e ? (n = e, i = o.intToString(n)) : (i = e, n = this._parseNumber(i));
  this.rootElement.value = i;
  t && this.emit("change", n);
};
n.prototype.setReadonly = function (e) {
  e === !1 ? this.rootElement.removeAttribute("readonly") : this.rootElement.setAttribute("readonly", "readonly");
  this.setEnable(!e);
};
n.prototype.setPlaceholder = function (e) {
  this.rootElement.placeholder = e;
};
n.prototype.blur = function () {};
n.prototype.focus = function () {};
n.prototype.disable = function () {
  this.setEnable(!1);
  this.rootElement.disabled = !0;
};
n.prototype.enable = function () {
  this.setEnable(!0);
  this.rootElement.disabled = !1;
};
this.emit("focus");
void 0 === this.minValue && (this.minValue = d);
void 0 === this.maxValue && (this.maxValue = c);
window.gui.numberInputPad.open(this, this.title, this.minValue, this.maxValue);
this.on("change", t);
window.gui.numberInputPad.once("hide", function () {
  return i.removeListener("change", t), e(n);
});
"number" == typeof e ? (n = e, i = o.intToString(n)) : (i = e, n = this._parseNumber(i));
this.rootElement.value = i;
t && this.emit("change", n);
e === !1 ? this.rootElement.removeAttribute("readonly") : this.rootElement.setAttribute("readonly", "readonly");
this.setEnable(!e);
this.setEnable(!1);
this.rootElement.disabled = !0;
this.setEnable(!0);
this.rootElement.disabled = !1;
n.prototype._setupInfoBox = function () {
  var e = this.infoBox = this.createChild("div", {
    className: "infoBox",
    hidden: !0
  });
  e.mp = e.createChild("div", {
    className: "mp"
  });
  e.ap = e.createChild("div", {
    className: "ap"
  });
};
n.prototype.hideInfobox = function () {
  this.infoBox.hide();
};
n.prototype.showInfobox = function (e, t) {
  "tackle" === e && (this.infoBox.mp.setText(t.mp ? -t.mp + " " + o("ui.stats.shortMP") : ""), this.infoBox.ap.setText(t.ap ? -t.ap + " " + o("ui.stats.shortAP") : ""));
  this.infoBox.show();
};
e.mp = e.createChild("div", {
  className: "mp"
});
e.ap = e.createChild("div", {
  className: "ap"
});
"tackle" === e && (this.infoBox.mp.setText(t.mp ? -t.mp + " " + o("ui.stats.shortMP") : ""), this.infoBox.ap.setText(t.ap ? -t.ap + " " + o("ui.stats.shortAP") : ""));
this.infoBox.show();
u.hide();
u.tween = null;
u.isOpen = !0;
u.allowDomEvents();
t(!1);
u.close();
d.cancel();
w.disable();
t(!0);
d.confirm();
u.close();
u.changeDamage = function (e) {
  y.show();
  y.clearContent();
  y.appendChild(e);
};
u.open = function (e, i, o, d, p, m) {
  return d = d || {}, m = m || n, d.allowDoubleTap && b && o && b === o ? (p(!0), void u.close()) : (b = o, w.enable(), y.hide(), "move" === e ? (h.setText(s("ui.common.move")), f.show(), g.setText(s("ui.short.movementPoints") + s("ui.common.colon") + "-" + i.mp), i.ap > 0 ? (v.setText(s("ui.short.actionPoints") + s("ui.common.colon") + "-" + i.ap), _.show()) : _.hide()) : (h.setText(i.name), f.hide(), _.show(), v.setText(s("ui.short.actionPoints") + s("ui.common.colon") + "-" + i.apCost)), u.show(), a = r(u, l.x, l.y), u.isOpen ? u.setStyles({
    webkitTransformOrigin: l.x + "px " + l.y + "px"
  }) : u.setStyles({
    webkitTransform: "scale(0) translate3d(" + a.x + "px," + a.y + "px,0)",
    webkitTransformOrigin: l.x + "px " + l.y + "px"
  }), c.tween(u, {
    webkitTransform: "scale(1) translate3d(" + a.x + "px," + a.y + "px,0)"
  }, {
    time: 100,
    easing: "linear"
  }, m), u.isOpen = !0, d.startHidden && u.hide(), void (t = p));
};
u.close = function () {
  u.isOpen && (i.emit("confirmBoxClosed"), u.isOpen = !1, w.disable(), b = null, c.tween(u, {
    webkitTransform: "scale(0) translate3d(" + a.x + "px," + a.y + "px,0)"
  }, {
    time: 100,
    easing: "linear"
  }, e));
};
u.close();
y.show();
y.clearContent();
y.appendChild(e);
a.prototype._setupTouchInteraction = function () {
  function e(e) {
    if (d.isVisible()) {
      var t = l(d, e.x, e.y);
      d.setStyle("webkitTransform", "translate3d(" + t.x + "px, " + t.y + "px, 0)");
    }
  }
  function t(t) {
    var i = u(t, {
      useScrollValue: !0
    });
    if (e(i), Math.abs(a - i.x) > 10 || Math.abs(s - i.y) > 10) {
      if (!h("TOUCH", f)) {
        return r();
      }
      a = i.x;
      s = i.y;
      var n = c.convertScreenToCanvasCoordinate(a, s);
      p.touchMove(n.x, n.y, this.tapOptions);
    }
  }
  var i,
    n,
    a,
    s,
    r,
    c = this,
    d = this.infoBox,
    p = window.isoEngine,
    m = window.gui.fightManager,
    f = {};
  r = function () {
    n = !0;
    p.touchCancel();
    c.removeListener("dom.touchmove", t);
  };
  this.on("dom.touchstart", function (e) {
    if (i) {
      return r();
    }
    var l = u(e, {
      useScrollValue: !0
    });
    this.locked || l.touchCount > 1 || (a = l.x, s = l.y, i = !0, n = !1, m.fightState !== o.BATTLE && m.fightState !== o.PREPARATION || this.on("dom.touchmove", t));
  });
  this.on("dom.touchend", function (e) {
    if (this.removeListener("dom.touchmove", t), this.locked || n || !i || !h("TOUCH", f)) {
      return void (i = !1);
    }
    i = !1;
    var o = u(e, {
        useScrollValue: !0
      }),
      a = c.convertScreenToCanvasCoordinate(o.x, o.y);
    p.touchEnd(a.x, a.y, this.tapOptions);
  });
  this._setupHighlightInteraction();
  this._setupCameraInteraction();
};
a.prototype.handleTapAfter = function (e) {
  var t = this;
  e.on("tap", function (e) {
    var i = t.convertScreenToCanvasCoordinate(e.x, e.y);
    window.isoEngine.touchEnd(i.x, i.y, t.tapOptions);
  });
};
a.prototype._setupHighlightInteraction = function () {
  function e() {
    window.clearTimeout(O);
    O = window.setTimeout(function () {
      I.closeTooltip();
    }, 500);
  }
  function t(e) {
    for (var t, i, n, o, a = e.humanoidInfo.options || [], s = 0; s < a.length; s += 1) {
      var r = a[s];
      "HumanOptionGuild" === r._type ? n = r.guildInformations : "HumanOptionAlliance" === r._type ? o = r.allianceInformations : "HumanOptionOrnament" === r._type ? i = r.ornamentId : "HumanOptionTitle" === r._type && (t = r.titleId);
    }
    var l = e.alignmentInfos.characterPower - e.actorId,
      c = window.gui.playerData.getLevelDiff(l);
    g.setAttributes({
      charName: e.name,
      titleId: t,
      ornamentId: i,
      guild: n,
      alliance: o,
      gender: e.humanoidInfo.sex,
      alignmentInfos: e.alignmentInfos,
      levelDiff: c
    });
    g.display();
  }
  function i() {
    T.getChild("ornamentTooltip") && T.removeChild("ornamentTooltip");
    T.getChild("propertyInfoTooltip") && T.removeChild("propertyInfoTooltip");
    T.clearContent();
  }
  function o(e) {
    window.clearTimeout(O);
    var t = e.bbox,
      i = R.convertSceneToCanvasCoordinate(t[0], t[2]),
      o = R.convertSceneToCanvasCoordinate(t[1], t[3]),
      a = (i.x + o.x) / 2,
      s = (i.y + o.y) / 2,
      l = o.x - i.x,
      c = o.y - i.y,
      d = n.isFeatureOn("singleTooltip") ? T : null,
      u = r.getCoordinatesFromNotch(a, s);
    I.openTooltipAt(u.x, u.y, l, c + 2 * C, d);
  }
  function a(t) {
    var i = E.getFighter(t.actorId);
    return i ? (window.isoEngine.displayEnemyMovementZone(i), window.foreground.isSpellSelected() && M.allowDamagePreview ? (window.gui.damagePreview.preview(window.foreground.tapOptions.spellId, i.data.disposition.cellId), !1) : (T.appendChild(i.createStatsTooltipContent()), !0)) : (I.openState && (e(), window.isoEngine.removeEnemyMovementZone()), window.gui.damagePreview.hide(), !1);
  }
  function s() {
    x && x.nicknameLabel && "name" === x.nicknameLabel.getType() && x.nicknameLabel.show();
  }
  function l(i, n) {
    if (s(), n.name && n.humanoidInfo) {
      if (x = i, i.nicknameLabel) {
        if ("full" === i.nicknameLabel.getType()) {
          return I.closeTooltip(), !1;
        }
        i.nicknameLabel.hide();
      }
      return t(n), I.hideBackgroundOnce(), !1;
    }
    if (n.npcData && n.npcData.nameId) {
      T.setText(n.npcData.nameId);
    } else if ("GameRolePlayGroupMonsterInformations" === n.type) {
      m._constructMonsterTooltip(T, n, i);
    } else {
      if ("PaddockObject" !== n.type) {
        return I.openState && e(), !1;
      }
      var o = n.durability.durability + "/" + n.durability.durabilityMax;
      T.setText(n.name + " (" + o + ")");
    }
    return !0;
  }
  function c(e, t) {
    var i = t.guildInfo,
      n = t._type,
      o = t.price,
      a = t.maxOutdoorMount,
      s = t.maxItems,
      r = "",
      l = "";
    switch (n) {
      case "PaddockInformations":
        r = b("ui.mount.paddockPublic");
        l = b("ui.mount.maxMount", a);
        break;
      case "PaddockAbandonnedInformations":
        r = b("ui.mount.paddockAbandonned");
        l = b("ui.mount.maxMount", a);
        break;
      case "PaddockPrivateInformations":
        r = o > 0 ? b("ui.mount.paddockToBuy", o) : b("ui.mount.paddockPrivate");
        l = b("ui.mount.paddockSize", a, s);
        break;
      case "PaddockBuyableInformations":
        r = t.locked ? b("ui.social.paddockWithNoOwner") : b("ui.mount.paddockToBuy", o);
        l = b("ui.mount.paddockSize", a, s);
    }
    var c = {
      guild: i,
      line1: r,
      line2: l
    };
    L = e;
    _.display(c);
  }
  function u(e, t, i, n) {
    var o = S.playerData,
      a = b("ui.house.homeOf", n || t),
      s = o.identification.uniqueNickname.toString(),
      r = o.position.currentMapHouses[i] || null,
      l = r && r.guildInfo || null;
    "?" === t || "" === t ? a = b("ui.common.houseWithNoOwner") : t === s && (a = b("ui.common.myHouse"));
    var c = null;
    r && (r.isOnSale || r.isSaleLocked) && (c = b(r.isSaleLocked ? "ui.common.forSaleSoon" : "ui.common.forSale"));
    var d = {
      guild: l,
      line1: a,
      line2: c
    };
    L = e;
    _.display(d);
  }
  function h() {
    var t = m.convertScreenToCanvasCoordinate(d.x, d.y),
      n = A.holdAndMove(t.x, t.y);
    if (!n) {
      return N = null, void (I.openState && e());
    }
    if (N !== n) {
      N = n;
      I.resetBackground();
      var s,
        r,
        h,
        f,
        g = A.mapRenderer.isPaddock(n),
        _ = A.mapRenderer.getPaddockProperties(),
        v = n.data,
        y = S.playerData.isFighting;
      if (g && _) {
        return i(), void c(n, _);
      }
      if (v) {
        if (i(), y) {
          if (!a(v)) {
            return;
          }
        } else if (!l(n, v)) {
          return;
        }
      } else {
        if (s = D.interactiveElements[n.id], !s || y) {
          return void (I.openState && e());
        }
        i();
        var w = s._houseData;
        if (s.ageBonus) {
          var b = s.ageBonus;
          T.appendChild(new p(b));
        }
        if (s._name && T.createChild("div", {
          className: "name",
          text: s._name
        }), w) {
          var M = w.houseId,
            C = window.gui.playerData.position.getHousePropertiesById(M);
          return void (C ? u(n, C.ownerName, C.houseId, C._displayedName) : u(n, C.ownerName, C.houseId));
        }
        var E;
        for (h = 0, f = s.enabledSkills.length; h < f; h += 1) {
          r = s.enabledSkills[h];
          E = T.createChild("div");
          E.createChild("div", {
            className: ["interaction", "cursor", "id" + r._cursor]
          });
          E.createChild("div", {
            className: "interaction",
            text: r._name
          });
        }
        for (h = 0, f = s.disabledSkills.length; h < f; h += 1) {
          r = s.disabledSkills[h];
          E = T.createChild("div");
          E.createChild("div", {
            className: ["interaction", "cursor", "id" + r._cursor, "disable"]
          });
          E.createChild("div", {
            className: "interaction",
            text: r._name
          });
        }
      }
      o(n);
    }
  }
  var m = this,
    g = new v({
      name: "ornamentTooltip"
    }, {
      scaleFactor: .8
    }),
    _ = new y({
      name: "propertyInfoTooltip"
    }),
    T = new w("div", {
      className: "sceneTooltip"
    });
  f.addTooltip(this, new w("div"));
  var I,
    A = window.isoEngine,
    S = window.gui,
    E = S.fightManager;
  I = n.isFeatureOn("singleTooltip") ? S.tooltipBox : this.appendChild(new f({
    content: T
  }));
  var N,
    x,
    L,
    O,
    R = A.mapScene,
    D = A.mapRenderer;
  this.on("tooltipOn", function () {
    window.gui.tooltipBox.closeForRecomputing();
    N = null;
    A.holdStart();
    S.wBody.on("dom.touchmove", h);
    h();
  });
  this.on("tooltipOut", function () {
    I.closeTooltip();
    s();
    S.wBody.removeListener("dom.touchmove", h);
    A.holdEnd();
  });
  g.on("rendered", function () {
    x === N && (T.appendChild(g), o(x));
  });
  _.on("rendered", function () {
    L === N && (T.appendChild(_), o(L));
  });
};
a.prototype._setupCameraInteraction = function () {
  function e(e) {
    e = n.convertScreenToCanvasCoordinate(e.x, e.y);
    P[E] = e[E] - x[E];
    P[N] = e[N];
    P[E] < O.min ? (P[E] = O.min, x[E] = e[E] - O.min) : P[E] > O.max && (P[E] = O.max, x[E] = e[E] - O.max);
    b.setStyle("webkitTransform", "translate3d(" + P.x + "px," + P.y + "px,0)");
  }
  function t(e) {
    if (R[N] = P[N], A = r.getChangeMapCellAt(R.x, R.y, M), b.arrow.setStyle("opacity", A !== -1 ? 1 : 0), e[N] < C) {
      S = Math.abs(C - e[N]);
      k[N] = c.min[N];
    } else {
      if (!(e[N] > I)) {
        return;
      }
      S = Math.abs(I - e[N]);
      k[N] = c.max[N];
    }
    if (k[N] !== c[N]) {
      B.x = c.x;
      B.y = c.y;
      c.follow(B);
      var t = 0,
        i = H,
        n = B[N],
        o = k[N];
      Math.abs(k[N] - B[N]) > t && (t = Math.abs(k[N] - B[N]), i = H * S);
      var a = F[N];
      a.playing || a.start(!1);
      "x" === N ? a.reset().from({
        x: n
      }).to({
        x: o
      }, t / i) : a.reset().from({
        y: n
      }).to({
        y: o
      }, t / i);
    }
  }
  m(this);
  var i,
    n = this,
    a = window.gui,
    r = window.isoEngine,
    l = r.mapScene,
    c = l.camera,
    d = a.fightManager,
    u = a.scenarioManager,
    h = 0,
    p = 0,
    f = this.createChild("div", {
      className: ["slide", "left"]
    });
  f.arrow = f.createChild("div", {
    className: "arrow"
  });
  var v = this.createChild("div", {
    className: ["slide", "right"]
  });
  v.arrow = v.createChild("div", {
    className: "arrow"
  });
  var y = this.createChild("div", {
    className: ["slide", "top"]
  });
  y.arrow = y.createChild("div", {
    className: "arrow"
  });
  var w = this.createChild("div", {
    className: ["slide", "bottom"]
  });
  w.arrow = w.createChild("div", {
    className: "arrow"
  });
  var b,
    M,
    C,
    I,
    A,
    S,
    E,
    N,
    x = {
      x: 0,
      y: 0
    },
    L = {
      x: 80,
      y: 60
    },
    O = {
      max: 0,
      min: 0
    },
    R = {},
    D = 5,
    P = {
      x: 0,
      y: 0
    },
    B = {},
    k = {
      x: 0,
      y: 0
    },
    F = {
      x: new _(B, ["x"]),
      y: new _(B, ["y"])
    };
  this.on("transformStart", function (e, t) {
    if (this.locked) {
      return this.cancelTransform();
    }
    if (b = null, d.fightState === o.UNDEFINED && 1 === e.touchCount) {
      var n = e.x - t[0].x,
        a = e.y - t[0].y;
      x = e;
      var r,
        l = c.zoom === c.minZoom || c.zoom === c.maxZoom;
      if (Math.abs(n) > Math.abs(a)) {
        if (r = l || Math.abs(a) < D, Math.abs(c.x - c.min.x) < 1 && n > 0 && r) {
          if (!u.isBehaviourEnabled(T.LEFT_SLIDE_CHANGEMAP)) {
            return;
          }
          return b = f, M = "left", R.x = 0, O.min = 0, O.max = L.x, C = s.mapHeight / 3, I = 2 * C, E = "x", void (N = "y");
        }
        if (Math.abs(c.x - c.max.x) < 1 && n < 0 && r) {
          if (!u.isBehaviourEnabled(T.RIGHT_SLIDE_CHANGEMAP)) {
            return;
          }
          return b = v, M = "right", R.x = s.mapWidth, O.min = -L.x, O.max = 0, C = s.mapHeight / 3, I = 2 * C, E = "x", void (N = "y");
        }
      } else {
        if (r = l || Math.abs(n) < D, Math.abs(c.y - c.min.y) < 1 && a > 0 && r) {
          if (!u.isBehaviourEnabled(T.TOP_SLIDE_CHANGEMAP)) {
            return;
          }
          return b = y, M = "top", R.y = 0, O.min = 0, O.max = L.y, C = s.mapWidth / 3, I = 2 * C, E = "y", void (N = "x");
        }
        if (Math.abs(c.y - c.max.y) < 1 && a < 0 && r) {
          if (!u.isBehaviourEnabled(T.BOTTOM_SLIDE_CHANGEMAP)) {
            return;
          }
          return b = w, M = "bottom", R.y = s.mapHeight, O.min = -L.y, O.max = 0, C = s.mapWidth / 3, I = 2 * C, E = "y", void (N = "x");
        }
      }
    }
    h = p = 0;
    this.setTranslationEnable(!0);
    i = Date.now();
  });
  var H = .5;
  this.on("transform", function (n, o, a, s, d, u) {
    return b ? (e(u), void t(u)) : (r.cancelCameraMovement(), i = Date.now(), c.zoom === c.minZoom && (a = s = 0), h = .5 * h + .5 * -a, p = .5 * p + .5 * -s, void l.move(n, o, -a, -s, d));
  });
  this.on("transformEnd", function () {
    if (F.x.playing && F.x.stop(), F.y.playing && F.y.stop(), b) {
      var e;
      if (e = "x" === E ? "translate3d(0," + P.y + "px,0)" : "translate3d(" + P.x + "px,0,0)", g.tween(b, {
        webkitTransform: e
      }, {
        time: 200,
        easing: "ease-out"
      }), b.arrow.setStyle("opacity", 0), b = null, this.locked) {
        return;
      }
      if (Math.abs(P[E]) === L[E] && A !== -1) {
        var t = l.convertCanvasToSceneCoordinate(R.x, R.y);
        r._tapRoleplay(t.x, t.y, r.mapRenderer.getCellId(t.x, t.y), {
          canvasX: R.x,
          canvasY: R.y,
          changeMapRequest: M,
          mode: "roleplay"
        });
      }
    } else {
      this.setTranslationEnable(d.fightState !== o.BATTLE);
      Date.now() - i > 100 || c.addInertia(h, p, .8);
    }
  });
  d.on("fightEnterBattle", function () {
    n.setTranslationEnable(!1);
  });
  d.on("fightEnd", function () {
    n.setTranslationEnable(!0);
  });
  a.playerData.position.on("mapUpdate", function () {
    c.follow(window.isoEngine.actorManager.userActor);
  });
};
a.prototype.convertScreenToCanvasCoordinate = function (e, t) {
  return {
    x: e - (s.mapLeft + s.bodyPaddingLeft),
    y: t - s.mapTop
  };
};
a.prototype.convertCanvasToScreenCoordinate = function (e, t) {
  return {
    x: e + (s.mapLeft + s.bodyPaddingLeft),
    y: t + s.mapTop
  };
};
a.prototype.convertScreenToSceneCoordinate = function (e, t) {
  return e -= s.mapLeft + s.bodyPaddingLeft, t -= s.mapTop, window.isoEngine.mapScene.convertCanvasToSceneCoordinate(e, t);
};
a.prototype.convertSceneToScreenCoordinate = function (e, t) {
  var i = window.isoEngine.mapScene.convertSceneToCanvasCoordinate(e, t);
  return {
    x: i.x + (s.mapLeft + s.bodyPaddingLeft),
    y: i.y + s.mapTop
  };
};
a = i.x;
s = i.y;
r = function () {
  n = !0;
  p.touchCancel();
  c.removeListener("dom.touchmove", t);
};
this.on("dom.touchstart", function (e) {
  if (i) {
    return r();
  }
  var l = u(e, {
    useScrollValue: !0
  });
  this.locked || l.touchCount > 1 || (a = l.x, s = l.y, i = !0, n = !1, m.fightState !== o.BATTLE && m.fightState !== o.PREPARATION || this.on("dom.touchmove", t));
});
this.on("dom.touchend", function (e) {
  if (this.removeListener("dom.touchmove", t), this.locked || n || !i || !h("TOUCH", f)) {
    return void (i = !1);
  }
  i = !1;
  var o = u(e, {
      useScrollValue: !0
    }),
    a = c.convertScreenToCanvasCoordinate(o.x, o.y);
  p.touchEnd(a.x, a.y, this.tapOptions);
});
this._setupHighlightInteraction();
this._setupCameraInteraction();
n = !0;
p.touchCancel();
c.removeListener("dom.touchmove", t);
window.clearTimeout(O);
O = window.setTimeout(function () {
  I.closeTooltip();
}, 500);
g.setAttributes({
  charName: e.name,
  titleId: t,
  ornamentId: i,
  guild: n,
  alliance: o,
  gender: e.humanoidInfo.sex,
  alignmentInfos: e.alignmentInfos,
  levelDiff: c
});
g.display();
T.getChild("ornamentTooltip") && T.removeChild("ornamentTooltip");
T.getChild("propertyInfoTooltip") && T.removeChild("propertyInfoTooltip");
T.clearContent();
r = b("ui.mount.paddockPublic");
l = b("ui.mount.maxMount", a);
r = b("ui.mount.paddockAbandonned");
l = b("ui.mount.maxMount", a);
r = o > 0 ? b("ui.mount.paddockToBuy", o) : b("ui.mount.paddockPrivate");
l = b("ui.mount.paddockSize", a, s);
r = t.locked ? b("ui.social.paddockWithNoOwner") : b("ui.mount.paddockToBuy", o);
l = b("ui.mount.paddockSize", a, s);
L = e;
_.display(c);
L = e;
_.display(d);
N = n;
I.resetBackground();
r = s.enabledSkills[h];
E = T.createChild("div");
E.createChild("div", {
  className: ["interaction", "cursor", "id" + r._cursor]
});
E.createChild("div", {
  className: "interaction",
  text: r._name
});
r = s.disabledSkills[h];
E = T.createChild("div");
E.createChild("div", {
  className: ["interaction", "cursor", "id" + r._cursor, "disable"]
});
E.createChild("div", {
  className: "interaction",
  text: r._name
});
this.on("tooltipOn", function () {
  window.gui.tooltipBox.closeForRecomputing();
  N = null;
  A.holdStart();
  S.wBody.on("dom.touchmove", h);
  h();
});
this.on("tooltipOut", function () {
  I.closeTooltip();
  s();
  S.wBody.removeListener("dom.touchmove", h);
  A.holdEnd();
});
g.on("rendered", function () {
  x === N && (T.appendChild(g), o(x));
});
_.on("rendered", function () {
  L === N && (T.appendChild(_), o(L));
});
window.gui.tooltipBox.closeForRecomputing();
N = null;
A.holdStart();
S.wBody.on("dom.touchmove", h);
h();
I.closeTooltip();
s();
S.wBody.removeListener("dom.touchmove", h);
A.holdEnd();
e = n.convertScreenToCanvasCoordinate(e.x, e.y);
P[E] = e[E] - x[E];
P[N] = e[N];
P[E] < O.min ? (P[E] = O.min, x[E] = e[E] - O.min) : P[E] > O.max && (P[E] = O.max, x[E] = e[E] - O.max);
b.setStyle("webkitTransform", "translate3d(" + P.x + "px," + P.y + "px,0)");
S = Math.abs(C - e[N]);
k[N] = c.min[N];
S = Math.abs(I - e[N]);
k[N] = c.max[N];
B.x = c.x;
B.y = c.y;
c.follow(B);
a.playing || a.start(!1);
"x" === N ? a.reset().from({
  x: n
}).to({
  x: o
}, t / i) : a.reset().from({
  y: n
}).to({
  y: o
}, t / i);
h = p = 0;
this.setTranslationEnable(!0);
i = Date.now();
this.on("transform", function (n, o, a, s, d, u) {
  return b ? (e(u), void t(u)) : (r.cancelCameraMovement(), i = Date.now(), c.zoom === c.minZoom && (a = s = 0), h = .5 * h + .5 * -a, p = .5 * p + .5 * -s, void l.move(n, o, -a, -s, d));
});
this.on("transformEnd", function () {
  if (F.x.playing && F.x.stop(), F.y.playing && F.y.stop(), b) {
    var e;
    if (e = "x" === E ? "translate3d(0," + P.y + "px,0)" : "translate3d(" + P.x + "px,0,0)", g.tween(b, {
      webkitTransform: e
    }, {
      time: 200,
      easing: "ease-out"
    }), b.arrow.setStyle("opacity", 0), b = null, this.locked) {
      return;
    }
    if (Math.abs(P[E]) === L[E] && A !== -1) {
      var t = l.convertCanvasToSceneCoordinate(R.x, R.y);
      r._tapRoleplay(t.x, t.y, r.mapRenderer.getCellId(t.x, t.y), {
        canvasX: R.x,
        canvasY: R.y,
        changeMapRequest: M,
        mode: "roleplay"
      });
    }
  } else {
    this.setTranslationEnable(d.fightState !== o.BATTLE);
    Date.now() - i > 100 || c.addInertia(h, p, .8);
  }
});
d.on("fightEnterBattle", function () {
  n.setTranslationEnable(!1);
});
d.on("fightEnd", function () {
  n.setTranslationEnable(!0);
});
a.playerData.position.on("mapUpdate", function () {
  c.follow(window.isoEngine.actorManager.userActor);
});
this.setTranslationEnable(d.fightState !== o.BATTLE);
Date.now() - i > 100 || c.addInertia(h, p, .8);
e = void 0 === e || e;
this.castingSpellId = null;
this.casterId = null;
this.targetedCell = null;
this.spell = null;
this.spellRank = null;
this.markId = null;
this.markType = null;
this.silentCast = null;
this.weaponId = -1;
this.isCriticalHit = null;
this.isCriticalFail = null;
e && (this.castingSpellId = o.uniqueSpellId++);
l.call(this);
this.turnCount = 0;
this.fightId = null;
this.turnsList = [];
this.deadTurnsList = [];
this.currentFighterId = 0;
this._lastFighterId = 0;
this._fighters = {};
this.FIGHT_STATES = P;
this.fightState = P.UNDEFINED;
this.fightType = B;
this.isInReconnection = !1;
this.isInactive = !1;
this.turnStartTime = 0;
this.spellCastCounts = {};
this.spellBuffsToIgnore = [];
this.buffSkipped = [];
this.fightMessagesStack = [];
this.isProcessing = !1;
this.asyncFightMessages = {
  GameActionFightDispellableEffectMessage: this.addDispellableEffect,
  GameActionFightCloseCombatMessage: this.gameActionFightCloseCombatAndSpell,
  GameActionFightSpellCastMessage: this.gameActionFightCloseCombatAndSpell
};
r = window.gui.playerData;
this._isTurnEndRequestPending = !1;
this._finishFightSequenceCb = null;
this._spellCasted = [];
this.fightSecretOn = !1;
this.fightHelpOn = !1;
u(a, l);
e.exports = a;
a.FIGHT_STATES = P;
a.FIGHT_OPTION_KEY_TO_ENUM = k;
a.FIGHT_OPTION_ICON_ID = F;
a.prototype.INCREMENT_MODE_SOURCE = 1;
a.prototype.INCREMENT_MODE_TARGET = 2;
a.prototype.getFighters = function () {
  return "fightPlacement" === window.foreground.tapOptions.mode ? this.getOrdonnedPreFighters() : this.turnsList;
};
a.prototype.getDeadFighters = function () {
  return this.deadTurnsList;
};
a.prototype.getAvailableFighters = function () {
  return this._fighters;
};
a.prototype.getFighter = function (e) {
  return this._fighters[e];
};
a.prototype.getTurnCount = function () {
  return this.turnCount;
};
a.prototype.isInFight = function () {
  return this.fightState === P.PREPARATION || this.fightState === P.BATTLE;
};
a.prototype.isInFightPreparation = function () {
  return this.fightState === P.PREPARATION;
};
a.prototype.tacticGraphicsOn = function () {
  this._tacticalModeUsed = !0;
};
a.prototype.resetTacticInfo = function () {
  this._tacticalModeUsed = !1;
};
a.prototype.wasTacticalUsed = function () {
  return this._tacticalModeUsed;
};
a.prototype.getFighterSpell = function (e, t, i) {
  var n = this.getAvailableFighters(),
    o = n[t];
  if (!o) {
    return i(new Error("Spell " + e + " could not be found, its fighter " + t + " does not exist"));
  }
  if (o.spells[e]) {
    return i(null, o.spells[e]);
  }
  var a = r.characters.mainCharacter.spellData;
  if (a.spells[e]) {
    return o.spells[e] = a.spells[e].clone(), o.spells[e].setLevel(a.spells[e].level), i(null, o.spells[e]);
  }
  for (var s in n) {
    if (n.hasOwnProperty(s)) {
      var l = n[s];
      if (l.id === t) {
        continue;
      }
      if (l.spells[e]) {
        return o.spells[e] = l.spells[e].clone(), i(null, o.spells[e]);
      }
    }
  }
  v.createSpells([e], function (n, s) {
    return n ? i(n) : (r.id === t && a.spells[e] && s[e].setLevel(a.spells[e].level), o.spells[e] = s[e], i(null, o.spells[e]));
  });
};
a.prototype._checkInactivityOnTurnStart = function () {
  this.isInactive && (d.isActiveSince(this.turnStartTime) ? this.isInactive = !1 : this.finishTurn());
  this.turnStartTime = Date.now();
};
a.prototype.finishTurn = function () {
  this.emit("finishTurn");
  window.dofus.sendMessage("GameFightTurnFinishMessage");
  this._spellCasted = [];
  this._isTurnEndRequestPending = !0;
};
a.prototype._checkInactivityOnTurnEnd = function () {
  !this.isInactive && !d.isActiveSince(this.turnStartTime) && Date.now() - this.turnStartTime > x && (this.isInactive = !0, window.gui.openSimplePopup(c("ui.fight.inactivityMessage"), c("ui.fight.inactivityTitle")));
};
a.prototype.initialize = function (e) {
  function t() {
    e.timeline && e.timeline.close();
    a.turnsList = [];
    a.deadTurnsList = [];
    a.fightId = null;
    a.currentFighterId = 0;
    a._lastFighterId = 0;
    for (var t in a._fighters) {
      a._fighters.hasOwnProperty(t) && a.removeFighter(t);
    }
    a._fighters = {};
    a.fightState = P.UNDEFINED;
    a.fightType = B;
    a.isInReconnection = !1;
    a.spellCastCounts = {};
    a.fightMessagesStack = [];
    a.isProcessing = !1;
    r.isFightLeader = !1;
    r.isFighting = !1;
    r.isSpectator = !1;
    r.characters.switchControlledCharacter(r.characters.mainCharacterId);
    r.characters.mainCharacter.currentSummonedCreature = 0;
    r.characters.mainCharacter.currentSummonedBomb = 0;
    r.characters.clearSlaves();
    window.actorManager.removeTeamCircles();
    window.actorManager.clearQueuedToCarryActors();
    a._isTurnEndRequestPending = !1;
    a._finishFightSequenceCb = null;
    a._spellCasted = [];
  }
  function i(e) {
    var t = e.id;
    a.currentFighterId = t;
    "GameFightTurnResumeMessage" !== e._messageType && a.decrementDuration(t);
    r.characters.canControlCharacterId(t) && (a.spellCastCounts = {}, a._checkInactivityOnTurnStart(), window.isoEngine.displayTextBanner("tablet.fight.animation.userTurn"));
    a.emit("GameFightTurnStart", e.id, e.waitTime, h.getValue("turnPicture"));
    a._isTurnEndRequestPending = !1;
  }
  function n(e) {
    if (a.fightState === P.PREPARATION) {
      var t = s(e);
      a.emit("UpdatePreFightersList", t.contextualId);
    }
  }
  function o(e, t) {
    var i = a.getAvailableFighters(),
      n = i[e];
    if (!n || !n.data.alive) {
      return console.warn("Fighter was killed previously.");
    }
    C(T.fightDeathStep, [H ? H.castingSpellId : -1, e, !t]);
    var o = n.data.stats.summoner;
    r.characters.canControlCharacterId(o) && (n.isBomb ? r.characters.removeSummonedBomb(o) : r.characters.removeSummonedCreature(o), a.emit("updateSpellsAvailability"));
  }
  var a = this;
  this._tacticalModeUsed = !1;
  var l = window.dofus.connectionManager,
    d = e.playerData.characters;
  d.on("spellList", function () {
    var e = a.getFighter(d.controlledCharacterId),
      t = d.getControlledCharacter();
    if (e && t) {
      for (var i in e.spells) {
        if (e.spells.hasOwnProperty(i)) {
          var n = t.spellData.spells[i];
          n && a._refreshCooldown(e, e.spells[i], n.level);
        }
      }
    }
  });
  e.on("GameFightStartMessage", function () {
    a._cleanFighters();
    a.fightState = P.BATTLE;
    a.emit("fightEnterBattle");
    a.prepareSpellsWithInitialCooldown(r.characters.mainCharacter);
    for (var e in r.characters.slaves) {
      r.characters.slaves.hasOwnProperty(e) && a.prepareSpellsWithInitialCooldown(r.characters.slaves[e]);
    }
    window.isoEngine.displayTextBanner("tablet.fight.animation.fightStarts");
    window.actorManager.removeReadyIcon();
  });
  e.on("GameFightStartingMessage", function (t) {
    a.fightType = t.fightType;
    a.turnCount = 0;
    e.timeline.show();
    a.emit("fightStart");
  });
  e.on("disconnect", function () {
    t();
    M.reset();
  });
  e.on("GameFightEndMessage", function (e) {
    var i = a.getAvailableFighters();
    e.results && e.results.length > 0 && window.gui.scenarioManager.isBehaviourEnabled(N.LEVEL_FIGHT_POPUP) && b.open("fightEnd", {
      msg: e,
      fighters: i
    });
    window.gui.playerData.evaluateRatingOpening("fightEnd", {
      fighters: i
    });
    M.flush(function (e) {
      e && console.error(e);
      t();
      r.isSpectator || M.send(p.FIGHT_END);
      M.reset();
    });
  });
  e.on("GameFightTurnResumeMessage", function (e) {
    i(e);
  });
  e.on("GameFightTurnStartMessage", function (e) {
    i(e);
  });
  e.on("GameFightTurnStartSlaveMessage", function (e) {
    i(e);
  });
  e.on("GameFightHumanReadyStateMessage", function (e) {
    e.characterId === r.id && a.emit("playerReady", e.isReady);
    window.actorManager.setReadyIconOnActor(e.characterId, e.isReady);
  });
  e.on("confirmTurnEnd", function () {
    var e = r.characters;
    if (a._lastFighterId) {
      var t = a._lastFighterId,
        i = a.getFighter(t);
      if (!i) {
        return console.warn("Turn confirmation failed, fighter does not exist:", t);
      }
      if (i.markFinishingBuffs(), i.data.stats.actionPoints = i.data.stats.maxActionPoints, i.data.stats.movementPoints = i.data.stats.maxMovementPoints, t === e.controlledCharacterId) {
        var n = e.getControlledCharacter();
        e.setCharacteristic(n, "actionPointsCurrent", i.data.stats.maxActionPoints);
        e.setCharacteristic(n, "movementPointsCurrent", i.data.stats.maxMovementPoints);
        for (var o in i.spells) {
          if (i.spells.hasOwnProperty(o)) {
            var s = i.spells[o];
            s.newTurn();
          }
        }
        a._checkInactivityOnTurnEnd();
        window.isoEngine.displayTextBanner("tablet.fight.animation.endOfUserTurn");
      }
      a.prepareNextPlayableCharacter();
      a.emit("GameFightTurnEnd", t);
    }
  });
  e.on("GameFightTurnEndMessage", function (e) {
    var t = e.id;
    a._lastFighterId = t;
    var i = a.getFighter(t);
    if (!i) {
      return console.warn("Turn end failed, fighter does not exist");
    }
    if (!i.data.alive && (a.decrementDuration(t), i.markFinishingBuffs(), i.data.stats.actionPoints = i.data.stats.maxActionPoints, i.data.stats.movementPoints = i.data.stats.maxMovementPoints, a.emit("GameFightTurnEnd", t), t === r.characters.controlledCharacterId)) {
      for (var n in i.spells) {
        if (i.spells.hasOwnProperty(n)) {
          var o = i.spells[n];
          o.newTurn();
        }
      }
    }
  });
  e.on("GameFightShowFighterMessage", function (e) {
    a.loadFighter(e);
    n(e);
  });
  e.on("GameFightShowFighterRandomStaticPoseMessage", function (e) {
    a.loadFighter(e);
  });
  e.on("GameActionFightSummonMessage", function (e) {
    n(e);
    var t = e.sourceId,
      i = e.actionId,
      o = e.summon;
    if (t === r.id && i !== _.ACTION_SUMMON_STATIC_CREATURE) {
      var s = a.getFighter(o.contextualId);
      if (!s) {
        return console.error(new Error("Summoning failed, fighter does not exist"));
      }
      i === R || s.isBomb ? r.characters.addSummonedBomb() : s.isCreature && r.characters.addSummonedCreature();
    }
    C(T.fightSummonStep, [H ? H.castingSpellId : -1, t, o]);
  });
  e.on("GameFightTurnListMessage", function (e) {
    a.turnsList = e.ids;
    a.deadTurnsList = e.deadsIds;
    a.emit("FightersListUpdated");
  });
  e.on("GameFightSynchronizeMessage", function (e) {
    var t = e.fighters,
      i = a.getAvailableFighters();
    if (e._synchronizeBuff) {
      for (var n in i) {
        i.hasOwnProperty(n) && i[n].enableBuffs();
      }
    }
    for (var o = 0; o < t.length; o++) {
      var s = t[o];
      if (s.alive) {
        var r = i[s.contextualId];
        if (!r) {
          return console.error(new Error("Synchronizing failed, fighter does not exist"));
        }
        r.synchronizeData(s);
      }
    }
  });
  e.on("GameFightLeaveMessage", function (e) {
    var t = e.charId;
    t === r.id && ("fightPlacement" === window.foreground.tapOptions.mode || r.isSpectator) && a.emit("gameFightLeave", t);
  });
  e.on("_GameActionFightLeaveMessage", function (e) {
    o(e.targetId, !0);
  });
  e.on("GameActionFightDeathMessage", function (e) {
    o(e.targetId, !1);
  });
  e.on("GameFightRefreshFighterMessage", function (e) {
    var t = e.informations,
      i = t.contextualId,
      n = a.getFighter(i);
    return n ? (n.data.updateData({
      look: t.look,
      disposition: t.disposition
    }), void ("fightPlacement" === window.foreground.tapOptions.mode && (n.updateFighterIllustration(), a.emit("UpdatePreFightersList", i)))) : console.error("Refreshing fighter failed, fighter " + i + " does not exist");
  });
  e.on("GameFightRemoveTeamMemberMessage", function (e) {
    var t = e.charId;
    a.removeFighter(t);
    "fightPlacement" === window.foreground.tapOptions.mode && a.emit("UpdatePreFightersList", t);
  });
  e.on("GameFightNewRoundMessage", function (e) {
    a.turnCount = e.roundNumber - 1;
    a.emit("TurnCountUpdated", e.roundNumber - 1);
  });
  e.on("GameFightResumeMessage", function (e) {
    a.gameFightResumeMessage(e);
  });
  e.on("GameFightResumeWithSlavesMessage", function (e) {
    a.gameFightResumeMessage(e);
  });
  e.on("GameFightSpectateMessage", function (e) {
    a.gameFightResumeMessage(e);
  });
  e.on("GameActionFightChangeLookMessage", function (e) {
    var t = e.targetId,
      i = a.getFighter(t);
    if (!i) {
      return console.error(new Error("Changing fighter's look failed, fighter does not exist"));
    }
    var n = e.entityLook;
    i.data.updateData({
      look: n
    });
    i.updateFighterIllustration();
    a.emit(p.FIGHTER_CHANGE_LOOK, [t, n], t);
  });
  e.on("GameActionFightDispellEffectMessage", function (e) {
    C(T.fightDispelEffectStep, [H ? H.castingSpellId : -1, e.targetId, e.boostUID]);
  });
  e.on("GameActionFightDispellSpellMessage", function (e) {
    C(T.fightDispelSpellStep, [H ? H.castingSpellId : -1, e.targetId, e.spellId, e.effectId]);
  });
  e.on("GameActionFightDispellMessage", function (e) {
    C(T.fightDispelStep, [H ? H.castingSpellId : -1, e.targetId, e.effectId]);
  });
  e.on("GameActionFightNoSpellCastMessage", function (e) {
    var t,
      i = e.spellLevelId,
      n = r.characters.getControlledCharacter();
    if (t = 0 === i ? n.spellData.spells[D] : n.spellData.getSpellBySpellLevelId(e.spellLevelId), t && a.spellCastCounts[t.id]) {
      a.spellCastCounts[t.id] -= 1;
      var o = t.getProperty("apCost", t.level);
      r.characters.setCharacteristic(n, "actionPointsCurrent", n.characteristics.actionPointsCurrent + o);
    }
  });
  e.on("GameActionFightLifePointsGainMessage", function (e) {
    C(T.fightLifePointsVariationStep, [H ? H.castingSpellId : -1, e.targetId, e.delta, 0, e.actionId, e.effectId, 0]);
  });
  e.on("GameActionFightLifePointsLostMessage", function (e) {
    C(T.fightLifePointsVariationStep, [H ? H.castingSpellId : -1, e.targetId, -e.loss, -e.permanentDamages, e.actionId, e.effectId, 0]);
  });
  e.on("GameActionFightLifeAndShieldPointsLostMessage", function (e) {
    C(T.fightShieldPointsVariationStep, [H ? H.castingSpellId : -1, e.targetId, -e.shieldLoss, e.actionId, e.effectId]);
    C(T.fightLifePointsVariationStep, [H ? H.castingSpellId : -1, e.targetId, -e.loss, -e.permanentDamages, e.actionId, e.effectId, e.shieldLoss]);
  });
  e.on("GameActionFightPointsVariationMessage", function (e) {
    var t = e.targetId,
      i = e.actionId,
      n = e.delta;
    i === _.ACTION_CHARACTER_ACTION_POINTS_USE || i === _.ACTION_CHARACTER_ACTION_POINTS_LOST || i === _.ACTION_CHARACTER_ACTION_POINTS_WIN ? C(T.fightActionPointsVariationStep, [H ? H.castingSpellId : -1, t, n, i === _.ACTION_CHARACTER_ACTION_POINTS_USE]) : i !== _.ACTION_CHARACTER_MOVEMENT_POINTS_USE && i !== _.ACTION_CHARACTER_MOVEMENT_POINTS_LOST && i !== _.ACTION_CHARACTER_MOVEMENT_POINTS_WIN || C(T.fightMovementPointsVariationStep, [H ? H.castingSpellId : -1, t, n, i === _.ACTION_CHARACTER_MOVEMENT_POINTS_USE]);
  });
  e.on("GameActionFightVanishMessage", function (e) {
    var t = e.targetId,
      i = a.getFighter(t);
    return i ? (i.setAlive(!1), i.dispel(!1, !1, !0), void a.removeLinkedBuff(t)) : console.error(new Error("Vanish failed, fighter does not exist"));
  });
  l.on("CharacterSelectedForceMessage", function () {
    a.isInReconnection = !0;
  });
  e.on("GameFightJoinMessage", function (e) {
    a.fightState = e.isFightStarted ? P.BATTLE : P.PREPARATION;
    a.fightType = e.fightType;
    window.actorManager.userActor.noMovement();
    var t = e.isSpectator;
    t ? window.actorManager.userActor.hide() : window.actorManager.userActor.show();
    r.isSpectator = t;
    r.isFighting = !0;
    e.isFightStarted ? (window.isoEngine.displayTextBanner("tablet.fight.animation.fightStarts"), a.emit("fightEnterBattle", "PREPARATION_SKIPPED")) : (window.isoEngine.displayTextBanner("tablet.fight.animation.preparationPhase"), a.emit("fightEnterPreparation", e));
  });
  e.on("GameActionFightSpellCooldownVariationMessage", function (e) {
    C(T.fightSpellCooldownVariationStep, [H ? H.castingSpellId : -1, e.targetId, e.spellId, e.value]);
  });
  e.on("GameActionFightModifyEffectsDurationMessage", function (e) {
    C(T.fightModifyEffectsDurationStep, [H ? H.castingSpellId : -1, e.sourceId, e.targetId, e.delta, e.effectId]);
  });
  e.on("GameActionFightExchangePositionsMessage", function (e) {
    C(T.fightExchangePositionsStep, [H ? H.castingSpellId : -1, e.sourceId, e.casterCellId, e.targetId, e.targetCellId]);
  });
  e.on("GameActionFightSlideMessage", function (e) {
    C(T.fightSlideStep, [H ? H.castingSpellId : -1, e.targetId, e.endCellId]);
  });
  e.on("GameActionFightTeleportOnSameMapMessage", function (e) {
    C(T.fightTeleportOnSameMapStep, [H ? H.castingSpellId : -1, e.targetId, e.cellId]);
  });
  e.on("GameMapMovementMessage", function (e) {
    var t = e.keyMovements[e.keyMovements.length - 1];
    C(T.mapMovementStep, [H ? H.castingSpellId : -1, e.actorId, t]);
  });
  e.on("GameActionFightCarryCharacterMessage", function (e) {
    C(T.fightCarryCharacterStep, [H ? H.castingSpellId : -1, e.sourceId, e.targetId]);
  });
  e.on("GameActionFightThrowCharacterMessage", function (e) {
    C(T.fightThrowCharacterStep, [H ? H.castingSpellId : -1, e.sourceId, e.targetId, e.cellId]);
  });
  e.on("GameActionFightDropCharacterMessage", function (e) {
    C(T.fightThrowCharacterStep, [H ? H.castingSpellId : -1, e.sourceId, e.targetId, e.cellId]);
  });
  e.on("sendAllFightEvent", function () {
    M.flush();
  });
  e.on("GameActionFightReduceDamagesMessage", function (e) {
    C(T.fightReduceDamages, [H ? H.castingSpellId : -1, e.targetId, e.amount, e.effectId]);
  });
  e.on("GameActionFightDodgePointLossMessage", function (e) {
    var t = e.actionId;
    t === _.ACTION_FIGHT_SPELL_DODGED_PA ? C(T.fightActionPointsLossDodge, [H ? H.castingSpellId : -1, e.targetId, e.amount, e.effectId]) : t === _.ACTION_FIGHT_SPELL_DODGED_PM && C(T.fightMovementPointsLossDodge, [H ? H.castingSpellId : -1, e.targetId, e.amount, e.effectId]);
  });
  e.on("GameActionFightSpellImmunityMessage", function (e) {
    C(T.fightSpellImmunity, [H ? H.castingSpellId : -1, e.targetId, e.effectId]);
  });
  e.on("GameActionFightReflectSpellMessage", function (e) {
    C(T.fightReflectSpellStep, [H ? H.castingSpellId : -1, e.targetId, e.effectId]);
  });
  e.on("GameActionFightReflectDamagesMessage", function (e) {
    C(T.fightReflectDamagesStep, [H ? H.castingSpellId : -1, e.sourceId, e.effectId]);
  });
  e.on("GameActionFightTackledMessage", function (e) {
    C(T.fightTackledStep, [H ? H.castingSpellId : -1, e.sourceId]);
  });
  e.on("GameActionFightKillMessage", function (e) {
    C(T.fightKillStep, [H ? H.castingSpellId : -1, e.targetId, e.sourceId]);
  });
  e.on("GameActionFightInvisibilityMessage", function (e) {
    C(T.fightInvisibilityStep, [H ? H.castingSpellId : -1, e.targetId, e.state, e.effectId]);
  });
  e.on("GameActionFightTriggerGlyphTrapMessage", function (e) {
    C(T.fightTriggerGlyphTrapStep, [H ? H.castingSpellId : -1, e.triggeringCharacterId, e.sourceId, e._spellId, e.effectId]);
  });
  e.on("GameFightUpdateTeamMessage", function (e) {
    a.fightId = e.fightId;
    r.isFightLeader = e.team.leaderId === r.id;
  });
  l.on("GameFightPlacementSwapPositionsMessage", function (e) {
    window.actorManager.setActorsDisposition(e.dispositions, !0);
  });
  l.on("GameFightPlacementSwapPositionsErrorMessage", function () {
    e.openPopup({
      title: c("ui.common.error"),
      message: c("ui.fight.swapPositionError")
    });
  });
  e.on("GameFightOptionStateUpdateMessage", function (e) {
    a.fightId = e.fightId;
    e.option === m.FIGHT_OPTION_SET_SECRET ? a.fightSecretOn = e.state : e.option === m.FIGHT_OPTION_ASK_FOR_HELP && (a.fightHelpOn = e.state);
    a.emit("fightOptionUpdate", e);
  });
  e.on("GameContextDestroyMessage", function () {
    A.isRoleplayMode || (a.fightState = P.UNDEFINED);
  });
};
a.prototype.getNextControllableCharacterId = function () {
  var e = this.turnsList,
    t = e.length;
  if (0 === t) {
    return r.characters.controlledCharacterId;
  }
  for (var i = e.indexOf(this.currentFighterId), n = 1; n < t; n++) {
    var o = e[(i + n) % t],
      a = this.getFighter(o);
    if (!a) {
      return console.error(new Error("Find next controllable character failed, fighter does not exist"));
    }
    if (r.characters.canControlCharacterId(o) && a.data.alive) {
      return o;
    }
  }
  return r.characters.controlledCharacterId;
};
a.prototype.prepareNextPlayableCharacter = function () {
  var e = this.getNextControllableCharacterId();
  r.characters.switchControlledCharacter(e);
};
a.prototype.removeFighter = function (e) {
  var t = this.getFighter(e);
  return t ? (t.clear(), void delete this._fighters[e]) : console.warn("Removing fighter failed, it does not exist");
};
a.prototype._cleanFighters = function () {
  for (var e in this._fighters) {
    if (this._fighters.hasOwnProperty(e)) {
      var t = this._fighters[e];
      t.id <= 0 && "" === t.name && t.data.disposition.cellId === -1 && "GameFightCharacterInformations" === t.data._type && !t.isBomb && !t.isCreature && (this.removeFighter(e), window.actorManager.removeActor(e));
    }
    this.emit("UpdatePreFightersList");
  }
};
a.prototype.loadFighter = function (e) {
  var t = e.actionId,
    i = "GameFightShowFighterRandomStaticPoseMessage" === e._type || t === L || t === O,
    n = s(e);
  if (!n) {
    return void console.warn("Fighter information could not be extracted from this message type: " + e._messageType);
  }
  var o = n.contextualId,
    a = this.getFighter(o);
  a || (a = new g(o, i), this._fighters[o] = a);
  a.setData(n);
  var r = window.actorManager.getActor(a.id);
  r && r.addTeamCircle();
};
a.prototype.prepareSpellsWithInitialCooldown = function (e) {
  function t(e, t) {
    return e ? console.error(e) : void t.resetInitialCooldown(i.turnCount);
  }
  var i = this,
    n = e.spellData.getSpells(I.USABLE);
  for (var o in n) {
    if (n.hasOwnProperty(o)) {
      var a = n[o];
      if (a.isItem || 0 === a.spellLevel.initialCooldown) {
        continue;
      }
      this.getFighterSpell(o, e.spellData.characterId, t);
    }
  }
};
a.prototype.addDispellableEffect = function (e, t) {
  function i() {
    function i(i, o) {
      if (i) {
        return console.error(i);
      }
      var a = o.visibleInFightLog;
      if (o.timeCreationStarted = l.timeCreationStarted, o instanceof f.StateBuff && (952 === o.actionId ? C(T.fightLeavingStateStep, [H ? H.castingSpellId : -1, o.targetId, o.stateId, a]) : C(T.fightEnteringStateStep, [H ? H.castingSpellId : -1, o.targetId, o.stateId, o.effect.getDurationString(), a])), "FightTemporaryBoostEffect" === n._type) {
        var s = e.actionId;
        s !== _.ACTION_CHARACTER_MAKE_INVISIBLE && s !== _.ACTION_CHARACTER_UPDATE_BOOST && s !== _.ACTION_CHARACTER_CHANGE_LOOK && s !== _.ACTION_CHARACTER_CHANGE_COLOR && s !== _.ACTION_CHARACTER_ADD_APPEARANCE && s !== _.ACTION_FIGHT_SET_STATE && C(T.fightTemporaryBoostStep, [H ? H.castingSpellId : -1, e.effect.targetId, o.effect.description, o.effect.duration, o.effect.getDurationString(), a]);
      }
      C(T.fightDisplayBuffStep, [H ? H.castingSpellId : -1, o]);
      var r = window.gui.playerData,
        c = r.characters;
      return c.mainCharacterId !== o.targetId && c.controlledCharacterId !== o.targetId || c.emitCharacteristicsUpdate(c.getControlledCharacter()), delete o.timeCreationStarted, t();
    }
    var n = e.effect;
    f.makeBuffFromEffect(n, r, e.actionId, i);
  }
  var n = e && e.effect || {},
    a = n.effectId,
    s = n.spellId;
  e.effect.effectCaller = "FightManager: GameActionFightDispellableEffectMessage from spellId:" + s;
  e.effect.effectCaller += ",effectId:" + a;
  e.effect.effectCaller += ",params:" + [n.param1, n.param2, n.param3].join(",");
  var r;
  r = new o(e.actionId === _.ACTION_CHARACTER_UPDATE_BOOST ? !1 : !H);
  H && (r.castingSpellId = H.castingSpellId, H.spell.id === s && (r.spellRank = H.spellRank));
  var l = this;
  r.casterId = e.sourceId;
  this.getFighterSpell(s, r.casterId, function (e, n) {
    return e ? t(e) : n ? (r.spell = n, void i()) : t(new Error("unable to find spell id " + s));
  });
};
a.prototype.gameActionFightCloseCombatAndSpell = function (e, t) {
  var i = this,
    n = "GameActionFightCloseCombatMessage" === e._messageType,
    a = 0;
  n && (e.spellId = D, e.spellLevel = 1, a = e.weaponGenericId);
  this.spellCastCounts[e.spellId] && (this.spellCastCounts[e.spellId] = this.spellCastCounts[e.spellId] - 1);
  this.getFighterSpell(e.spellId, e.sourceId, function (s, l) {
    if (s) {
      return t(s);
    }
    if (!l) {
      return t(new Error("unable to find spell id " + e.spellId));
    }
    H = new o();
    H.casterId = e.sourceId;
    H.spell = l;
    H.spellRank = n ? null : l.getProperty("spellLevel", e.spellLevel);
    H.isCriticalFail = e.critical === y.CRITICAL_FAIL;
    H.isCriticalHit = e.critical === y.CRITICAL_HIT;
    H.silentCast = e.silentCast;
    n && (H.weaponId = e.weaponGenericId);
    0 === i.currentFighterId && i.spellBuffsToIgnore.push(H);
    var c = r.characters,
      d = c.controlledCharacterId,
      u = e.sourceId === d;
    u && e.critical !== y.CRITICAL_FAIL && l.cast(i.turnCount, [e.targetId]);
    n && 0 !== a ? C(T.fightCloseCombatStep, [H ? H.castingSpellId : -1, e.sourceId, a, e.critical]) : C(T.fightSpellCastStep, [H ? H.castingSpellId : -1, e.sourceId, e.spellId, e.critical, e.effectId]);
    var h = i.getFighter(e.sourceId),
      p = i.getFighter(c.controlledCharacterId),
      m = p && p.data.teamId === h.data.teamId;
    if (!u && m && !H.isCriticalFail) {
      var f = c.getControlledCharacter().spellData.getSpells(I.USABLE),
        g = f[e.spellId];
      if (g) {
        var _ = l.getProperty("globalCooldown");
        _ === -1 && (_ = g.getProperty("minCastInterval"));
        _ && C(T.fightSpellCooldownVariationStep, [H.castingSpellId, d, e.spellId, _]);
      }
    }
    t();
  });
};
a.prototype._refreshCooldown = function (e, t, i) {
  var n = t.getCooldown(e);
  t.setLevel(i);
  t.forceCooldown(n);
  window.gui.shortcutBar.updateSpellAvailability(t.id);
};
a.prototype._restoreSpellCooldown = function (e, t, i) {
  var n = window.gui.shortcutBar;
  return t.cast(this.turnCount, [], !1), t.forceCooldown(e.cooldown), n.updateSpellAvailability(t.id), i();
};
a.prototype._restoreCooldowns = function (e, t, i) {
  var n = this;
  if (!t || 0 === t.length) {
    return i();
  }
  var o = this.getFighter(e);
  return o ? void w.each(t, function (t, i) {
    if ("GameFightSpellCooldown" !== t._type) {
      return i();
    }
    var a = t.spellId,
      s = o.spells[a];
    return s ? n._restoreSpellCooldown(t, s, i) : void n.getFighterSpell(a, e, function (e, o) {
      return e ? i(e) : n._restoreSpellCooldown(t, o, i);
    });
  }, function (e) {
    i(e);
  }) : console.error(new Error("Restoring cooldowns failed, fighter does not exist."));
};
a.prototype._restoreBuffs = function (e) {
  function t(e, t, i, o) {
    f.makeBuffFromEffect(e, t, i, function (e, t) {
      if (e) {
        return o(e);
      }
      var i = n.getFighter(t.targetId);
      if (!i) {
        return o(new Error("Restoring buffs failed, fighter does not exist"));
      }
      var a = !(t instanceof f.StatBuff);
      return i.addBuff(t, a), o();
    });
  }
  function i(e, i) {
    var s = e.effect || {},
      r = s.effectId,
      l = s.spellId;
    s.effectCaller || (s.effectCaller = "restored buff spellId: " + l, s.effectCaller += ",effectId:" + r, s.effectCaller += ",params:" + [s.param1, s.param2, s.param3].join(","));
    a[s.targetId] || (a[s.targetId] = {});
    a[s.targetId][s.turnDuration] || (a[s.targetId][s.turnDuration] = {});
    var c = a[s.targetId][s.turnDuration][s.spellId];
    return c ? void t(s, c, e.actionId, i) : (c = new o(), c.casterId = n.getFighter(e.sourceId) ? e.sourceId : e.effect.targetId, n.getFighterSpell(s.spellId, c.casterId, function (n, o) {
      return n ? i(n) : o ? (c.spell = o, a[s.targetId][s.turnDuration][s.spellId] = c, void t(s, c, e.actionId, i)) : i(new Error("unable to find spell id " + s.spellId));
    }));
  }
  var n = this,
    a = {};
  w.eachSeries(e, function (e, t) {
    return i(e, t);
  }, function (e) {
    if (n.isInReconnection = !1, e) {
      return console.error(e);
    }
  });
};
a.prototype.gameFightResumeMessage = function (e) {
  var t = this;
  if (r.characters.mainCharacter.currentSummonedCreature = e.summonCount, r.characters.mainCharacter.currentSummonedBomb = e.bombCount, this.turnCount = e.gameTurn - 1, this.emit("TurnCountUpdated", e.gameTurn - 1), "GameFightSpectateMessage" === e._messageType) {
    return t._restoreBuffs(e.effects), M.flush();
  }
  var i = e.slavesInfo || [];
  i.unshift({
    slaveId: r.characters.mainCharacterId,
    spellCooldowns: e.spellCooldowns
  });
  w.eachSeries(i, function (e, i) {
    return t._restoreCooldowns(e.slaveId, e.spellCooldowns, i);
  }, function (i) {
    return i ? console.error(i) : t._restoreBuffs(e.effects);
  });
};
a.prototype.getOrdonnedPreFighters = function () {
  function e(e, t) {
    return e.init === t.init ? t.fighter - e.fighter : t.init - e.init;
  }
  var t = [],
    i = [],
    n = [],
    o = 0,
    a = 0,
    s = this.getAvailableFighters();
  for (var r in s) {
    if (s.hasOwnProperty(r)) {
      var l = s[r],
        c = l.data.stats;
      if (c) {
        c.initiative || 0 === c.initiative || (console.warn("Initiative stats is not defined, it will be initialized at 0."), c.initiative = 0);
        var d = ~~(c.initiative * c.lifePoints / c.maxLifePoints);
        0 === l.data.teamId ? (n.push({
          fighter: r,
          init: d
        }), o += d) : (i.push({
          fighter: r,
          init: d
        }), a += d);
      }
    }
  }
  n.sort(e);
  i.sort(e);
  var u = n,
    h = i;
  (0 === n.length || 0 === i.length || o / n.length < a / i.length) && (u = i, h = n);
  var p,
    m = Math.min(u.length, h.length);
  for (p = 0; p < m; p++) {
    t.push(u[p].fighter);
    t.push(h[p].fighter);
  }
  var f = n.length > i.length ? n : i;
  for (m = f.length; p < m; p++) {
    t.push(f[p].fighter);
  }
  return t;
};
a.prototype.canCastThisSpell = function (e) {
  var t = r.characters.getControlledCharacter(),
    i = r.characters.controlledCharacterId,
    n = this.getFighter(i);
  if (!n) {
    return !1;
  }
  var o = n.states,
    a = t.spellData.getSpells(I.USABLE),
    s = a[e];
  if (!s || !s.isLoaded) {
    return !1;
  }
  var l,
    c = s.getProperty("apCost"),
    d = t.characteristics.actionPointsCurrent;
  if (c > d) {
    return !1;
  }
  var u = s.getProperty("castRestrictedOnMaxInvoc"),
    h = s.getProperty("canSummon");
  if ((h || u) && !r.characters.canSummonCreature()) {
    return !1;
  }
  var p = s.getProperty("canBomb");
  if (p && !r.characters.canSummonBomb()) {
    return !1;
  }
  var m = s.getProperty("statesForbidden"),
    f = s.getProperty("statesRequired");
  for (l = 0; l < o.length; l++) {
    var g = window.gui.databases.SpellStates[o[l]];
    if (m && m.length > 0 && m.indexOf(o[l]) !== -1) {
      return !1;
    }
    if (e === D && g && g.preventsFight) {
      return !1;
    }
  }
  if (f) {
    for (l = 0; l < f.length; l++) {
      if (o.indexOf(f[l]) === -1) {
        return !1;
      }
    }
  }
  var _ = n.spells[e];
  if (_ && _.hasBeenCast()) {
    var v = _.getProperty("maxCastPerTurn");
    if (v > 0 && _.castingData.castThisTurn >= v) {
      return !1;
    }
    if (_.getCooldown(n) > 0) {
      return !1;
    }
  }
  return !0;
};
a.prototype.getSpellCooldown = function (e) {
  var t = r.characters.controlledCharacterId,
    i = this.getFighter(t);
  if (!i || !i.spells[e]) {
    return 0;
  }
  var n = i.spells[e].getCooldown(i);
  return Math.max(0, n);
};
a.prototype.decrementDuration = function (e) {
  this.incrementDuration(e, -1);
};
a.prototype.incrementDuration = function (e, t, i, n) {
  void 0 === n && (n = this.INCREMENT_MODE_SOURCE);
  var o,
    a = this.getAvailableFighters();
  for (var s in a) {
    if (a.hasOwnProperty(s)) {
      o = [];
      for (var r = a[s], l = r.buffs, c = 0; c < l.length; c++) {
        var d = l[c],
          u = a[d.aliveSource];
        if (n === this.INCREMENT_MODE_SOURCE && d.aliveSource === e || n === this.INCREMENT_MODE_TARGET && d.targetId === e || (!u || u && !u.data.alive) && d.targetId === e) {
          var h = this.spellBuffsToIgnore.length;
          if (n === this.INCREMENT_MODE_SOURCE && h && this.buffSkipped.indexOf(d.id) === -1) {
            for (var p = !1, m = 0; m < h; m++) {
              var f = this.spellBuffsToIgnore[m];
              if (f.castingSpellId === d.castingSpell.castingSpellId && f.casterId === e) {
                p = !0;
                this.buffSkipped.push(d.id);
                break;
              }
            }
            if (p) {
              o.map(function (e) {
                return e.id;
              }).indexOf(d.id) === -1 && o.push(d);
              continue;
            }
          }
          var g = d.incrementDuration(t, i);
          d.isActive() ? (o.push(d), g && this.emit("BuffUpdate", d, r)) : (d.remove(), this.emit("BuffRemove", d, r));
        } else {
          o.push(d);
        }
      }
      r.buffs = o;
    }
  }
};
a.prototype.removeLinkedBuff = function (e) {
  var t = this.getAvailableFighters();
  for (var i in t) {
    if (t.hasOwnProperty(i)) {
      for (var n = t[i], o = S(n.buffs), a = 0; a < o.length; a++) {
        var s = o[a];
        s.source === e && n.dispelUniqueBuff(s.id, !1, !0, !1);
        n.isBomb && (s.aliveSource = n.data.stats.summoner);
      }
    }
  }
};
a.prototype.castSpell = function (e, t, i) {
  this._spellCasted.push(e);
  window.dofus.sendMessage("GameActionFightCastRequestMessage", {
    spellId: e,
    cellId: t
  });
  this.spellCastSucceeded(e, i);
};
a.prototype.spellCastSucceeded = function (e, t) {
  if (this.emit("spellCasted"), r.characters.controlledCharacterId === t) {
    var i = this.spellCastCounts[e];
    this.spellCastCounts[e] = i ? i + 1 : 1;
    var n = r.characters.getControlledCharacter(),
      o = n.spellData.spells[e],
      a = o.getProperty("apCost", o.level);
    r.characters.setCharacteristic(n, "actionPointsCurrent", n.characteristics.actionPointsCurrent - a);
  }
};
a.prototype.processFightSequenceMessage = function (e, t) {
  function i(e) {
    if (t(), e && console.error(e), o.isProcessing = !1, o.fightMessagesStack.length) {
      var i = o.fightMessagesStack.shift();
      o.processFightSequenceMessage(i.msg, i.callback);
    } else if (o._finishFightSequenceCb) {
      var n = o._finishFightSequenceCb;
      o._finishFightSequenceCb = null;
      o.timeCreationStarted = null;
      n();
    }
  }
  if (t = t || n, this.timeCreationStarted = this.timeCreationStarted ? this.timeCreationStarted : Date.now(), this.isProcessing) {
    return this.fightMessagesStack.push({
      msg: e,
      callback: t
    });
  }
  var o = this;
  this.isProcessing = !0;
  var a = this.asyncFightMessages[e._messageType];
  return a ? (window.gui.emit(e._messageType, e), a.call(this, e, i)) : (window.gui.emit(e._messageType, e), void i());
};
a.prototype.finishFightSequence = function (e) {
  e && (this._finishFightSequenceCb && console.error("FightManager.finishFightSequence: _finishFightSequenceCb was already set"), this._finishFightSequenceCb = e);
  this._spellCasted.shift();
  this.processFightSequenceMessage({
    _messageType: "sendAllFightEvent"
  });
};
a.prototype.correctActionPoint = function (e, t) {
  for (var i = window.gui.playerData, n = 0, o = 0; o < this._spellCasted.length; o++) {
    this._spellCasted[o] === e && n++;
  }
  var a = n * t,
    s = i.characters.getControlledCharacter();
  i.characters.setCharacteristic(s, "actionPointsCurrent", s.characteristics.actionPointsCurrent + a);
};
a.prototype.isInBattle = function () {
  return this.fightState === P.BATTLE;
};
a.prototype.isFightersTurn = function (e) {
  return this.currentFighterId === e;
};
a.prototype.getIsTurnEndRequestPending = function () {
  return this._isTurnEndRequestPending;
};
a.prototype.isFighterOnUsersTeam = function (e) {
  var t = this.getFighter(window.actorManager.userActor.actorId);
  return !!t && t.isOnSameTeam(e);
};
this.isInactive && (d.isActiveSince(this.turnStartTime) ? this.isInactive = !1 : this.finishTurn());
this.turnStartTime = Date.now();
this.emit("finishTurn");
window.dofus.sendMessage("GameFightTurnFinishMessage");
this._spellCasted = [];
this._isTurnEndRequestPending = !0;
e.timeline && e.timeline.close();
a.turnsList = [];
a.deadTurnsList = [];
a.fightId = null;
a.currentFighterId = 0;
a._lastFighterId = 0;
a._fighters = {};
a.fightState = P.UNDEFINED;
a.fightType = B;
a.isInReconnection = !1;
a.spellCastCounts = {};
a.fightMessagesStack = [];
a.isProcessing = !1;
r.isFightLeader = !1;
r.isFighting = !1;
r.isSpectator = !1;
r.characters.switchControlledCharacter(r.characters.mainCharacterId);
r.characters.mainCharacter.currentSummonedCreature = 0;
r.characters.mainCharacter.currentSummonedBomb = 0;
r.characters.clearSlaves();
window.actorManager.removeTeamCircles();
window.actorManager.clearQueuedToCarryActors();
a._isTurnEndRequestPending = !1;
a._finishFightSequenceCb = null;
a._spellCasted = [];
a.currentFighterId = t;
"GameFightTurnResumeMessage" !== e._messageType && a.decrementDuration(t);
r.characters.canControlCharacterId(t) && (a.spellCastCounts = {}, a._checkInactivityOnTurnStart(), window.isoEngine.displayTextBanner("tablet.fight.animation.userTurn"));
a.emit("GameFightTurnStart", e.id, e.waitTime, h.getValue("turnPicture"));
a._isTurnEndRequestPending = !1;
d.on("spellList", function () {
  var e = a.getFighter(d.controlledCharacterId),
    t = d.getControlledCharacter();
  if (e && t) {
    for (var i in e.spells) {
      if (e.spells.hasOwnProperty(i)) {
        var n = t.spellData.spells[i];
        n && a._refreshCooldown(e, e.spells[i], n.level);
      }
    }
  }
});
e.on("GameFightStartMessage", function () {
  a._cleanFighters();
  a.fightState = P.BATTLE;
  a.emit("fightEnterBattle");
  a.prepareSpellsWithInitialCooldown(r.characters.mainCharacter);
  for (var e in r.characters.slaves) {
    r.characters.slaves.hasOwnProperty(e) && a.prepareSpellsWithInitialCooldown(r.characters.slaves[e]);
  }
  window.isoEngine.displayTextBanner("tablet.fight.animation.fightStarts");
  window.actorManager.removeReadyIcon();
});
e.on("GameFightStartingMessage", function (t) {
  a.fightType = t.fightType;
  a.turnCount = 0;
  e.timeline.show();
  a.emit("fightStart");
});
e.on("disconnect", function () {
  t();
  M.reset();
});
e.on("GameFightEndMessage", function (e) {
  var i = a.getAvailableFighters();
  e.results && e.results.length > 0 && window.gui.scenarioManager.isBehaviourEnabled(N.LEVEL_FIGHT_POPUP) && b.open("fightEnd", {
    msg: e,
    fighters: i
  });
  window.gui.playerData.evaluateRatingOpening("fightEnd", {
    fighters: i
  });
  M.flush(function (e) {
    e && console.error(e);
    t();
    r.isSpectator || M.send(p.FIGHT_END);
    M.reset();
  });
});
e.on("GameFightTurnResumeMessage", function (e) {
  i(e);
});
e.on("GameFightTurnStartMessage", function (e) {
  i(e);
});
e.on("GameFightTurnStartSlaveMessage", function (e) {
  i(e);
});
e.on("GameFightHumanReadyStateMessage", function (e) {
  e.characterId === r.id && a.emit("playerReady", e.isReady);
  window.actorManager.setReadyIconOnActor(e.characterId, e.isReady);
});
e.on("confirmTurnEnd", function () {
  var e = r.characters;
  if (a._lastFighterId) {
    var t = a._lastFighterId,
      i = a.getFighter(t);
    if (!i) {
      return console.warn("Turn confirmation failed, fighter does not exist:", t);
    }
    if (i.markFinishingBuffs(), i.data.stats.actionPoints = i.data.stats.maxActionPoints, i.data.stats.movementPoints = i.data.stats.maxMovementPoints, t === e.controlledCharacterId) {
      var n = e.getControlledCharacter();
      e.setCharacteristic(n, "actionPointsCurrent", i.data.stats.maxActionPoints);
      e.setCharacteristic(n, "movementPointsCurrent", i.data.stats.maxMovementPoints);
      for (var o in i.spells) {
        if (i.spells.hasOwnProperty(o)) {
          var s = i.spells[o];
          s.newTurn();
        }
      }
      a._checkInactivityOnTurnEnd();
      window.isoEngine.displayTextBanner("tablet.fight.animation.endOfUserTurn");
    }
    a.prepareNextPlayableCharacter();
    a.emit("GameFightTurnEnd", t);
  }
});
e.on("GameFightTurnEndMessage", function (e) {
  var t = e.id;
  a._lastFighterId = t;
  var i = a.getFighter(t);
  if (!i) {
    return console.warn("Turn end failed, fighter does not exist");
  }
  if (!i.data.alive && (a.decrementDuration(t), i.markFinishingBuffs(), i.data.stats.actionPoints = i.data.stats.maxActionPoints, i.data.stats.movementPoints = i.data.stats.maxMovementPoints, a.emit("GameFightTurnEnd", t), t === r.characters.controlledCharacterId)) {
    for (var n in i.spells) {
      if (i.spells.hasOwnProperty(n)) {
        var o = i.spells[n];
        o.newTurn();
      }
    }
  }
});
e.on("GameFightShowFighterMessage", function (e) {
  a.loadFighter(e);
  n(e);
});
e.on("GameFightShowFighterRandomStaticPoseMessage", function (e) {
  a.loadFighter(e);
});
e.on("GameActionFightSummonMessage", function (e) {
  n(e);
  var t = e.sourceId,
    i = e.actionId,
    o = e.summon;
  if (t === r.id && i !== _.ACTION_SUMMON_STATIC_CREATURE) {
    var s = a.getFighter(o.contextualId);
    if (!s) {
      return console.error(new Error("Summoning failed, fighter does not exist"));
    }
    i === R || s.isBomb ? r.characters.addSummonedBomb() : s.isCreature && r.characters.addSummonedCreature();
  }
  C(T.fightSummonStep, [H ? H.castingSpellId : -1, t, o]);
});
e.on("GameFightTurnListMessage", function (e) {
  a.turnsList = e.ids;
  a.deadTurnsList = e.deadsIds;
  a.emit("FightersListUpdated");
});
e.on("GameFightSynchronizeMessage", function (e) {
  var t = e.fighters,
    i = a.getAvailableFighters();
  if (e._synchronizeBuff) {
    for (var n in i) {
      i.hasOwnProperty(n) && i[n].enableBuffs();
    }
  }
  for (var o = 0; o < t.length; o++) {
    var s = t[o];
    if (s.alive) {
      var r = i[s.contextualId];
      if (!r) {
        return console.error(new Error("Synchronizing failed, fighter does not exist"));
      }
      r.synchronizeData(s);
    }
  }
});
e.on("GameFightLeaveMessage", function (e) {
  var t = e.charId;
  t === r.id && ("fightPlacement" === window.foreground.tapOptions.mode || r.isSpectator) && a.emit("gameFightLeave", t);
});
e.on("_GameActionFightLeaveMessage", function (e) {
  o(e.targetId, !0);
});
e.on("GameActionFightDeathMessage", function (e) {
  o(e.targetId, !1);
});
e.on("GameFightRefreshFighterMessage", function (e) {
  var t = e.informations,
    i = t.contextualId,
    n = a.getFighter(i);
  return n ? (n.data.updateData({
    look: t.look,
    disposition: t.disposition
  }), void ("fightPlacement" === window.foreground.tapOptions.mode && (n.updateFighterIllustration(), a.emit("UpdatePreFightersList", i)))) : console.error("Refreshing fighter failed, fighter " + i + " does not exist");
});
e.on("GameFightRemoveTeamMemberMessage", function (e) {
  var t = e.charId;
  a.removeFighter(t);
  "fightPlacement" === window.foreground.tapOptions.mode && a.emit("UpdatePreFightersList", t);
});
e.on("GameFightNewRoundMessage", function (e) {
  a.turnCount = e.roundNumber - 1;
  a.emit("TurnCountUpdated", e.roundNumber - 1);
});
e.on("GameFightResumeMessage", function (e) {
  a.gameFightResumeMessage(e);
});
e.on("GameFightResumeWithSlavesMessage", function (e) {
  a.gameFightResumeMessage(e);
});
e.on("GameFightSpectateMessage", function (e) {
  a.gameFightResumeMessage(e);
});
e.on("GameActionFightChangeLookMessage", function (e) {
  var t = e.targetId,
    i = a.getFighter(t);
  if (!i) {
    return console.error(new Error("Changing fighter's look failed, fighter does not exist"));
  }
  var n = e.entityLook;
  i.data.updateData({
    look: n
  });
  i.updateFighterIllustration();
  a.emit(p.FIGHTER_CHANGE_LOOK, [t, n], t);
});
e.on("GameActionFightDispellEffectMessage", function (e) {
  C(T.fightDispelEffectStep, [H ? H.castingSpellId : -1, e.targetId, e.boostUID]);
});
e.on("GameActionFightDispellSpellMessage", function (e) {
  C(T.fightDispelSpellStep, [H ? H.castingSpellId : -1, e.targetId, e.spellId, e.effectId]);
});
e.on("GameActionFightDispellMessage", function (e) {
  C(T.fightDispelStep, [H ? H.castingSpellId : -1, e.targetId, e.effectId]);
});
e.on("GameActionFightNoSpellCastMessage", function (e) {
  var t,
    i = e.spellLevelId,
    n = r.characters.getControlledCharacter();
  if (t = 0 === i ? n.spellData.spells[D] : n.spellData.getSpellBySpellLevelId(e.spellLevelId), t && a.spellCastCounts[t.id]) {
    a.spellCastCounts[t.id] -= 1;
    var o = t.getProperty("apCost", t.level);
    r.characters.setCharacteristic(n, "actionPointsCurrent", n.characteristics.actionPointsCurrent + o);
  }
});
e.on("GameActionFightLifePointsGainMessage", function (e) {
  C(T.fightLifePointsVariationStep, [H ? H.castingSpellId : -1, e.targetId, e.delta, 0, e.actionId, e.effectId, 0]);
});
e.on("GameActionFightLifePointsLostMessage", function (e) {
  C(T.fightLifePointsVariationStep, [H ? H.castingSpellId : -1, e.targetId, -e.loss, -e.permanentDamages, e.actionId, e.effectId, 0]);
});
e.on("GameActionFightLifeAndShieldPointsLostMessage", function (e) {
  C(T.fightShieldPointsVariationStep, [H ? H.castingSpellId : -1, e.targetId, -e.shieldLoss, e.actionId, e.effectId]);
  C(T.fightLifePointsVariationStep, [H ? H.castingSpellId : -1, e.targetId, -e.loss, -e.permanentDamages, e.actionId, e.effectId, e.shieldLoss]);
});
e.on("GameActionFightPointsVariationMessage", function (e) {
  var t = e.targetId,
    i = e.actionId,
    n = e.delta;
  i === _.ACTION_CHARACTER_ACTION_POINTS_USE || i === _.ACTION_CHARACTER_ACTION_POINTS_LOST || i === _.ACTION_CHARACTER_ACTION_POINTS_WIN ? C(T.fightActionPointsVariationStep, [H ? H.castingSpellId : -1, t, n, i === _.ACTION_CHARACTER_ACTION_POINTS_USE]) : i !== _.ACTION_CHARACTER_MOVEMENT_POINTS_USE && i !== _.ACTION_CHARACTER_MOVEMENT_POINTS_LOST && i !== _.ACTION_CHARACTER_MOVEMENT_POINTS_WIN || C(T.fightMovementPointsVariationStep, [H ? H.castingSpellId : -1, t, n, i === _.ACTION_CHARACTER_MOVEMENT_POINTS_USE]);
});
e.on("GameActionFightVanishMessage", function (e) {
  var t = e.targetId,
    i = a.getFighter(t);
  return i ? (i.setAlive(!1), i.dispel(!1, !1, !0), void a.removeLinkedBuff(t)) : console.error(new Error("Vanish failed, fighter does not exist"));
});
l.on("CharacterSelectedForceMessage", function () {
  a.isInReconnection = !0;
});
e.on("GameFightJoinMessage", function (e) {
  a.fightState = e.isFightStarted ? P.BATTLE : P.PREPARATION;
  a.fightType = e.fightType;
  window.actorManager.userActor.noMovement();
  var t = e.isSpectator;
  t ? window.actorManager.userActor.hide() : window.actorManager.userActor.show();
  r.isSpectator = t;
  r.isFighting = !0;
  e.isFightStarted ? (window.isoEngine.displayTextBanner("tablet.fight.animation.fightStarts"), a.emit("fightEnterBattle", "PREPARATION_SKIPPED")) : (window.isoEngine.displayTextBanner("tablet.fight.animation.preparationPhase"), a.emit("fightEnterPreparation", e));
});
e.on("GameActionFightSpellCooldownVariationMessage", function (e) {
  C(T.fightSpellCooldownVariationStep, [H ? H.castingSpellId : -1, e.targetId, e.spellId, e.value]);
});
e.on("GameActionFightModifyEffectsDurationMessage", function (e) {
  C(T.fightModifyEffectsDurationStep, [H ? H.castingSpellId : -1, e.sourceId, e.targetId, e.delta, e.effectId]);
});
e.on("GameActionFightExchangePositionsMessage", function (e) {
  C(T.fightExchangePositionsStep, [H ? H.castingSpellId : -1, e.sourceId, e.casterCellId, e.targetId, e.targetCellId]);
});
e.on("GameActionFightSlideMessage", function (e) {
  C(T.fightSlideStep, [H ? H.castingSpellId : -1, e.targetId, e.endCellId]);
});
e.on("GameActionFightTeleportOnSameMapMessage", function (e) {
  C(T.fightTeleportOnSameMapStep, [H ? H.castingSpellId : -1, e.targetId, e.cellId]);
});
e.on("GameMapMovementMessage", function (e) {
  var t = e.keyMovements[e.keyMovements.length - 1];
  C(T.mapMovementStep, [H ? H.castingSpellId : -1, e.actorId, t]);
});
e.on("GameActionFightCarryCharacterMessage", function (e) {
  C(T.fightCarryCharacterStep, [H ? H.castingSpellId : -1, e.sourceId, e.targetId]);
});
e.on("GameActionFightThrowCharacterMessage", function (e) {
  C(T.fightThrowCharacterStep, [H ? H.castingSpellId : -1, e.sourceId, e.targetId, e.cellId]);
});
e.on("GameActionFightDropCharacterMessage", function (e) {
  C(T.fightThrowCharacterStep, [H ? H.castingSpellId : -1, e.sourceId, e.targetId, e.cellId]);
});
e.on("sendAllFightEvent", function () {
  M.flush();
});
e.on("GameActionFightReduceDamagesMessage", function (e) {
  C(T.fightReduceDamages, [H ? H.castingSpellId : -1, e.targetId, e.amount, e.effectId]);
});
e.on("GameActionFightDodgePointLossMessage", function (e) {
  var t = e.actionId;
  t === _.ACTION_FIGHT_SPELL_DODGED_PA ? C(T.fightActionPointsLossDodge, [H ? H.castingSpellId : -1, e.targetId, e.amount, e.effectId]) : t === _.ACTION_FIGHT_SPELL_DODGED_PM && C(T.fightMovementPointsLossDodge, [H ? H.castingSpellId : -1, e.targetId, e.amount, e.effectId]);
});
e.on("GameActionFightSpellImmunityMessage", function (e) {
  C(T.fightSpellImmunity, [H ? H.castingSpellId : -1, e.targetId, e.effectId]);
});
e.on("GameActionFightReflectSpellMessage", function (e) {
  C(T.fightReflectSpellStep, [H ? H.castingSpellId : -1, e.targetId, e.effectId]);
});
e.on("GameActionFightReflectDamagesMessage", function (e) {
  C(T.fightReflectDamagesStep, [H ? H.castingSpellId : -1, e.sourceId, e.effectId]);
});
e.on("GameActionFightTackledMessage", function (e) {
  C(T.fightTackledStep, [H ? H.castingSpellId : -1, e.sourceId]);
});
e.on("GameActionFightKillMessage", function (e) {
  C(T.fightKillStep, [H ? H.castingSpellId : -1, e.targetId, e.sourceId]);
});
e.on("GameActionFightInvisibilityMessage", function (e) {
  C(T.fightInvisibilityStep, [H ? H.castingSpellId : -1, e.targetId, e.state, e.effectId]);
});
e.on("GameActionFightTriggerGlyphTrapMessage", function (e) {
  C(T.fightTriggerGlyphTrapStep, [H ? H.castingSpellId : -1, e.triggeringCharacterId, e.sourceId, e._spellId, e.effectId]);
});
e.on("GameFightUpdateTeamMessage", function (e) {
  a.fightId = e.fightId;
  r.isFightLeader = e.team.leaderId === r.id;
});
l.on("GameFightPlacementSwapPositionsMessage", function (e) {
  window.actorManager.setActorsDisposition(e.dispositions, !0);
});
l.on("GameFightPlacementSwapPositionsErrorMessage", function () {
  e.openPopup({
    title: c("ui.common.error"),
    message: c("ui.fight.swapPositionError")
  });
});
e.on("GameFightOptionStateUpdateMessage", function (e) {
  a.fightId = e.fightId;
  e.option === m.FIGHT_OPTION_SET_SECRET ? a.fightSecretOn = e.state : e.option === m.FIGHT_OPTION_ASK_FOR_HELP && (a.fightHelpOn = e.state);
  a.emit("fightOptionUpdate", e);
});
e.on("GameContextDestroyMessage", function () {
  A.isRoleplayMode || (a.fightState = P.UNDEFINED);
});
a._cleanFighters();
a.fightState = P.BATTLE;
a.emit("fightEnterBattle");
a.prepareSpellsWithInitialCooldown(r.characters.mainCharacter);
window.isoEngine.displayTextBanner("tablet.fight.animation.fightStarts");
window.actorManager.removeReadyIcon();
a.fightType = t.fightType;
a.turnCount = 0;
e.timeline.show();
a.emit("fightStart");
t();
M.reset();
e.results && e.results.length > 0 && window.gui.scenarioManager.isBehaviourEnabled(N.LEVEL_FIGHT_POPUP) && b.open("fightEnd", {
  msg: e,
  fighters: i
});
window.gui.playerData.evaluateRatingOpening("fightEnd", {
  fighters: i
});
M.flush(function (e) {
  e && console.error(e);
  t();
  r.isSpectator || M.send(p.FIGHT_END);
  M.reset();
});
e && console.error(e);
t();
r.isSpectator || M.send(p.FIGHT_END);
M.reset();
e.characterId === r.id && a.emit("playerReady", e.isReady);
window.actorManager.setReadyIconOnActor(e.characterId, e.isReady);
e.setCharacteristic(n, "actionPointsCurrent", i.data.stats.maxActionPoints);
e.setCharacteristic(n, "movementPointsCurrent", i.data.stats.maxMovementPoints);
a._checkInactivityOnTurnEnd();
window.isoEngine.displayTextBanner("tablet.fight.animation.endOfUserTurn");
a.prepareNextPlayableCharacter();
a.emit("GameFightTurnEnd", t);
a.loadFighter(e);
n(e);
a.turnsList = e.ids;
a.deadTurnsList = e.deadsIds;
a.emit("FightersListUpdated");
a.removeFighter(t);
"fightPlacement" === window.foreground.tapOptions.mode && a.emit("UpdatePreFightersList", t);
a.turnCount = e.roundNumber - 1;
a.emit("TurnCountUpdated", e.roundNumber - 1);
i.data.updateData({
  look: n
});
i.updateFighterIllustration();
a.emit(p.FIGHTER_CHANGE_LOOK, [t, n], t);
C(T.fightShieldPointsVariationStep, [H ? H.castingSpellId : -1, e.targetId, -e.shieldLoss, e.actionId, e.effectId]);
C(T.fightLifePointsVariationStep, [H ? H.castingSpellId : -1, e.targetId, -e.loss, -e.permanentDamages, e.actionId, e.effectId, e.shieldLoss]);
a.fightState = e.isFightStarted ? P.BATTLE : P.PREPARATION;
a.fightType = e.fightType;
window.actorManager.userActor.noMovement();
t ? window.actorManager.userActor.hide() : window.actorManager.userActor.show();
r.isSpectator = t;
r.isFighting = !0;
e.isFightStarted ? (window.isoEngine.displayTextBanner("tablet.fight.animation.fightStarts"), a.emit("fightEnterBattle", "PREPARATION_SKIPPED")) : (window.isoEngine.displayTextBanner("tablet.fight.animation.preparationPhase"), a.emit("fightEnterPreparation", e));
a.fightId = e.fightId;
r.isFightLeader = e.team.leaderId === r.id;
a.fightId = e.fightId;
e.option === m.FIGHT_OPTION_SET_SECRET ? a.fightSecretOn = e.state : e.option === m.FIGHT_OPTION_ASK_FOR_HELP && (a.fightHelpOn = e.state);
a.emit("fightOptionUpdate", e);
a || (a = new g(o, i), this._fighters[o] = a);
a.setData(n);
e.effect.effectCaller = "FightManager: GameActionFightDispellableEffectMessage from spellId:" + s;
e.effect.effectCaller += ",effectId:" + a;
e.effect.effectCaller += ",params:" + [n.param1, n.param2, n.param3].join(",");
r = new o(e.actionId === _.ACTION_CHARACTER_UPDATE_BOOST ? !1 : !H);
H && (r.castingSpellId = H.castingSpellId, H.spell.id === s && (r.spellRank = H.spellRank));
r.casterId = e.sourceId;
this.getFighterSpell(s, r.casterId, function (e, n) {
  return e ? t(e) : n ? (r.spell = n, void i()) : t(new Error("unable to find spell id " + s));
});
n && (e.spellId = D, e.spellLevel = 1, a = e.weaponGenericId);
this.spellCastCounts[e.spellId] && (this.spellCastCounts[e.spellId] = this.spellCastCounts[e.spellId] - 1);
this.getFighterSpell(e.spellId, e.sourceId, function (s, l) {
  if (s) {
    return t(s);
  }
  if (!l) {
    return t(new Error("unable to find spell id " + e.spellId));
  }
  H = new o();
  H.casterId = e.sourceId;
  H.spell = l;
  H.spellRank = n ? null : l.getProperty("spellLevel", e.spellLevel);
  H.isCriticalFail = e.critical === y.CRITICAL_FAIL;
  H.isCriticalHit = e.critical === y.CRITICAL_HIT;
  H.silentCast = e.silentCast;
  n && (H.weaponId = e.weaponGenericId);
  0 === i.currentFighterId && i.spellBuffsToIgnore.push(H);
  var c = r.characters,
    d = c.controlledCharacterId,
    u = e.sourceId === d;
  u && e.critical !== y.CRITICAL_FAIL && l.cast(i.turnCount, [e.targetId]);
  n && 0 !== a ? C(T.fightCloseCombatStep, [H ? H.castingSpellId : -1, e.sourceId, a, e.critical]) : C(T.fightSpellCastStep, [H ? H.castingSpellId : -1, e.sourceId, e.spellId, e.critical, e.effectId]);
  var h = i.getFighter(e.sourceId),
    p = i.getFighter(c.controlledCharacterId),
    m = p && p.data.teamId === h.data.teamId;
  if (!u && m && !H.isCriticalFail) {
    var f = c.getControlledCharacter().spellData.getSpells(I.USABLE),
      g = f[e.spellId];
    if (g) {
      var _ = l.getProperty("globalCooldown");
      _ === -1 && (_ = g.getProperty("minCastInterval"));
      _ && C(T.fightSpellCooldownVariationStep, [H.castingSpellId, d, e.spellId, _]);
    }
  }
  t();
});
H = new o();
H.casterId = e.sourceId;
H.spell = l;
H.spellRank = n ? null : l.getProperty("spellLevel", e.spellLevel);
H.isCriticalFail = e.critical === y.CRITICAL_FAIL;
H.isCriticalHit = e.critical === y.CRITICAL_HIT;
H.silentCast = e.silentCast;
n && (H.weaponId = e.weaponGenericId);
0 === i.currentFighterId && i.spellBuffsToIgnore.push(H);
u && e.critical !== y.CRITICAL_FAIL && l.cast(i.turnCount, [e.targetId]);
n && 0 !== a ? C(T.fightCloseCombatStep, [H ? H.castingSpellId : -1, e.sourceId, a, e.critical]) : C(T.fightSpellCastStep, [H ? H.castingSpellId : -1, e.sourceId, e.spellId, e.critical, e.effectId]);
_ === -1 && (_ = g.getProperty("minCastInterval"));
_ && C(T.fightSpellCooldownVariationStep, [H.castingSpellId, d, e.spellId, _]);
t.setLevel(i);
t.forceCooldown(n);
window.gui.shortcutBar.updateSpellAvailability(t.id);
s.effectCaller || (s.effectCaller = "restored buff spellId: " + l, s.effectCaller += ",effectId:" + r, s.effectCaller += ",params:" + [s.param1, s.param2, s.param3].join(","));
a[s.targetId] || (a[s.targetId] = {});
a[s.targetId][s.turnDuration] || (a[s.targetId][s.turnDuration] = {});
i.unshift({
  slaveId: r.characters.mainCharacterId,
  spellCooldowns: e.spellCooldowns
});
w.eachSeries(i, function (e, i) {
  return t._restoreCooldowns(e.slaveId, e.spellCooldowns, i);
}, function (i) {
  return i ? console.error(i) : t._restoreBuffs(e.effects);
});
n.sort(e);
i.sort(e);
t.push(u[p].fighter);
t.push(h[p].fighter);
p = !0;
this.buffSkipped.push(d.id);
s.source === e && n.dispelUniqueBuff(s.id, !1, !0, !1);
n.isBomb && (s.aliveSource = n.data.stats.summoner);
this._spellCasted.push(e);
window.dofus.sendMessage("GameActionFightCastRequestMessage", {
  spellId: e,
  cellId: t
});
this.spellCastSucceeded(e, i);
o._finishFightSequenceCb = null;
o.timeCreationStarted = null;
n();
e && (this._finishFightSequenceCb && console.error("FightManager.finishFightSequence: _finishFightSequenceCb was already set"), this._finishFightSequenceCb = e);
this._spellCasted.shift();
this.processFightSequenceMessage({
  _messageType: "sendAllFightEvent"
});
o.setStateBuff(r);
t.BasicBuff = o;
t.SpellBuff = a;
t.StatBuff = s;
t.StateBuff = r;
t.TriggeredBuff = l;
t.makeBuffFromEffect = n;
this._disabled = !1;
this._removed = !1;
this.id = e.uid;
this.uid = e.uid;
this.actionId = i;
this.targetId = e.targetId;
this.castingSpell = t;
this.visibleInBuffUI = !0;
this.visibleInFightLog = !0;
this._effectCaller = e.effectCaller;
this._effectCaller || console.error(new Error("BB: No caller in the effect!"));
this.duration = e.turnDuration;
this.dispelable = e.dispelable;
this.source = t.casterId;
this.stack = [];
this.parentBoostUid = 0;
this.effectUid = e.effectId;
this.effectUid === -1 ? this.initParam(n || 0, o || 0, a || 0, s) : p.getDataMap("SpellEffects", [this.effectUid], function (e, t) {
  var i = t && t[r.effectUid];
  e ? console.error("Unable to retrieve the effects visibility for " + r.effectUid + ", " + e) : i && (r.visibleInBuffUI = i.visibleInBuffUI, r.visibleInFightLog = i.visibleInFightLog);
  r.initParam(n || 0, o || 0, a || 0, s);
});
e ? console.error("Unable to retrieve the effects visibility for " + r.effectUid + ", " + e) : i && (r.visibleInBuffUI = i.visibleInBuffUI, r.visibleInFightLog = i.visibleInFightLog);
r.initParam(n || 0, o || 0, a || 0, s);
e.exports = a;
a.prototype.getParam1 = function () {
  return "EffectInstanceDice" === this.effect._type ? this.effect.getParams()[0] : null;
};
a.prototype.getParam2 = function () {
  return "EffectInstanceDice" === this.effect._type ? this.effect.getParams()[1] : null;
};
a.prototype.getParam3 = function () {
  return "EffectInstanceInteger" === this.effect._type ? this.effect.value : "EffectInstanceDice" === this.effect._type ? this.effect.getParams()[2] : null;
};
a.prototype._setParameter = function (e, t) {
  this.effect.setParameter(e, 0 === t ? null : t);
};
a.prototype.setParam1 = function (e) {
  this._setParameter(0, e);
};
a.prototype.setParam2 = function (e) {
  this._setParameter(1, e);
};
a.prototype.setParam3 = function (e) {
  this._setParameter(2, e);
};
a.prototype._effectEnrichment = function () {
  if (this.castingSpell.spell) {
    var e = this.getParam1() || 0,
      t = this.getParam2() || 0,
      i = this.getParam3() || 0;
    o(this.effect) && (e = i, i = 0);
    var n = this.castingSpell.spell.effectInstances;
    for (var a in n) {
      if (n.hasOwnProperty(a)) {
        var s = n[a];
        if (this.actionId === s.effectId && e === s.diceNum && t === s.diceSide && i === s.value) {
          this.effect.targetMask = this.effect.targetMask || s.targetMask;
          this.effect.triggers = this.effect.triggers || s.triggers;
          this.effect.rawZone = this.effect.rawZone || s.rawZone;
          break;
        }
      }
    }
  }
};
a.prototype.initParam = function (e, t, i, o) {
  o || (o = n);
  var a = {
    effectId: this.actionId,
    duration: this.duration,
    trigger: this.isTrigger(),
    value: i,
    hidden: !1,
    targetMask: this.targetMask,
    triggers: this.triggers,
    rawZone: this.rawZone,
    effectCaller: this._effectCaller
  };
  if (e || t) {
    a.diceNum = e;
    a.diceSide = t;
  } else {
    switch (a.effectId) {
      case r.ACTION_CHARACTER_DISPELL_SPELL:
        a.diceNum = 0;
        a.diceSide = 0;
    }
  }
  var s = this,
    l = c.createEffectInstances([a], function (e) {
      return e ? o(e) : (s._effectEnrichment(), o(null, s));
    });
  this.effect = l[0];
  this.stack.push(this.clone());
};
a.prototype.updateParam = function (e, t, i, o) {
  switch (o || (o = n), this.actionId) {
    case 788:
      this.setParam1(t);
      break;
    case 169:
    case 107:
    case 220:
    case 265:
    case 950:
    case 951:
      break;
    default:
      this.setParam1(e);
      this.setParam2(t);
      this.setParam3(i);
  }
  this.refreshDescription(o);
};
a.prototype.equals = function (e, t) {
  var i = this.castingSpell.spellRank && e.castingSpell.spellRank && !t && this.castingSpell.spellRank.id !== e.castingSpell.spellRank.id,
    n = this.isTrigger() && this.duration;
  if (this.targetId !== e.targetId || this.effect.effectId !== e.actionId || this.effectUid !== e.effectUid || this.duration !== e.duration || this.effect.hasOwnProperty("delay") && this.effect.delay !== e.effect.delay || i || !t && this.castingSpell.spell.id !== e.castingSpell.spell.id || this.constructor !== e.constructor || this.source !== e.source || this.isTrigger() && !n) {
    return !1;
  }
  var o = this.actionId;
  if (788 === o) {
    if (this.getParam1() !== e.getParam1()) {
      return !1;
    }
  } else if (m.indexOf(o) !== -1) {
    if (this.getParam1() !== e.getParam1()) {
      return !1;
    }
  } else {
    if (165 === o) {
      return !1;
    }
    if (o === r.ACTION_SUMMON_CREATURE) {
      return !1;
    }
    if (o === e.actionId && (952 === o || 951 === o || 950 === o) && this instanceof s && e instanceof s && this.stateId !== e.stateId) {
      return !1;
    }
  }
  return !0;
};
a.prototype.apply = function () {
  this._disabled = !1;
  this._removed = !1;
};
a.prototype.remove = function () {
  this._removed = !0;
  this._disabled || this.disable();
};
a.prototype.unstack = function (e, t) {
  t || (t = n);
  for (var i = -1, o = 0; o < this.stack.length; o += 1) {
    var a = this.stack[o];
    if (a.uid === e) {
      i = o;
      break;
    }
  }
  if (i !== -1) {
    this.stack.splice(i, 1);
    var s = 0,
      r = 0,
      l = 0,
      c = this.stack[0];
    c && (s = c.getParam1(), r = c.getParam2(), l = c.getParam3());
    this.setParam1(s);
    this.setParam2(r);
    this.setParam3(l);
    for (var d = this.stack.splice(1) || [], u = 0; u < d.length; u += 1) {
      var h = d[u];
      this.addBuff(h);
    }
    return c ? this.refreshDescription(t) : t();
  }
};
a.prototype.enable = function () {
  this._disabled = !1;
};
a.prototype.disable = function () {
  this._disabled = !0;
};
a.prototype.incrementDuration = function (e, t) {
  return !(t && !this.canBeDispell()) && !(this.duration >= 63) && (this.duration + e > 0 ? (this.duration += e, this.effect.duration += e, !0) : this.duration > 0 && (this.duration = 0, this.effect.duration = 0, !0));
};
a.prototype.isActive = function () {
  return 0 !== this.duration;
};
a.prototype.isTrigger = function () {
  return !1;
};
a.prototype.canBeDispell = function (e, t, i) {
  if (t = void 0 === t ? Number.MIN_VALUE : t, t === this.id) {
    return !0;
  }
  switch (this.dispelable) {
    case d.DISPELLABLE:
      return !0;
    case d.DISPELLABLE_BY_STRONG_DISPEL:
      return e;
    case d.DISPELLABLE_BY_DEATH:
      return i || e;
    case d.REALLY_NOT_DISPELLABLE:
      return t === this.id;
    default:
      return !1;
  }
};
a.prototype.updateBuff = function (e) {
  this.stack.length > 0 ? (this.unstack(e.uid), this.addBuff(e)) : this.remove();
  this.updateParam(this.getParam1(), this.getParam2(), this.getParam3());
  this.apply();
};
a.prototype.addBuff = function (e, t) {
  t || (t = n);
  var i = this.castingSpell.spellRank && this.castingSpell.spellRank.maxStack > 0,
    o = i && this.stack && this.stack.length >= this.castingSpell.spellRank.maxStack;
  if (o) {
    return t();
  }
  switch (this.stack.push(e.clone()), this.actionId) {
    case r.ACTION_BOOST_SPELL_MAXPERTARGET:
      this.setParam1(e.getParam1());
      this.setParam2(e.getParam2());
      this.setParam3(this.getParam3() + e.getParam3());
      break;
    case 293:
      this.setParam1(e.getParam1());
      this.setParam2(this.getParam2() + e.getParam2());
      this.setParam3(this.getParam3() + e.getParam3());
      break;
    case 788:
      this.setParam1(this.getParam1() + e.getParam2());
      break;
    case r.ACTION_CHARACTER_MULTIPLY_RECEIVED_DAMAGE:
      var a = this.getParam1(),
        s = 100 - e.getParam1();
      this.setParam1(a - s);
      break;
    case 792:
    case 950:
    case 951:
    case 952:
      break;
    default:
      this.setParam1(this.getParam1() + e.getParam1());
      this.setParam2(this.getParam2() + e.getParam2());
      this.setParam3(this.getParam3() + e.getParam3());
  }
  return this.refreshDescription(t);
};
a.prototype.isUnusableNextTurn = function () {
  if (this.duration > 1 || this.duration < 0) {
    return !1;
  }
  var e = u(),
    t = e.gui.fightManager,
    i = e.gui.playerData.id,
    n = t.currentFighterId;
  if (n === i || n === this.source) {
    return !1;
  }
  var o = t.turnsList,
    a = o.indexOf(i),
    s = o.indexOf(n),
    r = o.indexOf(this.source);
  return r < s && (r += o.length), a < s && (a += o.length), !(a < r);
};
a.prototype.refreshDescription = function (e) {
  this.effect.forceDescriptionRefresh(e);
};
e.exports.setStateBuff = function (e) {
  s = e;
};
a.prototype.getDelta = function () {
  return console.warn("BasicBuff.prototype.getDelta should not be called directly"), 0;
};
a.prototype._copyTo = function (e) {
  var t = h.getOwnProperties(this).filter(function (e) {
    return "effect" !== e;
  });
  h.shallowCopyProperties(this, e, t);
  this.effect && (e.effect = this.effect.clone());
};
a.prototype.clone = function () {
  var e = new a();
  return this._copyTo(e), e;
};
this.effect.targetMask = this.effect.targetMask || s.targetMask;
this.effect.triggers = this.effect.triggers || s.triggers;
this.effect.rawZone = this.effect.rawZone || s.rawZone;
a.diceNum = e;
a.diceSide = t;
a.diceNum = 0;
a.diceSide = 0;
this.effect = l[0];
this.stack.push(this.clone());
this.setParam1(e);
this.setParam2(t);
this.setParam3(i);
this._disabled = !1;
this._removed = !1;
this._removed = !0;
this._disabled || this.disable();
c && (s = c.getParam1(), r = c.getParam2(), l = c.getParam3());
this.setParam1(s);
this.setParam2(r);
this.setParam3(l);
this.stack.length > 0 ? (this.unstack(e.uid), this.addBuff(e)) : this.remove();
this.updateParam(this.getParam1(), this.getParam2(), this.getParam3());
this.apply();
this.setParam1(e.getParam1());
this.setParam2(e.getParam2());
this.setParam3(this.getParam3() + e.getParam3());
this.setParam1(e.getParam1());
this.setParam2(this.getParam2() + e.getParam2());
this.setParam3(this.getParam3() + e.getParam3());
this.setParam1(this.getParam1() + e.getParam1());
this.setParam2(this.getParam2() + e.getParam2());
this.setParam3(this.getParam3() + e.getParam3());
h.shallowCopyProperties(this, e, t);
this.effect && (e.effect = this.effect.clone());
a[o.ACTION_CHARACTER_BOOST_LIFE_POINTS] = ["lifePoints", !0];
a[o.ACTION_CHARACTER_MOVEMENT_POINTS_LOST] = ["movementPoints", !1];
a[o.ACTION_CHARACTER_BOOST_MOVEMENT_POINTS] = ["movementPoints", !0];
a[o.ACTION_CHARACTER_DEBOOST_MOVEMENT_POINTS] = ["movementPoints", !1];
a[o.ACTION_CHARACTER_ACTION_POINTS_LOST] = ["actionPoints", !1];
a[o.ACTION_CHARACTER_BOOST_ACTION_POINTS] = ["actionPoints", !0];
a[o.ACTION_CHARACTER_DEBOOST_ACTION_POINTS] = ["actionPoints", !1];
a[o.ACTION_CHARACTER_DEBOOST_DAMAGES] = ["allDamagesBonus", !1];
a[o.ACTION_CHARACTER_BOOST_DAMAGES] = ["allDamagesBonus", !0];
a[o.ACTION_CHARACTER_BOOST_PHYSICAL_DAMAGES] = ["physicalDamagesBonus", !0];
a[o.ACTION_CHARACTER_DEBOOST_DAMAGES_PERCENT] = ["damagesBonusPercent", !1];
a[o.ACTION_CHARACTER_BOOST_DAMAGES_PERCENT] = ["damagesBonusPercent", !0];
a[o.ACTION_CHARACTER_BOOST_MAXIMUM_SUMMONED_CREATURES] = ["summonableCreaturesBoost", !0];
a[o.ACTION_CHARACTER_DEBOOST_EARTH_ELEMENT_PERCENT] = ["earthElementResistPercent", !1];
a[o.ACTION_CHARACTER_BOOST_EARTH_ELEMENT_PERCENT] = ["earthElementResistPercent", !0];
a[o.ACTION_CHARACTER_DEBOOST_WATER_ELEMENT_PERCENT] = ["waterElementResistPercent", !1];
a[o.ACTION_CHARACTER_BOOST_WATER_ELEMENT_PERCENT] = ["waterElementResistPercent", !0];
a[o.ACTION_CHARACTER_DEBOOST_AIR_ELEMENT_PERCENT] = ["airElementResistPercent", !1];
a[o.ACTION_CHARACTER_BOOST_AIR_ELEMENT_PERCENT] = ["airElementResistPercent", !0];
a[o.ACTION_CHARACTER_DEBOOST_FIRE_ELEMENT_PERCENT] = ["fireElementResistPercent", !1];
a[o.ACTION_CHARACTER_BOOST_FIRE_ELEMENT_PERCENT] = ["fireElementResistPercent", !0];
a[o.ACTION_CHARACTER_DEBOOST_NEUTRAL_ELEMENT_PERCENT] = ["neutralElementResistPercent", !1];
a[o.ACTION_CHARACTER_BOOST_NEUTRAL_ELEMENT_PERCENT] = ["neutralElementResistPercent", !0];
a[o.ACTION_CHARACTER_DEBOOST_EARTH_ELEMENT_PVP_PERCENT] = ["pvpEarthElementResistPercent", !1];
a[o.ACTION_CHARACTER_BOOST_EARTH_ELEMENT_PVP_PERCENT] = ["pvpEarthElementResistPercent", !0];
a[o.ACTION_CHARACTER_DEBOOST_WATER_ELEMENT_PVP_PERCENT] = ["pvpWaterElementResistPercent", !1];
a[o.ACTION_CHARACTER_BOOST_WATER_ELEMENT_PVP_PERCENT] = ["pvpWaterElementResistPercent", !0];
a[o.ACTION_CHARACTER_DEBOOST_AIR_ELEMENT_PVP_PERCENT] = ["pvpAirElementResistPercent", !1];
a[o.ACTION_CHARACTER_BOOST_AIR_ELEMENT_PVP_PERCENT] = ["pvpAirElementResistPercent", !0];
a[o.ACTION_CHARACTER_DEBOOST_FIRE_ELEMENT_PVP_PERCENT] = ["pvpFireElementResistPercent", !1];
a[o.ACTION_CHARACTER_BOOST_FIRE_ELEMENT_PVP_PERCENT] = ["pvpFireElementResistPercent", !0];
a[o.ACTION_CHARACTER_DEBOOST_NEUTRAL_ELEMENT_PVP_PERCENT] = ["pvpNeutralElementResistPercent", !1];
a[o.ACTION_CHARACTER_BOOST_NEUTRAL_ELEMENT_PVP_PERCENT] = ["pvpNeutralElementResistPercent", !0];
a[o.ACTION_CHARACTER_DEBOOST_RANGE] = ["range", !1];
a[o.ACTION_CHARACTER_BOOST_RANGE] = ["range", !0];
a[o.ACTION_CHARACTER_DEBOOST_STRENGTH] = ["strength", !1];
a[o.ACTION_CHARACTER_BOOST_STRENGTH] = ["strength", !0];
a[o.ACTION_CHARACTER_DEBOOST_AGILITY] = ["agility", !1];
a[o.ACTION_CHARACTER_BOOST_AGILITY] = ["agility", !0];
a[o.ACTION_CHARACTER_DEBOOST_CHANCE] = ["chance", !1];
a[o.ACTION_CHARACTER_BOOST_CHANCE] = ["chance", !0];
a[o.ACTION_CHARACTER_DEBOOST_WISDOM] = ["wisdom", !1];
a[o.ACTION_CHARACTER_BOOST_WISDOM] = ["wisdom", !0];
a[o.ACTION_CHARACTER_DEBOOST_VITALITY] = ["vitality", !1];
a[o.ACTION_CHARACTER_BOOST_VITALITY] = ["vitality", !0];
a[o.ACTION_CHARACTER_DEBOOST_INTELLIGENCE] = ["intelligence", !1];
a[o.ACTION_CHARACTER_BOOST_INTELLIGENCE] = ["intelligence", !0];
a[o.ACTION_CHARACTER_BOOST_TRAP] = ["trapBonus", !0];
a[o.ACTION_CHARACTER_BOOST_TRAP_PERCENT] = ["trapBonusPercent", !0];
a[o.ACTION_CHARACTER_DEBOOST_EARTH_ELEMENT_RESIST] = ["earthElementReduction", !1];
a[o.ACTION_CHARACTER_BOOST_EARTH_ELEMENT_RESIST] = ["earthElementReduction", !0];
a[o.ACTION_CHARACTER_DEBOOST_WATER_ELEMENT_RESIST] = ["waterElementReduction", !1];
a[o.ACTION_CHARACTER_BOOST_WATER_ELEMENT_RESIST] = ["waterElementReduction", !0];
a[o.ACTION_CHARACTER_DEBOOST_AIR_ELEMENT_RESIST] = ["airElementReduction", !1];
a[o.ACTION_CHARACTER_BOOST_AIR_ELEMENT_RESIST] = ["airElementReduction", !0];
a[o.ACTION_CHARACTER_DEBOOST_FIRE_ELEMENT_RESIST] = ["fireElementReduction", !1];
a[o.ACTION_CHARACTER_BOOST_FIRE_ELEMENT_RESIST] = ["fireElementReduction", !0];
a[o.ACTION_CHARACTER_DEBOOST_NEUTRAL_ELEMENT_RESIST] = ["neutralElementReduction", !1];
a[o.ACTION_CHARACTER_BOOST_NEUTRAL_ELEMENT_RESIST] = ["neutralElementReduction", !0];
a[o.ACTION_CHARACTER_BOOST_EARTH_ELEMENT_PVP_RESIST] = ["pvpEarthElementReduction", !0];
a[o.ACTION_CHARACTER_BOOST_WATER_ELEMENT_PVP_RESIST] = ["pvpWaterElementReduction", !0];
a[o.ACTION_CHARACTER_BOOST_AIR_ELEMENT_PVP_RESIST] = ["pvpAirElementReduction", !0];
a[o.ACTION_CHARACTER_BOOST_FIRE_ELEMENT_PVP_RESIST] = ["pvpFireElementReduction", !0];
a[o.ACTION_CHARACTER_BOOST_NEUTRAL_ELEMENT_PVP_RESIST] = ["pvpNeutralElementReduction", !0];
a[o.ACTION_CHARACTER_BOOST_CRITICAL_MISS] = ["criticalMiss", !0];
a[o.ACTION_CHARACTER_BOOST_CRITICAL_HIT] = ["criticalHit", !0];
a[o.ACTION_CHARACTER_DEBOOST_CRITICAL_HIT] = ["criticalHit", !1];
a[o.ACTION_CHARACTER_BOOST_INITIATIVE] = ["initiative", !0];
a[o.ACTION_CHARACTER_DEBOOST_INITIATIVE] = ["initiative", !1];
a[o.ACTION_CHARACTER_BOOST_MAGIC_FIND] = ["prospecting", !0];
a[o.ACTION_CHARACTER_DEBOOST_MAGIC_FIND] = ["prospecting", !1];
a[o.ACTION_CHARACTER_BOOST_HEAL_BONUS] = ["healBonus", !0];
a[o.ACTION_CHARACTER_BOOST_SHIELD_BASED_ON_CASTER_LIFE] = ["shieldPoints", !0];
a[o.ACTION_CHARACTER_BOOST_SHIELD] = ["shieldPoints", !0];
a[o.ACTION_CHARACTER_LIFE_POINTS_MALUS] = ["lifePointsMalus", !1];
a[o.ACTION_CHARACTER_LIFE_POINTS_MALUS_PERCENT] = ["lifePointsMalus", !1];
a[o.ACTION_CHARACTER_REFLECTOR_UNBOOSTED] = ["reflectorUnboosted", !0];
a[o.ACTION_CHARACTER_DEBOOST_ACTION_POINTS_LOST_DODGE] = ["dodgePALostProbability", !1];
a[o.ACTION_CHARACTER_BOOST_ACTION_POINTS_LOST_DODGE] = ["dodgePALostProbability", !0];
a[o.ACTION_CHARACTER_DEBOOST_MOVEMENT_POINTS_LOST_DODGE] = ["dodgePMLostProbability", !1];
a[o.ACTION_CHARACTER_BOOST_MOVEMENT_POINTS_LOST_DODGE] = ["dodgePMLostProbability", !0];
a[o.ACTION_CHARACTER_BOOST_DAMAGES_FOR_ALL_GAME] = ["allDamagesBonus", !0];
a[o.ACTION_CHARACTER_DEBOOST_MAXIMUM_WEIGHT] = ["maximumWeight", !1];
a[o.ACTION_CHARACTER_BOOST_MAXIMUM_WEIGHT] = ["maximumWeight", !0];
a[o.ACTION_CHARACTER_DEBOOST_PHYSICAL_REDUCTION] = ["physicalReduction", !1];
a[o.ACTION_CHARACTER_BOOST_PHYSICAL_REDUCTION] = ["physicalReduction", !0];
a[o.ACTION_CHARACTER_DEBOOST_MAGICAL_REDUCTION] = ["magicalReduction", !1];
a[o.ACTION_CHARACTER_BOOST_MAGICAL_REDUCTION] = ["magicalReduction", !0];
a[o.ACTION_CHARACTER_BOOST_DODGE] = ["tackleEvade", !0];
a[o.ACTION_CHARACTER_BOOST_TACKLE] = ["tackleBlock", !0];
a[o.ACTION_CHARACTER_DEBOOST_DODGE] = ["tackleEvade", !1];
a[o.ACTION_CHARACTER_DEBOOST_TACKLE] = ["tackleBlock", !1];
a[o.ACTION_CHARACTER_BOOST_PERMANENT_DAMAGE_PERCENT] = ["permanentDamagePercent", !0];
a[o.ACTION_BOOST_GLOBAL_RESISTS_BONUS] = ["globalResistPercentBonus", !0];
a[o.ACTION_BOOST_GLOBAL_RESISTS_MALUS] = ["globalResistPercentMalus", !0];
a[o.ACTION_CHARACTER_BOOST_PUSH_DAMAGE_REDUCTION] = ["pushDamageReduction", !0];
a[o.ACTION_CHARACTER_BOOST_CRITICAL_DAMAGES_REDUCTION] = ["criticalDamageFixedResist", !0];
a[o.ACTION_CHARACTER_BOOST_PUSH_DAMAGE] = ["pushDamageBonus", !0];
a[o.ACTION_CHARACTER_DEBOOST_PUSH_DAMAGE] = ["pushDamageBonus", !1];
a[o.ACTION_CHARACTER_BOOST_CRITICAL_DAMAGES_BONUS] = ["criticalDamageBonus", !0];
a[o.ACTION_CHARACTER_DEBOOST_CRITICAL_DAMAGES_BONUS] = ["criticalDamageBonus", !1];
a[o.ACTION_CHARACTER_BOOST_CRITICAL_DAMAGES_REDUCTION] = ["criticalDamageReduction", !0];
a[o.ACTION_CHARACTER_DEBOOST_CRITICAL_DAMAGES_REDUCTION] = ["criticalDamageReduction", !1];
a[o.ACTION_CHARACTER_BOOST_DEALT_DAMAGE_PERCENT_MULTIPLIER_MELEE] = ["dealtDamageMultiplierMelee", !0];
a[o.ACTION_CHARACTER_DEBOOST_DEALT_DAMAGE_PERCENT_MULTIPLIER_MELEE] = ["dealtDamageMultiplierMelee", !1];
a[o.ACTION_CHARACTER_BOOST_RECEIVED_DAMAGE_PERCENT_MULTIPLIER_MELEE] = ["receivedDamageMultiplierMelee", !0];
a[o.ACTION_CHARACTER_DEBOOST_RECEIVED_DAMAGE_PERCENT_MULTIPLIER_MELEE] = ["receivedDamageMultiplierMelee", !1];
a[o.ACTION_CHARACTER_BOOST_DEALT_DAMAGE_PERCENT_MULTIPLIER_DISTANCE] = ["dealtDamageMultiplierDistance", !0];
a[o.ACTION_CHARACTER_DEBOOST_DEALT_DAMAGE_PERCENT_MULTIPLIER_DISTANCE] = ["dealtDamageMultiplierDistance", !1];
a[o.ACTION_CHARACTER_BOOST_RECEIVED_DAMAGE_PERCENT_MULTIPLIER_DISTANCE] = ["receivedDamageMultiplierDistance", !0];
a[o.ACTION_CHARACTER_DEBOOST_RECEIVED_DAMAGE_PERCENT_MULTIPLIER_DISTANCE] = ["receivedDamageMultiplierDistance", !1];
a[o.ACTION_CHARACTER_BOOST_DEALT_DAMAGE_PERCENT_MULTIPLIER_WEAPON] = ["dealtDamageMultiplierWeapon", !0];
a[o.ACTION_CHARACTER_DEBOOST_DEALT_DAMAGE_PERCENT_MULTIPLIER_WEAPON] = ["dealtDamageMultiplierWeapon", !1];
a[o.ACTION_CHARACTER_BOOST_RECEIVED_DAMAGE_PERCENT_MULTIPLIER_WEAPON] = ["receivedDamageMultiplierWeapon", !0];
a[o.ACTION_CHARACTER_DEBOOST_RECEIVED_DAMAGE_PERCENT_MULTIPLIER_WEAPON] = ["receivedDamageMultiplierWeapon", !1];
a[o.ACTION_CHARACTER_BOOST_DEALT_DAMAGE_PERCENT_MULTIPLIER_SPELLS] = ["dealtDamageMultiplierSpells", !0];
a[o.ACTION_CHARACTER_DEBOOST_DEALT_DAMAGE_PERCENT_MULTIPLIER_SPELLS] = ["dealtDamageMultiplierSpells", !1];
a[o.ACTION_CHARACTER_BOOST_RECEIVED_DAMAGE_PERCENT_MULTIPLIER_SPELLS] = ["receivedDamageMultiplierSpells", !0];
a[o.ACTION_CHARACTER_DEBOOST_RECEIVED_DAMAGE_PERCENT_MULTIPLIER_SPELLS] = ["receivedDamageMultiplierSpells", !1];
o.getActionStatName = i;
o.getIsABoost = n;
e.exports = o;
this._effectCaller = "";
this._hasMissingDdInfo = !1;
this._effectCaller || M.error(new Error("EF: No caller!"));
this._init();
i || M.error("RD: the effectInstance is needed.");
o[e] || (o[e] = {});
o[e][t] || (o[e][t] = []);
o[e][t].push(i);
m += " caller: " + p.getCaller();
m += " for effectId: " + p.effectId;
M.error(new Error(m));
o[e] = l;
t || (t = {});
t[e] || (t[e] = {});
null === t[0] && t[2] && (t[0] = t[2]);
i ? (t[2] = i.Emoticons[t[0]].nameId, e.setDescription(t)) : o("Emoticons", t[0], e);
t[0] = t[2];
i ? (t[1] = i.Jobs[t[1]].nameId, e.setDescription(t)) : o("Jobs", t[1], e);
v || (M.error(new Error("monster " + d + " missing grade " + p + " for effectId " + r)), v = {});
u = v.level;
h = m.nameId;
e.setDescription(["", u, h]);
t[2] = i.Titles[t[0]][w];
e.setDescription(t);
t[1] > 6 ? t[0] = f("ui.petWeight.fat", [t[1]]) : t[2] > 6 ? t[0] = f("ui.petWeight.lean", [t[2]]) : "EffectInstanceInteger" === e._type && t[0] > 6 ? t[0] = f("ui.petWeight.lean", [t[0]]) : t[0] = f("ui.petWeight.nominal");
e.setDescription(t);
N && (t[0] = N.nameId || f("ui.effect.noMapName"));
e.setDescription(t);
I = S[t[0]] ? S[t[0]].mapId : -1;
o("MapPositions", I, e);
t[2] = t[0];
e.setDescription(t);
t[2] = t[0];
e.setDescription(t);
t[0] || (t[0] = t[2]);
e.setDescription(t);
k && (t[0] = '<span style="color:' + B + '">' + k.textId + "</span>");
e.setDescription(t);
r === T.ACTION_INCARNATION && n(t[4]) && (t[4] = 1);
r === T.ACTION_CAPTURE_RIDE && n(t[0]) && !n(t[2]) && (t[0] = t[2]);
r === T.ACTION_SHIELD_EXPERIENCE && n(t[0]) && (t[0] = 1);
e.setDescription(t);
M.effectCaller = "SubEffect spellLevelId: " + v + " effect#" + b;
M.effectCaller += " from parent: " + e.getCaller();
y.push(M);
t.parseZone = function (e) {
  var i = e.length > 1 ? e.substr(1).split(",") : [],
    n = {
      zoneShape: e.substr(0, 1),
      zoneSize: 0,
      zoneMinSize: 0,
      zoneEfficiencyPercent: 0,
      zoneMaxEfficiency: 0
    };
  if ("l" === n.zoneShape) {
    return n;
  }
  switch (i.length) {
    case 0:
      if ("X" === n.zoneShape) {
        return t.parseZone("X1");
      }
      if ("U" === n.zoneShape) {
        return t.parseZone("U1");
      }
      if ("T" === n.zoneShape) {
        return t.parseZone("T1");
      }
      if ("C" === n.zoneShape) {
        return t.parseZone("C1");
      }
      if ("G" === n.zoneShape) {
        return t.parseZone("G1");
      }
      if ("+" === n.zoneShape) {
        return t.parseZone("+1");
      }
      break;
    case 1:
      n.zoneSize = parseInt(i[0], 10);
      break;
    case 2:
      n.zoneSize = parseInt(i[0], 10);
      t.EFFECT_SHAPES[n.zoneShape].hasMinSize ? n.zoneMinSize = parseInt(i[1], 10) : n.zoneEfficiencyPercent = parseInt(i[1], 10);
      break;
    case 3:
      n.zoneSize = parseInt(i[0], 10);
      t.EFFECT_SHAPES[n.zoneShape].hasMinSize ? (n.zoneMinSize = parseInt(i[1], 10), n.zoneEfficiencyPercent = parseInt(i[2], 10)) : (n.zoneEfficiencyPercent = parseInt(i[1], 10), n.zoneMaxEfficiency = parseInt(i[2], 10));
      break;
    case 4:
      n.zoneSize = parseInt(i[0], 10);
      n.zoneMinSize = parseInt(i[1], 10);
      n.zoneEfficiencyPercent = parseInt(i[2], 10);
      n.zoneMaxEfficiency = parseInt(i[3], 10);
  }
  return n;
};
t.getHumanReadableZoneInfo = function (e) {
  if (!e) {
    return "";
  }
  var i = e.zoneShape,
    n = e.zoneSize;
  return "L" === i && (n += 1), void 0 === t.EFFECT_SHAPES[i] ? (M.error(new Error("EFFECT_SHAPES: missing for " + i)), "") : t.EFFECT_SHAPES[i].desc ? f(t.EFFECT_SHAPES[i].desc, n) : "";
};
o.prototype._init = function () {
  if (this.description = "", this.subEffectDescription = "", this.effect = null, this._retrieveInstanceType(), this.hasOwnProperty("actionId")) {
    if (this.duration = 0, this.effectId = this.actionId, "EffectInstanceDice" === this._type && this.effectId === T.ACTION_INCARNATION) {
      this._type = "EffectInstanceDate";
      this.year = this.diceNum;
      var e = g.getIncarnationExpDetails(this.diceSide, this.diceNum, this.diceConst);
      this.month = e.currentExp;
      this.day = e.level;
      this.hour = 0;
      this.minute = 0;
    } else {
      switch (this._type) {
        case "EffectInstanceString":
          this.text = this.value;
          delete this.value;
          break;
        case "EffectInstanceDice":
          this.value = this.diceConst;
          delete this.diceConst;
          break;
        case "EffectInstanceDate":
          this.month += 1;
      }
    }
  }
};
o.prototype.isBroken = function () {
  return this._hasMissingDdInfo;
};
o.prototype.setBroken = function (e) {
  this._hasMissingDdInfo = e;
};
o.prototype._retrieveInstanceType = function () {
  return this._type ? void (R[this._type] && (this._type = R[this._type])) : void (this.hasOwnProperty("diceNum") ? this._type = "EffectInstanceDice" : this.hasOwnProperty("year") ? this._type = "EffectInstanceDate" : this.hasOwnProperty("days") ? this._type = "EffectInstanceDuration" : this.hasOwnProperty("min") ? this._type = "EffectInstanceMinMax" : this.hasOwnProperty("monsterCount") ? this._type = "EffectInstanceLadder" : this.hasOwnProperty("monsterFamilyId") ? this._type = "EffectInstanceCreature" : this.hasOwnProperty("mountId") ? this._type = "EffectInstanceMount" : this.hasOwnProperty("text") ? this._type = "EffectInstanceString" : this._type = "EffectInstanceInteger");
};
o.prototype.describe = function () {
  return "[EffectInstance: effectId: " + this.effectId + " caller: " + this.getCaller();
};
o.prototype.clone = function () {
  var e = new o({
      effectCaller: this.getCaller()
    }),
    t = b.getOwnProperties(this).filter(function (e) {
      return "effect" !== e;
    });
  b.shallowCopyProperties(this, e, t);
  var i = this.effect;
  return i && (e.effect = {}, b.shallowCopyProperties(i, e.effect, b.getOwnProperties(i))), e;
};
o.prototype.getParams = function () {
  switch (this._type) {
    case "EffectInstanceString":
      return [null, null, null, this.text];
    case "EffectInstanceInteger":
      return [this.value];
    case "EffectInstanceMinMax":
      return [this.min, this.min !== this.max ? this.max : null];
    case "EffectInstanceDice":
      var e = this.value || null,
        t = this.diceSide || null;
      return [0 === this.diceNum ? null : this.diceNum, t, e];
    case "EffectInstanceDate":
      var i = this.month > 9 ? this.month : "0" + this.month,
        n = this.day > 9 ? this.day : "0" + this.day,
        o = this.hour > 9 ? this.hour : "0" + this.hour,
        a = this.minute > 9 ? this.minute : "0" + this.minute;
      return [this.year, i + "" + n, o + "" + a, this.month, this.day];
    case "EffectInstanceDuration":
      return [this.days, this.hours, this.minutes];
    case "EffectInstanceLadder":
      return [this.monsterFamilyId, null, this.monsterCount];
    case "EffectInstanceCreature":
      return [this.monsterFamilyId];
    case "EffectInstanceMount":
      return [this.date, this.modelId, this.mountId];
    default:
      return [];
  }
};
o.prototype.setParameter = function (e, t) {
  switch (this._type) {
    case "EffectInstanceString":
      return void (3 === e && (this.text = t.toString()));
    case "EffectInstanceInteger":
      return void (2 === e && (this.value = t));
    case "EffectInstanceMinMax":
      return void (0 === e ? this.min = t : 1 === e && (this.max = t));
    case "EffectInstanceDice":
      return void (0 === e ? this.diceNum = t : 1 === e ? this.diceSide = t : 2 === e && (this.value = t));
    case "EffectInstanceDate":
      return void (0 === e ? this.year = t : 1 === e ? (this.month = t.substr(0, 2), this.day = t.substr(2, 2)) : 2 === e ? (this.hour = t.substr(0, 2), this.minute = t.substr(2, 2)) : 3 === e ? this.month = t : 4 === e && (this.day = t));
    case "EffectInstanceDuration":
      return void (0 === e ? this.days = t : 1 === e ? this.hours = t : 2 === e && (this.minutes = t));
    case "EffectInstanceLadder":
      return void (0 === e ? this.monsterFamilyId = t : 2 === e && (this.monsterCount = t));
    case "EffectInstanceCreature":
      return void (0 === e && (this.monsterFamilyId = t));
    case "EffectInstanceMount":
      0 === e ? this.date = Number(t) : 1 === e ? this.modelId = Number(t) : 2 === e && (this.mountId = Number(t));
  }
};
o.prototype.getValue = function (e) {
  return this.hasOwnProperty(e) ? this[e] : O[e];
};
o.prototype.setDescription = function (e) {
  if (this.effect.hasOwnProperty("descriptionId")) {
    var t = "";
    if (this.effect.descriptionId) {
      for (var i = [], n = 0; n < e.length; n += 1) {
        var o = e[n];
        if (0 === n && Number.isInteger(o) && Number.isInteger(this.baseValue)) {
          var a = o - this.baseValue;
          i.push(this.baseValue + " (+" + a + ")");
        } else {
          i.push(o);
        }
      }
      t = v(this.effect.descriptionId, i, this.describe(), {
        isPreview: Boolean(this.isPreview)
      });
    }
    this.description = t;
    var s = this.getValue("modificator");
    0 !== s && (this.description += " " + f("ui.effect.boosted.spell.complement", [s], "%"));
    var r = this.getValue("random");
    r > 0 && (this.getValue("group") > 0 ? this.description += " (" + f("ui.common.random") + ")" : this.description += " " + f("ui.effect.randomProbability", [r], "%"));
    this.trigger && (this.description = f("ui.spell.trigger", this.description));
  }
};
o.prototype.getDurationString = function (e) {
  return this.delay ? f("ui.common.delayTurn", this.delay, this.delay <= 1) : !this.duration || isNaN(this.duration) ? "" : this.duration < 0 ? f("ui.common.infinit") : this.duration > 1 ? f("ui.common.turn", this.duration, !0) : e ? f("ui.common.lastTurn") : f("ui.common.turn", this.duration, !1);
};
o.prototype.isDamageEffect = function () {
  return this.effect && this.effect.category === I.damage;
};
o.prototype.isInZoneEffect = function (e) {
  return Boolean(this.cellZoneEffect[e]);
};
o.prototype.getZoneEffect = function () {
  return this.rawZone ? t.parseZone(this.rawZone) : {
    zoneShape: this.getValue("zoneShape"),
    zoneSize: this.getValue("zoneSize"),
    zoneMinSize: this.getValue("zoneMinSize"),
    zoneEfficiencyPercent: this.getValue("zoneEfficiencyPercent"),
    zoneMaxEfficiency: this.getValue("zoneMaxEfficiency")
  };
};
o.prototype.getHumanReadableZoneInfo = function () {
  return t.getHumanReadableZoneInfo(this.getZoneEffect());
};
o.prototype.requiresInvocationDescription = function () {
  return this.effectId === T.ACTION_SUMMON_CREATURE || this.effectId === T.ACTION_SUMMON_SLAVE;
};
o.prototype.requiresGlyphDescription = function () {
  return this.effectId === T.ACTION_FIGHT_ADD_GLYPH_CASTING_SPELL || this.effectId === T.ACTION_FIGHT_ADD_GLYPH_CASTING_SPELL_ENDTURN;
};
o.prototype.requiresTrapDescription = function () {
  return this.effectId === T.ACTION_FIGHT_ADD_TRAP_CASTING_SPELL;
};
o.prototype.requiresBombDescription = function () {
  return this.effectId === T.ACTION_SUMMON_BOMB;
};
o.prototype.isDirectEffect = function () {
  return !(this.delay || this.duration && "I" !== this.triggers || this.isPreview);
};
o.prototype.getCaller = function () {
  return this._effectCaller;
};
o.prototype.forceDescriptionRefresh = function (e) {
  this.description = "";
  this.subEffectDescription = "";
  l([this], null, function (t) {
    return e ? e(t) : void (t && M.error(t));
  });
};
t.createEffectInstances = function (e, t) {
  e instanceof Array || (M.error(new Error("EF: Not an Array")), e = [e]);
  for (var i = [], n = 0; n < e.length; n++) {
    i.push(new o(e[n]));
  }
  return h(i, t), i;
};
t.createEffectInstancesIndexed = function (e, i) {
  var n = [];
  for (var o in e) {
    e.hasOwnProperty(o) && (n.push(e[o]), e[o] = n.length - 1);
  }
  t.createEffectInstances(n, function (t, n) {
    if (t) {
      return i(t);
    }
    for (var o in e) {
      e.hasOwnProperty(o) && (e[o] = n[e[o]]);
    }
    return i(null, e);
  });
};
n.zoneSize = parseInt(i[0], 10);
t.EFFECT_SHAPES[n.zoneShape].hasMinSize ? n.zoneMinSize = parseInt(i[1], 10) : n.zoneEfficiencyPercent = parseInt(i[1], 10);
n.zoneSize = parseInt(i[0], 10);
t.EFFECT_SHAPES[n.zoneShape].hasMinSize ? (n.zoneMinSize = parseInt(i[1], 10), n.zoneEfficiencyPercent = parseInt(i[2], 10)) : (n.zoneEfficiencyPercent = parseInt(i[1], 10), n.zoneMaxEfficiency = parseInt(i[2], 10));
n.zoneSize = parseInt(i[0], 10);
n.zoneMinSize = parseInt(i[1], 10);
n.zoneEfficiencyPercent = parseInt(i[2], 10);
n.zoneMaxEfficiency = parseInt(i[3], 10);
this._type = "EffectInstanceDate";
this.year = this.diceNum;
this.month = e.currentExp;
this.day = e.level;
this.hour = 0;
this.minute = 0;
this.text = this.value;
delete this.value;
this.value = this.diceConst;
delete this.diceConst;
r > 0 && (this.getValue("group") > 0 ? this.description += " (" + f("ui.common.random") + ")" : this.description += " " + f("ui.effect.randomProbability", [r], "%"));
this.trigger && (this.description = f("ui.spell.trigger", this.description));
this.description = "";
this.subEffectDescription = "";
l([this], null, function (t) {
  return e ? e(t) : void (t && M.error(t));
});
t.toHexaString = i;
t.colorArrayToHexa = n;
t.hexToColorArray = o;
t.rgbaToColorArray = a;
t.parseIndexedColor = s;
t.addIndex = r;
t.addIndexes = l;
t.anyToColorArray = c;
t.parseIndexedColors = d;
t.getIndexedColor = u;
t.hexToRgb = h;
r(n, o);
e.exports = n;
n.prototype.getDelta = function () {
  return this._delta;
};
n.prototype.apply = function () {
  if (this.targetId === window.gui.playerData.characters.controlledCharacterId) {
    this.modifType = s(this.actionId);
    this.actionId === a.ACTION_DEBOOST_SPELL_RANGE && (this._delta *= -1);
    for (var e = !1, t = window.gui.playerData.characters.mainCharacter.characteristics.spellModifications, i = 0; i < t.length; i++) {
      var n = t[i];
      if (this.spellId === n.spellId && n.modificationType === this.modifType) {
        e = !0;
        var r = n.value.getContextModif();
        n.value.setPts({
          contextModif: r + this._delta
        });
      }
    }
    if (!e) {
      var c = new l({
        spellId: this.spellId,
        modificationType: this.modifType,
        value: {
          contextModif: this._delta
        }
      });
      t.push(c);
    }
    this.actionId === a.ACTION_BOOST_SPELL_AP_COST && window.gui.fightManager.correctActionPoint(this.spellId, this._delta);
  }
  o.prototype.apply.call(this);
};
n.prototype.remove = function () {
  if (!this._removed && this.targetId === window.gui.playerData.characters.controlledCharacterId) {
    for (var e = window.gui.playerData.characters.mainCharacter.characteristics.spellModifications, t = 0; t < e.length; t++) {
      var i = e[t];
      if (this.spellId === i.spellId && i.modificationType === this.modifType) {
        var n = i.value.getContextModif();
        i.value.setPts({
          contextModif: n - this._delta
        });
      }
    }
  }
  o.prototype.remove.call(this);
};
n.prototype.clone = function () {
  var e = new n();
  return this._copyTo(e), e;
};
this.modifType = s(this.actionId);
this.actionId === a.ACTION_DEBOOST_SPELL_RANGE && (this._delta *= -1);
s[o.ACTION_BOOST_SPELL_RANGEABLE] = a.RANGEABLE;
s[o.ACTION_BOOST_SPELL_DMG] = a.DAMAGE;
s[o.ACTION_BOOST_SPELL_BASE_DMG] = a.BASE_DAMAGE;
s[o.ACTION_BOOST_SPELL_HEAL] = a.HEAL_BONUS;
s[o.ACTION_BOOST_SPELL_AP_COST] = a.AP_COST;
s[o.ACTION_BOOST_SPELL_CAST_INTVL] = a.CAST_INTERVAL;
s[o.ACTION_BOOST_SPELL_CAST_INTVL_SET] = a.CAST_INTERVAL_SET;
s[o.ACTION_BOOST_SPELL_CC] = a.CRITICAL_HIT_BONUS;
s[o.ACTION_BOOST_SPELL_CASTOUTLINE] = a.CAST_LINE;
s[o.ACTION_BOOST_SPELL_NOLINEOFSIGHT] = a.LOS;
s[o.ACTION_BOOST_SPELL_MAXPERTURN] = a.MAX_CAST_PER_TURN;
s[o.ACTION_BOOST_SPELL_MAXPERTARGET] = a.MAX_CAST_PER_TARGET;
s[o.ACTION_BOOST_SPELL_RANGE] = a.RANGE;
s[o.ACTION_DEBOOST_SPELL_RANGE] = a.RANGE;
e.exports = n;
a(n, o);
e.exports = n;
n.prototype.getDelta = function () {
  return "EffectInstanceDice" === this.effect._type ? this.isABoost ? this.effect.diceNum : -this.effect.diceNum : 0;
};
n.prototype.apply = function () {
  var e = this.getDelta();
  this.incrementStats(e);
  o.prototype.apply.call(this);
};
n.prototype.remove = function () {
  if (!this._removed && !this.effect.effect.active) {
    var e = this.getDelta();
    this.decrementStats(e);
  }
  o.prototype.remove.call(this);
};
n.prototype.unstack = function (e) {
  if (!this._removed) {
    var t = this.getDelta();
    this.decrementStats(t);
  }
  o.prototype.unstack.call(this, e);
};
n.prototype.disable = function () {
  if (!this._disabled && this.effect.effect.active) {
    var e = this.getDelta();
    this.decrementStats(e);
  }
  o.prototype.disable.call(this);
};
n.prototype.incrementStats = function (e) {
  if (e) {
    var t = r(),
      i = t.gui,
      n = i.fightManager.getFighter(this.targetId);
    if (!n) {
      return void console.error("Trying to apply a stats buff on non-existing fighter " + this.targetId);
    }
    var o = n.data.stats;
    switch (this.statName) {
      case "vitality":
        o.lifePoints += e;
        o.maxLifePoints += e;
        break;
      case "lifePointsMalus":
        o.lifePoints = Math.min(o.lifePoints + e, o.maxLifePoints);
        break;
      case "lifePoints":
      case "shieldPoints":
      case "dodgePALostProbability":
      case "dodgePMLostProbability":
        o[this.statName] = Math.max(o[this.statName] + e, 0);
        break;
      case "agility":
        o.tackleEvade += ~~(e / 10);
        o.tackleBlock += ~~(e / 10);
        break;
      case "globalResistPercentMalus":
      case "globalResistPercentBonus":
        var a = "globalResistPercentBonus" === this.statName ? 1 : -1;
        o.neutralElementResistPercent += e * a;
        o.airElementResistPercent += e * a;
        o.waterElementResistPercent += e * a;
        o.earthElementResistPercent += e * a;
        o.fireElementResistPercent += e * a;
        break;
      case "actionPoints":
        o.actionPoints += e;
        o.maxActionPoints += e;
        break;
      case "movementPoints":
        o.movementPoints += e;
        o.maxMovementPoints += e;
        break;
      default:
        o.hasOwnProperty(this.statName) && (o[this.statName] += e);
    }
    var s = i.playerData.characters;
    if (s.mainCharacterId === this.targetId || s.controlledCharacterId === this.targetId) {
      var l;
      if (l = s.mainCharacterId === this.targetId ? s.mainCharacter : s.getControlledCharacter(), l.timeStatsSynchronized - this.timeCreationStarted > 0) {
        return void ("summonableCreaturesBoost" === this.statName ? i.fightManager.emit("updateSpellsAvailability") : "range" === this.statName && t.foreground.refreshSpellRange());
      }
      var c = l.characteristics;
      if (c && c.hasOwnProperty(this.statName) && c[this.statName]) {
        if ("CharacterBaseCharacteristic" === c[this.statName]._type) {
          var d = c[this.statName],
            u = d.getContextModif();
          d.setPts({
            contextModif: u + e
          });
        } else {
          var h = "StatBuff: Try to update an unknown type " + c[this.statName]._type;
          h += " for " + this.statName;
          console.error(new Error(h));
        }
      }
      switch (this.statName) {
        case "vitality":
          s.setCharacteristic(l, "maxLifePoints", Math.max(0, c.maxLifePoints + e));
          s.setCharacteristic(l, "lifePoints", Math.max(0, c.lifePoints + e));
          break;
        case "lifePoints":
        case "lifePointsMalus":
          s.setCharacteristic(l, "lifePoints", Math.max(0, c.lifePoints + e));
          break;
        case "movementPoints":
          s.setCharacteristic(l, "movementPointsCurrent", c.movementPointsCurrent + e);
          break;
        case "actionPoints":
          s.setCharacteristic(l, "actionPointsCurrent", c.actionPointsCurrent + e);
          break;
        case "summonableCreaturesBoost":
          i.fightManager.emit("updateSpellsAvailability");
          break;
        case "range":
          t.foreground.refreshSpellRange();
      }
    }
  }
};
n.prototype.decrementStats = function (e) {
  this.incrementStats(-e);
};
n.prototype.clone = function () {
  var e = new n();
  return this._copyTo(e), e;
};
this.incrementStats(e);
o.prototype.apply.call(this);
o.lifePoints += e;
o.maxLifePoints += e;
o.tackleEvade += ~~(e / 10);
o.tackleBlock += ~~(e / 10);
o.neutralElementResistPercent += e * a;
o.airElementResistPercent += e * a;
o.waterElementResistPercent += e * a;
o.earthElementResistPercent += e * a;
o.fireElementResistPercent += e * a;
o.actionPoints += e;
o.maxActionPoints += e;
o.movementPoints += e;
o.maxMovementPoints += e;
h += " for " + this.statName;
console.error(new Error(h));
s.setCharacteristic(l, "maxLifePoints", Math.max(0, c.maxLifePoints + e));
s.setCharacteristic(l, "lifePoints", Math.max(0, c.lifePoints + e));
a(n, o);
e.exports = n;
n.prototype.apply = function () {
  var e = window.gui.fightManager.getFighter(this.targetId);
  return e ? (e.addState(this.stateId), window.gui.shortcutBar.updateSpellsAvailability(), void o.prototype.apply.call(this)) : console.error("Applying state buff failed, fighter does not exist.");
};
n.prototype.remove = function () {
  if (!this._removed) {
    var e = window.gui.fightManager.getFighter(this.targetId);
    if (!e) {
      return console.error("Removing state buff failed, fighter does not exist.");
    }
    e.removeState(this.stateId);
    window.gui.shortcutBar.updateSpellsAvailability();
    var t = this.targetId,
      i = this.visibleInFightLog;
    window.gui.fightManager.deadTurnsList.indexOf(t) === -1 && (952 === this.actionId ? r.push(l.FIGHTER_ENTERING_STATE, [t, this.stateId], t, -1, -1, !1, 2, i) : r.push(l.FIGHTER_LEAVING_STATE, [t, this.stateId], t, -1, -1, !1, 2, i));
  }
  o.prototype.remove.call(this);
};
n.prototype.clone = function () {
  var e = new n();
  return this._copyTo(e), e;
};
e.removeState(this.stateId);
window.gui.shortcutBar.updateSpellsAvailability();
o = y().gui.databases.SpellStates[c[1]];
n = C("ui.fight.enterState", d.name, o.nameId + g);
o = y().gui.databases.SpellStates[c[1]];
n = C("ui.fight.exitState", d.name, o.nameId);
N = !0;
t || (t = n);
l = h.values[o];
c = h.actionIds[o];
s += o > 0 ? " + " : "";
s += r(Math.abs(l), [c]);
a += l;
n = C("ui.fight.lostShieldPoints", u, r(a, h.actionIds));
h.values.length > 1 && (n += " (" + s + ")");
t = t + ("" !== t ? "\n" : "") + n;
l = m.values[o];
s += o > 0 ? " + " + l : l;
a += l;
l = p.values[o];
c = p.actionIds[o];
s += m.values.length + o > 0 ? f : "";
s += r(Math.abs(l), [c]);
a += l;
p.values.length + m.values.length > 1 && (n += " (" + s + ")");
t = t + ("" !== t ? "\n" : "") + n;
t.send = function (e, t, i, n, a, s, r) {
  var l = o(e, t, i, -1, n, a, s, r),
    d = {};
  c(l, d, function (e, t) {
    if (e) {
      return console.error("fightEvents#send", e);
    }
    var i = t || "",
      n = u(d);
    "" !== i && "" !== n ? i += "\n" + n : "" === i && (i += n);
    "" !== i && y().gui.chat.logMsg(i, v.PSEUDO_CHANNEL_FIGHT_LOG);
  });
};
t.push = function (e, t, i, n, a, s, r, l) {
  var c = o(e, t, i, n, a, s, r, l);
  c.name === h.FIGHTER_LIFE_LOSS ? E[c.params[0]] = !0 : c.name === h.FIGHTER_DEATH && (S[c.params[0]] = !0);
  A.push(c);
};
t.reset = function () {
  A = [];
  S = {};
  E = {};
  N = !1;
  x = [];
};
t.flush = function (e) {
  var t = A;
  return A = [], N ? x.push([t, e]) : void d(t, e);
};
"" !== i && "" !== n ? i += "\n" + n : "" === i && (i += n);
"" !== i && y().gui.chat.logMsg(i, v.PSEUDO_CHANNEL_FIGHT_LOG);
c.name === h.FIGHTER_LIFE_LOSS ? E[c.params[0]] = !0 : c.name === h.FIGHTER_DEATH && (S[c.params[0]] = !0);
A.push(c);
A = [];
S = {};
E = {};
N = !1;
x = [];
s.delay = e.delay;
s.effect.delay = e.delay;
s(o, a);
e.exports = o;
o.prototype._forceMinMax = function (e, t, i) {
  var n = e || 0,
    o = t || 0,
    a = i || 0,
    s = a + n,
    r = n * o + a;
  s === r ? (n = s, o = 0, a = 0) : s > r ? (n = r, o = s, a = 0) : (n = s, o = r, a = 0);
  this.updateParam(n, o, a);
};
o.prototype.isActive = function () {
  return this.delay > 0 || a.prototype.isActive.call(this);
};
o.prototype.isTrigger = function () {
  return !0;
};
o.prototype.incrementDuration = function (e, t) {
  return this.delay > 0 && !t && (this.delay + e >= 0 ? (this.delay--, this.effect.delay--) : (e += this.delay, this.delay = 0, this.effect.delay = 0)), 0 === e || a.prototype.incrementDuration.call(this, e, t);
};
o.prototype.isUnusableNextTurn = function () {
  return this.delay <= 1 && a.prototype.isUnusableNextTurn.call(this);
};
o.prototype.clone = function () {
  var e = new o();
  return this._copyTo(e), e;
};
s === r ? (n = s, o = 0, a = 0) : s > r ? (n = r, o = s, a = 0) : (n = s, o = r, a = 0);
this.updateParam(n, o, a);
this.data = new d();
this.id = e;
this.name = null;
this.level = null;
this.picto = null;
this.isBomb = !1;
this.isCreature = !1;
this.isBoss = !1;
this.canTackle = !0;
this.canBePushed = !0;
this.buffs = [];
this._finishingBuffs = [];
this.states = [];
this.spells = {};
t || (this.picto = this.createPicto(e), this.isShieldBarVisible = !1, window.gui.timeline.linkToTimeline(this));
e.exports = n;
n.prototype.clear = function () {
  this.picto && (this.picto.destroy(), this.picto = null);
};
n.prototype.createPicto = function (e) {
  var t = new o("div", {
    name: e,
    className: "fighter"
  });
  return t.fighterTimeBar = t.createChild("div", {
    className: "fighterTimeBar"
  }), t.fighterTimeValue = t.fighterTimeBar.createChild("div", {
    className: "fighterTimeValue"
  }), t.fighterIllus = t.appendChild(new a({
    className: "fighterIllus",
    scale: "fitin"
  })), t.fighterIcon = t.createChild("div", {
    className: "fighterIcon"
  }), t.fighterHPBar = t.createChild("div", {
    className: "fighterHPBar"
  }), t.fighterHPValue = t.fighterHPBar.createChild("div", {
    className: "fighterHPValue"
  }), t.fighterShieldBar = t.createChild("div", {
    className: "fighterShieldBar",
    hidden: !0
  }), t.fighterShieldValue = t.fighterShieldBar.createChild("div", {
    className: "fighterShieldValue"
  }), t.fighterNumber = t.createChild("div", {
    className: "fighterNumber"
  }), t.fighterNumber.toggleDisplay(!!r.orderFighters), t;
};
n.prototype.createStatsTooltipContent = function () {
  var e,
    t = new o("table", {
      className: "statsDetails",
      name: "statsDetails"
    });
  return e = t.createChild("tr"), t.fighterName = e.createChild("td", {
    className: "fighterName",
    attr: {
      colspan: 3
    }
  }), t.level = e.createChild("td", {
    className: "fighterLevel",
    attr: {
      colspan: 2
    }
  }), e = t.createChild("tr"), t.lifePoints = e.createChild("td", {
    className: ["label", "iconLifePoints"],
    attr: {
      colspan: 2
    }
  }), t.shieldPoints = e.createChild("td", {
    className: ["label", "iconShieldPoints"]
  }), t.fighterUsedAP = e.createChild("td", {
    className: ["label", "iconActionPoints"]
  }), t.movementPoints = e.createChild("td", {
    className: ["label", "iconMovementPoints"]
  }), e = t.createChild("tr"), t.dodgePALostProbability = e.createChild("td", {
    className: ["label", "iconDodgeAP"]
  }), t.dodgePMLostProbability = e.createChild("td", {
    className: ["label", "iconDodgeMP"]
  }), t.tackleBlock = e.createChild("td", {
    className: ["label", "iconTackle"]
  }), t.criticalDamageReduction = e.createChild("td", {
    className: ["label", "iconCriticalDamage"]
  }), t.pushDamageReduction = e.createChild("td", {
    className: ["label", "iconPushDamageReduction"]
  }), e = t.createChild("tr"), t.neutral = e.createChild("td", {
    className: ["label", "iconYinyang"]
  }), t.strength = e.createChild("td", {
    className: ["label", "iconStrength"]
  }), t.intelligence = e.createChild("td", {
    className: ["label", "iconIntelligence"]
  }), t.chance = e.createChild("td", {
    className: ["label", "iconChance"]
  }), t.agility = e.createChild("td", {
    className: ["label", "iconAgility"]
  }), e = t.createChild("tr"), t.neutralPercent = e.createChild("td", {
    className: ["label", "iconYinyang"]
  }), t.strengthPercent = e.createChild("td", {
    className: ["label", "iconStrength"]
  }), t.intelligencePercent = e.createChild("td", {
    className: ["label", "iconIntelligence"]
  }), t.chancePercent = e.createChild("td", {
    className: ["label", "iconChance"]
  }), t.agilityPercent = e.createChild("td", {
    className: ["label", "iconAgility"]
  }), this.refreshStatsTooltipContent(t), t;
};
n.prototype.refreshStatsTooltipContent = function (e) {
  var t = this.data.stats;
  e.fighterName.setText(this.name);
  e.level.setText(u("ui.common.short.level") + " " + this.level);
  e.lifePoints.setText(t.lifePoints + " / " + t.maxLifePoints);
  e.shieldPoints.setText(t.shieldPoints);
  e.fighterUsedAP.setText(t.actionPoints);
  e.movementPoints.setText(t.movementPoints);
  e.dodgePALostProbability.setText(t.dodgePALostProbability);
  e.dodgePMLostProbability.setText(t.dodgePMLostProbability);
  e.tackleBlock.setText(Math.max(g, t.tackleBlock));
  e.criticalDamageReduction.setText(t.criticalDamageFixedResist);
  e.pushDamageReduction.setText(t.pushDamageFixedResist);
  e.neutral.setText(t.neutralElementReduction);
  e.strength.setText(t.earthElementReduction);
  e.intelligence.setText(t.fireElementReduction);
  e.chance.setText(t.waterElementReduction);
  e.agility.setText(t.airElementReduction);
  "GameFightCharacterInformations" === this.data._type ? (e.neutralPercent.setText(Math.min(f, t.neutralElementResistPercent) + "%"), e.strengthPercent.setText(Math.min(f, t.earthElementResistPercent) + "%"), e.intelligencePercent.setText(Math.min(f, t.fireElementResistPercent) + "%"), e.chancePercent.setText(Math.min(f, t.waterElementResistPercent) + "%"), e.agilityPercent.setText(Math.min(f, t.airElementResistPercent) + "%")) : (e.neutralPercent.setText(t.neutralElementResistPercent + "%"), e.strengthPercent.setText(t.earthElementResistPercent + "%"), e.intelligencePercent.setText(t.fireElementResistPercent + "%"), e.chancePercent.setText(t.waterElementResistPercent + "%"), e.agilityPercent.setText(t.airElementResistPercent + "%"));
};
n.prototype.getFinishingBuffs = function () {
  var e = this._finishingBuffs;
  return this._finishingBuffs = [], e;
};
n.prototype.synchronizeData = function (e) {
  this.applyFinishingBuffs(e);
  this.setAlive(e.alive);
  this.data.updateData(e);
  this.setHP(e.stats.lifePoints);
  this.setShield(e.stats.shieldPoints);
};
n.prototype.applyFinishingBuffs = function (e) {
  var t = this.getFinishingBuffs();
  if (0 !== t.length) {
    for (var i = 0; i < t.length; i++) {
      for (var n = t[i], o = n.statName, a = 0; a < this.buffs.length; a++) {
        var s = this.buffs[a];
        s.id === n.id && o && e.stats.hasOwnProperty(o) && s.effect.effect.active && ("actionPoints" === o && (e.stats.maxActionPoints -= n.getDelta()), e.stats[o] -= n.getDelta());
      }
    }
  }
};
n.prototype.getAvailableWidth = function () {
  var e = this.isSummon() ? p : h;
  return this.isShieldBarVisible ? e - m : e;
};
n.prototype.isSummon = function () {
  return this.data.stats.summoned;
};
n.prototype.resizeFighterIllustration = function () {
  if (this.picto) {
    var e = this.getAvailableWidth();
    this.picto.fighterTimeBar.setStyles({
      width: e + "px"
    });
    this.picto.fighterIllus.setStyles({
      width: e + "px"
    });
    this.picto.fighterIllus.resize();
    this.isBoss && (this.picto.fighterTimeBar.addClassNames("boss"), this.picto.fighterIcon.addClassNames("bossIcon"));
  }
};
n.prototype.setData = function (e) {
  this.data.updateData(e);
  var t = e.alive;
  this.data.alive = null;
  this.setAlive(t);
  this.setHP(this.data.stats.lifePoints);
  this.setShield(this.data.stats.shieldPoints);
  this.setNameAndLevel(e);
  this.picto && (e.teamId === l.TEAM_CHALLENGER && this.picto.addClassNames("challenger"), e.stats.summoned && this.picto.addClassNames("summoned"), this.data.look && this.updateFighterIllustration(), this.resizeFighterIllustration());
};
n.prototype.setAlive = function (e, t) {
  (this.data.alive !== e || t) && (this.data.alive = e, e || (this.setHP(0), this.setShield(0)), this.picto && (this.picto.toggleClassName("dead", !e), t && this.picto.toggleDisplay(e || !r.hideDeadFighters)));
};
n.prototype.setHP = function (e) {
  var t = window.gui.playerData.characters;
  if (this.data.stats) {
    e = Math.max(0, e);
    var i = this.data.stats;
    i.lifePoints = e;
    var n = this.id === t.controlledCharacterId;
    if (n) {
      var o = t.getControlledCharacter();
      t.setCharacteristic(o, "lifePoints", i.lifePoints);
      t.setCharacteristic(o, "maxLifePoints", i.maxLifePoints);
    }
    this.picto && this.picto.fighterHPValue.setStyle("height", Math.min(e / i.maxLifePoints * 100, 100) + "%");
  }
};
n.prototype.setShield = function (e) {
  if (this.data.stats) {
    e = Math.max(0, e);
    var t = this.data.stats;
    if (t.shieldPoints = e, this.picto) {
      var i = 0 !== t.shieldPoints;
      if (i) {
        var n = Math.max(t.maxLifePoints, e);
        this.picto.fighterShieldValue.setStyle("height", e / n * 100 + "%");
      }
      this.isShieldBarVisible !== i && (this.isShieldBarVisible = i, this.picto.fighterShieldBar.toggleDisplay(i), this.resizeFighterIllustration());
    }
    window.gui.fightManager.emit("shieldPointsUpdated", this.id, e);
  }
};
n.prototype.setNameAndLevel = function (e) {
  switch (e._type) {
    case "GameFightCharacterInformations":
      this.name = e.name;
      this.level = e.level;
      break;
    case "GameFightMutantInformations":
      this.name = e.name;
      this.level = e.powerLevel;
      break;
    case "GameFightMonsterInformations":
    case "GameFightMonsterWithAlignmentInformations":
      this.name = e._name;
      this.level = e.monsterLevel;
      this.isBomb = e._isBomb;
      this.isCreature = e._isCreature;
      this.isBoss = e._isBoss;
      this.canTackle = e._canTackle;
      this.canBePushed = e._canBePushed;
      break;
    case "GameFightTaxCollectorInformations":
      this.name = e._name;
      this.level = e.level;
      break;
    default:
      console.warn('Retrieving details of fighter type "' + e._type + '" not supported');
  }
};
n.prototype.updateFighterIllustration = function () {
  this.picto && this.picto.fighterIllus.setLook(this.data.look, {
    riderOnly: !0,
    direction: s.DIRECTION_SOUTH_EAST,
    animation: "AnimArtwork",
    boneType: "timeline/",
    skinType: "timeline/",
    showSubentities: !1
  });
};
n.prototype.refreshHP = function () {
  this.data.alive && this.setHP(this.data.stats.lifePoints);
};
n.prototype.refreshShield = function () {
  this.setShield(this.data.stats.shieldPoints);
};
n.prototype.updateNumber = function (e) {
  if (this.picto) {
    var t = e || "";
    this.picto.fighterNumber.setText(t);
    r.orderFighters && window.actorManager.turnNumberOn(this.id, t);
  }
};
n.prototype.isTurnPassed = function () {
  var e = window.gui.fightManager,
    t = e.turnsList.indexOf(this.id),
    i = e.turnsList.indexOf(e.currentFighterId);
  return t < i;
};
n.prototype.getRelativeTurnCount = function () {
  var e = window.gui.fightManager.getTurnCount();
  return this.isTurnPassed() ? e + 1 : e;
};
n.prototype.addBuff = function (e, t) {
  t = void 0 === t || t;
  for (var i, n = 0, o = this.buffs.length; n < o; n++) {
    if (e.equals(this.buffs[n])) {
      i = this.buffs[n];
      break;
    }
  }
  i ? i.addBuff(e) : this.buffs.push(e);
  t && e.apply();
  i ? window.gui.fightManager.emit("BuffUpdate", i, this) : window.gui.fightManager.emit("BuffAdd", e, this);
};
n.prototype.updateBuff = function (e) {
  var t = this.getBuffIndex(e.id);
  if (t === -1) {
    return !1;
  }
  var i = this.buffs[t];
  return i.updateBuff(e), window.gui.fightManager.emit("BuffUpdate", i, this), !0;
};
n.prototype.getBuff = function (e) {
  for (var t = 0; t < this.buffs.length; t++) {
    var i = this.buffs[t];
    if (e === i.id) {
      return i;
    }
  }
  return null;
};
n.prototype.getBuffIndex = function (e) {
  for (var t = 0; t < this.buffs.length; t++) {
    var i = this.buffs[t];
    if (e === i.id) {
      return t;
    }
    if (i.stack) {
      for (var n = 0; n < i.stack.length; n++) {
        if (e === i.stack[n].id) {
          return t;
        }
      }
    }
  }
  return -1;
};
n.prototype.addState = function (e) {
  this.states.push(e);
};
n.prototype.removeState = function (e) {
  this.states.indexOf(e) !== -1 && this.states.splice(this.states.indexOf(e), 1);
};
n.prototype.hasState = function (e) {
  return this.states.indexOf(e) !== -1;
};
n.prototype.dispel = function (e, t, i) {
  for (var n = [], o = 0; o < this.buffs.length; o++) {
    var a = this.buffs[o];
    a.canBeDispell(e, Number.MIN_VALUE, i) ? (window.gui.fightManager.emit("BuffRemove", a, this), a.remove()) : n.push(a);
  }
  this.buffs = n;
};
n.prototype.dispelSpell = function (e, t, i, n) {
  var o,
    a = [],
    s = [];
  for (o = 0; o < this.buffs.length; o++) {
    var r = this.buffs[o];
    e === r.castingSpell.spell.id && r.canBeDispell(t, Number.MIN_VALUE, n) ? (r.remove(), a.push(r)) : s.push(r);
  }
  for (this.buffs = s, o = 0; o < a.length; o++) {
    window.gui.fightManager.emit("BuffRemove", a[o], this);
  }
};
n.prototype.dispelUniqueBuff = function (e, t, i, n) {
  var o = this.getBuffIndex(e);
  if (o === -1) {
    return console.warn("Buff id", e, "does not exist");
  }
  var a = this.buffs[o],
    s = window.gui.fightManager;
  a.canBeDispell(t, n ? e : Number.MIN_VALUE, i) && (!i && a.stack && a.stack.length > 1 ? (a.unstack(e), a.apply(), s.emit("BuffUpdate", a, this)) : (this.buffs.splice(o, 1), a.remove(), s.emit("BuffRemove", a, this), s.emit("BuffRemove", a, this)));
};
n.prototype.markFinishingBuffs = function () {
  var e = window.gui.fightManager;
  for (var t in this.buffs) {
    var i = this.buffs[t];
    if (1 === i.duration) {
      for (var n = !1, o = 0, a = !1, s = 0; s < e.turnsList.length; s++) {
        var r = e.turnsList[s];
        r === i.aliveSource && (a = !0);
        r === e.currentFighterId && (o = 1);
        1 === o && (a && r !== e.currentFighterId ? (o = 2, n = !0) : r === this.id && r !== e.currentFighterId && (o = 2, n = !1));
      }
      if (n) {
        if (i instanceof c.StatBuff && this.id !== window.gui.playerData.characters.mainCharacterId && i.statName) {
          var l = e.getFighter(i.targetId);
          if (!l) {
            return console.error("Mark finishing buffs failed, fighter does not exist");
          }
          l._finishingBuffs.push(i);
        }
        i.disable();
      }
    }
  }
};
n.prototype.enableBuffs = function () {
  for (var e in this.buffs) {
    this.buffs[e].enable();
  }
};
n.prototype.isOnSameTeam = function (e) {
  var t = window.gui.fightManager.getFighter(e);
  return t ? this.data.teamId === t.data.teamId : (console.warn("Fighter " + e + " not found"), !1);
};
e.fighterName.setText(this.name);
e.level.setText(u("ui.common.short.level") + " " + this.level);
e.lifePoints.setText(t.lifePoints + " / " + t.maxLifePoints);
e.shieldPoints.setText(t.shieldPoints);
e.fighterUsedAP.setText(t.actionPoints);
e.movementPoints.setText(t.movementPoints);
e.dodgePALostProbability.setText(t.dodgePALostProbability);
e.dodgePMLostProbability.setText(t.dodgePMLostProbability);
e.tackleBlock.setText(Math.max(g, t.tackleBlock));
e.criticalDamageReduction.setText(t.criticalDamageFixedResist);
e.pushDamageReduction.setText(t.pushDamageFixedResist);
e.neutral.setText(t.neutralElementReduction);
e.strength.setText(t.earthElementReduction);
e.intelligence.setText(t.fireElementReduction);
e.chance.setText(t.waterElementReduction);
e.agility.setText(t.airElementReduction);
"GameFightCharacterInformations" === this.data._type ? (e.neutralPercent.setText(Math.min(f, t.neutralElementResistPercent) + "%"), e.strengthPercent.setText(Math.min(f, t.earthElementResistPercent) + "%"), e.intelligencePercent.setText(Math.min(f, t.fireElementResistPercent) + "%"), e.chancePercent.setText(Math.min(f, t.waterElementResistPercent) + "%"), e.agilityPercent.setText(Math.min(f, t.airElementResistPercent) + "%")) : (e.neutralPercent.setText(t.neutralElementResistPercent + "%"), e.strengthPercent.setText(t.earthElementResistPercent + "%"), e.intelligencePercent.setText(t.fireElementResistPercent + "%"), e.chancePercent.setText(t.waterElementResistPercent + "%"), e.agilityPercent.setText(t.airElementResistPercent + "%"));
this.applyFinishingBuffs(e);
this.setAlive(e.alive);
this.data.updateData(e);
this.setHP(e.stats.lifePoints);
this.setShield(e.stats.shieldPoints);
this.picto.fighterTimeBar.setStyles({
  width: e + "px"
});
this.picto.fighterIllus.setStyles({
  width: e + "px"
});
this.picto.fighterIllus.resize();
this.isBoss && (this.picto.fighterTimeBar.addClassNames("boss"), this.picto.fighterIcon.addClassNames("bossIcon"));
this.data.alive = null;
this.setAlive(t);
this.setHP(this.data.stats.lifePoints);
this.setShield(this.data.stats.shieldPoints);
this.setNameAndLevel(e);
this.picto && (e.teamId === l.TEAM_CHALLENGER && this.picto.addClassNames("challenger"), e.stats.summoned && this.picto.addClassNames("summoned"), this.data.look && this.updateFighterIllustration(), this.resizeFighterIllustration());
t.setCharacteristic(o, "lifePoints", i.lifePoints);
t.setCharacteristic(o, "maxLifePoints", i.maxLifePoints);
this.name = e.name;
this.level = e.level;
this.name = e.name;
this.level = e.powerLevel;
this.name = e._name;
this.level = e.monsterLevel;
this.isBomb = e._isBomb;
this.isCreature = e._isCreature;
this.isBoss = e._isBoss;
this.canTackle = e._canTackle;
this.canBePushed = e._canBePushed;
this.name = e._name;
this.level = e.level;
this.picto.fighterNumber.setText(t);
r.orderFighters && window.actorManager.turnNumberOn(this.id, t);
i ? i.addBuff(e) : this.buffs.push(e);
t && e.apply();
i ? window.gui.fightManager.emit("BuffUpdate", i, this) : window.gui.fightManager.emit("BuffAdd", e, this);
r === i.aliveSource && (a = !0);
r === e.currentFighterId && (o = 1);
1 === o && (a && r !== e.currentFighterId ? (o = 2, n = !0) : r === this.id && r !== e.currentFighterId && (o = 2, n = !1));
r.call(this, "div", e);
this.addClassNames("CharacterDisplay");
e = e || {};
this.canvas = this.appendChild(new l());
this.ctx = this.canvas.getContext("2d");
this.entity = null;
this.scale = void 0 !== e.scale ? e.scale : 1;
this._scale = 1 / 0;
this.only4Directions = !1;
"fitin" === this.scale ? (this.horizontalAlign = e.horizontalAlign || "left", this.verticalAlign = e.verticalAlign || "bottom") : (this.horizontalAlign = e.horizontalAlign || "none", this.verticalAlign = e.verticalAlign || "none");
this.canvasInitialized = !1;
this.renderingRequired = !1;
s(a, r);
e.exports = a;
a.prototype.setLook = function (e, t, i) {
  var n = this;
  if (t = t || {}, null === this.entity) {
    this.entity = new c({
      scene: g || o()
    });
    var a = t.showSubentities;
    this.entity.showSubentities = null === a || void 0 === a || a;
  }
  var s = void 0 !== t.direction ? t.direction : 1;
  t.keepDirection || (this.entity.direction = s);
  t.riderOnly && (e = c.getLookWithoutMount(e));
  var r = !1,
    l = !1,
    d = new h(30, function () {
      l || n.rootElement && (n.addClassNames("spinner"), r = !0);
    });
  d.start(!1);
  this.entity.setLook(e, t, function () {
    return l = !0, r && n.rootElement && n.delClassNames("spinner"), null !== n.entity && n.rootElement ? (e && 1 === e.bonesId && e.skins[0] && n.entity.animManager.addAnimationModifier("AnimStatique", "AnimStatique" + e.skins[0]), n.only4Directions = n.entity.animManager.only4Directions, t.animation && (n.entity.animSymbol.base = t.animation), n._scale = 1 / 0, n._render(), i && i()) : i && i();
  });
};
a.prototype.release = function () {
  f && (null !== this.entity && (this.entity.remove(), this.entity = null), this._scale = 1 / 0, this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height));
};
a.prototype.clear = function () {
  this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
};
a.prototype.rotateCharacter = function (e) {
  if (this.canvasInitialized && this.entity) {
    var t = this.entity.direction;
    return this.only4Directions ? (0 === (1 & t) && (t += 1), t += e ? 2 : -2, t > 7 && (t = 1), t < 0 && (t = 7)) : (t += e ? 1 : -1, t > 7 && (t = 0), t < 0 && (t = 7)), this.entity.direction = t, this._render(), t;
  }
};
a.prototype.resize = function () {
  if (this.rootElement && p(this)) {
    var e = this.canvas,
      t = parseInt(this.getComputedStyle("width"), 10),
      i = parseInt(this.getComputedStyle("height"), 10),
      n = e.width,
      o = e.height,
      a = t * d.PIXEL_RATIO,
      s = i * d.PIXEL_RATIO;
    0 !== a && 0 !== s && (this.renderingRequired || a !== n || s !== o) && (e.width = a, e.height = s, e.style.width = t + "px", e.style.height = i + "px", this._render());
  }
};
a.prototype.setScale = function (e) {
  e !== this.scale && (this.scale = e, this._render());
};
a.prototype._computeScale = function (e, t, i, n, o, a) {
  var s;
  if ("cover" === e) {
    s = this._scale = Math.min(this._scale, n / Math.abs(a[0]), n / Math.abs(a[1]), o / Math.abs(a[2]), o / Math.abs(a[3]));
  } else if ("width" === e) {
    s = this._scale = Math.min(this._scale, t / (a[1] - a[0]));
  } else if ("height" === e) {
    s = this._scale = Math.min(this._scale, i / (a[2] - a[3]));
  } else if ("fitin" === e) {
    s = this._scale = Math.min(this._scale, t / (a[1] - a[0]), i / (a[2] - a[3]));
    s = Math.min(s, y);
  } else if ("%" === e[e.length - 1]) {
    var r = parseFloat(e);
    isNaN(r) ? r = this._scale : r *= .01;
    var l = t / (a[1] - a[0]),
      c = i / (a[2] - a[3]),
      d = l > c ? c : l;
    s = this._scale = r * d;
    s = Math.min(s, y);
  }
  return s || this._scale;
};
a.prototype._render = function () {
  if (!this.canvasInitialized) {
    return void (this.renderingRequired = !0);
  }
  if (f && this.entity) {
    var e = this.canvas,
      t = e.width,
      i = e.height,
      n = f.gl,
      o = this.entity,
      a = this.scale;
    if (0 === t || 0 === i) {
      var s = this;
      return void window.setTimeout(function () {
        if (s.resize(), !e.rootElement || 0 === e.width || 0 === e.height) {
          return console.warn("[CharacterDisplay._render] Character display size must be greater than zero.");
        }
      }, 0);
    }
    f.clear();
    o.x = 0;
    o.y = 0;
    o.scaleX = d.PIXEL_RATIO;
    o.scaleY = -d.PIXEL_RATIO;
    o.updateAnimation();
    o.refreshAnimation();
    var r = o.bbox;
    if (r[1] < r[0] || r[2] < r[3]) {
      var l = o.animManager.template.id,
        c = o.animSymbol.base;
      if ("761/motion" === l) {
        return;
      }
      return void console.error(new Error("Entity animation frame is empty, template:" + l + ", animation:" + c));
    }
    var u = .5 * t,
      h = .85 * i;
    "string" == typeof a && (a = this._computeScale(a, t, i, u, h, r));
    o.scaleX *= a;
    o.scaleY *= a;
    var p = Math.floor(r[0] * a),
      m = Math.ceil(r[1] * a),
      g = -Math.floor(r[2] * a),
      _ = -Math.ceil(r[3] * a),
      y = m - p,
      w = _ - g;
    if (0 === y || 0 === w) {
      return console.warn("[CharacterDisplay._render] Character to render is of size 0.");
    }
    o.x = -p;
    o.y = _;
    o.render();
    o.animManager.releaseBuffer();
    var b = new window.Uint8Array(y * w * 4);
    n.readPixels(0, v - w, y, w, n.RGBA, n.UNSIGNED_BYTE, b);
    for (var M = this.ctx.createImageData(y, w), T = M.data, C = 0; C < b.length; C++) {
      T[C] = b[C];
    }
    var I, A;
    switch (this.horizontalAlign) {
      case "left":
        I = 0;
        break;
      case "center":
        I = (t - y) / 2;
        break;
      case "right":
        I = t - y;
        break;
      default:
        I = u + p;
    }
    switch (this.verticalAlign) {
      case "top":
        A = 0;
        break;
      case "center":
        A = (i - w) / 2;
        break;
      case "bottom":
        A = i - w;
        break;
      default:
        A = h + g;
    }
    this.ctx.clearRect(0, 0, t, i);
    this.ctx.putImageData(M, I, A);
  }
};
t.keepDirection || (this.entity.direction = s);
t.riderOnly && (e = c.getLookWithoutMount(e));
d.start(!1);
this.entity.setLook(e, t, function () {
  return l = !0, r && n.rootElement && n.delClassNames("spinner"), null !== n.entity && n.rootElement ? (e && 1 === e.bonesId && e.skins[0] && n.entity.animManager.addAnimationModifier("AnimStatique", "AnimStatique" + e.skins[0]), n.only4Directions = n.entity.animManager.only4Directions, t.animation && (n.entity.animSymbol.base = t.animation), n._scale = 1 / 0, n._render(), i && i()) : i && i();
});
s = this._scale = Math.min(this._scale, t / (a[1] - a[0]), i / (a[2] - a[3]));
s = Math.min(s, y);
s = this._scale = r * d;
s = Math.min(s, y);
f.clear();
o.x = 0;
o.y = 0;
o.scaleX = d.PIXEL_RATIO;
o.scaleY = -d.PIXEL_RATIO;
o.updateAnimation();
o.refreshAnimation();
"string" == typeof a && (a = this._computeScale(a, t, i, u, h, r));
o.scaleX *= a;
o.scaleY *= a;
o.x = -p;
o.y = _;
o.render();
o.animManager.releaseBuffer();
this.ctx.clearRect(0, 0, t, i);
this.ctx.putImageData(M, I, A);
a.call(this, "canvas", e);
this.addClassNames("Canvas");
this.style = this.rootElement.style;
o(n, a);
e.exports = n;
n.prototype.getContext = function (e) {
  return e = e || "2d", this.rootElement.getContext(e);
};
Object.defineProperty(n.prototype, "width", {
  get: function () {
    return this.rootElement.width;
  },
  set: function (e) {
    this.rootElement.width = e;
  }
});
Object.defineProperty(n.prototype, "height", {
  get: function () {
    return this.rootElement.height;
  },
  set: function (e) {
    this.rootElement.height = e;
  }
});
a.call(this, e, t);
this.direction = void 0 === e.direction ? 1 : e.direction;
this.animSymbol = {
  base: "AnimStatique",
  type: null,
  direction: this.direction
};
this.look = null;
this.fifo = u.createFifo();
this.showSubentities = !0;
o(n, a);
e.exports = n;
n.prototype.updateAnimation = function () {
  this.animSymbol.direction = this.direction;
  this.animManager.assignSymbol(this.animSymbol, !1);
};
n.prototype.addSubentity = function (e, t, i) {
  if (!this.showSubentities) {
    return i && i();
  }
  var n = e.subEntityLook;
  if (!n) {
    return console.error(new Error("Sub-entity has no look: " + Object.keys(e).join(";"))), i && i();
  }
  var o = n.bonesId + "/motion",
    a = n.skins,
    r = n.scales[0],
    d = s.parseIndexedColors(n.indexedColors),
    u = this;
  t.addToSprite = !1;
  l.loadCharacterAnimationManager(this, o, a, d, r, t, function (t) {
    return u.animManager.addSubentity({
      animManager: t,
      bindingPoint: "carried_" + e.bindingPointCategory + "_" + e.bindingPointIndex,
      symbolModifier: c[e.bindingPointCategory],
      bindingPointCategory: e.bindingPointCategory
    }), i && i(t);
  });
};
n.prototype.addSubentities = function (e, t, i) {
  function n() {
    if (a += 1, a === o) {
      return i && i();
    }
  }
  if (!e) {
    return i && i();
  }
  for (var o = e.length + 1, a = 0, s = 0; s < e.length; s += 1) {
    this.addSubentity(e[s], t, n);
  }
  n();
};
n.prototype.setLook = function (e, t, i) {
  var n = this,
    o = new Error("Look missing");
  this.fifo.push(function (a) {
    function c() {
      return a(), i && i();
    }
    function d() {
      return v.clear(), c();
    }
    var u = n.look;
    if (!e) {
      return console.error(o), c();
    }
    for (var h = e.scales[0], p = e.skins, m = u && n.look.bonesId === e.bonesId && n.look.skins.length === p.length && n.look.scales[0] === h, f = 0; m && f < p.length; f += 1) {
      m = m && p[f] === n.look.skins[f];
    }
    n.look = e;
    var g = s.parseIndexedColors(e.indexedColors);
    if (m) {
      return n.animManager.setTints(g), n.animManager.cleanupAnimationsAndRemoveSubentities(), void n.addSubentities(e.subentities, t, c);
    }
    if (u && n.isDisplayed && !t.noSmokeAnimation) {
      var _ = new r({
        x: n.x,
        y: n.y,
        position: n.position + 1,
        scene: n.scene
      });
      l.loadAnimationManager(_, "bone", "1165/FX", function (e) {
        e.assignSymbol({
          base: "FX",
          direction: 0
        }, !1, function () {
          _.remove();
        });
      });
    }
    var v = n.animManager;
    l.loadLook(n, e, t, d);
  });
};
this.animSymbol.direction = this.direction;
this.animManager.assignSymbol(this.animSymbol, !1);
t.addToSprite = !1;
l.loadCharacterAnimationManager(this, o, a, d, r, t, function (t) {
  return u.animManager.addSubentity({
    animManager: t,
    bindingPoint: "carried_" + e.bindingPointCategory + "_" + e.bindingPointIndex,
    symbolModifier: c[e.bindingPointCategory],
    bindingPointCategory: e.bindingPointCategory
  }), i && i(t);
});
p[2] = 1;
p[1084] = 44;
p[1068] = 113;
p[1202] = 453;
p[2456] = 1107;
m[1450] = 1576;
m[1449] = 1576;
m[1448] = 1575;
m[1443] = 1575;
n.getLookWithoutMount = function (e) {
  if (!e) {
    return console.error(new Error("look is missing")), null;
  }
  var t = n.getLookOfRider(e);
  if (!t) {
    return e;
  }
  for (var i = p[t.bonesId] || t.bonesId, o = 0; o < t.skins.length; o++) {
    var a = t.skins[o];
    if (m[a]) {
      i = m[a];
      break;
    }
  }
  return {
    _type: "EntityLook",
    bonesId: i,
    indexedColors: t.indexedColors,
    scales: t.scales,
    skins: t.skins,
    subentities: t.subentities
  };
};
n.getLookWithoutPet = function (e) {
  var t = n.getLookWithoutMount(e);
  return {
    _type: "EntityLook",
    bonesId: t.bonesId,
    indexedColors: t.indexedColors,
    scales: t.scales,
    skins: t.skins,
    subentities: []
  };
};
n.getLookOfRider = function (e) {
  if (!e) {
    return console.error(new Error("look is missing")), null;
  }
  for (var t = e.subentities || [], i = 0; i < t.length; i += 1) {
    var n = t[i];
    if (n.bindingPointCategory === h && 0 === n.bindingPointIndex) {
      return n.subEntityLook;
    }
  }
  return null;
};
a.call(this, e);
this.animManager = t || new s(this);
o(n, a);
e.exports = n;
n.prototype.setAnimManager = function (e) {
  this.animManager.cleanupAnimations();
  this.animManager.switchAnimationManager(e);
  this.animManager = e;
};
n.prototype.render = function () {
  this.renderer.save();
  this.renderer.multiplyColor(this.tint[0], this.tint[1], this.tint[2], this.tint[3]);
  this.renderer.translate(this._x, this._y);
  0 !== this._rotation && this.renderer.rotate(this._rotation);
  this.renderer.scale(this._scaleX, this._scaleY);
  this.animManager.draw(this.renderer);
  this.renderer.restore();
};
n.prototype.remove = function () {
  return this.hide(), this.isWhiteListed === !0 ? this.animManager.stop() : void (this._cleared !== !0 && (this._cleared = !0, this.animManager.clear()));
};
n.prototype.refreshAnimation = function (e) {
  if (this.isOutdated = !1, this.isDisplayed === !1) {
    return void 0 !== e && e.push(this.bbox), void (this.bbox = [1 / 0, -(1 / 0), 1 / 0, -(1 / 0)]);
  }
  var t = this.bbox,
    i = this.animManager.generateCurrentFrameData();
  if (0 === this._rotation) {
    this.bbox = [this._x + this._scaleX * (this._scaleX > 0 ? i[0] : i[1]), this._x + this._scaleX * (this._scaleX > 0 ? i[1] : i[0]), this._y + this._scaleY * i[2], this._y + this._scaleY * i[3]];
  } else {
    var n = Math.cos(this._rotation),
      o = Math.sin(this._rotation),
      a = this._scaleX * i[0],
      s = this._scaleX * i[1],
      r = this._scaleY * i[2],
      l = this._scaleY * i[3],
      c = n * a - o * r,
      d = o * a + n * r,
      u = n * s - o * r,
      h = o * s + n * r,
      p = n * a - o * l,
      m = o * a + n * l,
      f = n * s - o * l,
      g = o * s + n * l;
    this.bbox = [this._x + Math.min(c, u, p, f), this._x + Math.max(c, u, p, f), this._y + Math.min(d, h, m, g), this._y + Math.max(d, h, m, g)];
  }
  t[0] = Math.floor(Math.min(t[0], this.bbox[0]));
  t[1] = Math.ceil(Math.max(t[1], this.bbox[1]));
  t[2] = Math.floor(Math.min(t[2], this.bbox[2]));
  t[3] = Math.ceil(Math.max(t[3], this.bbox[3]));
  void 0 !== e && e.push(t);
};
n.prototype._refreshAnimation = n.prototype.refreshAnimation;
this.animManager.cleanupAnimations();
this.animManager.switchAnimationManager(e);
this.animManager = e;
this.renderer.save();
this.renderer.multiplyColor(this.tint[0], this.tint[1], this.tint[2], this.tint[3]);
this.renderer.translate(this._x, this._y);
0 !== this._rotation && this.renderer.rotate(this._rotation);
this.renderer.scale(this._scaleX, this._scaleY);
this.animManager.draw(this.renderer);
this.renderer.restore();
t[0] = Math.floor(Math.min(t[0], this.bbox[0]));
t[1] = Math.ceil(Math.max(t[1], this.bbox[1]));
t[2] = Math.floor(Math.min(t[2], this.bbox[2]));
t[3] = Math.ceil(Math.max(t[3], this.bbox[3]));
void 0 !== e && e.push(t);
s.call(this, e);
this._layer = e.layer || 0;
this._x = e.x || 0;
this._y = e.y || 0;
this._scaleX = e.sx || 1;
this._scaleY = e.sy || 1;
this._rotation = e.rotation || 0;
this._spriteRef = null;
this.isDisplayed = !1;
this.isWhiteListed = !1;
this.scene = e.scene;
this.renderer = this.scene.renderer;
this.updateList = this.scene.updateList;
this.displayList = this.scene.displayList;
this.holdsStatics && (this.displayList = this.scene.staticElements);
e.isHudElement && (this.displayList = this.scene.hudDisplayList);
this._cleared = !1;
this.show();
t.width = l;
t.height = l;
a(n, s);
e.exports = n;
Object.defineProperty(n.prototype, "x", {
  get: function () {
    return this._x;
  },
  set: function (e) {
    this._x = e;
    this.forceRefresh();
  }
});
Object.defineProperty(n.prototype, "y", {
  get: function () {
    return this._y;
  },
  set: function (e) {
    this._y = e;
    this.forceRefresh();
  }
});
Object.defineProperty(n.prototype, "scaleX", {
  get: function () {
    return this._scaleX;
  },
  set: function (e) {
    this._scaleX = e;
    this.forceRefresh();
  }
});
Object.defineProperty(n.prototype, "scaleY", {
  get: function () {
    return this._scaleY;
  },
  set: function (e) {
    this._scaleY = e;
    this.forceRefresh();
  }
});
Object.defineProperty(n.prototype, "rotation", {
  get: function () {
    return this._rotation;
  },
  set: function (e) {
    this._rotation = e;
    this.forceRefresh();
  }
});
Object.defineProperty(n.prototype, "layer", {
  get: function () {
    return this._layer;
  },
  set: function (e) {
    e !== this._layer && (this._layer = e, this.isDisplayed && this._show(), this.forceRefresh());
  }
});
n.prototype.render = function () {
  this.renderer.save();
  this.renderer.multiplyColor(this.tint[0], this.tint[1], this.tint[2], this.tint[3]);
  this.renderer.translate(this._x, this._y);
  0 !== this._rotation && this.renderer.rotate(this._rotation);
  this.renderer.scale(this._scaleX, this._scaleY);
  this.draw(this.renderer);
  this.renderer.restore();
};
n.prototype._show = function () {
  null === this._spriteRef ? this._spriteRef = this.displayList.add(this) : this._spriteRef = this.displayList.reposition(this._spriteRef);
};
n.prototype._hide = function () {
  null !== this._spriteRef && (this.displayList.removeByRef(this._spriteRef) || console.warn("[Sprite.remove] Sprite not found in display list", this, this.displayList), this._spriteRef = null);
};
n.prototype.show = function () {
  this._show();
  this.isDisplayed = !0;
  this.forceRefresh();
};
n.prototype.hide = function () {
  this._hide();
  this.isDisplayed = !1;
  this.forceRefresh();
};
n.prototype.forceRefresh = function () {
  this.isOutdated === !1 && (this.updateList.push(this), this.isOutdated = !0);
};
n.prototype.setWhiteListedness = function (e) {
  this.isWhiteListed = e;
};
n.prototype.remove = function () {
  if (this.hide(), this.isWhiteListed === !1) {
    if (this._cleared === !0) {
      return;
    }
    this._cleared = !0;
    this.clear();
  }
};
n.prototype.isWithinBounds = function (e, t) {
  return this.bbox[0] <= e && e <= this.bbox[1] && this.bbox[2] <= t && t <= this.bbox[3];
};
n.prototype.refreshAnimation = function (e) {
  if (this.isOutdated = !1, this.isDisplayed === !1) {
    return void 0 !== e && e.push(this.bbox), void (this.bbox = [1 / 0, -(1 / 0), 1 / 0, -(1 / 0)]);
  }
  var t = this.bbox,
    i = this.generateCurrentFrameData();
  if (0 === this._rotation) {
    this.bbox = [this._x + this._scaleX * (this._scaleX > 0 ? i[0] : i[1]), this._x + this._scaleX * (this._scaleX > 0 ? i[1] : i[0]), this._y + this._scaleY * i[2], this._y + this._scaleY * i[3]];
  } else {
    var n = Math.cos(this._rotation),
      o = Math.sin(this._rotation),
      a = this._scaleX * i[0],
      s = this._scaleX * i[1],
      r = this._scaleY * i[2],
      l = this._scaleY * i[3],
      c = n * a - o * r,
      d = o * a + n * r,
      u = n * s - o * r,
      h = o * s + n * r,
      p = n * a - o * l,
      m = o * a + n * l,
      f = n * s - o * l,
      g = o * s + n * l;
    this.bbox = [this._x + Math.min(c, u, p, f), this._x + Math.max(c, u, p, f), this._y + Math.min(d, h, m, g), this._y + Math.max(d, h, m, g)];
  }
  t[0] = Math.floor(Math.min(t[0], this.bbox[0]));
  t[1] = Math.ceil(Math.max(t[1], this.bbox[1]));
  t[2] = Math.floor(Math.min(t[2], this.bbox[2]));
  t[3] = Math.ceil(Math.max(t[3], this.bbox[3]));
  void 0 !== e && e.push(t);
};
this._x = e;
this.forceRefresh();
this._y = e;
this.forceRefresh();
this._scaleX = e;
this.forceRefresh();
this._scaleY = e;
this.forceRefresh();
this._rotation = e;
this.forceRefresh();
this.renderer.save();
this.renderer.multiplyColor(this.tint[0], this.tint[1], this.tint[2], this.tint[3]);
this.renderer.translate(this._x, this._y);
0 !== this._rotation && this.renderer.rotate(this._rotation);
this.renderer.scale(this._scaleX, this._scaleY);
this.draw(this.renderer);
this.renderer.restore();
this._show();
this.isDisplayed = !0;
this.forceRefresh();
this._hide();
this.isDisplayed = !1;
this.forceRefresh();
this._cleared = !0;
this.clear();
t[0] = Math.floor(Math.min(t[0], this.bbox[0]));
t[1] = Math.ceil(Math.max(t[1], this.bbox[1]));
t[2] = Math.floor(Math.min(t[2], this.bbox[2]));
t[3] = Math.ceil(Math.max(t[3], this.bbox[3]));
void 0 !== e && e.push(t);
n.prototype.draw = function () {
  window.isoEngine.debug && this.renderer.drawImage(r || o(this.renderer), -l / 2, -l / 2, l, l);
};
n.prototype.generateCurrentFrameData = function () {
  return [-l / 2, l / 2, -l / 2, l / 2];
};
n.prototype.clear = n.prototype.releaseBuffer = function () {};
this.sprite = e;
this._red = 1;
this._green = 1;
this._blue = 1;
this._alpha = 1;
this.id = e.id;
this._position = e.position || 0;
this.bbox = [1 / 0, -(1 / 0), 1 / 0, -(1 / 0)];
this.renderer = null;
this._highlight = new i(this);
this._hue = e.hue || [1, 1, 1, 1];
this.tint = this.hue.slice();
this._alpha = 1;
this.alpha = void 0 === e.alpha ? 1 : e.alpha;
this.isOutdated = !1;
Object.defineProperty(i.prototype, "red", {
  get: function () {
    return this._red;
  },
  set: function (e) {
    this._red = e;
    var t = this.sprite;
    t.tint[0] = t.hue[0] * e;
    t.forceRefresh();
  }
});
Object.defineProperty(i.prototype, "green", {
  get: function () {
    return this._green;
  },
  set: function (e) {
    this._green = e;
    var t = this.sprite;
    t.tint[1] = t.hue[1] * e;
    t.forceRefresh();
  }
});
Object.defineProperty(i.prototype, "blue", {
  get: function () {
    return this._blue;
  },
  set: function (e) {
    this._blue = e;
    var t = this.sprite;
    t.tint[2] = t.hue[2] * e;
    t.forceRefresh();
  }
});
Object.defineProperty(i.prototype, "alpha", {
  get: function () {
    return this._alpha;
  },
  set: function (e) {
    this._alpha = e;
    var t = this.sprite;
    t.tint[3] = t.hue[3] * e;
    t.forceRefresh();
  }
});
e.exports = n;
Object.defineProperty(n.prototype, "position", {
  get: function () {
    return this._position;
  },
  set: function (e) {
    e !== this._position && (this._position = e, this.isDisplayed && this._show(), this.forceRefresh());
  }
});
Object.defineProperty(n.prototype, "hue", {
  get: function () {
    return this._hue;
  },
  set: function (e) {
    e !== this._hue && (this._hue = e, this.tint[0] = this.hue[0] * this._highlight.red, this.tint[1] = this.hue[1] * this._highlight.green, this.tint[2] = this.hue[2] * this._highlight.blue, this.tint[3] = this.hue[3] * this._highlight.alpha * this._alpha, this.isDisplayed && this._show(), this.forceRefresh());
  }
});
Object.defineProperty(n.prototype, "highlight", {
  get: function () {
    return this._highlight;
  },
  set: function (e) {
    this.setHighlight(e);
  }
});
Object.defineProperty(n.prototype, "alpha", {
  get: function () {
    return this._alpha;
  },
  set: function (e) {
    e !== this._alpha && (this._alpha = e, this.tint[3] = this.hue[3] * this._highlight.alpha * this._alpha, this.forceRefresh());
  }
});
n.prototype.setHighlight = function (e) {
  return null === e ? void this.removeHighlight() : (this._highlight._red = e.red, this._highlight._green = e.green, this._highlight._blue = e.blue, this._highlight._alpha = e.alpha, this.tint[0] = this.hue[0] * e.red, this.tint[1] = this.hue[1] * e.green, this.tint[2] = this.hue[2] * e.blue, this.tint[3] = this.hue[3] * e.alpha * this._alpha, void this.forceRefresh());
};
n.prototype.removeHighlight = function () {
  this.tint[0] = this.hue[0];
  this.tint[1] = this.hue[1];
  this.tint[2] = this.hue[2];
  this.tint[3] = this.hue[3] * this._alpha;
  this.forceRefresh();
};
n.prototype.forceRefresh = function () {};
t.tint[0] = t.hue[0] * e;
t.forceRefresh();
t.tint[1] = t.hue[1] * e;
t.forceRefresh();
t.tint[2] = t.hue[2] * e;
t.forceRefresh();
t.tint[3] = t.hue[3] * e;
t.forceRefresh();
this.tint[0] = this.hue[0];
this.tint[1] = this.hue[1];
this.tint[2] = this.hue[2];
this.tint[3] = this.hue[3] * this._alpha;
this.forceRefresh();
this.sprite = e;
this.hasSubentities = !1;
this.subentities = [];
this.animationModifiers = {};
t.width = a;
t.height = a;
e.exports = i;
i.prototype.isTemporary = !0;
i.prototype.switchAnimationManager = function (e) {
  e.hasSubentities = this.hasSubentities;
  e.subentities = this.subentities;
  e.animationModifiers = this.animationModifiers;
};
i.prototype.addSubentity = function (e) {
  this.subentities.push(e);
  this.hasSubentities = !0;
};
i.prototype.removeSubentity = function (e) {
  var t = this.subentities.indexOf(e);
  return t === -1 ? console.error("Subentity does not exist.") : (e.animManager.cleanupAnimations(), this.subentities.splice(t, 1), void (this.hasSubentities = this.subentities.length > 0));
};
i.prototype.addAnimationModifier = function (e, t) {
  this.animationModifiers[e] = t;
};
i.prototype.removeAnimationModifier = function (e) {
  delete this.animationModifiers[e];
};
i.prototype.cleanupAnimations = function () {
  for (var e = 0; e < this.subentities.length; e++) {
    this.subentities[e].animManager.cleanupAnimations();
  }
};
i.prototype.cleanupAnimationsAndRemoveSubentities = function () {
  for (var e = 0; e < this.subentities.length; e++) {
    this.subentities[e].animManager.cleanupAnimations();
  }
  this.subentities = [];
  this.hasSubentities = !1;
};
e.hasSubentities = this.hasSubentities;
e.subentities = this.subentities;
e.animationModifiers = this.animationModifiers;
this.subentities.push(e);
this.hasSubentities = !0;
this.subentities = [];
this.hasSubentities = !1;
i.prototype.draw = function () {
  window.isoEngine.debug && this.sprite.renderer.drawImage(o || n(this.sprite.renderer), -a / 2, -a / 2, a, a);
};
i.prototype.generateCurrentFrameData = function () {
  return [-a / 2, a / 2, -a / 2, a / 2];
};
i.prototype.assignSymbol = function (e, t, i) {
  return console.warn("Attempt to call abstract method TemporaryAnimationManager.assignSymbol", e), i && i();
};
i.prototype.getSymbolDuration = function () {
  return 0;
};
i.prototype.clear = i.prototype.stop = i.prototype.releaseBuffer = i.prototype.addAnimation = i.prototype.applyAnimationModifier = i.prototype.setTints = i.prototype.prepareCurrentAnimationFrame = function () {};
a.call(this, e, e.animManager);
this.offsetY = e.offsetY || 0;
o(n, a);
e.exports = n;
n.prototype.isFx = !0;
this.type = e;
this.id = t;
this.usage = i || "";
o[n] = t;
i.bindingPointCategory === d && (e.riderEntity = t);
r();
t.loadCharacterAnimationManager = function (e, t, i, o, a, l, c) {
  function d(n) {
    var s = n[0];
    s.isEmpty && (console.warn("boneTemplate isEmpty"), s = n[1]);
    for (var l = n.length - 1, d = 2; d <= l; d += 1) {
      var u = n[d];
      u ? s.merge(u, !0) : console.error("onTemplatesLoaded: skinTemplate is missing on index", d, "of", n.length, "for skinIds", i, "and boneId", t, "stack:", g);
    }
    var h = t.split("/")[0],
      p = new r(e, s, a ? a / 100 : 1, h, o);
    return m !== !1 && e.setAnimManager(p), c && c(p);
  }
  l = l || {};
  var u = [];
  u.push(new n("bone", t, l.boneType));
  u.push(new n("bone", "666/motion", l.boneType));
  for (var h = i.length, p = 0; p < h; p += 1) {
    u.push(new n("skin", i[p], l.skinType));
  }
  var m = l.addToSprite,
    f = l.textureCache || e.renderer,
    g = new Error("stack");
  s.loadTemplates(u, d, f, "archivable");
};
t.loadAnimationManager = function (e, t, i, n) {
  function o(t) {
    var o = "string" == typeof i ? i.split("/").shift() : i,
      a = new r(e, t, 1, o);
    return e.setAnimManager(a), n && n(a);
  }
  var a = e.renderer;
  s.loadTemplate(t, i, "", o, a, "archivable");
};
t.loadLook = function (e, i, n, s) {
  function r() {
    if (m += 1, m === f) {
      for (var e = 0; e < h; e += 1) {
        var t = u[e],
          i = d[e];
        p && i.addSubentity(p);
        c.addSubentity({
          animManager: i,
          bindingPoint: "carried_" + t.bindingPointCategory + "_" + t.bindingPointIndex,
          symbolModifier: l[t.bindingPointCategory],
          bindingPointCategory: t.bindingPointCategory
        });
      }
      return s & s(c);
    }
  }
  n = n || {};
  var c = null,
    d = [],
    u = e.showSubentities ? i.subentities : null,
    h = u ? u.length : 0,
    p = null,
    m = 0,
    f = 2 + h,
    g = i.bonesId + "/motion",
    _ = i.skins,
    v = a.parseIndexedColors(i.indexedColors),
    y = i.scales[0];
  t.loadCharacterAnimationManager(e, g, _, v, y, n, function (t) {
    c = t;
    var i = t.sprite.parentActor;
    i && (i.carriedEntity.animManager = t);
    e.carriedEntity && (!e.actorManager.isCreatureModeOn && h > 0 ? p = e.carriedEntity : c.addSubentity(e.carriedEntity));
    r();
  });
  n.addToSprite = !1;
  for (var w = 0; w < h; w += 1) {
    o(e, u[w], w, d, n, r);
  }
  r();
};
u.push(new n("bone", t, l.boneType));
u.push(new n("bone", "666/motion", l.boneType));
p && i.addSubentity(p);
c.addSubentity({
  animManager: i,
  bindingPoint: "carried_" + t.bindingPointCategory + "_" + t.bindingPointIndex,
  symbolModifier: l[t.bindingPointCategory],
  bindingPointCategory: t.bindingPointCategory
});
t.loadCharacterAnimationManager(e, g, _, v, y, n, function (t) {
  c = t;
  var i = t.sprite.parentActor;
  i && (i.carriedEntity.animManager = t);
  e.carriedEntity && (!e.actorManager.isCreatureModeOn && h > 0 ? p = e.carriedEntity : c.addSubentity(e.carriedEntity));
  r();
});
n.addToSprite = !1;
i && (i.carriedEntity.animManager = t);
e.carriedEntity && (!e.actorManager.isCreatureModeOn && h > 0 ? p = e.carriedEntity : c.addSubentity(e.carriedEntity));
r();
this.symbols = e;
this.matrices = t;
this.colors = i;
_.isGraphic && (c[g] = new d(_, a, i));
_.isAnim && (c[g] = new r(_, a, i));
t.loadTemplate = function (e, t, i, n, s, r) {
  function d(i) {
    if (m = i, T += 1, T === C) {
      I = o(M, m, p);
      var s = a(e, t, p, I);
      return n && n(s);
    }
  }
  function u(i) {
    if (p = i, T += 1, T === C) {
      void 0 === I && (I = o(M, m, p));
      var s = a(e, t, p, I);
      return n && n(s);
    }
  }
  if (g.isMissingTemplates(t)) {
    var h = s.getEmptyTexture();
    return n && n(a(e, t, h, w));
  }
  var p,
    m,
    f = _[e] + i + t,
    b = f + ".png",
    M = f + ".json",
    T = 0,
    C = 1,
    I = y.holdElement(M);
  void 0 === I && (C += 1, l.loadJson(M, d));
  c.loadTexture(b, u, s, v[e], r);
};
t.loadTemplates = function (e, t, i, n) {
  function s(i, n) {
    var s = M[n],
      r = d[s];
    if (void 0 === r) {
      h[s] = i;
    } else {
      var l = f[s],
        c = o(l, i, r);
      u[s] = c;
      var m = e[s];
      p[s] = a(m.type, m.id, r, c);
    }
    if (C += 1, C === I) {
      return t && t(p);
    }
  }
  function r(i, n) {
    d[n] = i;
    var s,
      r,
      l = h[n];
    if (void 0 === l) {
      s = u[n];
      void 0 !== s && (r = e[n], p[n] = a(r.type, r.id, i, s));
    } else {
      var c = f[n];
      s = o(c, l, i);
      r = e[n];
      p[n] = a(r.type, r.id, i, s);
    }
    if (C += 1, C === I) {
      return t && t(p);
    }
  }
  for (var d = [], u = [], h = [], p = [], m = [], f = [], b = [], M = [], T = e.length, C = 0, I = 0, A = 0; A < T; A += 1) {
    var S = e[A],
      E = S.type,
      N = S.id;
    if (g.isMissingTemplates(N)) {
      var x = i.getEmptyTexture();
      p[A] = a(E, N, x, w);
    } else {
      var L = _[E] + S.usage + N,
        O = L + ".png",
        R = L + ".json";
      m.push(O);
      f.push(R);
      I += 1;
      var D = y.holdElement(R);
      void 0 === D ? (b.push(R), M.push(A), I += 1) : u[A] = D;
    }
  }
  var P = v[e[0].type];
  c.loadTextures(m, r, null, i, P, n);
  l.loadJsons(b, s, null);
};
void 0 === I && (C += 1, l.loadJson(M, d));
c.loadTexture(b, u, s, v[e], r);
s = u[n];
void 0 !== s && (r = e[n], p[n] = a(r.type, r.id, i, s));
s = o(c, l, i);
r = e[n];
p[n] = a(r.type, r.id, i, s);
m.push(O);
f.push(R);
I += 1;
c.loadTextures(m, r, null, i, P, n);
l.loadJsons(b, s, null);
this.id = n;
this.cache = e;
this.element = t;
this.memorySize = i;
this.type = s[o];
this.nLocks = 0;
this.reference = null;
this.attachment = null;
this.elementsById = {};
this.actives = new a();
this.archives = new a();
this.memoryUsed = 0;
this.memoryAllocated = e;
this.onElementRemoved = t || null;
this.unidentifiedElementsCount = 0;
this.addCount = 0;
this.removeCount = 0;
n.prototype.isPermanent = function () {
  return this.type === s.permanent;
};
n.prototype._hold = function () {
  return this.type === s.permanent ? this : (this.nLocks += 1, this.cache._holdElement(this), this);
};
n.prototype.release = function () {
  return this.type === s.permanent ? this : (this.nLocks -= 1, void (0 === this.nLocks ? this.cache._releaseElement(this) : this.nLocks < 0 && console.error(new Error("[ElementHandle.release] Number of locks is negative: " + this.id))));
};
n.prototype.isFree = function () {
  return 0 === this.nLocks;
};
e.exports = o;
o.prototype._clean = function () {
  for (var e = this.archives.first; null !== e && this.memoryUsed > this.memoryAllocated;) {
    var t = e.object;
    e = e.next;
    t.nLocks <= 0 && this._removeElement(t);
  }
};
o.prototype.log = function () {
  console.log("***** Cache Stats *****");
  console.log("  Actives", this.actives.length);
  console.log("  Archives", this.archives.length);
  console.log("  Total", Object.keys(this.elementsById).length);
  console.log("  Usage (units)", this.memoryUsed);
  console.log("  Usage (percentage)", (100 * this.memoryUsed / this.memoryAllocated).toFixed(0), "%");
  console.log("  Elements", this.elementsById);
};
o.prototype.getMemoryInformation = function () {
  return {
    actives: this.actives.length,
    archives: this.archives.length,
    total: Object.keys(this.elementsById).length,
    memoryUsed: this.memoryUsed,
    memoryAllocated: this.memoryAllocated,
    percentage: Math.round(100 * this.memoryUsed / this.memoryAllocated)
  };
};
o.prototype._holdElement = function (e) {
  e.type !== s.permanent && (e.reference.container === this.actives ? this.actives.moveToTheEnd(e.reference) : (this.archives.removeByReference(e.reference), e.reference = this.actives.addBack(e)));
};
o.prototype._releaseElement = function (e) {
  this._archiveElement(e);
};
o.prototype._archiveElement = function (e) {
  return e.reference.container !== this.actives ? void console.warn("[Cache3State.archiveElement] The element cannot be archived:", e.id) : void (e.type === s.throwable ? this._removeElement(e) : (this.actives.removeByReference(e.reference), e.reference = this.archives.addBack(e), this._clean()));
};
o.prototype._addElement = function (e) {
  this.elementsById[e.id] = e;
  this.memoryUsed += e.memorySize;
  this._clean();
  e.type !== s.permanent && (e.reference = this.actives.addBack(e));
  this.addCount += 1;
};
o.prototype.addAndHoldElement = function (e, t, i, o, a) {
  var r = Boolean(i);
  r === !1 && (i = "unidentified" + String(this.unidentifiedElementsCount++));
  void 0 !== o && null !== o || (o = r ? "archivable" : "throwable");
  var l = this.elementsById[i];
  if (void 0 !== l) {
    if (!a) {
      return l.type !== s[o] && console.warn("[Cache3State.addElement] Trying to change type of an exisiting element", i), l._hold();
    }
    if (l.isFree() === !1) {
      return console.warn("[Cache3State.addElement] Trying to replace a locked element", i), l._hold();
    }
    this._removeElement(l);
  }
  return l = new n(this, e, t, i, o), this._addElement(l), l._hold();
};
o.prototype.holdElement = function (e) {
  var t = this.elementsById[e];
  if (void 0 !== t) {
    return t._hold();
  }
};
o.prototype.useElement = function (e) {
  var t = this.elementsById[e];
  if (void 0 !== t) {
    return t;
  }
};
o.prototype._removeElement = function (e) {
  delete this.elementsById[e.id];
  this.memoryUsed -= e.memorySize;
  e.type !== s.permanent && (e.reference.container === this.actives ? e.reference = this.actives.removeByReference(e.reference) : e.reference = this.archives.removeByReference(e.reference));
  null !== this.onElementRemoved && this.onElementRemoved(e.element);
  this.removeCount += 1;
};
e = e.next;
t.nLocks <= 0 && this._removeElement(t);
console.log("***** Cache Stats *****");
console.log("  Actives", this.actives.length);
console.log("  Archives", this.archives.length);
console.log("  Total", Object.keys(this.elementsById).length);
console.log("  Usage (units)", this.memoryUsed);
console.log("  Usage (percentage)", (100 * this.memoryUsed / this.memoryAllocated).toFixed(0), "%");
console.log("  Elements", this.elementsById);
this.elementsById[e.id] = e;
this.memoryUsed += e.memorySize;
this._clean();
e.type !== s.permanent && (e.reference = this.actives.addBack(e));
this.addCount += 1;
r === !1 && (i = "unidentified" + String(this.unidentifiedElementsCount++));
void 0 !== o && null !== o || (o = r ? "archivable" : "throwable");
delete this.elementsById[e.id];
this.memoryUsed -= e.memorySize;
e.type !== s.permanent && (e.reference.container === this.actives ? e.reference = this.actives.removeByReference(e.reference) : e.reference = this.archives.removeByReference(e.reference));
null !== this.onElementRemoved && this.onElementRemoved(e.element);
this.removeCount += 1;
this.object = e;
this.previous = t;
this.next = i;
this.container = n;
this.first = null;
this.last = null;
this.length = 0;
e.exports = n;
n.prototype.addFront = function (e) {
  var t = new i(e, null, this.first, this);
  return null === this.first ? (this.first = t, this.last = t) : (this.first.previous = t, this.first = t), this.length += 1, t;
};
n.prototype.add = n.prototype.addFront;
n.prototype.addBack = function (e) {
  var t = new i(e, this.last, null, this);
  return null === this.first ? (this.first = t, this.last = t) : (this.last.next = t, this.last = t), this.length += 1, t;
};
n.prototype.popFront = function () {
  var e = this.first.object;
  return this.removeByReference(this.first), e;
};
n.prototype.pop = n.prototype.popFront;
n.prototype.popBack = function () {
  var e = this.last.object;
  return this.removeByReference(this.last), e;
};
n.prototype.addBefore = function (e, t) {
  var n = new i(t, e.previous, e, this);
  return null !== e.previous && (e.previous.next = n), e.previous = n, this.first === e && (this.first = n), this.length += 1, n;
};
n.prototype.addAfter = function (e, t) {
  var n = new i(t, e, e.next, this);
  return null !== e.next && (e.next.previous = n), e.next = n, this.last === e && (this.last = n), this.length += 1, n;
};
n.prototype.moveToTheBeginning = function (e) {
  return !(!e || e.container !== this) && (null === e.previous || (e.previous.next = e.next, this.last === e ? this.last = e.previous : e.next.previous = e.previous, e.previous = null, e.next = this.first, e.next.previous = e, this.first = e, !0));
};
n.prototype.moveToTheEnd = function (e) {
  return !(!e || e.container !== this) && (null === e.next || (e.next.previous = e.previous, this.first === e ? this.first = e.next : e.previous.next = e.next, e.next = null, e.previous = this.last, e.previous.next = e, this.last = e, !0));
};
n.prototype.removeByReference = function (e) {
  return e.container !== this ? (console.warn("[DoublyList.removeByReference] Trying to remove a node that does not belong to the list"), e) : (null === e.next ? this.last = e.previous : e.next.previous = e.previous, null === e.previous ? this.first = e.next : e.previous.next = e.next, e.container = null, this.length -= 1, null);
};
n.prototype.remove = function (e) {
  for (var t = this.first; null !== t; t = t.next) {
    if (t.object === e) {
      return this.removeByReference(t), !0;
    }
  }
  return !1;
};
n.prototype.clear = function () {
  for (var e = this.first; null !== e; e = e.next) {
    e.container = null;
  }
  this.first = null;
  this.last = null;
  this.length = 0;
};
n.prototype.forEach = function (e, t) {
  for (var i = this.first; i; i = i.next) {
    e(i.object, t);
  }
};
n.prototype.toArray = function () {
  for (var e = [], t = this.first; null !== t; t = t.next) {
    e.push(t.object);
  }
  return e;
};
this.first = null;
this.last = null;
this.length = 0;
t.loadTexture = function (e, t, i, a, s) {
  var r = i.holdTexture(e);
  return r ? void t(r) : void o.loadImage(e, function (o) {
    var r;
    r = o === n.EMPTY_IMAGE ? i.getEmptyTexture() : i.createTexture(o, e, a, s);
    t(r);
  });
};
t.loadTextures = function (e, t, i, a, s, r) {
  for (var l = [], c = [], d = e.length, u = 0; u < d; u += 1) {
    var h = e[u],
      p = a.holdTexture(h);
    p ? t(p, u) : (l.push(h), c.push(u));
  }
  return 0 === l.length ? i && i() : void o.loadImages(l, function (e, i) {
    var o,
      d = l[i];
    o = e === n.EMPTY_IMAGE ? a.getEmptyTexture() : a.createTexture(e, d, s, r);
    t(o, c[i]);
  }, i);
};
r = o === n.EMPTY_IMAGE ? i.getEmptyTexture() : i.createTexture(o, e, a, s);
t(r);
o = e === n.EMPTY_IMAGE ? a.getEmptyTexture() : a.createTexture(e, d, s, r);
t(o, c[i]);
this.vertexPos = [e.x, e.y, e.x + e.w, e.y + e.h];
this.textureCoord = [e.sx / i.element.width, e.sy / i.element.height, (e.sx + e.sw) / i.element.width, (e.sy + e.sh) / i.element.height];
this.id = e.id;
this.tint = e.tint;
this.texture = i;
this.className = e.className;
this.nbFrames = 1;
this.animationData = t;
i.prototype.isGraphic = !0;
e.exports = i;
this.id = e.id;
this.matrices = e.matrices;
this.colors = e.colors;
this.frames = e.frames;
this.maskStart = e.maskStart || !1;
this.maskEnd = e.maskEnd || !1;
this.children.push(new i(s));
o < s.frames[1] && (o = s.frames[1]);
this.id = e.id;
this.duration = e.duration;
this.className = e.className;
this.sounds = e.sounds;
this.nbFrames = o + 1;
this.animationData = t;
n.prototype.isAnim = !0;
e.exports = n;
this.id = e.id;
this.className = e.className;
this.sounds = e.sounds;
this.duration = e.duration;
this.nbFrames = this.frames.length;
this.animationData = t;
n.prototype.isAnim = !0;
e.exports = n;
this._id = e;
c.call(this, e);
this.externalSymbols = {};
this.mergedTemplates = {};
this.mergedSymbols = {};
this.matrices = [];
this.colors = [];
this.only4Directions = !1;
this.color = n;
this.texture = e;
this.vertexPos = t;
this.textureCoord = i;
d(n, c);
e.exports = n;
n.prototype._updateId = function () {
  this.id = this._id;
  for (var e = Object.keys(this.mergedTemplates), t = 0; t < e.length; t += 1) {
    this.id += "#" + this.mergedTemplates[e[t]].id;
  }
  for (e = Object.keys(this.parentTemplates), t = 0; t < e.length; t += 1) {
    this.parentTemplates[e[t]]._updateId();
  }
};
n.prototype.clear = function () {
  c.prototype.clear.call(this);
  for (var e = Object.keys(this.mergedTemplates), t = 0; t < e.length; t += 1) {
    this.mergedTemplates[e[t]].clear();
  }
};
n.prototype.merge = function (e, t) {
  var i = e.name,
    n = {};
  this.mergedSymbols[i] = n;
  this.mergedTemplates[i] = e;
  e.parentTemplates[this.name] = this;
  var o = e.exposedSymbols;
  for (var a in o) {
    var s = o[a],
      r = this.externalSymbols[s.className];
    r || (r = new l(), this.externalSymbols[s.className] = r);
    n[s.className] = t ? r.addBack(s) : r.addFront(s);
  }
  return this._updateId(), i;
};
n.prototype.unmerge = function (e) {
  var t = e.name,
    i = this.mergedSymbols[t];
  if (i) {
    for (var n in i) {
      var o = this.externalSymbols[n];
      o.removeByReference(i[n]);
      0 === o.length && delete this.externalSymbols[n];
    }
    delete e.parentTemplates[this.name];
    delete this.mergedTemplates[t];
    delete this.mergedSymbols[t];
    e.clear();
    this._updateId();
  }
};
n.prototype.generateTemplate = function (e, t) {
  this.animationHandle = t;
  var i = t.element;
  this.texture = e;
  this.symbols = i.symbols;
  this.matrices = i.matrices;
  this.colors = i.colors;
  for (var n = Object.keys(this.symbols), o = 0; o < n.length; o += 1) {
    var a = this.symbols[n[o]];
    a.className && (this.exposedSymbols[a.className] = a);
  }
  this.isEmpty = 0 === n.length;
};
n.prototype.getSymbol = function (e) {
  var t = this.exposedSymbols[e];
  return t ? t : (t = this.externalSymbols[e], t ? t.last.object : null);
};
a.prototype.isMaskTag = !0;
a.prototype.isMaskDef = !0;
s.prototype.isMaskTag = !0;
s.prototype.isMaskUse = !0;
r.prototype.isMaskTag = !0;
r.prototype.isMaskStop = !0;
n.prototype.createSprites = function (e, t, i, n, l, c, d) {
  if (void 0 === i) {
    return [];
  }
  var u,
    h,
    p,
    m,
    f,
    g,
    _,
    v,
    y,
    w,
    b,
    M,
    T,
    C = i.animationData,
    I = C.matrices[e.matrices[t]],
    A = C.colors[e.colors[t]],
    S = I[0],
    E = I[1],
    N = I[2],
    x = I[3],
    L = I[4] * l,
    O = I[5] * c,
    R = A[0],
    D = A[1],
    P = A[2],
    B = A[3],
    k = A[4],
    F = A[5],
    H = A[6],
    z = A[7];
  if (i.className) {
    if (d[i.className]) {
      var W = d[i.className];
      W.mirrored && (S = -S, E = -E);
      f = W.prepareCurrentAnimationFrame();
      var G = [],
        U = f.length;
      for (p = 0; p < U; p += 1) {
        m = f[p];
        G.push(m);
        m.isMaskTag || (h = m.color, m.color = [h[0] * R, h[1] * D, h[2] * P, h[3] * B, h[4] * R + k, h[5] * D + F, h[6] * P + H, h[7] * B + z], u = m.vertexPos, g = u[0], _ = u[1], v = u[2], y = u[3], w = u[4], b = u[5], M = u[6], T = u[7], m.vertexPos = [S * g + N * _ + L, E * g + x * _ + O, S * v + N * y + L, E * v + x * y + O, S * w + N * b + L, E * w + x * b + O, S * M + N * T + L, E * M + x * T + O]);
      }
      return G;
    }
    var q = this.externalSymbols[i.className];
    q && q.length > 0 && (i = q.last.object, C = i.animationData);
  }
  if (S *= l, E *= c, N *= l, x *= c, i.isGraphic) {
    if (h = [R, D, P, B, k, F, H, z], void 0 !== i.tint) {
      var Y = n[i.tint] || {
        r: 1,
        g: 1,
        b: 1
      };
      h[0] *= Y.r;
      h[1] *= Y.g;
      h[2] *= Y.b;
    }
    var j = i.vertexPos;
    return g = j[0], _ = j[1], v = j[2], y = j[3], u = [S * g + N * _ + L, E * g + x * _ + O, S * v + N * _ + L, E * v + x * _ + O, S * g + N * y + L, E * g + x * y + O, S * v + N * y + L, E * v + x * y + O], [new o(i.texture, u, i.textureCoord, h)];
  }
  if (i.isAnim) {
    t %= i.nbFrames;
    for (var V, X, Q, K, J, Z, $, ee, te = [], ie = i.children, ne = ie.length - 1; ne >= 0; ne -= 1) {
      var oe = ie[ne];
      if (!(t < oe.frames[0] || t > oe.frames[1])) {
        if (oe.maskEnd) {
          te.push(new r(oe.id));
        } else {
          for (oe.maskStart && te.push(new a(oe.id)), f = this.createSprites(oe, t - oe.frames[0], C.symbols[oe.id], n, 1, 1, d), p = 0; p < f.length; p += 1) {
            m = f[p];
            te.push(m);
            m.isMaskTag || (u = m.vertexPos, V = u[0], X = u[1], Q = u[2], K = u[3], J = u[4], Z = u[5], $ = u[6], ee = u[7], u[0] = S * V + N * X + L, u[1] = E * V + x * X + O, u[2] = S * Q + N * K + L, u[3] = E * Q + x * K + O, u[4] = S * J + N * Z + L, u[5] = E * J + x * Z + O, u[6] = S * $ + N * ee + L, u[7] = E * $ + x * ee + O, h = m.color, h[0] *= R, h[1] *= D, h[2] *= P, h[3] *= B, h[4] = h[4] * R + k, h[5] = h[5] * D + F, h[6] = h[6] * P + H, h[7] = h[7] * B + z);
          }
          oe.maskStart && te.push(new s(oe.id));
        }
      }
    }
    return te;
  }
  return [];
};
n.prototype.prepareAnimationFrame = function (e, t, i, n, l, c) {
  var d = this.getSymbol(e);
  if (!d) {
    return console.warn("Symbol " + e + " not registered in character's template"), [];
  }
  var u = d.animationData;
  if (d.isGraphic) {
    var h = d.vertexPos,
      p = [1, 1, 1, 1, 0, 0, 0, 0],
      m = h[0] * n,
      f = h[1] * l,
      g = h[2] * n,
      _ = h[3] * l,
      v = [m, f, g, f, m, _, g, _];
    return [new o(d.texture, v, d.textureCoord, p)];
  }
  for (var y = [], w = d.children, b = w.length - 1; b >= 0; b -= 1) {
    var M = w[b];
    if (M.frames[0] <= t && t <= M.frames[1]) {
      if (M.maskEnd) {
        y.push(new r(M.id));
        continue;
      }
      var T = this.createSprites(M, t - M.frames[0], u.symbols[M.id], i, n, l, c);
      M.maskStart ? (y.push(new a(M.id)), Array.prototype.push.apply(y, T), y.push(new s(M.id))) : Array.prototype.push.apply(y, T);
    }
  }
  return y;
};
this.mergedSymbols[i] = n;
this.mergedTemplates[i] = e;
e.parentTemplates[this.name] = this;
r || (r = new l(), this.externalSymbols[s.className] = r);
n[s.className] = t ? r.addBack(s) : r.addFront(s);
o.removeByReference(i[n]);
0 === o.length && delete this.externalSymbols[n];
delete e.parentTemplates[this.name];
delete this.mergedTemplates[t];
delete this.mergedSymbols[t];
e.clear();
this._updateId();
this.texture = e;
this.symbols = i.symbols;
this.matrices = i.matrices;
this.colors = i.colors;
W.mirrored && (S = -S, E = -E);
f = W.prepareCurrentAnimationFrame();
m = f[p];
G.push(m);
m.isMaskTag || (h = m.color, m.color = [h[0] * R, h[1] * D, h[2] * P, h[3] * B, h[4] * R + k, h[5] * D + F, h[6] * P + H, h[7] * B + z], u = m.vertexPos, g = u[0], _ = u[1], v = u[2], y = u[3], w = u[4], b = u[5], M = u[6], T = u[7], m.vertexPos = [S * g + N * _ + L, E * g + x * _ + O, S * v + N * y + L, E * v + x * y + O, S * w + N * b + L, E * w + x * b + O, S * M + N * T + L, E * M + x * T + O]);
h[0] *= Y.r;
h[1] *= Y.g;
h[2] *= Y.b;
m = f[p];
te.push(m);
m.isMaskTag || (u = m.vertexPos, V = u[0], X = u[1], Q = u[2], K = u[3], J = u[4], Z = u[5], $ = u[6], ee = u[7], u[0] = S * V + N * X + L, u[1] = E * V + x * X + O, u[2] = S * Q + N * K + L, u[3] = E * Q + x * K + O, u[4] = S * J + N * Z + L, u[5] = E * J + x * Z + O, u[6] = S * $ + N * ee + L, u[7] = E * $ + x * ee + O, h = m.color, h[0] *= R, h[1] *= D, h[2] *= P, h[3] *= B, h[4] = h[4] * R + k, h[5] = h[5] * D + F, h[6] = h[6] * P + H, h[7] = h[7] * B + z);
this.id = e;
this.name = "t" + n++;
this.exposedSymbols = {};
this.texture = null;
this.animationHandle = null;
this.symbols = {};
this.parentTemplates = {};
this.isEmpty = !0;
e.exports = i;
i.prototype.getFullId = function () {
  return this.id;
};
i.prototype.clear = function () {
  this.texture && this.texture.release();
  this.animationHandle && this.animationHandle.release();
};
i.prototype.merge = function () {};
i.prototype.unmerge = function () {};
i.prototype.generateTemplate = function () {};
i.prototype.getSymbol = function (e) {
  var t = this.exposedSymbols[e];
  return t ? t : null;
};
i.prototype.hasAnimation = function (e) {
  return !!this.getSymbol(e);
};
i.prototype.getAnimationNbFrames = function (e) {
  var t = this.getSymbol(e);
  return t ? t.nbFrames : (console.warn("Symbol " + e + " not registered in the template of the character"), 0);
};
i.prototype.getAnimationDuration = function (e) {
  var t = this.getSymbol(e);
  return t ? t.duration : (console.warn("Symbol " + e + " not registered in the template of the character"), 0);
};
this.texture && this.texture.release();
this.animationHandle && this.animationHandle.release();
this.color = n;
this.texture = e;
this.vertexPos = t;
this.textureCoord = i;
s(n, a);
e.exports = n;
n.prototype.merge = function () {
  console.error(new Error("[AtlasAnimationTemplate.merge]It is not possible to merge a template with an atlas template"));
};
n.prototype.unmerge = function () {
  console.error(new Error("[AtlasAnimationTemplate.merge]It is not impossible to merge a template with an atlas template and therefore to unmerge"));
};
n.prototype.generateTemplate = function (e, t) {
  this.animationHandle = t;
  this.texture = e;
  this.symbols = t.element;
  for (var i = Object.keys(this.symbols), n = 0; n < i.length; n += 1) {
    var o = this.symbols[i[n]];
    o.className && (this.exposedSymbols[o.className] = o);
  }
  this.isEmpty = 0 === i.length;
};
n.prototype.prepareAnimationFrame = function (e, t, i, n, a) {
  var s = this.getSymbol(e);
  if (!s) {
    return console.warn("Symbol " + e + " not registered in character's template"), [];
  }
  if (s.isAnim) {
    var r = s.frames;
    t >= 0 && t <= r.length && (s = r[t]);
  }
  var l = s.vertexPos,
    c = l[0] * n,
    d = l[1] * a,
    u = l[2] * n,
    h = l[3] * a,
    p = [1, 1, 1, 1, 0, 0, 0, 0],
    m = [c, d, u, d, c, h, u, h],
    f = new o(s.texture, m, s.textureCoord, p);
  return [f];
};
this.animationHandle = t;
this.texture = e;
this.symbols = t.element;
t.loadMissingTemplatesInfo = function () {
  o.loadJson(n.MISSING_ANIM_PATH, function (e) {
    for (var t = 0; t < e.length; t++) {
      a[e[t]] = !0;
    }
  });
};
t.isMissingTemplates = function (e) {
  return a[e] || !1;
};
this.id = "";
this.sounds = null;
h.call(this, e);
this.animationId = null;
this.animationName = "";
this.template = t;
this.bonesId = o;
this.audioVol = 1;
this.scaleX = i || 1;
this.scaleY = i || 1;
this.mirrored = !1;
this._frame = -1;
this._prevFrame = -1;
this.nbFrames = 0;
this.frameData = new n();
this.tints = [];
this.tintsString = "";
this._setTints(a);
this.loadedAnimations = {};
this.only4Directions = s && !(s.AnimStatique_0 || s.AnimStatique_4);
this.isFx = this.sprite.isFx;
this.tween = new l(this, ["frame"]);
this.tween.from({
  frame: 0
});
this._cleared = !1;
this._stopped = !1;
n = i.pop();
n[0] = Math.min(n[0], Math.max(s[0], r[0]));
n[1] = Math.max(n[1], Math.min(s[1], r[1]));
n[2] = Math.min(n[2], Math.max(s[2], r[2]));
n[3] = Math.max(n[3], Math.min(s[3], r[3]));
n[0] = Math.min(n[0], l[0], l[2], l[4], l[6]);
n[1] = Math.max(n[1], l[0], l[2], l[4], l[6]);
n[2] = Math.min(n[2], l[1], l[3], l[5], l[7]);
n[3] = Math.max(n[3], l[1], l[3], l[5], l[7]);
t += 1;
r(o, h);
e.exports = o;
Object.defineProperty(o.prototype, "frame", {
  get: function () {
    return this._frame;
  },
  set: function (e) {
    e = e < this.nbFrames ? Math.floor(e) : this.nbFrames - 1;
    this._frame !== e && (this._frame = e, this.sprite.forceRefresh());
  }
});
o.prototype.switchAnimationManager = function () {};
o.prototype.isTemporary = !1;
o.prototype._computeSymbolDirection = function (e) {
  return e.direction === -1 ? -1 : this.isFx && 0 === e.direction ? 0 : this.only4Directions && 0 === (1 & e.direction) ? e.direction + 1 : e.direction;
};
o.prototype._getSymbolId = function (e) {
  e = this.applyAnimationModifier(e);
  var t = e.type || 0 === e.type ? e.type.toString() : "",
    i = e.param || 0 === e.param ? "_" + e.param.toString() : "",
    n = e.base + t + i,
    o = this._computeSymbolDirection(e);
  return o !== -1 && (n += "_" + v[o]), p.isMissingTemplates(this.bonesId + "/" + n) && "AnimTacle" === e.base && (e.base = "AnimHit", n = e.base + t + i, o !== -1 && (n += "_" + v[o])), n;
};
o.prototype._getSymbolModelId = function (e) {
  return this.bonesId + "/" + this._getSymbolId(e);
};
o.prototype.isMissingTemplates = function (e) {
  return p.isMissingTemplates(this._getSymbolModelId(e));
};
o.prototype.addAnimation = function (e, t) {
  function i() {
    if (n += 1, n === o) {
      return t && t();
    }
  }
  var n = 0,
    o = 1;
  if (!this.hasSubentities) {
    return this._addAnimation(this._getSymbolModelId(e), i);
  }
  for (var a = this.subentities, s = !0, r = 0; r < a.length; r++) {
    var l = a[r],
      c = l.symbolModifier(e);
    if (c.parent) {
      var d = c.parent;
      o += 1;
      s = s && this._addAnimation(this._getSymbolModelId(d), i);
    }
    c.child && (o += 1, s = s && l.animManager.addAnimation(c.child, i));
  }
  return i(), s;
};
o.prototype._addAnimation = function (e, t) {
  if (!this.bonesId) {
    return console.warn("Incorrect bones id:", this.bonesId), t(), !1;
  }
  if (this.loadedAnimations[e]) {
    return t(), !0;
  }
  var i = this;
  return u.loadTemplate("bone", e, "", function (n) {
    i.template.merge(n, !1);
    i.loadedAnimations[e] = n;
    t();
  }, this.sprite.renderer), !0;
};
o.prototype.applyAnimationModifier = function (e) {
  var t = this.animationModifiers[e.base];
  if (!t) {
    return e;
  }
  switch (typeof t) {
    case "string":
      return {
        base: t,
        type: e.type,
        param: e.param,
        direction: e.direction
      };
    case "function":
      return t(e);
    default:
      return console.error("Wrong animation modifier type"), e;
  }
};
o.prototype.cleanupAnimations = function () {
  var e = this.template;
  for (var t in this.loadedAnimations) {
    var i = this.loadedAnimations[t];
    e.unmerge(i);
  }
  this.loadedAnimations = {};
  this.stop();
  for (var n = 0; n < this.subentities.length; n++) {
    this.subentities[n].animManager.stop();
    this.subentities[n].animManager.cleanupAnimations();
  }
};
o.prototype.cleanupAnimationsAndRemoveSubentities = function () {
  this.cleanupAnimations();
  this.subentities = [];
  this.hasSubentities = !1;
};
o.prototype.clear = function () {
  return this._cleared ? void console.warn("[AnimationManager.clear] Trying to clear an already cleared animation manager") : (this.cleanupAnimationsAndRemoveSubentities(), this.template.clear(), this.sprite.renderer.unlockBuffer(this.frameData.id), this.frameData.id = "", void (this._cleared = !0));
};
o.prototype._setTints = function (e) {
  e || (e = []);
  for (var t, i = [], n = this.tints.length !== e.length, o = 0; o < e.length; o += 1) {
    var a = e[o];
    if (t = a ? {
      r: a.r / 128,
      g: a.g / 128,
      b: a.b / 128
    } : {
      r: 1,
      g: 1,
      b: 1
    }, i[o] = t, !n) {
      var s = this.tints[o];
      n = s.r !== t.r || s.g !== t.g || s.b !== t.b;
    }
  }
  if (this.tints = i, n) {
    for (this.tintsString = "#", o = 0; o < i.length; o += 1) {
      t = i[o];
      this.tintsString += Math.round(255 * t.r).toString(16) + Math.round(255 * t.g).toString(16) + Math.round(255 * t.b).toString(16);
    }
  }
  return n;
};
o.prototype.setTints = function (e) {
  this._setTints(e) && this.releaseBuffer();
};
o.prototype.prepareCurrentAnimationFrame = function () {
  return this.template.prepareAnimationFrame(this.animationName, this._frame, this.tints, this.scaleX, this.scaleY, this.subentityRefs);
};
o.prototype.getSymbolDuration = function (e) {
  var t = this.template.exposedSymbols[e];
  return t ? t.duration : 0;
};
o.prototype.releaseBuffer = function () {
  this.sprite.renderer.releaseBuffer(this.frameData.id);
  this.frameData.id = "";
  this.sprite.forceRefresh();
};
o.prototype.generateCurrentFrameData = function () {
  if (null === this.animationId) {
    return [1 / 0, -(1 / 0), 1 / 0, -(1 / 0)];
  }
  var e = this.sprite.renderer,
    t = this.frameData.id;
  this.frameData.id = "";
  this._generateCurrentFrameId(this.frameData);
  var i = e.getBufferData(this.frameData.id);
  return void 0 === i && (i = a(this.prepareCurrentAnimationFrame()), e.prepareBatchFromSpriteList(this.frameData.id, i)), this.frameData.id !== t && (e.unlockBuffer(t), e.lockBuffer(this.frameData.id)), i.bbox;
};
o.prototype._generateCurrentFrameId = function (e) {
  var t = this._frame;
  e.id += this.animationId + t.toString();
  this._prevFrame !== t && (this._prevFrame = t);
  for (var i = 0; i < this.subentities.length; i += 1) {
    this.subentities[i].animManager._generateCurrentFrameId(e);
  }
};
o.prototype.draw = function (e) {
  e.drawSpriteBatch(this.frameData.id);
};
o.prototype._setMirroring = function (e, t) {
  e !== -1 && y[e] ^ t ? this.scaleX > 0 && (this.mirrored = !0, this.scaleX *= -1) : this.scaleX < 0 && (this.mirrored = !1, this.scaleX *= -1);
};
o.prototype.assignSymbol = function (e, t, i) {
  if (this.subentityRefs = {}, this.hasSubentities) {
    for (var n = null, o = {
        base: "AnimStatique",
        direction: e.direction
      }, a = 0; a < this.subentities.length; a++) {
      var r = this.subentities[a],
        l = r.animManager,
        c = r.symbolModifier(e);
      n = c.parent || n;
      c.child ? (l.assignSymbol(c.child, t, i), i = null) : l.assignSymbol(o, !1);
      this.subentityRefs[r.bindingPoint] = l;
      l.mirrored = !1;
    }
    e = n || o;
  }
  (this.tween.playing || this.tween.starting) && this.tween.stop();
  var d = this._getSymbolId(e),
    u = this._computeSymbolDirection(e);
  if (this.template.hasAnimation(d)) {
    this._setMirroring(u);
  } else {
    e = this.applyAnimationModifier(e);
    var h = e.type || 0 === e.type ? e.type : "",
      p = e.param || 0 === e.param ? "_" + e.param : "";
    if (d = e.base + h + p + "_" + b[u], this.template.hasAnimation(d)) {
      this._setMirroring(u, !0);
    } else {
      for (var f = !1, g = 0; g < 8; g++) {
        if (d = e.base + h + p + "_" + g, this.template.hasAnimation(d)) {
          this._setMirroring(g);
          f = !0;
          break;
        }
      }
      if (!f) {
        return console.warn("Could not find any Animation " + e.base + " in template", this.template.id), i && i();
      }
    }
  }
  var v = this;
  this.animationName = d;
  var y = this.template.id + "#" + d;
  return this.animationId = y + "#" + this.scaleY + this.tintsString + (this.mirrored ? "M#" : "#"), this.nbFrames = this.template.getAnimationNbFrames(d), this._prevFrame = -1, this._frame = -1, this.frame = 0, 0 === this.nbFrames ? i && i() : ("AnimStatique" === e.base && this.nbFrames > 1 && (t = !0), "AnimStatique_to_AnimMarche" !== e.base && "AnimStatique_to_AnimCourse" !== e.base || (t = !1), this._stopped = !1, void _.getAudio(parseInt(v.bonesId, 10), v.animationName, function (e, n) {
    if (v._stopped) {
      return i && i();
    }
    e && m.error(new Error("regAudio: " + e));
    v.tween.reset().to({
      frame: v.nbFrames
    }, v.nbFrames).start(t);
    var o = -1;
    if (v.tween.onUpdate(function () {
      if (v._stopped) {
        return v.tween.stop();
      }
      if (o !== v._frame) {
        var e = null;
        n && n.isSoundAnimationsPerFrame && (e = n, e.hasSoundForFrame(v.frame) && s(e.getIds(v.frame), v.sprite._x));
        o = v._frame;
      }
    }), i) {
      if (t) {
        return i();
      }
      v.tween.onceFinish(i);
    }
  }));
};
o.prototype.stop = function () {
  this._stopped = !0;
  (this.tween.playing || this.tween.starting) && this.tween.stop();
};
e = e < this.nbFrames ? Math.floor(e) : this.nbFrames - 1;
this._frame !== e && (this._frame = e, this.sprite.forceRefresh());
o += 1;
s = s && this._addAnimation(this._getSymbolModelId(d), i);
i.template.merge(n, !1);
i.loadedAnimations[e] = n;
t();
this.loadedAnimations = {};
this.stop();
this.subentities[n].animManager.stop();
this.subentities[n].animManager.cleanupAnimations();
this.cleanupAnimations();
this.subentities = [];
this.hasSubentities = !1;
t = i[o];
this.tintsString += Math.round(255 * t.r).toString(16) + Math.round(255 * t.g).toString(16) + Math.round(255 * t.b).toString(16);
this.sprite.renderer.releaseBuffer(this.frameData.id);
this.frameData.id = "";
this.sprite.forceRefresh();
this.frameData.id = "";
this._generateCurrentFrameId(this.frameData);
e.id += this.animationId + t.toString();
this._prevFrame !== t && (this._prevFrame = t);
n = c.parent || n;
c.child ? (l.assignSymbol(c.child, t, i), i = null) : l.assignSymbol(o, !1);
this.subentityRefs[r.bindingPoint] = l;
l.mirrored = !1;
this._setMirroring(g);
f = !0;
e && m.error(new Error("regAudio: " + e));
v.tween.reset().to({
  frame: v.nbFrames
}, v.nbFrames).start(t);
n && n.isSoundAnimationsPerFrame && (e = n, e.hasSoundForFrame(v.frame) && s(e.getIds(v.frame), v.sprite._x));
o = v._frame;
this._stopped = !0;
(this.tween.playing || this.tween.starting) && this.tween.stop();
this._time = 0;
this._duration = 0;
this.playing = !1;
this.stopping = !1;
this.starting = !1;
this._iterations = 0;
this._onStart = null;
this._onStop = null;
this._onFinish = null;
this._onUpdate = null;
this._onceFinish = null;
this.reference = null;
n.call(this);
this._duration = e;
this.onFinish(t);
this.start = i;
this.end = i + n;
this.duration = n;
this.fromObject = e;
this.toObject = t;
this.easing = o;
this.easingParam = a;
this.callback = s;
n.call(this);
e || (console.error(new Error("Invalid tween element: " + e)), e = {});
this._element = e;
this._properties = t;
this._transitions = [];
this._currentTransitionIndex = 0;
this._duration = 0;
this._from = null;
n.call(this);
e || (console.error(new Error("Invalid tween element: " + e)), e = {});
this._element = e;
this._properties = t;
this._previousValues = {};
this._transitions = [];
this._currentTransitionIndex = 0;
this._duration = 0;
this._from = null;
this._startingTime = h.now();
this._previousTime = h.now();
e.exports = p;
n.prototype.start = function (e) {
  return e === !0 ? this._iterations = 1 / 0 : this._iterations = e || 1, 0 === this._iterations ? (p._warn("[Playable.start] playable is required to run 0 times"), this) : this.starting ? (p._warn("[Playable.start] playable is already starting"), this) : this.playing && !this.stopping ? (p._warn("[Playable.start] playable is already playing"), this) : (this.starting = !0, p._add(this), this);
};
n.prototype.stop = function () {
  return this.stopping ? (p._warn("[Playable.stop] playable is already stopping"), this) : this.playing || this.starting ? (this.stopping = !0, this.starting = !1, this._finished(), this) : (p._warn("[Playable.stop] playable is not playing"), this);
};
n.prototype.fastForwardToEnd = function () {
  this._time = this._duration;
};
n.prototype._stopped = function () {
  this.stopping = !1;
  this.playing = !1;
  null !== this._onStop && this._onStop();
};
n.prototype._started = function () {
  this.starting = !1;
  this.playing = !0;
  null !== this._onStart && this._onStart();
};
n.prototype._finished = function () {
  if (this.playing = !1, p._remove(this), null !== this._onceFinish) {
    var e = this._onceFinish.slice();
    this._onceFinish = null;
    for (var t = 0; t < e.length; t += 1) {
      e[t]();
    }
  }
  null !== this._onFinish && this._onFinish();
};
n.prototype._reset = function () {
  this._time = 0;
};
n.prototype.update = function (e) {
  if (!this.stopping || (this._stopped(), this.starting)) {
    if (this.starting) {
      this._time = 0;
      this._update();
      this._started();
    } else {
      var t = this._time + e;
      t >= this._duration ? 1 === this._iterations ? (this._time = this._duration, this._update(), null !== this._onUpdate && this._onUpdate(), this._finished()) : (this._time = t % this._duration, this._update(), null !== this._onUpdate && this._onUpdate(), this._iterations -= 1) : (this._time = t, this._update(), null !== this._onUpdate && this._onUpdate());
    }
  }
};
n.prototype.onUpdate = function (e) {
  return this._onUpdate = e || null, this;
};
n.prototype.onStart = function (e) {
  return this._onStart = e || null, this;
};
n.prototype.onStop = function (e) {
  return this._onStop = e || null, this;
};
n.prototype.onFinish = function (e) {
  return this._onFinish = e || null, this;
};
n.prototype.onceFinish = function (e) {
  return null === this._onceFinish ? this._onceFinish = [e] : this._onceFinish.push(e), this;
};
n.prototype.removeOnFinish = function () {
  return this._onFinish = null, this._onceFinish = null, this;
};
n.prototype.removeOnUpdate = function () {
  return this._onUpdate = null, this;
};
n.prototype.removeOnStart = function () {
  return this._onStart = null, this;
};
n.prototype.removeOnStop = function () {
  return this._onStop = null, this;
};
n.prototype.getElapsedTime = function () {
  return this._time;
};
n.prototype.getRemainingTime = function () {
  return this._duration - this._time;
};
l(o, n);
p.Delay = o;
o.prototype.reset = function (e, t) {
  this._duration = e;
  this.removeOnFinish();
  this.onFinish(t);
};
o.prototype._update = function () {};
l(s, n);
p.Tween = s;
s.prototype.reset = function () {
  return this._from = null, this._duration = 0, this._currentTransitionIndex = 0, this._transitions = [], this._reset(), this;
};
s.prototype.from = function (e) {
  return this._from = e, this._transitions.length > 0 && (this._transitions[0].from = e), this;
};
s.prototype._setFrom = function () {
  this._from = {};
  for (var e = 0; e < this._properties.length; e += 1) {
    var t = this._properties[e];
    this._from[t] = this._element[t];
  }
  return this._from;
};
s.prototype._getLastTransitionEnding = function () {
  return this._transitions.length > 0 ? this._transitions[this._transitions.length - 1].toObject : null === this._from ? this._setFrom() : this._from;
};
s.prototype.to = function (e, t, i, n, o) {
  void 0 === i && (i = d.linear);
  var s = this._getLastTransitionEnding();
  return this._transitions.push(new a(s, e, this._duration, t, i, n, o)), this._duration += t, this;
};
s.prototype.wait = function (e, t) {
  if (0 === e) {
    return this;
  }
  var i = this._getLastTransitionEnding();
  return this._transitions.push(new a(i, i, this._duration, e, d.linear, null, t)), this._duration += e, this;
};
s.prototype._update = function () {
  for (; this._time < this._transitions[this._currentTransitionIndex].start;) {
    this._currentTransitionIndex--;
  }
  for (; this._time > this._transitions[this._currentTransitionIndex].end;) {
    this._currentTransitionIndex++;
    this._transitions[this._currentTransitionIndex].callback && this._transitions[this._currentTransitionIndex].callback();
  }
  for (var e = this._transitions[this._currentTransitionIndex], t = e.easing((this._time - e.start) / e.duration, e.easingParam), i = e.fromObject, n = e.toObject, o = 0; o < this._properties.length; o++) {
    var a = this._properties[o];
    this._element[a] = i[a] * (1 - t) + n[a] * t;
  }
};
l(r, n);
p.RelativeTween = r;
r.prototype.reset = function () {
  this._from = null;
  this._duration = 0;
  this._currentTransitionIndex = 0;
  this._transitions = [];
  this._reset();
  this._previousValues = {};
  for (var e = 0; e < this._properties.length; e += 1) {
    this._previousValues[this._properties[e]] = 0;
  }
  return this;
};
r.prototype.from = function (e) {
  return this._from = e, this._transitions.length > 0 && (this._transitions[0].from = e), this;
};
r.prototype._setFrom = function () {
  this._from = {};
  for (var e = 0; e < this._properties.length; e += 1) {
    this._from[this._properties[e]] = 0;
  }
  return this._from;
};
r.prototype._getLastTransitionEnding = function () {
  return this._transitions.length > 0 ? this._setFrom() : null === this._from ? this._setFrom() : this._from;
};
r.prototype.to = function (e, t, i, n) {
  void 0 === i && (i = d.linear);
  var o = this._getLastTransitionEnding();
  return this._transitions.push(new a(o, e, this._duration, t, i, n)), this._duration += t, this;
};
r.prototype.wait = function (e) {
  if (0 === e) {
    return this;
  }
  var t = this._getLastTransitionEnding();
  return this._transitions.push(new a(t, t, this._duration, e, d.linear, null)), this._duration += e, this;
};
r.prototype._update = function () {
  for (; this._time < this._transitions[this._currentTransitionIndex].start;) {
    this._currentTransitionIndex--;
  }
  for (; this._time > this._transitions[this._currentTransitionIndex].end;) {
    this._currentTransitionIndex++;
  }
  for (var e = this._transitions[this._currentTransitionIndex], t = e.easing((this._time - e.start) / e.duration, e.easingParam), i = e.fromObject, n = e.toObject, o = 0; o < this._properties.length; o++) {
    var a = this._properties[o],
      s = i[a] * (1 - t) + n[a] * t;
    this._element[a] += s - this._previousValues[a];
    this._previousValues[a] = s;
  }
};
this.stopping = !1;
this.playing = !1;
null !== this._onStop && this._onStop();
this.starting = !1;
this.playing = !0;
null !== this._onStart && this._onStart();
this._time = 0;
this._update();
this._started();
this._duration = e;
this.removeOnFinish();
this.onFinish(t);
this._currentTransitionIndex++;
this._transitions[this._currentTransitionIndex].callback && this._transitions[this._currentTransitionIndex].callback();
this._from = null;
this._duration = 0;
this._currentTransitionIndex = 0;
this._transitions = [];
this._reset();
this._previousValues = {};
this._element[a] += s - this._previousValues[a];
this._previousValues[a] = s;
t.none = function () {
  return 1;
};
t.linear = function (e) {
  return e;
};
t.flash = function (e, t) {
  return e + e * t - e * e * t;
};
t.parabolic = function (e) {
  var t = 2 * e - 1;
  return 1 - t * t;
};
t.trigo = function (e, t) {
  return .5 * (1 - Math.cos(o * e * t));
};
t.elastic = function (e, t) {
  if (1 === e) {
    return 1;
  }
  t /= t + 1;
  var i = (1 + t) * Math.log(1 - e) / Math.log(t);
  return Math.cos(i - n) * Math.pow(t, i);
};
t.quadIn = function (e) {
  return e * e;
};
t.quadOut = function (e) {
  return 2 * e - e * e;
};
t.quadInOut = function (e) {
  return e < .5 ? 2 * e * e : 2 * (2 * e - e * e) - 1;
};
t.cubicIn = function (e) {
  return e * e * e;
};
t.cubicOut = function (e) {
  return 3 * e - 3 * e * e + e * e * e;
};
t.cubicInOut = function (e) {
  return e < .5 ? 4 * e * e * e : 4 * (3 * e - 3 * e * e + e * e * e) - 3;
};
t.quarticIn = function (e) {
  return e * e * e * e;
};
t.quarticOut = function (e) {
  var t = e * e;
  return 4 * e - 6 * t + 4 * t * e - t * t;
};
t.quarticInOut = function (e) {
  if (e < .5) {
    return 8 * e * e * e * e;
  }
  var t = e * e;
  return 8 * (4 * e - 6 * t + 4 * t * e - t * t) - 7;
};
t.polyIn = function (e, t) {
  return Math.pow(e, t);
};
t.polyOut = function (e, t) {
  return 1 - Math.pow(1 - e, t);
};
t.polyInOut = function (e, t) {
  return e < .5 ? Math.pow(2 * e, t) / 2 : (2 - Math.pow(2 * (1 - e), t)) / 2;
};
t.sineIn = function (e) {
  return 1 - Math.cos(n * e);
};
t.sineOut = function (e) {
  return Math.sin(n * e);
};
t.sineInOut = function (e) {
  return e < .5 ? (1 - Math.cos(i * e)) / 2 : (1 + Math.sin(i * (e - .5))) / 2;
};
t.expIn = function (e, t) {
  return (1 - Math.pow(a, t * e)) / (1 - Math.pow(a, t));
};
t.expOut = function (e, t) {
  return (1 - Math.pow(a, -t * e)) / (1 - Math.pow(a, -t));
};
t.expInOut = function (e, t) {
  return e < .5 ? (1 - Math.pow(a, 2 * t * e)) / (1 - Math.pow(a, t)) / 2 : .5 + (1 - Math.pow(a, t - 2 * t * e)) / (1 - Math.pow(a, -t)) / 2;
};
t.circIn = function (e) {
  return 1 - Math.sqrt(1 - Math.pow(e, 2));
};
t.circOut = function (e) {
  return Math.sqrt(1 - Math.pow(1 - e, 2));
};
t.circInOut = function (e) {
  return e < .5 ? (1 - Math.sqrt(1 - 4 * e * e)) / 2 : (1 + Math.sqrt(-3 + 8 * e - 4 * e * e)) / 2;
};
t.elasticIn = function (e, t) {
  if (0 === e) {
    return 0;
  }
  t /= t + 1;
  var i = (1 + t) * Math.log(e) / Math.log(t);
  return Math.cos(i) * Math.pow(t, i);
};
t.elasticOut = function (e, t) {
  if (1 === e) {
    return 1;
  }
  t /= t + 1;
  var i = (1 + t) * Math.log(1 - e) / Math.log(t);
  return 1 - Math.cos(i) * Math.pow(t, i);
};
t.elasticInOut = function (e, t) {
  var i;
  return e < .5 ? 0 === e ? 0 : (t /= t + 1, i = (1 + t) * Math.log(2 * e) / Math.log(t), .5 * Math.cos(i) * Math.pow(t, i)) : 1 === e ? 1 : (t /= t + 1, i = (1 + t) * Math.log(2 - 2 * e) / Math.log(t), .5 + .5 * (1 - Math.cos(i) * Math.pow(t, i)));
};
t.bounceIn = function (e, t) {
  if (0 === e) {
    return 0;
  }
  t /= t + 1;
  var i = (1 + t) * Math.log(e) / Math.log(t);
  return Math.abs(Math.cos(i) * Math.pow(t, i));
};
t.bounceOut = function (e, t) {
  if (1 === e) {
    return 1;
  }
  t /= t + 1;
  var i = (1 + t) * Math.log(1 - e) / Math.log(t);
  return 1 - Math.abs(Math.cos(i) * Math.pow(t, i));
};
t.bounceInOut = function (e, t) {
  var i;
  return e < .5 ? 0 === e ? 0 : (t /= t + 1, i = (1 + t) * Math.log(2 * e) / Math.log(t), Math.abs(.5 * Math.cos(i) * Math.pow(t, i))) : 1 === e ? 1 : (t /= t + 1, i = (1 + t) * Math.log(2 - 2 * e) / Math.log(t), .5 + .5 * (1 - Math.abs(Math.cos(i) * Math.pow(t, i))));
};
t.backIn = function (e, t) {
  return e * e * ((t + 1) * e - t);
};
t.backOut = function (e, t) {
  return e -= 1, e * e * ((t + 1) * e + t) + 1;
};
t.backInOut = function (e, t) {
  return e < .5 ? (e *= 2, .5 * (e * e * ((t + 1) * e - t))) : (e = 2 * e - 2, .5 * (e * e * ((t + 1) * e + t)) + 1);
};
e.exports = a;
a.prototype._addToCache = function (e, t) {
  void 0 === this._cache[e] && (this._cache[e] = t);
};
a.prototype._getFromCache = function (e) {
  return this._cache[e];
};
a.prototype._gatherStaticDataAndAddToCache = function (e, t) {
  function i(e, t, i) {
    e || a._addToCache(t, i);
    var n = a._processingCb[t];
    a._processingCb[t] = null;
    for (var o = 0; o < n.length; o += 1) {
      n[o](e, i);
    }
  }
  if (isNaN(e) || !e) {
    return t();
  }
  var o = this._getFromCache(e);
  if (null === o) {
    return t();
  }
  var a = this;
  return this._processingCb[e] ? void this._processingCb[e].push(t) : (this._processingCb[e] || (this._processingCb[e] = []), this._processingCb[e].push(t), void this._staticContent.getDataMap("SoundBones", [e], function (t, o) {
    if (t) {
      return i(t, e, null);
    }
    var r = o[e];
    if (!r) {
      return i(t, e, null);
    }
    if (!r.keys) {
      return n(a._logger, "No keys soundBonesData for bonesId: " + e), i(t, e, null);
    }
    if (!r.values) {
      return n(a._logger, "No values soundBonesData for bonesId: " + e), i(t, e, null);
    }
    var l = new s(e, r.keys, r.values);
    return i(t, e, l);
  }));
};
a.prototype.getAudio = function (e, t, i) {
  if (isNaN(e) || !e) {
    return i();
  }
  var n = this._getFromCache(e);
  if (n) {
    return o(this._audioManager, n, t, i);
  }
  var a = this;
  this._gatherStaticDataAndAddToCache(e, function (e, n) {
    return e ? i(e) : n ? o(a._audioManager, n, t, i) : i();
  });
};
this._id = e;
this._soundGroupDefs = {};
this._values = {};
this._values[s] || (this._values[s] = new a(this._id, s));
this._values[s].addSoundAnimation(u, new o(c));
n.prototype._processSoundGroupDefs = function () {
  this._soundGroupDefs = {};
  for (var e in this._values) {
    if (this._values.hasOwnProperty(e)) {
      var t = this._values[e],
        i = t.getSoundGroupDefs();
      for (var n in i) {
        i.hasOwnProperty(n) && (this._soundGroupDefs[n] = i[n]);
      }
    }
  }
};
n.prototype.getAnimNameAudio = function (e) {
  return this._values[e] || {};
};
n.prototype.getSoundGroupDefs = function (e) {
  if (!e) {
    return this._soundGroupDefs;
  }
  var t = {};
  for (var i in this._soundGroupDefs) {
    if (this._soundGroupDefs.hasOwnProperty(i)) {
      var n = this._soundGroupDefs[i];
      n.animName === e && (t[i] = n);
    }
  }
  return t;
};
e.exports = n;
this.id = e.id;
this.filename = e.filename;
this.name = e.name;
this.label = e.label;
this.startFrame = e.startFrame;
this.volume = e.volume;
this._bonesId = e;
this._animName = t;
this._availableFrames = {};
this._data = {};
this._cacheIds = {};
this.isSoundAnimationsPerFrame = !0;
i.prototype.addSoundAnimation = function (e, t) {
  this._availableFrames[e] = !0;
  this._data[e] || (this._data[e] = []);
  this._data[e].push(t);
};
i.prototype.getId = function (e, t) {
  return this._availableFrames[e] ? this._bonesId + "/" + this._animName + ":" + e + "_" + t : "";
};
i.prototype.getIds = function (e) {
  return this._availableFrames[e] ? this._cacheIds[e] ? this._cacheIds[e] : [this.getId(e, n)] : [""];
};
i.prototype.getSoundAnimation = function (e) {
  return this._data[e] || [];
};
i.prototype.hasSoundForFrame = function (e) {
  return this._data[e] && 0 !== this._data[e].length || !1;
};
i.prototype.getSoundGroupDefs = function () {
  var e = {};
  for (var t in this._data) {
    if (this._data.hasOwnProperty(t)) {
      for (var i = parseInt(t, 10), n = this.getSoundAnimation(i), o = {}, a = 0; a < n.length; a += 1) {
        var s = n[a],
          r = this.getId(i, s.label);
        e[r] = e[r] || {
          animName: this._animName,
          id: [],
          vol: []
        };
        e[r].id.push(s.filename);
        e[r].vol.push(s.volume);
        o[r] = !0;
      }
      this._cacheIds[i] = Object.keys(o);
    }
  }
  return e;
};
e.exports = i;
this._availableFrames[e] = !0;
this._data[e] || (this._data[e] = []);
this._data[e].push(t);
e[r] = e[r] || {
  animName: this._animName,
  id: [],
  vol: []
};
e[r].id.push(s.filename);
e[r].vol.push(s.volume);
o[r] = !0;
i(453);
i(457);
i(458);
i(459);
i(460);
i(461);
i(462);
e.exports = i(454);
d.blendFunc(d.ONE, d.ONE_MINUS_SRC_ALPHA);
d.enable(d.BLEND);
d.activeTexture(d.TEXTURE0);
this.resetClearColor();
this._vertexSize = u * m + h * f + p * g;
this._spriteSize = 6 * this._vertexSize;
this._lineSize = 2 * this._vertexSize;
this._boxSize = 6 * this._vertexSize;
this._initPrograms();
this.initBuffer(a);
this.sFMPartitioner = new s(this._spriteSize, a * this._spriteSize);
this._initTextureCache(r);
this._programs = [];
this.useProgram(this._programRegular);
this._renderTarget = this._createRenderTarget(null, _, 1, 1);
this._renderTargetStack = [this._renderTarget];
this._matrixStack = this._renderTarget.matrixStack;
this._width = 1;
this._height = 1;
this.resetDimension(t || 0, i || 0);
this._maxTextureSize = d.getParameter(d.MAX_TEXTURE_SIZE);
this.prerenderRatio = l;
this.maskQuality = .5;
this._drawModes = {
  lines: d.LINES,
  triangles: d.TRIANGLES
};
this.emptyTexture = this.createTexture(o.EMPTY_IMAGE, "empty_texture", "linear", "permanent");
e.exports = n;
n.prototype.resetClearColor = function () {
  this.gl.clearColor(0, 0, 0, 0);
};
n.prototype.setClearColor = function (e, t, i, n) {
  this.gl.clearColor(e, t, i, n);
};
n.prototype._initTextureCache = function (e) {
  function t(e) {
    i.deleteTexture(e.binder);
  }
  var i = this.gl;
  this.textureCache = new a(e, t);
};
n.prototype.resetDimension = function (e, t) {
  var i = this._width,
    n = this._height;
  this._width = e;
  this._height = t;
  this.gl.viewport(0, 0, e, t);
  var o = this._renderTargetStack[0];
  o.width = e;
  o.height = t;
  for (var a = i / this._width, s = n / this._height, r = o.matrixStack, l = 0; l < r.length; l += 1) {
    var c = r[l];
    c[0] *= a;
    c[1] *= a;
    c[2] = (c[2] + 1) * a - 1;
    c[4] *= s;
    c[5] *= s;
    c[6] = (c[6] - 1) * s + 1;
  }
};
n.prototype.getNbBytesPerSprite = function () {
  return this._spriteSize;
};
n.prototype.getNbBytesPerLine = function () {
  return this._lineSize;
};
n.prototype.getNbBytesPerBox = function () {
  return this._boxSize;
};
n.prototype.getNbBytesPerVertex = function () {
  return this._vertexSize;
};
n.prototype.enableBlending = function () {
  var e = this.gl;
  e.enable(e.BLEND);
};
n.prototype.disableBlending = function () {
  var e = this.gl;
  e.disable(e.BLEND);
};
n.prototype.drawImage = function (e, t, i, n, o) {
  if (e) {
    var a = this._matrixStack[0],
      s = a[0],
      r = a[4],
      l = a[1],
      c = a[5],
      d = a[2],
      u = a[6];
    a[2] += s * t + l * i;
    a[6] += r * t + c * i;
    a[0] *= n;
    a[4] *= n;
    a[1] *= o;
    a[5] *= o;
    this.gl.uniformMatrix4fv(this._currentProgram.uniforms.uMatrix, !1, a);
    var h = this.textureCache.useElement(e.id).element.binder;
    this.gl.bindTexture(this.gl.TEXTURE_2D, h);
    this.gl.drawArrays(this.gl.TRIANGLES, 0, 6);
    a[0] = s;
    a[4] = r;
    a[1] = l;
    a[5] = c;
    a[2] = d;
    a[6] = u;
  }
};
n.prototype.clear = function () {
  this.gl.clear(this.gl.COLOR_BUFFER_BIT);
};
n.isWebGlSupported = function () {
  if (null !== r) {
    return r;
  }
  var e = document.createElement("canvas");
  return r = !!n.getWebGlContext(e, !0);
};
n.getGPUInformation = function () {
  return l;
};
n.getWebGlContext = function (e, t, i) {
  var n = null;
  try {
    var o = {
      alpha: i,
      depth: !1,
      stencil: !1,
      antialias: !1
    };
    if (n = e.getContext("webgl", o) || e.getContext("experimental-webgl", o), !l) {
      l = {
        textureSize: n.getParameter(n.MAX_TEXTURE_SIZE),
        rendererBufferSize: n.getParameter(n.MAX_RENDERBUFFER_SIZE),
        vendor: n.getParameter(n.VENDOR),
        version: n.getParameter(n.VERSION)
      };
      var a = n.getExtension("WEBGL_debug_renderer_info");
      a && (l.unmaskedVendor = n.getParameter(a.UNMASKED_VENDOR_WEBGL), l.unmaskedRenderer = n.getParameter(a.UNMASKED_RENDERER_WEBGL));
    }
  } catch (s) {
    if (!t) {
      throw new Error("Could not initialise WebGL (" + s.message + ")");
    }
    return null;
  }
  if (!n) {
    if (!t) {
      throw new Error("Could not initialise WebGL, sorry :-(");
    }
    return null;
  }
  return n;
};
this._width = e;
this._height = t;
this.gl.viewport(0, 0, e, t);
o.width = e;
o.height = t;
c[0] *= a;
c[1] *= a;
c[2] = (c[2] + 1) * a - 1;
c[4] *= s;
c[5] *= s;
c[6] = (c[6] - 1) * s + 1;
a[2] += s * t + l * i;
a[6] += r * t + c * i;
a[0] *= n;
a[4] *= n;
a[1] *= o;
a[5] *= o;
this.gl.uniformMatrix4fv(this._currentProgram.uniforms.uMatrix, !1, a);
this.gl.bindTexture(this.gl.TEXTURE_2D, h);
this.gl.drawArrays(this.gl.TRIANGLES, 0, 6);
a[0] = s;
a[4] = r;
a[1] = l;
a[5] = c;
a[2] = d;
a[6] = u;
this.start = e;
this.nBytes = t;
this.update = 0;
this.prevChunk = null;
this.nextChunk = null;
this.id = null;
this.obj = null;
this.ref = null;
this.nLocks = 0;
this.memoryChunksFree = new a(function (e, t) {
  return e.nBytes - t.nBytes;
});
this.memoryChunksUsed = new s(function (e, t) {
  return e.update - t.update;
});
this.memoryChunksLocked = new s(function () {
  return 1;
});
o.ref = this.memoryChunksFree.add(o);
this.firstByte = e;
this.nBytes = i;
this.update = 0;
this.chunksById = {};
n.prototype.set = function (e, t, i) {
  this.start = e;
  this.nBytes = t;
  this.update = i;
};
e.exports = o;
o.prototype.touch = function (e) {
  var t = this.chunksById[e];
  if (void 0 !== t) {
    return 0 === t.nLocks && (t.update = this.update++, this.memoryChunksUsed.moveToTheEnd(t.ref)), t.obj;
  }
};
o.prototype.getChunk = function (e) {
  return this.chunksById[e];
};
o.prototype.addLock = function (e) {
  var t = this.chunksById[e];
  if (void 0 !== t) {
    return 0 === t.nLocks && (this.memoryChunksUsed.removeByRef(t.ref) || console.warn("[SuperFastMemoryPartitioner.lock] Trying to lock an already locked chunk", e), t.ref = this.memoryChunksLocked.add(t), t.update = 1 / 0), t.nLocks += 1, t.obj;
  }
};
o.prototype.removeLock = function (e) {
  var t = this.chunksById[e];
  void 0 !== t && (t.nLocks -= 1, 0 === t.nLocks && (this.memoryChunksLocked.removeByRef(t.ref), t.ref = this.memoryChunksUsed.add(t), t.update = this.update++), t.nLocks < 0 && console.warn("[SuperFastMemoryPartitioner.unlock] Trying to unlock a non-locked chunk", e));
};
o.prototype.possess = function (e) {
  return !!this.chunksById[e];
};
o.prototype.release = function (e) {
  var t = this.chunksById[e];
  if (void 0 !== t) {
    if (t.ref.container === this.memoryChunksLocked ? this.memoryChunksLocked.removeByRef(t.ref) : this.memoryChunksUsed.removeByRef(t.ref), t.prevChunk && t.prevChunk.ref.container === this.memoryChunksFree) {
      var i = t.prevChunk;
      t.start = i.start;
      t.nBytes += i.nBytes;
      t.prevChunk = i.prevChunk;
      i.prevChunk && (i.prevChunk.nextChunk = t);
      this.memoryChunksFree.removeByReference(i.ref);
    }
    if (t.nextChunk && t.nextChunk.ref.container === this.memoryChunksFree) {
      var n = t.nextChunk;
      t.nBytes += n.nBytes;
      t.nextChunk = n.nextChunk;
      n.nextChunk && (n.nextChunk.prevChunk = t);
      this.memoryChunksFree.removeByReference(n.ref);
    }
    t.ref = this.memoryChunksFree.add(t);
    t.nLocks = 0;
    t.update = 0;
    delete this.chunksById[e];
  }
};
o.prototype.bindObject = function (e, t) {
  var i = this.chunksById[e];
  return void 0 !== i && (i.obj = t, !0);
};
o.prototype._selectChunks = function (e) {
  var t = this.memoryChunksFree.getSmallestAbove({
    nBytes: e
  });
  if (t) {
    return [t];
  }
  if (0 === this.memoryChunksUsed.count) {
    throw new Error("No available chunk can hold " + e + " Bytes.Make sure that enough space is allocated (currently " + this.nBytes + ") or that locked chunks are correctly unlocked.");
  }
  var i = this.memoryChunksUsed.first;
  if (i.object.nBytes >= e) {
    return [i.object];
  }
  for (var n, o = 0, a = 7, s = 1 / 0; (o < a || s === 1 / 0) && null !== i;) {
    for (var r = i.object, l = [r], c = r.nBytes, d = r.prevChunk, u = r.nextChunk, h = r.update; c < e;) {
      null === d || null !== u && u.update <= d.update ? (h < u.update && (h = u.update), l.push(u), c += u.nBytes, u = u.nextChunk) : (h < d.update && (h = d.update), l.unshift(d), c += d.nBytes, d = d.prevChunk);
    }
    h < s && (s = h, n = l);
    i = i.next;
    o += 1;
  }
  if (s === 1 / 0) {
    throw new Error("No available chunk can hold " + e + " Bytes.Make sure that enough space is allocated (currently " + this.nBytes + ") or that locked chunks are correctly unlocked.");
  }
  return n;
};
o.prototype.reserve = function (e, t) {
  for (var i = this._selectChunks(t), o = 0; o < i.length; o += 1) {
    var a = i[o];
    a.ref.container === this.memoryChunksUsed ? (this.memoryChunksUsed.removeByRef(a.ref), delete this.chunksById[a.id]) : this.memoryChunksFree.removeByReference(a.ref);
  }
  var s = i[0],
    r = i[i.length - 1],
    l = s.start,
    c = r.start + r.nBytes;
  s.set(l, t, this.update);
  s.ref = this.memoryChunksUsed.add(s);
  s.id = e;
  this.chunksById[e] = s;
  var d = c - l;
  if (d === t) {
    s.nextChunk = r.nextChunk;
    null !== s.nextChunk && (s.nextChunk.prevChunk = s);
  } else {
    var u;
    if (s === r ? (u = new n(l + t, d - t), u.nextChunk = r.nextChunk, null !== u.nextChunk && (u.nextChunk.prevChunk = u)) : (u = r, u.set(l + t, d - t, 0)), u.prevChunk = s, s.nextChunk = u, u.nextChunk && u.nextChunk.ref.container === this.memoryChunksFree) {
      var h = u.nextChunk;
      u.nBytes += h.nBytes;
      u.nextChunk = h.nextChunk;
      h.nextChunk && (h.nextChunk.prevChunk = u);
      this.memoryChunksFree.removeByReference(h.ref);
    }
    u.ref = this.memoryChunksFree.add(u);
  }
  return this.update += 1, s;
};
o.prototype.debug = function () {
  console.log("***** SFMP *****");
  console.log(" FREE CHUNKS");
  this.memoryChunksFree.forEach(function (e) {
    console.log(e);
  });
  console.log(" USED CHUNKS");
  this.memoryChunksUsed.forEach(function (e) {
    console.log(e);
  });
  console.log(" LOCKED CHUNKS");
  this.memoryChunksLocked.forEach(function (e) {
    console.log(e);
  });
};
this.start = e;
this.nBytes = t;
this.update = i;
t.start = i.start;
t.nBytes += i.nBytes;
t.prevChunk = i.prevChunk;
i.prevChunk && (i.prevChunk.nextChunk = t);
this.memoryChunksFree.removeByReference(i.ref);
t.nBytes += n.nBytes;
t.nextChunk = n.nextChunk;
n.nextChunk && (n.nextChunk.prevChunk = t);
this.memoryChunksFree.removeByReference(n.ref);
t.ref = this.memoryChunksFree.add(t);
t.nLocks = 0;
t.update = 0;
delete this.chunksById[e];
h < s && (s = h, n = l);
i = i.next;
o += 1;
s.set(l, t, this.update);
s.ref = this.memoryChunksUsed.add(s);
s.id = e;
this.chunksById[e] = s;
s.nextChunk = r.nextChunk;
null !== s.nextChunk && (s.nextChunk.prevChunk = s);
u.nBytes += h.nBytes;
u.nextChunk = h.nextChunk;
h.nextChunk && (h.nextChunk.prevChunk = u);
this.memoryChunksFree.removeByReference(h.ref);
console.log("***** SFMP *****");
console.log(" FREE CHUNKS");
this.memoryChunksFree.forEach(function (e) {
  console.log(e);
});
console.log(" USED CHUNKS");
this.memoryChunksUsed.forEach(function (e) {
  console.log(e);
});
console.log(" LOCKED CHUNKS");
this.memoryChunksLocked.forEach(function (e) {
  console.log(e);
});
this.object = e;
this.height = 1;
this.left = null;
this.right = null;
this.parent = null;
this.container = t;
this.length = 0;
this.root = null;
this.cmpFunc = e;
n.prototype._addLeft = function (e, t) {
  e.parent = t;
  t.left = e;
};
n.prototype._addRight = function (e, t) {
  e.parent = t;
  t.right = e;
};
n.prototype.popSmallest = function () {
  for (var e = this.root; null !== e.left;) {
    e = e.left;
  }
  return this.removeByReference(e), e.object;
};
n.prototype.popGreatest = function () {
  for (var e = this.root; null !== e.right;) {
    e = e.right;
  }
  return this.removeByReference(e), e.object;
};
n.prototype.add = function (e) {
  this.length += 1;
  var t = new i(e, this);
  if (null === this.root) {
    return this.root = t, t;
  }
  for (var n = this.root;;) {
    var o = this.cmpFunc(e, n.object);
    if (o < 0) {
      if (null === n.left) {
        this._addLeft(t, n);
        break;
      }
      n = n.left;
    } else if (o > 0) {
      if (null === n.right) {
        this._addRight(t, n);
        break;
      }
      n = n.right;
    } else {
      if (null === n.left) {
        this._addLeft(t, n);
        break;
      }
      if (null === n.right) {
        this._addRight(t, n);
        break;
      }
      n = n.right.height < n.left.height ? n.right : n.left;
    }
  }
  return 1 === n.height && this._balance(t.parent, !1), t;
};
n.prototype._balanceLeftRight = function (e) {
  var t = e.left,
    i = t.right,
    n = t.left,
    o = i.left;
  i.left = t;
  e.left = i;
  i.parent = e;
  t.parent = i;
  t.left = n;
  t.right = o;
  var a = 0;
  null !== n && (a = n.height, n.parent = t);
  var s = 0;
  null !== o && (s = o.height, o.parent = t);
  var r = (a > s ? a : s) + 1;
  t.height = r;
  var l = null === i.right ? 0 : i.right.height;
  i.height = (r > l ? r : l) + 1;
};
n.prototype._balanceLeftLeft = function (e) {
  var t = e.left,
    i = t.right,
    n = e.parent;
  e === this.root ? this.root = t : n.right === e ? n.right = t : n.left = t;
  t.right = e;
  t.parent = n;
  e.parent = t;
  e.left = i;
  var o;
  null === i ? o = 0 : (i.parent = e, o = i.height);
  var a = null === e.right ? 0 : e.right.height;
  e.height = (o > a ? o : a) + 1;
};
n.prototype._balanceRightLeft = function (e) {
  var t = e.right,
    i = t.left,
    n = t.right,
    o = i.right;
  i.right = t;
  e.right = i;
  i.parent = e;
  t.parent = i;
  t.right = n;
  t.left = o;
  var a = 0;
  null !== n && (a = n.height, n.parent = t);
  var s = 0;
  null !== o && (s = o.height, o.parent = t);
  var r = (a > s ? a : s) + 1;
  t.height = r;
  var l = null === i.left ? 0 : i.left.height;
  i.height = (l > r ? l : r) + 1;
};
n.prototype._balanceRightRight = function (e) {
  var t = e.right,
    i = t.left;
  e === this.root ? this.root = t : e.parent.left === e ? e.parent.left = t : e.parent.right = t;
  t.left = e;
  t.parent = e.parent;
  e.parent = t;
  e.right = i;
  var n;
  null === i ? n = 0 : (i.parent = e, n = i.height);
  var o = null === e.left ? 0 : e.left.height;
  e.height = (o > n ? o : n) + 1;
};
n.prototype._balance = function (e, t) {
  for (var i = e; null !== i;) {
    var n = i.left,
      o = i.right,
      a = null === n ? 0 : n.height,
      s = null === o ? 0 : o.height;
    if (a - s > 1) {
      null !== n.right && (null === n.left || n.left.height < n.right.height) && this._balanceLeftRight(i);
      this._balanceLeftLeft(i);
    } else if (s - a > 1) {
      null !== o.left && (null === o.right || o.right.height < o.left.height) && this._balanceRightLeft(i);
      this._balanceRightRight(i);
    } else {
      var r = (a > s ? a : s) + 1;
      if (!t && r === i.height) {
        break;
      }
      i.height = r;
    }
    i = i.parent;
  }
};
n.prototype.removeByReference = function (e) {
  if (e.container !== this) {
    return e;
  }
  this.length -= 1;
  var t = e.parent,
    i = e.left,
    n = e.right;
  if (null === e.right) {
    return null !== i && (i.parent = t), null === t ? this.root = i : (t.right === e ? t.right = i : t.left = i, null === i ? this._balance(t, !0) : i.height + 3 <= t.height && this._balance(t, !0)), !0;
  }
  var o = e.right;
  if (null === o.left) {
    return null !== i && (i.parent = o), o.left = i, null === t ? this.root = o : t.right === e ? t.right = o : t.left = o, o.parent = t, this._balance(o, !0), !0;
  }
  for (o = o.left; null !== o.left;) {
    o = o.left;
  }
  null !== o.right && (o.right.parent = o.parent);
  o.parent.left = o.right;
  null !== n && (n.parent = o);
  o.right = n;
  null !== i && (i.parent = o);
  o.left = i;
  null === t ? this.root = o : t.right === e ? t.right = o : t.left = o;
  var a = o.parent;
  return o.parent = t, this._balance(a, !0), e.left = null, e.right = null, e.parent = null, e.container = null, null;
};
n.prototype.getSmallestAbove = function (e) {
  if (null === this.root) {
    return null;
  }
  for (var t = null, i = this.root; null !== i;) {
    var n = this.cmpFunc(e, i.object);
    if (n < 0) {
      t = i.object;
      i = i.left;
    } else {
      if (!(n > 0)) {
        return i.object;
      }
      i = i.right;
    }
  }
  return t;
};
n.prototype.getGreatestBelow = function (e) {
  if (null === this.root) {
    return null;
  }
  for (var t = null, i = this.root; null !== i;) {
    var n = this.cmpFunc(e, i.object);
    if (n < 0) {
      i = i.left;
    } else {
      if (!(n > 0)) {
        return i.object;
      }
      t = i.object;
      i = i.right;
    }
  }
  return t;
};
n.prototype._forEach = function (e, t, i) {
  null !== e && (this._forEach(e.left, t, i), t(e.object, i), this._forEach(e.right, t, i));
};
n.prototype.forEach = function (e, t) {
  this._forEach(this.root, e, t);
};
n.prototype._forEachReverse = function (e, t, i) {
  null !== e && (this._forEachReverse(e.right, t, i), t(e.object, i), this._forEachReverse(e.left, t, i));
};
n.prototype.forEachReverse = function (e, t) {
  this._forEachReverse(this.root, e, t);
};
n.prototype.clear = function () {
  this._clearEachNode(this.root);
  this.length = 0;
  this.root = null;
};
n.prototype._clearEachNode = function (e) {
  null !== e && (this._clearEachNode(e.left), this._clearEachNode(e.right), e.left = null, e.right = null, e.parent = null, e.container = null);
};
n.prototype._toArray = function (e, t) {
  null !== e && (this._toArray(e.left, t), t.push(e.object), this._toArray(e.right, t));
};
n.prototype.toArray = function () {
  var e = [];
  return this._toArray(this.root, e), e;
};
e.exports = n;
e.parent = t;
t.left = e;
e.parent = t;
t.right = e;
i.left = t;
e.left = i;
i.parent = e;
t.parent = i;
t.left = n;
t.right = o;
e === this.root ? this.root = t : n.right === e ? n.right = t : n.left = t;
t.right = e;
t.parent = n;
e.parent = t;
e.left = i;
i.right = t;
e.right = i;
i.parent = e;
t.parent = i;
t.right = n;
t.left = o;
e === this.root ? this.root = t : e.parent.left === e ? e.parent.left = t : e.parent.right = t;
t.left = e;
t.parent = e.parent;
e.parent = t;
e.right = i;
null !== n.right && (null === n.left || n.left.height < n.right.height) && this._balanceLeftRight(i);
this._balanceLeftLeft(i);
null !== o.left && (null === o.right || o.right.height < o.left.height) && this._balanceRightLeft(i);
this._balanceRightRight(i);
null !== o.right && (o.right.parent = o.parent);
o.parent.left = o.right;
null !== n && (n.parent = o);
o.right = n;
null !== i && (i.parent = o);
o.left = i;
null === t ? this.root = o : t.right === e ? t.right = o : t.left = o;
t = i.object;
i = i.left;
t = i.object;
i = i.right;
this._clearEachNode(this.root);
this.length = 0;
this.root = null;
this.program = e;
this.data = t || null;
this.binder = null;
this.vertexShaderId = t;
this.fragmentShaderId = i;
this.uniformIds = n;
this.attributeIds = o;
this.uniforms = {};
this.attributes = {};
this.lastAttributeIndex = o.length - 1;
this.vertexSize = e._vertexSize;
this.gl = e.gl;
o.prototype.setAttributes = function () {
  var e = 4,
    t = 2,
    i = 1;
  this.gl.vertexAttribPointer(this.attributes.aPosition, 2, this.gl.FLOAT, !1, this.vertexSize, 0);
  this.gl.vertexAttribPointer(this.attributes.aColorMul, 4, this.gl.BYTE, !0, this.vertexSize, 2 * e + 2 * t);
  this.gl.vertexAttribPointer(this.attributes.aColorAdd, 4, this.gl.BYTE, !0, this.vertexSize, 2 * e + 2 * t + 4 * i);
};
a.prototype.setAttributes = function () {
  var e = 4,
    t = 2,
    i = 1;
  this.gl.vertexAttribPointer(this.attributes.aPosition, 2, this.gl.FLOAT, !1, this.vertexSize, 0);
  this.gl.vertexAttribPointer(this.attributes.aTexCoord, 2, this.gl.UNSIGNED_SHORT, !0, this.vertexSize, 2 * e);
  this.gl.vertexAttribPointer(this.attributes.aColorMul, 4, this.gl.BYTE, !0, this.vertexSize, 2 * e + 2 * t);
  this.gl.vertexAttribPointer(this.attributes.aColorAdd, 4, this.gl.BYTE, !0, this.vertexSize, 2 * e + 2 * t + 4 * i);
};
s.prototype._initPrograms = function () {
  this._shaders = {};
  var e = ["uMatrix"],
    t = ["uMatrix"],
    i = ["uMatrix", "uTexture"],
    n = ["uMatrix", "uTexture", "uRatio"],
    s = ["uMatrix", "uTexture", "uMask", "uBbox"],
    r = ["aPosition", "aColorMul", "aColorAdd"];
  this._programLine = new o(this, "vertexLine", "fragmentLine", e, r);
  this._programBox = new o(this, "vertexBox", "fragmentBox", t, r);
  var l = ["aPosition", "aTexCoord", "aColorMul", "aColorAdd"];
  this._programMask = new a(this, "vertexMask", "fragmentMask", s, l);
  this._programAbsoluteScale = new a(this, "vertexAbsoluteScale", "fragmentRegular", i, l);
  this._programPixelArt = new a(this, "vertexRegular", "fragmentPixelArt", n, l);
  this._programFiltering = new a(this, "vertexRegular", "fragmentFiltering", n, l);
  this._programMapTransition = new a(this, "vertexRegular", "fragmentMapTransition", n, l);
  this._programRegular = new a(this, "vertexRegular", "fragmentRegular", i, l);
  this._currentProgram = {
    lastAttributeIndex: -1
  };
};
s.prototype._getShader = function (e) {
  if (this._shaders[e]) {
    return this._shaders[e];
  }
  var t,
    i = this.gl,
    n = s.shadersData[e];
  if ("fragment" === n.type) {
    t = i.createShader(i.FRAGMENT_SHADER);
  } else {
    if ("vertex" !== n.type) {
      return null;
    }
    t = i.createShader(i.VERTEX_SHADER);
  }
  if (i.shaderSource(t, n.script), i.compileShader(t), !i.getShaderParameter(t, i.COMPILE_STATUS)) {
    throw new Error(i.getShaderInfoLog(t));
  }
  return this._shaders[e] = t, t;
};
s.prototype._buildProgram = function (e) {
  var t = this.gl,
    i = t.createProgram();
  if (t.attachShader(i, this._getShader(e.vertexShaderId)), t.attachShader(i, this._getShader(e.fragmentShaderId)), t.linkProgram(i), !t.getProgramParameter(i, t.LINK_STATUS)) {
    var n = t.getProgramInfoLog(i);
    throw t.deleteProgram(i), new Error("Error linking the program:" + n);
  }
  t.useProgram(i);
  for (var o = e.attributeIds, a = e.attributes, s = 0; s < o.length; s += 1) {
    var l = o[s];
    a[l] = t.getAttribLocation(i, l);
  }
  for (var c = e.uniformIds, d = e.uniforms, u = 0; u < c.length; u += 1) {
    var h = c[u],
      p = t.getUniformLocation(i, h);
    r[h] && t.uniform1i(p, r[h]);
    d[h] = p;
  }
  e.binder = i;
};
s.prototype._useProgram = function (e) {
  var t = e.program;
  if (t !== this._currentProgram) {
    var i,
      n = this._currentProgram.lastAttributeIndex,
      o = t.lastAttributeIndex;
    if (n > o) {
      for (i = n; i > o; i -= 1) {
        this.gl.disableVertexAttribArray(i);
      }
    } else if (n < o) {
      for (i = n + 1; i <= o; i += 1) {
        this.gl.enableVertexAttribArray(i);
      }
    }
    var a = t.binder;
    null === a ? this._buildProgram(t) : this.gl.useProgram(t.binder);
    t.setAttributes();
    this._currentProgram = t;
  }
  var s = e.data;
  if (null !== s) {
    var r = this.gl;
    void 0 !== s.mask && (r.activeTexture(r.TEXTURE1), r.bindTexture(r.TEXTURE_2D, s.mask), r.activeTexture(r.TEXTURE0));
    void 0 !== s.ratio && r.uniform1f(this._currentProgram.uniforms.uRatio, s.ratio);
    void 0 !== s.resolution && r.uniform1f(this._currentProgram.uniforms.uResolution, s.resolution);
  }
};
s.prototype.useProgram = function (e, t) {
  var i = new n(e, t);
  this._programs.push(i);
  this._useProgram(i);
};
s.prototype.stopProgram = function () {
  this._programs.pop();
  this._useProgram(this._programs[this._programs.length - 1]);
};
this.gl.vertexAttribPointer(this.attributes.aPosition, 2, this.gl.FLOAT, !1, this.vertexSize, 0);
this.gl.vertexAttribPointer(this.attributes.aColorMul, 4, this.gl.BYTE, !0, this.vertexSize, 2 * e + 2 * t);
this.gl.vertexAttribPointer(this.attributes.aColorAdd, 4, this.gl.BYTE, !0, this.vertexSize, 2 * e + 2 * t + 4 * i);
this.gl.vertexAttribPointer(this.attributes.aPosition, 2, this.gl.FLOAT, !1, this.vertexSize, 0);
this.gl.vertexAttribPointer(this.attributes.aTexCoord, 2, this.gl.UNSIGNED_SHORT, !0, this.vertexSize, 2 * e);
this.gl.vertexAttribPointer(this.attributes.aColorMul, 4, this.gl.BYTE, !0, this.vertexSize, 2 * e + 2 * t);
this.gl.vertexAttribPointer(this.attributes.aColorAdd, 4, this.gl.BYTE, !0, this.vertexSize, 2 * e + 2 * t + 4 * i);
this._programLine = new o(this, "vertexLine", "fragmentLine", e, r);
this._programBox = new o(this, "vertexBox", "fragmentBox", t, r);
this._programMask = new a(this, "vertexMask", "fragmentMask", s, l);
this._programAbsoluteScale = new a(this, "vertexAbsoluteScale", "fragmentRegular", i, l);
this._programPixelArt = new a(this, "vertexRegular", "fragmentPixelArt", n, l);
this._programFiltering = new a(this, "vertexRegular", "fragmentFiltering", n, l);
this._programMapTransition = new a(this, "vertexRegular", "fragmentMapTransition", n, l);
this._programRegular = new a(this, "vertexRegular", "fragmentRegular", i, l);
this._currentProgram = {
  lastAttributeIndex: -1
};
r[h] && t.uniform1i(p, r[h]);
d[h] = p;
null === a ? this._buildProgram(t) : this.gl.useProgram(t.binder);
t.setAttributes();
this._currentProgram = t;
void 0 !== s.mask && (r.activeTexture(r.TEXTURE1), r.bindTexture(r.TEXTURE_2D, s.mask), r.activeTexture(r.TEXTURE0));
void 0 !== s.ratio && r.uniform1f(this._currentProgram.uniforms.uRatio, s.ratio);
void 0 !== s.resolution && r.uniform1f(this._currentProgram.uniforms.uResolution, s.resolution);
this._programs.push(i);
this._useProgram(i);
this._programs.pop();
this._useProgram(this._programs[this._programs.length - 1]);
this.textureBinder = e;
this.frameBufferBinder = t;
this.width = i;
this.height = n;
this.matrixStack = [[2, 0, -1, 0, 0, -2, 1, 0, 1, 1, 1, 1, 0, 0, 0, 0]];
this.scissor = null;
this.texture = null;
o.prototype._createRenderTarget = function (e, t, i, o) {
  return new n(e, t, i, o);
};
o.prototype._setScissor = function (e) {
  var t = this.gl;
  null === e ? t.disable(t.SCISSOR_TEST) : (t.enable(t.SCISSOR_TEST), t.scissor(e[0], e[1], e[2], e[3]));
};
o.prototype.enableScissor = function (e, t, i, n) {
  var o = [e, t, i, n];
  this._renderTarget.scissor = o;
  this._setScissor(o);
};
o.prototype.disableScissor = function () {
  var e = null;
  this._renderTarget.scissor = e;
  this._setScissor(e);
};
o.prototype.startTextureUsage = function (e, t, i, o, a) {
  var s = this.gl;
  i = i || this.prerenderRatio;
  e * i > this._maxTextureSize && (i = this._maxTextureSize / e);
  t * i > this._maxTextureSize && (i = this._maxTextureSize / t);
  e = Math.ceil(e * i);
  t = Math.ceil(t * i);
  var r = s.createTexture(),
    l = s.createFramebuffer(),
    c = new n(r, l, e, t);
  s.bindTexture(s.TEXTURE_2D, r);
  s.texImage2D(s.TEXTURE_2D, 0, s.RGBA, e, t, 0, s.RGBA, s.UNSIGNED_BYTE, null);
  this._setFiltering(c, a);
  s.bindFramebuffer(s.FRAMEBUFFER, l);
  s.framebufferTexture2D(s.FRAMEBUFFER, s.COLOR_ATTACHMENT0, s.TEXTURE_2D, r, 0);
  s.bindFramebuffer(s.FRAMEBUFFER, this._renderTarget.frameBufferBinder);
  var d = {
    binder: r,
    width: e,
    height: t
  };
  return c.texture = this.textureCache.addAndHoldElement(d, 4 * e * t, o), c;
};
o.prototype._setRenderTarget = function (e, t) {
  var i = this.gl;
  this._renderTarget = e;
  i.bindFramebuffer(i.FRAMEBUFFER, e.frameBufferBinder);
  i.viewport(0, 0, e.width, e.height);
  this._setScissor(e.scissor);
  t && i.clear(i.COLOR_BUFFER_BIT);
  this._matrixStack = e.matrixStack;
};
o.prototype.startTextureRendering = function (e, t, i, n, o, a) {
  this._renderTargetStack.push(e);
  this._setRenderTarget(e, a);
  var s = 2 / Math.max(i - t, 1),
    r = 2 / Math.max(o - n, 1),
    l = this._matrixStack[0];
  l[0] = s;
  l[4] = 0;
  l[1] = 0;
  l[5] = r;
  l[2] = -t * s - 1;
  l[6] = -n * r - 1;
  l[8] = 1;
  l[9] = 1;
  l[10] = 1;
  l[11] = 1;
  l[12] = 0;
  l[13] = 0;
  l[14] = 0;
  l[15] = 0;
};
o.prototype.stopTextureRendering = function (e) {
  var t = this._renderTargetStack.pop();
  this._setRenderTarget(this._renderTargetStack[this._renderTargetStack.length - 1]);
  e && this.gl.deleteFramebuffer(t.frameBufferBinder);
};
o.prototype._debugRenderTarget = function () {
  var e = this._renderTargetStack[this._renderTargetStack.length - 1],
    t = e.width,
    i = e.height,
    n = this.gl,
    o = new window.Uint8Array(t * i * 4);
  n.readPixels(0, 0, t, i, n.RGBA, n.UNSIGNED_BYTE, o);
  var a = o.length,
    s = document.createElement("canvas"),
    r = s.getContext("2d");
  s.width = t;
  s.height = i;
  document.body.appendChild(s);
  s.style.position = "absolute";
  s.style.left = "100px";
  s.style.top = "100px";
  for (var l = r.getImageData(0, 0, t, i), c = l.data, d = 3; d < a; d += 4) {
    c[d - 3] = o[d - 3];
    c[d - 2] = o[d - 2];
    c[d - 1] = o[d - 1];
    c[d] = o[d];
  }
  r.putImageData(l, 0, 0);
  r.fillRect(t / 2 - 5, i / 2 - 5, 10, 10);
};
this._renderTarget.scissor = o;
this._setScissor(o);
this._renderTarget.scissor = e;
this._setScissor(e);
i = i || this.prerenderRatio;
e * i > this._maxTextureSize && (i = this._maxTextureSize / e);
t * i > this._maxTextureSize && (i = this._maxTextureSize / t);
e = Math.ceil(e * i);
t = Math.ceil(t * i);
s.bindTexture(s.TEXTURE_2D, r);
s.texImage2D(s.TEXTURE_2D, 0, s.RGBA, e, t, 0, s.RGBA, s.UNSIGNED_BYTE, null);
this._setFiltering(c, a);
s.bindFramebuffer(s.FRAMEBUFFER, l);
s.framebufferTexture2D(s.FRAMEBUFFER, s.COLOR_ATTACHMENT0, s.TEXTURE_2D, r, 0);
s.bindFramebuffer(s.FRAMEBUFFER, this._renderTarget.frameBufferBinder);
this._renderTarget = e;
i.bindFramebuffer(i.FRAMEBUFFER, e.frameBufferBinder);
i.viewport(0, 0, e.width, e.height);
this._setScissor(e.scissor);
t && i.clear(i.COLOR_BUFFER_BIT);
this._matrixStack = e.matrixStack;
this._renderTargetStack.push(e);
this._setRenderTarget(e, a);
l[0] = s;
l[4] = 0;
l[1] = 0;
l[5] = r;
l[2] = -t * s - 1;
l[6] = -n * r - 1;
l[8] = 1;
l[9] = 1;
l[10] = 1;
l[11] = 1;
l[12] = 0;
l[13] = 0;
l[14] = 0;
l[15] = 0;
this._setRenderTarget(this._renderTargetStack[this._renderTargetStack.length - 1]);
e && this.gl.deleteFramebuffer(t.frameBufferBinder);
s.width = t;
s.height = i;
document.body.appendChild(s);
s.style.position = "absolute";
s.style.left = "100px";
s.style.top = "100px";
c[d - 3] = o[d - 3];
c[d - 2] = o[d - 2];
c[d - 1] = o[d - 1];
c[d] = o[d];
r.putImageData(l, 0, 0);
r.fillRect(t / 2 - 5, i / 2 - 5, 10, 10);
n.prototype.initBuffer = function (e) {
  var t = this.gl,
    i = t.createBuffer();
  t.bindBuffer(t.ARRAY_BUFFER, i);
  var n = new window.ArrayBuffer(e * this._spriteSize),
    o = new window.Float32Array(n),
    a = new window.Uint32Array(n);
  o[0] = 0;
  o[1] = 0;
  a[2] = 0;
  o[5] = 0;
  o[6] = 1;
  a[7] = 4294901760;
  o[10] = 1;
  o[11] = 1;
  a[12] = 4294967295;
  o[15] = 0;
  o[16] = 0;
  a[17] = 0;
  o[20] = 1;
  o[21] = 1;
  a[22] = 4294967295;
  o[25] = 1;
  o[26] = 0;
  a[27] = 65535;
  a[3] = a[8] = a[13] = a[18] = a[23] = a[28] = 1077952576;
  a[4] = a[9] = a[14] = a[19] = a[24] = a[29] = 0;
  t.bufferData(t.ARRAY_BUFFER, n, t.STATIC_DRAW);
};
n.prototype.updateGPUBuffer = function (e, t) {
  var i = this.gl;
  i.bufferSubData(i.ARRAY_BUFFER, e, t);
};
n.prototype.isInBuffer = function (e) {
  return this.sFMPartitioner.possess(e);
};
n.prototype.getBufferData = function (e) {
  return this.sFMPartitioner.touch(e);
};
n.prototype.lockBuffer = function (e) {
  return this.sFMPartitioner.addLock(e);
};
n.prototype.releaseBuffer = function (e) {
  return this.sFMPartitioner.release(e);
};
n.prototype.unlockBuffer = function (e) {
  this.sFMPartitioner.removeLock(e);
};
o[0] = 0;
o[1] = 0;
a[2] = 0;
o[5] = 0;
o[6] = 1;
a[7] = 4294901760;
o[10] = 1;
o[11] = 1;
a[12] = 4294967295;
o[15] = 0;
o[16] = 0;
a[17] = 0;
o[20] = 1;
o[21] = 1;
a[22] = 4294967295;
o[25] = 1;
o[26] = 0;
a[27] = 65535;
a[3] = a[8] = a[13] = a[18] = a[23] = a[28] = 1077952576;
a[4] = a[9] = a[14] = a[19] = a[24] = a[29] = 0;
t.bufferData(t.ARRAY_BUFFER, n, t.STATIC_DRAW);
o.prototype._setFiltering = function (e, t, i) {
  var o = this.gl,
    a = o.LINEAR,
    s = o.LINEAR;
  switch (t) {
    case "nearest":
      s = o.NEAREST;
      break;
    case "mipmap":
      n(e.width) && n(e.height) ? (a = o.LINEAR_MIPMAP_LINEAR, o.generateMipmap(o.TEXTURE_2D)) : console.warn("[WebGLRenderer._setFiltering]", "Cannot build mipmap from image", i, " because its dimensions are not a power of 2.");
  }
  o.texParameteri(o.TEXTURE_2D, o.TEXTURE_MIN_FILTER, a);
  o.texParameteri(o.TEXTURE_2D, o.TEXTURE_MAG_FILTER, s);
  o.texParameteri(o.TEXTURE_2D, o.TEXTURE_WRAP_S, o.CLAMP_TO_EDGE);
  o.texParameteri(o.TEXTURE_2D, o.TEXTURE_WRAP_T, o.CLAMP_TO_EDGE);
};
o.prototype.holdTexture = function (e) {
  return this.textureCache.holdElement(e);
};
o.prototype.useTexture = function (e) {
  return this.textureCache.useElement(e);
};
o.prototype.createTexture = function (e, t, i, n) {
  var o = this.textureCache.holdElement(t);
  if (o) {
    return o;
  }
  var a = this.gl,
    s = a.createTexture();
  a.bindTexture(a.TEXTURE_2D, s);
  a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL, !0);
  a.texImage2D(a.TEXTURE_2D, 0, a.RGBA, a.RGBA, a.UNSIGNED_BYTE, e);
  this._setFiltering(e, i, t);
  var r = {
    binder: s,
    width: e.width,
    height: e.height
  };
  return this.textureCache.addAndHoldElement(r, 4 * e.width * e.height, t, n);
};
o.prototype.getEmptyTexture = function () {
  return this.emptyTexture;
};
o.texParameteri(o.TEXTURE_2D, o.TEXTURE_MIN_FILTER, a);
o.texParameteri(o.TEXTURE_2D, o.TEXTURE_MAG_FILTER, s);
o.texParameteri(o.TEXTURE_2D, o.TEXTURE_WRAP_S, o.CLAMP_TO_EDGE);
o.texParameteri(o.TEXTURE_2D, o.TEXTURE_WRAP_T, o.CLAMP_TO_EDGE);
a.bindTexture(a.TEXTURE_2D, s);
a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL, !0);
a.texImage2D(a.TEXTURE_2D, 0, a.RGBA, a.RGBA, a.UNSIGNED_BYTE, e);
this._setFiltering(e, i, t);
n.prototype.save = function () {
  this._matrixStack.unshift(this._matrixStack[0].slice());
};
n.prototype.restore = function () {
  this._matrixStack.shift();
};
n.prototype.setTransform = function (e, t, i, n, o, a, s, r) {
  var l = this._matrixStack[0];
  s = 2 / (s || this._width);
  r = -2 / (r || this._height);
  l[0] = e * s;
  l[4] = t * r;
  l[1] = i * s;
  l[5] = n * r;
  l[2] = o * s - 1;
  l[6] = a * r + 1;
};
n.prototype.rotate = function (e) {
  if (0 !== e) {
    var t = this._matrixStack[0],
      i = Math.cos(e),
      n = Math.sin(e),
      o = t[0],
      a = t[4],
      s = t[1],
      r = t[5];
    t[0] = o * i + s * n;
    t[4] = a * i + r * n;
    t[1] = s * i - o * n;
    t[5] = r * i - a * n;
  }
};
n.prototype.translate = function (e, t) {
  var i = this._matrixStack[0];
  i[2] += i[0] * e + i[1] * t;
  i[6] += i[4] * e + i[5] * t;
};
n.prototype.scale = function (e, t) {
  var i = this._matrixStack[0];
  i[0] *= e;
  i[4] *= e;
  i[1] *= t;
  i[5] *= t;
};
n.prototype.transform = function (e, t, i, n, o, a) {
  var s = this._matrixStack[0],
    r = s[0],
    l = s[4],
    c = s[1],
    d = s[5],
    u = s[2],
    h = s[6];
  s[0] = r * e + c * t;
  s[4] = l * e + d * t;
  s[1] = r * i + c * n;
  s[5] = l * i + d * n;
  s[2] = r * o + c * a + u;
  s[6] = l * o + d * a + h;
};
n.prototype.getTransform = function () {
  var e = this._matrixStack[0];
  return [e[0], e[4], e[1], e[5], e[2], e[6]];
};
n.prototype.setTint = function (e, t, i, n, o, a, s, r) {
  var l = this._matrixStack[0];
  l[8] = e;
  l[9] = t;
  l[10] = i;
  l[11] = n;
  l[12] = o / 255;
  l[13] = a / 255;
  l[14] = s / 255;
  l[15] = r / 255;
};
n.prototype.tint = function (e, t, i, n, o, a, s, r) {
  var l = this._matrixStack[0],
    c = l[8],
    d = l[9],
    u = l[10],
    h = l[11];
  l[8] = e * c;
  l[9] = t * d;
  l[10] = i * u;
  l[11] = n * h;
  l[12] = o / 255 + l[12] * e;
  l[13] = a / 255 + l[13] * t;
  l[14] = s / 255 + l[14] * i;
  l[15] = r / 255 + l[15] * n;
};
n.prototype.setTintMult = function (e, t, i, n) {
  var o = this._matrixStack[0];
  o[8] = e;
  o[9] = t;
  o[10] = i;
  o[11] = n;
};
n.prototype.setTintAdd = function (e, t, i, n) {
  var o = this._matrixStack[0];
  o[12] = e / 255;
  o[13] = t / 255;
  o[14] = i / 255;
  o[15] = n / 255;
};
n.prototype.multiplyColor = function (e, t, i, n) {
  var o = this._matrixStack[0];
  o[8] *= e;
  o[9] *= t;
  o[10] *= i;
  o[11] *= n;
};
n.prototype.addColor = function (e, t, i, n) {
  var o = this._matrixStack[0];
  o[12] += e * o[8] / 255;
  o[13] += t * o[9] / 255;
  o[14] += i * o[10] / 255;
  o[15] += n * o[11] / 255;
};
s = 2 / (s || this._width);
r = -2 / (r || this._height);
l[0] = e * s;
l[4] = t * r;
l[1] = i * s;
l[5] = n * r;
l[2] = o * s - 1;
l[6] = a * r + 1;
t[0] = o * i + s * n;
t[4] = a * i + r * n;
t[1] = s * i - o * n;
t[5] = r * i - a * n;
i[2] += i[0] * e + i[1] * t;
i[6] += i[4] * e + i[5] * t;
i[0] *= e;
i[4] *= e;
i[1] *= t;
i[5] *= t;
s[0] = r * e + c * t;
s[4] = l * e + d * t;
s[1] = r * i + c * n;
s[5] = l * i + d * n;
s[2] = r * o + c * a + u;
s[6] = l * o + d * a + h;
l[8] = e;
l[9] = t;
l[10] = i;
l[11] = n;
l[12] = o / 255;
l[13] = a / 255;
l[14] = s / 255;
l[15] = r / 255;
l[8] = e * c;
l[9] = t * d;
l[10] = i * u;
l[11] = n * h;
l[12] = o / 255 + l[12] * e;
l[13] = a / 255 + l[13] * t;
l[14] = s / 255 + l[14] * i;
l[15] = r / 255 + l[15] * n;
o[8] = e;
o[9] = t;
o[10] = i;
o[11] = n;
o[12] = e / 255;
o[13] = t / 255;
o[14] = i / 255;
o[15] = n / 255;
o[8] *= e;
o[9] *= t;
o[10] *= i;
o[11] *= n;
o[12] += e * o[8] / 255;
o[13] += t * o[9] / 255;
o[14] += i * o[10] / 255;
o[15] += n * o[11] / 255;
e[i + 0] = o[0];
e[i + 1] = o[1];
t[i + 2] = (65535 * a[0] & 65535) + (4294901760 * a[1] & 4294901760);
e[i + 5] = o[4];
e[i + 6] = o[5];
t[i + 7] = (65535 * a[0] & 65535) + (4294901760 * a[3] & 4294901760);
e[i + 10] = o[6];
e[i + 11] = o[7];
t[i + 12] = (65535 * a[2] & 65535) + (4294901760 * a[3] & 4294901760);
e[i + 15] = o[0];
e[i + 16] = o[1];
t[i + 17] = (65535 * a[0] & 65535) + (4294901760 * a[1] & 4294901760);
e[i + 20] = o[6];
e[i + 21] = o[7];
t[i + 22] = (65535 * a[2] & 65535) + (4294901760 * a[3] & 4294901760);
e[i + 25] = o[2];
e[i + 26] = o[3];
t[i + 27] = (65535 * a[2] & 65535) + (4294901760 * a[1] & 4294901760);
t[i + 3] = t[i + 8] = t[i + 13] = f;
t[i + 18] = t[i + 23] = t[i + 28] = f;
t[i + 4] = t[i + 9] = t[i + 14] = g;
t[i + 19] = t[i + 24] = t[i + 29] = g;
this.nBytes = t;
this.drawMode = i;
this.texture = n || null;
this.startingByte = e;
this.bbox = t;
this.prerender = i;
this.spriteBatches = e;
s.prototype.prepareBatchFromSpriteList = function (e, t, i) {
  i = !!i;
  for (var s = t.spriteBatch, r = s.length - 1, l = t.nbSprites * this._spriteSize, c = this.sFMPartitioner.reserve(e, l), d = c.start, u = d, h = d, p = new window.ArrayBuffer(l), m = new window.Float32Array(p), f = new window.Uint32Array(p), g = this._spriteSize / 4, _ = 0, v = [], y = 0; y <= r; y += 1) {
    var w = s[y];
    if (w.isMaskTag) {
      i = !0;
      v.push(w);
    } else {
      n(m, f, _ * g, w);
      h += this._spriteSize;
      _ += 1;
      var b = s[y + 1];
      (y === r || w.texture !== b.texture || b.isMaskTag) && (v.push(new o(u, h - u, this._drawModes.triangles, w.texture)), u = h);
    }
  }
  this.updateGPUBuffer(d, m);
  c.obj = new a(v, t.bbox, i);
};
s.prototype.loadSpriteBuffer = function (e, t, i, n, o) {
  this._loadVertexBuffer(e, t, i, n, this._drawModes.triangles, o);
};
s.prototype.loadLineBuffer = function (e, t, i, n) {
  this._loadVertexBuffer(e, t, null, i, this._drawModes.lines, n);
};
s.prototype._loadVertexBuffer = function (e, t, i, n, s, r) {
  var l = t.byteLength,
    c = this.sFMPartitioner.reserve(e, l),
    d = c.start,
    u = new o(d, l, s, i);
  c.obj = new a([u], n, r);
  this.updateGPUBuffer(d, t);
};
s.prototype.updateVertexBuffer = function (e, t, i, n) {
  var o = this.sFMPartitioner.getChunk(e);
  if (void 0 === o) {
    return void console.warn("[WebGLRenderer.updateVertexBuffer] No buffer loaded for", e);
  }
  var a = o.start;
  this.updateGPUBuffer(a + i, t, n);
};
s.prototype.drawLineBatch = function (e, t) {
  this.useProgram(this._programLine);
  this.gl.lineWidth(t);
  var i = this.sFMPartitioner.touch(e);
  return void 0 === i ? (console.warn("[WebGLRenderer.drawLineBatch] No buffer loaded for", e), void this.stopProgram()) : (this._drawBatch(i), void this.stopProgram());
};
s.prototype.drawBoxBatch = function (e) {
  this.useProgram(this._programBox);
  var t = this.sFMPartitioner.touch(e);
  return void 0 === t ? (console.warn("[WebGLRenderer.drawBoxBatch] No buffer loaded for", e), void this.stopProgram()) : (this._drawBatch(t), void this.stopProgram());
};
s.prototype.drawSpriteBatchAbsoluteScale = function (e, t) {
  this.useProgram(this._programAbsoluteScale);
  var i = this._matrixStack[0];
  i[3] = t / this._renderTarget.width;
  i[7] = t / this._renderTarget.height;
  this.drawSpriteBatch(e);
  this.stopProgram();
};
s.prototype.drawSpriteBatch = function (e) {
  var t = this.sFMPartitioner.touch(e);
  if (void 0 === t) {
    return void console.warn("[WebGLRenderer.drawSpriteBatch] No buffer loaded for", e);
  }
  if (t.prerender) {
    var i = this.textureCache.holdElement(e),
      n = t.bbox;
    if (void 0 === i) {
      var o = n[0],
        a = n[1],
        s = n[2],
        r = n[3],
        l = this._matrixStack[0],
        c = this._renderTarget.width * l[0] / 2,
        d = this._renderTarget.width * l[4] / 2,
        u = this._renderTarget.height * l[1] / 2,
        h = this._renderTarget.height * l[5] / 2,
        p = Math.sqrt(Math.max(c * c + d * d, u * u + h * h)) * this.prerenderRatio,
        m = this.startTextureUsage(a - o, r - s, p, e, "nearest");
      this.startTextureRendering(m, o, a, s, r);
      this._drawBatch(t);
      this.stopTextureRendering(!0, !0);
      i = m.texture;
    }
    this.drawImage(i, n[0], n[2], n[1] - n[0], n[3] - n[2]);
    i.release();
  } else {
    this._drawBatch(t);
  }
};
s.prototype.handleMaskTag = function (e, t, i) {
  if (e.isMaskDef) {
    var n = t[0],
      o = t[1],
      a = t[2],
      s = t[3],
      r = this.startTextureUsage(o - n, s - a, this.maskQuality);
    return this.startTextureRendering(r, n, o, a, s), void i.push(r);
  }
  var l = this.gl;
  return e.isMaskUse ? (this.useProgram(this._programMask, {
    mask: this._renderTarget.textureBinder
  }), l.uniform4fv(this._currentProgram.uniforms.uBbox, t), void this.stopTextureRendering(!0, !0)) : void (e.isMaskStop && (i.pop().texture.release(), this.stopProgram()));
};
s.prototype._drawBatch = function (e) {
  for (var t = e.spriteBatches, i = null, n = 0; n < t.length; n += 1) {
    var o = t[n];
    if (o.isMaskTag) {
      null === i && (i = []);
      this.handleMaskTag(o, e.bbox, i);
    } else {
      var a = o.startingByte / this._vertexSize,
        s = o.nBytes / this._vertexSize;
      this._drawSubBatch(a, s, o.texture, o.drawMode);
    }
  }
};
s.prototype.drawSpriteSubBatch = function (e, t, i) {
  var n = this.sFMPartitioner.touch(e);
  if (void 0 === n) {
    return void console.warn("[WebGLRenderer.drawSpriteSubBatch] No buffer loaded for", e);
  }
  var o = n.spriteBatches[0],
    a = o.startingByte / this._vertexSize + t,
    s = i - t;
  this._drawSubBatch(a, s, o.texture, o.drawMode);
};
s.prototype._drawSubBatch = function (e, t, i, n) {
  if (!(t <= 0)) {
    var o = this.gl;
    if (null !== i) {
      var a = this.textureCache.useElement(i.id);
      if (void 0 === a) {
        return void console.warn("[WebGLRenderer._drawSubBatch] Texture not loaded:", i.id);
      }
      o.bindTexture(o.TEXTURE_2D, a.element.binder);
    }
    o.uniformMatrix4fv(this._currentProgram.uniforms.uMatrix, !1, this._matrixStack[0]);
    o.drawArrays(n, e, t);
  }
};
i = !0;
v.push(w);
n(m, f, _ * g, w);
h += this._spriteSize;
_ += 1;
this.updateGPUBuffer(d, m);
c.obj = new a(v, t.bbox, i);
c.obj = new a([u], n, r);
this.updateGPUBuffer(d, t);
this.useProgram(this._programLine);
this.gl.lineWidth(t);
i[3] = t / this._renderTarget.width;
i[7] = t / this._renderTarget.height;
this.drawSpriteBatch(e);
this.stopProgram();
this.startTextureRendering(m, o, a, s, r);
this._drawBatch(t);
this.stopTextureRendering(!0, !0);
i = m.texture;
this.drawImage(i, n[0], n[2], n[1] - n[0], n[3] - n[2]);
i.release();
null === i && (i = []);
this.handleMaskTag(o, e.bbox, i);
o.uniformMatrix4fv(this._currentProgram.uniforms.uMatrix, !1, this._matrixStack[0]);
o.drawArrays(n, e, t);
this._type = null;
this.alive = !0;
this.teamId = 0;
this.isCarryied = !1;
this.disposition = {
  cellId: -1,
  direction: 0,
  carryingCharacterId: 0
};
this.look = null;
this.stats = {
  actionPoints: 0,
  airElementReduction: 0,
  airElementResistPercent: 0,
  baseMaxLifePoints: 0,
  criticalDamageFixedResist: 0,
  dodgePALostProbability: 0,
  dodgePMLostProbability: 0,
  earthElementReduction: 0,
  earthElementResistPercent: 0,
  fireElementReduction: 0,
  fireElementResistPercent: 0,
  invisibilityState: 0,
  initiative: 0,
  lifePoints: 0,
  maxActionPoints: 0,
  maxLifePoints: 0,
  maxMovementPoints: 0,
  movementPoints: 0,
  neutralElementReduction: 0,
  neutralElementResistPercent: 0,
  permanentDamagePercent: 0,
  pushDamageFixedResist: 0,
  shieldPoints: 0,
  summoned: !1,
  summoner: 0,
  tackleBlock: 0,
  tackleEvade: 0,
  waterElementReduction: 0,
  waterElementResistPercent: 0
};
e.exports = i;
i.prototype.updateData = function (e) {
  void 0 !== e._type && (this._type = e._type);
  void 0 !== e.alive && (this.alive = e.alive);
  void 0 !== e.teamId && (this.teamId = e.teamId);
  e.disposition && n(this.disposition, e.disposition);
  e.look && (this.look = e.look);
  e.stats && n(this.stats, e.stats);
};
i.prototype.pointVariation = function (e, t) {
  this.stats[e] += t;
  this.stats[e] < 0 && (this.stats[e] = 0);
};
void 0 !== e._type && (this._type = e._type);
void 0 !== e.alive && (this.alive = e.alive);
void 0 !== e.teamId && (this.teamId = e.teamId);
e.disposition && n(this.disposition, e.disposition);
e.look && (this.look = e.look);
e.stats && n(this.stats, e.stats);
this.stats[e] += t;
this.stats[e] < 0 && (this.stats[e] = 0);
S.preloadImage("ui/SpellPlaceholder.png", function (e) {
  t.placeHolder = e;
});
v([O], null, function (t, i) {
  return t ? e(t) : (b = i, void e());
});
this.id = parseInt(e, 10);
this.ownerId = null;
this.position = null;
this.isItem = !1;
this.level = null;
this.isLoaded = !1;
this.spell = null;
this._tables = {};
v(e, t, function (e, t) {
  return e ? i(e) : (n.effectInstances = t.effectInstances, delete t.effectInstances, n._tables = t, n.spell = t.spells[n.id], n.spell ? (n.setLevel(n.level || 1), n.isLoaded = !0, void i()) : i(new Error("missing static data for spell id " + n.id)));
});
this.id = O;
this.ownerId = null;
this.position = null;
this.isItem = !0;
this.level = 1;
this.isLoaded = !1;
this._item = e;
this.effectInstances = {};
e instanceof Array || (e = [e]);
v(e, function (i, n) {
  if (i) {
    return t(i);
  }
  var o = {};
  M.each(e, function (e, t) {
    if (o[e] = new s(), ~~e === O) {
      var i = window.gui.playerData.inventory.getCurrentWeapon();
      if (i) {
        return l.call(o[e], i, t);
      }
    }
    r.call(o[e], e, n, t);
  }, function (e) {
    return e ? t(e) : void t(null, o);
  });
});
h.effectCaller = "SpellFactory spellLevelId: " + n;
a[n] = c[u][o];
s.prototype.setLevel = function (e) {
  return this.isItem ? void (1 !== e && console.warn("Spell#setLevel called on item with level != 1", e)) : (this.level = e, this.spell ? !e || e < 1 || e > this.spell.spellLevels.length ? console.error(new Error("invalid level " + e + " for spell #" + this.id)) : void (this.spellLevel = this._getSpellLevelByLevel(this.level)) : console.error("Spell#setLevel this.spell is undefined or null #", this.id));
};
s.prototype.setPosition = function (e) {
  this.position = e;
};
s.prototype._getSpellLevelByLevel = function (e) {
  return this.isItem ? console.error("Spell#_getSpellLevelByLevel called on item for Spell id", this.id) : this.spell ? this._tables.spellLevels[this.spell.spellLevels[e - 1]] : console.error("Spell#_getSpellLevelByLevel this.spell is undefined or null #", this.id);
};
s.prototype.getSpellLevelId = function (e) {
  return this.isItem ? "weapon" : (e = void 0 !== e ? e : this.level, this._getSpellLevelByLevel(e).id);
};
s.prototype.getZoneEffect = function () {
  for (var e, t = 63, i = this.isWeapon() ? this._item.effects : this.spellLevel.effects, n = 0; n < i.length; n++) {
    var o = this.effectInstances[this.getSpellLevelId() + "-effects-" + n],
      a = o.getZoneEffect();
    if ((o.isPreview || a.zoneShape && a.zoneSize > 0 && a.zoneSize < t) && (t = a.zoneSize, e = a), o.isPreview) {
      break;
    }
  }
  return e || T.parseZone("P");
};
s.prototype.getZoneEffectWhenCasting = function () {
  for (var e, t = this.isWeapon() ? this._item.effects : this.spellLevel.effects, i = 0; i < t.length; i++) {
    var n = this.effectInstances[this.getSpellLevelId() + "-effects-" + i],
      o = n.getZoneEffect();
    if ((n.isPreview || o.zoneShape && o.zoneSize > 0) && (e = o), n.isPreview) {
      break;
    }
  }
  return e || T.parseZone("P");
};
s.prototype.getHumanReadableZoneInfo = function () {
  return T.getHumanReadableZoneInfo(this.getZoneEffect());
};
s.prototype.getMaxLevel = function () {
  return this.isItem || this.id === O ? 1 : this.spell.spellLevels.length;
};
s.prototype.getHumanReadableSpellType = function () {
  var e = this.getProperty("typeId"),
    t = window.gui.databases.SpellTypes[e];
  return t ? t.longNameId : (console.error("Spell factory cannot get typeId", e, "for spellId:", this.id), "");
};
s.prototype.getEffectsIds = function (e) {
  return this.isItem ? Object.keys(this.effectInstances) : this._getSpellLevelByLevel(e || this.level).effects;
};
s.prototype.getCriticalEffectsIds = function (e) {
  return this.isItem ? [] : this._getSpellLevelByLevel(e || this.level).criticalEffect;
};
s.prototype.getUpgradeCost = function (e, t) {
  if (this.isItem) {
    return null;
  }
  void 0 === t && void 0 === e ? (e = this.level, t = e + 1) : void 0 === t && (t = e, e = this.level);
  for (var i = 0, n = 0, o = 1; o <= e; o += 1) {
    n += o - 1;
    i += o - 1;
  }
  for (; o <= t; o += 1) {
    i += o - 1;
  }
  return i - n;
};
s.prototype.getName = function () {
  var e = this.getProperty("nameId");
  return e || (console.error("Spell#getName: no name for spellId " + this.id), e = ""), window.gui.playerData.isAbleToSeeId() && (e += " (" + this.id + ")"), e;
};
s.prototype.getProperty = function (e, t) {
  t = t || this.level;
  var i = this.isItem ? d.call(this, e) : c.call(this, e, t);
  if ("range" === e) {
    var n = window.gui.playerData.characters.getControlledCharacter().characteristics;
    if (!n) {
      return i;
    }
    var o = n.range,
      a = this.isItem ? d.call(this, "rangeCanBeBoosted") : c.call(this, "rangeCanBeBoosted", t);
    if (a) {
      var s = this.isItem ? d.call(this, "minRange") : c.call(this, "minRange", t),
        r = o.getTotalStat();
      i + r < s ? i = s : i += r;
    }
  }
  return i;
};
s.prototype.getIconUri = function () {
  var e = this.isItem ? E.ITEM_DIR : E.SPELL_DIR + "sort_",
    t = this.getProperty("iconId");
  return t < 0 && console.error(new Error("iconId < 0 for spellId " + this.id + ": " + t)), e + this.getProperty("iconId") + ".png";
};
s.prototype.getIconUrl = function () {
  return this.isItem ? this._item.item && this._item.getProperty("image") : this.spell && this.spell.image;
};
s.prototype.update = function (e) {
  if (this.id !== O) {
    return e();
  }
  var t = window.gui.playerData.inventory.getCurrentWeapon();
  return t ? l.call(this, t, e) : r.call(this, 0, null, e);
};
s.prototype.clone = function () {
  var e = new s();
  for (var t in this) {
    this.hasOwnProperty(t) && "_uid" !== t && "castingData" !== t && (e[t] = this[t]);
  }
  return e.setLevel(1), e;
};
s.prototype.cast = function (e, t, i) {
  this.castingData || h.call(this);
  t = t || [];
  i = i !== !1;
  this.castingData.lastCastTurn = e;
  for (var n = 0; n < t.length; n++) {
    var o = t[n];
    this.castingData.targetsThisTurn[o] || (this.castingData.targetsThisTurn[o] = 0);
    this.castingData.targetsThisTurn[o]++;
  }
  i && this.castingData.castThisTurn++;
  window.gui.shortcutBar.updateSpellAvailability(this.id);
};
s.prototype.newTurn = function () {
  this.castingData || (console.warn('You should not call "newTurn" on a spell that has not been casted'), h.call(this));
  this.castingData.castThisTurn = 0;
  this.castingData.targetsThisTurn = {};
};
s.prototype.getModifiedInterval = function () {
  if (this.isItem) {
    return 0;
  }
  for (var e = new N(), t = window.gui.playerData.characters.mainCharacter.characteristics.spellModifications, i = 0; i < t.length; i++) {
    var n = t[i];
    if (n.spellId === this.id) {
      var o = n.modificationType;
      o === C.CAST_INTERVAL ? e.castInterval.setPts(n.value.getAllValues()) : o === C.CAST_INTERVAL_SET && e.castIntervalSet.setPts(n.value.getAllValues());
    }
  }
  var a,
    s = e.castInterval.getTotalStat(),
    r = e.castIntervalSet.getTotalStat();
  return a = r ? r - s : this.spellLevel.minCastInterval - s;
};
s.prototype.refreshCellZoneEffect = function (e, t) {
  var i,
    n,
    o,
    a,
    s = window.isoEngine.mapRenderer.map.cells,
    r = this.isWeapon(),
    l = r ? this._item : this.spellLevel,
    c = [];
  for (i = 0; i < l.effects.length; i++) {
    n = this.effectInstances[this.getSpellLevelId() + "-effects-" + i];
    o = n.rawZone;
    o && c[o] ? n.cellZoneEffect = c[o] : (a = n.getZoneEffect(), n.cellZoneEffect = x.getSpellEffectZone(s, e, t, a), o && (c[o] = n.cellZoneEffect));
  }
  if (!this.isWeapon()) {
    for (i = 0; i < l.criticalEffect.length; i++) {
      n = this.effectInstances[this.getSpellLevelId() + "-criticalEffect-" + i];
      o = n.rawZone;
      o && c[o] ? n.cellZoneEffect = c[o] : (a = n.getZoneEffect(), n.cellZoneEffect = x.getSpellEffectZone(s, e, t, a), o && (c[o] = n.cellZoneEffect));
    }
  }
};
s.prototype.resetCellZoneEffect = function () {
  for (var e in this.effectInstances) {
    this.effectInstances.hasOwnProperty(e) && (this.effectInstances[e].cellZoneEffect = {});
  }
};
s.prototype.getEffectInstances = function () {
  var e,
    t,
    i = {
      effects: [],
      criticalEffects: []
    },
    n = this.isWeapon(),
    o = n ? this._item : this.spellLevel;
  for (e = 0; e < o.effects.length; e++) {
    t = this.effectInstances[this.getSpellLevelId() + "-effects-" + e];
    t.isPreview || (i.effects.push(t), n && o.item && o.item.criticalHitBonus && i.criticalEffects.push(t));
  }
  if (!n) {
    for (e = 0; e < o.criticalEffect.length; e++) {
      t = this.effectInstances[this.getSpellLevelId() + "-criticalEffect-" + e];
      t.isPreview || i.criticalEffects.push(t);
    }
  }
  return i;
};
s.prototype.isInSpellRange = function (e, t) {
  for (var i = window.isoEngine.mapRenderer.map.cells, n = x.getSpellRange(i, e, {
      castInDiagonal: this.getProperty("castInDiagonal"),
      castInLine: this.getProperty("castInLine"),
      minRange: this.getProperty("minRange"),
      range: this.getProperty("range")
    }), o = 0; o < n.length; o++) {
    var a = L.getCellIdFromMapPoint(n[o][0], n[o][1]);
    if (a === t) {
      return !0;
    }
  }
  return !1;
};
s.prototype.isWeapon = function () {
  return this.id === O && window.gui.playerData.inventory.getCurrentWeapon();
};
s.prototype.getCooldown = function (e) {
  if (!e || !this.castingData || this.isItem) {
    return 0;
  }
  var t,
    i = this.getModifiedInterval(),
    n = e.getRelativeTurnCount();
  if (0 === this.spellLevel.initialCooldown || this.castingData.lastCastTurn >= this.castingData.lastInitialCooldownReset + this.spellLevel.initialCooldown) {
    if (63 === i) {
      return 63;
    }
    t = i + this.castingData.lastCastTurn - n;
  } else {
    t = this.castingData.lastInitialCooldownReset + this.spellLevel.initialCooldown - n;
  }
  return t = Math.max(0, t);
};
s.prototype.resetInitialCooldown = function (e) {
  this.castingData || h.call(this);
  this.castingData.lastInitialCooldownReset = e;
};
s.prototype.forceCooldown = function (e) {
  this.castingData || (console.warn('You should not call "forceCooldown" on a spell that has not been casted'), h.call(this));
  var t = this.isItem ? 0 : this.getModifiedInterval();
  this.castingData.lastCastTurn = e + window.gui.fightManager.turnCount - t;
};
s.prototype.forceLastCastTurn = function (e) {
  this.castingData || (console.warn('You should not call "forceLastCastTurn" on a spell that has not been casted'), h.call(this));
  this.castingData.lastCastTurn = e;
};
s.prototype.hasBeenCast = function () {
  return !!this.castingData;
};
t.initialize = n;
t.createSpells = p;
t.sortSpells = y;
n += o - 1;
i += o - 1;
this.castingData || h.call(this);
t = t || [];
i = i !== !1;
this.castingData.lastCastTurn = e;
this.castingData.targetsThisTurn[o] || (this.castingData.targetsThisTurn[o] = 0);
this.castingData.targetsThisTurn[o]++;
i && this.castingData.castThisTurn++;
window.gui.shortcutBar.updateSpellAvailability(this.id);
this.castingData || (console.warn('You should not call "newTurn" on a spell that has not been casted'), h.call(this));
this.castingData.castThisTurn = 0;
this.castingData.targetsThisTurn = {};
n = this.effectInstances[this.getSpellLevelId() + "-effects-" + i];
o = n.rawZone;
o && c[o] ? n.cellZoneEffect = c[o] : (a = n.getZoneEffect(), n.cellZoneEffect = x.getSpellEffectZone(s, e, t, a), o && (c[o] = n.cellZoneEffect));
n = this.effectInstances[this.getSpellLevelId() + "-criticalEffect-" + i];
o = n.rawZone;
o && c[o] ? n.cellZoneEffect = c[o] : (a = n.getZoneEffect(), n.cellZoneEffect = x.getSpellEffectZone(s, e, t, a), o && (c[o] = n.cellZoneEffect));
t = this.effectInstances[this.getSpellLevelId() + "-effects-" + e];
t.isPreview || (i.effects.push(t), n && o.item && o.item.criticalHitBonus && i.criticalEffects.push(t));
t = this.effectInstances[this.getSpellLevelId() + "-criticalEffect-" + e];
t.isPreview || i.criticalEffects.push(t);
this.castingData || h.call(this);
this.castingData.lastInitialCooldownReset = e;
this.castingData || (console.warn('You should not call "forceLastCastTurn" on a spell that has not been casted'), h.call(this));
this.castingData.lastCastTurn = e;
this._type = "SpellModificator";
this.apCost = new o();
this.castInterval = new o();
this.castIntervalSet = new o();
this.maxCastPerTurn = new o();
this.maxCastPerTarget = new o();
o.push([e + s, t - r, a]);
o.push([e + r, t + s, a]);
o.push([e - s, t + r, a]);
o.push([e - r, t - s, a]);
o.push([e - a, t, a]);
o.push([e + a, t, a]);
o.push([e, t - a, a]);
o.push([e, t + a, a]);
o.push([e - a, t - a, a]);
o.push([e - a, t + a, a]);
o.push([e + a, t - a, a]);
o.push([e + a, t + a, a]);
o.push([e - a, t, a]);
o.push([e + a, t, a]);
o.push([e, t - a, a]);
o.push([e, t + a, a]);
o.push([e - a, t - a, a]);
o.push([e - a, t + a, a]);
o.push([e + a, t - a, a]);
o.push([e + a, t + a, a]);
o.push([e - a, t, a]);
o.push([e + a, t, a]);
o.push([e, t - a, a]);
o.push([e, t + a, a]);
o.push([e - a, t - a, a]);
o.push([e - a, t + a, a]);
o.push([e + a, t - a, a]);
o.push([e + a, t + a, a]);
o.push([e + a, t + s, a]);
o.push([e + a, t - s, a]);
o.push([e - a, t + s, a]);
o.push([e - a, t - s, a]);
o.push([e + s, t + a, a]);
o.push([e - s, t + a, a]);
o.push([e + s, t - a, a]);
o.push([e - s, t - a, a]);
s.push([l + d * a, c - d * o, r]);
s.push([l - d * a, c + d * o, r]);
s.push([l + r * a, c - r * o, r]);
s.push([l - r * a, c + r * o, r]);
o.push([e - a, t, a]);
o.push([e + a, t, a]);
o.push([e, t - a, a]);
o.push([e, t + a, a]);
o.push([e + a, t + s, a]);
o.push([e + a, t - s, a]);
o.push([e - a, t + s, a]);
o.push([e - a, t - s, a]);
o.push([e + s, t + a, a]);
o.push([e - s, t + a, a]);
o.push([e + s, t - a, a]);
o.push([e - s, t - a, a]);
s.push([e + a * r, t - o * r, r]);
s.push([e - a * r, t + o * r, r]);
e.exports.getSpellRange = function (e, t, i) {
  var s,
    r = _.getMapPointFromCellId(t);
  return s = i.castInLine && i.castInDiagonal ? o(r.x, r.y, i.minRange, i.range).concat(a(r.x, r.y, i.minRange, i.range)) : i.castInLine ? o(r.x, r.y, i.minRange, i.range) : i.castInDiagonal ? a(r.x, r.y, i.minRange, i.range) : n(r.x, r.y, i.minRange, i.range);
};
e.exports.getCircleArea = function (e, t, i) {
  return f(e, t, i, n);
};
e.exports.getCrossArea = function (e, t, i) {
  return f(e, t, i, o);
};
s = l.x === c.x ? 0 : l.x > c.x ? 1 : -1;
r = l.y === c.y ? 0 : l.y > c.y ? 1 : -1;
f = window.foreground.fightIsUserTurn ? v.areaOfEffect : v.areaOfEffectEnemyTurn;
o[p] = new g(p, u[h][2], f);
void 0 === a && console.error("Incorrect Effect shape id: " + n.zoneShape);
o[i] = new g(i, 0, window.foreground.fightIsUserTurn ? v.areaOfEffect : v.areaOfEffectEnemyTurn);
t.getCoordinateSceneFromGrid = n;
t.getMapPointFromCellId = o;
a();
Object.freeze(T);
t.getCellIdFromMapPoint = s;
t.getNeighbourCells = r;
t.areCellsNeighbours = l;
t.getOrientation = c;
t.getDistance = d;
t.getSquareDistance = u;
n.prepareSpellsWithInitialCooldown(r);
s.characters.setCharacteristic(r, "lifePoints", i.stats.lifePoints);
t.forceCooldown(a);
window.gui.shortcutBar.updateSpellAvailability(i);
a.incrementDuration(i, n, !0, a.INCREMENT_MODE_TARGET);
W.push(k.FIGHTER_EFFECTS_MODIFY_DURATION, [i, t, n], i, o, e);
l.setHP(d);
(!s || s && i) && (i <= 0 ? W.push(k.FIGHTER_LIFE_LOSS, [t, i, o], t, a, e, !1, 2) : i > 0 && W.push(k.FIGHTER_LIFE_GAIN, [t, i, o], t, a, e, !1, 2));
i !== F.VISIBLE && s === F.VISIBLE ? a = F.INVISIBLE : i === F.VISIBLE && s !== F.VISIBLE && (a = F.VISIBLE);
a && W.push(k.FIGHTER_VISIBILITY_CHANGED, [t, a], t, n, e);
o.data.stats.invisibilityState = i;
t.pushStep = n;
t.fightMovementPointsVariationStep = o;
t.fightActionPointsVariationStep = a;
t.fightLeavingStateStep = s;
t.fightEnteringStateStep = r;
t.fightTemporaryBoostStep = l;
t.fightDisplayBuffStep = c;
t.fightSummonStep = d;
t.fightSpellCooldownVariationStep = u;
t.fightModifyEffectsDurationStep = h;
t.fightExchangePositionsStep = p;
t.fightSlideStep = m;
t.fightTeleportOnSameMapStep = f;
t.mapMovementStep = g;
t.fightCarryCharacterStep = _;
t.fightThrowCharacterStep = v;
t.fightShieldPointsVariationStep = y;
t.fightLifePointsVariationStep = w;
t.fightReduceDamages = b;
t.fightActionPointsLossDodge = M;
t.fightMovementPointsLossDodge = T;
t.fightSpellImmunity = C;
t.fightDispelEffectStep = I;
t.fightDispelSpellStep = A;
t.fightDispelStep = S;
t.fightReflectSpellStep = E;
t.fightReflectDamagesStep = N;
t.fightTackledStep = x;
t.fightKillStep = L;
t.fightInvisibilityStep = O;
t.fightTriggerGlyphTrapStep = R;
t.fightCloseCombatStep = D;
t.fightSpellCastStep = P;
t.fightDeathStep = B;
o.call(this);
this.characteristics = null;
this.spellShortcuts = [];
this.spellData = new s();
this.currentSummonedCreature = 0;
this.currentSummonedBomb = 0;
this.timeStatsSynchronized = 0;
a(n, o);
e.exports = n;
n.prototype.connect = function () {
  this.spellData.connect();
};
n.prototype.disconnect = function () {
  this.characteristics = null;
  this.spellShortcuts = null;
  this.spellData.disconnect();
  this.currentSummonedCreature = 0;
  this.currentSummonedBomb = 0;
};
n.prototype.setCharacteristics = function (e) {
  this.characteristics = e;
  this.timeStatsSynchronized = Date.now();
};
n.prototype.setCharacteristic = function (e, t) {
  return void 0 === this.characteristics[e] ? void console.error(new Error("setCharacteristic: No characteristic named: " + e)) : "CharacterBaseCharacteristic" === this.characteristics[e]._type ? void console.error(new Error("setCharacteristic: " + e + ' cannot take a type "number"')) : void (this.characteristics[e] = t);
};
n.prototype.setCharacterId = function (e) {
  this.spellData.characterId = e;
};
n.prototype.getMaxSummonedCreature = function () {
  return this.characteristics.summonableCreaturesBoost.getTotalStat();
};
n.prototype.setSpellShortcuts = function (e) {
  this.spellShortcuts = [];
  for (var t = 0; t < e.length; t++) {
    this.spellShortcuts.push(e[t]);
  }
};
n.prototype.updateSpellShortcut = function (e) {
  for (var t = 0; t < this.spellShortcuts.length; t++) {
    if (this.spellShortcuts[t].slotIndex === e.slotIndex) {
      return void (this.spellShortcuts[t] = e);
    }
  }
  this.spellShortcuts.push(e);
};
n.SpellData = s;
this.characteristics = null;
this.spellShortcuts = null;
this.spellData.disconnect();
this.currentSummonedCreature = 0;
this.currentSummonedBomb = 0;
this.characteristics = e;
this.timeStatsSynchronized = Date.now();
this.spells = {};
this.characterId = null;
this.isLoaded = !1;
this._requestsPendingCount = 0;
this._spellsStatus = {};
this.onLevelUp = function () {
  e._updateSpells(function (e) {
    if (e) {
      return console.error(e);
    }
  });
};
s(o, a);
e.exports = o;
o.prototype.disconnect = function () {
  this.spells = {};
  this.characterId = null;
  this.isLoaded = !1;
  this._requestsPendingCount = 0;
  this._spellsStatus = {};
  window.gui.removeListener("CharacterLevelUpMessage", this.onLevelUp);
};
o.prototype.connect = function () {
  window.gui.on("CharacterLevelUpMessage", this.onLevelUp);
};
o.prototype.weaponChanged = function (e) {
  this.spells[u] && this.spells[u].update(e);
};
o.prototype.getSpells = function (e) {
  e = e || 0;
  var t = {};
  for (var i in this.spells) {
    var n = this._spellsStatus[i] || 0;
    n >= e && (t[i] = this.spells[i]);
  }
  return t;
};
o.prototype._updateSpells = function (e) {
  var t = this,
    i = Object.keys(t.spells);
  r.createSpells(i, function (i, n) {
    if (i) {
      return e(i);
    }
    for (var o in n) {
      var a = t.spells[o];
      a && (t.spells[o] = n[o], t.spells[o].ownerId = a.ownerId, t.spells[o].setLevel(a.level), t.spells[o].setPosition(a.position));
    }
    return e();
  });
};
o.prototype._createSpells = function (e, t, i) {
  var n = this;
  t = t || {};
  this._requestsPendingCount++;
  this.isLoaded = !1;
  this.spells[u] || e.indexOf(u) !== -1 || e.indexOf(u.toString()) !== -1 || e.push(u.toString());
  r.createSpells(e, function (e, o) {
    if (e) {
      return console.error(e);
    }
    for (var a in o) {
      o[a].ownerId = n.characterId;
      n.spells[a] = o[a];
      var s = t[a];
      s && (void 0 !== s.level && o[a].setLevel(s.level), void 0 !== s.position && o[a].setPosition(s.position));
    }
    return n._requestsPendingCount--, 0 === n._requestsPendingCount && (n.isLoaded = !0, n.emit("loaded")), i ? i() : void 0;
  });
};
o.prototype.addSpells = function (e, t) {
  var i = [],
    n = {};
  for (var o in e) {
    var a = e[o];
    this._spellsStatus[o] = a.spellStatus;
    this.spells[o] ? void 0 !== a.spellLevel && void 0 !== a.position && (this.spells[o].setLevel(a.spellLevel), this.spells[o].setPosition(a.position)) : (n[o] = {
      level: a.spellLevel,
      position: a.position
    }, i.push(o));
  }
  return 0 === i.length ? t && t() : void this._createSpells(i, n, t);
};
o.prototype.resetSpellsStatus = function () {
  this._spellsStatus = {};
};
o.prototype.upgradeSpell = function (e, t, i, o) {
  var a = -1,
    s = this._spellsStatus[e] || d.UNAVAILABLE,
    r = this.spells[e];
  if (o = o || n, r && s === d.USABLE && (a = r.level), l.log("character_progression.spell_level_change", {
    spell_level_before: a,
    spell_level_after: t,
    spell_id: e
  }), this._spellsStatus[e] = i, r) {
    return r.setLevel(t), o();
  }
  var c = {};
  return c[e] = {}, c[e].level = t, this._createSpells([e], c, o);
};
o.prototype.getSpellBySpellLevelId = function (e) {
  for (var t in this.spells) {
    var i = this.spells[t];
    if (!i.isItem && i.spellLevel.id === e) {
      return i;
    }
  }
  return null;
};
o.SPELL_STATUS = d;
this.spells = {};
this.characterId = null;
this.isLoaded = !1;
this._requestsPendingCount = 0;
this._spellsStatus = {};
window.gui.removeListener("CharacterLevelUpMessage", this.onLevelUp);
t = t || {};
this._requestsPendingCount++;
this.isLoaded = !1;
this.spells[u] || e.indexOf(u) !== -1 || e.indexOf(u.toString()) !== -1 || e.push(u.toString());
r.createSpells(e, function (e, o) {
  if (e) {
    return console.error(e);
  }
  for (var a in o) {
    o[a].ownerId = n.characterId;
    n.spells[a] = o[a];
    var s = t[a];
    s && (void 0 !== s.level && o[a].setLevel(s.level), void 0 !== s.position && o[a].setPosition(s.position));
  }
  return n._requestsPendingCount--, 0 === n._requestsPendingCount && (n.isLoaded = !0, n.emit("loaded")), i ? i() : void 0;
});
o[a].ownerId = n.characterId;
n.spells[a] = o[a];
this._spellsStatus[o] = a.spellStatus;
this.spells[o] ? void 0 !== a.spellLevel && void 0 !== a.position && (this.spells[o].setLevel(a.spellLevel), this.spells[o].setPosition(a.position)) : (n[o] = {
  level: a.spellLevel,
  position: a.position
}, i.push(o));
i.createChild("div", {
  className: "star"
});
this._starCounter = i.createChild("div", {
  className: "starsNb",
  text: "0"
});
this._bonusContainer = this.createChild("div", {
  className: "bonusContainer"
});
this._linkToShop = this._bonusContainer.appendChild(new s({
  className: "linkToShop",
  scaleOnPress: !1
}));
this._linkToShop.on("tap", function () {
  r.open("market", {
    tabId: "shop",
    tabParams: {
      category: "bonuspack"
    }
  });
  t.emit("shopOpened");
});
r.open("market", {
  tabId: "shop",
  tabParams: {
    category: "bonuspack"
  }
});
t.emit("shopOpened");
n.createChild("div", {
  className: ["bonusStar", "star1"]
});
n.createChild("div", {
  className: ["bonusStar", "star2"]
});
n.createChild("div", {
  className: ["bonusStar", "star3"]
});
n.createChild("div", {
  className: "locker"
});
void 0 !== e && this.setValue(e);
o(n, a);
e.exports = n;
n.prototype.setValue = function (e) {
  e = e < 0 ? 0 : e;
  var t = Math.floor(e / 20);
  this._starCounter.setText(t);
  window.gui.playerData.isSubscriberAtMinLevel(l.NORMAL) ? (this._bonusContainer.addClassNames("bonusPackActive"), this._linkToShop.disable()) : (this._bonusContainer.delClassNames("bonusPackActive"), this._linkToShop.enable());
};
this._starCounter.setText(t);
window.gui.playerData.isSubscriberAtMinLevel(l.NORMAL) ? (this._bonusContainer.addClassNames("bonusPackActive"), this._linkToShop.disable()) : (this._bonusContainer.delClassNames("bonusPackActive"), this._linkToShop.enable());
m && (d = u / m);
m = u;
c.x -= h.left;
c.y -= h.top;
p = p || c;
e.emit("transform", c.x, c.y, g, _, d, s);
p = c;
e._transformBehavior = !0;
e.allowDomEvents();
e.on("dom.wheel", function (t) {
  if (a.requestInteractionHandle("TRANSFORM", e)) {
    h = s(e.rootElement);
    var i = t.wheelDeltaY > 0 ? r : 1 / r;
    e.emit("transform", t.x - h.left, t.y - h.top, 0, 0, i);
  }
});
e.isTransforming = !1;
e.cancelTransform = function () {
  v && (_ = !0, p = m = null, v = !1, e.removeListener("dom.touchmove", u), e.isTransforming = !1, y && e.emit("transformEnd"));
};
e.on("dom.touchstart", function (t) {
  if (p = m = null, !v && !_) {
    var i = o(t);
    w && 2 !== i.touchCount || i.touchCount > 2 || (h = s(e.rootElement), v = !0, y = !1, f = i.touches, g = Date.now(), e.on("dom.touchmove", u));
  }
});
e.on("dom.touchend", function (t) {
  p = m = null;
  var i = o(t);
  return _ || 0 !== i.touchCount ? void (_ = !1) : (e.removeListener("dom.touchmove", u), v = !1, void (y && (e.isTransforming = !1, e.emit("transformEnd", i))));
});
t = t || {};
d.call(this, "div", e);
this.addClassNames("Ornament");
this._charName = null;
this._title = null;
this._titleId = null;
this._ornamentId = null;
this._ornamentAssetId = null;
this._guild = null;
this._gender = null;
this._alliance = null;
this._alignment = null;
this._scaleFactor = (t.scaleFactor || 1) * p.PIXEL_RATIO;
this.alignmentWingsWrapper = this.createChild("div", {
  className: "alignmentWingsWrapper"
});
this._wingsTopCanvas = this.alignmentWingsWrapper.appendChild(new a());
this._wingsTopCtx = this._wingsTopCanvas.getContext();
this.alignmentTailWrapper = this.createChild("div", {
  className: "alignmentTailWrapper"
});
this._wingsBottomCanvas = this.alignmentTailWrapper.appendChild(new a());
this._wingsBottomCtx = this._wingsBottomCanvas.getContext();
this._canvas = this.appendChild(new a());
this._ctx = this._canvas.getContext();
this._width = this._canvas.width = 400;
this._height = this._canvas.height = 400;
this._guildEmblem = new s({
  width: 40,
  height: 40
});
this._allianceEmblem = new s({
  width: 40,
  height: 40
});
r(n, d);
e.exports = n;
n.prototype.setAttributes = function (e) {
  e = e || {};
  this._charName = e.hasOwnProperty("charName") ? e.charName : null;
  this._guild = e.hasOwnProperty("guild") ? e.guild : null;
  this._alliance = e.hasOwnProperty("alliance") ? e.alliance : null;
  this._alignment = e.hasOwnProperty("alignmentInfos") ? e.alignmentInfos : null;
  this._levelDiff = e.levelDiff;
  this._ornamentId = e.hasOwnProperty("ornamentId") ? e.ornamentId : null;
  this._ornamentAssetId = e.hasOwnProperty("ornamentAssetId") ? e.ornamentAssetId : null;
  this._title = e.hasOwnProperty("title") ? e.title : null;
  this._titleId = e.hasOwnProperty("titleId") ? e.titleId : null;
  this._gender = e.hasOwnProperty("gender") ? e.gender : null;
};
n.prototype.changeAttributes = function (e) {
  e = e || {};
  for (var t in e) {
    this.hasOwnProperty("_" + t) && (this["_" + t] = e[t]);
  }
};
n.prototype.display = function () {
  var e = this,
    t = this._ctx;
  t.clearRect(0, 0, this._width, this._height);
  this._preload(function (t) {
    return t ? console.error(t) : (e._calculateDimension(), !e._ornamentAssetId || e._alignment && 0 !== e._alignment.alignmentGrade ? (e._resizeCanvas(e._textWidth, e._textHeight, 0, 0), e._displayText(), void e.emit("rendered")) : (e._displayTextAndOrnament(), void e.emit("rendered")));
  });
};
n.prototype._loadOrnament = function (e) {
  var t = this;
  o.series([function (e) {
    return t._ornamentId ? void c.getData("Ornaments", t._ornamentId, function (i, n) {
      return i ? e(i) : n ? (t._ornamentAssetId = n.assetId, void e()) : e("staticContent.getData Ornaments - ornamentData is " + n);
    }) : e();
  }, function (e) {
    return t._ornamentAssetId ? void l.loadModel("ornaments", "ornament_" + t._ornamentAssetId, function (i, n) {
      t._jsonObj = i;
      t._image = n;
      e();
    }) : e();
  }], e);
};
n.prototype._preload = function (e) {
  var t = this;
  this._guildEmblem = new s({
    width: 40,
    height: 40
  });
  this._allianceEmblem = new s({
    width: 40,
    height: 40
  });
  o.parallel([function (e) {
    t._loadOrnament(e);
  }, function (e) {
    return t._titleId ? void c.getData("Titles", t._titleId, function (i, n) {
      return i ? e(i) : n ? (t._title = t._gender ? n.nameFemaleId : n.nameMaleId, void e()) : e("staticContent.getData Titles - titleData is " + n);
    }) : e();
  }, function (e) {
    return t._guild && t._guild.guildEmblem ? void t._guildEmblem.setValue(t._guild.guildEmblem, !0, e) : e();
  }, function (e) {
    return t._alliance && t._alliance.allianceEmblem ? void t._allianceEmblem.setValue(t._alliance.allianceEmblem, !0, e) : e();
  }], e);
};
n.prototype._calculateDimension = function () {
  var e = this._ctx,
    t = [],
    i = 0,
    n = 0;
  if (e.font = w, this._nameWidth = e.measureText(this._charName).width, t.push(this._nameWidth), n = _, this._guild) {
    var o = this._guild.guildName;
    e.font = y;
    this._guildNameWidth = e.measureText(o).width;
    t.push(this._guildNameWidth + 2 * A);
    t.push(this._nameWidth + 2 * A);
    n += T + g;
  }
  if (this._title) {
    e.font = b;
    var a = this._title,
      s = e.measureText(a).width;
    t.push(s);
    n += T + v;
  }
  i = Math.max.apply(null, t) + 2 * M;
  n += 2 * M;
  i = Math.round(i);
  n = Math.round(n);
  this._textWidth = Math.max(i, m);
  this._textHeight = Math.max(n, f);
  this._diffWidth = this._textWidth - m;
  this._diffHeight = this._textHeight - f;
};
n.prototype._displayText = function () {
  var e = this,
    t = this._ctx,
    i = this._textWidth,
    n = this._textHeight;
  t.fillStyle = "rgba(0, 0, 0, 0.8)";
  var o = 5;
  t.beginPath();
  t.moveTo(o, 0);
  t.lineTo(i - o, 0);
  t.quadraticCurveTo(i, 0, i, o);
  t.lineTo(i, n - o);
  t.quadraticCurveTo(i, n, i - o, n);
  t.lineTo(o, n);
  t.quadraticCurveTo(0, n, 0, n - o);
  t.lineTo(0, o);
  t.quadraticCurveTo(0, 0, o, 0);
  t.closePath();
  t.fill();
  t.textAlign = "center";
  var a = Math.max(this._guildNameWidth || 0, this._nameWidth),
    s = a + (this._guild ? 2 * A : 0),
    r = Math.round(a / 2),
    l = Math.round((i - s) / 2) + (this._guild ? A : 0),
    c = M;
  if (this._guild) {
    var d = this._guild.guildName;
    t.font = y;
    t.fillStyle = "#ffffff";
    c += g;
    t.fillText(d, l + r, c);
    c += T;
  }
  if (this._charName && (t.font = w, t.fillStyle = "#ffffff", c += _, t.fillText(this._charName, l + r, c), c += T), this._title) {
    t.font = b;
    t.fillStyle = "#00B346";
    var p = this._title;
    c += v;
    t.fillText(p, Math.round(i / 2), c);
  }
  if (this._guild && (t.drawImage(this._guildEmblem.getContext().canvas, l - A, M, 40, 40), t.drawImage(this._allianceEmblem.getContext().canvas, l + a + I, M, 40, 40)), this._alignment && this._alignment.alignmentSide !== u.ALIGNMENT_NEUTRAL && 0 !== this._alignment.alignmentGrade) {
    var m = window.gui.playerData.alignment,
      f = 20,
      C = this._levelDiff === -1 ? .6 : 1,
      S = 1 === this._levelDiff ? f : 0,
      E = this._alignment.alignmentSide === u.ALIGNMENT_ANGEL ? "#ffffff" : "#ff0018",
      N = function (e, t, i, n, o) {
        var a = t.width + 2 * f,
          s = t.height + 2 * f,
          r = t.left - f,
          l = t.top;
        l += o ? -f : f;
        i.width = a;
        i.height = s;
        i.setStyles({
          left: r + "px",
          top: l + "px",
          width: a + "px",
          height: s + "px",
          opacity: C
        });
        n.shadowBlur = S;
        n.shadowColor = E;
        n.drawImage(e, f, f);
      };
    m.getTopWings(this._alignment, function (t) {
      h.loadImage(t.imagePath, function (i) {
        N(i, t, e._wingsTopCanvas, e._wingsTopCtx, !0);
        e._wingsTopCanvas.show();
      });
    });
    m.getBottomWings(this._alignment, function (t) {
      t ? h.loadImage(t.imagePath, function (i) {
        N(i, t, e._wingsBottomCanvas, e._wingsBottomCtx, !1);
        e._wingsBottomCanvas.show();
      }) : e._wingsBottomCanvas.hide();
    });
  } else {
    e._wingsTopCanvas.hide();
    e._wingsBottomCanvas.hide();
  }
};
n.prototype._displayTextAndOrnament = function () {
  var e = this._ctx,
    t = this._diffWidth,
    i = this._diffHeight,
    n = this._jsonObj,
    o = this._image,
    a = Math.round(t / 2),
    s = Math.round(i / 2);
  for (var r in n.symbols) {
    var l = n.symbols[r];
    if (l.className && l.className.indexOf("ornament_") !== -1) {
      this._resizeOrnament(l);
      for (var c = l.children.length - 1; c >= 0; c--) {
        var d = l.children[c],
          u = d.id,
          h = n.symbols[u],
          p = d.matrices[0],
          g = n.matrices[p],
          _ = g[0],
          v = g[1],
          y = g[2],
          w = g[3],
          b = g[4],
          M = g[5];
        switch (d.name) {
          case "left":
            M += s;
            break;
          case "right":
            b += t;
            M += s;
            break;
          case "picto":
            b += a;
            break;
          case "top":
            b += a;
            break;
          case "bottom":
            b += a;
            M += i;
        }
        e.save();
        e.transform(_, v, y, w, b, M);
        var T = isNaN(parseInt(h.sx, 10)) || isNaN(parseInt(h.sy, 10)) || isNaN(parseInt(h.sw, 10)) || isNaN(parseInt(h.sh, 10)) || isNaN(parseInt(h.x, 10)) || isNaN(parseInt(h.y, 10)) || isNaN(parseInt(h.w, 10)) || isNaN(parseInt(h.h, 10));
        if (T) {
          ;
        } else if ("bg" === d.name) {
          this._displayText();
          var C = h.sw / h.w,
            I = h.sh / h.h,
            A = .5 * m - h.x,
            S = .5 * f - h.y,
            E = h.w + h.x - .5 * m,
            N = h.h + h.y - .5 * f;
          e.drawImage(o, h.sx, h.sy, A * C, S * I, h.x, h.y, A, S);
          e.drawImage(o, h.sx + A * C, h.sy, E * C, S * I, h.x + A + t, h.y, E, S);
          e.drawImage(o, h.sx, h.sy + S * I, A * C, N * I, h.x, h.y + S + i, A, N);
          e.drawImage(o, h.sx + A * C, h.sy + S * I, E * C, N * I, h.x + A + t, h.y + S + i, E, N);
          e.drawImage(o, h.sx + A * C, h.sy, 1 * C, S * I, h.x + A, h.y, t, S);
          e.drawImage(o, h.sx + A * C, h.sy + S * I, 1 * C, N * I, h.x + A, h.y + S + i, t, N);
          e.drawImage(o, h.sx, h.sy + S * I, A * C, 1 * I, h.x, h.y + S, A, i);
          e.drawImage(o, h.sx + A * C, h.sy + S * I, A * C, 1 * I, h.x + A + t, h.y + S, A, i);
        } else {
          e.drawImage(o, h.sx, h.sy, h.sw, h.sh, h.x, h.y, h.w, h.h);
        }
        e.restore();
      }
    }
  }
};
n.prototype._resizeCanvas = function (e, t, i, n) {
  var o = this._ctx;
  this._width = e * this._scaleFactor;
  this._height = t * this._scaleFactor;
  this._canvas.width = this._width;
  this._canvas.height = this._height;
  this._cssWidth = this._width / p.PIXEL_RATIO;
  this._cssHeight = this._height / p.PIXEL_RATIO;
  this._canvas.setStyles({
    width: this._cssWidth + "px",
    height: this._cssHeight + "px"
  });
  o.clearRect(0, 0, this._width, this._height);
  o.scale(this._scaleFactor, this._scaleFactor);
  o.translate(i, n);
  this.emit("sizeChanged");
};
n.prototype._resizeOrnament = function (e) {
  var t = 1 / 0,
    i = 1 / 0,
    n = -(1 / 0),
    o = -(1 / 0);
  if (e.children.length) {
    for (var a = e.children.length - 1; a >= 0; a--) {
      var s = e.children[a],
        r = s.id,
        l = this._jsonObj.symbols[r];
      if (l.isGraphic) {
        var c = s.matrices[0],
          d = this._jsonObj.matrices[c],
          u = d[4] + l.x || 0,
          h = d[5] + l.y || 0;
        t = Math.min(t, h);
        i = Math.min(i, u);
        n = Math.max(n, u + l.w);
        o = Math.max(o, h + l.h);
      }
    }
    var p = Math.round(n - i + this._diffWidth),
      m = Math.round(o - t + this._diffHeight);
    this._resizeCanvas(p, m, -i, -t);
  }
};
n.prototype.getHeight = function () {
  return this._cssHeight;
};
n.prototype.getCanvasOffsetWidth = function () {
  return this._canvas.rootElement.offsetWidth;
};
e = e || {};
this._charName = e.hasOwnProperty("charName") ? e.charName : null;
this._guild = e.hasOwnProperty("guild") ? e.guild : null;
this._alliance = e.hasOwnProperty("alliance") ? e.alliance : null;
this._alignment = e.hasOwnProperty("alignmentInfos") ? e.alignmentInfos : null;
this._levelDiff = e.levelDiff;
this._ornamentId = e.hasOwnProperty("ornamentId") ? e.ornamentId : null;
this._ornamentAssetId = e.hasOwnProperty("ornamentAssetId") ? e.ornamentAssetId : null;
this._title = e.hasOwnProperty("title") ? e.title : null;
this._titleId = e.hasOwnProperty("titleId") ? e.titleId : null;
this._gender = e.hasOwnProperty("gender") ? e.gender : null;
t.clearRect(0, 0, this._width, this._height);
this._preload(function (t) {
  return t ? console.error(t) : (e._calculateDimension(), !e._ornamentAssetId || e._alignment && 0 !== e._alignment.alignmentGrade ? (e._resizeCanvas(e._textWidth, e._textHeight, 0, 0), e._displayText(), void e.emit("rendered")) : (e._displayTextAndOrnament(), void e.emit("rendered")));
});
t._jsonObj = i;
t._image = n;
e();
this._guildEmblem = new s({
  width: 40,
  height: 40
});
this._allianceEmblem = new s({
  width: 40,
  height: 40
});
o.parallel([function (e) {
  t._loadOrnament(e);
}, function (e) {
  return t._titleId ? void c.getData("Titles", t._titleId, function (i, n) {
    return i ? e(i) : n ? (t._title = t._gender ? n.nameFemaleId : n.nameMaleId, void e()) : e("staticContent.getData Titles - titleData is " + n);
  }) : e();
}, function (e) {
  return t._guild && t._guild.guildEmblem ? void t._guildEmblem.setValue(t._guild.guildEmblem, !0, e) : e();
}, function (e) {
  return t._alliance && t._alliance.allianceEmblem ? void t._allianceEmblem.setValue(t._alliance.allianceEmblem, !0, e) : e();
}], e);
e.font = y;
this._guildNameWidth = e.measureText(o).width;
t.push(this._guildNameWidth + 2 * A);
t.push(this._nameWidth + 2 * A);
n += T + g;
t.push(s);
n += T + v;
i = Math.max.apply(null, t) + 2 * M;
n += 2 * M;
i = Math.round(i);
n = Math.round(n);
this._textWidth = Math.max(i, m);
this._textHeight = Math.max(n, f);
this._diffWidth = this._textWidth - m;
this._diffHeight = this._textHeight - f;
t.beginPath();
t.moveTo(o, 0);
t.lineTo(i - o, 0);
t.quadraticCurveTo(i, 0, i, o);
t.lineTo(i, n - o);
t.quadraticCurveTo(i, n, i - o, n);
t.lineTo(o, n);
t.quadraticCurveTo(0, n, 0, n - o);
t.lineTo(0, o);
t.quadraticCurveTo(0, 0, o, 0);
t.closePath();
t.fill();
t.textAlign = "center";
t.font = y;
t.fillStyle = "#ffffff";
c += g;
t.fillText(d, l + r, c);
c += T;
t.font = b;
t.fillStyle = "#00B346";
c += v;
t.fillText(p, Math.round(i / 2), c);
l += o ? -f : f;
i.width = a;
i.height = s;
i.setStyles({
  left: r + "px",
  top: l + "px",
  width: a + "px",
  height: s + "px",
  opacity: C
});
n.shadowBlur = S;
n.shadowColor = E;
n.drawImage(e, f, f);
m.getTopWings(this._alignment, function (t) {
  h.loadImage(t.imagePath, function (i) {
    N(i, t, e._wingsTopCanvas, e._wingsTopCtx, !0);
    e._wingsTopCanvas.show();
  });
});
m.getBottomWings(this._alignment, function (t) {
  t ? h.loadImage(t.imagePath, function (i) {
    N(i, t, e._wingsBottomCanvas, e._wingsBottomCtx, !1);
    e._wingsBottomCanvas.show();
  }) : e._wingsBottomCanvas.hide();
});
N(i, t, e._wingsTopCanvas, e._wingsTopCtx, !0);
e._wingsTopCanvas.show();
N(i, t, e._wingsBottomCanvas, e._wingsBottomCtx, !1);
e._wingsBottomCanvas.show();
e._wingsTopCanvas.hide();
e._wingsBottomCanvas.hide();
b += t;
M += s;
b += a;
M += i;
e.save();
e.transform(_, v, y, w, b, M);
e.drawImage(o, h.sx, h.sy, A * C, S * I, h.x, h.y, A, S);
e.drawImage(o, h.sx + A * C, h.sy, E * C, S * I, h.x + A + t, h.y, E, S);
e.drawImage(o, h.sx, h.sy + S * I, A * C, N * I, h.x, h.y + S + i, A, N);
e.drawImage(o, h.sx + A * C, h.sy + S * I, E * C, N * I, h.x + A + t, h.y + S + i, E, N);
e.drawImage(o, h.sx + A * C, h.sy, 1 * C, S * I, h.x + A, h.y, t, S);
e.drawImage(o, h.sx + A * C, h.sy + S * I, 1 * C, N * I, h.x + A, h.y + S + i, t, N);
e.drawImage(o, h.sx, h.sy + S * I, A * C, 1 * I, h.x, h.y + S, A, i);
e.drawImage(o, h.sx + A * C, h.sy + S * I, A * C, 1 * I, h.x + A + t, h.y + S, A, i);
this._width = e * this._scaleFactor;
this._height = t * this._scaleFactor;
this._canvas.width = this._width;
this._canvas.height = this._height;
this._cssWidth = this._width / p.PIXEL_RATIO;
this._cssHeight = this._height / p.PIXEL_RATIO;
this._canvas.setStyles({
  width: this._cssWidth + "px",
  height: this._cssHeight + "px"
});
o.clearRect(0, 0, this._width, this._height);
o.scale(this._scaleFactor, this._scaleFactor);
o.translate(i, n);
this.emit("sizeChanged");
t = Math.min(t, h);
i = Math.min(i, u);
n = Math.max(n, u + l.w);
o = Math.max(o, h + l.h);
e = e || {};
s.call(this, {
  className: "EmblemLogo"
});
this.addClassNames(e.className);
this.width = e.width || 100;
this.height = e.height || 100;
this.images = {
  crownImage: null,
  backgroundShape: null,
  symbolShape: null
};
this._isAnkamaSymbol = !1;
this.symbolWidth = Math.round(this.width * p);
this.symbolHeight = Math.round(this.height * p);
this.symbolPosX = Math.round((this.width - this.symbolWidth) / 2);
this.symbolPosY = Math.round((this.height - this.symbolHeight) / 2);
this.crownWidth = Math.round(this.width * m);
this.crownHeight = Math.round(this.height * m);
this.crownPosX = 0;
this.crownPosY = 0;
i.width = this.width;
i.height = this.height;
this.tempCtx = i.getContext();
o(this, function () {
  if (t.isLeader) {
    return r("ui.guild.right.leader");
  }
});
c(n, s);
e.exports = n;
n.prototype._generateEmblem = function () {
  var e = this.images;
  if (e.backgroundShape && e.symbolShape) {
    var t = this.getContext(),
      i = this.tempCtx;
    t.clearRect(0, 0, this.width, this.height);
    t.drawImage(e.backgroundShape, 0, 0, this.width, this.height);
    var n,
      o = this.backgroundColor;
    if (o) {
      var a = t.getImageData(0, 0, this.width, this.height),
        s = a.data,
        r = o[0] / d,
        l = o[1] / u,
        c = o[2] / h;
      for (n = 0; n < s.length; n += 4) {
        s[n] *= r;
        s[n + 1] *= l;
        s[n + 2] *= c;
      }
      t.putImageData(a, 0, 0);
    }
    i.clearRect(0, 0, this.width, this.height);
    i.drawImage(e.symbolShape, this.symbolPosX, this.symbolPosY, this.symbolWidth, this.symbolHeight);
    var p = this.symbolColor;
    if (p && !this._isAnkamaSymbol) {
      var m = i.getImageData(0, 0, this.width, this.height),
        f = m.data;
      for (n = 0; n < f.length; n += 4) {
        0 !== f[n + 3] && (f[n] = p[0], f[n + 1] = p[1], f[n + 2] = p[2]);
      }
      i.putImageData(m, 0, 0);
    }
    t.drawImage(i.canvas, 0, 0, this.width, this.height);
    this.isLeader && t.drawImage(e.crownImage, this.crownPosX, this.crownPosY, this.crownWidth, this.crownHeight);
  }
};
n.prototype.setValue = function (e, t, i) {
  var n = this,
    o = [],
    s = [];
  if (t = t || e.dec2rgb, e.hasOwnProperty("guild") && (t = !0, this.isLeader = e.guild.allianceLeader, e = e.guild.guildEmblem), e.hasOwnProperty("backgroundColor") && (t ? this.backgroundColor = l.hexToRgb((+e.backgroundColor).toString(16)) : this.backgroundColor = e.backgroundColor), e.hasOwnProperty("backgroundShape")) {
    var r = "gfx/emblems/icons/" + (e.isAlliance ? "backalliance" : "back") + "/" + e.backgroundShape + ".png";
    o.push(r);
    s.push("backgroundShape");
  }
  if (e.hasOwnProperty("symbolShape")) {
    this._isAnkamaSymbol = e.symbolShape === f;
    var c = "gfx/emblems/icons/up/" + e.symbolShape + ".png";
    o.push(c);
    s.push("symbolShape");
  }
  e.hasOwnProperty("symbolColor") && (this.symbolColor = t ? l.hexToRgb((+e.symbolColor).toString(16)) : e.symbolColor);
  this.isLeader && !this.images.crownImage && (o.push("ui/tx_crown.png"), s.push("crownImage"));
  a.loadImages(o, null, function (e) {
    if (n && n.rootElement) {
      for (var t = 0; t < s.length; t += 1) {
        n.images[s[t]] = e[t];
      }
      if (n._generateEmblem(), "function" == typeof i) {
        return i();
      }
    } else if ("function" == typeof i) {
      return i();
    }
  });
};
t.clearRect(0, 0, this.width, this.height);
t.drawImage(e.backgroundShape, 0, 0, this.width, this.height);
s[n] *= r;
s[n + 1] *= l;
s[n + 2] *= c;
i.clearRect(0, 0, this.width, this.height);
i.drawImage(e.symbolShape, this.symbolPosX, this.symbolPosY, this.symbolWidth, this.symbolHeight);
t.drawImage(i.canvas, 0, 0, this.width, this.height);
this.isLeader && t.drawImage(e.crownImage, this.crownPosX, this.crownPosY, this.crownWidth, this.crownHeight);
o.push(r);
s.push("backgroundShape");
o.push(c);
s.push("symbolShape");
e.hasOwnProperty("symbolColor") && (this.symbolColor = t ? l.hexToRgb((+e.symbolColor).toString(16)) : e.symbolColor);
this.isLeader && !this.images.crownImage && (o.push("ui/tx_crown.png"), s.push("crownImage"));
a.loadImages(o, null, function (e) {
  if (n && n.rootElement) {
    for (var t = 0; t < s.length; t += 1) {
      n.images[s[t]] = e[t];
    }
    if (n._generateEmblem(), "function" == typeof i) {
      return i();
    }
  } else if ("function" == typeof i) {
    return i();
  }
});
n ? (u = n.holdTexture(f), u ? p = !1 : (p = !0, v += 1)) : (p = !0, v += 1);
o.loadJson(g, c);
p !== !1 && o.loadImage(f, d);
s.call(this, "div", e);
this.addClassNames("PropertyInfo");
this._guild = null;
this._guildEmblem = new o({
  width: 40,
  height: 40
});
this._emblemContainer = this.createChild("div", {
  className: "emblemContainer"
});
this._emblemContainer.appendChild(this._guildEmblem);
this._infoContainer = this.createChild("div", {
  className: "infoContainer"
});
a(n, s);
e.exports = n;
n.prototype._preload = function (e) {
  return this._guild && this._guild.guildEmblem ? this._guildEmblem.setValue(this._guild.guildEmblem, !0, e) : e(null, null);
};
n.prototype.display = function (e) {
  var t = this;
  e = e || {};
  this._guild = e.hasOwnProperty("guild") ? e.guild : null;
  this._emblemContainer.hide();
  this._infoContainer.clearContent();
  this._preload(function (i) {
    return i ? console.error("PropertyInfo preload", i) : (t._display(e.line1, e.line2), void t.emit("rendered"));
  });
};
n.prototype._display = function (e, t) {
  this._guild && this._guild.guildEmblem && (this._infoContainer.createChild("div", {
    text: this._guild.guildName,
    className: "guildName"
  }), this._emblemContainer.show());
  this._infoContainer.createChild("div", {
    text: e,
    className: "line1"
  });
  t && this._infoContainer.createChild("div", {
    text: t,
    className: "line2"
  });
};
e = e || {};
this._guild = e.hasOwnProperty("guild") ? e.guild : null;
this._emblemContainer.hide();
this._infoContainer.clearContent();
this._preload(function (i) {
  return i ? console.error("PropertyInfo preload", i) : (t._display(e.line1, e.line2), void t.emit("rendered"));
});
this._guild && this._guild.guildEmblem && (this._infoContainer.createChild("div", {
  text: this._guild.guildName,
  className: "guildName"
}), this._emblemContainer.show());
this._infoContainer.createChild("div", {
  text: e,
  className: "line1"
});
t && this._infoContainer.createChild("div", {
  text: t,
  className: "line2"
});
n.prototype._setupBorderArrow = function () {
  this._borderArrow = this.createChild("div", {
    className: "BorderArrow"
  });
};
n.prototype.showBorderArrow = function (e, t, i) {
  switch (e) {
    case "top":
    case "bottom":
      this._borderArrow.setStyles({
        left: t + "px",
        top: ""
      });
      break;
    case "left":
    case "right":
      this._borderArrow.setStyles({
        top: i + "px",
        left: ""
      });
  }
  this._borderArrow.setClassNames(["BorderArrow", e]);
  this._borderArrow.show();
};
n.prototype.hideBorderArrow = function () {
  this._borderArrow.hide();
};
this._borderArrow.setClassNames(["BorderArrow", e]);
this._borderArrow.show();
n.prototype._setupMonsterGroupTooltips = function () {
  this._monsterTooltips = [];
};
n.prototype.showAllMonsterGroupTooltips = function () {
  var e = this,
    t = window.actorManager.actors,
    i = window.isoEngine.mapScene;
  this.removeAllMonsterGroupTooltips();
  for (var n in t) {
    if (t.hasOwnProperty(n)) {
      var s = t[n];
      if (Number.isInteger(s.actorId) && s.actorId < 0 && "GameRolePlayGroupMonsterInformations" === t[n].data.type) {
        var r = new o("div", {
            className: "sceneTooltip"
          }),
          l = e.appendChild(new a({
            content: r
          }));
        e._constructMonsterTooltip(r, s.data, s);
        var d = s.bbox,
          u = i.convertSceneToCanvasCoordinate(d[0], d[2]),
          h = i.convertSceneToCanvasCoordinate(d[1], d[3]),
          p = h.x - u.x,
          m = h.y - u.y,
          f = (u.x + h.x) / 2,
          g = (u.y + h.y) / 2;
        l.openTooltipAt(f, g, p, m + 2 * c, r);
        e._monsterTooltips.push(l);
      }
    }
  }
  this._checkCollidingTooltip();
};
n.prototype.removeAllMonsterGroupTooltips = function () {
  var e = this;
  this._monsterTooltips.forEach(function (t) {
    e.removeChild(t);
  });
  this._monsterTooltips = [];
};
n.prototype._checkCollidingTooltip = function () {
  var e = window.isoEngine.mapScene;
  if (this._monsterTooltips && !(this._monsterTooltips.length <= 0)) {
    for (var t = this._monsterTooltips.length, i = 0; i < t; i++) {
      for (var n = this._monsterTooltips[i], o = n.getComputedPosition(), a = o.TL.x, s = o.TL.y, r = o.BR.x - o.TL.x, l = o.BR.y - o.TL.y, c = {}, d = 0, u = null, h = 0; h < t; h++) {
        if (h !== i && d < t) {
          var p = this._monsterTooltips[h].getComputedPosition(),
            m = o.TL.x < p.BR.x,
            f = o.BR.x > p.TL.x,
            g = o.TL.y < p.BR.y,
            _ = o.BR.y > p.TL.y;
          if (m && f && g && _) {
            var v = [],
              y = null;
            switch (c.left || "right" === u || v.push({
              name: "left",
              value: o.BR.x - p.TL.x
            }), c.right || "left" === u || v.push({
              name: "right",
              value: p.BR.x - o.TL.x
            }), c.bottom || "top" === u || v.push({
              name: "bottom",
              value: p.BR.y - o.TL.y
            }), c.top || "bottom" === u || v.push({
              name: "top",
              value: o.BR.y - p.TL.y
            }), v.length > 0 && (y = v.reduce(function (e, t) {
              return e.value < t.value ? e : t;
            })), y.name) {
              case "left":
                o.BR.x = p.TL.x;
                o.TL.x = o.BR.x - r;
                break;
              case "right":
                o.TL.x = p.BR.x;
                o.BR.x = o.TL.x + r;
                break;
              case "bottom":
                o.TL.y = p.BR.y;
                o.BR.y = o.TL.y + l;
                break;
              case "top":
                o.BR.y = p.TL.y;
                o.TL.y = o.BR.y - l;
            }
            var w = o.TL.x < 0 || o.BR.x > e.viewWidth,
              b = o.TL.y < 0 || o.BR.y > e.viewHeight;
            w || b ? (c[y.name] = !0, o.BR.x = a + r, o.BR.y = s + l, o.TL.x = a, o.TL.y = s, h--) : (u = y.name, a = o.TL.x, s = o.TL.y, c = {}, d++, h = -1);
          }
        }
      }
      n.setStyles({
        webkitTransform: "translate3d(" + o.TL.x + "px," + o.TL.y + "px,0)"
      });
    }
  }
};
n.prototype._constructMonsterTooltip = function (e, t, i) {
  var n = window.gui.playerData.partyData.getClassicalParty(),
    o = n ? n.getMemberCount() : 1,
    a = [],
    c = [t.staticInfos.mainCreatureLightInfos].concat(t.staticInfos.underlings),
    d = i.data.scaleLevel;
  if (d) {
    var u = window.gui.playerData.ToaData.getMonsterLevelScaled(d);
    for (v = 0; v < c.length; v += 1) {
      c[v].staticInfos.level = u;
    }
  }
  var h = c.sort(function (e, t) {
      return t.staticInfos.level - e.staticInfos.level;
    }),
    p = t.staticInfos.alternatives,
    m = [];
  if (p) {
    for (var f, g = 0; p[g] && p[g].playerCount <= o;) {
      f = p[g];
      g += 1;
    }
    for (v = 0; v < f.monsters.length; v++) {
      m.push(f.monsters[v].creatureGenericId);
    }
  }
  for (var _ = 0, v = 0, y = h.length; v < y; v += 1) {
    var w = h[v],
      b = w.staticInfos;
    if (w) {
      _ += b.level;
      var M = m.indexOf(w.creatureGenericId);
      M !== -1 && m.splice(M, 1);
      p && M === -1 || a.push({
        id: w.creatureGenericId,
        xp: b.xp,
        level: b.level
      });
    }
  }
  e.addClassNames("monsterInfoTooltip");
  e.createChild("div", {
    className: "level",
    text: r("ui.common.rank", l.intToString(_))
  });
  e.appendChild(new s(t.ageBonus));
  var T = l.getXpPreview(a, window.gui.playerData, null, t.ageBonus),
    C = l.getXpPreview(a, window.gui.playerData, n, t.ageBonus),
    I = e.createChild("div", {
      className: "xpPreview"
    });
  I.createChild("div", {
    text: r("ui.tooltip.monsterXpAlone", l.intToString(T))
  });
  o > 1 && I.createChild("div", {
    text: r("ui.tooltip.monsterXpParty", l.intToString(C))
  });
  for (var A = 0, S = h.length; A < S; A += 1) {
    w = h[A].staticInfos;
    w && e.createChild("div", {
      text: w.nameId + " (" + w.level + ")"
    });
  }
};
l.openTooltipAt(f, g, p, m + 2 * c, r);
e._monsterTooltips.push(l);
this._monsterTooltips.forEach(function (t) {
  e.removeChild(t);
});
this._monsterTooltips = [];
o.BR.x = p.TL.x;
o.TL.x = o.BR.x - r;
o.TL.x = p.BR.x;
o.BR.x = o.TL.x + r;
o.TL.y = p.BR.y;
o.BR.y = o.TL.y + l;
o.BR.y = p.TL.y;
o.TL.y = o.BR.y - l;
f = p[g];
g += 1;
M !== -1 && m.splice(M, 1);
p && M === -1 || a.push({
  id: w.creatureGenericId,
  xp: b.xp,
  level: b.level
});
e.addClassNames("monsterInfoTooltip");
e.createChild("div", {
  className: "level",
  text: r("ui.common.rank", l.intToString(_))
});
e.appendChild(new s(t.ageBonus));
I.createChild("div", {
  text: r("ui.tooltip.monsterXpAlone", l.intToString(T))
});
o > 1 && I.createChild("div", {
  text: r("ui.tooltip.monsterXpParty", l.intToString(C))
});
w = h[A].staticInfos;
w && e.createChild("div", {
  text: w.nameId + " (" + w.level + ")"
});
l.call(this);
this.windowsContainer = null;
this.playerData = new J();
this.serversData = new oe();
this.boxArranger = new w();
this.isConnected = !1;
this.wBody = Ye;
Ye.allowDomEvents();
this.on("IdentificationSuccessMessage", this.onIdentificationSuccess);
this.on("IdentificationSuccessWithLoginTokenMessage", this.onIdentificationSuccess);
this.on("ServersListMessage", this.onServerListReceived);
this.on("CurrentMapMessage", this.onCurrentMapMessage);
window.dofus.connectionManager.on("ClientUIOpenedMessage", this.openUIFromServer.bind(this));
H.initialize(this);
this.setupAppTransition();
u.initialize(Ye);
g.isIOS && !g.isPhoneGap && i(1414);
r(n, l);
e.exports = n;
n.prototype.setupAppTransition = function () {
  function e() {
    n.emit("appGoBackground");
  }
  function t() {
    n.emit("appLeaveBackground");
    p.appOpen();
    o && (window.dofus.sendMessage("BasicPingMessage", {
      quiet: !0
    }), a = !0);
  }
  var i = window.dofus.connectionManager,
    n = this,
    o = !1,
    a = !1;
  i.on("open", function () {
    o = !0;
  });
  i.on("disconnect", function () {
    o = !1;
    a = !1;
  });
  i.on("BasicPongMessage", function () {
    a && (n.emit("connectedAfterAppLeaveBackground"), a = !1);
  });
  p.appOpen();
  g.isIOSApp ? (document.addEventListener("pause", e, !1), document.addEventListener("resume", t, !1)) : document.addEventListener("visibilitychange", function (i) {
    i.target.hidden ? e() : t();
  }, !1);
};
n.prototype.transmitMessage = function (e) {
  switch (e._messageType) {
    case "MapComplementaryInformationsDataMessage":
    case "MapComplementaryInformationsWithCoordsMessage":
    case "MapComplementaryInformationsDataInHouseMessage":
    case "MapComplementaryInformationsWithObstacleOverride":
      this.emit("mapComplementaryInformationsData", e);
      break;
    default:
      this.emit(e._messageType, e);
  }
};
n.prototype.transmitFightSequenceMessage = function (e, t) {
  this.fightManager.processFightSequenceMessage(e, t);
};
n.prototype.initialize = function (e, t) {
  function i() {
    var e = ve.getLastFocusedWindowId();
    n.isConnected && n.chat.active ? n.chat.deactivate() : h.isOpen() ? h.close() : n.isConnected && !e ? ve["switch"]("global") : e ? ve.getWindow(e).backButtonClose() : n.loginScreen.isVisible() && navigator.app.exitApp();
  }
  var n = this;
  this.loginScreen || (h.initialize(Ye, Ye), this._createUiForLogin(), document.addEventListener("deviceReady", function () {
    document.addEventListener("backbutton", i);
  }));
  e && (t && (o = t, a = new Ue(o)), console.debug("Gui.initialize:", e));
};
n.prototype.initializeAfterLogin = function (e) {
  if (this.initialized) {
    return e();
  }
  ce.initialize(this);
  this.fightManager = new N();
  this.shieldTutorialManager = new fe();
  this.scenarioManager = new Ie();
  this.playerData.initialize(this, o, a);
  this.serversData.initialize(this);
  this.fightManager.initialize(this);
  this.shieldTutorialManager.initialize(this);
  this.boxArranger.initialize();
  this.GPS = new P();
  this.pingSystem = new ie();
  this.gifts = new ne();
  this.npcDialogHandler = new V();
  this.uiLocker = new be();
  Z.initialize();
  B.initialize(this);
  y.initialize(this);
  L.initialize(this);
  ge.initialize(this);
  I.initialize(this);
  M.initialize(this);
  $.initialize();
  we.initialize();
  Me.initialize(a);
  Ce.initialize();
  _.initialize();
  var t = this;
  s.series([S.load, z.initialize, F.initialize], function (i) {
    return i ? e(i) : (t._initUserInterface(), t._initAutoResize(), t.initialized = !0, t.emit("initialized"), void e());
  });
};
n.prototype.onServerListReceived = function (e) {
  this.initialized ? this.serversData.onServerList(e) : this.once("initialized", function () {
    this.serversData.onServerList(e);
  });
};
n.prototype._createUiForLogin = function () {
  ve.initialize(this);
  Ye.setStyles({
    height: v.dimensions.screenHeight + "px"
  });
  this.backgroundScreen = Ye.appendChild(new Le());
  this.loginScreen = Ye.appendChild(new xe());
  this.splashScreen = Ye.appendChild(new Oe());
  this.connectionSplashScreen = Ye.appendChild(new Ne());
  this.windowsContainer = new c("div", {
    className: "windowsContainer"
  });
  Ye.appendChild(this.windowsContainer);
  ve.addWindow("connectionQueue", new He(), {
    fixed: !0
  });
  ve.addWindow("popup", new ze());
  ve.addWindow("confirm", new We());
  ve.addWindow("nickname", new Re(), {
    fixed: !0
  });
  ve.addWindow("register", new De(), {
    fixed: !0
  });
  ve.addWindow("birthdayLimit", new Pe(), {
    fixed: !0
  });
  ve.addWindow("legalAgreement", new Be());
  ve.addWindow("preloadMap", new ke());
  ve.addWindow("cleanAssets", new Fe());
  ve.addWindow("recaptcha", new Ge());
  d.initialize(Ye);
  this.dropDown = Ye.appendChild(new de());
  this.tooltipBox = Ye.appendChild(pe.initialiseTooltipBehavior(Ye));
};
n.prototype._addWindows = function () {
  this.windowsReferences = ve.getWindowsReferences();
  Te(o, a);
};
n.prototype._initUserInterface = function () {
  this.gameGuiContainer = new c("div", {
    className: "gameGuiContainer",
    hidden: !0
  });
  Ye.appendChild(this.gameGuiContainer);
  this.sidebarBackground = this.gameGuiContainer.createChild("div", {
    className: "blackStripe"
  });
  this.mapBorder1 = this.gameGuiContainer.createChild("div", {
    className: "mapBorder"
  });
  this.mapBorder2 = this.gameGuiContainer.createChild("div", {
    className: ["mapBorder", "flipped"]
  });
  this.screenLeftover = this.gameGuiContainer.createChild("div", {
    className: "blackStripe"
  });
  this.gameGuiContainer.appendChild(window.foreground);
  this.numberInputPad = this.gameGuiContainer.appendChild(new Q());
  this._addWindows();
  this.chat = this.gameGuiContainer.appendChild(new T());
  this.chatButton = this.gameGuiContainer.appendChild(new C());
  this.mainControls = this.gameGuiContainer.appendChild(new Y());
  this.shortcutBar = this.gameGuiContainer.appendChild(new ae());
  this.menuBar = this.gameGuiContainer.appendChild(new q());
  this.textNotification = this.gameGuiContainer.appendChild(new A());
  this.roleplayBuffs = this.gameGuiContainer.appendChild(new _e(this.playerData.inventory));
  this.timeline = this.gameGuiContainer.appendChild(new re());
  this.damagePreview = this.gameGuiContainer.appendChild(new le());
  this.progressGauge = this.shortcutBar.appendChild(new ee());
  this.compass = this.gameGuiContainer.appendChild(new ue());
  this.hintArrow = this.gameGuiContainer.appendChild(new he());
  this.kohBox = this.windowsContainer.appendChild(new W());
  this.party = this.gameGuiContainer.appendChild(new K());
  this.challengeIndicator = this.gameGuiContainer.appendChild(new b());
  this.rewardsIndicator = this.gameGuiContainer.appendChild(new te());
  this.npcDialogUi = this.gameGuiContainer.appendChild(new X());
  this.portraitDialogUI = this.gameGuiContainer.appendChild(new Ae());
  this.notificationBar = this.gameGuiContainer.appendChild(new j());
  this.mapCoordinateDisplay = this.gameGuiContainer.appendChild(new U());
  this.houseMenuButton = this.gameGuiContainer.appendChild(new k());
  this.shopFloatingToolbar = this.gameGuiContainer.appendChild(new x());
  this.hintAnimationManager = this.gameGuiContainer.appendChild(new Se());
  this.performanceOverlay = this.gameGuiContainer.appendChild(new Ee());
  E.init(this.gameGuiContainer);
};
n.prototype.onCurrentMapMessage = function () {
  window.foreground.hideBorderArrow();
};
n.prototype.openUIFromServer = function (e) {
  e.type === m.CLIENT_UI_RECONNECTION && G.reconnectByCharId(window.gui.playerData.characterBaseInformations.id);
};
n.prototype.openContextualMenu = function (e, t, i) {
  i = i || {};
  var n = i.x,
    o = i.y;
  if (i.isCanvasCoordinate) {
    var a = window.foreground.convertCanvasToScreenCoordinate(n, o);
    n = a.x;
    o = a.y;
  }
  h.openAt(e, n, o, t);
};
n.prototype.openContextualMenuAround = function (e, t, i) {
  h.openAround(e, t, i);
};
n.prototype.closeContextualMenu = function (e) {
  h.close(e);
};
n.prototype.showHintArrow = function (e, t) {
  this.hintArrow.showArrow(e, t);
};
n.prototype.hideHintArrow = function () {
  this.hintArrow.hideArrow();
};
n.prototype.newSpeechBubble = function (e) {
  return new se(e);
};
n.prototype.disconnect = function (e) {
  this.isConnected = !1;
  "SOCKET_LOST" !== e && "ASSET_MISSING" !== e || this.expectedDisconnectionReason || (console.warn("[Gui] disconnected:", e), this.openSimplePopup(D("ui.popup.connectionFailed.text")));
  this._shutDownUI();
  this.emit("disconnect", e);
  this.playerData.disconnectModules();
};
n.prototype.connectionGonnaBeClosed = function (e) {
  this.expectedDisconnectionReason = e;
  var t = this;
  window.setTimeout(function () {
    t.expectedDisconnectionReason = null;
  }, 6e4);
};
n.prototype._shutDownUI = function () {
  this.splashScreen.show();
  G.backToLogin();
  me.close();
  ve.closeAll();
  this.gameGuiContainer && this.gameGuiContainer.hide();
  this.houseMenuButton && this.houseMenuButton.hide();
  this.tooltipBox && this.tooltipBox.closeTooltip();
  this.kohBox && this.kohBox.hide();
};
n.prototype.onIdentificationSuccess = function () {
  this.loginScreen.hide();
  this.splashScreen.show();
};
n.prototype.onConnect = function (e) {
  this.isConnected = !0;
  O.initialize(this);
  this.backgroundScreen.hide();
  this.gameGuiContainer.show();
  this._resizeUi();
  this.uiLocker.updateAll();
  this.playerData.connectModules(e, this.fightManager.isInReconnection);
  window.gui.emit("connected", this.fightManager.isInReconnection);
};
n.prototype.openPopup = function (e) {
  ve.getWindow("popup").addContent(e);
  ve.open("popup");
};
n.prototype.openSimplePopup = function (e, t) {
  this.openPopup({
    title: t || D("ui.common.error"),
    message: e
  });
};
n.prototype.openConfirmPopup = function (e, t) {
  ve.getWindow("confirm").update(e);
  ve.open("confirm", t);
};
n.prototype.openCancelPopup = function (e) {
  ve.getWindow("cancel").update(e);
  ve.open("cancel");
};
n.prototype._resizeUi = function (e) {
  void 0 === e && (e = window.gui.playerData.isFighting);
  g.isDevice ? Ye.replaceClassNames(["no-touch"], ["touch"]) : Ye.replaceClassNames(["touch"], ["no-touch"]);
  this.displayNotch(O.limitToNotch);
  v.updateScreen();
  var t = v.dimensions;
  Ye.setStyles({
    width: t.screenWidth + "px",
    height: t.screenHeight + "px"
  });
  var i = t.screenWidth / t.screenHeight;
  i <= 1.5 ? (this.ipadRatio = !0, Ye.replaceClassNames(["largeRatio"], ["ipadRatio"]), v.resizeNarrowScreen(e), this.sidebarBackground.setStyles({
    left: 0,
    top: t.mapBottom - 1 + "px",
    width: t.screenWidth + "px",
    height: t.screenHeight - t.mapBottom + 1 + "px"
  }), this.mapBorder1.addClassNames("vertical"), this.mapBorder1.setStyles({
    left: 0,
    top: 0,
    width: t.mapLeft + "px",
    height: t.mapHeight + "px"
  }), this.mapBorder2.addClassNames("vertical"), this.mapBorder2.setStyles({
    left: t.mapRight + "px",
    top: 0,
    width: t.screenWidth - t.mapRight + "px",
    height: t.mapHeight + "px"
  }), this.screenLeftover.setStyles({
    left: 0,
    top: 0,
    width: t.screenWidth + "px",
    height: t.mapTop + "px"
  })) : (this.ipadRatio = !1, Ye.replaceClassNames(["ipadRatio"], ["largeRatio"]), v.resizeWideScreen(e), this.sidebarBackground.setStyles({
    left: t.mapRight + "px",
    top: 0,
    width: t.screenWidth - t.mapRight + "px",
    height: t.screenHeight + "px"
  }), this.mapBorder1.delClassNames("vertical"), this.mapBorder1.setStyles({
    left: t.mapLeft + "px",
    top: 0,
    width: t.mapWidth + "px",
    height: t.mapTop + "px"
  }), this.mapBorder2.delClassNames("vertical"), this.mapBorder2.setStyles({
    left: t.mapLeft + "px",
    top: t.mapBottom - 1 + "px",
    width: t.mapWidth + "px",
    height: t.screenHeight - t.mapBottom + 1 + "px"
  }), this.screenLeftover.setStyles({
    left: 0,
    top: 0,
    width: t.mapLeft + "px",
    height: t.screenHeight + "px"
  }));
  window.isoEngine.updateDimensions(t);
  this.emit("resize", t);
};
n.prototype._initAutoResize = function () {
  function e() {
    clearTimeout(t);
    t = setTimeout(function () {
      i._resizeUi();
    }, 250);
  }
  ye.hide();
  this._resizeUi();
  var t,
    i = this;
  g.isDevice || (window.addEventListener("scroll", e), window.addEventListener("resize", e));
  this.fightManager.on("fightEnterPreparation", function () {
    i._resizeUi();
  });
  this.fightManager.on("fightEnterBattle", function (e) {
    "PREPARATION_SKIPPED" === e && i._resizeUi();
  });
  this.fightManager.on("fightEnd", function () {
    i._resizeUi();
  });
  f.on("gameContextChanged", function () {
    i._resizeUi();
  });
  O.on("fullscreen", function () {
    i._resizeUi();
  });
  O.on("limitToNotch", function () {
    i._resizeUi();
  });
  O.on("menubarSize", this.resizeToolbarForRoleplay.bind(this));
  O.on("menubarSizeInFight", this.resizeToolbarForFight.bind(this));
  O.on("toolbarThicknessInFight", this.resizeToolbarForFight.bind(this));
};
n.prototype._resizeToolbar = function (e) {
  var t = window.gui.playerData.isFighting;
  e === t && this._resizeUi(t);
};
n.prototype.resizeToolbarForFight = function () {
  this._resizeToolbar(!0);
};
n.prototype.resizeToolbarForRoleplay = function () {
  this._resizeToolbar(!1);
};
n.prototype.showFightingToolbar = function (e) {
  this._resizeUi(e);
};
n.prototype.getBuildVersion = function () {
  var e = window.appInfo && window.appInfo.version,
    t = window.buildVersion,
    i = [];
  return e && i.push("Client v" + e), t && i.push("Build v" + t), i.join("/");
};
n.prototype.displayNotch = function (e) {
  qe.toggleClassName("removeNotch", !e);
};
n.emit("appLeaveBackground");
p.appOpen();
o && (window.dofus.sendMessage("BasicPingMessage", {
  quiet: !0
}), a = !0);
i.on("open", function () {
  o = !0;
});
i.on("disconnect", function () {
  o = !1;
  a = !1;
});
i.on("BasicPongMessage", function () {
  a && (n.emit("connectedAfterAppLeaveBackground"), a = !1);
});
p.appOpen();
g.isIOSApp ? (document.addEventListener("pause", e, !1), document.addEventListener("resume", t, !1)) : document.addEventListener("visibilitychange", function (i) {
  i.target.hidden ? e() : t();
}, !1);
o = !1;
a = !1;
this.loginScreen || (h.initialize(Ye, Ye), this._createUiForLogin(), document.addEventListener("deviceReady", function () {
  document.addEventListener("backbutton", i);
}));
e && (t && (o = t, a = new Ue(o)), console.debug("Gui.initialize:", e));
ce.initialize(this);
this.fightManager = new N();
this.shieldTutorialManager = new fe();
this.scenarioManager = new Ie();
this.playerData.initialize(this, o, a);
this.serversData.initialize(this);
this.fightManager.initialize(this);
this.shieldTutorialManager.initialize(this);
this.boxArranger.initialize();
this.GPS = new P();
this.pingSystem = new ie();
this.gifts = new ne();
this.npcDialogHandler = new V();
this.uiLocker = new be();
Z.initialize();
B.initialize(this);
y.initialize(this);
L.initialize(this);
ge.initialize(this);
I.initialize(this);
M.initialize(this);
$.initialize();
we.initialize();
Me.initialize(a);
Ce.initialize();
_.initialize();
ve.initialize(this);
Ye.setStyles({
  height: v.dimensions.screenHeight + "px"
});
this.backgroundScreen = Ye.appendChild(new Le());
this.loginScreen = Ye.appendChild(new xe());
this.splashScreen = Ye.appendChild(new Oe());
this.connectionSplashScreen = Ye.appendChild(new Ne());
this.windowsContainer = new c("div", {
  className: "windowsContainer"
});
Ye.appendChild(this.windowsContainer);
ve.addWindow("connectionQueue", new He(), {
  fixed: !0
});
ve.addWindow("popup", new ze());
ve.addWindow("confirm", new We());
ve.addWindow("nickname", new Re(), {
  fixed: !0
});
ve.addWindow("register", new De(), {
  fixed: !0
});
ve.addWindow("birthdayLimit", new Pe(), {
  fixed: !0
});
ve.addWindow("legalAgreement", new Be());
ve.addWindow("preloadMap", new ke());
ve.addWindow("cleanAssets", new Fe());
ve.addWindow("recaptcha", new Ge());
d.initialize(Ye);
this.dropDown = Ye.appendChild(new de());
this.tooltipBox = Ye.appendChild(pe.initialiseTooltipBehavior(Ye));
this.windowsReferences = ve.getWindowsReferences();
Te(o, a);
this.gameGuiContainer = new c("div", {
  className: "gameGuiContainer",
  hidden: !0
});
Ye.appendChild(this.gameGuiContainer);
this.sidebarBackground = this.gameGuiContainer.createChild("div", {
  className: "blackStripe"
});
this.mapBorder1 = this.gameGuiContainer.createChild("div", {
  className: "mapBorder"
});
this.mapBorder2 = this.gameGuiContainer.createChild("div", {
  className: ["mapBorder", "flipped"]
});
this.screenLeftover = this.gameGuiContainer.createChild("div", {
  className: "blackStripe"
});
this.gameGuiContainer.appendChild(window.foreground);
this.numberInputPad = this.gameGuiContainer.appendChild(new Q());
this._addWindows();
this.chat = this.gameGuiContainer.appendChild(new T());
this.chatButton = this.gameGuiContainer.appendChild(new C());
this.mainControls = this.gameGuiContainer.appendChild(new Y());
this.shortcutBar = this.gameGuiContainer.appendChild(new ae());
this.menuBar = this.gameGuiContainer.appendChild(new q());
this.textNotification = this.gameGuiContainer.appendChild(new A());
this.roleplayBuffs = this.gameGuiContainer.appendChild(new _e(this.playerData.inventory));
this.timeline = this.gameGuiContainer.appendChild(new re());
this.damagePreview = this.gameGuiContainer.appendChild(new le());
this.progressGauge = this.shortcutBar.appendChild(new ee());
this.compass = this.gameGuiContainer.appendChild(new ue());
this.hintArrow = this.gameGuiContainer.appendChild(new he());
this.kohBox = this.windowsContainer.appendChild(new W());
this.party = this.gameGuiContainer.appendChild(new K());
this.challengeIndicator = this.gameGuiContainer.appendChild(new b());
this.rewardsIndicator = this.gameGuiContainer.appendChild(new te());
this.npcDialogUi = this.gameGuiContainer.appendChild(new X());
this.portraitDialogUI = this.gameGuiContainer.appendChild(new Ae());
this.notificationBar = this.gameGuiContainer.appendChild(new j());
this.mapCoordinateDisplay = this.gameGuiContainer.appendChild(new U());
this.houseMenuButton = this.gameGuiContainer.appendChild(new k());
this.shopFloatingToolbar = this.gameGuiContainer.appendChild(new x());
this.hintAnimationManager = this.gameGuiContainer.appendChild(new Se());
this.performanceOverlay = this.gameGuiContainer.appendChild(new Ee());
E.init(this.gameGuiContainer);
n = a.x;
o = a.y;
this.isConnected = !1;
"SOCKET_LOST" !== e && "ASSET_MISSING" !== e || this.expectedDisconnectionReason || (console.warn("[Gui] disconnected:", e), this.openSimplePopup(D("ui.popup.connectionFailed.text")));
this._shutDownUI();
this.emit("disconnect", e);
this.playerData.disconnectModules();
this.splashScreen.show();
G.backToLogin();
me.close();
ve.closeAll();
this.gameGuiContainer && this.gameGuiContainer.hide();
this.houseMenuButton && this.houseMenuButton.hide();
this.tooltipBox && this.tooltipBox.closeTooltip();
this.kohBox && this.kohBox.hide();
this.loginScreen.hide();
this.splashScreen.show();
this.isConnected = !0;
O.initialize(this);
this.backgroundScreen.hide();
this.gameGuiContainer.show();
this._resizeUi();
this.uiLocker.updateAll();
this.playerData.connectModules(e, this.fightManager.isInReconnection);
window.gui.emit("connected", this.fightManager.isInReconnection);
ve.getWindow("popup").addContent(e);
ve.open("popup");
ve.getWindow("confirm").update(e);
ve.open("confirm", t);
ve.getWindow("cancel").update(e);
ve.open("cancel");
void 0 === e && (e = window.gui.playerData.isFighting);
g.isDevice ? Ye.replaceClassNames(["no-touch"], ["touch"]) : Ye.replaceClassNames(["touch"], ["no-touch"]);
this.displayNotch(O.limitToNotch);
v.updateScreen();
i <= 1.5 ? (this.ipadRatio = !0, Ye.replaceClassNames(["largeRatio"], ["ipadRatio"]), v.resizeNarrowScreen(e), this.sidebarBackground.setStyles({
  left: 0,
  top: t.mapBottom - 1 + "px",
  width: t.screenWidth + "px",
  height: t.screenHeight - t.mapBottom + 1 + "px"
}), this.mapBorder1.addClassNames("vertical"), this.mapBorder1.setStyles({
  left: 0,
  top: 0,
  width: t.mapLeft + "px",
  height: t.mapHeight + "px"
}), this.mapBorder2.addClassNames("vertical"), this.mapBorder2.setStyles({
  left: t.mapRight + "px",
  top: 0,
  width: t.screenWidth - t.mapRight + "px",
  height: t.mapHeight + "px"
}), this.screenLeftover.setStyles({
  left: 0,
  top: 0,
  width: t.screenWidth + "px",
  height: t.mapTop + "px"
})) : (this.ipadRatio = !1, Ye.replaceClassNames(["ipadRatio"], ["largeRatio"]), v.resizeWideScreen(e), this.sidebarBackground.setStyles({
  left: t.mapRight + "px",
  top: 0,
  width: t.screenWidth - t.mapRight + "px",
  height: t.screenHeight + "px"
}), this.mapBorder1.delClassNames("vertical"), this.mapBorder1.setStyles({
  left: t.mapLeft + "px",
  top: 0,
  width: t.mapWidth + "px",
  height: t.mapTop + "px"
}), this.mapBorder2.delClassNames("vertical"), this.mapBorder2.setStyles({
  left: t.mapLeft + "px",
  top: t.mapBottom - 1 + "px",
  width: t.mapWidth + "px",
  height: t.screenHeight - t.mapBottom + 1 + "px"
}), this.screenLeftover.setStyles({
  left: 0,
  top: 0,
  width: t.mapLeft + "px",
  height: t.screenHeight + "px"
}));
window.isoEngine.updateDimensions(t);
this.emit("resize", t);
clearTimeout(t);
t = setTimeout(function () {
  i._resizeUi();
}, 250);
ye.hide();
this._resizeUi();
g.isDevice || (window.addEventListener("scroll", e), window.addEventListener("resize", e));
this.fightManager.on("fightEnterPreparation", function () {
  i._resizeUi();
});
this.fightManager.on("fightEnterBattle", function (e) {
  "PREPARATION_SKIPPED" === e && i._resizeUi();
});
this.fightManager.on("fightEnd", function () {
  i._resizeUi();
});
f.on("gameContextChanged", function () {
  i._resizeUi();
});
O.on("fullscreen", function () {
  i._resizeUi();
});
O.on("limitToNotch", function () {
  i._resizeUi();
});
O.on("menubarSize", this.resizeToolbarForRoleplay.bind(this));
O.on("menubarSizeInFight", this.resizeToolbarForFight.bind(this));
O.on("toolbarThicknessInFight", this.resizeToolbarForFight.bind(this));
e === f.TOO_FAST && (p = null);
d = e === f.CLICK_AWAY || e === f.FIGHT_END;
t.getContextMenu = function (e) {
  return h[e];
};
t.initialize = function (e, t) {
  t.on("dom.touchstart", function (e) {
    return m = u(e, {
      useScrollValue: !0
    }), p ? void (s ? s = !1 : p.close(f.CLICK_AWAY)) : void (d = !1);
  });
  window.gui.on("GameFightEndMessage", function () {
    p && p.close(f.FIGHT_END);
  });
  for (var i in h) {
    var a = h[i],
      r = h[i] = e.appendChild(new a());
    r.allowDomEvents();
    r.on("dom.touchstart", n);
    r.on("close", o);
  }
};
t.openAt = function (e, t, i, n) {
  p && p.close(f.TOO_FAST);
  a(e, Math.abs(l - t) < 5 && Math.abs(c - i) < 5) && (l = t, c = i, t = void 0 === t ? m.x : t, i = void 0 === i ? m.y : i, p.openAt(t, i, n));
};
t.openAround = function (e, t, i) {
  a(e, t === r) && (r = t, p.openAround(t, i));
};
t.isOpen = function () {
  return p && p.isOpen;
};
t.close = function (e) {
  p && p.close(e);
};
t.on("dom.touchstart", function (e) {
  return m = u(e, {
    useScrollValue: !0
  }), p ? void (s ? s = !1 : p.close(f.CLICK_AWAY)) : void (d = !1);
});
window.gui.on("GameFightEndMessage", function () {
  p && p.close(f.FIGHT_END);
});
r.allowDomEvents();
r.on("dom.touchstart", n);
r.on("close", o);
p && p.close(f.TOO_FAST);
a(e, Math.abs(l - t) < 5 && Math.abs(c - i) < 5) && (l = t, c = i, t = void 0 === t ? m.x : t, i = void 0 === i ? m.y : i, p.openAt(t, i, n));
e.targetPlayer = null;
e.curItems = null;
e.prevItems = [];
this.once("open", function () {
  e.container = e.entryList.appendChild(new u("div"));
  e._addCancel();
});
this.on("open", function (t, i) {
  e.targetPlayer = t;
  e.updateContent(i);
});
this.on("close", function () {
  e.container.clearContent();
  e.targetPlayer = null;
  e.curItems = null;
  e.prevItems = [];
});
e.container = e.entryList.appendChild(new u("div"));
e._addCancel();
e.targetPlayer = t;
e.updateContent(i);
e.container.clearContent();
e.targetPlayer = null;
e.curItems = null;
e.prevItems = [];
s(a, r);
e.exports = a;
a.prototype.replaceSymbols = function (e) {
  var t = window.gui.playerData.characterBaseInformations.name,
    i = this.targetPlayer.name,
    n = e.replace(/%n/gi, t);
  return n = n.replace(/%p/gi, i);
};
a.prototype._addStartup = function (e) {
  console.debug(e);
};
a.prototype._addStatic = function (e) {
  var t = this.replaceSymbols(e.label);
  this.container.appendChild(new u("div", {
    text: t,
    className: "contextHeader"
  }));
};
a.prototype._addMenu = function (e) {
  function t() {
    e.label && i.prevItems.push(i.curItems);
    i._addItems(e.item);
  }
  var i = this,
    n = this.replaceSymbols(e.label || "");
  n += " >";
  this.container.appendChild(new h({
    text: n,
    className: "cmButton"
  }, t));
};
a.prototype._addSendChat = function (e) {
  function t() {
    var e = window.gui.chat.chatInput;
    e.sendChatCommand(o);
    i.close();
  }
  var i = this,
    n = this.replaceSymbols(e.label),
    o = this.replaceSymbols(e.command);
  this.container.appendChild(new h({
    text: n,
    className: "cmButton"
  }, t));
};
a.prototype._addSendCommand = function (e) {
  function t() {
    var e = p.getWindow("adminConsole");
    p.open("adminConsole");
    e.runCommand(o);
    i.close();
  }
  var i = this,
    n = this.replaceSymbols(e.label),
    o = this.replaceSymbols(e.command);
  this.container.appendChild(new h({
    text: n,
    className: "cmButton"
  }, t));
};
a.prototype._addPrepareCommand = function (e) {
  function t() {
    var e = p.getWindow("adminConsole");
    p.open("adminConsole");
    e.cmdInput.setValue(o);
    i.close();
  }
  var i = this,
    n = this.replaceSymbols(e.label),
    o = this.replaceSymbols(e.command);
  this.targetPlayer.houseId && (o = o.replace("IDHOUSE", this.targetPlayer.houseId));
  this.container.appendChild(new h({
    text: n,
    className: "cmButton"
  }, t));
};
a.prototype._addBatch = function (e) {
  function t() {
    var t,
      n = p.getWindow("adminConsole"),
      o = window.gui.chat.chatInput,
      a = e.item;
    p.open("adminConsole");
    for (var s = 0; s < a.length; s += 1) {
      switch (t = i.replaceSymbols(a[s].command), a[s].type) {
        case "sendChat":
          o.sendChatCommand(t);
          break;
        default:
          n.runCommand(t);
      }
    }
    i.close();
  }
  var i = this,
    n = e.label;
  this.container.appendChild(new h({
    text: n,
    className: "cmButton"
  }, t));
};
a.prototype._addItem = function (e) {
  var t = e.type;
  switch (t) {
    case "startup":
      this._addStartup(e);
      break;
    case "static":
      this._addStatic(e);
      break;
    case "menu":
      this._addMenu(e);
      break;
    case "sendCommand":
      this._addSendCommand(e);
      break;
    case "sendChat":
      this._addSendChat(e);
      break;
    case "prepareCommand":
      this._addPrepareCommand(e);
      break;
    case "batch":
      this._addBatch(e);
  }
};
a.prototype._addItems = function (e) {
  var t = this;
  e && !Array.isArray(e) && (e = [e]);
  t.curItems = e;
  this.container.clearContent();
  for (var i, n = 0; n < e.length; n += 1) {
    i = e[n];
    this._addItem(i);
  }
  this.prevItems.length && this.container.appendChild(new h({
    text: "< " + d("ui.common.back"),
    className: "cmButton"
  }, function () {
    var e = t.prevItems.pop();
    t._addItems(e);
  }));
  this.scroller.refresh();
};
a.prototype.updateContent = function (e) {
  var t = this,
    i = window.gui.playerData.adminMenu.getURL(),
    a = window.gui.playerData.adminMenu.getAdminMenuId();
  if (!i || null === a) {
    return this.close(), e();
  }
  var s = "",
    r = i + a + ".json",
    d = l.MODERATOR_RANK_CUSTOM_EVENT_ONLY[0];
  if (a === d) {
    var u = l.G2_MODERATOR[l.G2_MODERATOR.length - 1];
    s = i + d + ".json";
    r = i + u + ".json";
  }
  var h = [],
    p = null;
  c.series([function (e) {
    window.fetch(r).then(n).then(o).then(function (t) {
      return h = t.menu.item, h && !Array.isArray(h) && (h = [h]), e();
    })["catch"](function (t) {
      return e(t);
    });
  }, function (e) {
    return s ? void window.fetch(s).then(n).then(o).then(function (t) {
      return p = t.item, e();
    })["catch"](function (t) {
      return e(t);
    }) : e();
  }], function (i) {
    return i ? (console.error(i + " when fetching menuUrl: " + r), t.close(), e()) : (s ? t._addItems(h.concat(p)) : t._addItems(h), e());
  });
};
e.label && i.prevItems.push(i.curItems);
i._addItems(e.item);
n += " >";
this.container.appendChild(new h({
  text: n,
  className: "cmButton"
}, t));
e.sendChatCommand(o);
i.close();
p.open("adminConsole");
e.runCommand(o);
i.close();
p.open("adminConsole");
e.cmdInput.setValue(o);
i.close();
this.targetPlayer.houseId && (o = o.replace("IDHOUSE", this.targetPlayer.houseId));
this.container.appendChild(new h({
  text: n,
  className: "cmButton"
}, t));
e && !Array.isArray(e) && (e = [e]);
t.curItems = e;
this.container.clearContent();
i = e[n];
this._addItem(i);
this.prevItems.length && this.container.appendChild(new h({
  text: "< " + d("ui.common.back"),
  className: "cmButton"
}, function () {
  var e = t.prevItems.pop();
  t._addItems(e);
}));
this.scroller.refresh();
s = i + d + ".json";
r = i + u + ".json";
p.call(this, "div", {
  className: "ContextualMenu",
  hidden: !0
});
e = e || {};
this.addClassNames(e.className);
this._position = {};
this.header = this.createChild("div", {
  className: "contextHeader"
});
e.noHeader && this._displayHeader(!1);
this.contextContent = this.createChild("div", {
  className: "contextContent"
});
this.scroller = this.contextContent.appendChild(new d({
  className: "contentScroller"
}, {
  showHintArrows: !0
}));
this.entryList = this.scroller.content.createChild("div", {
  className: "entryList"
});
this.buttonContainer = this.scroller.content.createChild("div", {
  className: "buttonContainer"
});
this.maxHeight = a.screenHeight - 2 * m - (e.noHeader ? 0 : f);
this.requestedHeight = this.maxHeight;
this.currentHeight = 0;
l.on("show", function (e) {
  t._refreshScroller(t.maxHeight - e);
});
l.on("hide", function () {
  t._refreshScroller(t.maxHeight);
});
c(n, p);
e.exports = n;
n.prototype._refreshScroller = function (e) {
  if (void 0 !== e) {
    if (this.requestedHeight = e, !this.isOpen && !this.isOpening) {
      return;
    }
    if (this.requestedHeight === this.currentHeight) {
      return;
    }
  }
  this.currentHeight = this.requestedHeight;
  this.scroller.setStyle("maxHeight", this.currentHeight + "px");
  void 0 === e && this.scroller.goToTop();
  this.scroller.refresh();
};
n.prototype._displayHeader = function (e) {
  this.toggleClassName("noHeader", !e);
  this.header.toggleDisplay(e);
};
n.prototype._setPosition = function (e, t) {
  this._position.x = u.x;
  this._position.y = u.y;
  this.setStyles({
    left: e + "px",
    top: t + 25 + "px"
  });
};
n.prototype._addEntry = function (e, t) {
  var i = this,
    n = this.entryList.appendChild(new o({
      text: e,
      className: "cmButton"
    }, t));
  return n.on("tap", function () {
    i.close();
  }), n;
};
n.prototype._addButton = function (e, t, i) {
  i = i || "";
  var n = this,
    a = this.buttonContainer.appendChild(new o({
      text: i,
      className: t
    }, e));
  return a.on("tap", function () {
    n.close();
  }), a;
};
n.prototype._addCancel = function () {
  return this._addSeparator(), this._addEntry(s("ui.common.cancel"), function () {});
};
n.prototype._addSeparator = function () {
  this.entryList.createChild("div", {
    className: "separator"
  });
};
n.prototype._openingAnimation = function (e, t) {
  function i() {
    n._tween1 = h.tween(n, {
      webkitTransform: "translate3d(0,-25px,0)",
      opacity: 1
    }, {
      time: 100,
      easing: "ease-out"
    }, function () {
      n._tween1 = null;
    });
    n._tween2 = h.tween(n.entryList, {
      webkitTransform: "translate3d(0,0,0)"
    }, {
      time: 200,
      easing: "cubic-bezier(0,1,0.62,1)"
    }, function () {
      this.setStyle("webkitTransform", "");
      n._tween2 = null;
      n.isOpening = !1;
      n._tween = null;
      n.isOpen = !0;
      n.closeRequest && (n.closeRequest = null, n.close("reopen"));
    });
  }
  if (!this.isOpening) {
    if (this.isOpen) {
      return this.close(), void (this.next = {
        positioningMethod: e,
        params: t
      });
    }
    if (e()) {
      this.isOpening = !0;
      this._tween1 && this._tween1.cancel();
      this._tween2 && this._tween2.cancel();
      this.show();
      this.contextContent.setStyle("overflow", "visible");
      this.entryList.setStyle("webkitTransform", "translate3d(0,-100%,0)");
      var n = this;
      this.emit("open", t, function () {
        n._refreshScroller();
        var t = e();
        n._setPosition(t.x, t.y);
        n.contextContent.setStyle("overflow", "hidden");
        window.setTimeout(i, 0);
      });
    }
  }
};
n.prototype.openAt = function (e, t, i) {
  var n = this;
  this._openingAnimation(function () {
    return r.getElementPositionAt(n, e, t);
  }, i);
};
n.prototype.openAround = function (e, t) {
  var i = this;
  this._openingAnimation(function () {
    return i.rootElement && e.rootElement ? r.getElementPositionAround(i, e) : null;
  }, t);
};
n.prototype.close = function (e) {
  if (this.isOpening) {
    return void (this.closeRequest = !0);
  }
  if (!this.isClosing && this.isOpen) {
    this.isClosing = !0;
    this._tween1 && this._tween1.cancel();
    this._tween2 && this._tween2.cancel();
    var t = this;
    this.emit("close", e);
    this._tween1 = h.tween(this.entryList, {
      webkitTransform: "translate3d(0,-100%,0)"
    }, {
      time: 200,
      easing: "ease-out"
    }, function () {
      t._tween1 = null;
      t.isClosing = !1;
      t.isOpen = !1;
      t.next && (t._openingAnimation(t.next.positioningMethod, t.next.params), t.next = null);
    });
    this._tween2 = h.tween(this, {
      webkitTransform: "translate3d(0,0,0)",
      opacity: 0
    }, {
      delay: 100,
      time: 100,
      easing: "ease-out"
    }, function () {
      t.hide();
      t._tween2 = null;
    });
  }
};
this.currentHeight = this.requestedHeight;
this.scroller.setStyle("maxHeight", this.currentHeight + "px");
void 0 === e && this.scroller.goToTop();
this.scroller.refresh();
this.toggleClassName("noHeader", !e);
this.header.toggleDisplay(e);
this._position.x = u.x;
this._position.y = u.y;
this.setStyles({
  left: e + "px",
  top: t + 25 + "px"
});
n._tween1 = h.tween(n, {
  webkitTransform: "translate3d(0,-25px,0)",
  opacity: 1
}, {
  time: 100,
  easing: "ease-out"
}, function () {
  n._tween1 = null;
});
n._tween2 = h.tween(n.entryList, {
  webkitTransform: "translate3d(0,0,0)"
}, {
  time: 200,
  easing: "cubic-bezier(0,1,0.62,1)"
}, function () {
  this.setStyle("webkitTransform", "");
  n._tween2 = null;
  n.isOpening = !1;
  n._tween = null;
  n.isOpen = !0;
  n.closeRequest && (n.closeRequest = null, n.close("reopen"));
});
this.setStyle("webkitTransform", "");
n._tween2 = null;
n.isOpening = !1;
n._tween = null;
n.isOpen = !0;
n.closeRequest && (n.closeRequest = null, n.close("reopen"));
this.isOpening = !0;
this._tween1 && this._tween1.cancel();
this._tween2 && this._tween2.cancel();
this.show();
this.contextContent.setStyle("overflow", "visible");
this.entryList.setStyle("webkitTransform", "translate3d(0,-100%,0)");
n._setPosition(t.x, t.y);
n.contextContent.setStyle("overflow", "hidden");
window.setTimeout(i, 0);
this.isClosing = !0;
this._tween1 && this._tween1.cancel();
this._tween2 && this._tween2.cancel();
this.emit("close", e);
this._tween1 = h.tween(this.entryList, {
  webkitTransform: "translate3d(0,-100%,0)"
}, {
  time: 200,
  easing: "ease-out"
}, function () {
  t._tween1 = null;
  t.isClosing = !1;
  t.isOpen = !1;
  t.next && (t._openingAnimation(t.next.positioningMethod, t.next.params), t.next = null);
});
this._tween2 = h.tween(this, {
  webkitTransform: "translate3d(0,0,0)",
  opacity: 0
}, {
  delay: 100,
  time: 100,
  easing: "ease-out"
}, function () {
  t.hide();
  t._tween2 = null;
});
t._tween1 = null;
t.isClosing = !1;
t.isOpen = !1;
t.next && (t._openingAnimation(t.next.positioningMethod, t.next.params), t.next = null);
t.hide();
t._tween2 = null;
"INPUT" === document.activeElement.tagName && document.activeElement.blur();
o.isPhoneGap && (s.plugins.Keyboard.close(), o.isAndroid && m.setStyle("height", ""));
n();
window.addEventListener("native.keyboardshow", function (e) {
  if (o.isAndroid && !h) {
    var t = parseInt(f.getStyle("height"), 10),
      i = screen.availHeight * devicePixelRatio,
      n = i - e.keyboardHeight * devicePixelRatio,
      a = n / (i / t);
    m.setStyle("height", a + "px");
    var s = document.activeElement;
    "INPUT" !== s.tagName || p || (m.rootElement.scrollLeft = 0, m.rootElement.scrollTop = s.getBoundingClientRect().top);
  }
  d.emit("show", e.keyboardHeight);
});
window.addEventListener("native.keyboardhide", function () {
  o.isAndroid && m.setStyle("height", "");
  var e = "INPUT" === document.activeElement.tagName && document.activeElement;
  setTimeout(function () {
    n();
    var t = "INPUT" === document.activeElement.tagName;
    t && e !== document.activeElement || (h = !1, d.emit("hide"), e && document.activeElement.blur());
  }, 0);
});
m.call(this, "div", e);
this.addClassNames("Scroller");
t = t || {};
o && (a = i ? "vertical" : "horizontal");
this.iScroll = new h(this.rootElement, {
  bindToWrapper: o,
  scrollbars: "custom",
  fadeScrollbars: !1,
  bounce: t.bounce,
  maxSpeed: t.maxSpeed,
  eventPassthrough: a,
  scrollX: i,
  scrollY: !i,
  mouseWheel: !0,
  preventDefault: !1,
  directionLockThreshold: g,
  disablePointer: !0
});
this.iScroll.myScroller = this;
this.on("destroy", this._destroyHandler);
t.showHintArrows && (this.scrollUpHint = this.createChild("div", {
  className: "scrollUpHint"
}), this.scrollDownHint = this.createChild("div", {
  className: "scrollDownHint"
}), this.notifyInterval = null, this.notifyCount = 0);
this.isEnable = !0;
this._isListeningToLostHandle = !1;
this._onLostHandle = null;
window.setTimeout(function () {
  s.refresh();
}, w);
this._setupEventListeners();
e._refreshHints();
e.emit("scrollEnd");
this.requestRefresh && this.refresh(!0);
this._isListeningToLostHandle || (f.pauseScrollAndroid(!0), this._isListeningToLostHandle = !0, this._onLostHandle = this._onLostHandle || r.bind(this), u.once("handleTaken", this._onLostHandle));
u.removeListener("handleTaken", this._onLostHandle);
this._isListeningToLostHandle = !1;
f.pauseScrollAndroid(!1);
this.isEnable && this.iScroll.enable();
p(n, m);
n.ease = h.utils.ease;
n.prototype._destroyHandler = function () {
  window.clearInterval(this.notifyInterval);
  this.iScroll.destroy();
};
n.prototype._setupEventListeners = function () {
  this.allowDomEvents();
  this.on("dom.touchstart", l);
  this.on("dom.touchend", c);
  this.iScroll.on("scrollStart", o);
  this.iScroll.on("scrollEnd", a);
  this.iScroll.on("scrollCancel", s);
};
n.prototype._refreshHints = function () {
  this.scrollUpHint && (this.scrollUpHint.toggleDisplay(this.canScrollUp(_)), this.scrollDownHint.toggleDisplay(this.canScrollDown(_)));
};
n.prototype.cancel = function () {
  return d.isFeatureOn("scrollerBoundToWrapper") ? void this.iScroll.cancel() : void this.iScroll.disable();
};
n.prototype.refresh = function (e) {
  if (this.rootElement) {
    if (!e && 0 === this.rootElement.clientHeight) {
      return void (this.requestRefresh = !0);
    }
    this.iScroll.refresh();
    this.toggleClassName("scrollBgVisible", this.iScroll.hasVerticalScroll || this.iScroll.hasHorizontalScroll);
    this._refreshHints();
    this.requestRefresh = !1;
  }
};
n.prototype.notify = function () {
  if (this.scrollUpHint && this.canScrollDown() && (this.notifyCount = y, !this.notifyInterval)) {
    var e = this;
    this.notifyInterval = window.setInterval(function () {
      e.scrollDownHint.toggleDisplay();
      e.notifyCount--;
      e.notifyCount > 0 || (window.clearInterval(e.notifyInterval), e.notifyInterval = null, e._refreshHints());
    }, v);
  }
};
n.prototype.scrollToElement = function (e, t, i, n, o) {
  this.iScroll.scrollToElement(e.rootElement, t, i, n, o);
  t || this._refreshHints();
};
n.prototype.showElement = function (e, t, i) {
  var n = this.iScroll,
    o = e.rootElement;
  o = o.nodeType ? o : n.scroller.querySelector(o);
  var a = h.utils.offset(o);
  a.left -= n.wrapperOffset.left;
  a.top -= n.wrapperOffset.top;
  var s = o.offsetHeight,
    r = o.offsetWidth;
  a.top < n.y && s <= n.wrapperHeight && (a.top = Math.min(a.top - s + n.wrapperHeight, n.y));
  a.left < n.x && r <= n.wrapperWidth && (a.left = Math.min(a.left - r + n.wrapperWidth, n.x));
  a.left = Math.min(0, Math.max(n.maxScrollX, a.left));
  a.top = Math.min(0, Math.max(n.maxScrollY, a.top));
  a.left === n.x && a.top === n.y || (t = void 0 === t || null === t || "auto" === t ? Math.max(Math.abs(n.x - a.left), Math.abs(n.y - a.top)) : t, this.scrollTo(a.left, a.top, t, i));
};
n.prototype.scrollTo = function (e, t, i, n) {
  this.iScroll.scrollTo(e, t, i, n);
  i || this._refreshHints();
};
n.prototype.scrollBy = function (e, t, i, n) {
  this.iScroll.scrollBy(e, t, i, n);
  i || this._refreshHints();
};
n.prototype.setEnable = function (e) {
  e ? this.iScroll.enable() : this.iScroll.disable();
  this.isEnable = e;
};
n.prototype.canScrollUp = function (e) {
  return e = e || 1, this.iScroll.options.scrollY ? this.iScroll.y <= -e : this.iScroll.x <= -e;
};
n.prototype.canScrollDown = function (e) {
  return e = e || 1, this.iScroll.options.scrollY ? this.iScroll.maxScrollY - this.iScroll.y <= -e : this.iScroll.maxScrollX - this.iScroll.x <= -e;
};
n.prototype.goToTop = function (e, t) {
  return this.iScroll.options.scrollY ? this.scrollTo(this.iScroll.x, 0, e, t) : void this.scrollTo(0, this.iScroll.y, e, t);
};
n.prototype.goToBottom = function (e, t) {
  return this.iScroll.options.scrollY ? this.scrollTo(this.iScroll.x, this.iScroll.maxScrollY, e, t) : void this.scrollTo(this.iScroll.maxScrollX, this.iScroll.y, e, t);
};
n.prototype.getScrollPosition = function () {
  return {
    x: this.iScroll.x,
    y: this.iScroll.y
  };
};
e.exports = n;
window.clearInterval(this.notifyInterval);
this.iScroll.destroy();
this.allowDomEvents();
this.on("dom.touchstart", l);
this.on("dom.touchend", c);
this.iScroll.on("scrollStart", o);
this.iScroll.on("scrollEnd", a);
this.iScroll.on("scrollCancel", s);
this.iScroll.refresh();
this.toggleClassName("scrollBgVisible", this.iScroll.hasVerticalScroll || this.iScroll.hasHorizontalScroll);
this._refreshHints();
this.requestRefresh = !1;
e.scrollDownHint.toggleDisplay();
e.notifyCount--;
e.notifyCount > 0 || (window.clearInterval(e.notifyInterval), e.notifyInterval = null, e._refreshHints());
this.iScroll.scrollToElement(e.rootElement, t, i, n, o);
t || this._refreshHints();
a.left -= n.wrapperOffset.left;
a.top -= n.wrapperOffset.top;
a.top < n.y && s <= n.wrapperHeight && (a.top = Math.min(a.top - s + n.wrapperHeight, n.y));
a.left < n.x && r <= n.wrapperWidth && (a.left = Math.min(a.left - r + n.wrapperWidth, n.x));
a.left = Math.min(0, Math.max(n.maxScrollX, a.left));
a.top = Math.min(0, Math.max(n.maxScrollY, a.top));
a.left === n.x && a.top === n.y || (t = void 0 === t || null === t || "auto" === t ? Math.max(Math.abs(n.x - a.left), Math.abs(n.y - a.top)) : t, this.scrollTo(a.left, a.top, t, i));
this.iScroll.scrollTo(e, t, i, n);
i || this._refreshHints();
this.iScroll.scrollBy(e, t, i, n);
i || this._refreshHints();
e ? this.iScroll.enable() : this.iScroll.disable();
this.isEnable = e;
this.wrapper = "string" == typeof e ? i.querySelector(e) : e;
this.scroller = this.wrapper.children[0];
this.scrollerStyle = this.scroller.style;
this.options = {
  resizeScrollbars: !0,
  mouseWheelSpeed: 20,
  snapThreshold: .334,
  startX: 0,
  startY: 0,
  scrollY: !0,
  directionLockThreshold: 5,
  momentum: !0,
  bounce: !0,
  bounceTime: 600,
  bounceEasing: "",
  preventDefault: !0,
  preventDefaultException: {
    tagName: /^(INPUT|TEXTAREA|BUTTON|SELECT)$/
  },
  HWCompositing: !0,
  useTransition: !0,
  useTransform: !0
};
this.translateZ = this.options.HWCompositing && l.hasPerspective ? " translateZ(0)" : "";
this.options.useTransition = l.hasTransition && this.options.useTransition;
this.options.useTransform = l.hasTransform && this.options.useTransform;
this.options.eventPassthrough = this.options.eventPassthrough === !0 ? "vertical" : this.options.eventPassthrough;
this.options.preventDefault = !this.options.eventPassthrough && this.options.preventDefault;
this.options.scrollY = "vertical" != this.options.eventPassthrough && this.options.scrollY;
this.options.scrollX = "horizontal" != this.options.eventPassthrough && this.options.scrollX;
this.options.freeScroll = this.options.freeScroll && !this.options.eventPassthrough;
this.options.directionLockThreshold = this.options.eventPassthrough ? 0 : this.options.directionLockThreshold;
this.options.bounceEasing = "string" == typeof this.options.bounceEasing ? l.ease[this.options.bounceEasing] || l.ease.circular : this.options.bounceEasing;
this.options.resizePolling = void 0 === this.options.resizePolling ? 60 : this.options.resizePolling;
this.options.tap === !0 && (this.options.tap = "tap");
"scale" == this.options.shrinkScrollbars && (this.options.useTransition = !1);
this.options.invertWheelDirection = this.options.invertWheelDirection ? -1 : 1;
this.x = 0;
this.y = 0;
this.directionX = 0;
this.directionY = 0;
this._events = {};
this._init();
this.refresh();
this.scrollTo(this.options.startX, this.options.startY);
this.enable();
this.wrapper = "string" == typeof n.el ? i.querySelector(n.el) : n.el;
this.wrapperStyle = this.wrapper.style;
this.indicator = this.wrapper.children[0];
this.indicatorStyle = this.indicator.style;
this.scroller = e;
this.options = {
  listenX: !0,
  listenY: !0,
  interactive: !1,
  resize: !0,
  defaultScrollbars: !1,
  shrink: !1,
  fade: !1,
  speedRatioX: 0,
  speedRatioY: 0
};
this.sizeRatioX = 1;
this.sizeRatioY = 1;
this.maxPosX = 0;
this.maxPosY = 0;
this.options.interactive && (this.options.disableTouch || (l.addEvent(this.indicator, "touchstart", this), l.addEvent(t, "touchend", this)), this.options.disablePointer || (l.addEvent(this.indicator, l.prefixPointerEvent("pointerdown"), this), l.addEvent(t, l.prefixPointerEvent("pointerup"), this)), this.options.disableMouse || (l.addEvent(this.indicator, "mousedown", this), l.addEvent(t, "mouseup", this)));
this.options.fade && (this.wrapperStyle[l.style.transform] = this.scroller.translateZ, this.wrapperStyle[l.style.transitionDuration] = l.isBadAndroid ? "0.001s" : "0ms", this.wrapperStyle.opacity = "0");
o.getTime = Date.now || function () {
  return new Date().getTime();
};
o.extend = function (e, t) {
  for (var i in t) {
    e[i] = t[i];
  }
};
o.addEvent = function (e, t, i, n) {
  e.addEventListener(t, i, !!n);
};
o.removeEvent = function (e, t, i, n) {
  e.removeEventListener(t, i, !!n);
};
o.prefixPointerEvent = function (e) {
  return t.MSPointerEvent ? "MSPointer" + e.charAt(9).toUpperCase() + e.substr(10) : e;
};
o.momentum = function (e, t, i, o, a, s, r) {
  var l,
    c,
    d = e - t,
    u = n.abs(d) / i;
  return r && u > r && (u = r), s = void 0 === s ? 6e-4 : s, l = e + u * u / (2 * s) * (d < 0 ? -1 : 1), c = u / s, l < o ? (l = a ? o - a / 2.5 * (u / 8) : o, d = n.abs(l - e), c = d / u) : l > 0 && (l = a ? a / 2.5 * (u / 8) : 0, d = n.abs(e) + l, c = d / u), {
    destination: n.round(l),
    duration: c
  };
};
i.push(t);
e.className = i.join(" ");
t -= e.offsetLeft;
i -= e.offsetTop;
n.initEvent(t, !0, !0);
n.pageX = e.pageX;
n.pageY = e.pageY;
e.target.dispatchEvent(n);
o.prototype = {
  version: "5.1.3",
  _init: function () {
    this._initEvents();
    (this.options.scrollbars || this.options.indicators) && this._initIndicators();
    this.options.mouseWheel && this._initWheel();
    this.options.snap && this._initSnap();
    this.options.keyBindings && this._initKeys();
  },
  destroy: function () {
    this._initEvents(!0);
    this._execEvent("destroy");
  },
  _transitionEnd: function (e) {
    e.target == this.scroller && this.isInTransition && (this._transitionTime(), this.resetPosition(this.options.bounceTime) || (this.isInTransition = !1, this._execEvent("scrollEnd")));
  },
  _start: function (e) {
    if ((1 == l.eventType[e.type] || 0 === e.button) && this.enabled && (!this.initiated || l.eventType[e.type] === this.initiated)) {
      !this.options.preventDefault || l.isBadAndroid || l.preventDefaultException(e.target, this.options.preventDefaultException) || e.preventDefault();
      var t,
        i = e.touches ? e.touches[0] : e;
      this.initiated = l.eventType[e.type];
      this.moved = !1;
      this.distX = 0;
      this.distY = 0;
      this.directionX = 0;
      this.directionY = 0;
      this.directionLocked = 0;
      this._transitionTime();
      this.startTime = l.getTime();
      this.options.useTransition && this.isInTransition ? (this.isInTransition = !1, t = this.getComputedPosition(), this._translate(n.round(t.x), n.round(t.y)), this._execEvent("scrollEnd")) : !this.options.useTransition && this.isAnimating && (this.isAnimating = !1, this._execEvent("scrollEnd"));
      this.startX = this.x;
      this.startY = this.y;
      this.absStartX = this.x;
      this.absStartY = this.y;
      this.pointX = i.pageX;
      this.pointY = i.pageY;
      this._execEvent("beforeScrollStart");
    }
  },
  _move: function (e) {
    if (this.enabled && l.eventType[e.type] === this.initiated) {
      this.options.preventDefault && e.preventDefault();
      var t,
        i,
        o,
        a,
        s = e.touches ? e.touches[0] : e,
        r = s.pageX - this.pointX,
        c = s.pageY - this.pointY,
        d = l.getTime();
      if (this.pointX = s.pageX, this.pointY = s.pageY, this.distX += r, this.distY += c, o = n.abs(this.distX), a = n.abs(this.distY), !(d - this.endTime > 300 && o < 10 && a < 10)) {
        if (this.directionLocked || this.options.freeScroll || (o > a + this.options.directionLockThreshold ? this.directionLocked = "h" : a >= o + this.options.directionLockThreshold ? this.directionLocked = "v" : this.directionLocked = "n"), "h" == this.directionLocked) {
          if ("vertical" == this.options.eventPassthrough) {
            e.preventDefault();
          } else if ("horizontal" == this.options.eventPassthrough) {
            return void (this.initiated = !1);
          }
          c = 0;
        } else if ("v" == this.directionLocked) {
          if ("horizontal" == this.options.eventPassthrough) {
            e.preventDefault();
          } else if ("vertical" == this.options.eventPassthrough) {
            return void (this.initiated = !1);
          }
          r = 0;
        }
        r = this.hasHorizontalScroll ? r : 0;
        c = this.hasVerticalScroll ? c : 0;
        t = this.x + r;
        i = this.y + c;
        (t > 0 || t < this.maxScrollX) && (t = this.options.bounce ? this.x + r / 3 : t > 0 ? 0 : this.maxScrollX);
        (i > 0 || i < this.maxScrollY) && (i = this.options.bounce ? this.y + c / 3 : i > 0 ? 0 : this.maxScrollY);
        this.directionX = r > 0 ? -1 : r < 0 ? 1 : 0;
        this.directionY = c > 0 ? -1 : c < 0 ? 1 : 0;
        this.moved || this._execEvent("scrollStart");
        this.moved = !0;
        this._translate(t, i);
        d - this.startTime > 300 && (this.startTime = d, this.startX = this.x, this.startY = this.y);
      }
    }
  },
  _end: function (e) {
    if (this.enabled && l.eventType[e.type] === this.initiated) {
      this.options.preventDefault && !l.preventDefaultException(e.target, this.options.preventDefaultException) && e.preventDefault();
      var t,
        i,
        o = (e.changedTouches ? e.changedTouches[0] : e, l.getTime() - this.startTime),
        a = n.round(this.x),
        s = n.round(this.y),
        r = n.abs(a - this.startX),
        c = n.abs(s - this.startY),
        d = 0,
        u = "";
      if (this.isInTransition = 0, this.initiated = 0, this.endTime = l.getTime(), !this.resetPosition(this.options.bounceTime)) {
        if (this.scrollTo(a, s), !this.moved) {
          return this.options.tap && l.tap(e, this.options.tap), this.options.click && l.click(e), void this._execEvent("scrollCancel");
        }
        if (this._events.flick && o < 200 && r < 100 && c < 100) {
          return void this._execEvent("flick");
        }
        if (this.options.momentum && o < 300 && (t = this.hasHorizontalScroll ? l.momentum(this.x, this.startX, o, this.maxScrollX, this.options.bounce ? this.wrapperWidth : 0, this.options.deceleration, this.options.maxSpeed) : {
          destination: a,
          duration: 0
        }, i = this.hasVerticalScroll ? l.momentum(this.y, this.startY, o, this.maxScrollY, this.options.bounce ? this.wrapperHeight : 0, this.options.deceleration, this.options.maxSpeed) : {
          destination: s,
          duration: 0
        }, a = t.destination, s = i.destination, d = n.max(t.duration, i.duration), this.isInTransition = 1), this.options.snap) {
          var h = this._nearestSnap(a, s);
          this.currentPage = h;
          d = this.options.snapSpeed || n.max(n.max(n.min(n.abs(a - h.x), 1e3), n.min(n.abs(s - h.y), 1e3)), 300);
          a = h.x;
          s = h.y;
          this.directionX = 0;
          this.directionY = 0;
          u = this.options.bounceEasing;
        }
        return a != this.x || s != this.y ? ((a > 0 || a < this.maxScrollX || s > 0 || s < this.maxScrollY) && (u = l.ease.quadratic), void this.scrollTo(a, s, d, u)) : void this._execEvent("scrollEnd");
      }
    }
  },
  _resize: function () {
    var e = this;
    clearTimeout(this.resizeTimeout);
    this.resizeTimeout = setTimeout(function () {
      e.refresh();
    }, this.options.resizePolling);
  },
  resetPosition: function (e) {
    var t = this.x,
      i = this.y;
    return e = e || 0, !this.hasHorizontalScroll || this.x > 0 ? t = 0 : this.x < this.maxScrollX && (t = this.maxScrollX), !this.hasVerticalScroll || this.y > 0 ? i = 0 : this.y < this.maxScrollY && (i = this.maxScrollY), (t != this.x || i != this.y) && (this.scrollTo(t, i, e, this.options.bounceEasing), !0);
  },
  cancel: function () {
    this.enabled = !1;
    this.initiated = !1;
  },
  disable: function () {
    this.enabled = !1;
  },
  enable: function () {
    this.enabled = !0;
  },
  refresh: function () {
    this.wrapper.offsetHeight;
    this.wrapperWidth = this.wrapper.clientWidth;
    this.wrapperHeight = this.wrapper.clientHeight;
    this.scrollerWidth = this.scroller.offsetWidth;
    this.scrollerHeight = this.scroller.offsetHeight;
    this.maxScrollX = this.wrapperWidth - this.scrollerWidth;
    this.maxScrollY = this.wrapperHeight - this.scrollerHeight;
    this.hasHorizontalScroll = this.options.scrollX && this.maxScrollX < 0;
    this.hasVerticalScroll = this.options.scrollY && this.maxScrollY < 0;
    this.hasHorizontalScroll || (this.maxScrollX = 0, this.scrollerWidth = this.wrapperWidth);
    this.hasVerticalScroll || (this.maxScrollY = 0, this.scrollerHeight = this.wrapperHeight);
    this.endTime = 0;
    this.directionX = 0;
    this.directionY = 0;
    this.wrapperOffset = l.offset(this.wrapper);
    this._execEvent("refresh");
    this.resetPosition();
  },
  on: function (e, t) {
    this._events[e] || (this._events[e] = []);
    this._events[e].push(t);
  },
  off: function (e, t) {
    if (this._events[e]) {
      var i = this._events[e].indexOf(t);
      i > -1 && this._events[e].splice(i, 1);
    }
  },
  _execEvent: function (e) {
    if (this._events[e]) {
      var t = 0,
        i = this._events[e].length;
      if (i) {
        for (; t < i; t++) {
          this._events[e][t].apply(this, [].slice.call(arguments, 1));
        }
      }
    }
  },
  scrollBy: function (e, t, i, n) {
    e = this.x + e;
    t = this.y + t;
    i = i || 0;
    this.scrollTo(e, t, i, n);
  },
  scrollTo: function (e, t, i, n) {
    n = n || l.ease.circular;
    this.isInTransition = this.options.useTransition && i > 0;
    !i || this.options.useTransition && n.style ? (this._transitionTimingFunction(n.style), this._transitionTime(i), this._translate(e, t)) : this._animate(e, t, i, n.fn);
  },
  scrollToElement: function (e, t, i, o, a) {
    if (e = e.nodeType ? e : this.scroller.querySelector(e)) {
      var s = l.offset(e);
      s.left -= this.wrapperOffset.left;
      s.top -= this.wrapperOffset.top;
      i === !0 && (i = n.round(e.offsetWidth / 2 - this.wrapper.offsetWidth / 2));
      o === !0 && (o = n.round(e.offsetHeight / 2 - this.wrapper.offsetHeight / 2));
      s.left -= i || 0;
      s.top -= o || 0;
      s.left = s.left > 0 ? 0 : s.left < this.maxScrollX ? this.maxScrollX : s.left;
      s.top = s.top > 0 ? 0 : s.top < this.maxScrollY ? this.maxScrollY : s.top;
      t = void 0 === t || null === t || "auto" === t ? n.max(n.abs(this.x - s.left), n.abs(this.y - s.top)) : t;
      this.scrollTo(s.left, s.top, t, a);
    }
  },
  _transitionTime: function (e) {
    if (e = e || 0, this.scrollerStyle[l.style.transitionDuration] = e + "ms", !e && l.isBadAndroid && (this.scrollerStyle[l.style.transitionDuration] = "0.001s"), this.indicators) {
      for (var t = this.indicators.length; t--;) {
        this.indicators[t].transitionTime(e);
      }
    }
  },
  _transitionTimingFunction: function (e) {
    if (this.scrollerStyle[l.style.transitionTimingFunction] = e, this.indicators) {
      for (var t = this.indicators.length; t--;) {
        this.indicators[t].transitionTimingFunction(e);
      }
    }
  },
  _translate: function (e, t) {
    if (this.options.useTransform ? this.scrollerStyle[l.style.transform] = "translate(" + e + "px," + t + "px)" + this.translateZ : (e = n.round(e), t = n.round(t), this.scrollerStyle.left = e + "px", this.scrollerStyle.top = t + "px"), this.x = e, this.y = t, this.indicators) {
      for (var i = this.indicators.length; i--;) {
        this.indicators[i].updatePosition();
      }
    }
  },
  _initEvents: function (e) {
    var i = e ? l.removeEvent : l.addEvent,
      n = this.options.bindToWrapper ? this.wrapper : t;
    i(t, "orientationchange", this);
    i(t, "resize", this);
    this.options.click && i(this.wrapper, "click", this, !0);
    this.options.disableMouse || (i(this.wrapper, "mousedown", this), i(n, "mousemove", this), i(n, "mousecancel", this), i(n, "mouseup", this));
    l.hasPointer && !this.options.disablePointer && (i(this.wrapper, l.prefixPointerEvent("pointerdown"), this), i(n, l.prefixPointerEvent("pointermove"), this), i(n, l.prefixPointerEvent("pointercancel"), this), i(n, l.prefixPointerEvent("pointerup"), this));
    l.hasTouch && !this.options.disableTouch && (i(this.wrapper, "touchstart", this), i(n, "touchmove", this), i(n, "touchcancel", this), i(n, "touchend", this));
    i(this.scroller, "transitionend", this);
    i(this.scroller, "webkitTransitionEnd", this);
    i(this.scroller, "oTransitionEnd", this);
    i(this.scroller, "MSTransitionEnd", this);
  },
  getComputedPosition: function () {
    var e,
      i,
      n = t.getComputedStyle(this.scroller, null);
    return this.options.useTransform ? (n = n[l.style.transform].split(")")[0].split(", "), e = +(n[12] || n[4]), i = +(n[13] || n[5])) : (e = +n.left.replace(/[^-\d.]/g, ""), i = +n.top.replace(/[^-\d.]/g, "")), {
      x: e,
      y: i
    };
  },
  _initIndicators: function () {
    function e(e) {
      if (r.indicators) {
        for (var t = r.indicators.length; t--;) {
          e.call(r.indicators[t]);
        }
      }
    }
    var t,
      i = this.options.interactiveScrollbars,
      n = "string" != typeof this.options.scrollbars,
      o = [],
      r = this;
    this.indicators = [];
    this.options.scrollbars && (this.options.scrollY && (t = {
      el: a("v", i, this.options.scrollbars),
      interactive: i,
      defaultScrollbars: !0,
      customStyle: n,
      resize: this.options.resizeScrollbars,
      shrink: this.options.shrinkScrollbars,
      fade: this.options.fadeScrollbars,
      listenX: !1
    }, this.wrapper.appendChild(t.el), o.push(t)), this.options.scrollX && (t = {
      el: a("h", i, this.options.scrollbars),
      interactive: i,
      defaultScrollbars: !0,
      customStyle: n,
      resize: this.options.resizeScrollbars,
      shrink: this.options.shrinkScrollbars,
      fade: this.options.fadeScrollbars,
      listenY: !1
    }, this.wrapper.appendChild(t.el), o.push(t)));
    this.options.indicators && (o = o.concat(this.options.indicators));
    for (var l = o.length; l--;) {
      this.indicators.push(new s(this, o[l]));
    }
    this.options.fadeScrollbars && (this.on("scrollEnd", function () {
      e(function () {
        this.fade();
      });
    }), this.on("scrollCancel", function () {
      e(function () {
        this.fade();
      });
    }), this.on("scrollStart", function () {
      e(function () {
        this.fade(1);
      });
    }), this.on("beforeScrollStart", function () {
      e(function () {
        this.fade(1, !0);
      });
    }));
    this.on("refresh", function () {
      e(function () {
        this.refresh();
      });
    });
    this.on("destroy", function () {
      e(function () {
        this.destroy();
      });
      delete this.indicators;
    });
  },
  _initWheel: function () {
    l.addEvent(this.wrapper, "wheel", this);
    l.addEvent(this.wrapper, "mousewheel", this);
    l.addEvent(this.wrapper, "DOMMouseScroll", this);
    this.on("destroy", function () {
      l.removeEvent(this.wrapper, "wheel", this);
      l.removeEvent(this.wrapper, "mousewheel", this);
      l.removeEvent(this.wrapper, "DOMMouseScroll", this);
    });
  },
  _wheel: function (e) {
    if (this.enabled) {
      e.preventDefault();
      e.stopPropagation();
      var t,
        i,
        o,
        a,
        s = this;
      if (void 0 === this.wheelTimeout && s._execEvent("scrollStart"), clearTimeout(this.wheelTimeout), this.wheelTimeout = setTimeout(function () {
        s._execEvent("scrollEnd");
        s.wheelTimeout = void 0;
      }, 400), "deltaX" in e) {
        1 === e.deltaMode ? (t = -e.deltaX * this.options.mouseWheelSpeed, i = -e.deltaY * this.options.mouseWheelSpeed) : (t = -e.deltaX, i = -e.deltaY);
      } else if ("wheelDeltaX" in e) {
        t = e.wheelDeltaX / 120 * this.options.mouseWheelSpeed;
        i = e.wheelDeltaY / 120 * this.options.mouseWheelSpeed;
      } else if ("wheelDelta" in e) {
        t = i = e.wheelDelta / 120 * this.options.mouseWheelSpeed;
      } else {
        if (!("detail" in e)) {
          return;
        }
        t = i = -e.detail / 3 * this.options.mouseWheelSpeed;
      }
      if (t *= this.options.invertWheelDirection, i *= this.options.invertWheelDirection, this.hasVerticalScroll || (t = i, i = 0), this.options.snap) {
        return o = this.currentPage.pageX, a = this.currentPage.pageY, t > 0 ? o-- : t < 0 && o++, i > 0 ? a-- : i < 0 && a++, void this.goToPage(o, a);
      }
      o = this.x + n.round(this.hasHorizontalScroll ? t : 0);
      a = this.y + n.round(this.hasVerticalScroll ? i : 0);
      o > 0 ? o = 0 : o < this.maxScrollX && (o = this.maxScrollX);
      a > 0 ? a = 0 : a < this.maxScrollY && (a = this.maxScrollY);
      this.scrollTo(o, a, 0);
    }
  },
  _initSnap: function () {
    this.currentPage = {};
    "string" == typeof this.options.snap && (this.options.snap = this.scroller.querySelectorAll(this.options.snap));
    this.on("refresh", function () {
      var e,
        t,
        i,
        o,
        a,
        s,
        r = 0,
        l = 0,
        c = 0,
        d = this.options.snapStepX || this.wrapperWidth,
        u = this.options.snapStepY || this.wrapperHeight;
      if (this.pages = [], this.wrapperWidth && this.wrapperHeight && this.scrollerWidth && this.scrollerHeight) {
        if (this.options.snap === !0) {
          for (i = n.round(d / 2), o = n.round(u / 2); c > -this.scrollerWidth;) {
            for (this.pages[r] = [], e = 0, a = 0; a > -this.scrollerHeight;) {
              this.pages[r][e] = {
                x: n.max(c, this.maxScrollX),
                y: n.max(a, this.maxScrollY),
                width: d,
                height: u,
                cx: c - i,
                cy: a - o
              };
              a -= u;
              e++;
            }
            c -= d;
            r++;
          }
        } else {
          for (s = this.options.snap, e = s.length, t = -1; r < e; r++) {
            (0 === r || s[r].offsetLeft <= s[r - 1].offsetLeft) && (l = 0, t++);
            this.pages[l] || (this.pages[l] = []);
            c = n.max(-s[r].offsetLeft, this.maxScrollX);
            a = n.max(-s[r].offsetTop, this.maxScrollY);
            i = c - n.round(s[r].offsetWidth / 2);
            o = a - n.round(s[r].offsetHeight / 2);
            this.pages[l][t] = {
              x: c,
              y: a,
              width: s[r].offsetWidth,
              height: s[r].offsetHeight,
              cx: i,
              cy: o
            };
            c > this.maxScrollX && l++;
          }
        }
        this.goToPage(this.currentPage.pageX || 0, this.currentPage.pageY || 0, 0);
        this.options.snapThreshold % 1 === 0 ? (this.snapThresholdX = this.options.snapThreshold, this.snapThresholdY = this.options.snapThreshold) : (this.snapThresholdX = n.round(this.pages[this.currentPage.pageX][this.currentPage.pageY].width * this.options.snapThreshold), this.snapThresholdY = n.round(this.pages[this.currentPage.pageX][this.currentPage.pageY].height * this.options.snapThreshold));
      }
    });
    this.on("flick", function () {
      var e = this.options.snapSpeed || n.max(n.max(n.min(n.abs(this.x - this.startX), 1e3), n.min(n.abs(this.y - this.startY), 1e3)), 300);
      this.goToPage(this.currentPage.pageX + this.directionX, this.currentPage.pageY + this.directionY, e);
    });
  },
  _nearestSnap: function (e, t) {
    if (!this.pages.length) {
      return {
        x: 0,
        y: 0,
        pageX: 0,
        pageY: 0
      };
    }
    var i = 0,
      o = this.pages.length,
      a = 0;
    if (n.abs(e - this.absStartX) < this.snapThresholdX && n.abs(t - this.absStartY) < this.snapThresholdY) {
      return this.currentPage;
    }
    for (e > 0 ? e = 0 : e < this.maxScrollX && (e = this.maxScrollX), t > 0 ? t = 0 : t < this.maxScrollY && (t = this.maxScrollY); i < o; i++) {
      if (e >= this.pages[i][0].cx) {
        e = this.pages[i][0].x;
        break;
      }
    }
    for (o = this.pages[i].length; a < o; a++) {
      if (t >= this.pages[0][a].cy) {
        t = this.pages[0][a].y;
        break;
      }
    }
    return i == this.currentPage.pageX && (i += this.directionX, i < 0 ? i = 0 : i >= this.pages.length && (i = this.pages.length - 1), e = this.pages[i][0].x), a == this.currentPage.pageY && (a += this.directionY, a < 0 ? a = 0 : a >= this.pages[0].length && (a = this.pages[0].length - 1), t = this.pages[0][a].y), {
      x: e,
      y: t,
      pageX: i,
      pageY: a
    };
  },
  goToPage: function (e, t, i, o) {
    o = o || this.options.bounceEasing;
    e >= this.pages.length ? e = this.pages.length - 1 : e < 0 && (e = 0);
    t >= this.pages[e].length ? t = this.pages[e].length - 1 : t < 0 && (t = 0);
    var a = this.pages[e][t].x,
      s = this.pages[e][t].y;
    i = void 0 === i ? this.options.snapSpeed || n.max(n.max(n.min(n.abs(a - this.x), 1e3), n.min(n.abs(s - this.y), 1e3)), 300) : i;
    this.currentPage = {
      x: a,
      y: s,
      pageX: e,
      pageY: t
    };
    this.scrollTo(a, s, i, o);
  },
  next: function (e, t) {
    var i = this.currentPage.pageX,
      n = this.currentPage.pageY;
    i++;
    i >= this.pages.length && this.hasVerticalScroll && (i = 0, n++);
    this.goToPage(i, n, e, t);
  },
  prev: function (e, t) {
    var i = this.currentPage.pageX,
      n = this.currentPage.pageY;
    i--;
    i < 0 && this.hasVerticalScroll && (i = 0, n--);
    this.goToPage(i, n, e, t);
  },
  _initKeys: function (e) {
    var i,
      n = {
        pageUp: 33,
        pageDown: 34,
        end: 35,
        home: 36,
        left: 37,
        up: 38,
        right: 39,
        down: 40
      };
    if ("object" == typeof this.options.keyBindings) {
      for (i in this.options.keyBindings) {
        "string" == typeof this.options.keyBindings[i] && (this.options.keyBindings[i] = this.options.keyBindings[i].toUpperCase().charCodeAt(0));
      }
    } else {
      this.options.keyBindings = {};
    }
    for (i in n) {
      this.options.keyBindings[i] = this.options.keyBindings[i] || n[i];
    }
    l.addEvent(t, "keydown", this);
    this.on("destroy", function () {
      l.removeEvent(t, "keydown", this);
    });
  },
  _key: function (e) {
    if (this.enabled) {
      var t,
        i = this.options.snap,
        o = i ? this.currentPage.pageX : this.x,
        a = i ? this.currentPage.pageY : this.y,
        s = l.getTime(),
        r = this.keyTime || 0,
        c = .25;
      switch (this.options.useTransition && this.isInTransition && (t = this.getComputedPosition(), this._translate(n.round(t.x), n.round(t.y)), this.isInTransition = !1), this.keyAcceleration = s - r < 200 ? n.min(this.keyAcceleration + c, 50) : 0, e.keyCode) {
        case this.options.keyBindings.pageUp:
          this.hasHorizontalScroll && !this.hasVerticalScroll ? o += i ? 1 : this.wrapperWidth : a += i ? 1 : this.wrapperHeight;
          break;
        case this.options.keyBindings.pageDown:
          this.hasHorizontalScroll && !this.hasVerticalScroll ? o -= i ? 1 : this.wrapperWidth : a -= i ? 1 : this.wrapperHeight;
          break;
        case this.options.keyBindings.end:
          o = i ? this.pages.length - 1 : this.maxScrollX;
          a = i ? this.pages[0].length - 1 : this.maxScrollY;
          break;
        case this.options.keyBindings.home:
          o = 0;
          a = 0;
          break;
        case this.options.keyBindings.left:
          o += i ? -1 : 5 + this.keyAcceleration >> 0;
          break;
        case this.options.keyBindings.up:
          a += i ? 1 : 5 + this.keyAcceleration >> 0;
          break;
        case this.options.keyBindings.right:
          o -= i ? -1 : 5 + this.keyAcceleration >> 0;
          break;
        case this.options.keyBindings.down:
          a -= i ? 1 : 5 + this.keyAcceleration >> 0;
          break;
        default:
          return;
      }
      if (i) {
        return void this.goToPage(o, a);
      }
      o > 0 ? (o = 0, this.keyAcceleration = 0) : o < this.maxScrollX && (o = this.maxScrollX, this.keyAcceleration = 0);
      a > 0 ? (a = 0, this.keyAcceleration = 0) : a < this.maxScrollY && (a = this.maxScrollY, this.keyAcceleration = 0);
      this.scrollTo(o, a, 0);
      this.keyTime = s;
    }
  },
  _animate: function (e, t, i, n) {
    function o() {
      var h,
        p,
        m,
        f = l.getTime();
      return f >= u ? (a.isAnimating = !1, a._translate(e, t), void (a.resetPosition(a.options.bounceTime) || a._execEvent("scrollEnd"))) : (f = (f - d) / i, m = n(f), h = (e - s) * m + s, p = (t - c) * m + c, a._translate(h, p), void (a.isAnimating && r(o)));
    }
    var a = this,
      s = this.x,
      c = this.y,
      d = l.getTime(),
      u = d + i;
    this.isAnimating = !0;
    o();
  },
  handleEvent: function (e) {
    switch (e.type) {
      case "touchstart":
      case "pointerdown":
      case "MSPointerDown":
      case "mousedown":
        this._start(e);
        break;
      case "touchmove":
      case "pointermove":
      case "MSPointerMove":
      case "mousemove":
        this._move(e);
        break;
      case "touchend":
      case "pointerup":
      case "MSPointerUp":
      case "mouseup":
      case "touchcancel":
      case "pointercancel":
      case "MSPointerCancel":
      case "mousecancel":
        this._end(e);
        break;
      case "orientationchange":
      case "resize":
        this._resize();
        break;
      case "transitionend":
      case "webkitTransitionEnd":
      case "oTransitionEnd":
      case "MSTransitionEnd":
        this._transitionEnd(e);
        break;
      case "wheel":
      case "DOMMouseScroll":
      case "mousewheel":
        this._wheel(e);
        break;
      case "keydown":
        this._key(e);
        break;
      case "click":
        e._constructed || (e.preventDefault(), e.stopPropagation());
    }
  }
};
s.prototype = {
  handleEvent: function (e) {
    switch (e.type) {
      case "touchstart":
      case "pointerdown":
      case "MSPointerDown":
      case "mousedown":
        this._start(e);
        break;
      case "touchmove":
      case "pointermove":
      case "MSPointerMove":
      case "mousemove":
        this._move(e);
        break;
      case "touchend":
      case "pointerup":
      case "MSPointerUp":
      case "mouseup":
      case "touchcancel":
      case "pointercancel":
      case "MSPointerCancel":
      case "mousecancel":
        this._end(e);
    }
  },
  destroy: function () {
    this.options.interactive && (l.removeEvent(this.indicator, "touchstart", this), l.removeEvent(this.indicator, l.prefixPointerEvent("pointerdown"), this), l.removeEvent(this.indicator, "mousedown", this), l.removeEvent(t, "touchmove", this), l.removeEvent(t, l.prefixPointerEvent("pointermove"), this), l.removeEvent(t, "mousemove", this), l.removeEvent(t, "touchend", this), l.removeEvent(t, l.prefixPointerEvent("pointerup"), this), l.removeEvent(t, "mouseup", this));
    this.options.defaultScrollbars && this.wrapper.parentNode.removeChild(this.wrapper);
  },
  _start: function (e) {
    var i = e.touches ? e.touches[0] : e;
    e.preventDefault();
    e.stopPropagation();
    this.transitionTime();
    this.initiated = !0;
    this.moved = !1;
    this.lastPointX = i.pageX;
    this.lastPointY = i.pageY;
    this.startTime = l.getTime();
    this.options.disableTouch || l.addEvent(t, "touchmove", this);
    this.options.disablePointer || l.addEvent(t, l.prefixPointerEvent("pointermove"), this);
    this.options.disableMouse || l.addEvent(t, "mousemove", this);
    this.scroller._execEvent("beforeScrollStart");
  },
  _move: function (e) {
    var t,
      i,
      n,
      o,
      a = e.touches ? e.touches[0] : e;
    l.getTime();
    this.moved || this.scroller._execEvent("scrollStart");
    this.moved = !0;
    t = a.pageX - this.lastPointX;
    this.lastPointX = a.pageX;
    i = a.pageY - this.lastPointY;
    this.lastPointY = a.pageY;
    n = this.x + t;
    o = this.y + i;
    this._pos(n, o);
    e.preventDefault();
    e.stopPropagation();
  },
  _end: function (e) {
    if (this.initiated) {
      if (this.initiated = !1, e.preventDefault(), e.stopPropagation(), l.removeEvent(t, "touchmove", this), l.removeEvent(t, l.prefixPointerEvent("pointermove"), this), l.removeEvent(t, "mousemove", this), this.scroller.options.snap) {
        var i = this.scroller._nearestSnap(this.scroller.x, this.scroller.y),
          o = this.options.snapSpeed || n.max(n.max(n.min(n.abs(this.scroller.x - i.x), 1e3), n.min(n.abs(this.scroller.y - i.y), 1e3)), 300);
        this.scroller.x == i.x && this.scroller.y == i.y || (this.scroller.directionX = 0, this.scroller.directionY = 0, this.scroller.currentPage = i, this.scroller.scrollTo(i.x, i.y, o, this.scroller.options.bounceEasing));
      }
      this.moved && this.scroller._execEvent("scrollEnd");
    }
  },
  transitionTime: function (e) {
    e = e || 0;
    this.indicatorStyle[l.style.transitionDuration] = e + "ms";
    !e && l.isBadAndroid && (this.indicatorStyle[l.style.transitionDuration] = "0.001s");
  },
  transitionTimingFunction: function (e) {
    this.indicatorStyle[l.style.transitionTimingFunction] = e;
  },
  refresh: function () {
    this.transitionTime();
    this.options.listenX && !this.options.listenY ? this.indicatorStyle.display = this.scroller.hasHorizontalScroll ? "block" : "none" : this.options.listenY && !this.options.listenX ? this.indicatorStyle.display = this.scroller.hasVerticalScroll ? "block" : "none" : this.indicatorStyle.display = this.scroller.hasHorizontalScroll || this.scroller.hasVerticalScroll ? "block" : "none";
    this.scroller.hasHorizontalScroll && this.scroller.hasVerticalScroll ? (l.addClass(this.wrapper, "iScrollBothScrollbars"), l.removeClass(this.wrapper, "iScrollLoneScrollbar"), this.options.defaultScrollbars && this.options.customStyle && (this.options.listenX ? this.wrapper.style.right = "8px" : this.wrapper.style.bottom = "8px")) : (l.removeClass(this.wrapper, "iScrollBothScrollbars"), l.addClass(this.wrapper, "iScrollLoneScrollbar"), this.options.defaultScrollbars && this.options.customStyle && (this.options.listenX ? this.wrapper.style.right = "2px" : this.wrapper.style.bottom = "2px"));
    this.wrapper.offsetHeight;
    this.options.listenX && (this.wrapperWidth = this.wrapper.clientWidth, this.options.resize ? (this.indicatorWidth = n.max(n.round(this.wrapperWidth * this.wrapperWidth / (this.scroller.scrollerWidth || this.wrapperWidth || 1)), 8), this.indicatorStyle.width = this.indicatorWidth + "px") : this.indicatorWidth = this.indicator.clientWidth, this.maxPosX = this.wrapperWidth - this.indicatorWidth, "clip" == this.options.shrink ? (this.minBoundaryX = -this.indicatorWidth + 8, this.maxBoundaryX = this.wrapperWidth - 8) : (this.minBoundaryX = 0, this.maxBoundaryX = this.maxPosX), this.sizeRatioX = this.options.speedRatioX || this.scroller.maxScrollX && this.maxPosX / this.scroller.maxScrollX);
    this.options.listenY && (this.wrapperHeight = this.wrapper.clientHeight, this.options.resize ? (this.indicatorHeight = n.max(n.round(this.wrapperHeight * this.wrapperHeight / (this.scroller.scrollerHeight || this.wrapperHeight || 1)), 8), this.indicatorStyle.height = this.indicatorHeight + "px") : this.indicatorHeight = this.indicator.clientHeight, this.maxPosY = this.wrapperHeight - this.indicatorHeight, "clip" == this.options.shrink ? (this.minBoundaryY = -this.indicatorHeight + 8, this.maxBoundaryY = this.wrapperHeight - 8) : (this.minBoundaryY = 0, this.maxBoundaryY = this.maxPosY), this.maxPosY = this.wrapperHeight - this.indicatorHeight, this.sizeRatioY = this.options.speedRatioY || this.scroller.maxScrollY && this.maxPosY / this.scroller.maxScrollY);
    this.updatePosition();
  },
  updatePosition: function () {
    var e = this.options.listenX && n.round(this.sizeRatioX * this.scroller.x) || 0,
      t = this.options.listenY && n.round(this.sizeRatioY * this.scroller.y) || 0;
    this.options.ignoreBoundaries || (e < this.minBoundaryX ? ("scale" == this.options.shrink && (this.width = n.max(this.indicatorWidth + e, 8), this.indicatorStyle.width = this.width + "px"), e = this.minBoundaryX) : e > this.maxBoundaryX ? "scale" == this.options.shrink ? (this.width = n.max(this.indicatorWidth - (e - this.maxPosX), 8), this.indicatorStyle.width = this.width + "px", e = this.maxPosX + this.indicatorWidth - this.width) : e = this.maxBoundaryX : "scale" == this.options.shrink && this.width != this.indicatorWidth && (this.width = this.indicatorWidth, this.indicatorStyle.width = this.width + "px"), t < this.minBoundaryY ? ("scale" == this.options.shrink && (this.height = n.max(this.indicatorHeight + 3 * t, 8), this.indicatorStyle.height = this.height + "px"), t = this.minBoundaryY) : t > this.maxBoundaryY ? "scale" == this.options.shrink ? (this.height = n.max(this.indicatorHeight - 3 * (t - this.maxPosY), 8), this.indicatorStyle.height = this.height + "px", t = this.maxPosY + this.indicatorHeight - this.height) : t = this.maxBoundaryY : "scale" == this.options.shrink && this.height != this.indicatorHeight && (this.height = this.indicatorHeight, this.indicatorStyle.height = this.height + "px"));
    this.x = e;
    this.y = t;
    this.scroller.options.useTransform ? this.indicatorStyle[l.style.transform] = "translate(" + e + "px," + t + "px)" + this.scroller.translateZ : (this.indicatorStyle.left = e + "px", this.indicatorStyle.top = t + "px");
  },
  _pos: function (e, t) {
    e < 0 ? e = 0 : e > this.maxPosX && (e = this.maxPosX);
    t < 0 ? t = 0 : t > this.maxPosY && (t = this.maxPosY);
    e = this.options.listenX ? n.round(e / this.sizeRatioX) : this.scroller.x;
    t = this.options.listenY ? n.round(t / this.sizeRatioY) : this.scroller.y;
    this.scroller.scrollTo(e, t);
  },
  fade: function (e, t) {
    if (!t || this.visible) {
      clearTimeout(this.fadeTimeout);
      this.fadeTimeout = null;
      var i = e ? 250 : 500,
        n = e ? 0 : 300;
      e = e ? "1" : "0";
      this.wrapperStyle[l.style.transitionDuration] = i + "ms";
      this.fadeTimeout = setTimeout(function (e) {
        this.wrapperStyle.opacity = e;
        this.visible = +e;
      }.bind(this, e), n);
    }
  }
};
o.utils = l;
"undefined" != typeof e && e.exports ? e.exports = o : t.IScroll = o;
this._initEvents();
(this.options.scrollbars || this.options.indicators) && this._initIndicators();
this.options.mouseWheel && this._initWheel();
this.options.snap && this._initSnap();
this.options.keyBindings && this._initKeys();
this._initEvents(!0);
this._execEvent("destroy");
this.initiated = l.eventType[e.type];
this.moved = !1;
this.distX = 0;
this.distY = 0;
this.directionX = 0;
this.directionY = 0;
this.directionLocked = 0;
this._transitionTime();
this.startTime = l.getTime();
this.options.useTransition && this.isInTransition ? (this.isInTransition = !1, t = this.getComputedPosition(), this._translate(n.round(t.x), n.round(t.y)), this._execEvent("scrollEnd")) : !this.options.useTransition && this.isAnimating && (this.isAnimating = !1, this._execEvent("scrollEnd"));
this.startX = this.x;
this.startY = this.y;
this.absStartX = this.x;
this.absStartY = this.y;
this.pointX = i.pageX;
this.pointY = i.pageY;
this._execEvent("beforeScrollStart");
r = this.hasHorizontalScroll ? r : 0;
c = this.hasVerticalScroll ? c : 0;
t = this.x + r;
i = this.y + c;
(t > 0 || t < this.maxScrollX) && (t = this.options.bounce ? this.x + r / 3 : t > 0 ? 0 : this.maxScrollX);
(i > 0 || i < this.maxScrollY) && (i = this.options.bounce ? this.y + c / 3 : i > 0 ? 0 : this.maxScrollY);
this.directionX = r > 0 ? -1 : r < 0 ? 1 : 0;
this.directionY = c > 0 ? -1 : c < 0 ? 1 : 0;
this.moved || this._execEvent("scrollStart");
this.moved = !0;
this._translate(t, i);
d - this.startTime > 300 && (this.startTime = d, this.startX = this.x, this.startY = this.y);
this.currentPage = h;
d = this.options.snapSpeed || n.max(n.max(n.min(n.abs(a - h.x), 1e3), n.min(n.abs(s - h.y), 1e3)), 300);
a = h.x;
s = h.y;
this.directionX = 0;
this.directionY = 0;
u = this.options.bounceEasing;
clearTimeout(this.resizeTimeout);
this.resizeTimeout = setTimeout(function () {
  e.refresh();
}, this.options.resizePolling);
this.enabled = !1;
this.initiated = !1;
this.wrapperWidth = this.wrapper.clientWidth;
this.wrapperHeight = this.wrapper.clientHeight;
this.scrollerWidth = this.scroller.offsetWidth;
this.scrollerHeight = this.scroller.offsetHeight;
this.maxScrollX = this.wrapperWidth - this.scrollerWidth;
this.maxScrollY = this.wrapperHeight - this.scrollerHeight;
this.hasHorizontalScroll = this.options.scrollX && this.maxScrollX < 0;
this.hasVerticalScroll = this.options.scrollY && this.maxScrollY < 0;
this.hasHorizontalScroll || (this.maxScrollX = 0, this.scrollerWidth = this.wrapperWidth);
this.hasVerticalScroll || (this.maxScrollY = 0, this.scrollerHeight = this.wrapperHeight);
this.endTime = 0;
this.directionX = 0;
this.directionY = 0;
this.wrapperOffset = l.offset(this.wrapper);
this._execEvent("refresh");
this.resetPosition();
this._events[e] || (this._events[e] = []);
this._events[e].push(t);
e = this.x + e;
t = this.y + t;
i = i || 0;
this.scrollTo(e, t, i, n);
n = n || l.ease.circular;
this.isInTransition = this.options.useTransition && i > 0;
!i || this.options.useTransition && n.style ? (this._transitionTimingFunction(n.style), this._transitionTime(i), this._translate(e, t)) : this._animate(e, t, i, n.fn);
s.left -= this.wrapperOffset.left;
s.top -= this.wrapperOffset.top;
i === !0 && (i = n.round(e.offsetWidth / 2 - this.wrapper.offsetWidth / 2));
o === !0 && (o = n.round(e.offsetHeight / 2 - this.wrapper.offsetHeight / 2));
s.left -= i || 0;
s.top -= o || 0;
s.left = s.left > 0 ? 0 : s.left < this.maxScrollX ? this.maxScrollX : s.left;
s.top = s.top > 0 ? 0 : s.top < this.maxScrollY ? this.maxScrollY : s.top;
t = void 0 === t || null === t || "auto" === t ? n.max(n.abs(this.x - s.left), n.abs(this.y - s.top)) : t;
this.scrollTo(s.left, s.top, t, a);
i(t, "orientationchange", this);
i(t, "resize", this);
this.options.click && i(this.wrapper, "click", this, !0);
this.options.disableMouse || (i(this.wrapper, "mousedown", this), i(n, "mousemove", this), i(n, "mousecancel", this), i(n, "mouseup", this));
l.hasPointer && !this.options.disablePointer && (i(this.wrapper, l.prefixPointerEvent("pointerdown"), this), i(n, l.prefixPointerEvent("pointermove"), this), i(n, l.prefixPointerEvent("pointercancel"), this), i(n, l.prefixPointerEvent("pointerup"), this));
l.hasTouch && !this.options.disableTouch && (i(this.wrapper, "touchstart", this), i(n, "touchmove", this), i(n, "touchcancel", this), i(n, "touchend", this));
i(this.scroller, "transitionend", this);
i(this.scroller, "webkitTransitionEnd", this);
i(this.scroller, "oTransitionEnd", this);
i(this.scroller, "MSTransitionEnd", this);
this.indicators = [];
this.options.scrollbars && (this.options.scrollY && (t = {
  el: a("v", i, this.options.scrollbars),
  interactive: i,
  defaultScrollbars: !0,
  customStyle: n,
  resize: this.options.resizeScrollbars,
  shrink: this.options.shrinkScrollbars,
  fade: this.options.fadeScrollbars,
  listenX: !1
}, this.wrapper.appendChild(t.el), o.push(t)), this.options.scrollX && (t = {
  el: a("h", i, this.options.scrollbars),
  interactive: i,
  defaultScrollbars: !0,
  customStyle: n,
  resize: this.options.resizeScrollbars,
  shrink: this.options.shrinkScrollbars,
  fade: this.options.fadeScrollbars,
  listenY: !1
}, this.wrapper.appendChild(t.el), o.push(t)));
this.options.indicators && (o = o.concat(this.options.indicators));
this.options.fadeScrollbars && (this.on("scrollEnd", function () {
  e(function () {
    this.fade();
  });
}), this.on("scrollCancel", function () {
  e(function () {
    this.fade();
  });
}), this.on("scrollStart", function () {
  e(function () {
    this.fade(1);
  });
}), this.on("beforeScrollStart", function () {
  e(function () {
    this.fade(1, !0);
  });
}));
this.on("refresh", function () {
  e(function () {
    this.refresh();
  });
});
this.on("destroy", function () {
  e(function () {
    this.destroy();
  });
  delete this.indicators;
});
e(function () {
  this.destroy();
});
delete this.indicators;
l.addEvent(this.wrapper, "wheel", this);
l.addEvent(this.wrapper, "mousewheel", this);
l.addEvent(this.wrapper, "DOMMouseScroll", this);
this.on("destroy", function () {
  l.removeEvent(this.wrapper, "wheel", this);
  l.removeEvent(this.wrapper, "mousewheel", this);
  l.removeEvent(this.wrapper, "DOMMouseScroll", this);
});
l.removeEvent(this.wrapper, "wheel", this);
l.removeEvent(this.wrapper, "mousewheel", this);
l.removeEvent(this.wrapper, "DOMMouseScroll", this);
e.preventDefault();
e.stopPropagation();
s._execEvent("scrollEnd");
s.wheelTimeout = void 0;
t = e.wheelDeltaX / 120 * this.options.mouseWheelSpeed;
i = e.wheelDeltaY / 120 * this.options.mouseWheelSpeed;
o = this.x + n.round(this.hasHorizontalScroll ? t : 0);
a = this.y + n.round(this.hasVerticalScroll ? i : 0);
o > 0 ? o = 0 : o < this.maxScrollX && (o = this.maxScrollX);
a > 0 ? a = 0 : a < this.maxScrollY && (a = this.maxScrollY);
this.scrollTo(o, a, 0);
this.currentPage = {};
"string" == typeof this.options.snap && (this.options.snap = this.scroller.querySelectorAll(this.options.snap));
this.on("refresh", function () {
  var e,
    t,
    i,
    o,
    a,
    s,
    r = 0,
    l = 0,
    c = 0,
    d = this.options.snapStepX || this.wrapperWidth,
    u = this.options.snapStepY || this.wrapperHeight;
  if (this.pages = [], this.wrapperWidth && this.wrapperHeight && this.scrollerWidth && this.scrollerHeight) {
    if (this.options.snap === !0) {
      for (i = n.round(d / 2), o = n.round(u / 2); c > -this.scrollerWidth;) {
        for (this.pages[r] = [], e = 0, a = 0; a > -this.scrollerHeight;) {
          this.pages[r][e] = {
            x: n.max(c, this.maxScrollX),
            y: n.max(a, this.maxScrollY),
            width: d,
            height: u,
            cx: c - i,
            cy: a - o
          };
          a -= u;
          e++;
        }
        c -= d;
        r++;
      }
    } else {
      for (s = this.options.snap, e = s.length, t = -1; r < e; r++) {
        (0 === r || s[r].offsetLeft <= s[r - 1].offsetLeft) && (l = 0, t++);
        this.pages[l] || (this.pages[l] = []);
        c = n.max(-s[r].offsetLeft, this.maxScrollX);
        a = n.max(-s[r].offsetTop, this.maxScrollY);
        i = c - n.round(s[r].offsetWidth / 2);
        o = a - n.round(s[r].offsetHeight / 2);
        this.pages[l][t] = {
          x: c,
          y: a,
          width: s[r].offsetWidth,
          height: s[r].offsetHeight,
          cx: i,
          cy: o
        };
        c > this.maxScrollX && l++;
      }
    }
    this.goToPage(this.currentPage.pageX || 0, this.currentPage.pageY || 0, 0);
    this.options.snapThreshold % 1 === 0 ? (this.snapThresholdX = this.options.snapThreshold, this.snapThresholdY = this.options.snapThreshold) : (this.snapThresholdX = n.round(this.pages[this.currentPage.pageX][this.currentPage.pageY].width * this.options.snapThreshold), this.snapThresholdY = n.round(this.pages[this.currentPage.pageX][this.currentPage.pageY].height * this.options.snapThreshold));
  }
});
this.on("flick", function () {
  var e = this.options.snapSpeed || n.max(n.max(n.min(n.abs(this.x - this.startX), 1e3), n.min(n.abs(this.y - this.startY), 1e3)), 300);
  this.goToPage(this.currentPage.pageX + this.directionX, this.currentPage.pageY + this.directionY, e);
});
this.pages[r][e] = {
  x: n.max(c, this.maxScrollX),
  y: n.max(a, this.maxScrollY),
  width: d,
  height: u,
  cx: c - i,
  cy: a - o
};
a -= u;
e++;
c -= d;
r++;
(0 === r || s[r].offsetLeft <= s[r - 1].offsetLeft) && (l = 0, t++);
this.pages[l] || (this.pages[l] = []);
c = n.max(-s[r].offsetLeft, this.maxScrollX);
a = n.max(-s[r].offsetTop, this.maxScrollY);
i = c - n.round(s[r].offsetWidth / 2);
o = a - n.round(s[r].offsetHeight / 2);
this.pages[l][t] = {
  x: c,
  y: a,
  width: s[r].offsetWidth,
  height: s[r].offsetHeight,
  cx: i,
  cy: o
};
c > this.maxScrollX && l++;
this.goToPage(this.currentPage.pageX || 0, this.currentPage.pageY || 0, 0);
this.options.snapThreshold % 1 === 0 ? (this.snapThresholdX = this.options.snapThreshold, this.snapThresholdY = this.options.snapThreshold) : (this.snapThresholdX = n.round(this.pages[this.currentPage.pageX][this.currentPage.pageY].width * this.options.snapThreshold), this.snapThresholdY = n.round(this.pages[this.currentPage.pageX][this.currentPage.pageY].height * this.options.snapThreshold));
o = o || this.options.bounceEasing;
e >= this.pages.length ? e = this.pages.length - 1 : e < 0 && (e = 0);
t >= this.pages[e].length ? t = this.pages[e].length - 1 : t < 0 && (t = 0);
i = void 0 === i ? this.options.snapSpeed || n.max(n.max(n.min(n.abs(a - this.x), 1e3), n.min(n.abs(s - this.y), 1e3)), 300) : i;
this.currentPage = {
  x: a,
  y: s,
  pageX: e,
  pageY: t
};
this.scrollTo(a, s, i, o);
i++;
i >= this.pages.length && this.hasVerticalScroll && (i = 0, n++);
this.goToPage(i, n, e, t);
i--;
i < 0 && this.hasVerticalScroll && (i = 0, n--);
this.goToPage(i, n, e, t);
l.addEvent(t, "keydown", this);
this.on("destroy", function () {
  l.removeEvent(t, "keydown", this);
});
o = i ? this.pages.length - 1 : this.maxScrollX;
a = i ? this.pages[0].length - 1 : this.maxScrollY;
o = 0;
a = 0;
o > 0 ? (o = 0, this.keyAcceleration = 0) : o < this.maxScrollX && (o = this.maxScrollX, this.keyAcceleration = 0);
a > 0 ? (a = 0, this.keyAcceleration = 0) : a < this.maxScrollY && (a = this.maxScrollY, this.keyAcceleration = 0);
this.scrollTo(o, a, 0);
this.keyTime = s;
this.isAnimating = !0;
o();
this.options.interactive && (l.removeEvent(this.indicator, "touchstart", this), l.removeEvent(this.indicator, l.prefixPointerEvent("pointerdown"), this), l.removeEvent(this.indicator, "mousedown", this), l.removeEvent(t, "touchmove", this), l.removeEvent(t, l.prefixPointerEvent("pointermove"), this), l.removeEvent(t, "mousemove", this), l.removeEvent(t, "touchend", this), l.removeEvent(t, l.prefixPointerEvent("pointerup"), this), l.removeEvent(t, "mouseup", this));
this.options.defaultScrollbars && this.wrapper.parentNode.removeChild(this.wrapper);
e.preventDefault();
e.stopPropagation();
this.transitionTime();
this.initiated = !0;
this.moved = !1;
this.lastPointX = i.pageX;
this.lastPointY = i.pageY;
this.startTime = l.getTime();
this.options.disableTouch || l.addEvent(t, "touchmove", this);
this.options.disablePointer || l.addEvent(t, l.prefixPointerEvent("pointermove"), this);
this.options.disableMouse || l.addEvent(t, "mousemove", this);
this.scroller._execEvent("beforeScrollStart");
this.moved || this.scroller._execEvent("scrollStart");
this.moved = !0;
t = a.pageX - this.lastPointX;
this.lastPointX = a.pageX;
i = a.pageY - this.lastPointY;
this.lastPointY = a.pageY;
n = this.x + t;
o = this.y + i;
this._pos(n, o);
e.preventDefault();
e.stopPropagation();
e = e || 0;
this.indicatorStyle[l.style.transitionDuration] = e + "ms";
!e && l.isBadAndroid && (this.indicatorStyle[l.style.transitionDuration] = "0.001s");
this.transitionTime();
this.options.listenX && !this.options.listenY ? this.indicatorStyle.display = this.scroller.hasHorizontalScroll ? "block" : "none" : this.options.listenY && !this.options.listenX ? this.indicatorStyle.display = this.scroller.hasVerticalScroll ? "block" : "none" : this.indicatorStyle.display = this.scroller.hasHorizontalScroll || this.scroller.hasVerticalScroll ? "block" : "none";
this.scroller.hasHorizontalScroll && this.scroller.hasVerticalScroll ? (l.addClass(this.wrapper, "iScrollBothScrollbars"), l.removeClass(this.wrapper, "iScrollLoneScrollbar"), this.options.defaultScrollbars && this.options.customStyle && (this.options.listenX ? this.wrapper.style.right = "8px" : this.wrapper.style.bottom = "8px")) : (l.removeClass(this.wrapper, "iScrollBothScrollbars"), l.addClass(this.wrapper, "iScrollLoneScrollbar"), this.options.defaultScrollbars && this.options.customStyle && (this.options.listenX ? this.wrapper.style.right = "2px" : this.wrapper.style.bottom = "2px"));
this.options.listenX && (this.wrapperWidth = this.wrapper.clientWidth, this.options.resize ? (this.indicatorWidth = n.max(n.round(this.wrapperWidth * this.wrapperWidth / (this.scroller.scrollerWidth || this.wrapperWidth || 1)), 8), this.indicatorStyle.width = this.indicatorWidth + "px") : this.indicatorWidth = this.indicator.clientWidth, this.maxPosX = this.wrapperWidth - this.indicatorWidth, "clip" == this.options.shrink ? (this.minBoundaryX = -this.indicatorWidth + 8, this.maxBoundaryX = this.wrapperWidth - 8) : (this.minBoundaryX = 0, this.maxBoundaryX = this.maxPosX), this.sizeRatioX = this.options.speedRatioX || this.scroller.maxScrollX && this.maxPosX / this.scroller.maxScrollX);
this.options.listenY && (this.wrapperHeight = this.wrapper.clientHeight, this.options.resize ? (this.indicatorHeight = n.max(n.round(this.wrapperHeight * this.wrapperHeight / (this.scroller.scrollerHeight || this.wrapperHeight || 1)), 8), this.indicatorStyle.height = this.indicatorHeight + "px") : this.indicatorHeight = this.indicator.clientHeight, this.maxPosY = this.wrapperHeight - this.indicatorHeight, "clip" == this.options.shrink ? (this.minBoundaryY = -this.indicatorHeight + 8, this.maxBoundaryY = this.wrapperHeight - 8) : (this.minBoundaryY = 0, this.maxBoundaryY = this.maxPosY), this.maxPosY = this.wrapperHeight - this.indicatorHeight, this.sizeRatioY = this.options.speedRatioY || this.scroller.maxScrollY && this.maxPosY / this.scroller.maxScrollY);
this.updatePosition();
this.options.ignoreBoundaries || (e < this.minBoundaryX ? ("scale" == this.options.shrink && (this.width = n.max(this.indicatorWidth + e, 8), this.indicatorStyle.width = this.width + "px"), e = this.minBoundaryX) : e > this.maxBoundaryX ? "scale" == this.options.shrink ? (this.width = n.max(this.indicatorWidth - (e - this.maxPosX), 8), this.indicatorStyle.width = this.width + "px", e = this.maxPosX + this.indicatorWidth - this.width) : e = this.maxBoundaryX : "scale" == this.options.shrink && this.width != this.indicatorWidth && (this.width = this.indicatorWidth, this.indicatorStyle.width = this.width + "px"), t < this.minBoundaryY ? ("scale" == this.options.shrink && (this.height = n.max(this.indicatorHeight + 3 * t, 8), this.indicatorStyle.height = this.height + "px"), t = this.minBoundaryY) : t > this.maxBoundaryY ? "scale" == this.options.shrink ? (this.height = n.max(this.indicatorHeight - 3 * (t - this.maxPosY), 8), this.indicatorStyle.height = this.height + "px", t = this.maxPosY + this.indicatorHeight - this.height) : t = this.maxBoundaryY : "scale" == this.options.shrink && this.height != this.indicatorHeight && (this.height = this.indicatorHeight, this.indicatorStyle.height = this.height + "px"));
this.x = e;
this.y = t;
this.scroller.options.useTransform ? this.indicatorStyle[l.style.transform] = "translate(" + e + "px," + t + "px)" + this.scroller.translateZ : (this.indicatorStyle.left = e + "px", this.indicatorStyle.top = t + "px");
e < 0 ? e = 0 : e > this.maxPosX && (e = this.maxPosX);
t < 0 ? t = 0 : t > this.maxPosY && (t = this.maxPosY);
e = this.options.listenX ? n.round(e / this.sizeRatioX) : this.scroller.x;
t = this.options.listenY ? n.round(t / this.sizeRatioY) : this.scroller.y;
this.scroller.scrollTo(e, t);
clearTimeout(this.fadeTimeout);
this.fadeTimeout = null;
e = e ? "1" : "0";
this.wrapperStyle[l.style.transitionDuration] = i + "ms";
this.fadeTimeout = setTimeout(function (e) {
  this.wrapperStyle.opacity = e;
  this.visible = +e;
}.bind(this, e), n);
this.wrapperStyle.opacity = e;
this.visible = +e;
i.ADMIN = i.GAME_MASTER_3.concat(i.G2_MODERATOR);
e.exports = i;
i && (i.unset(), i.delClassNames("unavailable"));
r = "remove";
e.openPanel && e.closePanels();
r = "use";
this.once("open", function () {
  l.useEmote = this._addEntry(s("ui.common.use"), t);
  l.remove = this._addEntry(s("ui.common.remove"), e);
  this._addCancel();
});
this.on("open", function (e, t) {
  e = e || {};
  i = e.slot;
  o = e.onClose;
  n = e.emoteId;
  r = "";
  l.remove.toggleDisplay(!!e.canRemove);
  l.useEmote.toggleDisplay(!!e.hasOwnProperty("emoteId"));
  t();
});
this.on("close", function () {
  o && o(r);
});
l.useEmote = this._addEntry(s("ui.common.use"), t);
l.remove = this._addEntry(s("ui.common.remove"), e);
this._addCancel();
e = e || {};
i = e.slot;
o = e.onClose;
n = e.emoteId;
r = "";
l.remove.toggleDisplay(!!e.canRemove);
l.useEmote.toggleDisplay(!!e.hasOwnProperty("emoteId"));
t();
o(n, a);
e.exports = n;
a.call(this, {
  className: "ContextualMenuFightMonsterSwap"
});
this.actorId = 0;
this.once("open", this._setupDom);
this.on("open", this._setContent);
o(n, a);
e.exports = n;
n.prototype._setupDom = function () {
  var e = this;
  this._addEntry(s("ui.fight.swapPosition"), function () {
    var t = window.actorManager.getActor(e.actorId);
    t && window.dofus.sendMessage("GameFightPlacementSwapPositionsRequestMessage", {
      cellId: t.cellId,
      requestedId: e.actorId
    });
    e.emit("close");
  });
  this._addCancel();
};
n.prototype._setContent = function (e, t) {
  this.actorId = e.actorId;
  t();
};
this._addEntry(s("ui.fight.swapPosition"), function () {
  var t = window.actorManager.getActor(e.actorId);
  t && window.dofus.sendMessage("GameFightPlacementSwapPositionsRequestMessage", {
    cellId: t.cellId,
    requestedId: e.actorId
  });
  e.emit("close");
});
this._addCancel();
t && window.dofus.sendMessage("GameFightPlacementSwapPositionsRequestMessage", {
  cellId: t.cellId,
  requestedId: e.actorId
});
e.emit("close");
this.actorId = e.actorId;
t();
a.call(this, {
  className: "ContextualMenuFightTeam"
});
this.leaderId = 0;
this.fightId = 0;
this.once("open", this._setupDom);
this.on("open", this._setContent);
o(n, a);
e.exports = n;
n.prototype._setupDom = function () {
  var e = this,
    t = this.entryList.createChild("div");
  this.teamMemberList = t.createChild("div", {
    className: "teamMemberList"
  });
  this.actionsContainer = t.createChild("div");
  this.buttonJoin = this._addEntry(r("ui.common.join"), function () {
    return e.isAlliancePrismFight ? void l.open("social", {
      tabId: "alliance",
      tabParams: {
        tabId: "attacks"
      }
    }) : e.isTaxCollectorFight ? void l.open("social", {
      tabId: "guild",
      tabParams: {
        tabId: "perceptors"
      }
    }) : void window.dofus.sendMessage("GameFightJoinRequestMessage", {
      fighterId: e.leaderId,
      fightId: e.fightId
    });
  });
  this._addCancel();
};
n.prototype._setContent = function (e, t) {
  var i = this;
  this.isAlliancePrismFight = !1;
  this.isTaxCollectorFight = !1;
  this.leaderId = e.leaderId;
  this.fightId = e.fightId;
  this.teamMemberList.clearContent();
  for (var n = e.teamMembers, o = [], a = 0; a < n.length; a++) {
    var l = n[a];
    switch (l._type) {
      case "FightTeamMemberMonsterInformations":
        o.push(l.monsterId);
        break;
      case "FightTeamMemberCharacterInformations":
      case "FightTeamMemberWithAllianceCharacterInformations":
      case "FightTeamMemberTaxCollectorInformations":
    }
  }
  s.getDataMap("Monsters", o, function (e, o) {
    if (e) {
      return console.error(e);
    }
    for (var a = 0, s = r("ui.common.short.level") + " ", l = 0; l < n.length; l++) {
      var c = n[l],
        d = i.teamMemberList.createChild("div", {
          className: "teamMember"
        });
      switch (c._type) {
        case "FightTeamMemberMonsterInformations":
          var u = c.grade,
            h = o[c.monsterId],
            p = h.grades[u - 1].level;
          a += p;
          d.setText(h.nameId + " (" + s + p + ")");
          3451 === h.id && (i.isAlliancePrismFight = !0);
          break;
        case "FightTeamMemberCharacterInformations":
        case "FightTeamMemberWithAllianceCharacterInformations":
          a += c.level;
          d.setText(c.name + " (" + s + c.level + ")");
          break;
        case "FightTeamMemberTaxCollectorInformations":
          i.isTaxCollectorFight = !0;
      }
    }
    i.header.setText(r("ui.common.rank", a));
    t();
  });
};
this.teamMemberList = t.createChild("div", {
  className: "teamMemberList"
});
this.actionsContainer = t.createChild("div");
this.buttonJoin = this._addEntry(r("ui.common.join"), function () {
  return e.isAlliancePrismFight ? void l.open("social", {
    tabId: "alliance",
    tabParams: {
      tabId: "attacks"
    }
  }) : e.isTaxCollectorFight ? void l.open("social", {
    tabId: "guild",
    tabParams: {
      tabId: "perceptors"
    }
  }) : void window.dofus.sendMessage("GameFightJoinRequestMessage", {
    fighterId: e.leaderId,
    fightId: e.fightId
  });
});
this._addCancel();
this.isAlliancePrismFight = !1;
this.isTaxCollectorFight = !1;
this.leaderId = e.leaderId;
this.fightId = e.fightId;
this.teamMemberList.clearContent();
a += p;
d.setText(h.nameId + " (" + s + p + ")");
3451 === h.id && (i.isAlliancePrismFight = !0);
a += c.level;
d.setText(c.name + " (" + s + c.level + ")");
i.header.setText(r("ui.common.rank", a));
t();
a.call(this);
this._cancelButton = null;
this.once("open", function () {
  this.buttonsContainer = this.entryList.createChild("div");
  this._cancelButton = this._addCancel();
});
this.on("open", function (e, t) {
  this._update(e);
  t();
});
this.buttonsContainer = this.entryList.createChild("div");
this._cancelButton = this._addCancel();
this._update(e);
t();
o(n, a);
e.exports = n;
n.prototype._update = function (e) {
  function t() {
    i.close();
    var e = this.action;
    e.cb && e.cb(e);
    i.emit("action", e);
  }
  var i = this;
  e = e || {};
  var n = e.actions || [];
  this.header.setText(e.title || "");
  this._displayHeader(!!e.title);
  this.buttonsContainer.clearContent();
  for (var o = 0, a = n.length; o < a; o++) {
    var r = n[o];
    if (!r.hidden) {
      var l = this.buttonsContainer.appendChild(new s({
        className: "cmButton"
      }, t));
      if (r.caption && l.setText(r.caption), r.wuiDomChild && l.appendChild(r.wuiDomChild), r.line) {
        l.addClassNames("line");
      } else {
        var c = "";
        r.isTitle && (c = "title");
        r.disabled ? l.addClassNames(c, "disabled") : (r.ticked && l.addClassNames(c, "ticked"), r.addClassNames && l.addClassNames(r.addClassNames), l.addClassNames(c), l.action = r);
      }
    }
  }
};
n.prototype.forceUpdateCancelButton = function () {
  this._cancelButton && this._cancelButton.setText(r("ui.common.cancel"));
};
n.sortMenuActions = function (e) {
  e.sort(function (e, t) {
    return e.caption.localeCompare(t.caption);
  });
};
e.cb && e.cb(e);
i.emit("action", e);
this.header.setText(e.title || "");
this._displayHeader(!!e.title);
this.buttonsContainer.clearContent();
r.isTitle && (c = "title");
r.disabled ? l.addClassNames(c, "disabled") : (r.ticked && l.addClassNames(c, "ticked"), r.addClassNames && l.addClassNames(r.addClassNames), l.addClassNames(c), l.action = r);
e.lastContextualMenuSkillId = o.skillId;
e.actionQueue.enqueueInteractive(n.elementId, n.elementTypeId, function () {
  e.queueUseInteractive(n.elementId, o.skillInstanceUid);
});
t.close();
this.once("open", function () {
  this._setupDom();
});
this.on("open", function (t, i) {
  function n(t, i) {
    var n = t._name || "skill " + t.skillId,
      o = s.actionsContainer.appendChild(new c({
        text: n,
        className: "cmButton"
      }, e));
    return i ? void o.disable() : (o.elementId = r.elementId, void (o.skill = t));
  }
  var a,
    s = this,
    r = t || {};
  if (r.ageBonus ? (this.starCounter.setValue(r.ageBonus), this.starCounter.show()) : this.starCounter.hide(), r._houseData) {
    var d = r._houseData.houseId;
    if (a = window.gui.playerData.position.getHousePropertiesById(d)) {
      var m = u.getWindow("houseBuySell");
      m.prepareDialog(a.modelId, a.ownerName, a._displayedName);
      var f = a.ownerName;
      f = "?" === f || "" === f ? l("ui.common.houseWithNoOwner") : f === window.gui.playerData.identification.uniqueNickname.toString() ? l("ui.common.myHouse") : l("ui.house.homeOf", a._displayedName);
      this.banner.setContent({
        house: {
          houseOwner: f,
          houseName: a._name,
          houseId: a.houseId,
          forSale: a.isOnSale,
          isClosed: a.isClosed
        },
        guild: a.guildInfo
      });
      this._displayHeader(!0);
    } else {
      this._displayHeader(!1);
    }
  } else {
    r._name ? (this.banner.setContent({
      name: r._name
    }), this._displayHeader(!0)) : this._displayHeader(!1);
  }
  if (this.actionsContainer.clearContent(), r.elementTypeId === o.ELEMENT_TYPE_ID.PADDOCK) {
    var g = window.isoEngine.mapRenderer.getPaddockProperties();
    if (g.locked) {
      return this.actionsContainer.createChild("div", {
        className: "cmButton",
        text: l("ui.social.paddockWithNoOwner")
      }), i();
    }
  }
  var _, v;
  for (_ = 0, v = r.enabledSkills.length; _ < v; _++) {
    n(r.enabledSkills[_]);
  }
  for (_ = 0, v = r.disabledSkills.length; _ < v; _++) {
    n(r.disabledSkills[_], !0);
  }
  0 === r.enabledSkills.length && r.disabledSkills.length > 0 && p(r.elementTypeId, r.disabledSkills);
  var y = window.gui.playerData,
    w = y.hasRight(h.JUMP_HOUSE),
    b = y.adminMenu.getAdminMenuId();
  w && null !== b && a && "?" !== a.ownerName && (s.admin = s.actionsContainer.appendChild(new c({
    text: "Admin",
    className: "cmButton"
  }, function () {
    var e = {
      name: "*" + a.ownerName,
      houseId: a.houseId
    };
    window.gui.closeContextualMenu();
    window.gui.openContextualMenuAround("admin", s.admin, e);
    s.emit("close");
  })));
  i();
});
f = "?" === f || "" === f ? l("ui.common.houseWithNoOwner") : f === window.gui.playerData.identification.uniqueNickname.toString() ? l("ui.common.myHouse") : l("ui.house.homeOf", a._displayedName);
this.banner.setContent({
  house: {
    houseOwner: f,
    houseName: a._name,
    houseId: a.houseId,
    forSale: a.isOnSale,
    isClosed: a.isClosed
  },
  guild: a.guildInfo
});
this._displayHeader(!0);
w && null !== b && a && "?" !== a.ownerName && (s.admin = s.actionsContainer.appendChild(new c({
  text: "Admin",
  className: "cmButton"
}, function () {
  var e = {
    name: "*" + a.ownerName,
    houseId: a.houseId
  };
  window.gui.closeContextualMenu();
  window.gui.openContextualMenuAround("admin", s.admin, e);
  s.emit("close");
})));
i();
window.gui.closeContextualMenu();
window.gui.openContextualMenuAround("admin", s.admin, e);
s.emit("close");
a(n, s);
e.exports = n;
n.prototype._setupDom = function () {
  this.banner = this.header.appendChild(new r());
  var e = this.entryList;
  this.starCounter = e.appendChild(new d());
  this.actionsContainer = e.createChild("div");
  this._addCancel();
};
this.starCounter = e.appendChild(new d());
this.actionsContainer = e.createChild("div");
this._addCancel();
o.call(this, "div", {
  className: "EntityBanner"
});
this._guildEmblem = this.appendChild(new a({
  width: 40,
  height: 40
}));
this._allianceEmblem = this.appendChild(new a({
  width: 40,
  height: 40
}));
this._guildName = e.createChild("div", {
  className: "guildName"
});
this._nameWrapper = e.createChild("div", {
  className: "nameWrapper"
});
this._houseName = e.createChild("div", {
  className: "houseName"
});
this._houseOwner = e.createChild("div", {
  className: "houseOwner"
});
this._forSale = e.createChild("div", {
  className: "forSale",
  text: s("ui.common.forSale")
});
r(n, o);
n.prototype.setContent = function (e) {
  e = e || {};
  this._nameWrapper.clearContent();
  var t = this._nameWrapper.createChild("div", {
    className: "icon"
  });
  e.playerId && window.gui.playerData.socialData.isSpouse(e.playerId) ? t.addClassNames("spouse") : e.playerId && window.gui.playerData.socialData.isFriend(e.playerId) ? t.addClassNames("friend") : e.guildId && window.gui.playerData.guildData.isOnSameGuild(e.guildId) ? t.addClassNames("guildMember") : e.guildId && window.gui.playerData.alliance.isGuildOnSameAlliance(e.guildId) && t.addClassNames("allianceMember");
  this._nameWrapper.createChild("div", {
    className: "name",
    text: e.name || ""
  });
  this._nameWrapper.toggleDisplay(!!e.name);
  var i,
    n = e.guild;
  n ? (this._guildName.setText(n.guildName), this._guildName.show(), i = n.guildEmblem, i && this._guildEmblem.setValue(i, !0), this._guildEmblem.show()) : (this._guildName.hide(), this._guildEmblem.hide());
  var o = e.alliance;
  o ? (this.addClassNames("alliance"), n ? this._guildName.setText(n.guildName + " - [" + o.allianceTag + "]") : (this._guildName.setText(o.allianceName), this._guildName.show()), i = o.allianceEmblem, i && (i.isAlliance = !0, this._allianceEmblem.setValue(i, !0), this._allianceEmblem.show())) : (this.delClassNames("alliance"), this._allianceEmblem.hide());
  var a = e.house || {},
    r = a.houseOwner || "";
  window.gui.playerData.isModeratorOrMore() && a.isClosed && (r += " " + s("ui.house.closed"));
  this._houseOwner.setText(r);
  this._houseOwner.toggleDisplay("" !== r);
  a.houseName && (a.houseName += window.gui.playerData.isAbleToSeeId() ? " (" + a.houseId + ")" : "", this._houseName.setText(a.houseName));
  this._houseName.toggleDisplay(!!a.houseName);
  this._forSale.toggleDisplay(!!a.forSale);
};
e.exports = n;
e = e || {};
this._nameWrapper.clearContent();
e.playerId && window.gui.playerData.socialData.isSpouse(e.playerId) ? t.addClassNames("spouse") : e.playerId && window.gui.playerData.socialData.isFriend(e.playerId) ? t.addClassNames("friend") : e.guildId && window.gui.playerData.guildData.isOnSameGuild(e.guildId) ? t.addClassNames("guildMember") : e.guildId && window.gui.playerData.alliance.isGuildOnSameAlliance(e.guildId) && t.addClassNames("allianceMember");
this._nameWrapper.createChild("div", {
  className: "name",
  text: e.name || ""
});
this._nameWrapper.toggleDisplay(!!e.name);
window.gui.playerData.isModeratorOrMore() && a.isClosed && (r += " " + s("ui.house.closed"));
this._houseOwner.setText(r);
this._houseOwner.toggleDisplay("" !== r);
a.houseName && (a.houseName += window.gui.playerData.isAbleToSeeId() ? " (" + a.houseId + ")" : "", this._houseName.setText(a.houseName));
this._houseName.toggleDisplay(!!a.houseName);
this._forSale.toggleDisplay(!!a.forSale);
i > 0 && (t += ", ");
t += e[i];
u.jobNameList = u.jobNameList.concat(l.jobNameList);
u.jobLevelList = u.jobLevelList.concat(l.jobLevelList);
u.levelMinList = u.levelMinList.concat(l.levelMinList);
this.once("open", function () {
  this._setupDom(t, i);
});
this.on("open", function (n, o) {
  this._params = n;
  var a = this._item = n.item;
  this._action = null;
  e = n.onClose;
  var s = a.objectUID ? a : null,
    l = this._dbItem = s ? s.item : a;
  this.header.setText(l.nameId || "");
  i.backgroundImage = l.image;
  for (var c in t) {
    t[c].hide();
  }
  var d = !n.hasOwnProperty("enableSet") || n.enableSet,
    u = !n.hasOwnProperty("enableBestiary") || n.enableBestiary,
    p = !n.hasOwnProperty("enableRecipe") || n.enableRecipe,
    f = !n.hasOwnProperty("enableInsertRecipe") || n.enableInsertRecipe,
    g = !!n.enableDestroy,
    _ = !!n.enableSell,
    v = !n.hasOwnProperty("enableCertificate") || n.enableCertificate,
    y = !!l,
    w = !!s && h.isItemInstanceWithMountInfo(s);
  if (t.itemSet.toggleDisplay(d && "ItemSetsWindow" !== n.location && !!l.itemSetId && l.itemSetId !== -1), t.recipes.toggleDisplay(p && y), t.insertItemStats.toggleDisplay(f && y), t.insertRecipe.toggleDisplay(f && y), t.findInBestiary.toggleDisplay(u && !!a.getProperty("dropMonsterIds").length), t.bidHouseSell.toggleDisplay(!!s && _), t.remove.toggleDisplay(!!n.remove), t.mount.toggleDisplay(v && w), s && n.enableActions) {
    t.feed.toggleDisplay(!!l.foodTypes);
    t.multiUse.toggleDisplay(!!l.usable && a.quantity > 1 && !l.multiUseUnabled);
    t.use.toggleDisplay(!!l.usable);
    t.target.toggleDisplay(m.isRoleplayMode && !!l.targetable && !l.nonUsableOnAnother);
    var b = l.isEquippable();
    t.equip.toggleDisplay(b && !r(a.position));
    t.unequip.toggleDisplay(b && r(a.position));
    t.mount.toggleDisplay(w);
    t.manage.toggleDisplay(!!a.livingObjectCategory);
    t.freeMimicry.toggleDisplay(s.isMimicryHost());
    t.manageShield.toggleDisplay(s.isShieldManageable());
  }
  g && s && void 0 !== a.position && t.destroy.toggleDisplay(a.quantity > 0);
  o();
});
this.on("close", function () {
  e && e(this._action);
});
this._action = null;
e = n.onClose;
this.header.setText(l.nameId || "");
i.backgroundImage = l.image;
t.feed.toggleDisplay(!!l.foodTypes);
t.multiUse.toggleDisplay(!!l.usable && a.quantity > 1 && !l.multiUseUnabled);
t.use.toggleDisplay(!!l.usable);
t.target.toggleDisplay(m.isRoleplayMode && !!l.targetable && !l.nonUsableOnAnother);
t.equip.toggleDisplay(b && !r(a.position));
t.unequip.toggleDisplay(b && r(a.position));
t.mount.toggleDisplay(w);
t.manage.toggleDisplay(!!a.livingObjectCategory);
t.freeMimicry.toggleDisplay(s.isMimicryHost());
t.manageShield.toggleDisplay(s.isShieldManageable());
g && s && void 0 !== a.position && t.destroy.toggleDisplay(a.quantity > 0);
o();
s(n, c);
e.exports = n;
n.prototype._setupDom = function (e, t) {
  function i(e, t, i) {
    n = e;
    c.open({
      min: t,
      max: i,
      x: s._position.x,
      y: s._position.y
    });
  }
  var n,
    s = this,
    r = window.gui.playerData.inventory,
    c = this._minMaxSelector = window.gui.windowsContainer.appendChild(new u());
  e.equip = this._addEntry(d("ui.common.equip"), function () {
    r.equipItem(s._item.objectUID);
  });
  e.unequip = this._addEntry(d("tablet.common.unequip"), function () {
    r.unEquipItem(s._item.objectUID);
  });
  var h = e.target = this._addEntry(d("ui.common.target"), function () {
    return window.gui.openSimplePopup(d("tablet.ui.item.targetInfo"));
  });
  a.setDraggable(h, t, "itemContextMenu", null, {
    containerWidth: f,
    containerHeight: f
  });
  h.on("dragStart", function () {
    this.item = s._item;
    p.closeAll();
    s.close();
  });
  e.feed = this._addEntry(d("ui.common.feed"), function () {
    var e = s._item.item,
      t = p.getWindow("feed");
    return t.feedingBox.possessFeedItemForPet(s._item) ? void p.open("feed", {
      mode: "pet",
      item: s._item
    }) : window.gui.openSimplePopup(d("ui.item.errorNoFoodLivingItem", e.nameId));
  });
  e.use = this._addEntry(d("ui.common.use"), function () {
    var e = s._item;
    return e.item.type.needUseConfirm ? void window.gui.openConfirmPopup({
      title: d("ui.common.confirm"),
      message: d("ui.common.confirmationUseItem", e.item.nameId),
      cb: function (t) {
        t && l(e.objectUID);
      }
    }) : void l(e.objectUID);
  });
  e.multiUse = this._addEntry(d("ui.common.multipleUse"), function () {
    i("use", 1, s._item.quantity);
  });
  e.insertItemStats = this._addEntry(d("ui.craft.displayChatItem"), function () {
    window.gui.chat.insertLink("itemStats", s._item);
  });
  e.insertRecipe = this._addEntry(d("ui.craft.displayChatRecipe"), function () {
    window.gui.chat.insertLink("recipe", s._item);
  });
  e.bidHouseSell = this._addEntry(d("tablet.itemSellInBidHouse"), function () {
    o.openBidHouse(!0, null, s._item);
  });
  e.findInBestiary = this._addEntry(d("ui.common.bestiary"), function () {
    p.open("grimoire", {
      tabId: "bestiary",
      tabParams: {
        monsterIds: s._item.getProperty("dropMonsterIds"),
        label: s._item.getRawName()
      }
    });
  });
  e.recipes = this._addEntry(d("ui.craft.associateReceipts"), function () {
    p.open("itemRecipes", {
      itemData: s._item || s._dbItem
    });
  });
  e.itemSet = this._addEntry(d("ui.common.set"), function () {
    p.open("itemSets", s._item);
  });
  e.manage = this._addEntry(d("ui.item.manageItem"), function () {
    p.open("itemManage", {
      itemInstance: s._item
    });
  });
  e.manageShield = this._addEntry(d("ui.item.manageShield"), function () {
    p.open("shieldWindow", {
      itemInstance: s._item
    });
  });
  this.getEntryManageShield = function () {
    return e.manageShield;
  };
  e.freeMimicry = this._addEntry(d("ui.mimicry.free"), function () {
    var e = s._item;
    window.gui.openConfirmPopup({
      message: d("ui.mimicry.confirmFreePopup", e.getName()),
      cb: function (t) {
        t && window.dofus.sendMessage("MimicryObjectEraseRequestMessage", {
          hostUID: e.objectUID,
          hostPos: e.position
        });
      }
    });
  });
  e.mount = this._addEntry(d("ui.mount.viewMountDetails"), function () {
    p.getWindow("mount").showCertificateMount(s._item);
  });
  e.destroy = this._addEntry(d("ui.common.destroyThisItem"), function () {
    var e = s._item;
    return 1 === e.quantity ? void window.gui.playerData.inventory.confirmDestroyItem(e, 1) : void i("destroy", 1, e.quantity);
  });
  e.remove = this._addEntry(d("ui.common.remove"), function () {
    s._action = "remove";
  });
  c.on("confirm", function (e) {
    var t = s._item;
    switch (n) {
      case "use":
        window.dofus.sendMessage("ObjectUseMultipleMessage", {
          objectUID: t.objectUID,
          quantity: e
        });
        break;
      case "destroy":
        window.gui.playerData.inventory.confirmDestroyItem(t, e);
        break;
      default:
        console.warn("[ContextualMenuItem] unknow mode.");
    }
  });
  this._addCancel();
};
n = e;
c.open({
  min: t,
  max: i,
  x: s._position.x,
  y: s._position.y
});
e.equip = this._addEntry(d("ui.common.equip"), function () {
  r.equipItem(s._item.objectUID);
});
e.unequip = this._addEntry(d("tablet.common.unequip"), function () {
  r.unEquipItem(s._item.objectUID);
});
a.setDraggable(h, t, "itemContextMenu", null, {
  containerWidth: f,
  containerHeight: f
});
h.on("dragStart", function () {
  this.item = s._item;
  p.closeAll();
  s.close();
});
e.feed = this._addEntry(d("ui.common.feed"), function () {
  var e = s._item.item,
    t = p.getWindow("feed");
  return t.feedingBox.possessFeedItemForPet(s._item) ? void p.open("feed", {
    mode: "pet",
    item: s._item
  }) : window.gui.openSimplePopup(d("ui.item.errorNoFoodLivingItem", e.nameId));
});
e.use = this._addEntry(d("ui.common.use"), function () {
  var e = s._item;
  return e.item.type.needUseConfirm ? void window.gui.openConfirmPopup({
    title: d("ui.common.confirm"),
    message: d("ui.common.confirmationUseItem", e.item.nameId),
    cb: function (t) {
      t && l(e.objectUID);
    }
  }) : void l(e.objectUID);
});
e.multiUse = this._addEntry(d("ui.common.multipleUse"), function () {
  i("use", 1, s._item.quantity);
});
e.insertItemStats = this._addEntry(d("ui.craft.displayChatItem"), function () {
  window.gui.chat.insertLink("itemStats", s._item);
});
e.insertRecipe = this._addEntry(d("ui.craft.displayChatRecipe"), function () {
  window.gui.chat.insertLink("recipe", s._item);
});
e.bidHouseSell = this._addEntry(d("tablet.itemSellInBidHouse"), function () {
  o.openBidHouse(!0, null, s._item);
});
e.findInBestiary = this._addEntry(d("ui.common.bestiary"), function () {
  p.open("grimoire", {
    tabId: "bestiary",
    tabParams: {
      monsterIds: s._item.getProperty("dropMonsterIds"),
      label: s._item.getRawName()
    }
  });
});
e.recipes = this._addEntry(d("ui.craft.associateReceipts"), function () {
  p.open("itemRecipes", {
    itemData: s._item || s._dbItem
  });
});
e.itemSet = this._addEntry(d("ui.common.set"), function () {
  p.open("itemSets", s._item);
});
e.manage = this._addEntry(d("ui.item.manageItem"), function () {
  p.open("itemManage", {
    itemInstance: s._item
  });
});
e.manageShield = this._addEntry(d("ui.item.manageShield"), function () {
  p.open("shieldWindow", {
    itemInstance: s._item
  });
});
this.getEntryManageShield = function () {
  return e.manageShield;
};
e.freeMimicry = this._addEntry(d("ui.mimicry.free"), function () {
  var e = s._item;
  window.gui.openConfirmPopup({
    message: d("ui.mimicry.confirmFreePopup", e.getName()),
    cb: function (t) {
      t && window.dofus.sendMessage("MimicryObjectEraseRequestMessage", {
        hostUID: e.objectUID,
        hostPos: e.position
      });
    }
  });
});
e.mount = this._addEntry(d("ui.mount.viewMountDetails"), function () {
  p.getWindow("mount").showCertificateMount(s._item);
});
e.destroy = this._addEntry(d("ui.common.destroyThisItem"), function () {
  var e = s._item;
  return 1 === e.quantity ? void window.gui.playerData.inventory.confirmDestroyItem(e, 1) : void i("destroy", 1, e.quantity);
});
e.remove = this._addEntry(d("ui.common.remove"), function () {
  s._action = "remove";
});
c.on("confirm", function (e) {
  var t = s._item;
  switch (n) {
    case "use":
      window.dofus.sendMessage("ObjectUseMultipleMessage", {
        objectUID: t.objectUID,
        quantity: e
      });
      break;
    case "destroy":
      window.gui.playerData.inventory.confirmDestroyItem(t, e);
      break;
    default:
      console.warn("[ContextualMenuItem] unknow mode.");
  }
});
this._addCancel();
this.item = s._item;
p.closeAll();
s.close();
C.call(this, {
  className: "BidHouseShopWindow",
  freeContentDelay: N,
  positionInfo: {
    left: "0",
    bottom: "0",
    width: L,
    height: "100%"
  },
  title: v("ui.bidhouse.bigStoreItemList")
});
this.openOnItem = null;
this.backBtn = null;
this.history = null;
this.searchBox = null;
this.isListening = !1;
this.sortedAllowedTypes = {};
this.currentSearchText = null;
this.currentSearchItemTypeMap = null;
this.currentItemTypeElt = null;
this.liveItemTypeId = null;
this.liveItems = null;
this._categoryToDisplay = null;
this._categoryToDisplayItems = null;
this._requestedCategories = [];
this.on("open", this._onOpen);
this.on("close", this._onClose);
I.getWindow("tradeItem").displayItem("buy-bidHouse", e);
I.focusWindow("tradeItem");
this.searchBox.setValue("");
this._cancelSearch();
b(n, C);
e.exports = n;
n.minWidth = L;
n.openBidHouse = function (e, t, i) {
  var n = o("tradeStorage", i, "modify-bidHouse"),
    a = o("bidHouseShop", i);
  if (n !== R || a !== R) {
    if (n === P) {
      return;
    }
    if (a === P) {
      return;
    }
    if (e && n) {
      return;
    }
    if (!e && a) {
      return;
    }
  }
  window.dofus.sendMessage("NpcGenericActionRequestMessage", {
    npcId: t || 0,
    npcActionId: e ? 5 : 6,
    npcMapId: window.gui.playerData.position.mapId
  });
};
n.switchBuySellMode = function (e, t, i) {
  var o = I.getWindow("tradeItem");
  if (!i) {
    var a = o.getCurrentItem();
    a && (i = a.getItemInstance() ? a : a.getProperty("id"));
  }
  I.close("tradeItem");
  window.dofus.sendMessage("LeaveDialogRequestMessage");
  window.gui.once("ExchangeLeaveMessage", function () {
    n.openBidHouse(e, t, i);
  });
};
n.prototype._onOpen = function (e) {
  I.arrangeOpeningWindowVertically(this.id, {
    below: "wallet",
    fullHeight: !0
  });
  this.npcId = e.buyerDescriptor.npcContextualId;
  this.searchBox || (this._createContent(), this.isListening || this._setupEventListeners());
  this.switchToSellModeBtn.enable();
  this._showBlankUi();
  this.openOnItem && this.navigateToItem(this.openOnItem);
};
n.prototype._onClose = function () {
  I.close("tradeItem");
  this.liveItemTypeId = null;
  this.liveItems = null;
};
n.prototype._createContent = function () {
  this.history || (this.history = new w(O));
  this._createBackButton();
  this._createSearchBox();
  this._createSwitchToSellModeButton();
  this._createBidHouseCatList();
  this._createViewer();
  this._resetSearchBox();
};
n.prototype.freeContent = function () {
  this.windowBody.clearContent();
  this.searchBox = this.bidHouseCatList = this.shopViewer = null;
  this.currentItemTypeElt = null;
  this._categoryToDisplayItems = null;
  this.sortedAllowedTypes = {};
};
n.prototype._resetCategoryFilter = function () {
  this.currentItemTypeElt = null;
  this._categoryToDisplayItems = null;
  this.bidHouseCatList.reset();
};
n.prototype._showBlankUi = function () {
  this._resetSearchBox();
  this._resetCategoryFilter();
  this._refreshDisplayedItems();
};
n.prototype._searchAgainFromTop = function () {
  this._resetCategoryFilter();
  this._refreshDisplayedItems();
};
n.prototype._sortAllowedTypes = function (e) {
  if (this.sortedAllowedTypes[e]) {
    return this.sortedAllowedTypes[e];
  }
  for (var t = window.gui.databases.BidHouseCategories[e].allowedTypes, i = window.gui.databases.ItemTypes, n = [], o = 0; o < t.length; o++) {
    var a = t[o];
    n.push({
      text: i[a].nameId,
      id: a
    });
  }
  return n.sort(c), this.sortedAllowedTypes[e] = n, n;
};
n.prototype._selectItemType = function (e, t) {
  this.currentItemTypeElt = e;
  t ? this.bidHouseCatList.selectAndShowSubitem(e) : this._pushHistory();
  this._requestAndDisplayItemAvailability(e.data.id);
};
n.prototype._createBackButton = function () {
  if (!this.backBtn) {
    var e = this.backBtn = new m({
      className: "backButton",
      hidden: !0
    }, a);
    e.insertBefore(this.windowTitle);
    e.myWindow = this;
  }
};
n.prototype._createSwitchToSellModeButton = function () {
  var e = this;
  this.switchToSellModeBtn = this.headerRow.appendChild(new m({
    addIcon: !0,
    className: ["sellModeBtn", "greenButton"],
    tooltip: v("ui.bidhouse.bigStoreModeSell")
  }, function () {
    n.switchBuySellMode(!0, e.npcId);
    this.disable();
  }));
};
n.prototype._createSearchBox = function () {
  this.headerRow = this.windowBody.createChild("div", {
    className: "headerRow"
  });
  var e = this.searchBox = this.headerRow.appendChild(new S({
    maxLength: x
  }));
  e.on("search", this._search.bind(this));
};
n.prototype._createBidHouseCatList = function () {
  var e = this.bidHouseCatList = new g();
  e.myWindow = this;
  e.setSubitemsGetter(d);
  e.setFilter(h, u);
  var t = window.gui.databases.BidHouseCategories,
    i = [];
  for (var n in t) {
    i.push({
      text: t[~~n].description,
      id: ~~n
    });
  }
  i.sort(c);
  for (var o = 0; o < i.length; o++) {
    e.addItem(i[o].text, i[o].id);
  }
  e.getDom(this.windowBody).addClassNames("bidHouseCategories");
  e.on("subitemSelected", s);
  e.on("resized", l);
};
n.prototype._refreshFilter = function () {
  this._categoryToDisplayItems && this._refreshDisplayedItems();
  var e = this.bidHouseCatList.refreshFilter();
  0 === e.itemCount ? (this.bidHouseCatList.toggleBreadcrumb(!1), this.bidHouseCatList.setPlaceholder(v("tablet.bidHouse.noCatHasMatchingItem", this.currentSearchText)), this.shopViewer.setPlaceholder(v("tablet.bidHouse.noMatchingItem", this.currentSearchText)), this._resetShopViewerHeader()) : this.bidHouseCatList.setPlaceholder(null);
};
n.prototype._pushHistory = function () {
  0 === this.history.getCurrentSize() && this.backBtn.show();
  var e = {
    bookmark: this.bidHouseCatList.getSubitemBookmark(this.currentItemTypeElt),
    search: this.currentSearchText
  };
  this.history.push(e);
};
n.prototype._goBackInHistory = function () {
  (this.currentItemTypeElt || this.currentSearchText) && this.history.pop();
  var e = this.history.getLast();
  if (!e) {
    return this.backBtn.hide(), this._showBlankUi();
  }
  this.bidHouseCatList.toggleBreadcrumb(!1);
  this._search(e.search, !0);
  var t = this.bidHouseCatList.getSubitemByBookmark(e.bookmark);
  t ? this._selectItemType(t, !0) : this.bidHouseCatList.collapseAll();
};
n.prototype.navigateToItem = function (e, t) {
  this.openOnItem = null;
  var i;
  i = "number" == typeof e ? M.items[e] : e.getItem();
  var n = {};
  return n[i.typeId] = !0, this.currentSearchItemTypeMap = n, this.currentSearchText = i.getNameForSearch(), this.searchBox.setValue(i.nameId), this._resetCategoryFilter(), this._refreshFilter(), t || this._pushHistory(), !0;
};
n.prototype._search = function (e, t) {
  if (null === e || "" === e) {
    return this._cancelSearch(t);
  }
  var i = y.simplifyString(e);
  i !== this.currentSearchText && (this.searchBox.searchInput.blur(), this.currentSearchText = i, this.bidHouseCatList.inBreadcrumbMode() || this._searchAgainFromTop(), t ? this.searchBox.setValue(e) : this._pushHistory(), this._searchItemsByName());
};
n.prototype._cancelSearch = function (e) {
  this.searchBox.searchInput.blur();
  this.currentSearchText && (this.currentSearchText = null, this.bidHouseCatList.removeFilter(), this.bidHouseCatList.toggleBreadcrumb(!1), this.currentItemTypeElt && this.bidHouseCatList.selectAndShowSubitem(this.currentItemTypeElt), this._categoryToDisplayItems && this._refreshDisplayedItems(), e ? this.searchBox.clear() : this.currentItemTypeElt && this._pushHistory());
};
n.prototype._resetSearchBox = function () {
  this.searchBox.clear();
  this.currentSearchText = null;
};
n.prototype._createViewer = function () {
  function e(e, t) {
    var i = e.level - t.level;
    return 0 !== i ? i : e.nameId.localeCompare(t.nameId);
  }
  var t = [{
    id: "icon",
    format: function (e) {
      var t = new A("div", {
          className: "slot"
        }),
        i = t.createChild("div", {
          className: "icon"
        });
      return i.setStyle("backgroundImage", e.image), t;
    },
    sort: e,
    defaultSorter: !0
  }, {
    id: "name",
    header: "",
    format: function (e) {
      var t = new A("div", {
        className: "name",
        text: e.nameId
      });
      return e.etheral ? t.addClassNames("etheral") : e.itemSetId && t.addClassNames("itemSet"), t;
    },
    getContent: function (e) {
      return e.nameId;
    },
    sort: !0
  }];
  this.shopViewer = this.windowBody.appendChild(new T(t, "id", {
    manualFiltering: !0,
    tableOption: {
      scaleOnPress: !0
    }
  }));
  this.shopViewer.on("itemSelected", r);
  this.shopViewer.myWindow = this;
  var i = new A("div", {
    className: "filterHeader"
  });
  this.shopViewerHeaderLabel = i.createChild("div", {
    className: "label",
    text: v("tablet.bidHouse.nowOnSale")
  });
  this.shopViewerHeaderButton = i.appendChild(new _("", p.bind(this)));
  this.shopViewerHeaderButton.hide();
  this.shopViewer.setHeader(i);
};
n.prototype._setupEventListeners = function () {
  this.isListening = !0;
  var e = this;
  f.on("ExchangeTypesExchangerDescriptionForUserMessage", function (t) {
    e._requestedCategories.shift();
    e._storeItemAvailability(t.typeDescription, !0);
  });
  f.on("ExchangeBidHouseGenericItemAddedMessage", function (t) {
    e._storeItemAvailability(t.objGenericId);
  });
  f.on("ExchangeBidHouseGenericItemRemovedMessage", function (t) {
    e._storeNonAvailableItem(t.objGenericId);
  });
};
n.prototype._shouldItemBeDisplayed = function (e) {
  return e.typeId === this._categoryToDisplay && (!this.currentSearchText || e.getNameForSearch().indexOf(this.currentSearchText) >= 0);
};
n.prototype._refreshDisplayedItems = function () {
  var e = this._categoryToDisplayItems || [],
    t = !!e.length;
  if (e.length && this.currentSearchText) {
    for (var i = [], n = 0; n < e.length; n++) {
      var o = e[n];
      this._shouldItemBeDisplayed(o) && i.push(o);
    }
    e = i;
  }
  if (e.length > 0 && this.bidHouseCatList.toggleBreadcrumb(!0), t && this.currentSearchText) {
    var a = v("tablet.common.filterHeader", this._categoryToDisplayItems.length - e.length);
    this._setShopViewerHeader(a, this.currentSearchText);
  } else {
    this._resetShopViewerHeader();
  }
  if (!e.length) {
    this.shopViewer.clearContent();
    var s;
    if (this._categoryToDisplayItems) {
      var r = window.gui.databases.ItemTypes[this._categoryToDisplay].nameId;
      s = t ? v("tablet.bidHouse.noMatchInCat", this.currentSearchText, r) : v("tablet.bidHouse.nothingInCat", r);
    } else {
      s = v("tablet.bidHouse.searchOrSelect");
    }
    this.shopViewer.setPlaceholder(s);
  }
  this.shopViewer.setItemList(e);
};
n.prototype._setShopViewerHeader = function (e, t) {
  this.shopViewerHeaderLabel.setText(e);
  this.shopViewerHeaderButton.setLabel(t);
  this.shopViewerHeaderButton.show();
  this.shopViewer.table.setSortingHintVisible("name", !0);
};
n.prototype._resetShopViewerHeader = function () {
  this.shopViewerHeaderLabel.setText(v("tablet.bidHouse.nowOnSale"));
  this.shopViewerHeaderButton.hide();
  this.shopViewer.table.setSortingHintVisible("name", !1);
};
n.prototype._requestAndDisplayItemAvailability = function (e) {
  return e === this.liveItemTypeId ? (this._categoryToDisplayItems = this.liveItems, this._refreshDisplayedItems()) : (I.close("tradeItem"), this._categoryToDisplay = e, void (this._requestedCategories.indexOf(e) === -1 && (this._requestedCategories.push(e), this.liveItemTypeId = e, this.liveItems = null, this.shopViewer.setPlaceholder(" "), this.shopViewer.table.placeholder.frame.addClassNames("spinner"), window.dofus.sendMessage("ExchangeBidHouseTypeMessage", {
    type: e
  }))));
};
n.prototype._searchItemsByName = function () {
  this.searchBox.showAsSearching(!0);
  var e = this;
  E.searchDataMap("Items", {
    match: this.currentSearchText
  }, function (t, i) {
    if (t) {
      return console.error(t), e.shopViewer.setPlaceholder(v("tablet.searchError"));
    }
    var n = {};
    for (var o in i) {
      var a = i[~~o];
      n[a.typeId] = !0;
    }
    e.currentSearchItemTypeMap = n;
    e._refreshFilter();
    e.searchBox.showAsSearching(!1);
  });
};
n.prototype._storeItemAvailability = function (e, t) {
  var i = e instanceof Array,
    n = i ? e : [e],
    o = this;
  M.getItems(n, function (e, i) {
    if (e) {
      return console.error(e);
    }
    if (o.openState && (t || o.liveItems)) {
      o.shopViewer.table.placeholder.frame.delClassNames("spinner");
      var n = o._categoryToDisplayItems === o.liveItems;
      o.liveItems = t ? i : o.liveItems.concat(i);
      (n || t) && (o._categoryToDisplayItems = o.liveItems, o._refreshDisplayedItems());
    }
  });
};
n.prototype._storeNonAvailableItem = function (e) {
  if (this.openState && this.liveItems) {
    for (var t = this.liveItems.length - 1; t >= 0; t--) {
      if (this.liveItems[t].id === e) {
        this.liveItems.splice(t, 1);
        break;
      }
    }
    var i = this._categoryToDisplayItems === this.liveItems;
    i && this.shopViewer.removeItems([e]);
  }
};
I.close("tradeItem");
window.dofus.sendMessage("LeaveDialogRequestMessage");
window.gui.once("ExchangeLeaveMessage", function () {
  n.openBidHouse(e, t, i);
});
I.arrangeOpeningWindowVertically(this.id, {
  below: "wallet",
  fullHeight: !0
});
this.npcId = e.buyerDescriptor.npcContextualId;
this.searchBox || (this._createContent(), this.isListening || this._setupEventListeners());
this.switchToSellModeBtn.enable();
this._showBlankUi();
this.openOnItem && this.navigateToItem(this.openOnItem);
I.close("tradeItem");
this.liveItemTypeId = null;
this.liveItems = null;
this.history || (this.history = new w(O));
this._createBackButton();
this._createSearchBox();
this._createSwitchToSellModeButton();
this._createBidHouseCatList();
this._createViewer();
this._resetSearchBox();
this.windowBody.clearContent();
this.searchBox = this.bidHouseCatList = this.shopViewer = null;
this.currentItemTypeElt = null;
this._categoryToDisplayItems = null;
this.sortedAllowedTypes = {};
this.currentItemTypeElt = null;
this._categoryToDisplayItems = null;
this.bidHouseCatList.reset();
this._resetSearchBox();
this._resetCategoryFilter();
this._refreshDisplayedItems();
this._resetCategoryFilter();
this._refreshDisplayedItems();
this.currentItemTypeElt = e;
t ? this.bidHouseCatList.selectAndShowSubitem(e) : this._pushHistory();
this._requestAndDisplayItemAvailability(e.data.id);
e.insertBefore(this.windowTitle);
e.myWindow = this;
n.switchBuySellMode(!0, e.npcId);
this.disable();
e.myWindow = this;
e.setSubitemsGetter(d);
e.setFilter(h, u);
e.getDom(this.windowBody).addClassNames("bidHouseCategories");
e.on("subitemSelected", s);
e.on("resized", l);
this.bidHouseCatList.toggleBreadcrumb(!1);
this._search(e.search, !0);
this.searchBox.searchInput.blur();
this.currentSearchText && (this.currentSearchText = null, this.bidHouseCatList.removeFilter(), this.bidHouseCatList.toggleBreadcrumb(!1), this.currentItemTypeElt && this.bidHouseCatList.selectAndShowSubitem(this.currentItemTypeElt), this._categoryToDisplayItems && this._refreshDisplayedItems(), e ? this.searchBox.clear() : this.currentItemTypeElt && this._pushHistory());
this.searchBox.clear();
this.currentSearchText = null;
this.shopViewer = this.windowBody.appendChild(new T(t, "id", {
  manualFiltering: !0,
  tableOption: {
    scaleOnPress: !0
  }
}));
this.shopViewer.on("itemSelected", r);
this.shopViewer.myWindow = this;
this.shopViewerHeaderLabel = i.createChild("div", {
  className: "label",
  text: v("tablet.bidHouse.nowOnSale")
});
this.shopViewerHeaderButton = i.appendChild(new _("", p.bind(this)));
this.shopViewerHeaderButton.hide();
this.shopViewer.setHeader(i);
f.on("ExchangeTypesExchangerDescriptionForUserMessage", function (t) {
  e._requestedCategories.shift();
  e._storeItemAvailability(t.typeDescription, !0);
});
f.on("ExchangeBidHouseGenericItemAddedMessage", function (t) {
  e._storeItemAvailability(t.objGenericId);
});
f.on("ExchangeBidHouseGenericItemRemovedMessage", function (t) {
  e._storeNonAvailableItem(t.objGenericId);
});
e._requestedCategories.shift();
e._storeItemAvailability(t.typeDescription, !0);
this.shopViewerHeaderLabel.setText(e);
this.shopViewerHeaderButton.setLabel(t);
this.shopViewerHeaderButton.show();
this.shopViewer.table.setSortingHintVisible("name", !0);
this.shopViewerHeaderLabel.setText(v("tablet.bidHouse.nowOnSale"));
this.shopViewerHeaderButton.hide();
this.shopViewer.table.setSortingHintVisible("name", !1);
e.currentSearchItemTypeMap = n;
e._refreshFilter();
e.searchBox.showAsSearching(!1);
o.liveItems = t ? i : o.liveItems.concat(i);
(n || t) && (o._categoryToDisplayItems = o.liveItems, o._refreshDisplayedItems());
c.call(this);
this._init();
e.toggleClassName("selected", t);
e.subitemList.toggleDisplay(t);
d(n, c);
e.exports = n;
n.prototype._init = function () {
  this.parentElt = null;
  this.elt = null;
  this.items = [];
  this.infos = [];
  this.breadcrumb = null;
  this.list = null;
  this.currentDeployedItem = null;
  this.currentSubitem = null;
  this.isFilterOn = !1;
  this.itemFilterFunc = null;
  this.subitemFilterFunc = null;
  this.singleItem = null;
  this.singleSubitem = null;
};
n.prototype.clearContent = function () {
  this.elt && (this.elt.clearContent(), this._init());
};
n.prototype.reset = function () {
  if (this.elt) {
    var e = this.currentDeployedItem;
    e && this.deployItem(e, !1);
    this.refresh(!0);
    this._selectSubitem(null);
    this.removeFilter();
  }
};
n.prototype.setBreadcrumbText = function (e) {
  this.breadcrumbText.setText(e);
};
n.prototype.inBreadcrumbMode = function () {
  return this.breadcrumb.isVisible();
};
n.prototype.toggleBreadcrumb = function (e) {
  this.elt.toggleClassName("onlyBreadcrumb", e);
  this.breadcrumb.toggleDisplay(e);
  this.list.toggleDisplay(!e);
  this.emit("resized");
  e || (this.list.refresh(), this.currentSubitem && this.list.showElement(this.currentSubitem));
};
n.prototype.setSubitemsGetter = function (e) {
  this.getSubitemsFunc = e;
};
n.prototype.colorItems = function () {
  for (var e = !0, t = 0; t < this.items.length; t++) {
    var i = this.list.getItem(t);
    i.isVisible() && (i.toggleClassName("odd", e), e = !e);
  }
};
n.prototype.getDom = function (e) {
  if (this.elt) {
    return this.elt;
  }
  if (!this.items.length) {
    return console.warn("Empty DrillDownList");
  }
  this.parentElt = e;
  var t = this.elt = e.createChild("div", {
      className: "drillDownList"
    }),
    i = this.breadcrumb = t.appendChild(new l({
      className: "breadcrumb",
      hidden: !0,
      addIcon: "before",
      text: "_"
    }, s));
  i.myDrilldownList = this;
  this.breadcrumbText = i.getChildren()[1];
  this.list = t.appendChild(new u({
    className: "tree"
  }));
  this.list.myDrilldownList = this;
  for (var n = 0; n < this.items.length; n++) {
    var a = new h("div", {
      className: "sublistHeader"
    });
    a.createChild("div", {
      className: "arrow"
    });
    a.createChild("div", {
      className: "text",
      text: this.items[n]
    });
    var r = this.list.addItem({
      id: n,
      element: a
    }, {
      noRefresh: !0
    });
    r.info = this.infos[n];
    r.myDrilldownList = this;
  }
  return this.colorItems(), this.list.setStyle("max-height", e.rootElement.clientHeight + "px"), this.list.refresh(), this.list.on("selected", o), this.elt = t, t;
};
n.prototype._createSubitemList = function (e) {
  for (var t = this.getSubitemsFunc(e), i = e.subitemList = e.appendChild(new h("div", {
      className: "subitemList",
      hidden: !0
    })), n = 0; n < t.length; n++) {
    var o = t[n],
      s = void 0 !== o.id ? o.id : n,
      r = i.appendChild(new l({
        text: o.text,
        className: "subitem",
        name: s
      }, a));
    r.data = o;
    r.myTopItem = e;
  }
};
n.prototype.addItem = function (e, t) {
  this.items.push(e);
  this.infos.push(void 0 !== t ? t : this.infos.length);
};
n.prototype.getItemCount = function () {
  return this.list.getItemCount();
};
n.prototype.getItem = function (e) {
  return this.items[e];
};
n.prototype.getItemElt = function (e) {
  return this.list.getItem(e);
};
n.prototype.getSubitemBookmark = function (e) {
  return e ? [e.myTopItem.id, e.getWuiName()] : null;
};
n.prototype.getSubitemByBookmark = function (e) {
  if (!e) {
    return null;
  }
  var t = this.list.getItem(e[0]);
  return t ? (t.subitemList || this._createSubitemList(t), t.subitemList.getChild(e[1])) : null;
};
n.prototype.selectAndShowSubitem = function (e) {
  this._selectSubitem(e, !1, !0);
  this.list.isVisible() && (this.deployItem(e.myTopItem, !0), this.list.showElement(e));
};
n.prototype.collapseAll = function () {
  this.currentSubitem && this.deselectSubitem();
  this.currentDeployedItem && this.deployItem(this.currentDeployedItem, !1);
};
n.prototype.deselectSubitem = function () {
  this._selectSubitem(null);
};
n.prototype._selectSubitem = function (e, t, i) {
  var n = this.currentSubitem;
  return n && n.delClassNames("selected"), this.currentSubitem = e, e ? (this.setBreadcrumbText(this.items[e.myTopItem.id] + " > " + e.data.text), e.addClassNames("selected"), void (i || this.emit("subitemSelected", e, t))) : this.toggleBreadcrumb(!1);
};
n.prototype.getSelectedSubitem = function () {
  return this.currentSubitem;
};
n.prototype.setPlaceholder = function (e) {
  this.list.setPlaceholderText(e);
};
n.prototype.refresh = function (e) {
  this.colorItems();
  this.list.refresh();
  e && this.list.goToTop();
};
n.prototype.setFilter = function (e, t) {
  this.itemFilterFunc = e;
  this.subitemFilterFunc = t;
};
n.prototype._filterOneItemSubitems = function (e) {
  if (!this.isFilterOn) {
    return this._resetFilterOnSubitems(e);
  }
  for (var t, i = 0, n = e.subitemList.getChildren(), o = 0; o < n.length; o++) {
    var a = n[o];
    this.subitemFilterFunc(e, o, a) ? (i++, 1 === i && (t = a), a.show()) : a.hide();
  }
  return 1 === i && (this.singleSubitem = t), i;
};
n.prototype.isItemDeployed = function (e) {
  return e.subitemList && e.subitemList.isVisible();
};
n.prototype.deployItem = function (e, t) {
  if (t === this.isItemDeployed(e)) {
    return 0;
  }
  t && !e.subitemList && this._createSubitemList(e);
  var i = this.currentDeployedItem;
  i && e !== i && r(i, !1);
  r(e, t);
  this.currentDeployedItem = t ? e : null;
  var n = 0;
  return t && (this.subitemFilterFunc ? n = this._filterOneItemSubitems(e) : (n = e.subitemList.getChildCount(), 1 === n && (this.singleSubitem = e.subitemList.getChildren()[0]))), this.list.refresh(), this.list.showElement(e), n;
};
n.prototype.refreshFilter = function () {
  this.isFilterOn = !0;
  for (var e, t = 0, i = this.list.getItems(), n = i.length - 1; n >= 0; n--) {
    var o = i[n];
    this.itemFilterFunc(o) ? (t++, 1 === t && (e = o), this.isItemDeployed(o) && this.subitemFilterFunc && this._filterOneItemSubitems(o), o.show()) : o.hide();
  }
  var a = 0;
  return 1 === t && (this.singleItem = e, a = this.deployItem(e, !0), 1 === a && this._selectSubitem(this.singleSubitem, !0)), this.refresh(), {
    itemCount: t,
    subitemCount: a
  };
};
n.prototype._resetFilterOnSubitems = function (e) {
  if (e.subitemList) {
    for (var t = e.subitemList.getChildren(), i = 0; i < t.length; i++) {
      t[i].show();
    }
  }
};
n.prototype.removeFilter = function () {
  if (this.isFilterOn) {
    this.isFilterOn = !1;
    for (var e = this.list.getItems(), t = e.length - 1; t >= 0; t--) {
      var i = e[t];
      i.show();
      this._resetFilterOnSubitems(i);
    }
    this.refresh();
    this.currentSubitem && (this.list.showElement(this.currentSubitem), this.emit("subitemSelected", this.currentSubitem, !0));
  }
};
this.parentElt = null;
this.elt = null;
this.items = [];
this.infos = [];
this.breadcrumb = null;
this.list = null;
this.currentDeployedItem = null;
this.currentSubitem = null;
this.isFilterOn = !1;
this.itemFilterFunc = null;
this.subitemFilterFunc = null;
this.singleItem = null;
this.singleSubitem = null;
e && this.deployItem(e, !1);
this.refresh(!0);
this._selectSubitem(null);
this.removeFilter();
this.elt.toggleClassName("onlyBreadcrumb", e);
this.breadcrumb.toggleDisplay(e);
this.list.toggleDisplay(!e);
this.emit("resized");
e || (this.list.refresh(), this.currentSubitem && this.list.showElement(this.currentSubitem));
i.myDrilldownList = this;
this.breadcrumbText = i.getChildren()[1];
this.list = t.appendChild(new u({
  className: "tree"
}));
this.list.myDrilldownList = this;
a.createChild("div", {
  className: "arrow"
});
a.createChild("div", {
  className: "text",
  text: this.items[n]
});
r.info = this.infos[n];
r.myDrilldownList = this;
r.data = o;
r.myTopItem = e;
this.items.push(e);
this.infos.push(void 0 !== t ? t : this.infos.length);
this._selectSubitem(e, !1, !0);
this.list.isVisible() && (this.deployItem(e.myTopItem, !0), this.list.showElement(e));
this.currentSubitem && this.deselectSubitem();
this.currentDeployedItem && this.deployItem(this.currentDeployedItem, !1);
this.colorItems();
this.list.refresh();
e && this.list.goToTop();
this.itemFilterFunc = e;
this.subitemFilterFunc = t;
i && e !== i && r(i, !1);
r(e, t);
this.currentDeployedItem = t ? e : null;
i.show();
this._resetFilterOnSubitems(i);
this.refresh();
this.currentSubitem && (this.list.showElement(this.currentSubitem), this.emit("subitemSelected", this.currentSubitem, !0));
n.SingleSelectionList = o;
e.exports = n;
r.call(this, e);
this.addClassNames("ListV2");
this.options = t || {};
this.placeholder = null;
o(n, r);
e.exports = n;
n.prototype._createItem = function (e) {
  e = e || {};
  var t = e.id,
    i = e.element;
  if (!t && 0 !== t) {
    return console.error("List: Invalid Id");
  }
  var n = this.content.createChild("div", {
    name: t,
    className: "listItem"
  });
  return n.myList = this, n.id = t, n.data = e.data, "object" == typeof i ? n.appendChild(i) : n.setText(i), l(n), n.on("tap", this._tapHandler), n;
};
n.prototype.addItem = function (e, t) {
  t = t || {};
  var i = this._createItem(e);
  return t.noRefresh || this.refresh(), i;
};
n.prototype.addItems = function (e, t) {
  t = t || {};
  for (var i, n = 0; n < e.length; n += 1) {
    i = e[n];
    this._createItem(i);
  }
  return t.noRefresh || this.refresh(), this.getItems();
};
n.prototype.removeItem = function (e) {
  var t = this.getItem(e);
  t && t.destroy();
};
n.prototype.selectItem = function (e, t) {
  t = t || {};
  var i = this.getItem(e);
  i && (i.isSelected = !0, i.addClassNames("selected"), t.noEvent || this.emit("selected", i), t.noSound || s("GEN_BUTTON"), t.scrollToElement && this.scrollToElement(i));
};
n.prototype.deselectItem = function (e, t) {
  t = t || {};
  var i = this.getItem(e);
  i && (i.isSelected = !1, i.delClassNames("selected"), t.noEvent || this.emit("deselected", i), t.noSound || s("GEN_BUTTON"));
};
n.prototype.deselectAll = function () {
  for (var e = this.getItems(), t = 0; t < e.length; t += 1) {
    var i = e[t];
    i.isSelected && this.deselectItem(i.getWuiName(), {
      noSound: !0
    });
  }
};
n.prototype.getItemCount = function () {
  return this.content.getChildCount();
};
n.prototype.getItem = function (e) {
  return this.content.getChild(e);
};
n.prototype.getItems = function () {
  return this.content.getChildren();
};
n.prototype.getContentElement = function () {
  return this.content;
};
n.prototype.clearContent = function () {
  this.content.clearContent();
};
n.prototype.setPlaceholderText = function (e) {
  this.placeholder || (this.placeholder = new a(this));
  this.placeholder.setText(e);
};
n.prototype._tapHandler = function () {
  var e = this.myList,
    t = this.getWuiName();
  return this.isSelected ? void (e.options.disableSelectionToggle || e.deselectItem(t)) : e.selectItem(t);
};
i = e[n];
this._createItem(i);
this.placeholder || (this.placeholder = new a(this));
this.placeholder.setText(e);
this.parent = e;
this.options = t || {};
this.frame = null;
this.text = null;
e.exports = n;
n.prototype.setText = function (e) {
  return e ? (this.frame || (this.frame = this.parent.createChild("div", {
    className: "placeholderFrame"
  }), this.options.headerElement && this.frame.addClassNames("withHeader"), this.text = this.frame.createChild("div", {
    className: "placeholderText"
  })), this.options.noHeight || this._computeHeight(), this.text.setText(e), void this.frame.show()) : this.frame && this.frame.hide();
};
n.prototype._computeHeight = function () {
  var e = this.parent;
  e instanceof o && (e = e.getParent());
  var t = e.rootElement.offsetHeight;
  0 === t && console.error(new Error("Placeholder computing a 0 height"));
  this.options.headerElement && (t -= this.options.headerElement.rootElement.offsetHeight);
  this.frame.setStyle("minHeight", t + "px");
};
n.prototype.toggleDisplay = function (e) {
  this.frame && this.frame.toggleDisplay(!!e);
};
n.prototype.refresh = function () {
  this.frame && this.frame.isVisible() && this.setText(this.text.getText());
};
0 === t && console.error(new Error("Placeholder computing a 0 height"));
this.options.headerElement && (t -= this.options.headerElement.rootElement.offsetHeight);
this.frame.setStyle("minHeight", t + "px");
a.call(this, e, t);
this.addClassNames("SingleSelectionList");
this.currentSelected = null;
o(n, a);
e.exports = n;
n.prototype.removeItem = function (e) {
  var t = this.getItem(e);
  t && (this.currentSelected = null);
  a.prototype.removeItem.call(this, e);
};
n.prototype.selectItem = function (e, t) {
  this.currentSelected && this.deselectItem(this.currentSelected.getWuiName(), {
    noSound: !0
  });
  a.prototype.selectItem.call(this, e, t);
  var i = this.getItem(e);
  i && (this.currentSelected = i);
};
n.prototype.deselectItem = function (e, t) {
  var i = this.getItem(e);
  i && i.isSelected && (this.currentSelected = null, a.prototype.deselectItem.call(this, e, t));
};
n.prototype.deselectAll = function () {
  this.currentSelected && this.deselectItem(this.currentSelected.getWuiName(), {
    noSound: !0
  });
};
n.prototype._tapHandler = function () {
  var e = this.myList,
    t = this.getWuiName(),
    i = e.currentSelected;
  i ? i === this ? (i.tappedOnMe = !0, e.options.disableSelectionToggle || e.deselectItem(i.getWuiName(), {
    noSound: !0
  }), i.tappedOnMe = !1) : (e.deselectItem(e.currentSelected.getWuiName(), {
    noSound: !0
  }), e.selectItem(t)) : e.selectItem(t);
};
t && (this.currentSelected = null);
a.prototype.removeItem.call(this, e);
this.currentSelected && this.deselectItem(this.currentSelected.getWuiName(), {
  noSound: !0
});
a.prototype.selectItem.call(this, e, t);
n = n || {};
o.call(this, {
  className: "filterTagButton",
  tooltip: n.tooltip
}, t);
this.tapHandler = t;
this.filterName = i;
n.withIcon && (a.createChild("div", {
  className: "btnIcon"
}), a.addClassNames("withIcon"));
this._labelElement = a.createChild("div", {
  className: "btnText",
  text: e
});
a.createChild("div", {
  className: "cross",
  text: "x"
});
a(n, o);
e.exports = n;
n.prototype.setLabel = function (e) {
  this._labelElement.setText(e);
};
this.maxSize = e;
this.clear();
e.exports = i;
i.prototype.clear = function () {
  this.buf = new Array(this.maxSize);
  this.first = 0;
  this.last = 0;
  this.empty = !0;
};
i.prototype.isEmpty = function () {
  return this.empty;
};
i.prototype.isFull = function () {
  return this.last === (this.first + this.maxSize - 1) % this.maxSize;
};
i.prototype.getCurrentSize = function () {
  return this.empty ? 0 : (this.last - this.first + this.maxSize) % this.maxSize + 1;
};
i.prototype.push = function (e) {
  var t;
  if (this.empty) {
    this.buf[this.last] = e;
    this.empty = !1;
  } else {
    var i = (this.last + 1) % this.maxSize;
    i === this.first && (t = this.buf[i], this.first = (i + 1) % this.maxSize);
    this.buf[i] = e;
    this.last = i;
  }
  return t;
};
i.prototype.pop = function () {
  if (!this.empty) {
    var e = this.buf[this.last];
    return this.buf[this.last] = void 0, this.first === this.last ? this.empty = !0 : this.last = (this.last + this.maxSize - 1) % this.maxSize, e;
  }
};
i.prototype.getFirst = function () {
  if (!this.empty) {
    return this.buf[this.first];
  }
};
i.prototype.getLast = function () {
  if (!this.empty) {
    return this.buf[this.last];
  }
};
i.prototype.getBuffer = function () {
  return this.buf;
};
this.buf = new Array(this.maxSize);
this.first = 0;
this.last = 0;
this.empty = !0;
this.buf[this.last] = e;
this.empty = !1;
i === this.first && (t = this.buf[i], this.first = (i + 1) % this.maxSize);
this.buf[i] = e;
this.last = i;
this.price = e;
this.timestamp = t;
E[e] = new n(t, Date.now());
T[e] && (T[e].averagePrice = t);
s(e.genericId, e.averagePrice);
e.genericId === x && L(e.averagePrice);
t.playerData && t.playerData.characterBaseInformations && i === t.playerData.characterBaseInformations.id && t.playerData.inventory.objects[e] && M.dofus.sendMessage("ObjectUseMessage", {
  objectUID: e
});
n();
c.push(new f(s));
l.push("gfx/items/" + s.iconId + ".png");
delete I[a];
d.emit("loaded");
T[o.id] = o;
o.image = t[i];
delete I[o.id];
a.loaded = !0;
a.emit("loaded");
"function" == typeof t && (i = t, t = null);
Array.isArray(e) || (e = [e]);
a[r.objectGID] = !0;
s.push(new g(r));
l || (l = T[S], console.error('ItemManager: Player got a "Picfail Puree" instead of the itemId', r.objectGID));
r.setItem(l);
a[r.objectUID] = r;
t.Item = f;
t.ItemInstance = g;
t.getAveragePrice = o;
t.getFreshAveragePrice = function (e, t) {
  var i = o(e);
  return a(e) ? t(i) : (x = e, L = t, M.dofus.sendMessage("ExchangeBidHousePriceMessage", {
    genId: e
  }), void (E[e] = new n(i, Date.now())));
};
t.useObject = l;
t.getItems = c;
t.initialize = function (e) {
  var t = M.dofus.connectionManager;
  C = M.gui.databases.ItemTypes;
  for (var i in C) {
    var n = C[i];
    n.category = p.getCategory(n.superTypeId);
    n.possiblePositions = p.getTypePositions(n.superTypeId);
  }
  c([S], e);
  var o = function () {
    w.isFightMode || (w.removeListener("gameContextChanged", o), M.dofus.sendMessage("ObjectAveragePricesGetMessage"));
  };
  w.on("gameContextChanged", o);
  M.gui.on("ObjectAveragePricesMessage", function (e) {
    for (var t = 0, i = e.ids.length; t < i; t += 1) {
      s(e.ids[t], e.avgPrices[t]);
    }
  });
  t.on("ExchangeBidPriceMessage", r);
};
t.getItemTypeMap = function () {
  return C ? C : void console.error(new Error("Fatal error: item types not loaded"));
};
t.createItemInstances = d;
t.getCategoryName = p.getCategoryName;
t.isEquippable = p.isEquippable;
t.isEquipped = p.isEquipped;
t.unlinkedItemsFilter = p.unlinkedItemsFilter;
t.positions = h.positions;
t.categories = h.categories;
n.category = p.getCategory(n.superTypeId);
n.possiblePositions = p.getTypePositions(n.superTypeId);
w.on("gameContextChanged", o);
M.gui.on("ObjectAveragePricesMessage", function (e) {
  for (var t = 0, i = e.ids.length; t < i; t += 1) {
    s(e.ids[t], e.avgPrices[t]);
  }
});
t.on("ExchangeBidPriceMessage", r);
e.exports.types = a;
t.superTypeNotEquippable = [n.RESOURCE, n.QUEST_OBJECT, n.MUTATION, n.BOOST_FOOD, n.BLESSING, n.CURSE, n.USABLE_OBJECT, n.ROLEPLAY_BUFF, n.MOUNT, n.FOLLOWER, n.CAPTURING_OBJECT, n.LIVING_OBJECT];
e.exports.getTypePositions = n;
e.exports.getCategoryName = o;
e.exports.getCategory = a;
e.exports.isEquippable = s;
e.exports.isEquipped = r;
e.exports.unlinkedItemsFilter = l;
this.isWeapon = "Weapon" === e._type;
this.averagePrice = -1;
this.etheral && (this.descriptionId = c("ui.common.etherealWeaponDescription"));
this.type = u.getItemTypeMap()[this.typeId];
this.type || m.error("Item #" + this.id + " has invalid typeId #" + this.typeId);
this.averagePrice = u.getAveragePrice(this.id);
e && m.error("criterion initialize: error for item:", t.id, "criteria:", t.criteria);
i();
s && 0 !== l && (f += " " + e.operator.text + " ");
f += t;
0 !== l && c.operator === r.groupOperators.or && (f += c.getOperatorText() + " ");
f += c.getText();
s ? o += f : o = f;
e.exports = n;
n.initializeList = function (e, t) {
  s.parallel([function (t) {
    s.each(e, function (e, t) {
      return e.criteria ? (e.conditions = r.createGroupCriterion(e.criteria, e), void o(e.conditions, e, t)) : t();
    }, t);
  }, function (t) {
    s.each(e, function (e, t) {
      return e.criteriaTarget ? (e.targetConditions = r.createGroupCriterion(e.criteriaTarget, e), void o(e.targetConditions, e, t)) : t();
    }, t);
  }, function (t) {
    for (var i = [], n = 0; n < e.length; n += 1) {
      var o = e[n];
      if (o.possibleEffects) {
        var a,
          s = {};
        for (a = 0; a < o.upgradeEffects.length; a += 1) {
          var r = o.upgradeEffects[a];
          s[r.typeActionId] = !0;
        }
        for (a = 0; a < o.possibleEffects.length; a += 1) {
          var c = o.possibleEffects[a];
          o.isShield && c.effectId === g.ACTION_ID_SHIELD_LEVEL && (c.diceNum = 1);
          s[c.effectId] && (c.baseValue = c.diceNum);
          c.effectCaller = "Item id " + o.id;
          i.push(c);
        }
      }
    }
    l.createEffectInstances(i, function (i, n) {
      if (i) {
        return t(i);
      }
      for (var o = 0; o < e.length; o++) {
        var a = e[o];
        if (a.possibleEffects) {
          var s = a.possibleEffects.length,
            r = s > 0 ? n.splice(0, s) : [];
          r = r.filter(function (e) {
            return e && e.effect;
          });
          a.possibleEffectsMap = {};
          a.possibleEffects = r;
          for (var l = 0; l < r.length; l++) {
            a.possibleEffectsMap[r[l].effectId] = r[l];
          }
        }
      }
      t();
    });
  }, function (t) {
    s.each(e, function (e, t) {
      return e.type.superTypeId !== p.PET ? t() : (e.foodItems = [], e.foodTypes = [], void h.getData("Pets", e.id, function (i, n) {
        return i || !n ? t() : (e.foodItems = n.foodItems, e.foodTypes = n.foodTypes, t());
      }));
    }, t);
  }, function (t) {
    for (var i = [], n = [], o = 0; o < e.length; o++) {
      var a = e[o],
        s = a.itemSetId;
      s && (i.push(s), n.push(a));
    }
    return i.length ? void h.getDataMap("ItemSets", i, function (e, i) {
      if (e) {
        return t(e);
      }
      for (var o = 0; o < n.length; o++) {
        var a = n[o],
          s = i[a.itemSetId];
        s ? a.itemSetName = s.nameId : (m.error(new Error("ItemSet id " + a.itemSetId + " for item id " + a.id + " does not exist.")), a.itemSetName = null);
      }
      return t();
    }) : t();
  }], t);
};
n.prototype.initialize = function (e) {
  n.initializeList([this], e);
};
n.prototype.getRawName = function () {
  return this.nameId;
};
n.prototype.getName = function () {
  var e = window.gui.playerData.isAbleToSeeId(),
    t = this.getRawName();
  return e && (t += " (" + this.id + ")"), t;
};
n.prototype.getNameForSearch = function () {
  return this._simplifiedName ? this._simplifiedName : (this._simplifiedName = d.simplifyString(this.nameId), this._simplifiedName);
};
n.prototype._getStatsFormatted = function () {
  var e = [];
  if (!this.isWeapon) {
    return m.error(new Error("getProperty(statsFormatted) should never be called on non-weapon Item")), e;
  }
  var t = c("ui.stats.shortAP") + c("ui.common.colon") + this.apCost;
  this.maxCastPerTurn && (t += " (" + c("ui.item.usePerTurn", this.maxCastPerTurn) + ")");
  e.push(t);
  var i = c("ui.common.range") + c("ui.common.colon");
  if (i += this.range === this.minRange ? this.range : this.minRange + " - " + this.range, e.push(i), this.criticalFailureProbability || this.criticalHitProbability) {
    var n = "";
    if (this.criticalHitProbability) {
      0 !== this.criticalHitBonus && e.push(c("ui.item.critical.bonus", this.criticalHitBonus));
      n += c("ui.common.short.CriticalHit") + c("ui.common.colon") + "1/" + this.criticalHitProbability;
      var o = window.gui.playerData.characters.mainCharacter.characteristics;
      if (o) {
        var a = d.totalCriticalHitRate(this.criticalHitProbability, o);
        e.push(c("ui.itemtooltip.itemCriticalReal", "1/" + a));
      }
    }
    this.criticalFailureProbability && (n += (this.criticalHitProbability ? " - " : "") + c("ui.common.short.CriticalFailure") + c("ui.common.colon") + "1/" + this.criticalFailureProbability);
    e.push(n);
  }
  return this.castInLine && this.range > 1 && !this.castInDiagonal && e.push(c("ui.spellInfo.castInLine")), !this.castTestLos && this.range > 1 && e.push(c("ui.spellInfo.castWithoutLos")), e;
};
n.prototype._getConditionsFormatted = function () {
  return a(this.conditions);
};
n.prototype._getTargetConditionsFormatted = function () {
  var e = "(" + c("ui.item.target") + ") ";
  return a(this.targetConditions, e);
};
n.prototype.getSuperTypeId = function () {
  return this.type.superTypeId;
};
n.prototype.isEquippable = function () {
  return u.isEquippable(this.type.superTypeId);
};
n.prototype.isCosmetic = function () {
  return this.typeId === f.types.cosmeticHat || this.typeId === f.types.cosmeticCape || this.typeId === f.types.cosmeticShield || this.typeId === f.types.cosmeticWeapon || this.typeId === f.types.cosmeticPet || this.typeId === f.types.cosmeticMount;
};
n.prototype.isShield = function () {
  return this.typeId === f.types.shield;
};
n.prototype.isShieldManageable = function () {
  return !1;
};
n.prototype.isLegendaryWeapon = function () {
  return this.typeId === f.types.cosmeticLegendaryWeapon;
};
n.prototype.isFullSoulStone = function () {
  return this.typeId === f.types.fullSoulStone;
};
n.prototype.getShieldLevel = function (e, t) {
  for (var i = 0; i < t.length; i += 1) {
    if (t[i] < e) {
      return i;
    }
  }
  return t.length;
};
o.isShield && c.effectId === g.ACTION_ID_SHIELD_LEVEL && (c.diceNum = 1);
s[c.effectId] && (c.baseValue = c.diceNum);
c.effectCaller = "Item id " + o.id;
i.push(c);
r = r.filter(function (e) {
  return e && e.effect;
});
a.possibleEffectsMap = {};
a.possibleEffects = r;
this.maxCastPerTurn && (t += " (" + c("ui.item.usePerTurn", this.maxCastPerTurn) + ")");
e.push(t);
0 !== this.criticalHitBonus && e.push(c("ui.item.critical.bonus", this.criticalHitBonus));
n += c("ui.common.short.CriticalHit") + c("ui.common.colon") + "1/" + this.criticalHitProbability;
this.criticalFailureProbability && (n += (this.criticalHitProbability ? " - " : "") + c("ui.common.short.CriticalFailure") + c("ui.common.colon") + "1/" + this.criticalFailureProbability);
e.push(n);
n.prototype.isChangingCharacterLookWhenEquipped = function () {
  return v.indexOf(this.type.superTypeId) !== -1;
};
n.prototype.getItem = function () {
  return this;
};
n.prototype.getItemInstance = function () {
  return null;
};
n.prototype.getProperty = function (e) {
  return "nameId" === e ? this.getName() : "conditionsFormatted" === e ? this._getConditionsFormatted() : "targetConditionsFormatted" === e ? this._getTargetConditionsFormatted() : "statsFormatted" === e ? this._getStatsFormatted() : ("weight" === e && (e = "realWeight"), this.hasOwnProperty(e) ? this[e] : _[e]);
};
t.createCriterion = function (e, t) {
  var i = e.substring(0, 2);
  return J[i] ? new J[i](e, t) : void console.warn("unknown criterion: " + i);
};
t.createGroupCriterion = function (e, t) {
  return e = e.replace(/[\s+]/g, ""), new n(e, this, t);
};
t.groupOperators = n.operators;
c.or = {
  token: "|",
  isRespectedFn: function (e, t) {
    for (var i = 0, n = e.length; i < n; i += 1) {
      if (e[i].isRespected(t)) {
        return !0;
      }
    }
    return !1;
  },
  text: l("ui.common.or")
};
c.and = {
  token: "&",
  isRespectedFn: function (e, t) {
    for (var i = 0, n = e.length; i < n; i += 1) {
      if (!e[i].isRespected(t)) {
        return !1;
      }
    }
    return !0;
  },
  text: l("ui.common.and")
};
c.or || n();
this.criterions = [];
o.prototype.initialize = function (e) {
  r.each(this.criterions, s, e);
};
o.prototype.isRespected = function (e) {
  return !this.criterions.length || (1 === this.criterions.length ? this.criterions[0].isRespected(e) : this.operator.isRespectedFn(this.criterions, e));
};
o.prototype.getOperatorText = function () {
  return this.operator ? this.operator.text : "";
};
o.prototype.getText = function () {
  for (var e = [], t = 0, i = this.criterions.length; t < i; t += 1) {
    var n = this.criterions[t];
    n.criterions ? e.push("(" + n.getText() + ")") : e.push(n.getText());
  }
  return e.join(" " + this.operator.text + " ");
};
e.exports = o;
e.exports.operators = c;
o.call(this, e);
window.gui.playerData.identification.hasRights ? this._text = a("ui.social.guildHouseRights") + " " + this.getOperatorText() + " " + this.getValueText() : this._text = "";
s(n, o);
n.prototype.getText = function () {
  return this._text;
};
e.exports = n;
this.operator = {
  token: a,
  text: a,
  compareFn: function () {
    return !0;
  }
};
this.rawValue = e.substring(3);
this.value = parseInt(this.rawValue, 10);
i.prototype.initialize = function (e) {
  e();
};
i.prototype.getOperatorText = function () {
  return this.operator ? this.operator.text : "";
};
i.prototype.getKeyText = function () {
  return this.key;
};
i.prototype.getValueText = function () {
  return this.value;
};
i.prototype.isRespected = function (e) {
  if (!this.operator) {
    return !0;
  }
  var t = this.operator.compareFn;
  return !!t && t(this.getCriterion(e), this.value);
};
i.prototype.getText = function () {
  return this.getKeyText() + " " + this.getOperatorText() + " " + this.getValueText();
};
i.prototype.getCriterion = function () {
  return 0;
};
e.exports = i;
e.exports.operators = n;
r(n, o);
n.prototype.initialize = function (e) {
  var t = this;
  s.getData("Achievements", this.value, function (i, n) {
    return i ? e(i) : (t._valueText = " '" + n.nameId + "'", t._keyText = a("ui.tooltip.unlockAchievement", [t._valueText]), void e());
  });
};
n.prototype.isRespected = function () {
  var e = window.gui.playerData.achievements.finishedAchievementsIds;
  return e.indexOf(this.value) !== -1;
};
n.prototype.getKeyText = function () {
  return this._keyText;
};
n.prototype.getOperatorText = function () {
  return this.operator === o.operators.different ? a("ui.tooltip.dontUnlockAchievement", [this._valueText]) : o.prototype.getOperatorText.call(this);
};
n.prototype.getValueText = function () {
  return this._valueText;
};
e.exports = n;
s(n, o);
n.prototype.getKeyText = function () {
  return a("ui.common.alignment");
};
n.prototype.getOperatorText = function () {
  return this.operator === o.operators.different ? " " + a("ui.common.differentFrom") + a("ui.common.colon") : o.prototype.getOperatorText.call(this);
};
n.prototype.getValueText = function () {
  return window.gui.databases.AlignmentSides[this.value].nameId;
};
n.prototype.getCriterion = function () {
  return window.gui.playerData.characters.mainCharacter.characteristics.alignmentInfos.alignmentSide;
};
e.exports = n;
o.call(this, e);
this._text = a("ui.tooltip.AlignmentLevel") + " " + this.getOperatorText() + " " + this.value;
s(n, o);
n.prototype.getText = function () {
  return this._text;
};
n.prototype.getCriterion = function () {
  var e = window.gui.playerData;
  return e.characters.mainCharacter.characteristics.alignmentInfos.alignmentValue;
};
e.exports = n;
s.call(this, e);
this.operator === s.operators.equal ? this._text = r("ui.criterion.allianceAvA") : this._text = "";
c(n, s);
n.prototype.getText = function () {
  return this._text;
};
n.prototype.isRespected = function () {
  if (this.operator !== s.operators.equal) {
    return !1;
  }
  var e = window.gui.playerData,
    t = e.characters.mainCharacter.characteristics.alignmentInfos.aggressable;
  if (t !== o.AvA_ENABLED_AGGRESSABLE && t !== o.AvA_PREQUALIFIED_AGGRESSABLE) {
    return !1;
  }
  var i = a.entities.prism[e.position.subAreaId];
  return !(!i || i.mapId === -1) && i.state === l.PRISM_STATE_VULNERABLE;
};
e.exports = n;
h._reset = function () {
  o = h.fights = {};
  o[g.taxCollector] = {};
  o[g.prism] = {};
  a = h.entities = {};
  a[g.taxCollector] = {};
  a[g.prism] = {};
};
h.isPlayerDefending = function (e, t) {
  if (!g[e]) {
    return console.log("unknown entity type", e);
  }
  var i = h.fights[e];
  for (var n in i) {
    var o = i[n];
    if (o.state === m.waitingForHelp && h.isPlayerFightingFor(t, e, n, f.allies)) {
      return parseInt(n, 10);
    }
  }
  return null;
};
h.getAttackedEntity = function (e) {
  return e.type && e.hasOwnProperty("id") && g[e.type] ? h.entities[e.type][e.id] : console.log("wrong fight object");
};
h.isPlayerFightingFor = function (e, t, i, n) {
  if (!g[t]) {
    return console.log("unknown entity type", t);
  }
  var a = o[t][i];
  if (!a) {
    return !1;
  }
  for (var s = a.fighters[n], r = 0, l = s.length; r < l; r += 1) {
    if (s[r].id === e) {
      return !0;
    }
  }
  return !1;
};
o = h.fights = {};
o[g.taxCollector] = {};
o[g.prism] = {};
a = h.entities = {};
a[g.taxCollector] = {};
a[g.prism] = {};
h.playerAutoKick = function (e, t) {
  if (!g[e]) {
    return console.log("unknown entity type", e);
  }
  var i = window.gui.playerData.id;
  e === g.taxCollector ? window.dofus.sendMessage("GuildFightLeaveRequestMessage", {
    taxCollectorId: t,
    characterId: i
  }) : window.dofus.sendMessage("PrismFightJoinLeaveRequestMessage", {
    subAreaId: t,
    join: !1
  });
  _ = {
    type: e,
    fightId: t,
    playerId: i
  };
};
h.initialize = function (e) {
  function t(e, t) {
    o[e][t] && (delete o[e][t], h.emit("fightEnded", e, t));
  }
  function i(e, t, i, n) {
    var a = o[e][t];
    if (a) {
      var s = a.fighters[i];
      s.push(n);
      h.emit("fighterJoined", e, t, i, n, s.length - 1);
    }
  }
  function s(e, t, i, a) {
    var s = o[e][t];
    s || (s = n(e, t));
    s.fighters[i] = a;
    h.emit("fighterList", e, t, i, a);
  }
  function d(e, t, i, n) {
    var a = o[e][t];
    if (a) {
      for (var s = a.fighters[i], r = 0, l = s.length; r < l; r += 1) {
        var c = s[r].id;
        if (c === n) {
          return s.splice(r, 1), void h.emit("fighterLeft", e, t, i, n, r);
        }
      }
      return console.error("unknown fighter id", n);
    }
  }
  h._reset();
  e.on("disconnect", function () {
    h._reset();
  });
  l.setupEvents();
  e.on("TaxCollectorListMessage", function (e) {
    var t,
      i = e.informations,
      o = a.taxCollector;
    for (t = 0; t < i.length; t += 1) {
      var s = new c(i[t]);
      o[s.id] = s;
    }
    h.emit("taxCollectorList", g.taxCollector, i, e.nbcollectorMax);
    var r = e.fightersInformations;
    for (t = 0; t < r.length; t += 1) {
      var l = r[t];
      n(g.taxCollector, l.collectorId, l);
    }
  });
  e.on("TaxCollectorMovementAddMessage", function (e) {
    var i = new c(e.informations),
      s = a.taxCollector,
      r = !s.hasOwnProperty(i.id);
    if (s[i.id] = i, r) {
      return void h.emit("entityAdded", g.taxCollector, i);
    }
    if (h.emit("entityUpdated", g.taxCollector, i), i.fightState === m.noFight) {
      t(g.taxCollector, i.id);
    } else {
      var l = o[g.taxCollector][i.id];
      if (!l) {
        return n(g.taxCollector, i.id);
      }
      l.state = i.fightState;
      l.waitingForHelpInfo = i.waitingForHelpInfo;
      l.state === m.fighting && h.emit("fighting", g.taxCollector, l);
    }
  });
  e.on("TaxCollectorMovementRemoveMessage", function (e) {
    var t = e.collectorId,
      i = a.taxCollector;
    i[t] && (delete i[t], h.emit("entityRemoved", g.taxCollector, t));
  });
  e.on("PrismsListMessage", function (e) {
    for (var t = a.prism, i = e.prisms, n = 0, o = i.length; n < o; n += 1) {
      var s = new u(i[n]);
      t[s.id] = s;
    }
    h.emit("prismList", g.prism, i);
  });
  e.on("PrismsListUpdateMessage", function (e) {
    for (var t = a.prism, i = e.prisms, n = 0, o = i.length; n < o; n += 1) {
      var s = i[n],
        r = t[s.subAreaId];
      r ? (r.updateInfo(s), h.emit("entityUpdated", g.prism, r)) : (r = new u(s), t[r.id] = r, h.emit("entityAdded", g.prism, r));
    }
  });
  e.on("PrismsInfoValidMessage", function (e) {
    for (var t = e.fights, i = a.prism, o = 0, s = t.length; o < s; o += 1) {
      var r = t[o],
        l = i[r.subAreaId];
      if (l) {
        var c = r.allyCharactersInformations[0];
        c && "3451" === c.name && (l.look = c.entityLook, l.level = c.level, r.allyCharactersInformations.splice(0, 1));
        l.fightState = m.waitingForHelp;
        n(g.prism, r.subAreaId, r);
      } else {
        console.warn("unknown prism", r.subAreaId);
      }
    }
  });
  e.on("PrismFightAddedMessage", function (e) {
    var t = e.fight,
      i = a.prism[t.subAreaId];
    return i ? void n(g.prism, t.subAreaId, t) : console.warn("unknown prism", t.subAreaId);
  });
  e.on("PrismFightRemovedMessage", function (e) {
    t(g.prism, e.subAreaId);
  });
  e.on("GuildFightPlayersHelpersJoinMessage", function (e) {
    i(g.taxCollector, e.fightId, f.allies, e.playerInfo);
  });
  e.on("PrismFightDefenderAddMessage", function (e) {
    var t = e.defender;
    if ("3451" === t.name) {
      var n = a.prism[e.subAreaId];
      n.look = t.entityLook;
      n.level = t.level;
      h.emit("fightTarget", g.prism, e.subAreaId, n);
    } else {
      i(g.prism, e.subAreaId, f.allies, t);
    }
  });
  e.on("PrismFightAttackerAddMessage", function (e) {
    i(g.prism, e.subAreaId, f.enemies, e.attacker);
  });
  e.on("GuildFightPlayersEnemiesListMessage", function (e) {
    s(g.taxCollector, e.fightId, f.enemies, e.playerInfo);
  });
  e.on("GuildFightPlayersEnemyRemoveMessage", function (e) {
    d(g.taxCollector, e.fightId, f.enemies, e.playerId);
  });
  e.on("GuildFightPlayersHelpersLeaveMessage", function (e) {
    _ && _.type === g.taxCollector && _.fightId === e.fightId && _.playerId === e.playerId && (window.gui.chat.logMsg(r("ui.social.guild.autoFightLeave")), _ = null);
    d(g.taxCollector, e.fightId, f.allies, e.playerId);
  });
  e.on("PrismFightDefenderLeaveMessage", function (e) {
    _ && _.type === g.prism && _.fightId === e.subAreaId && _.playerId === e.fighterToRemoveId && (window.gui.chat.logMsg(r("ui.prism.AutoDisjoin")), _ = null);
    d(g.prism, e.subAreaId, f.allies, e.fighterToRemoveId);
  });
  e.on("PrismFightAttackerRemoveMessage", function (e) {
    d(g.prism, e.subAreaId, f.enemies, e.fighterToRemoveId);
  });
};
e === g.taxCollector ? window.dofus.sendMessage("GuildFightLeaveRequestMessage", {
  taxCollectorId: t,
  characterId: i
}) : window.dofus.sendMessage("PrismFightJoinLeaveRequestMessage", {
  subAreaId: t,
  join: !1
});
_ = {
  type: e,
  fightId: t,
  playerId: i
};
s.push(n);
h.emit("fighterJoined", e, t, i, n, s.length - 1);
s || (s = n(e, t));
s.fighters[i] = a;
h.emit("fighterList", e, t, i, a);
h._reset();
e.on("disconnect", function () {
  h._reset();
});
l.setupEvents();
e.on("TaxCollectorListMessage", function (e) {
  var t,
    i = e.informations,
    o = a.taxCollector;
  for (t = 0; t < i.length; t += 1) {
    var s = new c(i[t]);
    o[s.id] = s;
  }
  h.emit("taxCollectorList", g.taxCollector, i, e.nbcollectorMax);
  var r = e.fightersInformations;
  for (t = 0; t < r.length; t += 1) {
    var l = r[t];
    n(g.taxCollector, l.collectorId, l);
  }
});
e.on("TaxCollectorMovementAddMessage", function (e) {
  var i = new c(e.informations),
    s = a.taxCollector,
    r = !s.hasOwnProperty(i.id);
  if (s[i.id] = i, r) {
    return void h.emit("entityAdded", g.taxCollector, i);
  }
  if (h.emit("entityUpdated", g.taxCollector, i), i.fightState === m.noFight) {
    t(g.taxCollector, i.id);
  } else {
    var l = o[g.taxCollector][i.id];
    if (!l) {
      return n(g.taxCollector, i.id);
    }
    l.state = i.fightState;
    l.waitingForHelpInfo = i.waitingForHelpInfo;
    l.state === m.fighting && h.emit("fighting", g.taxCollector, l);
  }
});
e.on("TaxCollectorMovementRemoveMessage", function (e) {
  var t = e.collectorId,
    i = a.taxCollector;
  i[t] && (delete i[t], h.emit("entityRemoved", g.taxCollector, t));
});
e.on("PrismsListMessage", function (e) {
  for (var t = a.prism, i = e.prisms, n = 0, o = i.length; n < o; n += 1) {
    var s = new u(i[n]);
    t[s.id] = s;
  }
  h.emit("prismList", g.prism, i);
});
e.on("PrismsListUpdateMessage", function (e) {
  for (var t = a.prism, i = e.prisms, n = 0, o = i.length; n < o; n += 1) {
    var s = i[n],
      r = t[s.subAreaId];
    r ? (r.updateInfo(s), h.emit("entityUpdated", g.prism, r)) : (r = new u(s), t[r.id] = r, h.emit("entityAdded", g.prism, r));
  }
});
e.on("PrismsInfoValidMessage", function (e) {
  for (var t = e.fights, i = a.prism, o = 0, s = t.length; o < s; o += 1) {
    var r = t[o],
      l = i[r.subAreaId];
    if (l) {
      var c = r.allyCharactersInformations[0];
      c && "3451" === c.name && (l.look = c.entityLook, l.level = c.level, r.allyCharactersInformations.splice(0, 1));
      l.fightState = m.waitingForHelp;
      n(g.prism, r.subAreaId, r);
    } else {
      console.warn("unknown prism", r.subAreaId);
    }
  }
});
e.on("PrismFightAddedMessage", function (e) {
  var t = e.fight,
    i = a.prism[t.subAreaId];
  return i ? void n(g.prism, t.subAreaId, t) : console.warn("unknown prism", t.subAreaId);
});
e.on("PrismFightRemovedMessage", function (e) {
  t(g.prism, e.subAreaId);
});
e.on("GuildFightPlayersHelpersJoinMessage", function (e) {
  i(g.taxCollector, e.fightId, f.allies, e.playerInfo);
});
e.on("PrismFightDefenderAddMessage", function (e) {
  var t = e.defender;
  if ("3451" === t.name) {
    var n = a.prism[e.subAreaId];
    n.look = t.entityLook;
    n.level = t.level;
    h.emit("fightTarget", g.prism, e.subAreaId, n);
  } else {
    i(g.prism, e.subAreaId, f.allies, t);
  }
});
e.on("PrismFightAttackerAddMessage", function (e) {
  i(g.prism, e.subAreaId, f.enemies, e.attacker);
});
e.on("GuildFightPlayersEnemiesListMessage", function (e) {
  s(g.taxCollector, e.fightId, f.enemies, e.playerInfo);
});
e.on("GuildFightPlayersEnemyRemoveMessage", function (e) {
  d(g.taxCollector, e.fightId, f.enemies, e.playerId);
});
e.on("GuildFightPlayersHelpersLeaveMessage", function (e) {
  _ && _.type === g.taxCollector && _.fightId === e.fightId && _.playerId === e.playerId && (window.gui.chat.logMsg(r("ui.social.guild.autoFightLeave")), _ = null);
  d(g.taxCollector, e.fightId, f.allies, e.playerId);
});
e.on("PrismFightDefenderLeaveMessage", function (e) {
  _ && _.type === g.prism && _.fightId === e.subAreaId && _.playerId === e.fighterToRemoveId && (window.gui.chat.logMsg(r("ui.prism.AutoDisjoin")), _ = null);
  d(g.prism, e.subAreaId, f.allies, e.fighterToRemoveId);
});
e.on("PrismFightAttackerRemoveMessage", function (e) {
  d(g.prism, e.subAreaId, f.enemies, e.fighterToRemoveId);
});
l.state = i.fightState;
l.waitingForHelpInfo = i.waitingForHelpInfo;
l.state === m.fighting && h.emit("fighting", g.taxCollector, l);
c && "3451" === c.name && (l.look = c.entityLook, l.level = c.level, r.allyCharactersInformations.splice(0, 1));
l.fightState = m.waitingForHelp;
n(g.prism, r.subAreaId, r);
n.look = t.entityLook;
n.level = t.level;
h.emit("fightTarget", g.prism, e.subAreaId, n);
_ && _.type === g.taxCollector && _.fightId === e.fightId && _.playerId === e.playerId && (window.gui.chat.logMsg(r("ui.social.guild.autoFightLeave")), _ = null);
d(g.taxCollector, e.fightId, f.allies, e.playerId);
_ && _.type === g.prism && _.fightId === e.subAreaId && _.playerId === e.fighterToRemoveId && (window.gui.chat.logMsg(r("ui.prism.AutoDisjoin")), _ = null);
d(g.prism, e.subAreaId, f.allies, e.fighterToRemoveId);
this.id = e.uniqueId;
this.level = 0;
this.updateInfo(e);
t.TaxCollector = o;
o.prototype.updateInfo = function (e) {
  for (var t in e) {
    this[t] = e[t];
  }
  this.fightState = n(e.state);
  var i = c.getObjectInArrayById(e.complements, "_type", "TaxCollectorWaitingForHelpInformations");
  i && (this.waitingForHelpInfo = i.waitingForHelpInfo);
  var o = c.getObjectInArrayById(e.complements, "_type", "TaxCollectorGuildInformations");
  o && (this.guildId = o.guild.guildId, this.level = s.guilds[this.guildId].guildLevel);
};
o.prototype.getGuild = function () {
  return s.guilds[this.guildId];
};
o.prototype.getName = function () {
  return this.enrichData.firstName + " " + this.enrichData.lastName;
};
o.prototype.getPosition = function () {
  return this.worldX + "," + this.worldY;
};
t.setupEvents = function () {
  var e = window.gui;
  e.on("TaxCollectorMovementMessage", function (e) {
    var t = e.basicInfos,
      i = t.enrichData || {},
      n = i.firstName + " " + i.lastName,
      o = t.worldX + "," + t.worldY,
      a = "";
    a = e.hireOrFire ? l("ui.social.TaxCollectorAdded", n, o, e.playerName) : l("ui.social.TaxCollectorRemoved", n, o, e.playerName);
    window.gui.chat.logMsg(a, h.CHANNEL_GUILD);
  });
  e.on("TaxCollectorAttackedMessage", function (e) {
    var t = e.enrichData,
      i = t.firstName + " " + t.lastName,
      n = e.worldX + "," + e.worldY;
    window.gui.chat.logMsg(l("ui.social.TaxCollectorAttacked", i, n), h.CHANNEL_GUILD);
  });
  e.on("TaxCollectorErrorMessage", function (e) {
    var t;
    switch (e.reason) {
      case u.TAX_COLLECTOR_ALREADY_ONE:
        t = l("ui.social.alreadyTaxCollectorOnMap");
        break;
      case u.TAX_COLLECTOR_CANT_HIRE_HERE:
        t = l("ui.social.cantHireTaxCollecotrHere");
        break;
      case u.TAX_COLLECTOR_CANT_HIRE_YET:
        t = l("ui.social.cantHireTaxcollectorTooTired");
        break;
      case u.TAX_COLLECTOR_ERROR_UNKNOWN:
        t = l("ui.social.unknownErrorTaxCollector");
        break;
      case u.TAX_COLLECTOR_MAX_REACHED:
        t = l("ui.social.cantHireMaxTaxCollector");
        break;
      case u.TAX_COLLECTOR_NO_RIGHTS:
        t = l("ui.social.taxCollectorNoRights");
        break;
      case u.TAX_COLLECTOR_NOT_ENOUGH_KAMAS:
        t = l("ui.social.notEnougthRichToHireTaxCollector");
        break;
      case u.TAX_COLLECTOR_NOT_OWNED:
        t = l("ui.social.notYourTaxcollector");
    }
    if (t) {
      var i = window.gui.chat;
      i.logError(t);
    }
  });
  e.on("TaxCollectorAttackedResultMessage", function (e) {
    var t,
      i = e.basicInfos,
      n = i.enrichData || {},
      o = n.firstName + " " + n.lastName,
      a = i.worldX + "," + i.worldY;
    t = e.deadOrAlive ? l("ui.social.TaxCollectorDied", o, a) : l("ui.social.TaxCollectorSurvived", o, a);
    window.gui.chat.logMsg(t, h.CHANNEL_GUILD);
  });
  e.on("ExchangeGuildTaxCollectorGetMessage", function (e) {
    for (var t = e.objectsInfos || [], i = "", n = 0; n < t.length; n += 1) {
      i && (i += ", ");
      var o = t[n],
        a = o.enrichData || {};
      i += o.quantity + "x" + a.itemName;
    }
    var s = "";
    s = i ? l("ui.social.thingsTaxCollectorGet", i, e.experience) : l("ui.social.xpTaxCollectorGet", e.experience);
    var r = e.enrichData || {},
      c = l("ui.social.taxcollectorRecolted", r.firstName + " " + r.lastName, "(" + e.worldX + ", " + e.worldY + ")", e.userName, s);
    window.gui.chat.logMsg(c, h.CHANNEL_GUILD);
  });
};
e.on("TaxCollectorMovementMessage", function (e) {
  var t = e.basicInfos,
    i = t.enrichData || {},
    n = i.firstName + " " + i.lastName,
    o = t.worldX + "," + t.worldY,
    a = "";
  a = e.hireOrFire ? l("ui.social.TaxCollectorAdded", n, o, e.playerName) : l("ui.social.TaxCollectorRemoved", n, o, e.playerName);
  window.gui.chat.logMsg(a, h.CHANNEL_GUILD);
});
e.on("TaxCollectorAttackedMessage", function (e) {
  var t = e.enrichData,
    i = t.firstName + " " + t.lastName,
    n = e.worldX + "," + e.worldY;
  window.gui.chat.logMsg(l("ui.social.TaxCollectorAttacked", i, n), h.CHANNEL_GUILD);
});
e.on("TaxCollectorErrorMessage", function (e) {
  var t;
  switch (e.reason) {
    case u.TAX_COLLECTOR_ALREADY_ONE:
      t = l("ui.social.alreadyTaxCollectorOnMap");
      break;
    case u.TAX_COLLECTOR_CANT_HIRE_HERE:
      t = l("ui.social.cantHireTaxCollecotrHere");
      break;
    case u.TAX_COLLECTOR_CANT_HIRE_YET:
      t = l("ui.social.cantHireTaxcollectorTooTired");
      break;
    case u.TAX_COLLECTOR_ERROR_UNKNOWN:
      t = l("ui.social.unknownErrorTaxCollector");
      break;
    case u.TAX_COLLECTOR_MAX_REACHED:
      t = l("ui.social.cantHireMaxTaxCollector");
      break;
    case u.TAX_COLLECTOR_NO_RIGHTS:
      t = l("ui.social.taxCollectorNoRights");
      break;
    case u.TAX_COLLECTOR_NOT_ENOUGH_KAMAS:
      t = l("ui.social.notEnougthRichToHireTaxCollector");
      break;
    case u.TAX_COLLECTOR_NOT_OWNED:
      t = l("ui.social.notYourTaxcollector");
  }
  if (t) {
    var i = window.gui.chat;
    i.logError(t);
  }
});
e.on("TaxCollectorAttackedResultMessage", function (e) {
  var t,
    i = e.basicInfos,
    n = i.enrichData || {},
    o = n.firstName + " " + n.lastName,
    a = i.worldX + "," + i.worldY;
  t = e.deadOrAlive ? l("ui.social.TaxCollectorDied", o, a) : l("ui.social.TaxCollectorSurvived", o, a);
  window.gui.chat.logMsg(t, h.CHANNEL_GUILD);
});
e.on("ExchangeGuildTaxCollectorGetMessage", function (e) {
  for (var t = e.objectsInfos || [], i = "", n = 0; n < t.length; n += 1) {
    i && (i += ", ");
    var o = t[n],
      a = o.enrichData || {};
    i += o.quantity + "x" + a.itemName;
  }
  var s = "";
  s = i ? l("ui.social.thingsTaxCollectorGet", i, e.experience) : l("ui.social.xpTaxCollectorGet", e.experience);
  var r = e.enrichData || {},
    c = l("ui.social.taxcollectorRecolted", r.firstName + " " + r.lastName, "(" + e.worldX + ", " + e.worldY + ")", e.userName, s);
  window.gui.chat.logMsg(c, h.CHANNEL_GUILD);
});
a = e.hireOrFire ? l("ui.social.TaxCollectorAdded", n, o, e.playerName) : l("ui.social.TaxCollectorRemoved", n, o, e.playerName);
window.gui.chat.logMsg(a, h.CHANNEL_GUILD);
t = e.deadOrAlive ? l("ui.social.TaxCollectorDied", o, a) : l("ui.social.TaxCollectorSurvived", o, a);
window.gui.chat.logMsg(t, h.CHANNEL_GUILD);
t.fightState = {
  noFight: 0,
  waitingForHelp: 1,
  fighting: 2
};
t.fightingSide = {
  allies: "allies",
  enemies: "enemies"
};
t.entityType = {
  taxCollector: "taxCollector",
  prism: "prism"
};
t.Emblem = i(541);
t.GuildRightsBitEnum = i(543);
t.createGuild = function (e) {
  var t = new o(e);
  return r[t.guildId] = t, t;
};
t.initialize = function (e) {
  function t(e) {
    s.getWindow("guildCard").display(e);
  }
  e.on("GuildCreationResultMessage", function (e) {
    switch (e.result) {
      case a.SOCIAL_GROUP_CREATE_ERROR_ALREADY_IN_GROUP:
        return window.gui.openSimplePopup(n("ui.guild.alreadyInGuild"));
      case a.SOCIAL_GROUP_CREATE_ERROR_EMBLEM_ALREADY_EXISTS:
        return window.gui.openSimplePopup(n("ui.guild.AlreadyUseEmblem"));
      case a.SOCIAL_GROUP_CREATE_ERROR_NAME_ALREADY_EXISTS:
        return window.gui.openSimplePopup(n("ui.guild.AlreadyUseName"));
      case a.SOCIAL_GROUP_CREATE_ERROR_NAME_INVALID:
        return window.gui.openSimplePopup(n("ui.guild.invalidName"));
      case a.SOCIAL_GROUP_CREATE_ERROR_REQUIREMENT_UNMET:
        return window.gui.openSimplePopup(n("ui.guild.requirementUnmet"));
      case a.SOCIAL_GROUP_CREATE_OK:
        return s.close("socialGroupCreation");
      case a.SOCIAL_GROUP_CREATE_ERROR_EMBLEM_INVALID:
      case a.SOCIAL_GROUP_CREATE_ERROR_UNKNOWN:
        return window.gui.openSimplePopup(n("ui.common.unknownFail"));
    }
  });
  e.on("GuildInAllianceFactsMessage", t);
  e.on("GuildFactsMessage", t);
  window.dofus.connectionManager.on("GuildFactsErrorMessage", function () {
    e.chat.logMsg(n("ui.guild.doesntExistAnymore"));
  });
};
t.openGuildCard = function (e) {
  window.dofus.sendMessage("GuildFactsRequestMessage", {
    guildId: e
  });
};
e.on("GuildCreationResultMessage", function (e) {
  switch (e.result) {
    case a.SOCIAL_GROUP_CREATE_ERROR_ALREADY_IN_GROUP:
      return window.gui.openSimplePopup(n("ui.guild.alreadyInGuild"));
    case a.SOCIAL_GROUP_CREATE_ERROR_EMBLEM_ALREADY_EXISTS:
      return window.gui.openSimplePopup(n("ui.guild.AlreadyUseEmblem"));
    case a.SOCIAL_GROUP_CREATE_ERROR_NAME_ALREADY_EXISTS:
      return window.gui.openSimplePopup(n("ui.guild.AlreadyUseName"));
    case a.SOCIAL_GROUP_CREATE_ERROR_NAME_INVALID:
      return window.gui.openSimplePopup(n("ui.guild.invalidName"));
    case a.SOCIAL_GROUP_CREATE_ERROR_REQUIREMENT_UNMET:
      return window.gui.openSimplePopup(n("ui.guild.requirementUnmet"));
    case a.SOCIAL_GROUP_CREATE_OK:
      return s.close("socialGroupCreation");
    case a.SOCIAL_GROUP_CREATE_ERROR_EMBLEM_INVALID:
    case a.SOCIAL_GROUP_CREATE_ERROR_UNKNOWN:
      return window.gui.openSimplePopup(n("ui.common.unknownFail"));
  }
});
e.on("GuildInAllianceFactsMessage", t);
e.on("GuildFactsMessage", t);
window.dofus.connectionManager.on("GuildFactsErrorMessage", function () {
  e.chat.logMsg(n("ui.guild.doesntExistAnymore"));
});
this.guildId = 0;
this.guildName = "";
this.guildEmblem = new a();
this.guildLevel = 0;
this.creationDate = 0;
this.leaderId = 0;
this.leaderName = "";
this.nbMembers = 0;
this.nbConnectedMembers = 0;
this.nbTaxCollectors = 0;
this.averageMemberLevel = 0;
this.lastActivity = 0;
this.enabled = !1;
this.allianceId = 0;
this.allianceName = "";
this.allianceLeader = !1;
this.experiencePercentage = 0;
this.members = [];
this.update(e);
n.prototype.update = function (e) {
  for (var t in e) {
    o(this, t, e);
  }
  "#NONAME#" === this.guildName && (this.guildName = s("ui.guild.noName"));
  "#NONAME#" === this.allianceName && (this.allianceName = s("ui.guild.noName"));
};
n.prototype.getHoursSinceLastConnection = function () {
  if (!this.lastActivity) {
    return 0;
  }
  var e = new Date();
  return Math.floor((e.time - 1e3 * this.lastActivity) / 36e5);
};
n.prototype.getMembersByRank = function () {
  var e = window.gui.databases.RankNames,
    t = this.members,
    i = [];
  for (var n in t) {
    var o = t[n];
    o.rankOrder = e[o.rank].order;
    i.push(o);
  }
  return r.sortObjectInArray(i, "rankOrder"), i;
};
e.exports = n;
"#NONAME#" === this.guildName && (this.guildName = s("ui.guild.noName"));
"#NONAME#" === this.allianceName && (this.allianceName = s("ui.guild.noName"));
o.rankOrder = e[o.rank].order;
i.push(o);
e = e || {};
this.symbolShape = e.symbolShape || 0;
this.symbolColor = e.symbolColor || 0;
this.backgroundShape = e.backgroundShape || 0;
this.backgroundColor = e.backgroundColor || 0;
this.id = e.subAreaId;
this.fightState = e.prism ? n(e.prism.state) : s.noFight;
t.Prism = o;
o.prototype.updateInfo = function (e) {
  for (var t in e) {
    this[t] = e[t];
  }
  if (!e.prism) {
    return void delete this.prism;
  }
  var i = n(e.prism.state);
  if (i === s.waitingForHelp && this.fightState !== s.waitingForHelp) {
    var o = e.enrichData.subAreaName + " (" + e.enrichData.areaName + ")";
    window.gui.chat.logMsg(r("ui.prism.attacked", o, this.getPosition()), c.CHANNEL_ALLIANCE);
  }
  var a = this.getAlliance();
  a.allianceEmblem.isAlliance = !0;
  this.fightState = i;
};
o.prototype.getPlacementDate = function () {
  return new d.DofusDate(1e3 * this.prism.placementDate).getServerDate().toString().date;
};
o.prototype.getName = function () {
  var e = window.gui.playerData.alliance.current;
  return r("ui.zaap.prism") + " " + e.allianceName;
};
o.prototype.getPosition = function () {
  return this.worldX + "," + this.worldY;
};
o.prototype.getAlliance = function () {
  if (this.prism) {
    return "AllianceInsiderPrismInformation" === this.prism._type ? window.gui.playerData.alliance.current : this.prism.alliance;
  }
};
a.allianceEmblem.isAlliance = !0;
this.fightState = i;
o.call(this, e);
0 === this.value ? this._text = a("ui.criterion.noAlliance") : 1 === this.value ? this._text = a("ui.criterion.hasAlliance") : this._text = a("ui.criterion.hasValidAlliance");
s(n, o);
n.prototype.getText = function () {
  return this._text;
};
n.prototype.getCriterion = function () {
  var e = window.gui.playerData.alliance;
  return e.hasAlliance() ? e.current.enabled ? 2 : 1 : 0;
};
e.exports = n;
r.ALLIANCE_RIGHT_MANAGE_PRISMS = 2;
r.ALLIANCE_RIGHT_TALK_IN_CHAN = 4;
r.ALLIANCE_RIGHT_RECRUIT_GUILDS = 8;
r.ALLIANCE_RIGHT_KICK_GUILDS = 16;
r.ALLIANCE_RIGHT_MANAGE_RIGHTS = 32;
l(o, a);
o.prototype.getText = function () {
  return this._text;
};
o.prototype.isRespected = function () {
  var e = window.gui.playerData.alliance;
  if (!e.hasAlliance()) {
    return this.operator === a.operators.equal;
  }
  var t = this.value !== r.ALLIANCE_RIGHT_BOSS || e.isBoss();
  return this.operator === a.operators.equal ? t : this.operator === a.operators.equal && !t;
};
e.exports = o;
s(n, o);
n.prototype.getText = function () {
  var e = window.gui.databases.Areas[this.value],
    t = e ? e.nameId : "";
  return this.operator === o.operators.equal ? a("ui.tooltip.beInArea", [t]) : a("ui.tooltip.dontBeInArea", [t]);
};
n.prototype.getCriterion = function () {
  return window.gui.playerData.position.area.id;
};
e.exports = n;
o.call(this, e);
0 === this.value && "B" === this.key ? this._text = a("ui.criterion.initialBones") : this._text = a("ui.criterion.bones") + " " + this.getOperatorText() + " " + this.value;
s(n, o);
n.prototype.getText = function () {
  return this._text;
};
n.prototype.getCriterion = function () {
  return window.gui.playerData.characterBaseInformations.entityLook.bonesId;
};
e.exports = n;
s(n, o);
n.prototype.getText = function () {
  return this._text;
};
n.prototype.getCriterion = function () {
  return window.gui.playerData.characterBaseInformations.breed;
};
e.exports = n;
o.call(this, e);
this._communityId = window.gui.playerData.identification.communityId;
s(n, o);
n.prototype.initialize = function (e) {
  var t = this,
    i = window.gui.serversData;
  i.syncServerStaticData(function (n) {
    return n ? (console.error("ServerDetails setServer error", n), e(n)) : (t._communityName = i.staticContent.communities[t._communityId], void e());
  });
};
n.prototype.getText = function () {
  return this.operator === o.operators.equal ? a("ui.criterion.community", [this._communityName]) : a("ui.criterion.notCommunity", [this._communityName]);
};
n.prototype.getCriterion = function () {
  return this._communityId;
};
e.exports = n;
s(n, o);
n.prototype.getKeyText = function () {
  return a("ui.time.days", 1);
};
n.prototype.getCriterion = function () {
  var e = new Date();
  return e.getDate();
};
e.exports = n;
r(n, o);
n.prototype.initialize = function (e) {
  var t = this.value,
    i = l[t];
  if (i) {
    return this._emoticonData = i, e();
  }
  if (i = window.gui.playerData.emoteData.list[t]) {
    return this._emoticonData = i, e();
  }
  var n = this;
  s.getData("Emoticons", this.value, function (t, i) {
    return t ? e(t) : (l[i.id] = i, n._emoticonData = i, void e());
  });
};
n.prototype.isRespected = function () {
  return window.gui.playerData.emoteData.list.hasOwnProperty(this.value);
};
n.prototype.getText = function () {
  var e = a(this.operator === o.operators.different ? "ui.tooltip.dontPossessEmote" : "ui.tooltip.possessEmote");
  return e + " '" + this._emoticonData.nameId + "'";
};
e.exports = n;
s.inherits(n, o);
n.prototype.getKeyText = function () {
  return a("ui.tooltip.playerInFriendlist");
};
n.prototype.getCriterion = function () {
  return Object.keys(window.gui.playerData.socialData.friendsList).length;
};
e.exports = n;
s.inherits(n, o);
n.prototype.getText = function () {
  var e = window.gui.databases.AlignmentGift,
    t = e[this._giftId] ? e[this._giftId].nameId : "";
  return this.operator === o.operators.superior ? a("ui.pvp.giftRequired", [t + " > " + this._giftLevel]) : a("ui.pvp.giftRequired", [t]);
};
n.prototype.isRespected = function () {
  var e = window.gui.playerData.alignmentRank,
    t = window.gui.databases.AlignmentRankJntGift[e];
  if (!t || !t.gifts) {
    return !1;
  }
  for (var i = 0, n = t.gifts.length; i < n; i += 1) {
    if (t.gifts[i] === this._giftId) {
      return !this._giftLevel || t.levels[i] > this._giftLevel;
    }
  }
  return !1;
};
e.exports = n;
s(n, o);
n.prototype.getText = function () {
  return a(0 === this.value ? "ui.criterion.noguild" : 1 === this.value ? "ui.criterion.hasGuild" : "ui.criterion.hasValidGuild");
};
n.prototype.getCriterion = function () {
  var e = window.gui.playerData.guild;
  return e.hasGuild() ? e.current.enabled ? 2 : 1 : 0;
};
e.exports = n;
s(n, o);
n.prototype.getKeyText = function () {
  return a("ui.guild.guildLevel");
};
n.prototype.getCriterion = function () {
  var e = window.gui.playerData.guild;
  return e.hasGuild() ? e.current.guildLevel : 0;
};
e.exports = n;
r(n, o);
n.prototype.getText = function () {
  var e;
  switch (this.value) {
    case s.GUILD_RIGHT_BOSS:
      e = a("ui.guild.right.leader");
      break;
    case s.GUILD_RIGHT_BAN_MEMBERS:
      e = a("ui.social.guildRightsBann");
      break;
    case s.GUILD_RIGHT_COLLECT:
      e = a("ui.social.guildRightsCollect");
      break;
    case s.GUILD_RIGHT_COLLECT_MY_TAX_COLLECTOR:
      e = a("ui.social.guildRightsCollectMy");
      break;
    case s.GUILD_RIGHT_DEFENSE_PRIORITY:
      e = a("ui.social.guildRightsPrioritizeMe");
      break;
    case s.GUILD_RIGHT_HIRE_TAX_COLLECTOR:
      e = a("ui.social.guildRightsHiretax");
      break;
    case s.GUILD_RIGHT_INVITE_NEW_MEMBERS:
      e = a("ui.social.guildRightsInvit");
      break;
    case s.GUILD_RIGHT_MANAGE_GUILD_BOOSTS:
      e = a("ui.social.guildRightsBoost");
      break;
    case s.GUILD_RIGHT_MANAGE_MY_XP_CONTRIBUTION:
      e = a("ui.social.guildRightManageOwnXP");
      break;
    case s.GUILD_RIGHT_MANAGE_RANKS:
      e = a("ui.social.guildRightsRank");
      break;
    case s.GUILD_RIGHT_MANAGE_RIGHTS:
      e = a("ui.social.guildManageRights");
      break;
    case s.GUILD_RIGHT_MANAGE_XP_CONTRIBUTION:
      e = a("ui.social.guildRightsPercentXP");
      break;
    case s.GUILD_RIGHT_ORGANIZE_PADDOCKS:
      e = a("ui.social.guildRightsMountParkArrange");
      break;
    case s.GUILD_RIGHT_SET_ALLIANCE_PRISM:
      e = a("ui.social.guildRightsSetAlliancePrism");
      break;
    case s.GUILD_RIGHT_TALK_IN_ALLIANCE_CHAN:
      e = a("ui.social.guildRightsTalkInAllianceChannel");
      break;
    case s.GUILD_RIGHT_TAKE_OTHERS_MOUNTS_IN_PADDOCKS:
      e = a("ui.social.guildRightsManageOtherMount");
      break;
    case s.GUILD_RIGHT_USE_PADDOCKS:
      e = a("ui.social.guildRightsMountParkUse");
      break;
    default:
      e = "";
  }
  return this.operator === o.operators.equal ? a("ui.criterion.guildRights", [e]) : a("ui.criterion.notGuildRights", [e]);
};
n.prototype.isRespected = function () {
  var e = window.gui.playerData.guild;
  if (!e.hasGuild()) {
    return this.operator === o.operators.different;
  }
  var t = e.hasRight(this.value);
  return this.operator === o.operators.equal ? t : !t;
};
e.exports = n;
r.inherits(n, o);
n.prototype.initialize = function (e) {
  var t = this;
  s.getData("Jobs", this._jobId, function (i, n) {
    return i ? e(i) : (t._jobName = n && n.nameId, void e());
  });
};
n.prototype.getText = function () {
  if (!this._jobName) {
    return "";
  }
  var e = this._jobName,
    t = "";
  switch (this._jobLevel >= 0 && (t = " " + a("ui.common.short.level") + " " + this._jobLevel), this.operator) {
    case o.operators.equal:
      return e + t;
    case o.operators.different:
      return a("ui.common.dontBe") + e + t;
    case o.operators.superior:
      return e + " >" + t;
    case o.operators.inferior:
      return e + " <" + t;
    default:
      return "";
  }
};
n.prototype.isRespected = function () {
  var e = window.gui.playerData.jobs.list;
  if (this._jobLevel === -1) {
    return e.hasOwnProperty(this._jobId);
  }
  var t = e[this._jobId];
  if (!t || !t.experience) {
    return !1;
  }
  var i = this.operator.compareFn;
  return !!i && i(t.experience.jobLevel, this._jobLevel);
};
e.exports = n;
s.inherits(n, o);
n.prototype.getKeyText = function () {
  return a("ui.common.kamas");
};
n.prototype.getCriterion = function () {
  return window.gui.playerData.inventory.kamas;
};
e.exports = n;
s.inherits(n, o);
n.prototype.getKeyText = function () {
  return a("ui.common.level");
};
n.prototype.getCriterion = function () {
  return window.gui.playerData.characterBaseInformations.level;
};
e.exports = n;
s(n, o);
n.prototype.getKeyText = function () {
  return a("ui.criterion.MK", [this._mapId]);
};
n.prototype.getCriterion = function () {
  return window.gui.playerData.characterBaseInformations.level;
};
e.exports = n;
s(n, o);
n.prototype.getText = function () {
  return a(this.operator === o.operators.equal && 1 === this.value || this.operator === o.operators.different && 2 === this.value ? "ui.tooltip.beMaried" : "ui.tooltip.beSingle");
};
n.prototype.getCriterion = function () {
  return null !== window.gui.playerData.socialData.spouse ? 1 : 2;
};
e.exports = n;
s.inherits(n, o);
n.prototype.getCriterion = function () {
  return window.gui.playerData.partyData.arenaStats.bestDailyRank;
};
n.prototype.getText = function () {
  var e;
  return e = this.operator === o.operators.different ? a("ui.common.differentFrom") + " >" : ">", a("ui.common.pvpMaxRank") + " " + e + " " + this.value;
};
e.exports = n;
s.inherits(n, o);
n.prototype.getKeyText = function () {
  return a("ui.time.months");
};
n.prototype.getCriterion = function () {
  var e = new Date();
  return e.getMonth();
};
e.exports = n;
s.inherits(n, o);
n.prototype.getText = function () {
  var e;
  switch (this.operator.token) {
    case "!":
    case "=":
      e = this.operator.token + " " + this.rawValue;
      break;
    case "~":
      e = "= " + this.rawValue;
      break;
    case "S":
    case "s":
      e = a("ui.criterion.startWith", [this.rawValue]);
      break;
    case "E":
    case "e":
      e = a("ui.criterion.endWith", [this.rawValue]);
      break;
    case "v":
      e = a("ui.criterion.valid");
      break;
    case "i":
      e = a("ui.criterion.invalid");
      break;
    default:
      e = "";
  }
  return a("ui.common.name") + " " + e;
};
n.prototype.isRespected = function () {
  var e = window.gui.playerData.characterBaseInformations.name;
  switch (this.operator.token) {
    case "=":
      return e === this.rawValue;
    case "!":
      return e !== this.rawValue;
    case "~":
      return e.toLowerCase() === this.rawValue.toLowerCase();
    case "S":
      return 0 === e.toLowerCase().indexOf(this.rawValue.toLowerCase());
    case "s":
      return 0 === e.indexOf(this.rawValue);
    case "E":
      return e.toLowerCase().indexOf(this.rawValue.toLowerCase()) === e.length - this.rawValue.length;
    case "e":
      return e.indexOf(this.rawValue) === e.length - this.rawValue.length;
    default:
    case "v":
    case "i":
      return !1;
  }
};
e.exports = n;
o.call(this, e);
this._objectName = t.nameId;
s(n, o);
n.prototype.initialize = function (e) {
  var t = this.value;
  if (!t && 0 !== t) {
    return e();
  }
  var i = this;
  r.getDataMap("Items", [t], function (n, o) {
    if (n) {
      return e(n);
    }
    var a = o[t];
    return a ? (i._objectName = a.nameId, void e()) : e("ObjectItemCriterion: unable to find item id " + t);
  });
};
n.prototype.isRespected = function () {
  var e = window.gui.playerData.inventory.objects,
    t = this.operator === o.operators.equal;
  for (var i in e) {
    var n = e[i];
    if (n.objectGID === this.value) {
      return t;
    }
  }
  return !t;
};
n.prototype.getText = function () {
  return this.operator === o.operators.different ? a("ui.common.doNotPossess", [this._objectName]) : a("ui.common.doPossess", [this._objectName]);
};
e.exports = n;
d = {
  CM: p("ui.stats.shortMP"),
  CP: p("ui.stats.shortAP"),
  CH: p("ui.pvp.honourPoints"),
  CD: p("ui.pvp.disgracePoints"),
  CT: p("ui.stats.takleBlock"),
  Ct: p("ui.stats.takleEvade")
};
u = p("ui.item.characteristics").split(",");
h.call(this, e);
d || n();
this._keyText = a(this.key);
m(s, h);
s.prototype.getKeyText = function () {
  return this._keyText;
};
s.prototype.getCriterion = function () {
  var e = window.gui.playerData.characters.mainCharacter.characteristics;
  return g[this.key] ? parseInt(g[this.key](e), 10) : (console.error("unknown criterion key: " + this.key), 0);
};
e.exports = s;
s(n, o);
n.prototype.getKeyText = function () {
  return a("ui.pvp.rank");
};
e.exports = n;
o.call(this, e);
this._quest = null;
s.inherits(n, o);
n.prototype.initialize = function (e) {
  var t = this;
  r.getDataMap("Quests", [this.value], function (i, n) {
    return i ? e("QuestItemCriterion#initialize", i) : (n[t.value] ? t._quest = n[t.value] : l.error("QuestItemCriterion#initialize: cannot get questId", t.value), void e());
  });
};
n.prototype.getText = function () {
  if (!this._quest) {
    return "";
  }
  switch (this.key) {
    case "Qa":
      return a("ui.grimoire.quest.active", [this._quest.nameId]);
    case "Qc":
      return a("ui.grimoire.quest.startable", [this._quest.nameId]);
    case "Qf":
      return a("ui.grimoire.quest.done", [this._quest.nameId]);
    default:
      return "";
  }
};
n.prototype.isRespected = function () {
  var e = window.gui.playerData.quests,
    t = !1;
  switch (this.key) {
    case "Qa":
      t = e.active.hasOwnProperty(this.value);
      break;
    case "Qc":
      t = e.startable.hasOwnProperty(this.value) && !e.active.hasOwnProperty(this.value) && !e.finished.hasOwnProperty(this.value);
      break;
    case "Qf":
      t = e.finished.hasOwnProperty(this.value);
  }
  return "=" === this.operator.token ? t : !t;
};
e.exports = n;
o.call(this, e);
this._stepId = null;
"<" === this.operator.token && (this.operator = {
  token: "<",
  compareFn: function (e, t) {
    return e <= t;
  },
  text: " < "
});
a(n, o);
n.prototype.initialize = function (e) {
  var t = this;
  s.getDataMap("QuestObjectives", [this.value], function (i, n) {
    return i ? e("QuestObjectiveCriterion#initialize", i) : (t._stepId = n[t.value] && n[t.value].stepId, void e());
  });
};
n.prototype.getCriterion = function () {
  var e = window.gui.playerData.quests,
    t = -1;
  if (!this._stepId) {
    return t;
  }
  for (var i in e.all) {
    var n = e.all[i];
    if (n.dbObjectives && n.dbObjectives[this.value]) {
      if (n.finishedCount >= 1) {
        t = this.value + 1;
        break;
      }
      for (var o = 0; o < n.objectives.length; o++) {
        var a = n.objectives[o];
        if (a.objectiveId === this.value) {
          t = a.objectiveStatus ? this.value : this.value + 1;
          break;
        }
      }
      break;
    }
    if (n.dbQuest && n.dbQuest.stepIds && n.dbQuest.stepIds.indexOf(this._stepId) !== -1) {
      t = this.value + 1;
      break;
    }
  }
  return t;
};
e.exports = n;
o.call(this, e);
"<" === this.operator.token && (this.operator = {
  token: "<",
  compareFn: function (e, t) {
    return e <= t;
  },
  text: " < "
});
a(n, o);
e.exports = n;
n.prototype.getCriterion = function () {
  var e = window.gui.playerData.quests,
    t = -1;
  for (var i in e.all) {
    var n = e.all[i],
      o = n.dbQuest.stepIds.indexOf(this.value);
    if (o !== -1) {
      if (n.finishedCount >= 1) {
        t = this.value + 1;
      } else {
        var a = n.dbQuest.stepIds.indexOf(n.stepId);
        t = this.value + (a - o);
      }
      break;
    }
  }
  return t;
};
s(n, o);
n.prototype.getKeyText = function () {
  return a("ui.common.pvpRank");
};
n.prototype.getOperatorText = function () {
  return this.operator === o.operators.different ? a("ui.common.differentFrom") + " >" : ">";
};
n.prototype.getCriterion = function () {
  return window.gui.playerData.partyData.arenaStats.rank;
};
e.exports = n;
s(n, o);
n.prototype.getKeyText = function () {
  return a("ui.common.level");
};
n.prototype.getCriterion = function () {
  return window.gui.playerData.characterBaseInformations.level;
};
e.exports = n;
s(n, o);
n.prototype.getText = function () {
  return this.operator === o.operators.equal && 1 === this.value || this.operator === o.operators.different && 0 === this.value ? a("ui.tooltip.mountEquiped") : this.operator === o.operators.equal && 1 === this.value || this.operator === o.operators.different && 0 === this.value ? a("ui.tooltip.mountNonEquiped") : "";
};
n.prototype.getCriterion = function () {
  return window.gui.playerData.isRiding ? 1 : 0;
};
e.exports = n;
o.call(this, e);
this._keyText = a("ui.header.server");
s(n, o);
n.prototype.initialize = function (e) {
  var t = this;
  this._serverName = "";
  r.getData("Servers", this.value, function (i, n) {
    return i ? e(i) : (t._serverName = n.nameId, void e());
  });
};
n.prototype.getKeyText = function () {
  return this._keyText;
};
n.prototype.getValueText = function () {
  return this._serverName;
};
n.prototype.getCriterion = function () {
  return window.gui.serversData.connectedServerId;
};
e.exports = n;
this._serverName = "";
r.getData("Servers", this.value, function (i, n) {
  return i ? e(i) : (t._serverName = n.nameId, void e());
});
s(n, o);
n.prototype.getText = function () {
  return a(1 === this.value ? "ui.tooltip.beFemale" : "ui.tooltip.beMale");
};
n.prototype.getCriterion = function () {
  return window.gui.playerData.characterBaseInformations.sex ? 1 : 0;
};
e.exports = n;
s(n, o);
n.prototype.initialize = function (e) {
  var t,
    i = this.key.split(",");
  i.length > 1 ? (t = parseInt(i[0], 10), this._quantityMonster = parseInt(i[1], 10)) : (t = parseInt(this.value, 10), this._quantityMonster = 1);
  this._monsterName = "";
  var n = this;
  r.getData("Monsters", t, function (t, i) {
    return t ? e(t) : (n._monsterName = i.nameId, void e());
  });
};
n.prototype.isRespected = function () {
  for (var e = window.gui.playerData.inventory, t = 0; t < l.length; t += 1) {
    if (e.quantityList[[l]]) {
      return !0;
    }
  }
  return !1;
};
n.prototype.getText = function () {
  return a("ui.tooltip.possessSoulStone", [this._quantityMonster, this._monsterName]);
};
e.exports = n;
i.length > 1 ? (t = parseInt(i[0], 10), this._quantityMonster = parseInt(i[1], 10)) : (t = parseInt(this.value, 10), this._quantityMonster = 1);
this._monsterName = "";
a(n, o);
n.prototype.getCriterion = function () {
  return window.gui.playerData.characters.mainCharacter.characteristics.alignmentInfos.alignmentGrade;
};
e.exports = n;
s(n, o);
n.prototype.getText = function () {
  var e = window.gui.playerData.characters.mainCharacter.spellData.spells[this._spellId];
  if (!e) {
    return "";
  }
  switch (this.operator) {
    case o.operators.equal:
      return a("ui.criterion.gotSpell", [e.nameId]);
    case o.operators.different:
      return a("ui.criterion.doesntGotSpell", [e.nameId]);
    default:
      return "";
  }
};
n.prototype.isRespected = function () {
  var e = window.gui.playerData.characters.mainCharacter.spellData,
    t = e.spells.hasOwnProperty(this._spellId) && e._spellsStatus[this._spellId] === r.USABLE;
  return t && this.operator === o.operators.equal || !t && this.operator === o.operators.different;
};
e.exports = n;
a(n, o);
n.prototype.isRespected = function () {
  return !0;
};
n.prototype.getText = function () {
  return "";
};
e.exports = n;
s(n, o);
n.prototype.initialize = function (e) {
  var t = this;
  this._name = "";
  r.getObject("SubAreas", this.value, function (i, n) {
    return i ? e(i) : (t._name = n.nameId, void e());
  });
};
n.prototype.getText = function () {
  if (!this._name) {
    return "";
  }
  switch (this.operator) {
    case o.operators.equal:
      return a("ui.tooltip.beInSubarea", [this._name]);
    case o.operators.different:
      return a("ui.tooltip.dontBeInSubarea", [this._name]);
    default:
      return "";
  }
};
n.prototype.getCriterion = function (e) {
  return e = e || {}, e.subAreaId || window.gui.playerData.position.subAreaId;
};
e.exports = n;
this._name = "";
r.getObject("SubAreas", this.value, function (i, n) {
  return i ? e(i) : (t._name = n.nameId, void e());
});
s(n, o);
n.prototype.getText = function () {
  return a(this.operator === o.operators.equal && 1 === this.value || this.operator === o.operators.different && 0 === this.value ? "ui.tooltip.beSubscirber" : "ui.tooltip.dontBeSubscriber");
};
n.prototype.getCriterion = function () {
  var e = window.gui.playerData;
  return e.isSubscriberAtMinLevel(r.NORMAL) || e.identification.hasRights ? 1 : 0;
};
e.exports = n;
o.call(this, e);
this._text = a("ui.criterion.unusableItem");
s(n, o);
n.prototype.isRespected = function () {
  return !0;
};
n.prototype.getText = function () {
  return this._text;
};
e.exports = n;
s(n, o);
n.prototype.getKeyText = function () {
  return a("ui.common.weight");
};
n.prototype.getCriterion = function () {
  return window.gui.playerData.inventory.weight;
};
e.exports = n;
s(n, o);
n.prototype.getText = function () {
  switch (this.key) {
    case "Oo":
      var e = window.gui.databases.ItemTypes[this.value].nameId;
      return a("ui.criterion.cosmeticItemSlotType", e);
    case "Pn":
      switch (this.value) {
        case 1:
          return a("ui.criterion.cosmeticItemSlot", a("ui.common.inventoryType2"));
        case 6:
          return a("ui.criterion.cosmeticItemSlot", a("ui.common.inventoryType10"));
        case 7:
          return a("ui.criterion.cosmeticItemSlot", a("ui.common.inventoryType11"));
        case 8:
          return a("ui.criterion.cosmeticItemSlot", a("ui.common.inventoryType8"));
        case 15:
          return a("ui.criterion.cosmeticItemSlot", a("ui.common.inventoryType7"));
        case 16:
          return a("ui.criterion.cosmeticItemSlot", a("ui.banner.mount"));
        default:
          return "";
      }
    default:
      return "";
  }
};
n.prototype.getCriterion = function () {
  var e = window.gui.playerData.inventory.equippedItems;
  switch (this.key) {
    case "Oo":
      for (var t = window.gui.databases.ItemTypes[this.value].possiblePositions, i = 0; i < t.length; i++) {
        if (e[t[i]]) {
          if (e[t[i]].item) {
            return e[t[i]].item.typeId;
          }
          console.error("Equipped items not initialized yet to set criterion `" + this.key + "`");
        }
      }
      return null;
    case "Pn":
      switch (this.value) {
        case 16:
          return window.gui.playerData.isRiding ? this.value : null;
        default:
          return window.gui.playerData.inventory.equippedItems[this.value] ? this.value : null;
      }
    default:
      return "";
  }
};
e.exports = n;
o.call(this, e);
this._spellId = null;
s(n, o);
n.prototype.initialize = function (e) {
  var t = this;
  r.getDataMap("SpellLevels", [this.value], function (i, n) {
    return i ? e("SpellLevelItemCriterion#initialize", i) : (n[t.value] ? t._spellId = n[t.value].spellId : l.error("SpellLevelItemCriterion#initialize: cannot get SpellLevelId", t.value), void e());
  });
};
n.prototype.getText = function () {
  if (!this._spellId) {
    return "";
  }
  switch (this.operator) {
    case o.operators.equal:
      return a("ui.criterion.gotSpellLevel", this._spellId);
    case o.operators.different:
      return a("ui.criterion.doesntGotSpellLevel", this._spellId);
    default:
      return "";
  }
};
n.prototype.isRespected = function () {
  var e = window.gui.playerData.characters.mainCharacter.spellData,
    t = e.spells.hasOwnProperty(this._spellId) && e._spellsStatus[this._spellId] === c.USABLE;
  if (!t) {
    return !1;
  }
  var i = e.spells[this._spellId].spellLevel.id === this.value;
  return i && this.operator === o.operators.equal || !i && this.operator === o.operators.different;
};
e.exports = n;
d.call(this);
this.isItemInstance = !0;
this.exchangeAllowed = !0;
this.isInitialised = !1;
this.effectsMap = {};
this.shortName = "";
a = "X";
s = 1;
a = "T";
s = 1;
a = "L";
s = 1;
i.livingObjectId = c.value;
c.isLivingProperty = !0;
i.livingObjectMood = c.value;
c.isLivingProperty = !0;
i.livingObjectSkin = c.value;
c.isLivingProperty = !0;
i.livingObjectCategory = c.value;
c.isLivingProperty = !0;
i.livingObjectLevel = d;
i.livingObjectXp = u;
i.livingObjectMaxXp = h;
c.isLivingProperty = !0;
c.diceNum = y;
c.forceDescriptionRefresh();
983 === c.effectId && (i.exchangeAllowed = !1);
c.effectId !== I && c.effectId !== A || (i.exchangeable = !1);
n.push(r);
o[a] = r;
r.iconId = l[r.livingObjectMood][r.livingObjectSkin - 1];
i.push(r);
l.shortName = l.item.getRawName();
l._initializationDone();
a[r] = c;
s = !0;
p = o[m];
n[m] = o[m];
u.shortName = l;
u._initializationDone();
h(n, d);
e.exports = n;
n.prototype.setItem = function (e) {
  this.exchangeable = e.exchangeable;
  this.weight = e.realWeight;
  this.item = e;
  this.id = e.id;
};
n.prototype.isLinked = function () {
  return !this.exchangeable || !this.exchangeAllowed;
};
n.prototype.isLinkedCharacter = function () {
  return !!this.effectsMap[I];
};
n.prototype.isMimicryHost = function () {
  return !!this.effectsMap[g.ACTION_ITEM_MIMICRY_OBJ_GID];
};
n.prototype.isStarvingPet = function () {
  return 18 === this.item.typeId;
};
n.prototype.isCosmetic = function () {
  return !!this.item && this.item.isCosmetic();
};
n.prototype.isShield = function () {
  return !!this.item && this.item.isShield();
};
n.prototype.isShieldManageable = function () {
  return !!this.item && (this.isShield() && this.item.shieldModelId > 0 && window.gui.playerData.inventory.objects[this.objectUID] && this.effectsMap[g.ACTION_SHIELD_EXPERIENCE] || this.item.id === _.fakeShieldId && window.gui.playerData.isOnShieldTutorial());
};
n.prototype.isLegendaryWeapon = function () {
  return !!this.item && this.item.isLegendaryWeapon();
};
n.prototype.isAsleepLegendaryWeapon = function () {
  return !!this.item && this.item.isLegendaryWeapon() && this.item.recipeIds.length > 0;
};
n.prototype.getGrindLevel = function () {
  for (var e = 1, t = 0; t < this.effects.length; t++) {
    var i = this.effects[t];
    if (i.effectId === g.ACTION_GRIND_LEVEL) {
      e = i.value;
      break;
    }
  }
  return e;
};
n.prototype.isFullSoulStone = function () {
  return !!this.item && this.item.isFullSoulStone();
};
n.prototype._loadDifferentImage = function (e) {
  var t = this;
  m.preloadImage("gfx/items/" + this.iconId + ".png", function (i) {
    t.image = i;
    e();
  });
};
n.prototype._initializationDone = function () {
  this.isInitialised = !0;
  this.emit("initialised");
};
n.prototype.initialize = function (e) {
  console.error("ItemInstance.initialized called");
  n.initializeList([this], null, e);
};
n.initializeList = function (e, t, i) {
  for (var n = [], o = 0; o < e.length; o += 1) {
    var l,
      c = e[o],
      d = {};
    if (c.item) {
      for (l = 0; l < c.item.upgradeEffects.length; l += 1) {
        for (var h = c.item.upgradeEffects[l], p = 0; p < c.item.possibleEffects.length; p += 1) {
          var m = c.item.possibleEffects[p];
          if (m.effectId === h.typeActionId) {
            d[h.typeActionId] = m.diceNum;
            break;
          }
        }
      }
    }
    for (l = 0; l < c.effects.length; l += 1) {
      var f = c.effects[l];
      void 0 !== d[f.actionId] && (f.baseValue = d[f.actionId]);
      f.effectCaller = "ItemInstance id " + c.id;
      n.push(f);
    }
  }
  u.createEffectInstances(n, function (n, o) {
    if (n) {
      return i(n);
    }
    for (var l = 0; l < e.length; l++) {
      var c = e[l],
        d = c.effects.length;
      c.effects = d > 0 ? o.splice(0, d) : [];
    }
    a(e);
    s(e, function (n) {
      return n ? i(n) : void r(e, t, i);
    });
  });
};
n.prototype.getRawName = function () {
  if (!this.isInitialised) {
    return "";
  }
  var e;
  return e = this.objectGID === M ? l("ui.item.soul", this.shortName) : this.objectGID === C ? l("ui.item.miniboss", this.shortName) : this.objectGID === T ? l("ui.item.boss", this.shortName) : this.shortName;
};
n.prototype.doDefaultAction = function () {
  if (this.isInitialised) {
    var e = this.getProperty("objectUID");
    if (this.getProperty("usable")) {
      if (!this.getProperty("type").needUseConfirm) {
        return void y.useObject(e);
      }
      window.gui.openConfirmPopup({
        title: f("ui.common.confirm"),
        message: f("ui.common.confirmationUseItem", this.getProperty("nameId")),
        cb: function (t) {
          t && y.useObject(e);
        }
      });
    } else {
      this.item.isEquippable() && window.gui.playerData.inventory.equipItem(e);
    }
  }
};
n.prototype.getName = function () {
  if (!this.isInitialised) {
    return "";
  }
  var e = v(),
    t = this.getRawName();
  return e.gui.playerData.isAbleToSeeId() && (t += " (" + this.objectGID + ")"), t;
};
n.prototype.getItem = function () {
  return this.item;
};
n.prototype.getItemInstance = function () {
  return this;
};
n.prototype.getProperty = function (e) {
  if (!this.isInitialised) {
    return null;
  }
  switch (e) {
    case "nameId":
      return this.getName();
    default:
      return this.hasOwnProperty(e) ? this[e] : this.item.getProperty(e);
  }
};
this.exchangeable = e.exchangeable;
this.weight = e.realWeight;
this.item = e;
this.id = e.id;
t.image = i;
e();
this.isInitialised = !0;
this.emit("initialised");
console.error("ItemInstance.initialized called");
n.initializeList([this], null, e);
void 0 !== d[f.actionId] && (f.baseValue = d[f.actionId]);
f.effectCaller = "ItemInstance id " + c.id;
n.push(f);
a(e);
s(e, function (n) {
  return n ? i(n) : void r(e, t, i);
});
t.questFilterId = 3;
t.fakeShieldId = 17128;
t.fakeRune = {
  _type: "ObjectItem",
  position: 63,
  objectGID: 17130,
  effects: [{
    _type: "ObjectEffectDice",
    actionId: 2826,
    diceNum: 0,
    diceSide: 0,
    diceConst: 2500
  }],
  objectUID: 1,
  quantity: 1
};
m.call(this, "div", {
  className: "ShopViewer"
});
i = i || {};
this.itemTypes = {};
this._totalPrice = 0;
this._createDom(e, t, i);
l(o, m);
e.exports = o;
o.prototype._createDom = function (e, t, i) {
  var o = this;
  i.manualFiltering || (this.itemFilter = this.appendChild(new c({
    noSorting: !0
  })));
  this.table = this.appendChild(new p(e, t, i.tableOption));
  this.table.on("rowSlidedLeft", function (e, t) {
    h("RIGHT_TO_LEFT_SWITCH");
    o.emit("rowSlidedLeft", e, t);
  });
  this.table.on("rowSlidedRight", function (e, t) {
    h("LEFT_TO_RIGHT_SWITCH");
    o.emit("rowSlidedRight", e, t);
  });
  this.table.on("rowAdded", function (e, t, i) {
    i.tooltipContent = null;
    s(i, n);
  });
  this.table.on("rowTap", function (e, t) {
    h("GEN_BUTTON");
    o.emit("itemSelected", t);
  });
  this.itemFilter && this._setupFiltering();
};
o.prototype.setHeader = function (e) {
  this.table.setColumnHeader("name", e);
};
o.prototype._setupFiltering = function () {
  var e,
    t,
    i,
    n,
    o,
    a = u.getItemTypeMap(),
    s = this;
  this.itemFilter.on("filter", function (a, l, d) {
    e = a;
    t = a !== c.filters.all;
    i = l;
    n = l !== c.subFilters.all;
    o = d ? r.simplifyString(d) : null;
    s.table.filter();
  });
  this.table.addFilter(function (s) {
    var l = s.getItem(),
      c = a[l.typeId].category;
    if (t && c !== e) {
      return !1;
    }
    if (n && l.typeId !== i) {
      return !1;
    }
    if (o && s.isFullSoulStone()) {
      for (var d = 0; d < s.effects.length; d++) {
        if (s.effects[d] && r.simplifyString(s.effects[d].description).indexOf(o) !== -1) {
          return !0;
        }
      }
    }
    return !o || l.getNameForSearch().indexOf(o) !== -1;
  });
};
o.prototype.filter = function (e) {
  this.table.filter(e);
};
o.prototype._unregisterItemType = function (e) {
  var t = this.table.getRow(e);
  if (t) {
    var i = t.rowContent,
      n = i.getItem().typeId;
    this.itemTypes[n] && (this.itemTypes[n]--, 0 === this.itemTypes[n] && delete this.itemTypes[n]);
  }
};
o.prototype._registerItemType = function (e) {
  var t = e.getItem().typeId;
  return this.itemTypes[t] ? (this.itemTypes[t]++, !1) : (this.itemTypes[t] = 1, !0);
};
o.prototype._collectItemTypesAndIncrementTotalPrice = function (e, t) {
  if (this.itemFilter) {
    for (var i = !1, n = 0; n < e.length; n++) {
      t && this._incrementTotalPrice(e[n].objectPrice);
      var o = this.table.getIdFn(e[n]);
      this.table.hasRow(o) || (i |= this._registerItemType(e[n]));
    }
    t && this.emit("totalPriceUpdated", this._totalPrice);
    i && this.itemFilter.updateSubFilters(Object.keys(this.itemTypes));
  }
};
o.prototype.removeItems = function (e, t) {
  for (var i = 0; i < e.length; i++) {
    t && this._decrementTotalPrice(this.getItem(e[i]).objectPrice);
    this._unregisterItemType(e[i]);
  }
  this.table.delRows(e, !0);
  t && this.emit("totalPriceUpdated", this._totalPrice);
};
o.prototype.getItemCount = function () {
  return this.table.getRowCount();
};
o.prototype.selectItem = function (e) {
  this.table.selectRow(e);
};
o.prototype.getItem = function (e) {
  var t = this.table.getRow(e);
  return t ? t.rowContent : null;
};
o.prototype.findItemByGID = function (e) {
  return this.table.findRow(a, e);
};
o.prototype.selectFilter = function (e) {
  this.itemFilter.selectSubfilter(e);
};
o.prototype.clearContent = function () {
  this.itemTypes = {};
  this._totalPrice = 0;
  this.table.clearContent();
};
o.prototype._incrementTotalPrice = function (e) {
  this._totalPrice += e;
};
o.prototype._decrementTotalPrice = function (e) {
  this._totalPrice -= e;
};
o.prototype.setItemList = function (e, t) {
  this.clearContent();
  this.itemFilter && (this._collectItemTypesAndIncrementTotalPrice(e, t), e.length || this.itemFilter.updateSubFilters([]), this.itemFilter.reset());
  this.table.addList(e, !0);
};
o.prototype.addItems = function (e, t) {
  this._collectItemTypesAndIncrementTotalPrice(e, t);
  this.table.addList(e, !0, !0);
};
o.prototype.addItemsAndHighlightThem = function (e, t) {
  this._collectItemTypesAndIncrementTotalPrice(e, t);
  this.selectFilter(e[0].getProperty("typeId"));
  this.table.addList(e, !0, !0);
  this.selectItem(e[0].objectUID);
};
o.prototype.setPlaceholder = function (e) {
  this.table.setPlaceholderText(e);
};
o.prototype.refresh = function () {
  this.table.placeholder && this.table.placeholder.refresh();
  this.table.scroller.refresh();
};
i.manualFiltering || (this.itemFilter = this.appendChild(new c({
  noSorting: !0
})));
this.table = this.appendChild(new p(e, t, i.tableOption));
this.table.on("rowSlidedLeft", function (e, t) {
  h("RIGHT_TO_LEFT_SWITCH");
  o.emit("rowSlidedLeft", e, t);
});
this.table.on("rowSlidedRight", function (e, t) {
  h("LEFT_TO_RIGHT_SWITCH");
  o.emit("rowSlidedRight", e, t);
});
this.table.on("rowAdded", function (e, t, i) {
  i.tooltipContent = null;
  s(i, n);
});
this.table.on("rowTap", function (e, t) {
  h("GEN_BUTTON");
  o.emit("itemSelected", t);
});
this.itemFilter && this._setupFiltering();
h("RIGHT_TO_LEFT_SWITCH");
o.emit("rowSlidedLeft", e, t);
h("LEFT_TO_RIGHT_SWITCH");
o.emit("rowSlidedRight", e, t);
i.tooltipContent = null;
s(i, n);
h("GEN_BUTTON");
o.emit("itemSelected", t);
this.itemFilter.on("filter", function (a, l, d) {
  e = a;
  t = a !== c.filters.all;
  i = l;
  n = l !== c.subFilters.all;
  o = d ? r.simplifyString(d) : null;
  s.table.filter();
});
this.table.addFilter(function (s) {
  var l = s.getItem(),
    c = a[l.typeId].category;
  if (t && c !== e) {
    return !1;
  }
  if (n && l.typeId !== i) {
    return !1;
  }
  if (o && s.isFullSoulStone()) {
    for (var d = 0; d < s.effects.length; d++) {
      if (s.effects[d] && r.simplifyString(s.effects[d].description).indexOf(o) !== -1) {
        return !0;
      }
    }
  }
  return !o || l.getNameForSearch().indexOf(o) !== -1;
});
e = a;
t = a !== c.filters.all;
i = l;
n = l !== c.subFilters.all;
o = d ? r.simplifyString(d) : null;
s.table.filter();
t && this.emit("totalPriceUpdated", this._totalPrice);
i && this.itemFilter.updateSubFilters(Object.keys(this.itemTypes));
t && this._decrementTotalPrice(this.getItem(e[i]).objectPrice);
this._unregisterItemType(e[i]);
this.table.delRows(e, !0);
t && this.emit("totalPriceUpdated", this._totalPrice);
this.itemTypes = {};
this._totalPrice = 0;
this.table.clearContent();
this.clearContent();
this.itemFilter && (this._collectItemTypesAndIncrementTotalPrice(e, t), e.length || this.itemFilter.updateSubFilters([]), this.itemFilter.reset());
this.table.addList(e, !0);
this._collectItemTypesAndIncrementTotalPrice(e, t);
this.table.addList(e, !0, !0);
this._collectItemTypesAndIncrementTotalPrice(e, t);
this.selectFilter(e[0].getProperty("typeId"));
this.table.addList(e, !0, !0);
this.selectItem(e[0].objectUID);
this.table.placeholder && this.table.placeholder.refresh();
this.table.scroller.refresh();
h.call(this, "div", {
  className: "ItemFilters"
});
e = e || {};
this._withAllCategoriesBtn = !e.noAllCategory;
this._withSorting = !e.noSorting;
this._withTagBar = !!e.withTagBar;
this._selectedFilter = null;
this._selectedSubFilter = null;
this._sortOrderMap = {};
this._currentSorting = g;
this._currentText = "";
this._filterButtonList = {};
this._selectList = {};
this._subFiltersSelect = [];
this._createDom();
this._switchFilterInput("category");
this._refreshSortOrder();
c(n, h);
e.exports = n;
n.filters = w;
n.subFilters = I;
n.prototype._createDom = function () {
  M || (M = [l("ui.common.all"), l("ui.common.equipement"), l("ui.common.usableItems"), l("ui.common.ressources"), l("ui.common.quest.objects"), l("ui.common.presets")]);
  var e = this.createChild("div", {
    className: "filters"
  });
  this._filterBtnMap = {};
  this._subFiltersBox = this.createChild("div", {
    className: "subFiltersBox"
  });
  this._switchFilteringBtn = this._subFiltersBox.appendChild(new u({
    className: "switchBtn",
    addIcon: !0,
    tooltip: l("ui.common.sortOrSearch")
  }, this._switchFilterInput.bind(this, "NEXT")));
  this._categoryBox = this._subFiltersBox.createChild("div", {
    className: "categories"
  });
  for (var t = e.createChild("div", {
      className: "content"
    }), i = this._itemTypeChangeHandler.bind(this), n = 0, a = A.length; n < a; n++) {
    var r = A[n],
      c = ["filter", d.getCategoryName(r) || "all"],
      h = t.appendChild(new u({
        className: c
      }, o));
    this._filterButtonList[r] = h;
    this._filterBtnMap[r] = h;
    s(h, M[n]);
    h.filter = r;
    h.myItemFilters = this;
    h.createChild("div", {
      className: "icon"
    });
    var f = this._categoryBox.appendChild(new m({
      className: "subFilterSelect"
    }));
    this._subFiltersSelect.push(f);
    f.on("change", i);
    f.hide();
    this._selectList[r] = {
      wdSelect: f
    };
  }
  if (this._searchBox = this._subFiltersBox.appendChild(new p({
    isLiveSearch: !0
  })), this._searchBox.on("search", this._textChangedHandler.bind(this)), this._searchBox.setPlaceholder(l("tablet.common.filter")), this._sortBox = this._subFiltersBox.createChild("div", {
    className: "sortBox"
  }), this._sortSelector = this._sortBox.appendChild(this._createSortSelector()), this._sortSelector.on("change", this._sortChangeHandler.bind(this)), this._sortOrderBtn = new u({
    className: "sortOrderBtn",
    addIcon: !0
  }, this._switchSortOrder.bind(this)), this._sortBox.appendChild(this._sortOrderBtn), this._withTagBar) {
    var g = this.createChild("div", {
      className: "tagZone"
    });
    this._tagBar = g.createChild("div", {
      className: "tagBar"
    });
    this._tagButtons = [];
  }
};
n.prototype._itemTypeChangeHandler = function (e) {
  this._updateFilterDisplay(this._selectedFilter, parseInt(e, 10));
};
n.prototype._sortChangeHandler = function (e) {
  this._currentSorting = e;
  this._refreshSortOrder();
  this._requestSort();
};
n.prototype._switchSortOrder = function () {
  var e = this._sortOrderMap[this._currentSorting],
    t = "ASC" === e ? "DESC" : "ASC";
  this._sortOrderMap[this._currentSorting] = t;
  this._refreshSortOrder();
  this._requestSort();
};
n.prototype._resetSortOrder = function () {
  this._currentSorting = g;
  this._sortOrderMap[g] = _;
  this._sortSelector.selectFirst();
  this._refreshSortOrder();
  this._requestSort();
};
n.prototype.getCurrentSorting = function () {
  var e = this._sortOrderMap[this._currentSorting];
  return {
    by: this._currentSorting,
    order: e
  };
};
n.prototype._refreshSortOrder = function () {
  var e = this._sortOrderMap[this._currentSorting];
  this._sortOrderBtn.toggleClassName("ascending", "ASC" === e);
  this._sortOrderBtn.toggleClassName("descending", "DESC" === e);
  this._updateSortingTag();
};
n.prototype._updateSortingTag = function () {
  if (this._withTagBar) {
    this._delFilterButton("SORTING");
    var e = this._sortOrderMap[this._currentSorting];
    if (this._currentSorting !== g || e !== _) {
      var t = T[C[this._currentSorting]].labels,
        i = t["ASC" === e ? 0 : 1];
      this._addFilterButton("SORTING", i).addClassNames("sorting");
    }
  }
};
n.prototype._requestSort = function () {
  this.emit("sort", [this._currentSorting], this._sortOrderMap[this._currentSorting]);
};
n.prototype._createSortSelector = function () {
  var e = "A..Z",
    t = "Z..A",
    i = l("ui.common.category"),
    n = l("ui.common.quantity"),
    o = l("tablet.filter.light"),
    a = l("tablet.filter.heavy"),
    s = l("tablet.filter.cheap"),
    r = l("tablet.filter.costly");
  T = [{
    value: g,
    defOrder: _,
    text: l("tablet.sortBy.default"),
    labels: [l("tablet.filter.older"), "new"]
  }, {
    value: "name",
    defOrder: "ASC",
    text: l("tablet.sortBy.name"),
    labels: [e, t]
  }, {
    value: "weight",
    defOrder: "DESC",
    text: l("tablet.sortBy.weight"),
    labels: [o, a]
  }, {
    value: "totalWeight",
    defOrder: "DESC",
    text: l("tablet.sortBy.weight.lot"),
    labels: [v + o, v + a]
  }, {
    value: "quantity",
    defOrder: "DESC",
    text: l("tablet.sortBy.quantity"),
    labels: ["1..999 " + n, "999..1 " + n]
  }, {
    value: "averagePrice",
    defOrder: "DESC",
    text: l("tablet.sortBy.averageprice"),
    labels: [s, r]
  }, {
    value: "totalAveragePrice",
    defOrder: "DESC",
    text: l("tablet.sortBy.averageprice.lot"),
    labels: [v + s, v + r]
  }, {
    value: "level",
    defOrder: "DESC",
    text: l("tablet.sortBy.level"),
    labels: [l("tablet.filter.lowLevel"), l("tablet.filter.highLevel")]
  }, {
    value: "category",
    defOrder: "ASC",
    text: l("tablet.sortBy.category"),
    labels: [e + " " + i, t + " " + i]
  }];
  var c = new m({
    className: "sortSelector",
    removeWords: l("tablet.sortBy.removeWords")
  });
  C = {};
  for (var d = 0; d < T.length; d++) {
    var u = T[d];
    c.addOption(u.text, u.value);
    this._sortOrderMap[u.value] = u.defOrder;
    C[u.value] = d;
  }
  return c;
};
n.prototype._switchFilterInput = function (e) {
  var t = this._filterDisplayed;
  if ("NEXT" === e) {
    var i = S.indexOf(this._filterDisplayed),
      n = this._withSorting ? S.length : S.length - 1;
    i = (i + 1) % n;
    this._filterDisplayed = S[i];
  } else {
    this._filterDisplayed = e;
  }
  this._switchFilteringBtn.replaceClassNames([t], [this._filterDisplayed]);
  this._categoryBox.toggleDisplay("category" === this._filterDisplayed);
  this._searchBox.toggleDisplay("search" === this._filterDisplayed);
  this._sortBox.toggleDisplay("sort" === this._filterDisplayed);
};
n.prototype._setCategoryFilter = function (e, t) {
  var i = !1;
  if (e !== this._selectedFilter) {
    if (this._filterButtonList[this._selectedFilter] && (this._filterButtonList[this._selectedFilter].delClassNames("selected"), this._selectList[this._selectedFilter].wdSelect.hide()), this._selectedFilter = e, this._filterButtonList[e].addClassNames("selected"), e === w.preset) {
      return this._subFiltersBox.hide(), this._withTagBar && this._tagBar.hide(), !0;
    }
    this._subFiltersBox.show();
    this._withTagBar && (this._tagBar.show(), this._delFilterButton("CAT"), e !== y && this._addFilterButton("CAT", M[e + 1]));
    var n = this._selectList[e].wdSelect;
    n.show();
    i = !0;
  }
  return !(!i && void 0 === t) && (void 0 === t && (t = this._selectedSubFilter), this._setSubCategoryFilter(t) | i);
};
n.prototype._setSubCategoryFilter = function (e) {
  var t = this._selectList[this._selectedFilter].wdSelect;
  return t.hasValue(e) ? t.select(e, !0) : (e = t.selectFirst(!0), void 0 === e && (e = y)), e !== this._selectedSubFilter && (this._selectedSubFilter = e, this._withTagBar && (this._delFilterButton("SUBCAT"), e !== y && this._addFilterButton("SUBCAT", t.getCurrentText())), !0);
};
n.prototype._setTextFilter = function (e) {
  return e !== this._currentText && (this._searchBox.setValue(e), this._currentText = e, this._withTagBar && (this._delFilterButton("TEXT"), e && this._addFilterButton("TEXT", '"' + e + '"')), !0);
};
n.prototype._textChangedHandler = function (e) {
  this._setTextFilter(e) && this._requestFilter();
};
n.prototype._updateFilterDisplay = function (e, t) {
  this._setCategoryFilter(e, t) && this._requestFilter();
};
n.prototype._requestFilter = function () {
  this.emit("filter", this._selectedFilter, this._selectedSubFilter, this._searchBox.getValue());
};
n.prototype._tapOnMainCategory = function (e) {
  this._updateFilterDisplay(e);
};
n.prototype.selectCategory = function (e) {
  this._switchFilterInput("category");
  this._updateFilterDisplay(e, y);
};
n.prototype.toggleCategoryDisplay = function (e, t) {
  this._filterBtnMap[e].toggleDisplay(t);
};
n.prototype.selectSubfilter = function (e) {
  var t = this._selectedFilter,
    i = this._selectList[t].wdSelect;
  return !!i.hasValue(e) && (i.select(e, !0), this._updateFilterDisplay(t, e), !0);
};
n.prototype.updateSubFilters = function (e) {
  var t = d.getItemTypeMap(),
    i = e.sort(function (e, i) {
      return t[e].nameId.localeCompare(t[i].nameId);
    });
  for (var n in this._selectList) {
    this._selectList[n].wdSelect.clearContent();
    this._withAllCategoriesBtn && this._selectList[n].wdSelect.addOption(l("ui.common.allTypesForObject"), I.all);
  }
  for (var o = this._selectList[w.all], a = 0, s = i.length; a < s; a += 1) {
    var r = t[i[a]],
      c = this._selectList[r.category];
    c.wdSelect.addOption(r.nameId, r.id);
    o.wdSelect.addOption(r.nameId, r.id);
  }
};
n.prototype.reset = function (e) {
  var t = this._setCategoryFilter(y, y),
    i = this._setTextFilter("");
  (!e && t || i) && this._requestFilter();
};
this._filterBtnMap = {};
this._subFiltersBox = this.createChild("div", {
  className: "subFiltersBox"
});
this._switchFilteringBtn = this._subFiltersBox.appendChild(new u({
  className: "switchBtn",
  addIcon: !0,
  tooltip: l("ui.common.sortOrSearch")
}, this._switchFilterInput.bind(this, "NEXT")));
this._categoryBox = this._subFiltersBox.createChild("div", {
  className: "categories"
});
this._filterButtonList[r] = h;
this._filterBtnMap[r] = h;
s(h, M[n]);
h.filter = r;
h.myItemFilters = this;
h.createChild("div", {
  className: "icon"
});
this._subFiltersSelect.push(f);
f.on("change", i);
f.hide();
this._selectList[r] = {
  wdSelect: f
};
this._tagBar = g.createChild("div", {
  className: "tagBar"
});
this._tagButtons = [];
this._currentSorting = e;
this._refreshSortOrder();
this._requestSort();
this._sortOrderMap[this._currentSorting] = t;
this._refreshSortOrder();
this._requestSort();
this._currentSorting = g;
this._sortOrderMap[g] = _;
this._sortSelector.selectFirst();
this._refreshSortOrder();
this._requestSort();
this._sortOrderBtn.toggleClassName("ascending", "ASC" === e);
this._sortOrderBtn.toggleClassName("descending", "DESC" === e);
this._updateSortingTag();
c.addOption(u.text, u.value);
this._sortOrderMap[u.value] = u.defOrder;
C[u.value] = d;
i = (i + 1) % n;
this._filterDisplayed = S[i];
this._switchFilteringBtn.replaceClassNames([t], [this._filterDisplayed]);
this._categoryBox.toggleDisplay("category" === this._filterDisplayed);
this._searchBox.toggleDisplay("search" === this._filterDisplayed);
this._sortBox.toggleDisplay("sort" === this._filterDisplayed);
this._subFiltersBox.show();
this._withTagBar && (this._tagBar.show(), this._delFilterButton("CAT"), e !== y && this._addFilterButton("CAT", M[e + 1]));
n.show();
i = !0;
this._switchFilterInput("category");
this._updateFilterDisplay(e, y);
this._selectList[n].wdSelect.clearContent();
this._withAllCategoriesBtn && this._selectList[n].wdSelect.addOption(l("ui.common.allTypesForObject"), I.all);
c.wdSelect.addOption(r.nameId, r.id);
o.wdSelect.addOption(r.nameId, r.id);
n.prototype.getEquipmentButton = function () {
  return this._filterBtnMap[E];
};
n.prototype.getQuestButton = function () {
  return this._filterBtnMap[f.questFilterId];
};
n.prototype.setAvailableCategories = function (e) {
  for (var t in d.categories) {
    var i = !(!e || !e[t]) || N[t];
    this.toggleCategoryDisplay(d.categories[t], i);
    this._selectedFilter !== d.categories[t] || i || this.selectCategory(y);
  }
};
n.prototype._addFilterButton = function (e, t) {
  var i = {};
  t[0] === v ? (t = t.substr(1), i.withIcon = !0, i.tooltip = t + " (" + l("tablet.lot") + ")") : i.tooltip = t;
  var n = new r(t, a, e, i);
  return n.itemFilters = this, this._tagButtons.push(n), this._tagBar.appendChild(n), this._tagBar.show(), n;
};
n.prototype._delFilterButton = function (e) {
  for (var t = 0; t < this._tagButtons.length; t++) {
    var i = this._tagButtons[t];
    if (i.filterName === e) {
      return this._tagBar.removeChild(i), void this._tagButtons.splice(t, 1);
    }
  }
};
this.toggleCategoryDisplay(d.categories[t], i);
this._selectedFilter !== d.categories[t] || i || this.selectCategory(y);
h.call(this, "div", {
  className: "searchBox"
});
e = e || {};
this.isLiveSearch = !!e.isLiveSearch;
this.maxLength = e.maxLength || 50;
this._createContent(e.label);
e.placeholder && this.setPlaceholder(e.placeholder);
e.emit("search", t);
e.cancelBtn.toggleDisplay(!!t);
e.cancelBtn.hide();
e.clear();
e.searchInput.blur();
e.emit("search", "");
c(n, h);
e.exports = n;
n.prototype.clear = function () {
  this.lastEmittedValue = null;
  this.searchInput.setValue("");
  this.cancelBtn.hide();
};
n.prototype.setValue = function (e) {
  this.searchInput.setValue(e);
  this.cancelBtn.toggleDisplay("string" == typeof e && "" !== e);
};
n.prototype.getValue = function () {
  return this.searchInput.getValue();
};
n.prototype.setPlaceholder = function (e) {
  this.searchInput.setPlaceholder(e);
};
n.prototype._createContent = function (e) {
  e && this.createChild("div", {
    className: "label",
    text: e
  });
  var t = this.createChild("div", {
      className: "inputFrame"
    }),
    i = this.searchInput = t.appendChild(new d({
      attr: {
        maxLength: this.maxLength
      }
    }));
  i.mySearchBox = this;
  i.on("change", o);
  i.on("validate", a);
  var n = this.cancelBtn = t.appendChild(new r({
    className: "cancelBtn",
    addIcon: !0,
    hidden: !0
  }, s));
  if (n.mySearchBox = this, !this.isLiveSearch) {
    var l = this.appendChild(new r({
      className: "searchBtn",
      addIcon: !0
    }, a));
    l.mySearchBox = this;
  }
};
n.prototype.showAsSearching = function (e) {
  this.toggleClassName("spinner", e);
  this.searchInput.setEnable(!e);
};
n.prototype.setEnable = function (e) {
  this.searchInput.setEnable(e);
};
this.lastEmittedValue = null;
this.searchInput.setValue("");
this.cancelBtn.hide();
this.searchInput.setValue(e);
this.cancelBtn.toggleDisplay("string" == typeof e && "" !== e);
i.mySearchBox = this;
i.on("change", o);
i.on("validate", a);
this.toggleClassName("spinner", e);
this.searchInput.setEnable(!e);
e.attr = n;
a.call(this, "div");
e && e.className && this.addClassNames(e.className + "_InputBox");
this.addClassNames("InputBox");
this._inputBox = this.createChild("input", e);
this._inputBox.addClassNames("domInputBox", n.type);
this._inputBox.rootElement.addEventListener("input", function () {
  i.emit("change", i._inputBox.rootElement.value);
});
this._inputBox.rootElement.addEventListener("blur", function () {
  i.emit("blur");
});
this.rootElement.addEventListener("touchend", function (e) {
  e.stopImmediatePropagation();
  i._inputBox.rootElement.dispatchEvent(new Event("touchend"));
});
this.rootElement.addEventListener("keypress", function (e) {
  13 === e.which && (t && t(i), i.emit("validate"));
});
e.stopImmediatePropagation();
i._inputBox.rootElement.dispatchEvent(new Event("touchend"));
o(n, a);
e.exports = n;
n.prototype.setValue = function (e, t) {
  this._inputBox.rootElement.value = e;
  t && this.emit("change", e);
};
n.prototype.setClassNames = function (e) {
  this._inputBox.setClassNames(e);
};
n.prototype.setPlaceholder = function (e) {
  this._inputBox.rootElement.placeholder = e;
};
n.prototype.getValue = function () {
  return this._inputBox.rootElement.value || "";
};
n.prototype.setReadonly = function (e) {
  e === !1 ? this._inputBox.rootElement.removeAttribute("readonly") : this._inputBox.rootElement.setAttribute("readonly", "readonly");
};
n.prototype.blur = function () {
  this._inputBox.rootElement.blur();
  s.hide();
};
n.prototype.focus = function () {
  this._inputBox.rootElement.focus();
};
n.prototype.disable = function () {
  this._inputBox.rootElement.disabled = !0;
};
n.prototype.enable = function () {
  this._inputBox.rootElement.disabled = !1;
};
n.prototype.setEnable = function (e) {
  this._inputBox.rootElement.disabled = !e;
};
n.prototype.setCaretPosition = function (e) {
  this._inputBox.rootElement.setSelectionRange(e, e);
};
this._inputBox.rootElement.value = e;
t && this.emit("change", e);
this._inputBox.rootElement.blur();
s.hide();
r = window.gui.wBody.appendChild(new s({
  className: "notification"
}));
r.appendChild(new a({
  className: "closeButton",
  scaleOnPress: !0
}, function () {
  t.closeNotifications();
}));
t.showClosableNotification = function (e, t, i) {
  return r || n(), l || (window.gui.wBody.on("dom.touchend", o), l = !0), i && i.centerOnTarget ? r.updateAndAppearAt(e, t, {
    centerOnTarget: !0
  }) : r.updateAndAppearAt(e, t), r;
};
t.closeNotifications = function () {
  l && (window.gui.wBody.removeListener("dom.touchend", o), l = !1);
  r && r.closeTooltip();
};
t.showNotification = function (e, t, i) {
  s.showNotification(e, t, i);
};
l && (window.gui.wBody.removeListener("dom.touchend", o), l = !1);
r && r.closeTooltip();
e = e || {};
l.call(this, "div", {
  className: "Selector"
});
this.addClassNames(e.className);
this.removeWords = e.removeWords ? e.removeWords.split("|") : null;
this._valuePairs = [];
this._currentValue = null;
this._isEnabled = !0;
this._dropDownSelector = this.appendChild(new c({
  className: ["selectorContent"],
  scaleOnPress: !1,
  text: " "
}));
s(this._dropDownSelector, o);
this.buttonOpen = this.createChild("div", {
  className: "buttonOpen"
});
this._dropDownSelector.on("tap", function () {
  if (null !== i._currentValue) {
    var e = i._getValueIndex(i._currentValue);
    window.gui.dropDown.setupDropDown(this, i._valuePairs, e, t);
  }
});
r(n, l);
e.exports = n;
n.prototype._getValueIndex = function (e) {
  for (var t = this._valuePairs, i = 0; i < t.length; i++) {
    if (t[i].value === e) {
      return i;
    }
  }
  return -1;
};
n.prototype.addOption = function (e, t) {
  t || 0 === t || (t = "");
  null === this._currentValue && (this._currentValue = t, this._setCurrentText(e, 0), this.setEnable(!0));
  this._valuePairs.push({
    text: e,
    value: t
  });
};
n.prototype.changeTexts = function (e) {
  for (var t = 0; t < Math.min(e.length, this._valuePairs.length); t++) {
    this._valuePairs[t].text = e[t];
  }
};
n.prototype.insertOptionAtTop = function (e, t) {
  t || 0 === t || (t = "");
  this._valuePairs.unshift({
    text: e,
    value: t
  });
};
n.prototype.sortValues = function () {
  this._valuePairs.sort(a);
};
n.prototype.setEnable = function (e) {
  e = !!e && null !== this._currentValue;
  e !== this._isEnabled && (this._isEnabled = e, this._dropDownSelector.setEnable(e), this.toggleClassName("disabled", !e));
};
n.prototype.hasValue = function (e) {
  return this._getValueIndex(e) !== -1;
};
n.prototype.select = function (e, t) {
  this._setValue(e, t);
};
n.prototype.selectFirst = function (e) {
  if (this._valuePairs.length) {
    var t = this._valuePairs[0].value;
    return this._setValue(t, e), t;
  }
};
n.prototype._setValue = function (e, t) {
  var i = this._getValueIndex(e);
  if (i === -1) {
    return console.error(new Error("Selecting invalid value: " + e));
  }
  var n = this._currentValue;
  this._currentValue = e;
  window.gui.dropDown.select(i);
  var o = this._valuePairs[i],
    a = this._setCurrentText(o.text, i);
  t || this.emit("change", e, n, a);
};
n.prototype._setCurrentText = function (e, t) {
  if (this._dropDownSelector._tooltipText = e, this.removeWords && 0 !== t) {
    for (var i = 0; i < this.removeWords.length; i++) {
      e = e.replace(this.removeWords[i], "");
    }
    e = e[0].toLocaleUpperCase() + e.substr(1);
  }
  return this._dropDownSelector.setText(e), e;
};
n.prototype.getCurrentText = function () {
  return this._dropDownSelector.getText();
};
n.prototype.setValue = function (e) {
  this._setValue(e, !0);
};
n.prototype.clearContent = function () {
  this._valuePairs = [];
  this._currentValue = null;
  this._dropDownSelector.setText("");
  window.gui.dropDown.clearContent();
  this.setEnable(!1);
};
n.prototype.toggleOption = function (e, t) {
  if (e || 0 === e) {
    var i = this._valuePairs[e];
    i && (t = void 0 === t ? i.disabled : t, i.disabled = !t);
  }
};
n.prototype.setOptionHidden = function (e, t) {
  var i = this._valuePairs[e];
  return i ? void (i.hidden = !!t) : console.warn("Invalid selector option", e);
};
t || 0 === t || (t = "");
null === this._currentValue && (this._currentValue = t, this._setCurrentText(e, 0), this.setEnable(!0));
this._valuePairs.push({
  text: e,
  value: t
});
t || 0 === t || (t = "");
this._valuePairs.unshift({
  text: e,
  value: t
});
e = !!e && null !== this._currentValue;
e !== this._isEnabled && (this._isEnabled = e, this._dropDownSelector.setEnable(e), this.toggleClassName("disabled", !e));
this._currentValue = e;
window.gui.dropDown.select(i);
this._valuePairs = [];
this._currentValue = null;
this._dropDownSelector.setText("");
window.gui.dropDown.clearContent();
this.setEnable(!1);
n && (o += " (" + M("tablet.estimation") + ")");
e.createChild("div", {
  text: o
});
a.createChild("span", {
  text: t + M("ui.common.colon")
});
a.createChild("span", {
  text: "?",
  className: "unknown"
});
o > 0 ? i = "+" : o < 0 && (i = "-");
n += M("ui.common.short.CriticalHit") + M("ui.common.colon") + "1/";
e.category.setText(M("ui.common.category") + M("ui.common.colon") + o[n].nameId);
e.category.show();
i.showWeight === !1 ? e.weight.hide() : (e.weight.setText(M("ui.common.short.weight", t.getProperty("weight"))), e.weight.show());
e.level.setText(M("ui.common.short.level") + " " + t.getProperty("level"));
e.points.ra.setText(M("ui.common.ra") + " : " + l);
e.points.range.setText(r !== l ? " - " + r : "");
e.points.show();
s && s !== -1 && h(a.createChild("div", {
  className: "extra"
}), t);
t.getProperty("twoHanded") && a.createChild("div", {
  className: "extra",
  text: M("ui.common.twoHandsWeapon")
});
t.getProperty("castInLine") && r > 1 && !t.getProperty("castInDiagonal") && a.createChild("div", {
  className: "extra",
  text: M("ui.spellInfo.castInLine")
});
!t.getProperty("castTestLos") && r > 1 && a.createChild("div", {
  className: "extra",
  text: M("ui.spellInfo.castWithoutLos")
});
p(a, t);
g && (_ += d(t, v));
f && (_ += u(t, v));
a.createChild("div", {
  className: "extra",
  text: _
});
e.points.hide();
s && s !== -1 && h(a.createChild("div", {
  className: "extra"
}), t);
p(a, t);
T.call(this, "div", {
  className: "ItemDescription"
});
this._buildDomElements(t);
e && this.updateUI(e, t);
v(f, T);
e.exports = f;
f.prototype._buildDomElements = function (e) {
  var t = this._domElements = {};
  t.header = this.createChild("div", {
    className: "header"
  });
  var i = t.header.createChild("div", {
    className: "nameAndLevel"
  });
  t.header.name = i.createChild("div", {
    className: "name"
  });
  t.header.level = i.createChild("div", {
    className: "right"
  });
  var n = t.header.createChild("div", {
    className: "categoryAndWeight"
  });
  t.header.category = n.createChild("div");
  t.header.weight = n.createChild("div", {
    className: "right"
  });
  var o = t.header.points = t.header.createChild("div", {
    className: "pointsLine"
  });
  o.ap = o.createChild("span", {
    className: "ap"
  });
  o.ra = o.createChild("span", {
    className: "ra"
  });
  o.range = o.createChild("span");
  t.header.extra = t.header.createChild("div", {
    className: "extra"
  });
  t.effects = this.appendChild(new g(e));
  t.conditions = this.createChild("div", {
    className: "topSpacing"
  });
  t.description = this.createChild("div", {
    className: ["topSpacing", "description"]
  });
  t.averagePrice = this.createChild("div", {
    className: "topSpacing"
  });
  t.remoteQuantity = this.createChild("div", {
    className: ["topSpacing", "quantities"]
  });
};
f.prototype.updateUI = function (e, t) {
  if (!(e instanceof w || e instanceof b)) {
    return console.error(new Error("ItemDescription: item is not Item nor ItemInstance"));
  }
  if (this.currentItem = e, e.isItemInstance && !e.isInitialised) {
    var i = this;
    return e.once("initialised", function () {
      i.currentItem === e && i.updateUI(e, t);
    });
  }
  t = t || {};
  for (var n in E) {
    var o = this._domElements[n];
    t[n] !== !1 && E[n](o, e, t) ? o.show() : o.hide();
  }
};
t.header.name = i.createChild("div", {
  className: "name"
});
t.header.level = i.createChild("div", {
  className: "right"
});
t.header.category = n.createChild("div");
t.header.weight = n.createChild("div", {
  className: "right"
});
o.ap = o.createChild("span", {
  className: "ap"
});
o.ra = o.createChild("span", {
  className: "ra"
});
o.range = o.createChild("span");
t.header.extra = t.header.createChild("div", {
  className: "extra"
});
t.effects = this.appendChild(new g(e));
t.conditions = this.createChild("div", {
  className: "topSpacing"
});
t.description = this.createChild("div", {
  className: ["topSpacing", "description"]
});
t.averagePrice = this.createChild("div", {
  className: "topSpacing"
});
t.remoteQuantity = this.createChild("div", {
  className: ["topSpacing", "quantities"]
});
u.call(this, "div", e);
this.addClassNames("EffectDescription");
t = t || {};
this.alwaysVisible = !!t.alwaysVisible;
t = n.createChild("div", {
  className: "monsterLine"
});
i = t.createChild("div", {
  className: "column1"
});
i.setHtml(h + " " + e.subEffectDescription[a]);
e.subEffectDescription[o + a] && (i = t.createChild("div", {
  className: "column2"
}), i.setHtml(h + " " + e.subEffectDescription[o + a]));
n.dbEffect.bonusType === -1 ? o.addClassNames("malus") : 1 === n.dbEffect.bonusType && o.addClassNames("bonus");
n.isExotic && o.addClassNames("exotic");
"string" == typeof n.description ? o.setHtml(h + " " + n.description) : o.appendChild(n.description);
d(n, u);
e.exports = n;
n.prototype._renderDamageAndEffects = function (e, t) {
  for (var i = [], n = [], l = 0, d = e.length; l < d; l++) {
    var u = e[l];
    if (u) {
      var h = u.description;
      if (h && (this.alwaysVisible || !u.hidden)) {
        var p = u.getDurationString();
        p && (h += " (" + p + ")");
        var m = u.isDamageEffect() ? i : n;
        m.push({
          dbEffect: u.effect,
          description: h,
          isExotic: u.isExotic
        });
        u.requiresInvocationDescription() && u.subEffectDescription && m.push({
          dbEffect: u.effect,
          description: a(u)
        });
        o(u) && u.subEffectDescription && m.push({
          dbEffect: u.effect,
          description: s(u)
        });
      }
    }
  }
  var f;
  i.length > 0 && (f = t ? c("ui.common.criticalDamages", 1) : c("ui.stats.damagesBonus", i.length), this.createChild("div", {
    className: "effectTitle",
    text: f + c("ui.common.colon")
  }), r(this, i));
  n.length > 0 && (f = t ? c("ui.common.criticalEffects", 1) : c("ui.common.effects", n.length), this.createChild("div", {
    className: "effectTitle",
    text: f + c("ui.common.colon")
  }), r(this, n));
};
n.prototype.setEffectsFromItem = function (e, t) {
  var i;
  t = t || {};
  this.clearContent();
  var n,
    o = e.getItemInstance();
  n = t.showPossibleEffects || !o ? e.getItem() : o;
  i = l.getSortedEffectInstances(n);
  this._renderDamageAndEffects(i);
};
n.prototype.setEffectsFromSpell = function (e, t) {
  this.clearContent();
  var i,
    n,
    o,
    a = e.getSpellLevelId();
  for (i = [], n = 0, o = e.getEffectsIds(t).length; n < o; n++) {
    i.push(e.effectInstances[a + "-effects-" + n]);
  }
  for (this._renderDamageAndEffects(i), i = [], n = 0, o = e.getCriticalEffectsIds(t).length; n < o; n++) {
    i.push(e.effectInstances[a + "-criticalEffect-" + n]);
  }
  this._renderDamageAndEffects(i, !0);
};
n.prototype.setEffects = function (e) {
  this.clearContent();
  this._renderDamageAndEffects(e);
};
m.push({
  dbEffect: u.effect,
  description: h,
  isExotic: u.isExotic
});
u.requiresInvocationDescription() && u.subEffectDescription && m.push({
  dbEffect: u.effect,
  description: a(u)
});
o(u) && u.subEffectDescription && m.push({
  dbEffect: u.effect,
  description: s(u)
});
i.length > 0 && (f = t ? c("ui.common.criticalDamages", 1) : c("ui.stats.damagesBonus", i.length), this.createChild("div", {
  className: "effectTitle",
  text: f + c("ui.common.colon")
}), r(this, i));
n.length > 0 && (f = t ? c("ui.common.criticalEffects", 1) : c("ui.common.effects", n.length), this.createChild("div", {
  className: "effectTitle",
  text: f + c("ui.common.colon")
}), r(this, n));
t = t || {};
this.clearContent();
n = t.showPossibleEffects || !o ? e.getItem() : o;
i = l.getSortedEffectInstances(n);
this._renderDamageAndEffects(i);
this.clearContent();
this._renderDamageAndEffects(e);
i = c[d];
n = i.effect.bonusType;
1 === n && (o = Math.floor(i.value * e.favoriteSubAreasBonus / 100), o && (a = i.clone(), a.setParameter(2, o), a.forceDescriptionRefresh(), s.push(a)));
n.prototype._getEffectInstances = function (e, t) {
  var i = t && t.effects,
    n = e.possibleEffects,
    a = i && i.length > 0,
    s = n && n.length > 0;
  if (a || s) {
    var r, l;
    if (t) {
      r = i.concat(o(e, t));
      l = !t.objectUID;
    } else {
      if (!s) {
        return;
      }
      r = n;
      l = !0;
    }
    if (r = r.filter(function (e) {
      return e && e.effect && !e.isLivingProperty;
    }), this.exoticEffects = {}, !l && !e.hideEffects && e.enhanceable) {
      for (var c = 0; c < r.length; c += 1) {
        var d = r[c].effect;
        if (d && d.showInSet && n) {
          for (var u = !0, h = 0; h < n.length; h += 1) {
            if (d.id === n[h].effectId) {
              u = !1;
              break;
            }
          }
          this.exoticEffects[d.id] = u;
        }
      }
    }
    return r;
  }
};
n.prototype.sortEffects = function (e) {
  function t(e, t) {
    var i = e.effect,
      n = t.effect;
    return a.exoticEffects[i.id] ? -1 : a.exoticEffects[n.id] ? 1 : i.category === n.category && n.category === s.damage ? 0 : i.effectPriority - n.effectPriority;
  }
  var i,
    n,
    o,
    a = this,
    r = e.sort(t),
    l = [s.damage, s.miscellaneous, s.resistance, s.special],
    c = {};
  for (i = 0; i < r.length; i += 1) {
    if (o = r[i].effect, o.category !== s.undefined && 812 !== o.id) {
      a.exoticEffects[o.id] && (r[i].isExotic = !0);
      var d = o.showInSet ? o.category : s.special;
      c[d] || (c[d] = []);
      c[d].push(r[i]);
    }
  }
  var u = [];
  for (i = 0; i < l.length; i += 1) {
    var h = c[l[i]];
    if (h) {
      for (n = 0; n < h.length; n += 1) {
        var p = h[n];
        u.push(p);
      }
    }
  }
  return u;
};
n.prototype.getSortedEffectInstances = function (e) {
  var t = e instanceof a ? e : null,
    i = t && t.item || e,
    n = this._getEffectInstances(i, t);
  return n ? this.sortEffects(n) : [];
};
e.exports = new n();
r = i.concat(o(e, t));
l = !t.objectUID;
r = n;
l = !0;
c[d] || (c[d] = []);
c[d].push(r[i]);
this.cols = e;
this._selectedRow = null;
this.colIndex = {};
this.colIndex[c.id] = r;
c.format = c.format || c.getContent || o;
c.sort && ("function" == typeof c.sort ? c.getContent = c.getContent || a : (c.sort = n, c.getContent = c.getContent || o), c.order = c.order || "ascending", c.defaultSorter && (this.defaultSorter = c, this.defaultOrder = c.order, this.sortBy = c));
this._clickable = i.clickable !== !1;
i.noHeader || this._addHeader();
i.sorter && this.setSorter(i.sorter);
this.toggleClassName("scaleOnPress", Boolean(i.scaleOnPress));
this._onRowCreation = i.onRowCreation;
this.scroller = this.appendChild(new v({
  className: "tableScroller"
}));
this.rows = this.scroller.content;
this.rows.addClassNames("tableContent");
this._slidable = i.slidable;
this._slidable && this._createSlideBackElement();
this.filters = [];
this.placeholder = null;
this.spinner = new y(this);
this.isSorting = !1;
_(s, m);
e.exports = s;
s.prototype._createSlideBackElement = function () {
  var e = this._slideBack = new m("div", {
    className: "slideBackElement"
  });
  e.setStyle("opacity", 0);
  e.appendChild(this._slidable);
  e.rowId = null;
  e.side = "left";
  this.scroller.appendChild(e);
};
s.prototype.setColumnHeader = function (e, t) {
  var i = this.header.row.getChild(e);
  return i ? ("string" == typeof t ? i.content.setText(t) : (i.content.clearContent(), i.content.appendChild(t)), void i.sorter.toggleClassName("noText", !t)) : console.error("setColumnHeader: invalid colId:", e);
};
s.prototype.setSortingHintVisible = function (e, t) {
  var i = this.header.row.getChild(e);
  return i ? void i.sorter.toggleClassName("noTriangle", !!t) : console.error("setSortingHintVisible: invalid colId:", e);
};
s.prototype._addHeader = function () {
  this.header = this.createChild("div", {
    className: "tableHeader"
  });
  for (var e = this.header.row = this.header.createChild("div", {
      className: "row"
    }), t = 0, i = this.cols.length; t < i; t += 1) {
    var n,
      o = this.cols[t];
    o.sort ? (n = e.appendChild(new h({
      className: ["col", o.id],
      name: o.id
    }, r)), n.myTable = this) : n = e.createChild("div", {
      className: ["col", o.id]
    });
    u(n, o.tooltip ? o.tooltip : l);
    e[o.id] = n;
    (o.header || o.sort) && (n.content = n.createChild("div", {
      className: "headerContent"
    }), o.header instanceof m ? n.content.appendChild(o.header) : n.content.setText(o.header || ""), o.sort && (n.addClassNames(o.order), n.sorter = n.createChild("div", {
      className: "sortBtn"
    }), this._toggleTriangle(n, !!o.defaultSorter), n.sortBy = o, o.header || n.sorter.addClassNames("noText")));
  }
};
s.prototype.setContentLoading = function (e) {
  e ? this.spinner.addSpinner("content") : this.spinner.removeSpinner("content");
};
s.prototype.setPlaceholderText = function (e) {
  if (!this.placeholder) {
    if (!e) {
      return;
    }
    this.placeholder = new p(this, {
      headerElement: this.header
    });
  }
  this.placeholder.setText(e);
};
s.prototype._toggleTriangle = function (e, t) {
  e.toggleClassName("showingTriangle", t);
};
s.prototype._hideCurrentTriangle = function () {
  var e = this.sortBy;
  e && e.id && this._toggleTriangle(this.header.row[e.id], !1);
};
s.prototype.setSorter = function (e, t) {
  this._hideCurrentTriangle();
  this.sortBy = {
    order: t || "ascending",
    sort: e,
    getContent: a
  };
};
s.prototype._updateSortButton = function (e, t) {
  this._hideCurrentTriangle();
  this._toggleTriangle(e, !0);
  e.sortBy.order = t;
  e.toggleClassName("descending", "descending" === t);
};
s.prototype._tapOnSortBtn = function (e) {
  if (!this.isSorting) {
    this.isSorting = !0;
    var t;
    t = e.sortBy === this.sortBy ? "ascending" === e.sortBy.order ? "descending" : "ascending" : e.sortBy.order;
    this.spinner.addSpinner("sorting");
    this._updateSortButton(e, t);
    window.setTimeout(this._sortByColumn.bind(this, e, t));
  }
};
s.prototype.sortByColumnId = function (e, t) {
  var i = this.header.row[e];
  this._updateSortButton(i, t);
  this._sortByColumn(i, t);
};
s.prototype.sortAgain = function () {
  this.scroller.removeChild(this.rows);
  this.sort();
  this.scroller.appendChild(this.rows);
};
s.prototype._sortByColumn = function (e, t) {
  this.sortBy = e.sortBy;
  e.sortBy.order = t;
  this.scroller.removeChild(this.rows);
  this.sort();
  this.scroller.appendChild(this.rows);
  this.spinner.removeSpinner("sorting");
  this.isSorting = !1;
};
s.prototype.resetSort = function () {
  if (this.defaultSorter) {
    var e = this.header.row[this.defaultSorter.id];
    this._updateSortButton(e, this.defaultOrder);
    this._sortByColumn(e, this.defaultOrder);
  }
};
s.prototype.sort = function (e, t) {
  if (e && this.setSorter(e, t), this.sortBy) {
    var i = this.sortBy,
      n = "ascending" === i.order ? 1 : -1;
    e = function (e, t) {
      return i.sort(i.getContent(e.rowContent), i.getContent(t.rowContent)) * n;
    };
  }
  var o = this.rows.getChildren();
  e && o.sort(e);
  for (var a = !0, s = 0, r = o.length; s < r; s += 1) {
    var l = o[s];
    e && this.rows.appendChild(l);
    l.isVisible() && (l.toggleClassName("odd", a), a = !a);
  }
};
s.prototype._insertRowInRightPosition = function (e) {
  var t,
    i,
    n,
    o = this.sortBy;
  o && (t = o.sort, i = "ascending" === o.order ? 1 : -1);
  t && (n = o.getContent(e.rowContent));
  for (var a = !1, s = !1, r = !0, l = this.rows.getChildren(), c = 0, d = l.length; c < d; c += 1) {
    var u = l[c];
    if (u === e) {
      if (t) {
        continue;
      }
      a = !0;
    }
    !s && t && t(n, o.getContent(u.rowContent)) * i < 0 && (e.insertBefore(u), s = !0, e.isVisible() && (e.toggleClassName("odd", r), r = !r));
    u.isVisible() && (u.toggleClassName("odd", r), r = !r);
  }
  s || a || (this.rows.appendChild(e), e.toggleClassName("odd", r));
};
s.prototype.findRow = function (e, t) {
  for (var i = this.rows.getChildren(), n = 0, o = i.length; n < o; n += 1) {
    var a = i[n];
    if (e.call(this, a.rowContent, t)) {
      return a.rowId;
    }
  }
  return null;
};
s.prototype.filter = function (e) {
  var t = this.rows.getChildren(),
    i = !0;
  e = e || this._shouldDisplayRow;
  for (var n = 0, o = t.length; n < o; n += 1) {
    var a = t[n],
      s = e.call(this, a.rowContent);
    a.toggleDisplay(s);
    s && (w.cancelTween(a) && a.setStyle("webkitTransform", null), a.toggleClassName("odd", i), i = !i);
  }
  this.scroller.refresh();
};
s.prototype.addFilter = function (e) {
  this.filters.push(e);
};
s.prototype.removeFilter = function (e) {
  var t = this.filters.indexOf(e);
  t !== -1 && this.filters.splice(t, 1);
};
s.prototype._shouldDisplayRow = function (e) {
  for (var t = 0, i = this.filters.length; t < i; t += 1) {
    if (!this.filters[t].call(this, e)) {
      return !1;
    }
  }
  return !0;
};
s.prototype.hasRow = function (e) {
  return !!this.rows.getChild(e);
};
s.prototype.unSelectRow = function () {
  this._selectedRow && this._selectedRow.delClassNames("selected");
  this._selectedRow = null;
};
s.prototype.selectRow = function (e, t) {
  var i = this.rows.getChild(e);
  return this._selectedRow !== i && (this.unSelectRow(), i.addClassNames("selected"), this._selectedRow = i), t || this.emit("rowTap", i, i.rowContent), i;
};
s.prototype.scrollToSelectedRow = function () {
  this._selectedRow && this.scroller.scrollToElement(this._selectedRow);
};
s.prototype.selectFirstRow = function (e) {
  var t = this.rows.getChildren()[0];
  t && this.selectRow(t.rowId, e);
};
s.prototype.endSlide = function (e) {
  this._slideBack.rowId === e && (this._slideBack.setStyle("opacity", 0), this._slideBack.row.slideBack());
};
s.prototype.setSlideEnable = function (e) {
  this._slideLock = !e;
};
s.prototype._addSlideBehavior = function (e) {
  g(e, "x");
  var t,
    i,
    n,
    o = this,
    a = this._slideBack,
    s = e.rootElement;
  e.on("slideStart", function (i, r) {
    o._slideLock || (null !== a.rowId && o.endSlide(a.rowId), a.rowId = e.rowId, a.row = e, a.setStyles({
      height: r.height + "px",
      webkitTransform: "translate3d(0," + (s.offsetTop + o.scroller.iScroll.y) + "px,0)"
    }), t = i.x, n = r.width / 2, e.setSwipeMinimum(n));
  });
  e.on("slide", function (e) {
    o._slideLock || (i = e.x - t, i > n ? i = n : i < -n && (i = -n), a.setStyle("opacity", Math.abs(i) / n), this.setStyle("webkitTransform", "translate3d(" + i + "px,0,0)"));
  });
  e.slideBack = function (t) {
    a.rowId = null;
    w.tween(e, {
      webkitTransform: "translate3d(0,0,0)"
    }, {
      time: 100,
      easing: "ease-out"
    }, function () {
      if (a.setStyle("opacity", 0), a.delClassNames("spinner", a.side), t) {
        return t();
      }
    });
  };
  e.on("slideEnd", function (t, i) {
    o._slideLock || (t ? i > 0 ? (a.side = "left", a.addClassNames("spinner", "left"), o.emit("rowSlidedLeft", e, e.rowContent)) : (a.side = "right", a.addClassNames("spinner", "right"), o.emit("rowSlidedRight", e, e.rowContent)) : e.slideBack());
  });
};
s.prototype._createRow = function (e, t, i) {
  t = void 0 === t ? this.getIdFn(e) : t;
  var n = this;
  if (this.rows.getChild(t)) {
    throw new Error('THROW createRow: Already have a child named "' + t + '"');
  }
  var o = this.rows.appendChild(new m("div", {
    className: "row",
    name: t
  }));
  this._slidable && this._addSlideBehavior(o);
  i && o.setStyle("webkitTransform", "translate3d(100%,0,0)");
  o.rowId = t;
  o.rowContent = e;
  o.myTable = this;
  for (var a = 0, s = this.cols.length; a < s; a += 1) {
    var r = this.cols[a];
    o[r.id] = o.createChild("div", {
      className: ["col", r.id]
    });
    d(o, r);
  }
  return this._clickable && (f(o), o.on("enable", c), o.on("tapstart", function () {
    o.addClassNames("pressed");
  }), o.on("tapend", function () {
    o.delClassNames("pressed");
  }), o.on("tap", function () {
    n.selectRow(t);
  })), this._onRowCreation && this._onRowCreation(o, e), o.toggleDisplay(this._shouldDisplayRow(e)), this.emit("rowAdded", t, e, o), o;
};
s.prototype.addRow = function (e, t, i) {
  var n = this._createRow(e, t, i);
  return this._insertRowInRightPosition(n), this.scroller.refresh(), i ? (this.scroller.scrollToElement(n), w.tween(n, {
    webkitTransform: "translate3d(0,0,0)"
  }, {
    time: T,
    easing: "ease-out"
  })) : n.setStyle("webkitTransform", null), n;
};
s.prototype._playAnimationForNewRows = function (e) {
  for (var t, i = this.rows.getChildren(), n = 0, o = b / 2, a = 0; a < i.length; a++) {
    var s = i[a];
    if (e[s.rowId]) {
      if (n >= b || !s.isVisible()) {
        s.setStyle("webkitTransform", null);
      } else {
        0 === n && (t = s);
        var r = (o - Math.abs(n - o)) * M;
        n++;
        w.tween(s, {
          webkitTransform: "translate3d(0,0,0)"
        }, {
          time: T,
          easing: "ease-out",
          delay: r
        });
      }
    }
  }
  t && this.scroller.scrollToElement(t);
};
s.prototype.addList = function (e, t, i) {
  if (this.scroller.removeChild(this.rows), e.length && this.setPlaceholderText(""), i) {
    for (var n = 0; n < e.length; n++) {
      var o = this.getIdFn(e[n]);
      this.hasRow(o) && this.delRow(o, !1);
    }
  }
  var a,
    s,
    r,
    l = {};
  for (s = 0, r = e.length; s < r; s += 1) {
    a = this._createRow(e[s], void 0, t);
    t && (l[a.rowId] = a);
  }
  this.sort();
  this.scroller.appendChild(this.rows);
  this.scroller.refresh();
  t && this._playAnimationForNewRows(l);
};
s.prototype.addMap = function (e, t) {
  this.scroller.removeChild(this.rows);
  var i = {};
  for (var n in e) {
    var o = this._createRow(e[n], n, t);
    i[o.rowId] = o;
  }
  this.sort();
  this.scroller.appendChild(this.rows);
  this.scroller.refresh();
  t && this._playAnimationForNewRows(i);
};
s.prototype._updateRow = function (e, t) {
  t = void 0 !== t ? t : this.getIdFn(e);
  var i = this.rows.getChild(t);
  if (!i) {
    return this.addRow(e, t);
  }
  i.rowContent = e;
  for (var n = 0, o = this.cols.length; n < o; n += 1) {
    d(i, this.cols[n]);
  }
  return i.toggleDisplay(this._shouldDisplayRow(e)), i;
};
s.prototype.refreshRows = function () {
  for (var e = this.rows.getChildren(), t = 0; t < e.length; t++) {
    var i = e[t];
    this._updateRow(i.rowContent, i.rowId);
  }
};
s.prototype.updateRows = function (e) {
  for (var t = 0, i = e.length; t < i; t += 1) {
    this._updateRow(e[t]);
  }
  this.sort();
};
s.prototype.updateRow = function (e, t) {
  var i = this._updateRow(e, t);
  return this._insertRowInRightPosition(i), i;
};
s.prototype.getRow = function (e) {
  return this.rows.getChild(e);
};
s.prototype.updateCell = function (e, t, i) {
  var n = this.rows.getChild(e);
  if (!n) {
    return console.error(new Error("Row id unknown: " + e));
  }
  var o = n[t];
  if (!o) {
    return console.error(new Error("Column id unknown: " + t));
  }
  var a = this.cols[this.colIndex[t]];
  return n.rowContent = i, d(n, a), n.toggleDisplay(this._shouldDisplayRow(i)), this.sortBy === a && this._insertRowInRightPosition(n), n;
};
s.prototype.getCell = function (e, t) {
  var i = this.rows.getChild(e);
  if (!i) {
    return console.error(new Error("Row id unknown " + e));
  }
  var n = i[t];
  return n ? n.content : console.error(new Error("Column id unknown " + t));
};
s.prototype._delRow = function (e) {
  var t = this.rows.getChild(e);
  t && (this._selectedRow === t && (this._selectedRow = null), this.emit("rowDeleted", e, t.rowContent, t), t.destroy());
};
s.prototype.delRow = function (e, t) {
  function i() {
    o._delRow(e);
    o._updateRowColor();
    o.scroller.refresh();
  }
  var n = this.rows.getChild(e);
  if (n) {
    var o = this;
    return t ? void w.tween(n, {
      webkitTransform: "translate3d(-100%,0,0)"
    }, {
      time: T,
      easing: "ease-out"
    }, i) : i();
  }
};
s.prototype.delRows = function (e, t, i) {
  function n() {
    for (var t = 0, n = e.length; t < n; t += 1) {
      o._delRow(e[t]);
    }
    o._updateRowColor();
    o.scroller.refresh();
    i && i.call(o);
  }
  var o = this;
  if (!e.length || !t) {
    return n();
  }
  for (var a = 0, s = e.length; a < s; a += 1) {
    var r = this.rows.getChild(e[a]);
    if (r) {
      var l = a === s - 1 ? n : null;
      w.tween(r, {
        webkitTransform: "translate3d(-100%,0,0)"
      }, {
        time: T,
        easing: "ease-out",
        delay: a * M
      }, l);
    }
  }
};
s.prototype.clearContent = function () {
  this.rows.clearContent();
  this._selectedRow = null;
  this.scroller.refresh();
};
s.prototype.getRowCount = function () {
  return this.rows.getChildCount();
};
s.prototype._updateRowColor = function () {
  for (var e = !0, t = this.rows.getChildren(), i = 0, n = t.length; i < n; i += 1) {
    var o = t[i];
    o.isVisible() && (o.toggleClassName("odd", e), e = !e);
  }
};
e.setStyle("opacity", 0);
e.appendChild(this._slidable);
e.rowId = null;
e.side = "left";
this.scroller.appendChild(e);
o.sort ? (n = e.appendChild(new h({
  className: ["col", o.id],
  name: o.id
}, r)), n.myTable = this) : n = e.createChild("div", {
  className: ["col", o.id]
});
u(n, o.tooltip ? o.tooltip : l);
e[o.id] = n;
(o.header || o.sort) && (n.content = n.createChild("div", {
  className: "headerContent"
}), o.header instanceof m ? n.content.appendChild(o.header) : n.content.setText(o.header || ""), o.sort && (n.addClassNames(o.order), n.sorter = n.createChild("div", {
  className: "sortBtn"
}), this._toggleTriangle(n, !!o.defaultSorter), n.sortBy = o, o.header || n.sorter.addClassNames("noText")));
this._hideCurrentTriangle();
this.sortBy = {
  order: t || "ascending",
  sort: e,
  getContent: a
};
this._hideCurrentTriangle();
this._toggleTriangle(e, !0);
e.sortBy.order = t;
e.toggleClassName("descending", "descending" === t);
t = e.sortBy === this.sortBy ? "ascending" === e.sortBy.order ? "descending" : "ascending" : e.sortBy.order;
this.spinner.addSpinner("sorting");
this._updateSortButton(e, t);
window.setTimeout(this._sortByColumn.bind(this, e, t));
this._updateSortButton(i, t);
this._sortByColumn(i, t);
this.scroller.removeChild(this.rows);
this.sort();
this.scroller.appendChild(this.rows);
this.sortBy = e.sortBy;
e.sortBy.order = t;
this.scroller.removeChild(this.rows);
this.sort();
this.scroller.appendChild(this.rows);
this.spinner.removeSpinner("sorting");
this.isSorting = !1;
this._updateSortButton(e, this.defaultOrder);
this._sortByColumn(e, this.defaultOrder);
e && this.rows.appendChild(l);
l.isVisible() && (l.toggleClassName("odd", a), a = !a);
o && (t = o.sort, i = "ascending" === o.order ? 1 : -1);
t && (n = o.getContent(e.rowContent));
!s && t && t(n, o.getContent(u.rowContent)) * i < 0 && (e.insertBefore(u), s = !0, e.isVisible() && (e.toggleClassName("odd", r), r = !r));
u.isVisible() && (u.toggleClassName("odd", r), r = !r);
a.toggleDisplay(s);
s && (w.cancelTween(a) && a.setStyle("webkitTransform", null), a.toggleClassName("odd", i), i = !i);
this._selectedRow && this._selectedRow.delClassNames("selected");
this._selectedRow = null;
e.on("slideStart", function (i, r) {
  o._slideLock || (null !== a.rowId && o.endSlide(a.rowId), a.rowId = e.rowId, a.row = e, a.setStyles({
    height: r.height + "px",
    webkitTransform: "translate3d(0," + (s.offsetTop + o.scroller.iScroll.y) + "px,0)"
  }), t = i.x, n = r.width / 2, e.setSwipeMinimum(n));
});
e.on("slide", function (e) {
  o._slideLock || (i = e.x - t, i > n ? i = n : i < -n && (i = -n), a.setStyle("opacity", Math.abs(i) / n), this.setStyle("webkitTransform", "translate3d(" + i + "px,0,0)"));
});
e.slideBack = function (t) {
  a.rowId = null;
  w.tween(e, {
    webkitTransform: "translate3d(0,0,0)"
  }, {
    time: 100,
    easing: "ease-out"
  }, function () {
    if (a.setStyle("opacity", 0), a.delClassNames("spinner", a.side), t) {
      return t();
    }
  });
};
e.on("slideEnd", function (t, i) {
  o._slideLock || (t ? i > 0 ? (a.side = "left", a.addClassNames("spinner", "left"), o.emit("rowSlidedLeft", e, e.rowContent)) : (a.side = "right", a.addClassNames("spinner", "right"), o.emit("rowSlidedRight", e, e.rowContent)) : e.slideBack());
});
a.rowId = null;
w.tween(e, {
  webkitTransform: "translate3d(0,0,0)"
}, {
  time: 100,
  easing: "ease-out"
}, function () {
  if (a.setStyle("opacity", 0), a.delClassNames("spinner", a.side), t) {
    return t();
  }
});
this._slidable && this._addSlideBehavior(o);
i && o.setStyle("webkitTransform", "translate3d(100%,0,0)");
o.rowId = t;
o.rowContent = e;
o.myTable = this;
o[r.id] = o.createChild("div", {
  className: ["col", r.id]
});
d(o, r);
n++;
w.tween(s, {
  webkitTransform: "translate3d(0,0,0)"
}, {
  time: T,
  easing: "ease-out",
  delay: r
});
a = this._createRow(e[s], void 0, t);
t && (l[a.rowId] = a);
this.sort();
this.scroller.appendChild(this.rows);
this.scroller.refresh();
t && this._playAnimationForNewRows(l);
this.sort();
this.scroller.appendChild(this.rows);
this.scroller.refresh();
t && this._playAnimationForNewRows(i);
o._delRow(e);
o._updateRowColor();
o.scroller.refresh();
o._updateRowColor();
o.scroller.refresh();
i && i.call(o);
this.rows.clearContent();
this._selectedRow = null;
this.scroller.refresh();
this.element = e;
this.isAddingClasses = t;
this.locks = {};
e.exports = i;
i.prototype.addSpinner = function (e) {
  var t = this.locks[e];
  return t ? console.warn("Spinner already set for " + e) : (this.locks[e] = !0, this.element.addClassNames("spinner"), void (this.isAddingClasses && this.element.addClassNames(e)));
};
i.prototype.removeSpinner = function (e) {
  var t = this.locks[e];
  if (t) {
    this.locks[e] = !1;
    this.isAddingClasses && this.element.delClassNames(e);
    for (var i in this.locks) {
      if (this.locks[i]) {
        return;
      }
    }
    this.element.delClassNames("spinner");
  }
};
i.prototype.clearSpinner = function () {
  for (var e in this.locks) {
    this.locks[e] && this.removeSpinner(e);
  }
  this.locks = {};
};
i.prototype.isActive = function () {
  for (var e in this.locks) {
    if (this.locks[e]) {
      return !0;
    }
  }
  return !1;
};
this.locks[e] = !1;
this.isAddingClasses && this.element.delClassNames(e);
b.call(this, "div", {
  className: "MountDetails"
});
this.mountData = {};
this.boostMap = {
  1: {
    property: "energy",
    update: this._setEnergy
  },
  2: {
    property: "serenity",
    update: this._setSerenity
  },
  3: {
    property: "stamina",
    update: this._setStamina
  },
  4: {
    property: "love",
    update: this._setLove
  },
  5: {
    property: "maturity",
    update: this._setMaturity
  },
  6: {
    property: "boostLimiter",
    update: this._setTiredness
  }
};
this._givenXP = 0;
this._name = "";
this.shouldResetTab = !0;
this.hasDomAndListeners = !1;
this.on("destroy", function () {
  this.hasDomAndListeners && (this._setEventListeners(!1), this.hasDomAndListeners = !1);
});
u(n, b);
e.exports = n;
n.EFFECT_MOUNT = 995;
n.EFFECT_INVALID_CERTIF = 994;
n.isItemInstanceWithMountInfo = function (e) {
  return !!e.effectsMap[n.EFFECT_MOUNT];
};
n.getMountInfoFromCertificate = function (e) {
  return e.effectsMap[n.EFFECT_MOUNT];
};
n.prototype.getIllustrationElement = function () {
  return this.hasDomAndListeners || this._setupDomAndListeners(), this._mountIllus;
};
n.prototype._createProgressBar = function (e, t, i, n) {
  var o = d("ui.common.colon"),
    a = e.createChild("div", {
      className: t
    });
  return a.createChild("div", {
    className: "label",
    text: i + o
  }), a.appendChild(new f({
    className: ["mountBar", n],
    tooltip: !0,
    longTapExplanation: !0,
    tooltipText: i
  }));
};
n.prototype._getActionOnMount = function (e) {
  var t = this.mountData.mountLocation;
  return t ? l[this.mountData.mountLocation][e] : null;
};
n.prototype._exchangeAction = function (e) {
  var t = this._getActionOnMount(e);
  if (!t) {
    return console.error(new Error("Invalid action " + e));
  }
  var i = this;
  window.dofus.sendMessage("ExchangeHandleMountStableMessage", {
    actionType: t,
    rideId: i.mountData.id
  });
};
n.prototype._setSex = function (e) {
  e ? this._sexIcon.replaceClassNames(["male"], ["female"]) : this._sexIcon.replaceClassNames(["female"], ["male"]);
};
n.prototype._setupDomAndListeners = function () {
  this.mustResize = !0;
  this._createMinMaxBox();
  this._createMainInformation();
  this._createPanels();
  this._createButtons();
  this._setEventListeners(!0);
  this.hasDomAndListeners = !0;
};
n.prototype._createMainInformation = function () {
  var e = this,
    t = this.createChild("div", {
      className: "mainContainer"
    }),
    i = t.createChild("div", {
      className: "mainInfosTop"
    }),
    n = i.createChild("div", {
      className: "leftColumn"
    });
  this._mountIllus = n.createChild("div", {
    className: "mountIllus"
  });
  this._sexIcon = this._mountIllus.createChild("div", {
    className: "sexIcon"
  });
  y.addTooltip(this._mountIllus, o, {
    longTapExplanation: !0
  });
  var a = i.createChild("div", {
    className: "rightColumn"
  });
  this._mountName = a.createChild("div", {
    className: "mountName"
  });
  this._renameButton = a.appendChild(new s({
    className: ["simpleButton", "tinyBtn", "renameBtn"],
    tooltip: d("ui.mount.renameTooltip")
  }, function () {
    w.open("mountRename", {
      name: e.mountData.name,
      mountId: e.mountData.id,
      inputBox: e._mountName
    });
  }));
  var r = a.createChild("div", {
    className: "typeAndLevel"
  });
  this._mountType = r.appendChild(new m());
  this._level = r.createChild("div", {
    className: "level"
  });
  var l = t.createChild("div", {
      className: "mainInfosBottom"
    }),
    c = this.abilityDiv = l.createChild("div", {
      className: "abilityDiv"
    });
  this.abilities = [];
  for (var u = 0; u < I; u++) {
    var h = this.abilities[u] = c.createChild("div", {
      className: "ability"
    });
    y.addTooltip(h, o, {
      longTapExplanation: !0
    });
  }
  var p = l.createChild("div", {
    className: "statusIcons"
  });
  this.fertileIcon = p.appendChild(new _("fertile", {
    tooltip: ""
  }));
  this.domesticIcon = p.appendChild(new _("domestic", {
    tooltip: d("tablet.mount.domestic")
  }));
  this.mountableIcon = p.appendChild(new _("mountable", {
    tooltip: d("ui.common.mountable")
  }));
  this._rideButtonDiv = p.createChild("div", {
    className: "rideBtnDiv"
  });
  this._rideButton = this._rideButtonDiv.appendChild(new s({
    className: ["greenButton", "rideButton"],
    addIcon: !0,
    tooltip: d("ui.mount.rideTooltip")
  }, function () {
    window.dofus.sendMessage("MountToggleRidingRequestMessage");
  }));
};
n.prototype._createPanels = function () {
  var e = this._tabs = this.appendChild(new v({
    className: "tabs"
  }));
  e.addTab(d("tablet.mount.breeding"), this._createBreedingPanel());
  e.addTab(d("ui.common.short.caracteristic"), this._createStatPanel());
};
n.prototype._createBreedingPanel = function () {
  var e = new b("div", {
      className: "panel"
    }),
    t = e.createChild("div", {
      className: "breedingPanel"
    }),
    i = d("ui.common.colon");
  this._tirednessValue = this._createProgressBar(t, ["progressBar2col", "tired"], d("ui.common.tire"), "orange");
  var n = t.createChild("div", {
    className: "iconGaugeBar"
  });
  this._staminaGauge = n.appendChild(new c("stamina", d("ui.common.stamina")));
  this._maturityGauge = n.appendChild(new c("maturity", d("ui.common.maturity")));
  this._loveGauge = n.appendChild(new c("love", d("ui.common.love")));
  this._serenityGauge = t.appendChild(new g());
  var o = this._fertilityDiv = t.createChild("div", {
    className: ["textInfo", "mating"]
  });
  return o.createChild("div", {
    className: "label",
    text: d("ui.common.reproductions") + i
  }), this._fertilityValue = o.createChild("div", {
    className: "value"
  }), this._fecondationState = t.createChild("div", {
    className: "fecondationState"
  }), e;
};
n.prototype._createStatPanel = function () {
  var e = new b("div", {
      className: "panel"
    }),
    t = e.createChild("div", {
      className: "statPanel"
    });
  return this._energyGauge = t.appendChild(new c("energy", d("ui.common.energy"), {
    size: M
  })), this._experienceValue = this._createProgressBar(t, ["progressBar2col", "xp"], d("ui.common.experiment"), "blue"), this._createGivenXp(t), t.createChild("div", {
    className: "effectLabel",
    text: d("ui.effects")
  }), this._effectsContent = t.createChild("div", {
    className: "effectsContent"
  }), e;
};
n.prototype._createGivenXp = function (e) {
  var t = this,
    i = this._givenXpDiv = e.createChild("div", {
      className: "givenXp"
    }),
    n = d("ui.common.giveXP") + d("ui.common.colon");
  i.createChild("div", {
    className: "label",
    text: n
  });
  var o = i.createChild("div", {
    className: "valueAndButton"
  });
  this._xpValue = o.createChild("div", {
    className: "value"
  });
  o.appendChild(new s({
    className: ["simpleButton", "tinyBtn", "xpButton"],
    tooltip: d("ui.mount.xpPercentTooltip")
  }, function () {
    t.minMaxSelector.open({
      min: 0,
      max: 90,
      defaultValue: t._givenXP
    });
  }));
};
n.prototype._feedMount = function () {
  var e = w.getWindow("feed");
  if (!e.feedingBox.possessFeedItemForMount()) {
    return window.gui.openSimplePopup(d("ui.item.errorNoFoodMount"));
  }
  var t;
  t = "shed" === this.mountData.mountLocation ? p.LOCATION_STABLED : p.LOCATION_EQUIPED;
  w.open("feed", {
    mode: "mount",
    mountUid: this.mountData.id,
    mountLocation: t
  });
};
n.prototype._neuterMount = function () {
  var e = this;
  window.gui.openConfirmPopup({
    title: d("ui.popup.warning"),
    message: d("ui.mount.doUCastrateYourMount"),
    cb: function (t) {
      t && (e.inBreeding ? e._exchangeAction("sterilize") : window.dofus.sendMessage("MountSterilizeRequestMessage"));
    }
  });
};
n.prototype._releaseMount = function () {
  var e = this;
  window.gui.openConfirmPopup({
    title: d("ui.popup.warning"),
    message: d("ui.mount.doUKillYourMount"),
    cb: function (t) {
      t && (e.inBreeding ? e._exchangeAction("free") : window.dofus.sendMessage("MountReleaseRequestMessage"));
    }
  });
};
n.prototype._createButtons = function () {
  var e = this,
    t = this.createChild("div", {
      className: "buttons"
    });
  this._feedButton = t.appendChild(new s({
    className: ["simpleButton", "mountButton", "feedButton"],
    tooltip: d("ui.mount.feed")
  }, this._feedMount.bind(this)));
  this._feedButton.disable();
  this._inventoryButton = t.appendChild(new s({
    className: ["simpleButton", "mountButton", "inventoryButton"],
    tooltip: d("ui.mount.inventoryAccess")
  }, function () {
    window.dofus.sendMessage("ExchangeRequestOnMountStockMessage");
  }));
  this._genealogyButton = t.appendChild(new s({
    className: ["simpleButton", "mountButton", "genealogyButton"],
    tooltip: d("ui.mount.ancestorTooltip")
  }, function () {
    w.open("familyTree", e.mountData);
  }));
  this._cutButton = t.appendChild(new s({
    className: ["simpleButton", "mountButton", "cutButton"],
    tooltip: d("ui.mount.castrateTooltip")
  }, this._neuterMount.bind(this)));
  this._releaseButton = t.appendChild(new s({
    className: ["simpleButton", "mountButton", "releaseButton"],
    tooltip: d("ui.mount.killTooltip")
  }, this._releaseMount.bind(this)));
};
n.prototype._createMinMaxBox = function () {
  var e = this.minMaxSelector = this.appendChild(new h());
  e.setStyles({
    left: "-12px",
    top: "249px"
  });
  var t = this;
  e.on("confirm", function (e) {
    e !== t._givenXP && window.dofus.sendMessage("MountSetXpRatioRequestMessage", {
      xpRatio: e
    });
  });
};
n.prototype._processMountRenamed = function (e) {
  e.mountId === this.mountData.id && (this._setName(e.name), this.emit("renameMount", this._name));
};
n.prototype._processMountSterilized = function (e) {
  e.mountId === this.mountData.id && (this.mountData.reproductionCount = -1, this._setFertilityState());
};
n.prototype._processMountRiding = function (e) {
  var t = window.gui.playerData;
  t.equippedMount.id === this.mountData.id && this._setRideButton(e);
};
n.prototype._processMountReleased = function (e) {
  e.mountId === this.mountData.id && this.emit("freeMount", e.mountId);
};
n.prototype._processUpdateMountBoost = function (e) {
  e.rideId === this.mountData.id && this._updateBoost(e.boostToUpdateList);
};
n.prototype._setEventListeners = function (e) {
  var t = window.gui.playerData,
    i = window.dofus.connectionManager;
  e ? (this.mountRenamedHandler || (this.mountRenamedHandler = this._processMountRenamed.bind(this), this.mountSterilizedHandler = this._processMountSterilized.bind(this), this.mountReleasedHandler = this._processMountReleased.bind(this), this.updateMountBoostHandler = this._processUpdateMountBoost.bind(this), this.setRatioHandler = this._setXpRatio.bind(this), this.mountRidingHandler = this._processMountRiding.bind(this)), i.on("MountRenamedMessage", this.mountRenamedHandler), i.on("MountSterilizedMessage", this.mountSterilizedHandler), i.on("MountReleasedMessage", this.mountReleasedHandler), i.on("UpdateMountBoostMessage", this.updateMountBoostHandler), t.on("setMountRatio", this.setRatioHandler), t.on("mountRiding", this.mountRidingHandler)) : (i.removeListener("MountRenamedMessage", this.mountRenamedHandler), i.removeListener("MountSterilizedMessage", this.mountSterilizedHandler), i.removeListener("MountReleasedMessage", this.mountReleasedHandler), i.removeListener("UpdateMountBoostMessage", this.updateMountBoostHandler), t.removeListener("setMountRatio", this.setRatioHandler), t.removeListener("mountRiding", this.mountRidingHandler));
};
n.prototype._updateBoost = function (e) {
  for (var t = this.mountData, i = 0; i < e.length; i += 1) {
    var n = e[i],
      o = this.boostMap[n.type].property;
    t[o] = n.value;
    this.boostMap[n.type].update.call(this, n.value);
  }
};
n.prototype._setSpecificBehaviors = function (e) {
  if (this.abilityDiv.toggleClassName("withoutAbilities", 0 === e.length), e.length) {
    for (var t = window.gui.databases.MountBehaviors, i = 0; i < this.abilities.length; i++) {
      var n = this.abilities[i],
        o = e[i];
      o && (n.setText(t[o].nameId), n.tooltipText = t[o].descriptionId);
      n.toggleDisplay(!!o);
    }
  }
};
n.prototype._setName = function (e) {
  this._name = this.mountData.name = e;
  this._name || (this._name = d("ui.common.noName"));
  this._mountName.setText(this._name);
  var t = d(this.mountData.sex ? "ui.common.animalFemale" : "ui.common.animalMale");
  this._mountIllus.tooltipText = this._name + " (" + t + ")";
};
n.prototype.getName = function () {
  return this._name;
};
n.prototype._setXpRatio = function (e) {
  this._givenXP = e;
  this._xpValue.setText(e + "%");
};
n.prototype._setRideButton = function (e) {
  this._rideButton.toggleClassName("isRiding", !!e);
};
n.prototype._setLove = function (e) {
  this._loveGauge.setValue(e, this.mountData.loveMax);
};
n.prototype._setTiredness = function (e) {
  this._tirednessValue.setValue(e, this.mountData.boostMax);
};
n.prototype._setEnergy = function (e) {
  this._energyGauge.setValue(e, this.mountData.energyMax);
};
n.prototype._setStamina = function (e) {
  this._staminaGauge.setValue(e, this.mountData.staminaMax);
};
n.prototype._setMaturity = function (e) {
  this._maturityGauge.setValue(e, this.mountData.maturityForAdult);
};
n.prototype._setSerenity = function (e) {
  this._serenityGauge.setValue(e);
};
n.getFertilityState = function (e) {
  var t = e.reproductionCount,
    i = e.reproductionCountMax,
    n = t >= 0 && t < i,
    o = t < 0,
    a = {
      canReproduce: n,
      isNeutered: o,
      isFecondationReady: e.isFecondationReady,
      fecondationTime: e.fecondationTime
    };
  return n && (a.reproCount = t, a.reproMax = i), e.isNewborn && (a.isNewborn = !0), a;
};
n.prototype._setFertilityState = function () {
  var e = n.getFertilityState(this.mountData),
    t = !!e.canReproduce;
  t && this._fertilityValue.setText(e.reproCount + "/" + e.reproMax);
  this._fertilityDiv.toggleDisplay(t);
  this._cutButton.setEnable(t && !!this._getActionOnMount("sterilize"));
  this.fertileIcon.setFertileIcon(e, !0);
};
n.prototype._setFecondationState = function () {
  var e = this.mountData.isFecondationReady,
    t = this.mountData.fecondationTime,
    i = !e && t > -1;
  this._fecondationState.toggleDisplay(i);
  i && this._fecondationState.setText(d("ui.mount.pregnantSince", t));
};
n.prototype._setExperience = function (e, t, i) {
  i === -1 && (i = e);
  var n = (e - t) / (i - t);
  this._experienceValue.setValue(e, i, n);
};
n.prototype._resize = function () {
  return this.isVisible() && this.rootElement.clientWidth ? (this.mustResize = !1, void this._serenityGauge.resize()) : this.once("show", this._resize.bind(this));
};
n.prototype.setMount = function (e, t) {
  var i = this,
    n = window.gui.playerData;
  e = e || {};
  t = t || {};
  var o = this.inBreeding = "breeding" === t.context;
  this.hasDomAndListeners || this._setupDomAndListeners();
  this.shouldResetTab && (this.shouldResetTab = !1, this._tabs.openTab(o ? T : C));
  this.mustResize && this._resize();
  this.mountData = e;
  var s = e.mountLocation;
  s || console.error("Mount", e.id, "does not have a location.");
  this._givenXpDiv.toggleDisplay("equip" === s);
  this._setXpRatio(e.xpRatio);
  this.domesticIcon.setEnabled(!e.isWild);
  var l = "equipped" === t.context;
  this._rideButtonDiv.toggleDisplay(l);
  this.mountableIcon.toggleDisplay(!l);
  l ? (this._rideButton.setEnable(e.isRideable), this._setRideButton(n.isRiding)) : this.mountableIcon.setEnabled(e.isRideable);
  this._setName(e.name);
  this._setSpecificBehaviors(e.behaviors || []);
  this._releaseButton.setEnable(!!this._getActionOnMount("free"));
  this._renameButton.setEnable("equip" === e.mountLocation || "shed" === e.mountLocation);
  this._feedButton.setEnable(e.maturity === e.maturityForAdult && ("shed" === this.mountData.mountLocation || "equip" === this.mountData.mountLocation) && "fight" !== window.foreground.tapOptions.mode);
  this._inventoryButton.setEnable(e.maxPods > 0 && "equip" === e.mountLocation && !o);
  this._level.setText(d("ui.common.short.level") + " " + e.level);
  this._setExperience(e.experience, e.experienceForLevel, e.experienceForNextLevel);
  this._setFecondationState();
  this._setFertilityState();
  this._setSex(e.sex);
  this._setEnergy(e.energy);
  this._setLove(e.love);
  this._setTiredness(e.boostLimiter);
  this._setStamina(e.stamina);
  this._setMaturity(e.maturity);
  this._setSerenity(e.serenity);
  this._mountType.setModel(e.model);
  a.preloadImage("gfx/mounts/" + e.model + ".png", function (e) {
    i._mountIllus.setStyle("backgroundImage", e);
  });
  for (var c = 0, u = e.effectList.length; c < u; c += 1) {
    var h = e.effectList[c];
    h.effectCaller || (h.effectCaller = "mount " + e.model + " from location " + e.mountLocation);
  }
  r.createEffectInstances(e.effectList, function (e, t) {
    var n = "<ul>",
      o = "<li>" + d("ui.common.lowerNone", 0) + "</li>";
    if (e) {
      return n += o + "</ul>", i._effectsContent.setHtml(o), console.error(e);
    }
    if (t.length <= 0) {
      return n += o + "</ul>", i._effectsContent.setHtml(o);
    }
    for (var a = 0, s = t.length; a < s; a += 1) {
      var r = t[a];
      n += "<li>" + r.description + "</li>";
    }
    n += "</ul>";
    i._effectsContent.setHtml(n);
  });
};
this.mustResize = !0;
this._createMinMaxBox();
this._createMainInformation();
this._createPanels();
this._createButtons();
this._setEventListeners(!0);
this.hasDomAndListeners = !0;
this._mountIllus = n.createChild("div", {
  className: "mountIllus"
});
this._sexIcon = this._mountIllus.createChild("div", {
  className: "sexIcon"
});
y.addTooltip(this._mountIllus, o, {
  longTapExplanation: !0
});
this._mountName = a.createChild("div", {
  className: "mountName"
});
this._renameButton = a.appendChild(new s({
  className: ["simpleButton", "tinyBtn", "renameBtn"],
  tooltip: d("ui.mount.renameTooltip")
}, function () {
  w.open("mountRename", {
    name: e.mountData.name,
    mountId: e.mountData.id,
    inputBox: e._mountName
  });
}));
this._mountType = r.appendChild(new m());
this._level = r.createChild("div", {
  className: "level"
});
this.fertileIcon = p.appendChild(new _("fertile", {
  tooltip: ""
}));
this.domesticIcon = p.appendChild(new _("domestic", {
  tooltip: d("tablet.mount.domestic")
}));
this.mountableIcon = p.appendChild(new _("mountable", {
  tooltip: d("ui.common.mountable")
}));
this._rideButtonDiv = p.createChild("div", {
  className: "rideBtnDiv"
});
this._rideButton = this._rideButtonDiv.appendChild(new s({
  className: ["greenButton", "rideButton"],
  addIcon: !0,
  tooltip: d("ui.mount.rideTooltip")
}, function () {
  window.dofus.sendMessage("MountToggleRidingRequestMessage");
}));
e.addTab(d("tablet.mount.breeding"), this._createBreedingPanel());
e.addTab(d("ui.common.short.caracteristic"), this._createStatPanel());
this._staminaGauge = n.appendChild(new c("stamina", d("ui.common.stamina")));
this._maturityGauge = n.appendChild(new c("maturity", d("ui.common.maturity")));
this._loveGauge = n.appendChild(new c("love", d("ui.common.love")));
this._serenityGauge = t.appendChild(new g());
this._xpValue = o.createChild("div", {
  className: "value"
});
o.appendChild(new s({
  className: ["simpleButton", "tinyBtn", "xpButton"],
  tooltip: d("ui.mount.xpPercentTooltip")
}, function () {
  t.minMaxSelector.open({
    min: 0,
    max: 90,
    defaultValue: t._givenXP
  });
}));
t = "shed" === this.mountData.mountLocation ? p.LOCATION_STABLED : p.LOCATION_EQUIPED;
w.open("feed", {
  mode: "mount",
  mountUid: this.mountData.id,
  mountLocation: t
});
this._feedButton = t.appendChild(new s({
  className: ["simpleButton", "mountButton", "feedButton"],
  tooltip: d("ui.mount.feed")
}, this._feedMount.bind(this)));
this._feedButton.disable();
this._inventoryButton = t.appendChild(new s({
  className: ["simpleButton", "mountButton", "inventoryButton"],
  tooltip: d("ui.mount.inventoryAccess")
}, function () {
  window.dofus.sendMessage("ExchangeRequestOnMountStockMessage");
}));
this._genealogyButton = t.appendChild(new s({
  className: ["simpleButton", "mountButton", "genealogyButton"],
  tooltip: d("ui.mount.ancestorTooltip")
}, function () {
  w.open("familyTree", e.mountData);
}));
this._cutButton = t.appendChild(new s({
  className: ["simpleButton", "mountButton", "cutButton"],
  tooltip: d("ui.mount.castrateTooltip")
}, this._neuterMount.bind(this)));
this._releaseButton = t.appendChild(new s({
  className: ["simpleButton", "mountButton", "releaseButton"],
  tooltip: d("ui.mount.killTooltip")
}, this._releaseMount.bind(this)));
t[o] = n.value;
this.boostMap[n.type].update.call(this, n.value);
o && (n.setText(t[o].nameId), n.tooltipText = t[o].descriptionId);
n.toggleDisplay(!!o);
this._name = this.mountData.name = e;
this._name || (this._name = d("ui.common.noName"));
this._mountName.setText(this._name);
this._givenXP = e;
this._xpValue.setText(e + "%");
t && this._fertilityValue.setText(e.reproCount + "/" + e.reproMax);
this._fertilityDiv.toggleDisplay(t);
this._cutButton.setEnable(t && !!this._getActionOnMount("sterilize"));
this.fertileIcon.setFertileIcon(e, !0);
this._fecondationState.toggleDisplay(i);
i && this._fecondationState.setText(d("ui.mount.pregnantSince", t));
e = e || {};
t = t || {};
this.hasDomAndListeners || this._setupDomAndListeners();
this.shouldResetTab && (this.shouldResetTab = !1, this._tabs.openTab(o ? T : C));
this.mustResize && this._resize();
this.mountData = e;
s || console.error("Mount", e.id, "does not have a location.");
this._givenXpDiv.toggleDisplay("equip" === s);
this._setXpRatio(e.xpRatio);
this.domesticIcon.setEnabled(!e.isWild);
this._rideButtonDiv.toggleDisplay(l);
this.mountableIcon.toggleDisplay(!l);
l ? (this._rideButton.setEnable(e.isRideable), this._setRideButton(n.isRiding)) : this.mountableIcon.setEnabled(e.isRideable);
this._setName(e.name);
this._setSpecificBehaviors(e.behaviors || []);
this._releaseButton.setEnable(!!this._getActionOnMount("free"));
this._renameButton.setEnable("equip" === e.mountLocation || "shed" === e.mountLocation);
this._feedButton.setEnable(e.maturity === e.maturityForAdult && ("shed" === this.mountData.mountLocation || "equip" === this.mountData.mountLocation) && "fight" !== window.foreground.tapOptions.mode);
this._inventoryButton.setEnable(e.maxPods > 0 && "equip" === e.mountLocation && !o);
this._level.setText(d("ui.common.short.level") + " " + e.level);
this._setExperience(e.experience, e.experienceForLevel, e.experienceForNextLevel);
this._setFecondationState();
this._setFertilityState();
this._setSex(e.sex);
this._setEnergy(e.energy);
this._setLove(e.love);
this._setTiredness(e.boostLimiter);
this._setStamina(e.stamina);
this._setMaturity(e.maturity);
this._setSerenity(e.serenity);
this._mountType.setModel(e.model);
a.preloadImage("gfx/mounts/" + e.model + ".png", function (e) {
  i._mountIllus.setStyle("backgroundImage", e);
});
n += "</ul>";
i._effectsContent.setHtml(n);
r.call(this, "div", {
  className: ["gaugeIcon", e]
});
i = i || {};
this.name = e;
this.createChild("div", {
  className: "icon"
});
this.progressCircle = this.appendChild(new s({
  size: n,
  thickness: o,
  color: h[e],
  bgColor: u,
  tooltip: t
}));
this.valueElement = i.withoutLabel ? null : this.createChild("div", {
  className: "value",
  text: ""
});
a(n, r);
e.exports = n;
n.prototype.setValue = function (e, t, i) {
  i = i || p[this.name] || m;
  this.valueElement && this.valueElement.setText(o.intToString(e));
  var n = !t || !i || e >= t * i;
  this.toggleClassName("enabled", n);
  this.progressCircle.setValue(e, t);
};
n.prototype.setLabel = function (e) {
  this.valueElement.setText(e);
};
i = i || p[this.name] || m;
this.valueElement && this.valueElement.setText(o.intToString(e));
this.toggleClassName("enabled", n);
this.progressCircle.setValue(e, t);
e = e || {};
r.call(this, "div", {
  className: "ProgressCircle"
});
this.addClassNames(e.className);
this.size = e.size || l;
this.thickness = e.thickness || Math.round(.15 * this.size);
this.bgThickness = e.bgThickness || this.thickness + 2;
this.color = e.color || "#EEE";
this.bgColor = e.bgColor;
e.tooltip && (this.tooltipText = e.tooltip, s.addTooltip(this, this._tooltipHandler.bind(this), {
  longTapExplanation: !0
}));
this.radius = (this.size - this.bgThickness) / 2;
this.center = this.size / 2;
t.width = this.size;
t.height = this.size;
t.style.width = this.size + "px";
t.style.height = this.size + "px";
this._ctx = t.getContext("2d");
a(n, r);
e.exports = n;
n.prototype.setValue = function (e, t) {
  var i;
  t ? (this.value = e, i = e / t) : (this.value = e, i = e);
  this.maxValue = t;
  var n = this._ctx;
  this._ctx.clearRect(0, 0, n.canvas.width, n.canvas.height);
  this.bgColor && this._drawArc(this.bgThickness, this.bgColor, 1);
  this._drawArc(this.thickness, this.color, i);
};
n.prototype._drawArc = function (e, t, i) {
  i < .01 && 0 !== i && (i = .01);
  i > .99 && 1 !== i && (i = .99);
  var n = this._ctx;
  n.lineWidth = e;
  n.strokeStyle = t;
  n.beginPath();
  n.arc(this.center, this.center, this.radius, -.5 * Math.PI, (2 * i - .5) * Math.PI, !1);
  n.stroke();
};
n.prototype._tooltipHandler = function () {
  var e = this.tooltipText + o("ui.common.colon");
  return this.maxValue ? e + this.value + " / " + this.maxValue : e + this.value + "%";
};
t ? (this.value = e, i = e / t) : (this.value = e, i = e);
this.maxValue = t;
this._ctx.clearRect(0, 0, n.canvas.width, n.canvas.height);
this.bgColor && this._drawArc(this.bgThickness, this.bgColor, 1);
this._drawArc(this.thickness, this.color, i);
i < .01 && 0 !== i && (i = .01);
i > .99 && 1 !== i && (i = .99);
n.lineWidth = e;
n.strokeStyle = t;
n.beginPath();
n.arc(this.center, this.center, this.radius, -.5 * Math.PI, (2 * i - .5) * Math.PI, !1);
n.stroke();
this._hasBeenDestroyed = !1;
this.color1 = this.createChild("div", {
  className: "color"
});
this.color2 = this.createChild("div", {
  className: ["color", "color2"]
});
r.addTooltip(this, o, {
  longTapExplanation: !0
});
this.on("destroy", function () {
  e._hasBeenDestroyed = !0;
});
a(n, l);
e.exports = n;
n.ARMOURED_MOUNT_ID = 88;
n.FEATHERY_MOUNT_ID = 89;
n.ROYAL_MOUNT_ID = 90;
n.BARBARIAN_MOUNT_ID = 91;
n.NOWEL_MOUNT_ID = 99;
n.parseColorsFromLook = function (e, t) {
  if (e === n.ARMOURED_MOUNT_ID) {
    return c;
  }
  if (e === n.BARBARIAN_MOUNT_ID) {
    return d;
  }
  if (e === n.ROYAL_MOUNT_ID) {
    return u;
  }
  if (e === n.NOWEL_MOUNT_ID) {
    return h;
  }
  var i = t.split("|")[2];
  if (!i) {
    return c;
  }
  for (var o = i.split(","), a = [], s = 0; s < 3; s++) {
    var r = o[s].split("="),
      l = parseInt(r[0], 10) - 1,
      p = parseInt(r[1], 10);
    isNaN(p) ? console.error("MountType: Color is not a number for mountId: " + e + ", index: " + l) : a[l] = "#" + p.toString(16);
  }
  return a;
};
n.isSingleColor = function (e) {
  return e[0] === e[1] || e[0] === e[2];
};
n.prototype.setModel = function (e) {
  var t = this;
  s.getData("Mounts", e, function (i, o) {
    if (i) {
      return console.error("Failed loading Mounts with id=", e, "error:", i);
    }
    if (!t._hasBeenDestroyed) {
      var a = n.parseColorsFromLook(e, o.look);
      t.color1.setStyle("backgroundColor", a[0]);
      t.color2.setStyle("backgroundColor", a[1]);
      t.color2.toggleDisplay(!n.isSingleColor(a));
      t.tooltipText = o.nameId;
    }
  });
};
t.color1.setStyle("backgroundColor", a[0]);
t.color2.setStyle("backgroundColor", a[1]);
t.color2.toggleDisplay(!n.isSingleColor(a));
t.tooltipText = o.nameId;
e = e || {};
r.call(this, "div", {
  className: "ProgressBar",
  name: e.name
});
this.addClassNames(e.className);
this.barBg = this.createChild("div", {
  className: "barBg"
});
this.barFill = this.createChild("div", {
  className: "barFill"
});
this.barColor = this.barFill.createChild("div", {
  className: "barColor"
});
this.vertical = e.vertical || !1;
this.barFill.toggleClassName("vertical", this.vertical);
this.tooltipText = e.tooltipText;
e.tooltip && s.addTooltip(this, this._tooltipHandler.bind(this), {
  longTapExplanation: e.longTapExplanation
});
this.epsilon = void 0 === e.epsilon ? 5 : e.epsilon;
this.setValue(e.value || 0);
a(n, r);
e.exports = n;
n.prototype.setValue = function (e, t, i) {
  this.maxValue = t;
  t ? (this.humanValue = e, void 0 !== i ? e = i : e /= t) : this.humanValue = Math.round(100 * e);
  e *= 100;
  var n = this.epsilon;
  e < n && e > 0 && (e = n);
  e > 100 - n && e < 100 && (e = 100 - n);
  e = Math.round(e);
  var o = e ? e + "%" : "1px";
  this.barFill.setStyle("-webkit-mask-size", this.vertical ? "100% " + o : o + " 100%");
  this.barFill.setStyle("-webkit-mask-position", this.vertical ? "0 100%" : "0 0");
};
n.prototype.setRange = function (e, t) {
  var i = t - e,
    n = i ? Math.round(100 * i) + "%" : "1px",
    o = e ? Math.round(100 * e) + "%" : "1px";
  this.barFill.setStyle("-webkit-mask-size", this.vertical ? "100% " + n : n + " 100%");
  this.barFill.setStyle("-webkit-mask-position", this.vertical ? "100% " + o : o + " 100%");
};
n.prototype._tooltipHandler = function () {
  var e = this.tooltipText ? this.tooltipText + o("ui.common.colon") : "";
  return this.maxValue ? e + this.humanValue + " / " + this.maxValue : e + this.humanValue + "%";
};
this.maxValue = t;
t ? (this.humanValue = e, void 0 !== i ? e = i : e /= t) : this.humanValue = Math.round(100 * e);
e *= 100;
e < n && e > 0 && (e = n);
e > 100 - n && e < 100 && (e = 100 - n);
e = Math.round(e);
this.barFill.setStyle("-webkit-mask-size", this.vertical ? "100% " + o : o + " 100%");
this.barFill.setStyle("-webkit-mask-position", this.vertical ? "0 100%" : "0 0");
this.barFill.setStyle("-webkit-mask-size", this.vertical ? "100% " + n : n + " 100%");
this.barFill.setStyle("-webkit-mask-position", this.vertical ? "100% " + o : o + " 100%");
r.call(this, "div", {
  className: "serenityGauge"
});
e = e || {};
t && this.addClassNames("mini");
t || this.createChild("div", {
  className: ["bigIcon", "bigIcon_mad"]
});
this.zones = [];
this._createColorZone("stamina", l, c, o("ui.mount.viewerTooltipZone1"));
this._createColorZone("maturity", c, d, o("ui.mount.viewerToolTipZone2"));
this._createColorZone("love", d, u, o("ui.mount.viewerTooltipZone3"));
this._serenityBarCursor = n.createChild("div", {
  className: "cursor"
});
t || (this._serenityValue = this._serenityBarCursor.createChild("div", {
  className: "value"
}));
i.createChild("div", {
  className: "background"
});
t || this.createChild("div", {
  className: ["bigIcon", "bigIcon_happy"]
});
a(n, r);
e.exports = n;
n.SERENITY_MIN = l;
n.SERENITY_MAX = u;
n.GOOD_SERENITY_MIN = c;
n.GOOD_SERENITY_MAX = d;
n.prototype._createColorZone = function (e, t, i, n) {
  var a = this._serenityBar.createChild("div", {
    className: ["colorZone", e]
  });
  this.isMini || (a.createChild("div", {
    className: "icon"
  }), s.addTooltip(a, o("tablet.mount.serenityZoneTooltip", t, i, n), {
    longTapExplanation: !0
  }));
  a.name = e;
  a.min = t;
  a.max = i;
  this.zones.push(a);
  this._serenityBar[e] = a;
};
n.prototype.resize = function () {
  this.isMini ? (this.serenityBarWidth = h, this.serenityCursorOffset = -p / 2) : (this.serenityBarWidth = this._serenityBar.rootElement.clientWidth, this.serenityCursorOffset = -this._serenityBarCursor.rootElement.clientWidth / 2);
  for (var e = u - l, t = this._serenityBar.maturity, i = (t.max - t.min) / e * this.serenityBarWidth / 2, n = 0, o = this.zones, a = 0; a < o.length; a++) {
    var s = o[a],
      r = (s.max - s.min) / e,
      c = r * this.serenityBarWidth;
    "maturity" !== s.name && (c += i);
    "stamina" !== s.name && (n -= i);
    s.setStyle("left", n + "px");
    s.setStyle("width", c + "px");
    n += c;
  }
  this._serenityBar.maturity.setStyles({
    borderBottomLeftRadius: i + "px",
    borderTopRightRadius: i + "px"
  });
  void 0 !== this._currentSerenity && this.setValue(this._currentSerenity);
};
n.prototype.setValue = function (e) {
  if (this._currentSerenity = e, this.serenityBarWidth) {
    this.isMini || this._serenityValue.setText(e);
    var t = (e - l) / (u - l),
      i = t * this.serenityBarWidth + this.serenityCursorOffset;
    this._serenityBarCursor.setStyle("left", i + "px");
    this._serenityBar.stamina.toggleClassName("disabled", e > 0);
    this._serenityBar.maturity.toggleClassName("disabled", e < c || e > d);
    this._serenityBar.love.toggleClassName("disabled", e < 0);
  }
};
this.isMini || (a.createChild("div", {
  className: "icon"
}), s.addTooltip(a, o("tablet.mount.serenityZoneTooltip", t, i, n), {
  longTapExplanation: !0
}));
a.name = e;
a.min = t;
a.max = i;
this.zones.push(a);
this._serenityBar[e] = a;
"maturity" !== s.name && (c += i);
"stamina" !== s.name && (n -= i);
s.setStyle("left", n + "px");
s.setStyle("width", c + "px");
n += c;
this._serenityBar.maturity.setStyles({
  borderBottomLeftRadius: i + "px",
  borderTopRightRadius: i + "px"
});
void 0 !== this._currentSerenity && this.setValue(this._currentSerenity);
this._serenityBarCursor.setStyle("left", i + "px");
this._serenityBar.stamina.toggleClassName("disabled", e > 0);
this._serenityBar.maturity.toggleClassName("disabled", e < c || e > d);
this._serenityBar.love.toggleClassName("disabled", e < 0);
l.call(this, "div", {
  className: ["statusIcon", e]
});
t = t || {};
this.isEnabled = !1;
this.tooltipText = t.tooltip;
void 0 !== t.tooltip && r.addTooltip(this, o, {
  longTapExplanation: !0
});
s(n, l);
e.exports = n;
n.prototype.setEnabled = function (e) {
  this.isEnabled = e;
  this.toggleClassName("disabled", !e);
};
n.prototype.setFertileIcon = function (e, t) {
  var i = !1;
  if (e.isNewborn) {
    this.replaceClassNames(["disabled", "fertile", "pregnant", "sterile"], ["newborn"]);
    this.tooltipText = a("ui.mount.filterBorn");
  } else if (e.fecondationTime >= 0) {
    this.replaceClassNames(["disabled", "fertile", "neutered", "newborn", "sterile"], ["pregnant"]);
    this.tooltipText = a("ui.mount.pregnantSince", e.fecondationTime);
  } else if (e.canReproduce) {
    if (!e.isFecondationReady && !t) {
      return void this.hide();
    }
    this.replaceClassNames(["pregnant", "neutered", "newborn", "sterile"], ["fertile"]);
    i = !!t && !e.isFecondationReady;
    this.toggleClassName("disabled", i);
    this.tooltipText = a("ui.mount.fecondable");
  } else {
    this.replaceClassNames(["disabled", "fertile", "pregnant", "newborn"], ["sterile"]);
    var n = e.isNeutered;
    this.toggleClassName("neutered", n);
    this.tooltipText = a(n ? "ui.mount.castrated" : "ui.mount.sterilized");
  }
  this.show();
  this.isEnabled = !i;
};
this.isEnabled = e;
this.toggleClassName("disabled", !e);
this.replaceClassNames(["disabled", "fertile", "pregnant", "sterile"], ["newborn"]);
this.tooltipText = a("ui.mount.filterBorn");
this.replaceClassNames(["disabled", "fertile", "neutered", "newborn", "sterile"], ["pregnant"]);
this.tooltipText = a("ui.mount.pregnantSince", e.fecondationTime);
this.replaceClassNames(["pregnant", "neutered", "newborn", "sterile"], ["fertile"]);
i = !!t && !e.isFecondationReady;
this.toggleClassName("disabled", i);
this.tooltipText = a("ui.mount.fecondable");
this.toggleClassName("neutered", n);
this.tooltipText = a(n ? "ui.mount.castrated" : "ui.mount.sterilized");
this.show();
this.isEnabled = !i;
l.call(this, "div", {
  className: "SwipingTabs"
});
e = e || {};
e.className && this.addClassNames(e.className);
this.tabClassName = e.tabClassName || "swipeTabBtn";
this.tabList = [];
this.tabMap = {};
this.index = null;
this.currentTab = null;
this.leftTab = null;
this.rightTab = null;
this.isCyclingAllowed = !e.noCycling;
e.noHeader || (this.header = this.createChild("div", {
  className: "swipeHeader"
}));
this.content = this.createChild("div", {
  className: "swipeContent"
});
this.tabContainer = this.content.createChild("div", {
  className: "tabContainer"
});
s(this.content);
this.setSwipeDirection(e.direction || "horizontal");
this.tabContainer.on("tweenCancelled", function () {
  o = !0;
});
this.content.on("slideStart", function (e) {
  o && (o = !0, n._positionTabs());
  i = e[n._axis];
  n.tabContainer.setStyle("webkitTransition", "");
  n.currentTab.content.emit("slideStart");
  n.emit("slideStart");
});
this.content.on("slideCancel", function () {
  n.currentTab.content.emit("slideEnd");
  n.emit("slideEnd");
  n.tabContainer.setStyles({
    webkitTransform: "translate" + n._axis + "(0)",
    webkitTransition: "-webkit-transform 200ms ease-out"
  });
});
this.content.on("slide", function (e) {
  this.slideOut || (t = i - e[n._axis], (t > 0 && !n._canRightSlide || t < 0 && !n._canLeftSlide) && (t = 0, i = e[n._axis]), n.tabContainer.setStyle("webkitTransform", "translate" + n._axis + "(" + -t + "px)"));
});
this.content.on("slideEnd", function (e) {
  if (n.currentTab.content.emit("slideEnd"), n.emit("slideEnd"), e) {
    var i = n.index;
    t > 0 && n._canRightSlide && (i = n.rightTab.index);
    t < 0 && n._canLeftSlide && (i = n.leftTab.index);
    n._openTabWithTransition(i);
  } else {
    n.tabContainer.setStyles({
      webkitTransform: "translate" + n._axis + "(0)",
      webkitTransition: "-webkit-transform 200ms ease-out"
    });
  }
});
o && (o = !0, n._positionTabs());
i = e[n._axis];
n.tabContainer.setStyle("webkitTransition", "");
n.currentTab.content.emit("slideStart");
n.emit("slideStart");
n.currentTab.content.emit("slideEnd");
n.emit("slideEnd");
n.tabContainer.setStyles({
  webkitTransform: "translate" + n._axis + "(0)",
  webkitTransition: "-webkit-transform 200ms ease-out"
});
t > 0 && n._canRightSlide && (i = n.rightTab.index);
t < 0 && n._canLeftSlide && (i = n.leftTab.index);
n._openTabWithTransition(i);
a(n, l);
n.prototype.setSwipeDirection = function (e) {
  this._direction = e;
  this.content.setSlideDirection(e);
  this._axis = "vertical" === e ? "y" : "x";
  null !== this.index && this._positionTabs();
};
n.prototype.addTab = function (e, t, i) {
  var n = this,
    a = this.tabList.length;
  t.addClassNames("swipeTabContent");
  var s = this.tabMap[i] = {
    id: i,
    index: this.tabList.length,
    content: t,
    position: 0,
    enable: !0
  };
  return this.header && (s.tabBtn = this.header.appendChild(new o({
    className: this.tabClassName,
    text: e
  }, function () {
    n.openTab(a);
  })), s.tabBtn.addClassNames("tab" + a)), this.tabList.push(s), this.tabContainer.appendChild(t), t.hide(), a;
};
n.prototype.getTabContent = function (e) {
  var t = isNaN(e) ? this.tabMap[e] : this.tabList[e];
  return t && t.content;
};
n.prototype.swipeNegative = function () {
  this.leftTab && this._openTabWithTransition(this.leftTab.index);
};
n.prototype.swipePositive = function () {
  this.rightTab && this._openTabWithTransition(this.rightTab.index);
};
n.prototype._openTabWithTransition = function (e, t) {
  var i = this.tabList[e],
    n = this.tabList[this.index];
  this.header && n.tabBtn.delClassNames("on");
  n.content.emit("close");
  i.content.emit("open", t);
  var o = this;
  r.tween(this.tabContainer, {
    webkitTransform: "translate" + this._axis + "(" + -i.position + "%)"
  }, {
    time: 200,
    easing: "ease-out"
  }, function () {
    o._positionTabs();
    i.content.emit("opened", t);
    o.emit("openTab", i.id);
  });
  this.index = i.index;
  this.header && i.tabBtn.addClassNames("on");
};
n.prototype.reopen = function () {
  var e = this.tabList[0];
  this.index = e.index;
  this.leftTab = null;
  this.rightTab = null;
  for (var t = this._getNextAvailableRightTab(), i = this._getNextAvailableLeftTab(), n = 0; n < this.tabList.length; n++) {
    var o = this.tabList[n],
      a = o === e || o === i || o === t;
    o.content.toggleDisplay(a);
  }
  this._positionTabs();
};
n.prototype.openTab = function (e, t, i) {
  i = i || {};
  var n = isNaN(e) ? this.tabMap[e] : this.tabList[e];
  if (n && (i.forceOpen || this.index !== n.index)) {
    if (null !== this.index) {
      if (n === this.leftTab || n === this.rightTab) {
        return this._openTabWithTransition(n.index, t);
      }
      var o = this.tabList[this.index];
      this.header && o.tabBtn.delClassNames("on");
      o.content.emit("close");
      o.content.hide();
    }
    n.content.emit("open", t);
    this.index = n.index;
    this.header && n.tabBtn.addClassNames("on");
    n.content.show();
    this._positionTabs();
    n.content.emit("opened", t);
    this.emit("openTab", n.id);
  }
};
n.prototype.close = function () {
  this.tabList[this.index].content.emit("close");
};
n.prototype._getNextAvailableRightTab = function () {
  var e, t, i;
  for (e = this.index + 1, t = this.tabList.length; e < t; e += 1) {
    if (i = this.tabList[e], i.enable) {
      return i;
    }
  }
  if (!this.isCyclingAllowed) {
    return null;
  }
  for (e = 0, t = this.index; e < t; e += 1) {
    if (i = this.tabList[e], i.enable) {
      return i;
    }
  }
  return null;
};
n.prototype._getNextAvailableLeftTab = function () {
  var e, t;
  for (e = this.index - 1; e >= 0; e -= 1) {
    if (t = this.tabList[e], t.enable) {
      return t;
    }
  }
  if (!this.isCyclingAllowed) {
    return null;
  }
  for (e = this.tabList.length - 1; e > this.index; e -= 1) {
    if (t = this.tabList[e], t.enable) {
      return t;
    }
  }
  return null;
};
n.prototype._positionTabs = function () {
  var e = this.currentTab = this.tabList[this.index];
  e.content.setStyle("webkitTransform", "translate" + this._axis + "(0)");
  e.position = 0;
  this.tabContainer.setStyles({
    webkitTransform: "translate" + this._axis + "(0)",
    webkitTransition: ""
  });
  this.leftTab && this.leftTab !== e && this.leftTab.content.hide();
  this.rightTab && this.rightTab !== e && this.rightTab.content.hide();
  this.leftTab = this.rightTab = null;
  var t = this._getNextAvailableRightTab(),
    i = this._getNextAvailableLeftTab();
  t && t === i ? this.index < i.index ? (this._canRightSlide = !0, this._canLeftSlide = !1, this.rightTab = t, t.position = 100, t.content.show(), t.content.setStyle("webkitTransform", "translate" + this._axis + "(100%)")) : (this._canRightSlide = !1, this._canLeftSlide = !0, this.leftTab = i, i.position = -100, i.content.show(), i.content.setStyle("webkitTransform", "translate" + this._axis + "(-100%)")) : (t ? (this._canRightSlide = !0, this.rightTab = t, t.position = 100, t.content.show(), t.content.setStyle("webkitTransform", "translate" + this._axis + "(100%)")) : this._canRightSlide = !1, i ? (this._canLeftSlide = !0, this.leftTab = i, i.position = -100, i.content.show(), i.content.setStyle("webkitTransform", "translate" + this._axis + "(-100%)")) : this._canLeftSlide = !1);
};
n.prototype.toggleTabAvailability = function (e, t) {
  var i = isNaN(e) ? this.tabMap[e] : this.tabList[e];
  i && (arguments.length < 2 && (console.error(new Error("toggleTabAvailability missing param")), t = !i.enable), t = !!t, t !== i.enable && (i.enable = t, this.header && (t ? i.tabBtn.enable() : i.tabBtn.disable()), null !== this.index && this._positionTabs()));
};
n.prototype.toggleTabNotification = function (e, t) {
  var i = isNaN(e) ? this.tabMap[e] : this.tabList[e];
  i && this.header && i.tabBtn.toggleClassName("notification", t);
};
e.exports = n;
this._direction = e;
this.content.setSlideDirection(e);
this._axis = "vertical" === e ? "y" : "x";
null !== this.index && this._positionTabs();
this.header && n.tabBtn.delClassNames("on");
n.content.emit("close");
i.content.emit("open", t);
r.tween(this.tabContainer, {
  webkitTransform: "translate" + this._axis + "(" + -i.position + "%)"
}, {
  time: 200,
  easing: "ease-out"
}, function () {
  o._positionTabs();
  i.content.emit("opened", t);
  o.emit("openTab", i.id);
});
this.index = i.index;
this.header && i.tabBtn.addClassNames("on");
o._positionTabs();
i.content.emit("opened", t);
o.emit("openTab", i.id);
this.index = e.index;
this.leftTab = null;
this.rightTab = null;
this.header && o.tabBtn.delClassNames("on");
o.content.emit("close");
o.content.hide();
n.content.emit("open", t);
this.index = n.index;
this.header && n.tabBtn.addClassNames("on");
n.content.show();
this._positionTabs();
n.content.emit("opened", t);
this.emit("openTab", n.id);
e.content.setStyle("webkitTransform", "translate" + this._axis + "(0)");
e.position = 0;
this.tabContainer.setStyles({
  webkitTransform: "translate" + this._axis + "(0)",
  webkitTransition: ""
});
this.leftTab && this.leftTab !== e && this.leftTab.content.hide();
this.rightTab && this.rightTab !== e && this.rightTab.content.hide();
this.leftTab = this.rightTab = null;
this.worldMapTooltip = new l();
this.once("open", function () {
  this.header.setText(s("ui.cartography.title"));
  var a = r.getWindow("worldMap"),
    l = window.gui.GPS;
  this.worldMapTooltip.addClassNames("worldMapTooltip");
  this.entryList.appendChild(this.worldMapTooltip);
  this._addSeparator();
  e = this._addEntry(s("ui.common.teleport"), function () {
    window.dofus.sendMessage("AdminQuietCommandMessage", {
      content: "move * " + h.i + "," + h.j
    });
    a.isFullScreen && r.close("worldMap");
  });
  o = this._addEntry(s("ui.map.flag"), function () {
    var e = "",
      t = h.icons;
    if (t) {
      for (var i = 0, n = t.length; i < n; i += 1) {
        var o = t[i];
        o.infoData.isHintFromDB && (e += o.infoData.nameIdOverRideFunc ? o.infoData.nameIdOverRideFunc() : o.infoData.nameId.replace("\\n ", "\n"), e += "\n");
      }
      "" !== e && (e += "\n");
    }
    l.addCustomFlag(h.i, h.j, e);
  });
  d = this._addEntry(s("ui.common.remove"), function () {
    l.removeCustomFlag(h.i, h.j);
  });
  t = this._addEntry(s("ui.common.remove") + " [" + s("ui.zaap.zaap") + "]", function () {
    l.removePOI(this.flagId);
  });
  i = this._addEntry(s("ui.common.remove") + " [" + s("ui.common.quests") + "]", function () {
    l.removePOI(this.flagId, void 0, !0);
  });
  n = this._addEntry(s("ui.common.remove") + " [" + s("ui.map.flagDefaultName") + "]", function () {
    l.removePOI(this.flagId);
  });
  u = this._addEntry(s("ui.common.remove") + " [" + s("tablet.ui.map.estate") + "]", function () {
    l.removePOI(this.flagId);
  });
  this._addCancel();
});
this.on("open", function (a, s) {
  h = a;
  o.show();
  d.hide();
  i.hide();
  t.hide();
  n.hide();
  u.hide();
  var r = a.icons;
  if (r) {
    for (var l = 0, p = r.length; l < p; l += 1) {
      var m = r[l];
      "customFlag" === m.categoryId ? (d.show(), o.hide()) : "questObjective" === m.categoryId ? (i.flagId = m.id, i.show()) : "zaap" === m.categoryId ? (t.flagId = m.id, t.show()) : "hint" === m.categoryId ? (n.flagId = m.id, n.show()) : "estate" === m.categoryId && (u.flagId = m.id, u.show());
    }
  }
  var f = window.gui.playerData.hasRight(c.SHOW_ADMIN_CONSOLE_BUTTON);
  e.toggleDisplay(window.gui.playerData.isModeratorOrMore() || f);
  s();
});
this.worldMapTooltip.addClassNames("worldMapTooltip");
this.entryList.appendChild(this.worldMapTooltip);
this._addSeparator();
e = this._addEntry(s("ui.common.teleport"), function () {
  window.dofus.sendMessage("AdminQuietCommandMessage", {
    content: "move * " + h.i + "," + h.j
  });
  a.isFullScreen && r.close("worldMap");
});
o = this._addEntry(s("ui.map.flag"), function () {
  var e = "",
    t = h.icons;
  if (t) {
    for (var i = 0, n = t.length; i < n; i += 1) {
      var o = t[i];
      o.infoData.isHintFromDB && (e += o.infoData.nameIdOverRideFunc ? o.infoData.nameIdOverRideFunc() : o.infoData.nameId.replace("\\n ", "\n"), e += "\n");
    }
    "" !== e && (e += "\n");
  }
  l.addCustomFlag(h.i, h.j, e);
});
d = this._addEntry(s("ui.common.remove"), function () {
  l.removeCustomFlag(h.i, h.j);
});
t = this._addEntry(s("ui.common.remove") + " [" + s("ui.zaap.zaap") + "]", function () {
  l.removePOI(this.flagId);
});
i = this._addEntry(s("ui.common.remove") + " [" + s("ui.common.quests") + "]", function () {
  l.removePOI(this.flagId, void 0, !0);
});
n = this._addEntry(s("ui.common.remove") + " [" + s("ui.map.flagDefaultName") + "]", function () {
  l.removePOI(this.flagId);
});
u = this._addEntry(s("ui.common.remove") + " [" + s("tablet.ui.map.estate") + "]", function () {
  l.removePOI(this.flagId);
});
this._addCancel();
window.dofus.sendMessage("AdminQuietCommandMessage", {
  content: "move * " + h.i + "," + h.j
});
a.isFullScreen && r.close("worldMap");
h = a;
o.show();
d.hide();
i.hide();
t.hide();
n.hide();
u.hide();
e.toggleDisplay(window.gui.playerData.isModeratorOrMore() || f);
s();
o(n, a);
e.exports = n;
l.call(this, "div", {
  className: "WorldMapIcon"
});
this.iconData = e;
a.rootElement.width = o;
a.rootElement.height = n;
a.setStyle("minWidth", o + "px");
l.call(this, "div", {
  className: "WorldMapTooltip"
});
this.coordinates = this.createChild("div");
this.subAreaName = this.createChild("div");
this.uniqueDrops = this.createChild("div");
this.subArea = this.createChild("div", {
  className: "subArea"
});
this.level = this.subArea.createChild("div");
this.alliance = this.subArea.createChild("div", {
  className: "alliance"
});
this.allianceEmblem = this.alliance.appendChild(new a({
  width: 28,
  height: 28
}));
this.allianceName = this.alliance.createChild("div");
this.icons = this.createChild("div", {
  className: "icons"
});
r(n, l);
r(o, l);
e.exports = o;
o.prototype.setCoordinates = function (e, t) {
  this.coordinates.setText(s("ui.common.coordinatesSmall") + " " + e + "," + t);
};
o.prototype.displayIcons = function () {
  for (var e = this.icons.getChildren(), t = !0, i = 0; i < e.length; i++) {
    var n = e[i],
      o = !n.iconData.infoData.groupCriterion || n.iconData.visible;
    n.toggleDisplay(o);
    o && (t = !1);
  }
  this.icons.toggleDisplay(!t);
  this.subArea.toggleDisplay(t);
};
o.prototype.setIcons = function (e, t) {
  this._icons = e;
  this.icons.clearContent();
  for (var i = 0, o = e.length; i < o; i += 1) {
    this.icons.appendChild(new n(e[i], t));
  }
};
o.prototype.unsetAlliance = function () {
  this.alliance.hide();
};
o.prototype.setAlliance = function (e) {
  this.allianceName.setText(e.allianceName + " [" + e.allianceTag + "]");
  this.allianceEmblem.setValue(e.allianceEmblem, !0);
  this.alliance.show();
};
o.prototype.unsetSubArea = function () {
  this.subAreaName.hide();
};
o.prototype.displayCoordinates = function () {
  this.subAreaName.hide();
  this.icons.hide();
  this.subArea.hide();
};
o.prototype.setSubArea = function (e) {
  var t = this;
  this.subAreaName.setText(e.nameId);
  this.level.setText(s("ui.common.averageLevel") + " " + e.level);
  this.subAreaName.show();
  this.uniqueDrops.hide();
  c.getLWUniqueDropsTextBySubArea(e.id, function (e, i) {
    return e ? console.error(e) : void ("" !== i && (t.uniqueDrops.setText(s("ui.legendaryWeapon.possibleDrop", i)), t.uniqueDrops.show()));
  });
};
o.prototype.displaySubArea = function () {
  this.icons.hide();
  this.subArea.show();
};
n.toggleDisplay(o);
o && (t = !1);
this.icons.toggleDisplay(!t);
this.subArea.toggleDisplay(t);
this._icons = e;
this.icons.clearContent();
this.allianceName.setText(e.allianceName + " [" + e.allianceTag + "]");
this.allianceEmblem.setValue(e.allianceEmblem, !0);
this.alliance.show();
this.subAreaName.hide();
this.icons.hide();
this.subArea.hide();
this.subAreaName.setText(e.nameId);
this.level.setText(s("ui.common.averageLevel") + " " + e.level);
this.subAreaName.show();
this.uniqueDrops.hide();
c.getLWUniqueDropsTextBySubArea(e.id, function (e, i) {
  return e ? console.error(e) : void ("" !== i && (t.uniqueDrops.setText(s("ui.legendaryWeapon.possibleDrop", i)), t.uniqueDrops.show()));
});
this.icons.hide();
this.subArea.show();
t.getUniqueDrops = function (e) {
  return r ? e(null, l) : n(function (t) {
    return e(t, l);
  });
};
t.getLWUniqueDrops = function (e) {
  return r ? e(null, c) : n(function (t) {
    return e(t, c);
  });
};
t.getLWUniqueDropsTextBySubArea = function (e, i) {
  t.getLWUniqueDrops(function (t, n) {
    if (t) {
      return i(t);
    }
    for (var o = "", a = 0; a < n.length; a++) {
      var s = n[a];
      if (s.criterions.isRespected({
        subAreaId: e
      })) {
        o = s.itemName;
        break;
      }
    }
    return i(null, o);
  });
};
t.initialize = function () {
  r = !1;
  l = {};
  c = [];
};
r = !1;
l = {};
c = [];
n = n || {};
z.indexOf(e) === -1 && z.push(e);
G.push(i);
W.push(new RegExp(t));
U.push(n);
S(a);
a.on("tap", l[1]);
l(F, "\\{player,([^,]+),([0-9]+)(?:,channel:([0-9]+))?\\}", function (e) {
  var t = e[1];
  return d(e[0], t, function () {
    var i = e[2],
      n = e[3];
    window.gui.openContextualMenu("player", {
      playerId: i,
      playerName: t,
      channel: n,
      isInteractiveRequired: !0
    });
  });
});
l(F, "\\{item,([0-9]+),([0-9]+)\\}", function (e) {
  return f({
    objectGID: parseInt(e[1], 10),
    objectUID: parseInt(e[2], 10)
  });
});
c(F, "\\{itemStats,([0-9]+),([0-9]+)\\}", function (e, t) {
  var i = parseInt(e[2], 10);
  return f({
    objectGID: parseInt(e[1], 10),
    objectUID: i,
    objectItem: t.objectItems ? g(t.objectItems, i) : null
  });
});
c(F, "\\{recipe,([0-9]+)\\}", function (e) {
  return h("Items", parseInt(e[1], 10), function (e) {
    var t = "[" + b("ui.common.recipes", 1) + b("ui.common.colon") + e.nameId + "]";
    return [t, function () {
      T.getItems([e.id], function (t, i) {
        return t ? console.error("Broken link item:", e) : void I.open("itemRecipes", {
          itemData: i[0]
        });
      });
    }];
  }, {
    className: "insertedLink"
  });
});
l(F, "\\{cell,([-0-9]+)::([^\\}]*?)(;;([0-2])|)\\}", function (e) {
  return d(e[0], e[2], function () {
    window.isoEngine.addArrowOnCell(parseInt(e[1], 10), 0, 0, void 0, P);
  }, {
    linkType: parseInt(e[4], 10) || 0
  });
});
l(F, "\\{npc,([-0-9]+)::([^\\}]*?)(;;([0-2])|)\\}", function (e) {
  return d(e[0], e[2], function () {
    window.isoEngine.addArrowOnNpc(parseInt(e[1], 10), D);
  });
});
l(F, "\\{monster,([-0-9]+)::([^\\}]*?)(;;([0-2])|)\\}", function (e) {
  return d(e[0], e[2], function () {
    window.isoEngine.addArrowOnMonster(parseInt(e[1], 10), D);
  }, {
    linkType: parseInt(e[4], 10) || 0
  });
});
l(F, "\\{element,([-0-9]+)::([^\\}]*?)(;;([0-2])|)\\}", function (e) {
  return d(e[0], e[2], function () {
    window.isoEngine.addArrowOnInteractiveElement(parseInt(e[1], 10), D);
  }, {
    linkType: parseInt(e[4], 10) || 0
  });
});
l(F, "\\{chattitle,([-0-9]+)::([^\\}]*?)(;;([0-2])|)\\}", function (e) {
  return d(e[0], e[2], p("grimoire", "ornaments", {
    titleId: e[1]
  }, {
    linkType: parseInt(e[4], 10) || 0
  }));
});
l(F, "\\{chatachievement,([-0-9]+)::([^\\}]*?)(;;([0-2])|)\\}", function (e) {
  return d(e[0], e[2], p("grimoire", "achievements", {
    achievementId: e[1]
  }), {
    linkType: parseInt(e[4], 10) || 0
  });
});
l(F, "\\{chatmonster,([-0-9]+)::([^\\}]*)\\}", function (e) {
  return h("Monsters", e[1], function (t) {
    var i = e[2] || t.nameId;
    return [i, p("grimoire", "bestiary", {
      monsterIds: [e[1]],
      label: t.nameId
    })];
  });
});
l(F, "\\{chatitem,([-0-9]+)::([^\\}]*)\\}", function (e) {
  return f({
    objectGID: parseInt(e[1], 10),
    label: e[2]
  });
});
l(F, "\\{guild,([-0-9]+)::([^\\}]*)\\}", function (e) {
  return d(e[0], e[2], function () {
    window.dofus.sendMessage("GuildFactsRequestMessage", {
      guildId: e[1]
    });
  });
});
l(F, "\\{alliance,([0-9]+)::([^\\}]*)\\}", function (e) {
  return d(e[0], e[2], function () {
    window.dofus.sendMessage("AllianceFactsRequestMessage", {
      allianceId: e[1]
    });
  });
});
l(F, "\\{pingsystem,([0-9]+),([0-9]+),([0-9]+)::([^\\}]*)\\}", function (e) {
  var t = window.gui.pingSystem,
    i = e[0],
    n = e[1],
    o = e[2] || "",
    a = e[3] || "",
    s = e[4] || "";
  return d(i, s, function () {
    t.addPingPicto(n, o, a);
  });
});
l(F, "\\{ui,([a-zA-Z_,0-9]+)::([^\\}]*?)(;;([0-2])|)\\}", function (e) {
  var t = q[e[1]];
  return t || (t = function () {
    M.pointToSpecificUi(e[1]);
  }), d(e[0], e[2], t, {
    linkType: parseInt(e[4], 10) || 0
  });
});
l(F, "\\{launchAnim,([0-9]+),([a-zA-Z_0-9]+),([0-9]),([0-1]),([0-9]+),([0-9]+)\\}", function (e) {
  return window.actorManager.playAnimationOnNpcId(parseInt(e[1], 10), {
    animationName: e[2],
    direction: parseInt(e[3], 10),
    loop: "0" !== e[4],
    delay: parseInt(e[5], 10),
    duration: parseInt(e[6], 10)
  }), u();
});
l(F, "\\{openSocial,([0-9]+),([0-9]+)::([^\\}]*?)(;;([0-2])|)\\}", function (e) {
  return d(e[0], e[3], p("social", parseInt(e[1], 10), {
    tabId: parseInt(e[2], 10)
  }), {
    linkType: parseInt(e[5], 10) || 0
  });
});
l(k, "\\$item([0-9]+)", function (e) {
  return f({
    objectGID: parseInt(e[1], 10)
  });
});
l(k, "\\$job([0-9]+)", function (e) {
  return h("Jobs", e[1], function (e) {
    return [e.nameId, p("grimoire", "jobs", {
      jobId: e.id
    })];
  });
});
l(k, "\\$quest([0-9]+)", function (e) {
  return h("Quests", e[1], function (e) {
    return [e.nameId, p("grimoire", "quests", {
      questId: e.id,
      categoryId: e.categoryId
    })];
  });
});
l(k, "\\$area([0-9]+)", function (e) {
  return h("Areas", e[1], function (e) {
    return [e.nameId, null];
  });
});
l(k, "\\$subarea([0-9]+)", function (e) {
  return h("SubAreas", e[1], function (e) {
    return [e.nameId, function () {
      I.open("worldMap", {
        subareaConquest: e.id
      });
    }];
  });
});
l(k, "\\$map([0-9]+)", function (e) {
  return h("MapPositions", e[1], function (e) {
    return [e.nameId || "[" + e.posX + "," + e.posY + "]", function () {
      window.gui.emit("CompassUpdateMessage", {
        type: w.COMPASS_TYPE_SIMPLE,
        worldX: e.posX,
        worldY: e.posY
      });
    }];
  });
});
l(F, "\\{map,(-?[0-9]+),(-?[0-9]+)::([^\\}]*?)(;;([0-2])|)\\}", function (e) {
  var t = parseInt(e[1], 10),
    i = parseInt(e[2], 10),
    n = e[3] || "[" + t + "," + i + "]";
  return d(e[0], n, function () {
    I.open("worldMap", {
      x: t,
      y: i
    });
  }, {
    linkType: parseInt(e[5], 10) || 0
  });
});
c(F, "\\{mapWithFlag,(-?[0-9]+),(-?[0-9]+),(-?[0-9]+)(;;([0-2])|)\\}", function (e, t) {
  var i = parseInt(e[1], 10),
    n = parseInt(e[2], 10),
    o = parseInt(e[3], 10),
    a = (t.cameViaChat ? 0 : parseInt(e[5], 10)) || 0,
    s = "[" + i + "," + n + "]";
  return d(e[0], s, function () {
    o === window.gui.playerData.position.worldmapId && (I.open("worldMap", {
      x: i,
      y: n
    }), window.gui.GPS.addPOI({
      id: "flag_srv" + w.COMPASS_TYPE_SIMPLE,
      x: i,
      y: n,
      categoryId: "hint",
      nameId: "(" + i + "," + n + ")",
      color: {
        r: 255,
        g: 134,
        b: 0,
        a: 1
      },
      isDestination: !1
    }));
  }, {
    className: t.cameViaChat ? "insertedLink" : null,
    linkType: a
  });
});
l(k, "\\$itemType([0-9]+)", function (e) {
  return h("ItemTypes", e[1], function (e) {
    return [e.nameId, null];
  });
});
l(k, "\\$achievement([0-9]+)", function (e) {
  return h("Achievements", e[1], function (t) {
    return [t.nameId, p("grimoire", "achievements", {
      achievementId: e[1]
    })];
  });
});
l(k, "\\$title([0-9]+)", function (e) {
  return h("Titles", e[1], function (t) {
    var i = window.gui.playerData.characterBaseInformations.sex ? t.nameFemaleId : t.nameMaleId;
    return [i, p("grimoire", "ornaments", {
      titleId: e[1]
    })];
  });
});
l(k, "\\$ornament([0-9]+)", function (e) {
  return h("Ornaments", e[1], function (t) {
    return [t.nameId, p("grimoire", "ornaments", {
      ornamentId: e[1]
    })];
  });
});
l(k, "\\$spell([0-9]+)", function (e) {
  return h("Spells", e[1], function (e) {
    return [e.nameId, null];
  });
});
l(k, "\\$spellState([0-9]+)", function (e) {
  return h("SpellStates", e[1], function (e) {
    return [e.nameId, null];
  });
});
l(k, "\\$breed([0-9]+)", function (e) {
  return h("Breeds", e[1], function (e) {
    return [e.shortNameId, null];
  });
});
l(k, "\\$emote([0-9]+)", function (e) {
  return h("Emoticons", e[1], function (e) {
    return [e.nameId, null];
  });
});
l(k, "\\$monster([0-9]+)", function (e) {
  return h("Monsters", e[1], function (t) {
    return [t.nameId, p("grimoire", "bestiary", {
      monsterIds: [e[1]],
      label: t.nameId
    })];
  });
});
l(k, "\\$monsterRace([0-9]+)", function (e) {
  return h("MonsterRaces", e[1], function (e) {
    return [e.nameId, null];
  });
});
l(k, "\\$monsterSuperRace([0-9]+)", function (e) {
  return h("MonsterSuperRaces", e[1], function (e) {
    return [e.nameId, null];
  });
});
l(k, "\\$alignment([0-9]+)", function (e) {
  return h("AlignmentSides", e[1], function (e) {
    return [e.nameId, null];
  });
});
l(k, "\\$stat([0-9]+)", function (e) {
  var t = b("ui.item.characteristics").split(",");
  return d(e[0], t[e[1]], null);
});
l(k, "\\$dungeon([0-9]+)", function (e) {
  return h("Dungeons", e[1], function (e) {
    return [e.nameId, null];
  });
});
l(k, "\\$challenge([0-9]+)", function (e) {
  return h("Challenge", e[1], function (e) {
    return [e.nameId, null, e.descriptionId];
  }, {
    tooltip: !0
  });
});
c(H, "<a href=([^>]+)>(.*?)</a>", function (e, t) {
  var i = e[1],
    n = e[2];
  return '"' !== i[0] && "'" !== i[0] || (i = i.slice(1, -1)), r(i, null, {
    html: n,
    isMsgSafe: t.isMsgSafe,
    senderId: t.senderId,
    senderName: t.senderName
  });
});
l(F, "\\{style:([a-zA-Z]+),([^\\}]*)\\}", function (e) {
  return new A("span", {
    text: e[2],
    className: e[1]
  });
});
l(F, "\\{windowTab,([a-zA-Z_,0-9]+),([a-zA-Z_,0-9]+)::([^\\}]*?)(;;([0-2])|)\\}", function (e) {
  return d(e[0], e[3], function () {
    I.open(e[1], {
      tabId: e[2]
    });
  }, {
    linkType: parseInt(e[5], 10) || 0
  });
});
l(F, "\\{icon:([a-zA-Z]+)\\}", function (e) {
  return new A("div", {
    className: ["iconInDialog", e[1]]
  });
});
l(F, "\\{window,([a-zA-Z_,0-9]+)::([^\\}]*?)(;;([0-2])|)\\}", function (e) {
  return d(e[0], e[2], function () {
    return "bidHouseShop" === e[1] ? E.openBidHouse(!1) : void I.open(e[1]);
  }, {
    linkType: parseInt(e[4], 10) || 0
  });
});
l(F, "\\{guild,([a-zA-Z_,0-9]+)::([^\\}]*?)(;;([0-2])|)\\}", function (e) {
  return d(e[0], e[2], p("social", "guild", {
    tabId: e[1]
  }), {
    linkType: parseInt(e[4], 10) || 0
  });
});
l(F, "\\{help,(-?[0-9]+),(-?[0-9]+)::([^\\}]*?)(;;([0-2])|)\\}", function (e) {
  return d(e[0], e[3], m("help", {
    part: e[1],
    subPart: e[2]
  }), {
    linkType: parseInt(e[5], 10) || 0
  });
});
p || (p = _(c));
u && (n && (u = y.decode(u, a)), r.createChild("span").setHtml(u));
r.appendChild(p);
e = h;
t.RED_CHANNEL = o;
t.isChannelSelective = function (e, t) {
  switch (e) {
    case n.CHANNEL_ALLIANCE:
    case n.CHANNEL_GUILD:
    case n.CHANNEL_PARTY:
      return !0;
    case n.PSEUDO_CHANNEL_PRIVATE:
      var i,
        o = window.gui.playerData.socialData;
      return i = "string" == typeof t ? o.searchOnlineFriendByName(t) : o.searchOnlineFriendById(t), !!i && o.isMutualFriend(i);
    default:
      return !1;
  }
};
t.isChannelSafe = function (e) {
  switch (e) {
    case o:
    case n.CHANNEL_ADMIN:
    case n.CHANNEL_ADS:
    case n.PSEUDO_CHANNEL_INFO:
    case n.PSEUDO_CHANNEL_FIGHT_LOG:
    case n.PSEUDO_CHANNEL_NPC_LOG:
      return !0;
    default:
      return !1;
  }
};
t.isHumanChannel = function (e) {
  switch (e) {
    case o:
    case n.PSEUDO_CHANNEL_INFO:
    case n.PSEUDO_CHANNEL_FIGHT_LOG:
    case n.PSEUDO_CHANNEL_NPC_LOG:
      return !1;
    default:
      return !0;
  }
};
p[0] = [[10, 10], [32, 126], [160, 255]];
p[1] = !0;
p[2] = [[512, 591]];
p[255] = [[g, g]];
p[4] = !0;
p[5] = [[1280, 1327]];
p[32] = [[8217, 8217], [8221, 8221]];
i(m, _, v);
i(m, y, w);
t.getUnsendableCharacters = function (e, t) {
  h = t && t.allPagesAllowed;
  for (var i = [], n = 0; n < e.length; n++) {
    var a = e.codePointAt(n);
    a > 65535 && n++;
    o(a) || i.push(String.fromCodePoint(a));
  }
  return i;
};
t.encode = function (e, t) {
  h = t && t.allPagesAllowed;
  for (var i = "", n = 0; n < e.length; n++) {
    var o = e[n];
    if (o.charCodeAt() > 255) {
      var r = e.substr(n, 2),
        c = r.codePointAt();
      c > 65535 && n++;
      i += a(c) ? l + c.toString(16) + l : o;
    } else {
      i += s(o) ? l + o.charCodeAt().toString(16) + l : o;
    }
  }
  return i;
};
t.decode = function (e, t) {
  h = t && t.allPagesAllowed;
  for (var i = "", a = 0; a < e.length; a++) {
    var s = e[a];
    if (s !== l) {
      var c = s.charCodeAt();
      i += o(c) ? s : "�";
    } else {
      var d = n(e, a);
      a += d.length - 1;
      i += r(d);
    }
  }
  return i;
};
a > 65535 && n++;
o(a) || i.push(String.fromCodePoint(a));
c > 65535 && n++;
i += a(c) ? l + c.toString(16) + l : o;
a += d.length - 1;
i += r(d);
t.pointHintArrowAt = n;
t.pointToChallenge = function () {
  window.gui.hintAnimationManager.playUITap(window.gui.challengeIndicator.challengeSlot, {
    animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.RIGHT_BOTTOM_POINT_TO_RIGHT,
    doubleTap: !1
  });
};
t.pointToWindowCloseButton = function (e) {
  var t = a.getWindow(e);
  t.openState && window.gui.hintAnimationManager.playUITap(t.closeButton, {
    animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_BOTTOM_POINT_TO_RIGHT,
    doubleTap: !1
  });
};
t.pointToConfirmUpgradeSpell = function () {
  var e = a.getWindow("grimoire");
  if (e) {
    var t = e.tabs.tabsMap.spells;
    t && window.gui.hintAnimationManager.playUITap(t.target.confirmButton, {
      animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_TOP_POINT_TO_RIGHT,
      doubleTap: !1
    });
  }
};
t.pointToMenuIcon = function (e) {
  var t = window.gui.menuBar.getIconForTuto(e);
  window.gui.hintAnimationManager.playUITap(t, {
    animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_TOP_POINT_TO_RIGHT,
    doubleTap: !1
  });
};
t.pointToTimelineButton = function (e) {
  var t = window.gui.timeline.fightControlButtons.getButtonForTuto(e);
  t && window.gui.hintAnimationManager.playUITap(t, {
    animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_TOP_POINT_TO_RIGHT,
    doubleTap: !1
  });
};
t.pointToFirstSkillShortcut = function () {
  var e = window.gui.shortcutBar;
  e.openPanel("spell");
  window.gui.hintAnimationManager.playUITap(e.getSlotForTuto("spell", 0), {
    animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_TOP_POINT_TO_RIGHT,
    doubleTap: !1
  });
};
t.pointToEquipFilterIcon = function () {
  var e = a.getWindow("equipment");
  e.openState && window.gui.hintAnimationManager.playUITap(e.storageView.getEquipmentFilterButtonForTuto(), {
    animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_BOTTOM_POINT_TO_RIGHT,
    doubleTap: !1
  });
};
t.pointToQuestFilterIcon = function () {
  var e = a.getWindow("equipment");
  e.openState && window.gui.hintAnimationManager.playUITap(e.storageView.getQuestFilterButtonForTuto(), {
    animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_BOTTOM_POINT_TO_RIGHT,
    doubleTap: !1
  });
};
t.pointToActionButton = function () {
  var e = a.getWindow("equipment");
  e.openState && window.gui.hintAnimationManager.playUITap(e.drawer._getItemBoxActionButton(), {
    animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_TOP_POINT_TO_RIGHT,
    doubleTap: !1
  });
};
t.pointToEntryManageShield = function () {
  var e = s.getContextMenu("item");
  e && window.gui.hintAnimationManager.playUITap(e.getEntryManageShield(), {
    animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_TOP_POINT_TO_RIGHT,
    doubleTap: !1
  });
};
t.pointToCharacterItem = function (e) {
  var t = a.getWindow("equipment");
  if (t.openState) {
    var i = t.getEquipmentSlotsForTuto();
    n(i[e], "upLeft");
  }
};
t.pointToShieldSpellSlot = function () {
  var e = a.getWindow("shieldWindow");
  e.openState && window.gui.hintAnimationManager.playUITap(e.getShieldSpellSlot(), {
    animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_BOTTOM_POINT_TO_RIGHT,
    doubleTap: !1
  });
};
t.pointToFirstArticleShopButton = function () {
  var e = a.getWindow("market");
  if (e.openState) {
    var t = e.tabs.getFirstTab();
    if (t) {
      var i = t.target.getFirstArticle();
      if (i) {
        var n = i.getButtons();
        window.gui.hintAnimationManager.playUITap(n.hardButton, {
          animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_TOP_POINT_TO_RIGHT,
          doubleTap: !1
        });
      }
    }
  }
};
t.pointToShieldValidateButton = function () {
  var e = a.getWindow("shieldWindow");
  e.openState && window.gui.hintAnimationManager.playUITap(e.feedingBox.confirmBtn, {
    animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_TOP_POINT_TO_RIGHT,
    doubleTap: !1
  });
};
t.pointToShieldStorageFirstSlotBox = function () {
  var e = a.getWindow("shieldWindow");
  e.openState && setTimeout(function () {
    window.gui.hintAnimationManager.playUITap(e.feedingBox.storageViewer.getStorageFirstSlotForTuto(), {
      animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_TOP_POINT_TO_RIGHT,
      doubleTap: !1
    });
  }, c);
};
t.pointToStorageFirstSlotBox = function (e) {
  e = e || {};
  var t = a.getWindow("equipment");
  t.openState && setTimeout(function () {
    window.gui.hintAnimationManager.playUITap(t.storageView.getStorageFirstSlotForTuto(), {
      animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_TOP_POINT_TO_RIGHT,
      doubleTap: e.doubleTap
    });
  }, c);
};
t.pointToSpecificUi = function (e) {
  if (!e) {
    return console.warn("We can not point to a null link");
  }
  for (var t = e.split(","), i = window, a = 0; a < t.length; a++) {
    var s = i[t[a]];
    if (!s) {
      i = null;
      break;
    }
    i = s;
  }
  return i && i instanceof l ? void (i.isVisible() && (n(i, "upLeft"), o(d))) : console.warn("The dom " + e + " does not exist");
};
e.openPanel("spell");
window.gui.hintAnimationManager.playUITap(e.getSlotForTuto("spell", 0), {
  animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_TOP_POINT_TO_RIGHT,
  doubleTap: !1
});
t.createHash = i(646);
t.createHmac = i(655);
t.randomBytes = function (t, i) {
  if (!i || !i.call) {
    return new e(a(t));
  }
  try {
    i.call(this, void 0, new e(a(t)));
  } catch (n) {
    i(n);
  }
};
t.getHashes = function () {
  return ["sha1", "sha256", "sha512", "md5", "rmd160"];
};
t.pbkdf2 = s.pbkdf2;
t.pbkdf2Sync = s.pbkdf2Sync;
o(["createCredentials", "createCipher", "createCipheriv", "createDecipher", "createDecipheriv", "createSign", "createVerify", "createDiffieHellman"], function (e) {
  t[e] = function () {
    n("sorry,", e, "is not implemented yet");
  };
});
i = ("" + i).toLowerCase();
o = !0;
e = (e + "").toLowerCase();
n = !0;
e[t] = e[i];
e[i] = n;
s = 2;
r /= 2;
l /= 2;
i /= 2;
d !== -1 && (c -= c - d);
d = -1;
l = e[o + 1];
128 === (192 & l) && (u = (31 & a) << 6 | 63 & l, u > 127 && (s = u));
l = e[o + 1];
c = e[o + 2];
128 === (192 & l) && 128 === (192 & c) && (u = (15 & a) << 12 | (63 & l) << 6 | 63 & c, u > 2047 && (u < 55296 || u > 57343) && (s = u));
l = e[o + 1];
c = e[o + 2];
d = e[o + 3];
128 === (192 & l) && 128 === (192 & c) && 128 === (192 & d) && (u = (15 & a) << 18 | (63 & l) << 12 | (63 & c) << 6 | 63 & d, u > 65535 && u < 1114112 && (s = u));
null === s ? (s = 65533, r = 1) : s > 65535 && (s -= 65536, n.push(s >>> 10 & 1023 | 55296), s = 56320 | 1023 & s);
n.push(s);
o += r;
(!t || t < 0) && (t = 0);
(!i || i < 0 || i > n) && (i = n);
(t -= 3) > -1 && a.push(239, 191, 189);
o = i;
i = e.charCodeAt(s);
n = i >> 8;
o = i % 256;
a.push(o);
a.push(n);
t.Buffer = e;
t.SlowBuffer = g;
t.INSPECT_MAX_BYTES = 50;
e.TYPED_ARRAY_SUPPORT = void 0 !== n.TYPED_ARRAY_SUPPORT ? n.TYPED_ARRAY_SUPPORT : o();
t.kMaxLength = a();
e.poolSize = 8192;
e._augment = function (t) {
  return t.__proto__ = e.prototype, t;
};
e.from = function (e, t, i) {
  return r(null, e, t, i);
};
e.TYPED_ARRAY_SUPPORT && (e.prototype.__proto__ = Uint8Array.prototype, e.__proto__ = Uint8Array, "undefined" != typeof Symbol && Symbol.species && e[Symbol.species] === e && Object.defineProperty(e, Symbol.species, {
  value: null,
  configurable: !0
}));
e.alloc = function (e, t, i) {
  return c(null, e, t, i);
};
e.allocUnsafe = function (e) {
  return d(null, e);
};
e.allocUnsafeSlow = function (e) {
  return d(null, e);
};
e.isBuffer = function (e) {
  return !(null == e || !e._isBuffer);
};
e.compare = function (t, i) {
  if (!e.isBuffer(t) || !e.isBuffer(i)) {
    throw new TypeError("Arguments must be Buffers");
  }
  if (t === i) {
    return 0;
  }
  for (var n = t.length, o = i.length, a = 0, s = Math.min(n, o); a < s; ++a) {
    if (t[a] !== i[a]) {
      n = t[a];
      o = i[a];
      break;
    }
  }
  return n < o ? -1 : o < n ? 1 : 0;
};
e.isEncoding = function (e) {
  switch (String(e).toLowerCase()) {
    case "hex":
    case "utf8":
    case "utf-8":
    case "ascii":
    case "latin1":
    case "binary":
    case "base64":
    case "ucs2":
    case "ucs-2":
    case "utf16le":
    case "utf-16le":
      return !0;
    default:
      return !1;
  }
};
e.concat = function (t, i) {
  if (!$(t)) {
    throw new TypeError('"list" argument must be an Array of Buffers');
  }
  if (0 === t.length) {
    return e.alloc(0);
  }
  var n;
  if (void 0 === i) {
    for (i = 0, n = 0; n < t.length; ++n) {
      i += t[n].length;
    }
  }
  var o = e.allocUnsafe(i),
    a = 0;
  for (n = 0; n < t.length; ++n) {
    var s = t[n];
    if (!e.isBuffer(s)) {
      throw new TypeError('"list" argument must be an Array of Buffers');
    }
    s.copy(o, a);
    a += s.length;
  }
  return o;
};
e.byteLength = _;
e.prototype._isBuffer = !0;
e.prototype.swap16 = function () {
  var e = this.length;
  if (e % 2 !== 0) {
    throw new RangeError("Buffer size must be a multiple of 16-bits");
  }
  for (var t = 0; t < e; t += 2) {
    y(this, t, t + 1);
  }
  return this;
};
e.prototype.swap32 = function () {
  var e = this.length;
  if (e % 4 !== 0) {
    throw new RangeError("Buffer size must be a multiple of 32-bits");
  }
  for (var t = 0; t < e; t += 4) {
    y(this, t, t + 3);
    y(this, t + 1, t + 2);
  }
  return this;
};
e.prototype.swap64 = function () {
  var e = this.length;
  if (e % 8 !== 0) {
    throw new RangeError("Buffer size must be a multiple of 64-bits");
  }
  for (var t = 0; t < e; t += 8) {
    y(this, t, t + 7);
    y(this, t + 1, t + 6);
    y(this, t + 2, t + 5);
    y(this, t + 3, t + 4);
  }
  return this;
};
e.prototype.toString = function () {
  var e = 0 | this.length;
  return 0 === e ? "" : 0 === arguments.length ? N(this, 0, e) : v.apply(this, arguments);
};
e.prototype.equals = function (t) {
  if (!e.isBuffer(t)) {
    throw new TypeError("Argument must be a Buffer");
  }
  return this === t || 0 === e.compare(this, t);
};
e.prototype.inspect = function () {
  var e = "",
    i = t.INSPECT_MAX_BYTES;
  return this.length > 0 && (e = this.toString("hex", 0, i).match(/.{2}/g).join(" "), this.length > i && (e += " ... ")), "<Buffer " + e + ">";
};
e.prototype.compare = function (t, i, n, o, a) {
  if (!e.isBuffer(t)) {
    throw new TypeError("Argument must be a Buffer");
  }
  if (void 0 === i && (i = 0), void 0 === n && (n = t ? t.length : 0), void 0 === o && (o = 0), void 0 === a && (a = this.length), i < 0 || n > t.length || o < 0 || a > this.length) {
    throw new RangeError("out of range index");
  }
  if (o >= a && i >= n) {
    return 0;
  }
  if (o >= a) {
    return -1;
  }
  if (i >= n) {
    return 1;
  }
  if (i >>>= 0, n >>>= 0, o >>>= 0, a >>>= 0, this === t) {
    return 0;
  }
  for (var s = a - o, r = n - i, l = Math.min(s, r), c = this.slice(o, a), d = t.slice(i, n), u = 0; u < l; ++u) {
    if (c[u] !== d[u]) {
      s = c[u];
      r = d[u];
      break;
    }
  }
  return s < r ? -1 : r < s ? 1 : 0;
};
e.prototype.includes = function (e, t, i) {
  return this.indexOf(e, t, i) !== -1;
};
e.prototype.indexOf = function (e, t, i) {
  return w(this, e, t, i, !0);
};
e.prototype.lastIndexOf = function (e, t, i) {
  return w(this, e, t, i, !1);
};
e.prototype.write = function (e, t, i, n) {
  if (void 0 === t) {
    n = "utf8";
    i = this.length;
    t = 0;
  } else if (void 0 === i && "string" == typeof t) {
    n = t;
    i = this.length;
    t = 0;
  } else {
    if (!isFinite(t)) {
      throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");
    }
    t = 0 | t;
    isFinite(i) ? (i = 0 | i, void 0 === n && (n = "utf8")) : (n = i, i = void 0);
  }
  var o = this.length - t;
  if ((void 0 === i || i > o) && (i = o), e.length > 0 && (i < 0 || t < 0) || t > this.length) {
    throw new RangeError("Attempt to write outside buffer bounds");
  }
  n || (n = "utf8");
  for (var a = !1;;) {
    switch (n) {
      case "hex":
        return M(this, e, t, i);
      case "utf8":
      case "utf-8":
        return T(this, e, t, i);
      case "ascii":
        return C(this, e, t, i);
      case "latin1":
      case "binary":
        return I(this, e, t, i);
      case "base64":
        return A(this, e, t, i);
      case "ucs2":
      case "ucs-2":
      case "utf16le":
      case "utf-16le":
        return S(this, e, t, i);
      default:
        if (a) {
          throw new TypeError("Unknown encoding: " + n);
        }
        n = ("" + n).toLowerCase();
        a = !0;
    }
  }
};
e.prototype.toJSON = function () {
  return {
    type: "Buffer",
    data: Array.prototype.slice.call(this._arr || this, 0)
  };
};
n = t[a];
o = i[a];
s.copy(o, a);
a += s.length;
y(this, t, t + 3);
y(this, t + 1, t + 2);
y(this, t, t + 7);
y(this, t + 1, t + 6);
y(this, t + 2, t + 5);
y(this, t + 3, t + 4);
s = c[u];
r = d[u];
n = "utf8";
i = this.length;
t = 0;
n = t;
i = this.length;
t = 0;
t = 0 | t;
isFinite(i) ? (i = 0 | i, void 0 === n && (n = "utf8")) : (n = i, i = void 0);
n = ("" + n).toLowerCase();
a = !0;
e.prototype.slice = function (t, i) {
  var n = this.length;
  t = ~~t;
  i = void 0 === i ? n : ~~i;
  t < 0 ? (t += n, t < 0 && (t = 0)) : t > n && (t = n);
  i < 0 ? (i += n, i < 0 && (i = 0)) : i > n && (i = n);
  i < t && (i = t);
  var o;
  if (e.TYPED_ARRAY_SUPPORT) {
    o = this.subarray(t, i);
    o.__proto__ = e.prototype;
  } else {
    var a = i - t;
    o = new e(a, void 0);
    for (var s = 0; s < a; ++s) {
      o[s] = this[s + t];
    }
  }
  return o;
};
e.prototype.readUIntLE = function (e, t, i) {
  e = 0 | e;
  t = 0 | t;
  i || P(e, t, this.length);
  for (var n = this[e], o = 1, a = 0; ++a < t && (o *= 256);) {
    n += this[e + a] * o;
  }
  return n;
};
e.prototype.readUIntBE = function (e, t, i) {
  e = 0 | e;
  t = 0 | t;
  i || P(e, t, this.length);
  for (var n = this[e + --t], o = 1; t > 0 && (o *= 256);) {
    n += this[e + --t] * o;
  }
  return n;
};
e.prototype.readUInt8 = function (e, t) {
  return t || P(e, 1, this.length), this[e];
};
e.prototype.readUInt16LE = function (e, t) {
  return t || P(e, 2, this.length), this[e] | this[e + 1] << 8;
};
e.prototype.readUInt16BE = function (e, t) {
  return t || P(e, 2, this.length), this[e] << 8 | this[e + 1];
};
e.prototype.readUInt32LE = function (e, t) {
  return t || P(e, 4, this.length), (this[e] | this[e + 1] << 8 | this[e + 2] << 16) + 16777216 * this[e + 3];
};
e.prototype.readUInt32BE = function (e, t) {
  return t || P(e, 4, this.length), 16777216 * this[e] + (this[e + 1] << 16 | this[e + 2] << 8 | this[e + 3]);
};
e.prototype.readIntLE = function (e, t, i) {
  e = 0 | e;
  t = 0 | t;
  i || P(e, t, this.length);
  for (var n = this[e], o = 1, a = 0; ++a < t && (o *= 256);) {
    n += this[e + a] * o;
  }
  return o *= 128, n >= o && (n -= Math.pow(2, 8 * t)), n;
};
e.prototype.readIntBE = function (e, t, i) {
  e = 0 | e;
  t = 0 | t;
  i || P(e, t, this.length);
  for (var n = t, o = 1, a = this[e + --n]; n > 0 && (o *= 256);) {
    a += this[e + --n] * o;
  }
  return o *= 128, a >= o && (a -= Math.pow(2, 8 * t)), a;
};
e.prototype.readInt8 = function (e, t) {
  return t || P(e, 1, this.length), 128 & this[e] ? (255 - this[e] + 1) * -1 : this[e];
};
e.prototype.readInt16LE = function (e, t) {
  t || P(e, 2, this.length);
  var i = this[e] | this[e + 1] << 8;
  return 32768 & i ? 4294901760 | i : i;
};
e.prototype.readInt16BE = function (e, t) {
  t || P(e, 2, this.length);
  var i = this[e + 1] | this[e] << 8;
  return 32768 & i ? 4294901760 | i : i;
};
e.prototype.readInt32LE = function (e, t) {
  return t || P(e, 4, this.length), this[e] | this[e + 1] << 8 | this[e + 2] << 16 | this[e + 3] << 24;
};
e.prototype.readInt32BE = function (e, t) {
  return t || P(e, 4, this.length), this[e] << 24 | this[e + 1] << 16 | this[e + 2] << 8 | this[e + 3];
};
e.prototype.readFloatLE = function (e, t) {
  return t || P(e, 4, this.length), Z.read(this, e, !0, 23, 4);
};
e.prototype.readFloatBE = function (e, t) {
  return t || P(e, 4, this.length), Z.read(this, e, !1, 23, 4);
};
e.prototype.readDoubleLE = function (e, t) {
  return t || P(e, 8, this.length), Z.read(this, e, !0, 52, 8);
};
e.prototype.readDoubleBE = function (e, t) {
  return t || P(e, 8, this.length), Z.read(this, e, !1, 52, 8);
};
e.prototype.writeUIntLE = function (e, t, i, n) {
  if (e = +e, t = 0 | t, i = 0 | i, !n) {
    var o = Math.pow(2, 8 * i) - 1;
    B(this, e, t, i, o, 0);
  }
  var a = 1,
    s = 0;
  for (this[t] = 255 & e; ++s < i && (a *= 256);) {
    this[t + s] = e / a & 255;
  }
  return t + i;
};
e.prototype.writeUIntBE = function (e, t, i, n) {
  if (e = +e, t = 0 | t, i = 0 | i, !n) {
    var o = Math.pow(2, 8 * i) - 1;
    B(this, e, t, i, o, 0);
  }
  var a = i - 1,
    s = 1;
  for (this[t + a] = 255 & e; --a >= 0 && (s *= 256);) {
    this[t + a] = e / s & 255;
  }
  return t + i;
};
e.prototype.writeUInt8 = function (t, i, n) {
  return t = +t, i = 0 | i, n || B(this, t, i, 1, 255, 0), e.TYPED_ARRAY_SUPPORT || (t = Math.floor(t)), this[i] = 255 & t, i + 1;
};
e.prototype.writeUInt16LE = function (t, i, n) {
  return t = +t, i = 0 | i, n || B(this, t, i, 2, 65535, 0), e.TYPED_ARRAY_SUPPORT ? (this[i] = 255 & t, this[i + 1] = t >>> 8) : k(this, t, i, !0), i + 2;
};
e.prototype.writeUInt16BE = function (t, i, n) {
  return t = +t, i = 0 | i, n || B(this, t, i, 2, 65535, 0), e.TYPED_ARRAY_SUPPORT ? (this[i] = t >>> 8, this[i + 1] = 255 & t) : k(this, t, i, !1), i + 2;
};
e.prototype.writeUInt32LE = function (t, i, n) {
  return t = +t, i = 0 | i, n || B(this, t, i, 4, 4294967295, 0), e.TYPED_ARRAY_SUPPORT ? (this[i + 3] = t >>> 24, this[i + 2] = t >>> 16, this[i + 1] = t >>> 8, this[i] = 255 & t) : F(this, t, i, !0), i + 4;
};
e.prototype.writeUInt32BE = function (t, i, n) {
  return t = +t, i = 0 | i, n || B(this, t, i, 4, 4294967295, 0), e.TYPED_ARRAY_SUPPORT ? (this[i] = t >>> 24, this[i + 1] = t >>> 16, this[i + 2] = t >>> 8, this[i + 3] = 255 & t) : F(this, t, i, !1), i + 4;
};
e.prototype.writeIntLE = function (e, t, i, n) {
  if (e = +e, t = 0 | t, !n) {
    var o = Math.pow(2, 8 * i - 1);
    B(this, e, t, i, o - 1, -o);
  }
  var a = 0,
    s = 1,
    r = 0;
  for (this[t] = 255 & e; ++a < i && (s *= 256);) {
    e < 0 && 0 === r && 0 !== this[t + a - 1] && (r = 1);
    this[t + a] = (e / s >> 0) - r & 255;
  }
  return t + i;
};
e.prototype.writeIntBE = function (e, t, i, n) {
  if (e = +e, t = 0 | t, !n) {
    var o = Math.pow(2, 8 * i - 1);
    B(this, e, t, i, o - 1, -o);
  }
  var a = i - 1,
    s = 1,
    r = 0;
  for (this[t + a] = 255 & e; --a >= 0 && (s *= 256);) {
    e < 0 && 0 === r && 0 !== this[t + a + 1] && (r = 1);
    this[t + a] = (e / s >> 0) - r & 255;
  }
  return t + i;
};
e.prototype.writeInt8 = function (t, i, n) {
  return t = +t, i = 0 | i, n || B(this, t, i, 1, 127, -128), e.TYPED_ARRAY_SUPPORT || (t = Math.floor(t)), t < 0 && (t = 255 + t + 1), this[i] = 255 & t, i + 1;
};
e.prototype.writeInt16LE = function (t, i, n) {
  return t = +t, i = 0 | i, n || B(this, t, i, 2, 32767, -32768), e.TYPED_ARRAY_SUPPORT ? (this[i] = 255 & t, this[i + 1] = t >>> 8) : k(this, t, i, !0), i + 2;
};
e.prototype.writeInt16BE = function (t, i, n) {
  return t = +t, i = 0 | i, n || B(this, t, i, 2, 32767, -32768), e.TYPED_ARRAY_SUPPORT ? (this[i] = t >>> 8, this[i + 1] = 255 & t) : k(this, t, i, !1), i + 2;
};
e.prototype.writeInt32LE = function (t, i, n) {
  return t = +t, i = 0 | i, n || B(this, t, i, 4, 2147483647, -2147483648), e.TYPED_ARRAY_SUPPORT ? (this[i] = 255 & t, this[i + 1] = t >>> 8, this[i + 2] = t >>> 16, this[i + 3] = t >>> 24) : F(this, t, i, !0), i + 4;
};
e.prototype.writeInt32BE = function (t, i, n) {
  return t = +t, i = 0 | i, n || B(this, t, i, 4, 2147483647, -2147483648), t < 0 && (t = 4294967295 + t + 1), e.TYPED_ARRAY_SUPPORT ? (this[i] = t >>> 24, this[i + 1] = t >>> 16, this[i + 2] = t >>> 8, this[i + 3] = 255 & t) : F(this, t, i, !1), i + 4;
};
e.prototype.writeFloatLE = function (e, t, i) {
  return z(this, e, t, !0, i);
};
e.prototype.writeFloatBE = function (e, t, i) {
  return z(this, e, t, !1, i);
};
e.prototype.writeDoubleLE = function (e, t, i) {
  return W(this, e, t, !0, i);
};
e.prototype.writeDoubleBE = function (e, t, i) {
  return W(this, e, t, !1, i);
};
e.prototype.copy = function (t, i, n, o) {
  if (n || (n = 0), o || 0 === o || (o = this.length), i >= t.length && (i = t.length), i || (i = 0), o > 0 && o < n && (o = n), o === n) {
    return 0;
  }
  if (0 === t.length || 0 === this.length) {
    return 0;
  }
  if (i < 0) {
    throw new RangeError("targetStart out of bounds");
  }
  if (n < 0 || n >= this.length) {
    throw new RangeError("sourceStart out of bounds");
  }
  if (o < 0) {
    throw new RangeError("sourceEnd out of bounds");
  }
  o > this.length && (o = this.length);
  t.length - i < o - n && (o = t.length - i + n);
  var a,
    s = o - n;
  if (this === t && n < i && i < o) {
    for (a = s - 1; a >= 0; --a) {
      t[a + i] = this[a + n];
    }
  } else if (s < 1e3 || !e.TYPED_ARRAY_SUPPORT) {
    for (a = 0; a < s; ++a) {
      t[a + i] = this[a + n];
    }
  } else {
    Uint8Array.prototype.set.call(t, this.subarray(n, n + s), i);
  }
  return s;
};
e.prototype.fill = function (t, i, n, o) {
  if ("string" == typeof t) {
    if ("string" == typeof i ? (o = i, i = 0, n = this.length) : "string" == typeof n && (o = n, n = this.length), 1 === t.length) {
      var a = t.charCodeAt(0);
      a < 256 && (t = a);
    }
    if (void 0 !== o && "string" != typeof o) {
      throw new TypeError("encoding must be a string");
    }
    if ("string" == typeof o && !e.isEncoding(o)) {
      throw new TypeError("Unknown encoding: " + o);
    }
  } else {
    "number" == typeof t && (t = 255 & t);
  }
  if (i < 0 || this.length < i || this.length < n) {
    throw new RangeError("Out of range index");
  }
  if (n <= i) {
    return this;
  }
  i >>>= 0;
  n = void 0 === n ? this.length : n >>> 0;
  t || (t = 0);
  var s;
  if ("number" == typeof t) {
    for (s = i; s < n; ++s) {
      this[s] = t;
    }
  } else {
    var r = e.isBuffer(t) ? t : Y(new e(t, o).toString()),
      l = r.length;
    for (s = 0; s < n - i; ++s) {
      this[s + i] = r[s % l];
    }
  }
  return this;
};
t = ~~t;
i = void 0 === i ? n : ~~i;
t < 0 ? (t += n, t < 0 && (t = 0)) : t > n && (t = n);
i < 0 ? (i += n, i < 0 && (i = 0)) : i > n && (i = n);
i < t && (i = t);
o = this.subarray(t, i);
o.__proto__ = e.prototype;
e = 0 | e;
t = 0 | t;
i || P(e, t, this.length);
e = 0 | e;
t = 0 | t;
i || P(e, t, this.length);
e = 0 | e;
t = 0 | t;
i || P(e, t, this.length);
e = 0 | e;
t = 0 | t;
i || P(e, t, this.length);
e < 0 && 0 === r && 0 !== this[t + a - 1] && (r = 1);
this[t + a] = (e / s >> 0) - r & 255;
e < 0 && 0 === r && 0 !== this[t + a + 1] && (r = 1);
this[t + a] = (e / s >> 0) - r & 255;
o > this.length && (o = this.length);
t.length - i < o - n && (o = t.length - i + n);
i >>>= 0;
n = void 0 === n ? this.length : n >>> 0;
t || (t = 0);
t = d[e.charCodeAt(n)] << 18 | d[e.charCodeAt(n + 1)] << 12 | d[e.charCodeAt(n + 2)] << 6 | d[e.charCodeAt(n + 3)];
l[c++] = t >> 16 & 255;
l[c++] = t >> 8 & 255;
l[c++] = 255 & t;
n = (e[a] << 16 & 16711680) + (e[a + 1] << 8 & 65280) + (255 & e[a + 2]);
o.push(s(n));
t.byteLength = n;
t.toByteArray = a;
t.fromByteArray = l;
c[p] = h[p];
d[h.charCodeAt(p)] = p;
d["-".charCodeAt(0)] = 62;
d["_".charCodeAt(0)] = 63;
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
t.read = function (e, t, i, n, o) {
  var a,
    s,
    r = 8 * o - n - 1,
    l = (1 << r) - 1,
    c = l >> 1,
    d = -7,
    u = i ? o - 1 : 0,
    h = i ? -1 : 1,
    p = e[t + u];
  for (u += h, a = p & (1 << -d) - 1, p >>= -d, d += r; d > 0; a = 256 * a + e[t + u], u += h, d -= 8) {
    ;
  }
  for (s = a & (1 << -d) - 1, a >>= -d, d += n; d > 0; s = 256 * s + e[t + u], u += h, d -= 8) {
    ;
  }
  if (0 === a) {
    a = 1 - c;
  } else {
    if (a === l) {
      return s ? NaN : (p ? -1 : 1) * (1 / 0);
    }
    s += Math.pow(2, n);
    a -= c;
  }
  return (p ? -1 : 1) * s * Math.pow(2, a - n);
};
t.write = function (e, t, i, n, o, a) {
  var s,
    r,
    l,
    c = 8 * a - o - 1,
    d = (1 << c) - 1,
    u = d >> 1,
    h = 23 === o ? Math.pow(2, -24) - Math.pow(2, -77) : 0,
    p = n ? 0 : a - 1,
    m = n ? 1 : -1,
    f = t < 0 || 0 === t && 1 / t < 0 ? 1 : 0;
  for (t = Math.abs(t), isNaN(t) || t === 1 / 0 ? (r = isNaN(t) ? 1 : 0, s = d) : (s = Math.floor(Math.log(t) / Math.LN2), t * (l = Math.pow(2, -s)) < 1 && (s--, l *= 2), t += s + u >= 1 ? h / l : h * Math.pow(2, 1 - u), t * l >= 2 && (s++, l /= 2), s + u >= d ? (r = 0, s = d) : s + u >= 1 ? (r = (t * l - 1) * Math.pow(2, o), s += u) : (r = t * Math.pow(2, u - 1) * Math.pow(2, o), s = 0)); o >= 8; e[i + p] = 255 & r, p += m, r /= 256, o -= 8) {
    ;
  }
  for (s = s << o | r, c += o; c > 0; e[i + p] = 255 & s, p += m, s /= 256, c -= 8) {
    ;
  }
  e[i + p - m] |= 128 * f;
};
s += Math.pow(2, n);
a -= c;
_crypto = o.crypto || o.msCrypto || i(645);
e.exports = function (e) {
  if (_crypto.getRandomValues) {
    var t = new n(e);
    return _crypto.getRandomValues(t), t;
  }
  if (_crypto.randomBytes) {
    return _crypto.randomBytes(e);
  }
  throw new Error("secure random number generation not supported by this browser\nuse chrome, FireFox or Internet Explorer 11");
};
t.sha1 = i(649)(n, o);
t.sha256 = i(650)(n, o);
t.sha512 = i(651)(n, o);
this._block = new e(t);
this._finalSize = i;
this._blockSize = t;
this._len = 0;
this._s = 0;
this._s = 0;
this._len = 0;
o += l;
a += l;
o % this._blockSize === 0 && this._update(s);
this._block[this._len % this._blockSize] = 128;
this._block.fill(0, this._len % this._blockSize + 1);
t % (8 * this._blockSize) >= 8 * this._finalSize && (this._update(this._block), this._block.fill(0));
this._block.writeInt32BE(t, this._blockSize - 4);
t = d = this._a;
i = u = this._b;
n = h = this._c;
l = p = this._d;
c = m = this._e;
c = l;
l = n;
n = r(i, 30);
i = t;
t = v;
this._a = s(t, d);
this._b = s(i, u);
this._c = s(n, h);
this._d = s(l, p);
this._e = s(c, m);
this.init();
this._w = p;
t.call(this, 64, 56);
t = 0 | this._a;
i = 0 | this._b;
n = 0 | this._c;
o = 0 | this._d;
a = 0 | this._e;
p = 0 | this._f;
m = 0 | this._g;
f = 0 | this._h;
g = f + c(a) + s(a, p, m) + h[y] + w;
_ = l(t) + r(t, i, n);
f = m;
m = p;
p = a;
a = o + g;
o = n;
n = i;
i = t;
t = g + _;
this._a = t + this._a | 0;
this._b = i + this._b | 0;
this._c = n + this._c | 0;
this._d = o + this._d | 0;
this._e = a + this._e | 0;
this._f = p + this._f | 0;
this._g = m + this._g | 0;
this._h = f + this._h | 0;
this.init();
this._w = l;
t.call(this, 128, 112);
t = 0 | this._a;
i = 0 | this._b;
n = 0 | this._c;
l = 0 | this._d;
c = 0 | this._e;
d = 0 | this._f;
u = 0 | this._g;
h = 0 | this._h;
p = 0 | this._al;
m = 0 | this._bl;
f = 0 | this._cl;
g = 0 | this._dl;
_ = 0 | this._el;
v = 0 | this._fl;
y = 0 | this._gl;
w = 0 | this._hl;
T = b[I] = e.readInt32BE(4 * I);
C = b[I + 1] = e.readInt32BE(4 * I + 4);
A = b[I - 4];
S = b[I - 4 + 1];
C = N + R;
T = E + O + (C >>> 0 < N >>> 0 ? 1 : 0);
C += L;
T = T + x + (C >>> 0 < L >>> 0 ? 1 : 0);
C += P;
T = T + D + (C >>> 0 < P >>> 0 ? 1 : 0);
b[I] = T;
b[I + 1] = C;
j += Y;
V = V + q + (j >>> 0 < Y >>> 0 ? 1 : 0);
j += U;
V = V + G + (j >>> 0 < U >>> 0 ? 1 : 0);
j += C;
V = V + T + (j >>> 0 < C >>> 0 ? 1 : 0);
h = u;
w = y;
u = d;
y = v;
d = c;
v = _;
_ = g + j | 0;
c = l + V + (_ >>> 0 < g >>> 0 ? 1 : 0) | 0;
l = n;
g = f;
n = i;
f = m;
i = t;
m = p;
p = j + X | 0;
t = V + Q + (p >>> 0 < j >>> 0 ? 1 : 0) | 0;
this._al = this._al + p | 0;
this._bl = this._bl + m | 0;
this._cl = this._cl + f | 0;
this._dl = this._dl + g | 0;
this._el = this._el + _ | 0;
this._fl = this._fl + v | 0;
this._gl = this._gl + y | 0;
this._hl = this._hl + w | 0;
this._a = this._a + t + (this._al >>> 0 < p >>> 0 ? 1 : 0) | 0;
this._b = this._b + i + (this._bl >>> 0 < m >>> 0 ? 1 : 0) | 0;
this._c = this._c + n + (this._cl >>> 0 < f >>> 0 ? 1 : 0) | 0;
this._d = this._d + l + (this._dl >>> 0 < g >>> 0 ? 1 : 0) | 0;
this._e = this._e + c + (this._el >>> 0 < _ >>> 0 ? 1 : 0) | 0;
this._f = this._f + d + (this._fl >>> 0 < v >>> 0 ? 1 : 0) | 0;
this._g = this._g + u + (this._gl >>> 0 < y >>> 0 ? 1 : 0) | 0;
this._h = this._h + h + (this._hl >>> 0 < w >>> 0 ? 1 : 0) | 0;
i.writeInt32BE(e, n);
i.writeInt32BE(t, n + 4);
e[t >> 5] |= 128 << t % 32;
e[(t + 64 >>> 9 << 4) + 14] = t;
i = a(i, n, o, d, e[u + 0], 7, -680876936);
d = a(d, i, n, o, e[u + 1], 12, -389564586);
o = a(o, d, i, n, e[u + 2], 17, 606105819);
n = a(n, o, d, i, e[u + 3], 22, -1044525330);
i = a(i, n, o, d, e[u + 4], 7, -176418897);
d = a(d, i, n, o, e[u + 5], 12, 1200080426);
o = a(o, d, i, n, e[u + 6], 17, -1473231341);
n = a(n, o, d, i, e[u + 7], 22, -45705983);
i = a(i, n, o, d, e[u + 8], 7, 1770035416);
d = a(d, i, n, o, e[u + 9], 12, -1958414417);
o = a(o, d, i, n, e[u + 10], 17, -42063);
n = a(n, o, d, i, e[u + 11], 22, -1990404162);
i = a(i, n, o, d, e[u + 12], 7, 1804603682);
d = a(d, i, n, o, e[u + 13], 12, -40341101);
o = a(o, d, i, n, e[u + 14], 17, -1502002290);
n = a(n, o, d, i, e[u + 15], 22, 1236535329);
i = s(i, n, o, d, e[u + 1], 5, -165796510);
d = s(d, i, n, o, e[u + 6], 9, -1069501632);
o = s(o, d, i, n, e[u + 11], 14, 643717713);
n = s(n, o, d, i, e[u + 0], 20, -373897302);
i = s(i, n, o, d, e[u + 5], 5, -701558691);
d = s(d, i, n, o, e[u + 10], 9, 38016083);
o = s(o, d, i, n, e[u + 15], 14, -660478335);
n = s(n, o, d, i, e[u + 4], 20, -405537848);
i = s(i, n, o, d, e[u + 9], 5, 568446438);
d = s(d, i, n, o, e[u + 14], 9, -1019803690);
o = s(o, d, i, n, e[u + 3], 14, -187363961);
n = s(n, o, d, i, e[u + 8], 20, 1163531501);
i = s(i, n, o, d, e[u + 13], 5, -1444681467);
d = s(d, i, n, o, e[u + 2], 9, -51403784);
o = s(o, d, i, n, e[u + 7], 14, 1735328473);
n = s(n, o, d, i, e[u + 12], 20, -1926607734);
i = r(i, n, o, d, e[u + 5], 4, -378558);
d = r(d, i, n, o, e[u + 8], 11, -2022574463);
o = r(o, d, i, n, e[u + 11], 16, 1839030562);
n = r(n, o, d, i, e[u + 14], 23, -35309556);
i = r(i, n, o, d, e[u + 1], 4, -1530992060);
d = r(d, i, n, o, e[u + 4], 11, 1272893353);
o = r(o, d, i, n, e[u + 7], 16, -155497632);
n = r(n, o, d, i, e[u + 10], 23, -1094730640);
i = r(i, n, o, d, e[u + 13], 4, 681279174);
d = r(d, i, n, o, e[u + 0], 11, -358537222);
o = r(o, d, i, n, e[u + 3], 16, -722521979);
n = r(n, o, d, i, e[u + 6], 23, 76029189);
i = r(i, n, o, d, e[u + 9], 4, -640364487);
d = r(d, i, n, o, e[u + 12], 11, -421815835);
o = r(o, d, i, n, e[u + 15], 16, 530742520);
n = r(n, o, d, i, e[u + 2], 23, -995338651);
i = l(i, n, o, d, e[u + 0], 6, -198630844);
d = l(d, i, n, o, e[u + 7], 10, 1126891415);
o = l(o, d, i, n, e[u + 14], 15, -1416354905);
n = l(n, o, d, i, e[u + 5], 21, -57434055);
i = l(i, n, o, d, e[u + 12], 6, 1700485571);
d = l(d, i, n, o, e[u + 3], 10, -1894986606);
o = l(o, d, i, n, e[u + 10], 15, -1051523);
n = l(n, o, d, i, e[u + 1], 21, -2054922799);
i = l(i, n, o, d, e[u + 8], 6, 1873313359);
d = l(d, i, n, o, e[u + 15], 10, -30611744);
o = l(o, d, i, n, e[u + 6], 15, -1560198380);
n = l(n, o, d, i, e[u + 13], 21, 1309151649);
i = l(i, n, o, d, e[u + 4], 6, -145523070);
d = l(d, i, n, o, e[u + 11], 10, -1120210379);
o = l(o, d, i, n, e[u + 2], 15, 718787259);
n = l(n, o, d, i, e[u + 9], 21, -343485551);
i = c(i, h);
n = c(n, p);
o = c(o, m);
d = c(d, f);
n[o >>> 5] |= 128 << 24 - o % 32;
n[(o + 64 >>> 9 << 4) + 14] = 16711935 & (a << 8 | a >>> 24) | 4278255360 & (a << 24 | a >>> 8);
T = v = e[0];
C = y = e[1];
I = w = e[2];
A = b = e[3];
S = M = e[4];
E = v + t[l + c[f]] | 0;
E += f < 16 ? i(y, w, b) + p[0] : f < 32 ? n(y, w, b) + p[1] : f < 48 ? o(y, w, b) + p[2] : f < 64 ? a(y, w, b) + p[3] : s(y, w, b) + p[4];
E = 0 | E;
E = r(E, u[f]);
E = E + M | 0;
v = M;
M = b;
b = r(w, 10);
w = y;
y = E;
E = T + t[l + d[f]] | 0;
E += f < 16 ? s(C, I, A) + m[0] : f < 32 ? a(C, I, A) + m[1] : f < 48 ? o(C, I, A) + m[2] : f < 64 ? n(C, I, A) + m[3] : i(C, I, A) + m[4];
E = 0 | E;
E = r(E, h[f]);
E = E + S | 0;
T = S;
S = A;
A = r(I, 10);
I = C;
C = E;
E = e[1] + w + A | 0;
e[1] = e[2] + b + S | 0;
e[2] = e[3] + M + T | 0;
e[3] = e[4] + v + C | 0;
e[4] = e[0] + y + I | 0;
e[0] = E;
this._opad = l;
this._alg = e;
i = this._key = t.isBuffer(i) ? i : new t(i);
i.length > s ? i = o(e).update(i).digest() : i.length < s && (i = t.concat([i, a], s));
r[c] = 54 ^ i[c];
l[c] = 92 ^ i[c];
a.fill(0);
e.exports = n;
n.prototype.update = function (e, t) {
  return this._hash.update(e, t), this;
};
n.prototype.digest = function (e) {
  var t = this._hash.digest();
  return o(this._alg).update(this._opad).update(t).digest(e);
};
s = s || "sha1";
t.isBuffer(i) || (i = new t(i));
t.isBuffer(n) || (n = new t(n));
a.call(this, {
  className: "ContextualMenuMonster"
});
this.monsterId = null;
this.attack = null;
this.once("open", function () {
  this._setupDom();
});
this.on("open", function (i, n) {
  function o(e) {
    for (var t = 0; t < h.monsters.length; t++) {
      if (h.monsters[t].creatureGenericId === e) {
        return h.monsters[t];
      }
    }
    return null;
  }
  this.monsterId = i.contextualId;
  this.starCounter.setValue(i.ageBonus);
  this.monstersList.clearContent();
  var a = this.monstersList.createChild("div", {
      className: "willFightContainer"
    }),
    s = this.monstersList.createChild("div", {
      className: "willNotFightContainer"
    }),
    c = [i.staticInfos.mainCreatureLightInfos].concat(i.staticInfos.underlings);
  for (t._monsterIds = [], d = 0; d < c.length; d += 1) {
    t._monsterIds.push(c[d].creatureGenericId);
  }
  var d,
    u = i.staticInfos.alternatives,
    h = null,
    p = [],
    m = window.gui.playerData.partyData.getClassicalParty(),
    f = m ? m.getMemberCount() : 1;
  if (u) {
    for (var g = 0; u[g] && u[g].playerCount <= f;) {
      h = u[g];
      g += 1;
    }
    for (d = 0; d < h.monsters.length; d += 1) {
      p.push(h.monsters[d].creatureGenericId);
    }
  }
  var _ = i.scaleLevel;
  if (_) {
    var v = window.gui.playerData.ToaData.getMonsterLevelScaled(_);
    for (d = 0; d < c.length; d += 1) {
      c[d].staticInfos.level = v;
    }
  }
  var y = c.sort(function (e, t) {
      return t.staticInfos.level - e.staticInfos.level;
    }),
    w = [],
    b = 0;
  for (d = 0; d < y.length; d += 1) {
    var M = y[d],
      T = M.staticInfos,
      C = M.creatureGenericId,
      I = !0,
      A = T.xp,
      S = T.level;
    if (u) {
      I = !1;
      var E = p.indexOf(C);
      if (E !== -1) {
        I = !0;
        p.splice(E, 1);
        var N = o(C);
        N && (A = N.xp, S = N.level);
      }
    }
    I && (b += S);
    var x = T.nameId + " (" + S + ")",
      L = I ? a : s,
      O = "monsterName";
    if (T.isMiniBoss) {
      O = ["monsterName", "miniBoss"];
      L.createChild("div", {
        className: O,
        text: x
      });
    } else if (T.isBoss) {
      O = ["monsterName", "boss"];
      var R = L.createChild("div", {
        className: O,
        text: x
      });
      R.createChild("div", {
        className: "bossIcon"
      });
      R.createChild("div", {
        className: "bossName",
        text: x
      });
    } else {
      L.createChild("div", {
        className: O,
        text: x
      });
    }
    I && w.push({
      id: M.creatureGenericId,
      xp: A,
      level: S
    });
  }
  var D = window.gui.playerData.characterBaseInformations.level,
    P = window.gui.playerData.partyData.getDangerDisplay(),
    B = f > 1 && P ? m.getMembersTotalLevel() : D,
    k = f > 1 && P ? m.getMembersLevelAverage() : D;
  e(b, b / y.length, B, k);
  t.level.setText(l("ui.common.rank", b));
  t.attack.setEnable(!window.gui.playerData.getRestrictions().cantAttackMonster);
  var F = r.getXpPreview(w, window.gui.playerData, null, i.ageBonus),
    H = r.getXpPreview(w, window.gui.playerData, m, i.ageBonus);
  t.xp.setText(l("ui.tooltip.monsterXpAlone", r.intToString(F)));
  f > 1 && t.xpGroup.setText(l("ui.tooltip.monsterXpParty", r.intToString(H)));
  t.xpGroup.toggleDisplay(f > 1);
  n();
});
this.monsterId = i.contextualId;
this.starCounter.setValue(i.ageBonus);
this.monstersList.clearContent();
h = u[g];
g += 1;
I = !0;
p.splice(E, 1);
O = ["monsterName", "miniBoss"];
L.createChild("div", {
  className: O,
  text: x
});
R.createChild("div", {
  className: "bossIcon"
});
R.createChild("div", {
  className: "bossName",
  text: x
});
e(b, b / y.length, B, k);
t.level.setText(l("ui.common.rank", b));
t.attack.setEnable(!window.gui.playerData.getRestrictions().cantAttackMonster);
t.xp.setText(l("ui.tooltip.monsterXpAlone", r.intToString(F)));
f > 1 && t.xpGroup.setText(l("ui.tooltip.monsterXpParty", r.intToString(H)));
t.xpGroup.toggleDisplay(f > 1);
n();
o(n, a);
e.exports = n;
n.prototype._setupDom = function () {
  var e = this,
    t = this.header.createChild("div", {
      className: "monsterInfosContainer"
    }),
    i = t.createChild("div", {
      className: "levelContainer"
    });
  this.level = i.createChild("div", {
    className: "level"
  });
  i.createChild("div", {
    className: "warning"
  });
  this.starCounter = t.appendChild(new s());
  this.starCounter.on("shopOpened", function () {
    e.close();
  });
  this.xp = t.createChild("div", {
    className: "xp"
  });
  this.xpGroup = t.createChild("div", {
    className: "xp"
  });
  this.monstersList = this.entryList.createChild("div", {
    className: "monstersList"
  });
  this.bestiary = this._addButton(function () {
    c.open("grimoire", {
      tabId: "bestiary",
      tabParams: {
        monsterIds: e._monsterIds
      }
    });
  }, ["bestiary", "greenButton"]);
  this.bestiary.createChild("div", {
    className: "bestiaryImg"
  });
  this.attack = this._addButton(function () {
    e.monsterId && window.isoEngine.attackActor(e.monsterId);
    e.close();
  }, ["greenButton", "attack"], l("ui.common.attack"));
};
this.level = i.createChild("div", {
  className: "level"
});
i.createChild("div", {
  className: "warning"
});
this.starCounter = t.appendChild(new s());
this.starCounter.on("shopOpened", function () {
  e.close();
});
this.xp = t.createChild("div", {
  className: "xp"
});
this.xpGroup = t.createChild("div", {
  className: "xp"
});
this.monstersList = this.entryList.createChild("div", {
  className: "monstersList"
});
this.bestiary = this._addButton(function () {
  c.open("grimoire", {
    tabId: "bestiary",
    tabParams: {
      monsterIds: e._monsterIds
    }
  });
}, ["bestiary", "greenButton"]);
this.bestiary.createChild("div", {
  className: "bestiaryImg"
});
this.attack = this._addButton(function () {
  e.monsterId && window.isoEngine.attackActor(e.monsterId);
  e.close();
}, ["greenButton", "attack"], l("ui.common.attack"));
e.monsterId && window.isoEngine.attackActor(e.monsterId);
e.close();
console.error(new Error(s + " not received: timeout triggered to unlock the character"));
o.unlock("npcActionRequest");
a.removeListener(s, c);
o.unlock("npcActionRequest");
clearTimeout(r);
this.once("open", function () {
  this._setupDom();
});
this.on("open", function (t, i) {
  function o() {
    n(a, s, l, this.npcActionId);
    e.close();
  }
  var a = t.npcData,
    s = t.actorId,
    l = t.mapId;
  this.header.setText(a.nameId);
  this.actionsContainer.clearContent();
  for (var c = window.gui.playerData.isAlive(), d = 0, u = a.actions.length; d < u; d++) {
    var h = this.actionsContainer.appendChild(new r({
      text: a.actionsName[d],
      className: "cmButton",
      disable: !c
    }, o));
    h.npcActionId = a.actions[d];
  }
  i();
});
n(a, s, l, this.npcActionId);
e.close();
this.header.setText(a.nameId);
this.actionsContainer.clearContent();
a(o, s);
e.exports = o;
o.npcActionRequest = n;
o.prototype._setupDom = function () {
  var e = this.entryList.createChild("div");
  this.actionsContainer = e.createChild("div");
  this._addCancel();
};
this.actionsContainer = e.createChild("div");
this._addCancel();
this.once("open", function () {
  e = this.header.appendChild(new a());
  var t = this._addEntry(s("ui.common.ankaboxMessage"), function () {});
  t.disable();
  this._addCancel();
});
this.on("open", function (t, i) {
  if (void 0 === t.hoursSinceLastConnection) {
    e.setContent({
      name: t.playerName
    });
  } else {
    var n = Math.floor(t.hoursSinceLastConnection),
      o = Math.floor(n / 720),
      a = Math.floor((n - 720 * o) / 24),
      r = "";
    r = o > 0 ? a > 0 ? s("ui.social.monthsAndDaysSinceLastConnection", o, a) : s("ui.social.monthsSinceLastConnection", o) : a > 0 ? s("ui.social.daysSinceLastConnection", a) : n > 0 ? s("tablet.ui.social.hoursSinceLastConnection", n) : s("tablet.ui.social.lessThanOneHour");
    e.setContent({
      name: t.playerName + "\n" + s("ui.social.lastConnection", r)
    });
  }
  i();
});
t.disable();
this._addCancel();
r = o > 0 ? a > 0 ? s("ui.social.monthsAndDaysSinceLastConnection", o, a) : s("ui.social.monthsSinceLastConnection", o) : a > 0 ? s("ui.social.daysSinceLastConnection", a) : n > 0 ? s("tablet.ui.social.hoursSinceLastConnection", n) : s("tablet.ui.social.lessThanOneHour");
e.setContent({
  name: t.playerName + "\n" + s("ui.social.lastConnection", r)
});
r(n, o);
e.exports = n;
this.data = null;
this.on("open", function (e, t) {
  this.data = e;
  this.header.setText(e.paddockObjectName);
  t();
});
this.once("open", function () {
  this._addEntry(s("ui.common.remove"), function () {
    window.dofus.sendMessage("PaddockRemoveItemRequestMessage", {
      cellId: e.data.cellId
    });
  });
  this._addCancel();
});
this.data = e;
this.header.setText(e.paddockObjectName);
t();
this._addEntry(s("ui.common.remove"), function () {
  window.dofus.sendMessage("PaddockRemoveItemRequestMessage", {
    cellId: e.data.cellId
  });
});
this._addCancel();
o(n, a);
e.exports = n;
a.call(this);
this.partyId = !1;
this.isLoyal = !1;
this.once("open", function () {
  this._setupDom();
});
this.on("open", function (e, t) {
  this.partyId = e.partyId;
  this.isLoyal = e.isLoyal;
  this.loyalMsg.toggleClassName("ticked", e.isLoyal);
  this.dangerMsg.toggleClassName("ticked", window.gui.playerData.partyData.getDangerDisplay());
  e.partyType === r.PARTY_TYPE_ARENA ? this.restrictedMsg.hide() : (this.restrictedMsg.show(), this.restrictedMsg.setEnable(e.isLeader), this.restrictedMsg.toggleClassName("ticked", e.isRestricted));
  t();
});
this.partyId = e.partyId;
this.isLoyal = e.isLoyal;
this.loyalMsg.toggleClassName("ticked", e.isLoyal);
this.dangerMsg.toggleClassName("ticked", window.gui.playerData.partyData.getDangerDisplay());
e.partyType === r.PARTY_TYPE_ARENA ? this.restrictedMsg.hide() : (this.restrictedMsg.show(), this.restrictedMsg.setEnable(e.isLeader), this.restrictedMsg.toggleClassName("ticked", e.isRestricted));
t();
o(n, a);
e.exports = n;
n.prototype._setupDom = function () {
  var e = this;
  this.header.setText(s("ui.common.options"));
  this.restrictedMsg = this._addEntry(s("ui.party.lockFight"), function () {
    window.dofus.sendMessage("GameFightOptionToggleMessage", {
      option: l.FIGHT_OPTION_SET_TO_PARTY_ONLY
    });
  });
  this.loyalMsg = this._addEntry(s("ui.party.refuseOtherInvitations"), function () {
    window.dofus.sendMessage("PartyPledgeLoyaltyRequestMessage", {
      partyId: e.partyId,
      loyal: !e.isLoyal
    });
  });
  this.dangerMsg = this._addEntry(s("ui.party.toggleDangerDisplay"), function () {
    window.gui.playerData.partyData.toggleDangerDisplay();
  });
  this._addCancel();
};
this.header.setText(s("ui.common.options"));
this.restrictedMsg = this._addEntry(s("ui.party.lockFight"), function () {
  window.dofus.sendMessage("GameFightOptionToggleMessage", {
    option: l.FIGHT_OPTION_SET_TO_PARTY_ONLY
  });
});
this.loyalMsg = this._addEntry(s("ui.party.refuseOtherInvitations"), function () {
  window.dofus.sendMessage("PartyPledgeLoyaltyRequestMessage", {
    partyId: e.partyId,
    loyal: !e.isLoyal
  });
});
this.dangerMsg = this._addEntry(s("ui.party.toggleDangerDisplay"), function () {
  window.gui.playerData.partyData.toggleDangerDisplay();
});
this._addCancel();
this.once("open", function () {
  var i = this,
    n = this.header.appendChild(new o());
  e = this.entryList.appendChild(new r(n));
  e.on("close", function () {
    i.close();
  });
  t = this.entryList.appendChild(new l(n));
  t.on("close", function () {
    i.close();
  });
  this._addCancel();
});
this.on("open", function (i, n) {
  var o = i.playerId === window.gui.playerData.id;
  o ? t.updateContent(i) : e.updateContent(i);
  t.toggleDisplay(o);
  e.toggleDisplay(!o);
  n();
});
e = this.entryList.appendChild(new r(n));
e.on("close", function () {
  i.close();
});
t = this.entryList.appendChild(new l(n));
t.on("close", function () {
  i.close();
});
this._addCancel();
o ? t.updateContent(i) : e.updateContent(i);
t.toggleDisplay(o);
e.toggleDisplay(!o);
n();
a(n, s);
e.exports = n;
this.banner = e;
this._setupGroup1(t);
this._setupGroup2(t);
this._setupGroup3(t);
this._setupGroup4(t);
this._setupGroup5(t);
this._setupGroup6(t);
this._setupHelper(t);
this._setupAdmin(t);
g(n, T);
e.exports = n;
n.prototype.updateContent = function (e) {
  function t(e) {
    switch (e._type) {
      case "HumanOptionAlliance":
        s = e;
        break;
      case "HumanOptionGuild":
        a = e.guildInformations;
        o = e.guildInformations.guildId;
    }
  }
  u = e.accountId;
  h = e.playerId;
  p = e.playerName;
  m = e.cellId;
  var i = e.humanoidInfoOptions,
    n = e.alignmentInfos,
    o = e.guildId;
  this.admin.hide();
  this.muteLong.hide();
  this.muteShort.hide();
  var a = null,
    s = null;
  if (this.targetPlayer = {
    id: h,
    name: p
  }, i) {
    for (var f = 0, g = i.length; f < g; f += 1) {
      t(i[f]);
    }
  }
  var _ = {
    name: p,
    guild: a,
    accountId: u,
    playerId: h,
    guildId: o
  };
  null !== s && (_.alliance = s.allianceInformations);
  this.banner.setContent(_);
  var v = window.gui.playerData.partyData;
  r = v.getClassicalParty();
  l = v.getArenaParty();
  c = r ? r.getPartyId() : null;
  d = l ? l.getPartyId() : null;
  this.toggleButtonsAvailability(e, n, a, s);
  var y = window.gui.playerData.adminMenu.getAdminMenuId();
  window.gui.playerData.isModeratorOrMore() && null !== y && this.admin.show();
  var w = window.gui.playerData.hasRight(L.SHOW_MUTE_MENU);
  w && parseInt(e.channel, 10) === x.CHANNEL_NOOB && (this.muteLong.show(), this.muteShort.show());
};
n.prototype.hideButtons = function () {
  this.kickFighter.hide();
  this.challenge.hide();
  this.assault.hide();
  this.exchangeProp.hide();
  this.inviteParty.hide();
  this.inviteArena.hide();
  this.inviteGuild.hide();
  this.inviteAlliance.hide();
  this.addFriend.hide();
  this.addEnemy.hide();
  this.ignoreSession.hide();
  this.stopIgnoreSession.hide();
  this.partyTitle.hide();
  this.follow.hide();
  this.stopFollowing.hide();
  this.kickPlayer.hide();
  this.appointLeader.hide();
  this.kickArenaPlayer.hide();
  this.appointArenaLeader.hide();
  this.allFollow.hide();
  this.allStopFollow.hide();
  this.cancelPartyInvitation.hide();
  this.leaveParty.hide();
  this.arenaTitle.hide();
  this.cancelArenaInvitation.hide();
  this.leaveArena.hide();
  this.kickOutFromHome.hide();
  this.guildInformations.hide();
  this.allianceInformations.hide();
  this.join.hide();
  this.spouseJoin.hide();
};
n.prototype.toggleButtonsAvailability = function (e, t, i, n) {
  e = e || {};
  var o = window.gui.playerData,
    a = o.partyData,
    c = o.jobs,
    d = o.socialData,
    p = !o.isAlive(),
    f = e.isMutant;
  this.hideButtons();
  window.gui.fightManager.fightState === O.PREPARATION && o.isFightLeader && o.id !== h && this.kickFighter.show();
  r && r.getGuest(h) ? (this.partyTitle.show(), this.cancelPartyInvitation.show()) : r && r.getMember(h) || this.inviteParty.show();
  l && l.getGuest(h) ? (this.arenaTitle.show(), this.cancelArenaInvitation.show()) : l && l.getMember(h) || this.inviteArena.show();
  u && (d.friendsList[u] || d.enemiesList[u]) || (this.addFriend.show(), this.addEnemy.show());
  d.isIgnored(u) ? this.stopIgnoreSession.show() : this.ignoreSession.show();
  r && r.getMember(h) && (this.partyTitle.show(), a.getFollowedCharacterId() === h ? this.stopFollowing.show() : this.follow.show(), r.getLeaderId() === o.id && (this.kickPlayer.show(), this.appointLeader.show(), R ? this.allStopFollow.show() : this.allFollow.show()));
  this.kickOutFromHome.toggleDisplay(!!window.gui.playerData.position.isInMyHouse);
  l && l.getMember(h) && l.getLeaderId() === o.id && (this.arenaTitle.show(), this.kickArenaPlayer.show(), this.appointArenaLeader.show());
  var g = d.spouse && d.spouse.spouseId === h;
  if (S.isRoleplayMode) {
    var _ = o.getRestrictions();
    if (_.cantExchange || (p ? this.exchangeProp.disable() : this.exchangeProp.enable(), this.exchangeProp.show()), _.cantChallenge || (p ? this.challenge.disable() : this.challenge.enable(), this.challenge.show()), t) {
      var v = s(t, n, f, h);
      v !== P && v !== B || (v === P || p ? this.assault.disable() : this.assault.enable(), this.assault.show());
    }
    !m && g ? this.spouseJoin.show() : o.position.isInIncarnam() && this.join.show();
  }
  var w = o.guild;
  !e.hasGuild && !i && w.current && w.hasRight(y.GUILD_RIGHT_INVITE_NEW_MEMBERS) && this.inviteGuild.show();
  var b = o.alliance;
  !e.hasGuild && h && i && !n && b.current && b.isBoss() && this.inviteAlliance.show();
  i && (this.guildId = i.guildId, this.guildInformations.show());
  n && (this.allianceId = n.allianceInformations.allianceId, this.allianceInformations.show());
  this._updateMultiCraftMenu(e, o, c);
};
n.prototype._setupGroup1 = function (e) {
  var t = this,
    i = e.createChild("div", {
      className: "group"
    });
  this.kickFighter = i.appendChild(new v({
    text: _("ui.fight.kick"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("GameContextKickMessage", {
      targetId: h
    });
    t.emit("close");
  }));
};
n.prototype._setupGroup2 = function (e) {
  var t = this,
    i = e.createChild("div", {
      className: "group"
    });
  this.privateMessage = i.appendChild(new v({
    text: _("ui.common.wisperMessage"),
    className: "cmButton"
  }, function () {
    window.gui.chat.startPrivateMessage(p);
    t.emit("close");
  }));
  i.appendChild(new v({
    text: _("ui.common.ankaboxMessage"),
    className: ["cmButton", "disabled"]
  }, function () {}));
  this.challenge = i.appendChild(new v({
    text: _("ui.common.challenge"),
    className: "cmButton"
  }, function () {
    window.gui.playerData.fightRequests.requestChallenge({
      targetId: h,
      targetName: p,
      targetCellId: m
    });
    t.emit("close");
  }));
  this.assault = i.appendChild(new v({
    text: _("ui.pvp.assault"),
    className: "cmButton"
  }, function () {
    window.gui.playerData.fightRequests.requestAssault({
      targetId: h,
      targetName: p,
      targetCellId: m
    }, f);
    t.emit("close");
  }));
  this.join = i.appendChild(new v({
    text: _("ui.common.join"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("FriendJoinRequestMessage", {
      name: p
    });
    t.emit("close");
  }));
  this.spouseJoin = i.appendChild(new v({
    text: _("ui.common.join"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("FriendSpouseJoinRequestMessage");
    t.emit("close");
  }));
  this.kickOutFromHome = i.appendChild(new v({
    text: _("ui.common.kickOff"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("HouseKickRequestMessage", {
      id: h
    });
    t.emit("close");
  }));
  i.appendChild(new v({
    text: _("ui.common.informations"),
    className: ["cmButton"]
  }, function () {
    var e = new N(E.now()).getServerDate(!1).toString(!1),
      i = e.date + " - " + e.time;
    window.gui.chat.logMsg(i);
    window.dofus.sendMessage("BasicWhoIsRequestMessage", {
      search: p,
      verbose: !0
    });
    t.emit("close");
  }));
  this.guildInformations = i.appendChild(new v({
    text: _("ui.guild.guildInformations"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("GuildFactsRequestMessage", {
      guildId: t.guildId
    });
    t.emit("close");
  }));
  this.allianceInformations = i.appendChild(new v({
    text: _("ui.alliance.allianceInformations"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("AllianceFactsRequestMessage", {
      allianceId: t.allianceId
    });
    t.emit("close");
  }));
};
n.prototype._setupGroup3 = function (e) {
  var t = this,
    i = e.createChild("div", {
      className: "group"
    });
  this.exchangeProp = i.appendChild(new v({
    text: _("ui.common.exchangeProp"),
    className: "cmButton"
  }, function () {
    t.emit("close");
    C.getWindow("tradeWithPlayer").prepareMakeExchange({
      targetId: h,
      targetName: p
    });
    window.dofus.sendMessage("ExchangePlayerRequestMessage", {
      exchangeType: 1,
      target: h
    });
  }));
  this.inviteParty = i.appendChild(new v({
    text: _("ui.party.addToParty"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("PartyInvitationRequestMessage", {
      name: p
    });
    t.emit("close");
  }));
  this.inviteArena = i.appendChild(new v({
    text: _("ui.party.addToArena"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("PartyInvitationArenaRequestMessage", {
      name: p
    });
    t.emit("close");
  }));
  this.inviteGuild = i.appendChild(new v({
    text: _("ui.social.inviteInGuild"),
    className: "cmButton"
  }, function () {
    h ? window.dofus.sendMessage("GuildInvitationMessage", {
      targetId: h
    }) : window.dofus.sendMessage("GuildInvitationByNameMessage", {
      name: p
    });
    t.emit("close");
  }));
  this.inviteAlliance = i.appendChild(new v({
    text: _("ui.social.inviteInAlliance"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("AllianceInvitationMessage", {
      targetId: h
    });
    t.emit("close");
  }));
  this._multiCraftMenu = i.createChild("div", {
    className: "multiCraftMenu"
  });
};
n.prototype._setupGroup4 = function (e) {
  var t = this,
    i = e.createChild("div");
  this.addFriend = i.appendChild(new v({
    text: _("ui.social.addToFriends"),
    className: "cmButton"
  }, function () {
    t.emit("close");
    window.gui.openConfirmPopup({
      title: _("ui.popup.warning"),
      message: _("ui.social.confirmAddFriend", p),
      cb: function (e) {
        e && window.dofus.sendMessage("FriendAddRequestMessage", {
          name: p
        });
      }
    });
  }));
  this.addEnemy = i.appendChild(new v({
    text: _("ui.social.addToEnemy"),
    className: "cmButton"
  }, function () {
    t.emit("close");
    window.gui.openConfirmPopup({
      title: _("ui.popup.warning"),
      message: _("ui.social.confirmAddEnemy", p),
      cb: function (e) {
        e && window.dofus.sendMessage("IgnoredAddRequestMessage", {
          name: p,
          session: !1
        });
      }
    });
  }));
  this.ignoreSession = i.appendChild(new v({
    text: _("ui.social.blackListTemporarly"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("IgnoredAddRequestMessage", {
      name: p,
      session: !0
    });
    t.emit("close");
  }));
  this.stopIgnoreSession = i.appendChild(new v({
    text: _("ui.social.blackListRemove"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("IgnoredDeleteRequestMessage", {
      accountId: u,
      session: !0
    });
    t.emit("close");
  }));
};
n.prototype._setupGroup5 = function (e) {
  var t = this,
    i = e.createChild("div");
  this.partyTitle = i.createChild("div", {
    text: _("ui.common.party"),
    className: "title"
  });
  this.follow = i.appendChild(new v({
    text: _("ui.common.follow"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("PartyFollowMemberRequestMessage", {
      partyId: c,
      playerId: h
    });
    t.emit("close");
  }));
  this.stopFollowing = i.appendChild(new v({
    text: _("ui.party.stopFollowing"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("PartyStopFollowRequestMessage", {
      partyId: c
    });
    t.emit("close");
  }));
  this.kickPlayer = i.appendChild(new v({
    text: _("ui.party.kickPlayer"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("PartyKickRequestMessage", {
      partyId: c,
      playerId: h
    });
    t.emit("close");
  }));
  this.appointLeader = i.appendChild(new v({
    text: _("ui.party.promotePartyLeader"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("PartyAbdicateThroneMessage", {
      partyId: c,
      playerId: h
    });
    t.emit("close");
  }));
  this.allFollow = i.appendChild(new v({
    text: _("ui.party.followHimAll"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("PartyFollowThisMemberRequestMessage", {
      partyId: c,
      playerId: h,
      enabled: !0
    });
    R = !0;
    t.emit("close");
  }));
  this.allStopFollow = i.appendChild(new v({
    text: _("ui.party.stopAllFollowingHim"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("PartyFollowThisMemberRequestMessage", {
      partyId: c,
      playerId: h,
      enabled: !1
    });
    R = !1;
    t.emit("close");
  }));
  this.cancelPartyInvitation = i.appendChild(new v({
    text: _("ui.party.cancelInvitation"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("PartyCancelInvitationMessage", {
      partyId: c,
      guestId: h
    });
    t.emit("close");
  }));
  this.leaveParty = i.appendChild(new v({
    text: _("ui.party.leaveParty"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("PartyLeaveRequestMessage", {
      partyId: c
    });
    t.emit("close");
  }));
};
n.prototype._setupGroup6 = function (e) {
  var t = this,
    i = e.createChild("div", {
      className: "group"
    });
  this.arenaTitle = i.createChild("div", {
    text: _("ui.common.koliseum"),
    className: "title"
  });
  this.cancelArenaInvitation = i.appendChild(new v({
    text: _("ui.party.cancelInvitation"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("PartyCancelInvitationMessage", {
      partyId: d,
      guestId: h
    });
    t.emit("close");
  }));
  this.kickArenaPlayer = i.appendChild(new v({
    text: _("ui.party.kickPlayer"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("PartyKickRequestMessage", {
      partyId: d,
      playerId: h
    });
    t.emit("close");
  }));
  this.appointArenaLeader = i.appendChild(new v({
    text: _("ui.party.promotePartyLeader"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("PartyAbdicateThroneMessage", {
      partyId: d,
      playerId: h
    });
    t.emit("close");
  }));
  this.leaveArena = i.appendChild(new v({
    text: _("ui.party.arenaQuit"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("PartyLeaveRequestMessage", {
      partyId: d
    });
    t.emit("close");
  }));
};
n.prototype._updateMultiCraftMenu = function (e, t, i) {
  function n(e, t, i) {
    var n = o.appendChild(new v({
      text: e,
      className: "cmButton"
    }, function () {
      window.dofus.sendMessage("ExchangePlayerMultiCraftRequestMessage", {
        exchangeType: t,
        target: h,
        skillId: i
      });
      a.emit("close");
    }));
    r ? n.disable() : n.enable();
  }
  var o = this._multiCraftMenu;
  if (o.clearContent(), !S.isFightMode) {
    var a = this,
      s = t.id,
      r = !t.isAlive();
    if (e.isInteractiveRequired && s !== e.playerId) {
      var l,
        c = window.isoEngine.mapRenderer.interactiveElements,
        d = i.getUsableSkillsInMap(s, c),
        u = _("ui.common.inviteTo");
      for (var p in d) {
        var m = d[p];
        l = u + " " + m.nameId;
        n(l, w.MULTICRAFT_CRAFTER, m.id);
      }
      var f = i.getUsableSkillsInMap(h, c),
        g = _("ui.common.askTo");
      for (var y in f) {
        var b = f[y];
        l = g + " " + b.nameId;
        n(l, w.MULTICRAFT_CUSTOMER, b.id);
      }
    }
  }
};
n.prototype._setupHelper = function (e) {
  var t = this;
  t.muteShort = e.appendChild(new v({
    text: _("tablet.chat.mute.short"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("AdminQuietCommandMessage", {
      content: "mutenoob " + t.targetPlayer.name + " short"
    });
    t.emit("close");
  }));
  t.muteLong = e.appendChild(new v({
    text: _("tablet.chat.mute.long"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("AdminQuietCommandMessage", {
      content: "mutenoob " + t.targetPlayer.name + " long"
    });
    t.emit("close");
  }));
};
n.prototype._setupAdmin = function (e) {
  var t = this;
  t.admin = e.appendChild(new v({
    text: "Admin",
    className: "cmButton"
  }, function () {
    window.gui.closeContextualMenu();
    window.gui.openContextualMenuAround("admin", t.admin, t.targetPlayer);
    t.emit("close");
  }));
};
a = e.guildInformations;
o = e.guildInformations.guildId;
u = e.accountId;
h = e.playerId;
p = e.playerName;
m = e.cellId;
this.admin.hide();
this.muteLong.hide();
this.muteShort.hide();
null !== s && (_.alliance = s.allianceInformations);
this.banner.setContent(_);
r = v.getClassicalParty();
l = v.getArenaParty();
c = r ? r.getPartyId() : null;
d = l ? l.getPartyId() : null;
this.toggleButtonsAvailability(e, n, a, s);
this.kickFighter.hide();
this.challenge.hide();
this.assault.hide();
this.exchangeProp.hide();
this.inviteParty.hide();
this.inviteArena.hide();
this.inviteGuild.hide();
this.inviteAlliance.hide();
this.addFriend.hide();
this.addEnemy.hide();
this.ignoreSession.hide();
this.stopIgnoreSession.hide();
this.partyTitle.hide();
this.follow.hide();
this.stopFollowing.hide();
this.kickPlayer.hide();
this.appointLeader.hide();
this.kickArenaPlayer.hide();
this.appointArenaLeader.hide();
this.allFollow.hide();
this.allStopFollow.hide();
this.cancelPartyInvitation.hide();
this.leaveParty.hide();
this.arenaTitle.hide();
this.cancelArenaInvitation.hide();
this.leaveArena.hide();
this.kickOutFromHome.hide();
this.guildInformations.hide();
this.allianceInformations.hide();
this.join.hide();
this.spouseJoin.hide();
this.hideButtons();
window.gui.fightManager.fightState === O.PREPARATION && o.isFightLeader && o.id !== h && this.kickFighter.show();
r && r.getGuest(h) ? (this.partyTitle.show(), this.cancelPartyInvitation.show()) : r && r.getMember(h) || this.inviteParty.show();
l && l.getGuest(h) ? (this.arenaTitle.show(), this.cancelArenaInvitation.show()) : l && l.getMember(h) || this.inviteArena.show();
u && (d.friendsList[u] || d.enemiesList[u]) || (this.addFriend.show(), this.addEnemy.show());
d.isIgnored(u) ? this.stopIgnoreSession.show() : this.ignoreSession.show();
r && r.getMember(h) && (this.partyTitle.show(), a.getFollowedCharacterId() === h ? this.stopFollowing.show() : this.follow.show(), r.getLeaderId() === o.id && (this.kickPlayer.show(), this.appointLeader.show(), R ? this.allStopFollow.show() : this.allFollow.show()));
this.kickOutFromHome.toggleDisplay(!!window.gui.playerData.position.isInMyHouse);
l && l.getMember(h) && l.getLeaderId() === o.id && (this.arenaTitle.show(), this.kickArenaPlayer.show(), this.appointArenaLeader.show());
!e.hasGuild && h && i && !n && b.current && b.isBoss() && this.inviteAlliance.show();
i && (this.guildId = i.guildId, this.guildInformations.show());
n && (this.allianceId = n.allianceInformations.allianceId, this.allianceInformations.show());
this._updateMultiCraftMenu(e, o, c);
window.dofus.sendMessage("GameContextKickMessage", {
  targetId: h
});
t.emit("close");
this.privateMessage = i.appendChild(new v({
  text: _("ui.common.wisperMessage"),
  className: "cmButton"
}, function () {
  window.gui.chat.startPrivateMessage(p);
  t.emit("close");
}));
i.appendChild(new v({
  text: _("ui.common.ankaboxMessage"),
  className: ["cmButton", "disabled"]
}, function () {}));
this.challenge = i.appendChild(new v({
  text: _("ui.common.challenge"),
  className: "cmButton"
}, function () {
  window.gui.playerData.fightRequests.requestChallenge({
    targetId: h,
    targetName: p,
    targetCellId: m
  });
  t.emit("close");
}));
this.assault = i.appendChild(new v({
  text: _("ui.pvp.assault"),
  className: "cmButton"
}, function () {
  window.gui.playerData.fightRequests.requestAssault({
    targetId: h,
    targetName: p,
    targetCellId: m
  }, f);
  t.emit("close");
}));
this.join = i.appendChild(new v({
  text: _("ui.common.join"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("FriendJoinRequestMessage", {
    name: p
  });
  t.emit("close");
}));
this.spouseJoin = i.appendChild(new v({
  text: _("ui.common.join"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("FriendSpouseJoinRequestMessage");
  t.emit("close");
}));
this.kickOutFromHome = i.appendChild(new v({
  text: _("ui.common.kickOff"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("HouseKickRequestMessage", {
    id: h
  });
  t.emit("close");
}));
i.appendChild(new v({
  text: _("ui.common.informations"),
  className: ["cmButton"]
}, function () {
  var e = new N(E.now()).getServerDate(!1).toString(!1),
    i = e.date + " - " + e.time;
  window.gui.chat.logMsg(i);
  window.dofus.sendMessage("BasicWhoIsRequestMessage", {
    search: p,
    verbose: !0
  });
  t.emit("close");
}));
this.guildInformations = i.appendChild(new v({
  text: _("ui.guild.guildInformations"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("GuildFactsRequestMessage", {
    guildId: t.guildId
  });
  t.emit("close");
}));
this.allianceInformations = i.appendChild(new v({
  text: _("ui.alliance.allianceInformations"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("AllianceFactsRequestMessage", {
    allianceId: t.allianceId
  });
  t.emit("close");
}));
window.gui.chat.startPrivateMessage(p);
t.emit("close");
window.gui.playerData.fightRequests.requestChallenge({
  targetId: h,
  targetName: p,
  targetCellId: m
});
t.emit("close");
window.gui.playerData.fightRequests.requestAssault({
  targetId: h,
  targetName: p,
  targetCellId: m
}, f);
t.emit("close");
window.dofus.sendMessage("FriendJoinRequestMessage", {
  name: p
});
t.emit("close");
window.dofus.sendMessage("FriendSpouseJoinRequestMessage");
t.emit("close");
window.dofus.sendMessage("HouseKickRequestMessage", {
  id: h
});
t.emit("close");
window.gui.chat.logMsg(i);
window.dofus.sendMessage("BasicWhoIsRequestMessage", {
  search: p,
  verbose: !0
});
t.emit("close");
window.dofus.sendMessage("GuildFactsRequestMessage", {
  guildId: t.guildId
});
t.emit("close");
window.dofus.sendMessage("AllianceFactsRequestMessage", {
  allianceId: t.allianceId
});
t.emit("close");
this.exchangeProp = i.appendChild(new v({
  text: _("ui.common.exchangeProp"),
  className: "cmButton"
}, function () {
  t.emit("close");
  C.getWindow("tradeWithPlayer").prepareMakeExchange({
    targetId: h,
    targetName: p
  });
  window.dofus.sendMessage("ExchangePlayerRequestMessage", {
    exchangeType: 1,
    target: h
  });
}));
this.inviteParty = i.appendChild(new v({
  text: _("ui.party.addToParty"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("PartyInvitationRequestMessage", {
    name: p
  });
  t.emit("close");
}));
this.inviteArena = i.appendChild(new v({
  text: _("ui.party.addToArena"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("PartyInvitationArenaRequestMessage", {
    name: p
  });
  t.emit("close");
}));
this.inviteGuild = i.appendChild(new v({
  text: _("ui.social.inviteInGuild"),
  className: "cmButton"
}, function () {
  h ? window.dofus.sendMessage("GuildInvitationMessage", {
    targetId: h
  }) : window.dofus.sendMessage("GuildInvitationByNameMessage", {
    name: p
  });
  t.emit("close");
}));
this.inviteAlliance = i.appendChild(new v({
  text: _("ui.social.inviteInAlliance"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("AllianceInvitationMessage", {
    targetId: h
  });
  t.emit("close");
}));
this._multiCraftMenu = i.createChild("div", {
  className: "multiCraftMenu"
});
t.emit("close");
C.getWindow("tradeWithPlayer").prepareMakeExchange({
  targetId: h,
  targetName: p
});
window.dofus.sendMessage("ExchangePlayerRequestMessage", {
  exchangeType: 1,
  target: h
});
window.dofus.sendMessage("PartyInvitationRequestMessage", {
  name: p
});
t.emit("close");
window.dofus.sendMessage("PartyInvitationArenaRequestMessage", {
  name: p
});
t.emit("close");
h ? window.dofus.sendMessage("GuildInvitationMessage", {
  targetId: h
}) : window.dofus.sendMessage("GuildInvitationByNameMessage", {
  name: p
});
t.emit("close");
window.dofus.sendMessage("AllianceInvitationMessage", {
  targetId: h
});
t.emit("close");
this.addFriend = i.appendChild(new v({
  text: _("ui.social.addToFriends"),
  className: "cmButton"
}, function () {
  t.emit("close");
  window.gui.openConfirmPopup({
    title: _("ui.popup.warning"),
    message: _("ui.social.confirmAddFriend", p),
    cb: function (e) {
      e && window.dofus.sendMessage("FriendAddRequestMessage", {
        name: p
      });
    }
  });
}));
this.addEnemy = i.appendChild(new v({
  text: _("ui.social.addToEnemy"),
  className: "cmButton"
}, function () {
  t.emit("close");
  window.gui.openConfirmPopup({
    title: _("ui.popup.warning"),
    message: _("ui.social.confirmAddEnemy", p),
    cb: function (e) {
      e && window.dofus.sendMessage("IgnoredAddRequestMessage", {
        name: p,
        session: !1
      });
    }
  });
}));
this.ignoreSession = i.appendChild(new v({
  text: _("ui.social.blackListTemporarly"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("IgnoredAddRequestMessage", {
    name: p,
    session: !0
  });
  t.emit("close");
}));
this.stopIgnoreSession = i.appendChild(new v({
  text: _("ui.social.blackListRemove"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("IgnoredDeleteRequestMessage", {
    accountId: u,
    session: !0
  });
  t.emit("close");
}));
t.emit("close");
window.gui.openConfirmPopup({
  title: _("ui.popup.warning"),
  message: _("ui.social.confirmAddFriend", p),
  cb: function (e) {
    e && window.dofus.sendMessage("FriendAddRequestMessage", {
      name: p
    });
  }
});
t.emit("close");
window.gui.openConfirmPopup({
  title: _("ui.popup.warning"),
  message: _("ui.social.confirmAddEnemy", p),
  cb: function (e) {
    e && window.dofus.sendMessage("IgnoredAddRequestMessage", {
      name: p,
      session: !1
    });
  }
});
window.dofus.sendMessage("IgnoredAddRequestMessage", {
  name: p,
  session: !0
});
t.emit("close");
window.dofus.sendMessage("IgnoredDeleteRequestMessage", {
  accountId: u,
  session: !0
});
t.emit("close");
this.partyTitle = i.createChild("div", {
  text: _("ui.common.party"),
  className: "title"
});
this.follow = i.appendChild(new v({
  text: _("ui.common.follow"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("PartyFollowMemberRequestMessage", {
    partyId: c,
    playerId: h
  });
  t.emit("close");
}));
this.stopFollowing = i.appendChild(new v({
  text: _("ui.party.stopFollowing"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("PartyStopFollowRequestMessage", {
    partyId: c
  });
  t.emit("close");
}));
this.kickPlayer = i.appendChild(new v({
  text: _("ui.party.kickPlayer"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("PartyKickRequestMessage", {
    partyId: c,
    playerId: h
  });
  t.emit("close");
}));
this.appointLeader = i.appendChild(new v({
  text: _("ui.party.promotePartyLeader"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("PartyAbdicateThroneMessage", {
    partyId: c,
    playerId: h
  });
  t.emit("close");
}));
this.allFollow = i.appendChild(new v({
  text: _("ui.party.followHimAll"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("PartyFollowThisMemberRequestMessage", {
    partyId: c,
    playerId: h,
    enabled: !0
  });
  R = !0;
  t.emit("close");
}));
this.allStopFollow = i.appendChild(new v({
  text: _("ui.party.stopAllFollowingHim"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("PartyFollowThisMemberRequestMessage", {
    partyId: c,
    playerId: h,
    enabled: !1
  });
  R = !1;
  t.emit("close");
}));
this.cancelPartyInvitation = i.appendChild(new v({
  text: _("ui.party.cancelInvitation"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("PartyCancelInvitationMessage", {
    partyId: c,
    guestId: h
  });
  t.emit("close");
}));
this.leaveParty = i.appendChild(new v({
  text: _("ui.party.leaveParty"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("PartyLeaveRequestMessage", {
    partyId: c
  });
  t.emit("close");
}));
window.dofus.sendMessage("PartyFollowMemberRequestMessage", {
  partyId: c,
  playerId: h
});
t.emit("close");
window.dofus.sendMessage("PartyStopFollowRequestMessage", {
  partyId: c
});
t.emit("close");
window.dofus.sendMessage("PartyKickRequestMessage", {
  partyId: c,
  playerId: h
});
t.emit("close");
window.dofus.sendMessage("PartyAbdicateThroneMessage", {
  partyId: c,
  playerId: h
});
t.emit("close");
window.dofus.sendMessage("PartyFollowThisMemberRequestMessage", {
  partyId: c,
  playerId: h,
  enabled: !0
});
R = !0;
t.emit("close");
window.dofus.sendMessage("PartyFollowThisMemberRequestMessage", {
  partyId: c,
  playerId: h,
  enabled: !1
});
R = !1;
t.emit("close");
window.dofus.sendMessage("PartyCancelInvitationMessage", {
  partyId: c,
  guestId: h
});
t.emit("close");
window.dofus.sendMessage("PartyLeaveRequestMessage", {
  partyId: c
});
t.emit("close");
this.arenaTitle = i.createChild("div", {
  text: _("ui.common.koliseum"),
  className: "title"
});
this.cancelArenaInvitation = i.appendChild(new v({
  text: _("ui.party.cancelInvitation"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("PartyCancelInvitationMessage", {
    partyId: d,
    guestId: h
  });
  t.emit("close");
}));
this.kickArenaPlayer = i.appendChild(new v({
  text: _("ui.party.kickPlayer"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("PartyKickRequestMessage", {
    partyId: d,
    playerId: h
  });
  t.emit("close");
}));
this.appointArenaLeader = i.appendChild(new v({
  text: _("ui.party.promotePartyLeader"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("PartyAbdicateThroneMessage", {
    partyId: d,
    playerId: h
  });
  t.emit("close");
}));
this.leaveArena = i.appendChild(new v({
  text: _("ui.party.arenaQuit"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("PartyLeaveRequestMessage", {
    partyId: d
  });
  t.emit("close");
}));
window.dofus.sendMessage("PartyCancelInvitationMessage", {
  partyId: d,
  guestId: h
});
t.emit("close");
window.dofus.sendMessage("PartyKickRequestMessage", {
  partyId: d,
  playerId: h
});
t.emit("close");
window.dofus.sendMessage("PartyAbdicateThroneMessage", {
  partyId: d,
  playerId: h
});
t.emit("close");
window.dofus.sendMessage("PartyLeaveRequestMessage", {
  partyId: d
});
t.emit("close");
window.dofus.sendMessage("ExchangePlayerMultiCraftRequestMessage", {
  exchangeType: t,
  target: h,
  skillId: i
});
a.emit("close");
l = u + " " + m.nameId;
n(l, w.MULTICRAFT_CRAFTER, m.id);
l = g + " " + b.nameId;
n(l, w.MULTICRAFT_CUSTOMER, b.id);
t.muteShort = e.appendChild(new v({
  text: _("tablet.chat.mute.short"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("AdminQuietCommandMessage", {
    content: "mutenoob " + t.targetPlayer.name + " short"
  });
  t.emit("close");
}));
t.muteLong = e.appendChild(new v({
  text: _("tablet.chat.mute.long"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("AdminQuietCommandMessage", {
    content: "mutenoob " + t.targetPlayer.name + " long"
  });
  t.emit("close");
}));
window.dofus.sendMessage("AdminQuietCommandMessage", {
  content: "mutenoob " + t.targetPlayer.name + " short"
});
t.emit("close");
window.dofus.sendMessage("AdminQuietCommandMessage", {
  content: "mutenoob " + t.targetPlayer.name + " long"
});
t.emit("close");
window.gui.closeContextualMenu();
window.gui.openContextualMenuAround("admin", t.admin, t.targetPlayer);
t.emit("close");
d.call(this, "div", {
  className: "ContextualMenuUserContent"
});
this.banner = e;
this._createDom();
r(n, d);
e.exports = n;
n.prototype._createDom = function () {
  var e = this,
    t = this.createChild("div"),
    i = window.gui.playerData;
  this.freeSoul = t.appendChild(new c({
    text: l("ui.common.freeSoul"),
    className: "cmButton",
    hidden: !0
  }, function () {
    window.dofus.sendMessage("GameRolePlayFreeSoulRequestMessage");
    e.emit("close");
  }));
  this.slapHimself = t.appendChild(new c({
    text: l("ui.dialog.slapHimself"),
    className: "cmButton"
  }, function () {
    window.dofus.sendMessage("ChatClientMultiMessage", {
      content: l("ui.dialog.slapSentence"),
      channel: 0
    });
    e.emit("close");
  }));
  this.orientCharacter = t.appendChild(new c({
    text: l("ui.orientCharacter"),
    className: ["cmButton"]
  }, function () {
    p.open("characterOrientation");
    e.emit("close");
  }));
  this.partyTitle = t.createChild("div", {
    text: l("ui.common.party"),
    className: "title",
    hidden: !0
  });
  this.leaveParty = t.appendChild(new c({
    text: l("ui.party.leaveParty"),
    className: "cmButton",
    hidden: !0
  }, function () {
    window.dofus.sendMessage("PartyLeaveRequestMessage", {
      partyId: o
    });
    e.emit("close");
  }));
  this.followMe = t.appendChild(new c({
    text: l("ui.party.followMeAll"),
    className: "cmButton",
    hidden: !0
  }, function () {
    window.dofus.sendMessage("PartyFollowThisMemberRequestMessage", {
      partyId: o,
      playerId: i.id,
      enabled: !0
    });
    s = !0;
    e.emit("close");
  }));
  this.stopFollowMe = t.appendChild(new c({
    text: l("ui.party.stopAllFollowingMe"),
    className: "cmButton",
    hidden: !0
  }, function () {
    window.dofus.sendMessage("PartyFollowThisMemberRequestMessage", {
      partyId: o,
      playerId: i.id,
      enabled: !1
    });
    s = !1;
    e.emit("close");
  }));
  var n = t.createChild("div", {
    className: "group"
  });
  this.arenaTitle = n.createChild("div", {
    text: l("ui.common.koliseum"),
    className: "title",
    hidden: !0
  });
  this.leaveArena = n.appendChild(new c({
    text: l("ui.party.arenaQuit"),
    className: "cmButton",
    hidden: !0
  }, function () {
    window.dofus.sendMessage("PartyLeaveRequestMessage", {
      partyId: a
    });
    e.emit("close");
  }));
  this.fightReady = t.appendChild(new c({
    text: l("ui.banner.ready"),
    className: "cmButton"
  }, function () {
    window.gui.timeline.fightControlButtons.toggleReadyForFight();
    e.emit("close");
  }));
  this.admin = t.appendChild(new c({
    text: "Admin",
    className: "cmButton"
  }, function () {
    var t = {
      id: i.id,
      name: i.characterBaseInformations.name
    };
    window.gui.closeContextualMenu();
    window.gui.openContextualMenuAround("admin", e.admin, t);
    e.emit("close");
  }));
};
n.prototype.updateContent = function () {
  var e = window.gui.playerData,
    t = e.partyData.getClassicalParty(),
    i = e.partyData.getArenaParty();
  if (this.banner.setContent({
    name: e.characterBaseInformations.name
  }), o = t ? t.getPartyId() : null, a = i ? i.getPartyId() : null, this.freeSoul.hide(), this.slapHimself.hide(), this.orientCharacter.hide(), this.partyTitle.hide(), this.leaveParty.hide(), this.arenaTitle.hide(), this.leaveArena.hide(), this.followMe.hide(), this.stopFollowMe.hide(), this.fightReady.hide(), this.admin.hide(), e.state === u.STATUS_TOMBSTONE ? this.freeSoul.show() : h.isRoleplayMode && (this.slapHimself.show(), this.orientCharacter.show()), o && (this.partyTitle.show(), this.leaveParty.show(), t.getLeaderId() === e.id)) {
    if (s) {
      return this.followMe.hide(), void this.stopFollowMe.show();
    }
    this.followMe.show();
    this.stopFollowMe.hide();
  }
  a && (this.arenaTitle.show(), this.leaveArena.show());
  window.gui.timeline.fightControlButtons.isReadyForFightButtonVisible() && this.fightReady.show();
  var n = e.adminMenu.getAdminMenuId();
  e.isModeratorOrMore() && null !== n && this.admin.show();
};
this.freeSoul = t.appendChild(new c({
  text: l("ui.common.freeSoul"),
  className: "cmButton",
  hidden: !0
}, function () {
  window.dofus.sendMessage("GameRolePlayFreeSoulRequestMessage");
  e.emit("close");
}));
this.slapHimself = t.appendChild(new c({
  text: l("ui.dialog.slapHimself"),
  className: "cmButton"
}, function () {
  window.dofus.sendMessage("ChatClientMultiMessage", {
    content: l("ui.dialog.slapSentence"),
    channel: 0
  });
  e.emit("close");
}));
this.orientCharacter = t.appendChild(new c({
  text: l("ui.orientCharacter"),
  className: ["cmButton"]
}, function () {
  p.open("characterOrientation");
  e.emit("close");
}));
this.partyTitle = t.createChild("div", {
  text: l("ui.common.party"),
  className: "title",
  hidden: !0
});
this.leaveParty = t.appendChild(new c({
  text: l("ui.party.leaveParty"),
  className: "cmButton",
  hidden: !0
}, function () {
  window.dofus.sendMessage("PartyLeaveRequestMessage", {
    partyId: o
  });
  e.emit("close");
}));
this.followMe = t.appendChild(new c({
  text: l("ui.party.followMeAll"),
  className: "cmButton",
  hidden: !0
}, function () {
  window.dofus.sendMessage("PartyFollowThisMemberRequestMessage", {
    partyId: o,
    playerId: i.id,
    enabled: !0
  });
  s = !0;
  e.emit("close");
}));
this.stopFollowMe = t.appendChild(new c({
  text: l("ui.party.stopAllFollowingMe"),
  className: "cmButton",
  hidden: !0
}, function () {
  window.dofus.sendMessage("PartyFollowThisMemberRequestMessage", {
    partyId: o,
    playerId: i.id,
    enabled: !1
  });
  s = !1;
  e.emit("close");
}));
window.dofus.sendMessage("GameRolePlayFreeSoulRequestMessage");
e.emit("close");
window.dofus.sendMessage("ChatClientMultiMessage", {
  content: l("ui.dialog.slapSentence"),
  channel: 0
});
e.emit("close");
p.open("characterOrientation");
e.emit("close");
window.dofus.sendMessage("PartyLeaveRequestMessage", {
  partyId: o
});
e.emit("close");
window.dofus.sendMessage("PartyFollowThisMemberRequestMessage", {
  partyId: o,
  playerId: i.id,
  enabled: !0
});
s = !0;
e.emit("close");
window.dofus.sendMessage("PartyFollowThisMemberRequestMessage", {
  partyId: o,
  playerId: i.id,
  enabled: !1
});
s = !1;
e.emit("close");
this.arenaTitle = n.createChild("div", {
  text: l("ui.common.koliseum"),
  className: "title",
  hidden: !0
});
this.leaveArena = n.appendChild(new c({
  text: l("ui.party.arenaQuit"),
  className: "cmButton",
  hidden: !0
}, function () {
  window.dofus.sendMessage("PartyLeaveRequestMessage", {
    partyId: a
  });
  e.emit("close");
}));
this.fightReady = t.appendChild(new c({
  text: l("ui.banner.ready"),
  className: "cmButton"
}, function () {
  window.gui.timeline.fightControlButtons.toggleReadyForFight();
  e.emit("close");
}));
this.admin = t.appendChild(new c({
  text: "Admin",
  className: "cmButton"
}, function () {
  var t = {
    id: i.id,
    name: i.characterBaseInformations.name
  };
  window.gui.closeContextualMenu();
  window.gui.openContextualMenuAround("admin", e.admin, t);
  e.emit("close");
}));
window.dofus.sendMessage("PartyLeaveRequestMessage", {
  partyId: a
});
e.emit("close");
window.gui.timeline.fightControlButtons.toggleReadyForFight();
e.emit("close");
window.gui.closeContextualMenu();
window.gui.openContextualMenuAround("admin", e.admin, t);
e.emit("close");
this.followMe.show();
this.stopFollowMe.hide();
a && (this.arenaTitle.show(), this.leaveArena.show());
window.gui.timeline.fightControlButtons.isReadyForFightButtonVisible() && this.fightReady.show();
i && (i.unset(), i.delClassNames("unavailable"));
r = "remove";
window.dofus.sendMessage("InventoryPresetUseMessage", {
  presetId: n
});
r = "equip";
this.once("open", function () {
  l.equipSet = this._addEntry(s("ui.common.equip"), t);
  l.remove = this._addEntry(s("ui.common.remove"), e);
  this._addCancel();
});
this.on("open", function (e, t) {
  e = e || {};
  i = e.slot;
  o = e.onClose;
  n = e.presetId;
  r = "";
  l.remove.toggleDisplay(!!e.canRemove);
  l.equipSet.toggleDisplay(!!e.hasOwnProperty("presetId"));
  t();
});
this.on("close", function () {
  o && o(r);
});
l.equipSet = this._addEntry(s("ui.common.equip"), t);
l.remove = this._addEntry(s("ui.common.remove"), e);
this._addCancel();
e = e || {};
i = e.slot;
o = e.onClose;
n = e.presetId;
r = "";
l.remove.toggleDisplay(!!e.canRemove);
l.equipSet.toggleDisplay(!!e.hasOwnProperty("presetId"));
t();
o(n, a);
e.exports = n;
this.once("open", function () {
  e = this.header.appendChild(new s());
  this._addEntry(r("ui.common.talk"), function () {
    m.prepareDialog(c.npcData);
    window.dofus.sendMessage("NpcGenericActionRequestMessage", {
      npcId: c.contextualId,
      npcActionId: 3,
      npcMapId: window.gui.playerData.position.mapId
    });
  });
  p = this._addEntry(r("ui.common.teleport"), function () {
    window.dofus.sendMessage("PrismUseRequestMessage");
  });
  i = this._addEntry(r("ui.common.attack"), function () {
    window.gui.openConfirmPopup({
      title: r("ui.popup.warning"),
      message: r("tablet.popup.prismAttackConfirm"),
      cb: function (e) {
        e && window.dofus.sendMessage("PrismAttackRequestMessage");
      }
    });
  });
  n = this._addEntry(r("ui.common.modify"), function () {
    h.open("social", {
      tabId: "alliance",
      tabParams: {
        tabId: "conquests"
      }
    });
  });
  this._addCancel();
  window.gui.on("AlliancePrismDialogQuestionMessage", function () {
    var e = new u(1e3 * t.nextVulnerabilityDate).getServerDate().toString(),
      i = [f, o.prismState[t.state], e.date + " " + e.time, 0];
    m.nextQuestionAsync(15428, [], i);
  });
});
this.on("open", function (o, a) {
  c = o;
  m = window.gui.npcDialogHandler;
  var s,
    r = window.gui.playerData;
  t = o.prism;
  "AlliancePrismInformation" === t._type ? (s = o.prism.alliance, f = s.allianceName, e.setContent({
    alliance: s
  }), r.alliance.hasAlliance() && r.alliance.current.allianceId === s.allianceId ? (i.hide(), n.toggleDisplay(r.guild.hasRight(l.GUILD_RIGHT_SET_ALLIANCE_PRISM))) : (i.show(), r.isAlive() && t.state === d.PRISM_STATE_NORMAL ? i.enable() : i.disable(), n.hide()), p.hide()) : (s = window.gui.playerData.alliance.current, f = s.allianceName, e.setContent({
    alliance: s
  }), i.hide(), p.toggleDisplay(t.hasTeleporterModule), r.guild.hasRight(l.GUILD_RIGHT_SET_ALLIANCE_PRISM) ? n.show() : n.hide());
  a();
});
e = this.header.appendChild(new s());
this._addEntry(r("ui.common.talk"), function () {
  m.prepareDialog(c.npcData);
  window.dofus.sendMessage("NpcGenericActionRequestMessage", {
    npcId: c.contextualId,
    npcActionId: 3,
    npcMapId: window.gui.playerData.position.mapId
  });
});
p = this._addEntry(r("ui.common.teleport"), function () {
  window.dofus.sendMessage("PrismUseRequestMessage");
});
i = this._addEntry(r("ui.common.attack"), function () {
  window.gui.openConfirmPopup({
    title: r("ui.popup.warning"),
    message: r("tablet.popup.prismAttackConfirm"),
    cb: function (e) {
      e && window.dofus.sendMessage("PrismAttackRequestMessage");
    }
  });
});
n = this._addEntry(r("ui.common.modify"), function () {
  h.open("social", {
    tabId: "alliance",
    tabParams: {
      tabId: "conquests"
    }
  });
});
this._addCancel();
window.gui.on("AlliancePrismDialogQuestionMessage", function () {
  var e = new u(1e3 * t.nextVulnerabilityDate).getServerDate().toString(),
    i = [f, o.prismState[t.state], e.date + " " + e.time, 0];
  m.nextQuestionAsync(15428, [], i);
});
m.prepareDialog(c.npcData);
window.dofus.sendMessage("NpcGenericActionRequestMessage", {
  npcId: c.contextualId,
  npcActionId: 3,
  npcMapId: window.gui.playerData.position.mapId
});
c = o;
m = window.gui.npcDialogHandler;
t = o.prism;
"AlliancePrismInformation" === t._type ? (s = o.prism.alliance, f = s.allianceName, e.setContent({
  alliance: s
}), r.alliance.hasAlliance() && r.alliance.current.allianceId === s.allianceId ? (i.hide(), n.toggleDisplay(r.guild.hasRight(l.GUILD_RIGHT_SET_ALLIANCE_PRISM))) : (i.show(), r.isAlive() && t.state === d.PRISM_STATE_NORMAL ? i.enable() : i.disable(), n.hide()), p.hide()) : (s = window.gui.playerData.alliance.current, f = s.allianceName, e.setContent({
  alliance: s
}), i.hide(), p.toggleDisplay(t.hasTeleporterModule), r.guild.hasRight(l.GUILD_RIGHT_SET_ALLIANCE_PRISM) ? n.show() : n.hide());
a();
c(n, a);
e.exports = n;
t.alliances = {};
t.createAlliance = function (e) {
  var i = new n(e);
  return t.alliances[i.allianceId] = i, i;
};
t.initialize = function (e) {
  e.on("disconnect", function () {
    t.alliances = {};
  });
  e.on("PrismSettingsErrorMessage", function () {
    e.chat.logMsg(o("ui.error.cantModifiedPrismVulnerabiltyHour"));
  });
  e.on("AllianceCreationResultMessage", function (e) {
    switch (e.result) {
      case a.SOCIAL_GROUP_CREATE_ERROR_ALREADY_IN_GROUP:
        return window.gui.openSimplePopup(o("ui.alliance.alreadyInAlliance"));
      case a.SOCIAL_GROUP_CREATE_OK:
        return s.close("socialGroupCreation");
      case a.SOCIAL_GROUP_CREATE_ERROR_NAME_ALREADY_EXISTS:
        return window.gui.openSimplePopup(o("ui.alliance.alreadyUseName"));
      case a.SOCIAL_GROUP_CREATE_ERROR_NAME_INVALID:
        return window.gui.openSimplePopup(o("ui.alliance.invalidName"));
      case a.SOCIAL_GROUP_CREATE_ERROR_TAG_ALREADY_EXISTS:
        return window.gui.openSimplePopup(o("ui.alliance.alreadyUseTag"));
      case a.SOCIAL_GROUP_CREATE_ERROR_TAG_INVALID:
        return window.gui.openSimplePopup(o("ui.alliance.invalidTag"));
      case a.SOCIAL_GROUP_CREATE_ERROR_EMBLEM_ALREADY_EXISTS:
        return window.gui.openSimplePopup(o("ui.guild.AlreadyUseEmblem"));
      case a.SOCIAL_GROUP_CREATE_ERROR_REQUIREMENT_UNMET:
        return window.gui.openSimplePopup(o("ui.guild.requirementUnmet"));
      case a.SOCIAL_GROUP_CREATE_ERROR_EMBLEM_INVALID:
      case a.SOCIAL_GROUP_CREATE_ERROR_UNKNOWN:
        return window.gui.openSimplePopup(o("ui.common.unknownFail"));
    }
  });
  e.on("AllianceFactsMessage", function (e) {
    s.getWindow("allianceCard").display(e);
  });
  e.on("AllianceFactsErrorMessage", function () {
    e.chat.logMsg(o("ui.alliance.doesntExistAnymore"));
  });
  t.prismState = {
    0: o("ui.prism.state0"),
    1: o("ui.prism.state1"),
    2: o("ui.prism.state2"),
    3: o("ui.prism.state3"),
    4: o("ui.prism.state4"),
    5: o("ui.prism.state5"),
    6: o("ui.prism.state6")
  };
  t.getPrismStateInfo = function (e, t) {
    switch (e) {
      case 0:
        return o("ui.prism.stateInfos0");
      case 1:
        return o("ui.prism.stateInfos1");
      case 2:
        return o("ui.prism.stateInfos2");
      case 3:
        return o("ui.prism.stateInfos3");
      case 4:
        return o("ui.prism.stateInfos4", t);
      case 5:
        return o("ui.prism.stateInfos5");
      case 6:
        return o("ui.prism.stateInfos6");
    }
  };
};
t.openAllianceCard = function (e) {
  window.dofus.sendMessage("AllianceFactsRequestMessage", {
    allianceId: e
  });
};
e.on("disconnect", function () {
  t.alliances = {};
});
e.on("PrismSettingsErrorMessage", function () {
  e.chat.logMsg(o("ui.error.cantModifiedPrismVulnerabiltyHour"));
});
e.on("AllianceCreationResultMessage", function (e) {
  switch (e.result) {
    case a.SOCIAL_GROUP_CREATE_ERROR_ALREADY_IN_GROUP:
      return window.gui.openSimplePopup(o("ui.alliance.alreadyInAlliance"));
    case a.SOCIAL_GROUP_CREATE_OK:
      return s.close("socialGroupCreation");
    case a.SOCIAL_GROUP_CREATE_ERROR_NAME_ALREADY_EXISTS:
      return window.gui.openSimplePopup(o("ui.alliance.alreadyUseName"));
    case a.SOCIAL_GROUP_CREATE_ERROR_NAME_INVALID:
      return window.gui.openSimplePopup(o("ui.alliance.invalidName"));
    case a.SOCIAL_GROUP_CREATE_ERROR_TAG_ALREADY_EXISTS:
      return window.gui.openSimplePopup(o("ui.alliance.alreadyUseTag"));
    case a.SOCIAL_GROUP_CREATE_ERROR_TAG_INVALID:
      return window.gui.openSimplePopup(o("ui.alliance.invalidTag"));
    case a.SOCIAL_GROUP_CREATE_ERROR_EMBLEM_ALREADY_EXISTS:
      return window.gui.openSimplePopup(o("ui.guild.AlreadyUseEmblem"));
    case a.SOCIAL_GROUP_CREATE_ERROR_REQUIREMENT_UNMET:
      return window.gui.openSimplePopup(o("ui.guild.requirementUnmet"));
    case a.SOCIAL_GROUP_CREATE_ERROR_EMBLEM_INVALID:
    case a.SOCIAL_GROUP_CREATE_ERROR_UNKNOWN:
      return window.gui.openSimplePopup(o("ui.common.unknownFail"));
  }
});
e.on("AllianceFactsMessage", function (e) {
  s.getWindow("allianceCard").display(e);
});
e.on("AllianceFactsErrorMessage", function () {
  e.chat.logMsg(o("ui.alliance.doesntExistAnymore"));
});
t.prismState = {
  0: o("ui.prism.state0"),
  1: o("ui.prism.state1"),
  2: o("ui.prism.state2"),
  3: o("ui.prism.state3"),
  4: o("ui.prism.state4"),
  5: o("ui.prism.state5"),
  6: o("ui.prism.state6")
};
t.getPrismStateInfo = function (e, t) {
  switch (e) {
    case 0:
      return o("ui.prism.stateInfos0");
    case 1:
      return o("ui.prism.stateInfos1");
    case 2:
      return o("ui.prism.stateInfos2");
    case 3:
      return o("ui.prism.stateInfos3");
    case 4:
      return o("ui.prism.stateInfos4", t);
    case 5:
      return o("ui.prism.stateInfos5");
    case 6:
      return o("ui.prism.stateInfos6");
  }
};
this.enabled = !1;
this.allianceId = 0;
this.allianceTag = "";
this.allianceName = "";
this.creationDate = 0;
this.allianceEmblem = new l();
this.nbMembers = 0;
this.prisms = [];
this.guilds = [];
this.guildCount = 0;
this.setInfo(e);
n.prototype.setInfo = function (e) {
  for (var t in e) {
    o.call(this, t, e);
  }
  if (e.guilds) {
    var i = a(e);
    this.nbMembers = i.memberCount;
    this.guilds = i.guilds;
    this.guildCount = this.guilds.length;
  }
  var n = e.prisms;
  if (n) {
    this.prisms = {};
    for (var s = 0, l = n.length; s < l; s += 1) {
      var c = n[s];
      this.prisms[c.subAreaId] = c;
    }
  }
  "#NONAME#" === this.allianceName && (this.allianceName = r("ui.guild.noName"));
  "#TAG#" === this.allianceTag && (this.allianceTag = r("ui.alliance.noTag"));
  this.allianceEmblem.isAlliance = !0;
};
e.exports = n;
this.nbMembers = i.memberCount;
this.guilds = i.guilds;
this.guildCount = this.guilds.length;
"#NONAME#" === this.allianceName && (this.allianceName = r("ui.guild.noName"));
"#TAG#" === this.allianceTag && (this.allianceTag = r("ui.alliance.noTag"));
this.allianceEmblem.isAlliance = !0;
i && (i.unset(), i.delClassNames("unavailable"));
r = "remove";
e.openPanel && e.closePanels();
r = "use";
this.once("open", function () {
  l.useSmiley = this._addEntry(s("ui.common.use"), t);
  l.remove = this._addEntry(s("ui.common.remove"), e);
  this._addCancel();
});
this.on("open", function (e, t) {
  e = e || {};
  i = e.slot;
  o = e.onClose;
  n = e.smileyId;
  r = "";
  l.remove.toggleDisplay(!!e.canRemove);
  l.useSmiley.toggleDisplay(!!e.hasOwnProperty("smileyId"));
  t();
});
this.on("close", function () {
  o && o(r);
});
l.useSmiley = this._addEntry(s("ui.common.use"), t);
l.remove = this._addEntry(s("ui.common.remove"), e);
this._addCancel();
e = e || {};
i = e.slot;
o = e.onClose;
n = e.smileyId;
r = "";
l.remove.toggleDisplay(!!e.canRemove);
l.useSmiley.toggleDisplay(!!e.hasOwnProperty("smileyId"));
t();
o(n, a);
e.exports = n;
n && n.unset();
l = "remove";
this.once("open", function () {
  c.showSpellUi = this._addEntry(s("ui.spell.openUI"), e);
  c.remove = this._addEntry(s("ui.common.remove"), t);
  this._addCancel();
});
this.on("open", function (e, t) {
  e = e || {};
  i._spellId = e.spell.id;
  n = e.slot;
  o = e.onClose;
  this.header.setText(e.spell.getName());
  l = "";
  c.remove.toggleDisplay(!!e.canRemove);
  t();
});
this.on("close", function () {
  o && o(l);
});
c.showSpellUi = this._addEntry(s("ui.spell.openUI"), e);
c.remove = this._addEntry(s("ui.common.remove"), t);
this._addCancel();
e = e || {};
i._spellId = e.spell.id;
n = e.slot;
o = e.onClose;
this.header.setText(e.spell.getName());
l = "";
c.remove.toggleDisplay(!!e.canRemove);
t();
o(n, a);
e.exports = n;
this.once("open", function () {
  this._addEntry(s("ui.storage.getAll"), e);
  this._addEntry(s("ui.storage.getVisible"), t);
  this._addEntry(s("ui.storage.getExisting"), i);
  this._addCancel();
});
this.on("open", function (e, t) {
  n = e.toInventory;
  o = e.viewer;
  t();
});
this._addEntry(s("ui.storage.getAll"), e);
this._addEntry(s("ui.storage.getVisible"), t);
this._addEntry(s("ui.storage.getExisting"), i);
this._addCancel();
n = e.toInventory;
o = e.viewer;
t();
o(n, a);
e.exports = n;
3 === this.actionId && h.prepareDialog(a.npcData);
window.dofus.sendMessage("NpcGenericActionRequestMessage", {
  npcId: a.contextualId,
  npcActionId: this.actionId,
  npcMapId: a.mapId
});
this.once("open", function (n) {
  function s(e) {
    var t = [e.guildInfo.guildName];
    e.maxPods && (t.push(e.maxPods), t.push(e.prospecting), t.push(e.wisdom), t.push(e.taxCollectorsCount), t.push(l(e.kamas)), t.push(l(e.experience)), t.push(l(e.pods)), t.push(l(e.itemsValue)));
    var i = e.alliance;
    return i && (t.push("#NONAME#" !== i.allianceName ? i.allianceName : r("ui.guild.noName")), t.push("[" + ("#TAG#" !== i.allianceTag ? i.allianceTag : r("ui.alliance.noTag")) + "]")), t;
  }
  h = window.gui.npcDialogHandler;
  o = this.header.appendChild(new d());
  for (var c = n.npcData, u = 0, m = c.actions.length; u < m; u += 1) {
    var f = this._addEntry(c.actionsName[u], e);
    f.actionId = c.actions[u];
  }
  i = this._addEntry(r("ui.social.CollectTaxCollector"), function () {
    window.dofus.sendMessage("ExchangeRequestOnTaxCollectorMessage", {
      taxCollectorId: a.contextualId
    });
  });
  t = this._addEntry(r("ui.common.attack"), function () {
    window.gui.openConfirmPopup({
      title: r("ui.popup.warning"),
      message: r("tablet.popup.taxCollectorAttackConfirm"),
      cb: function (e) {
        e && window.dofus.sendMessage("GameRolePlayTaxCollectorFightRequestMessage", {
          taxCollectorId: a.contextualId
        });
      }
    });
  });
  this._addCancel();
  window.gui.on("TaxCollectorDialogQuestionExtendedMessage", function (e) {
    h.nextQuestionAsync(p.guild, [], s(e));
  });
  window.gui.on("TaxCollectorDialogQuestionBasicMessage", function (e) {
    h.nextQuestionAsync(p.basic, [], s(e));
  });
  window.gui.on("AllianceTaxCollectorDialogQuestionExtendedMessage", function (e) {
    h.nextQuestionAsync(p.alliance, [], s(e));
  });
});
this.on("open", function (e, s) {
  if (a = e, m.hasGuild() && e.guild.guildId === m.current.guildId) {
    i.show();
    var r = m.hasRight(u.GUILD_RIGHT_COLLECT),
      l = m.hasRight(u.GUILD_RIGHT_COLLECT_MY_TAX_COLLECTOR);
    r || l ? i.enable() : i.disable();
    t.hide();
  } else {
    i.hide();
    t.show();
    0 !== e.taxCollectorAttack ? t.disable() : t.enable();
  }
  n("firstName", e.taxCollector.firstNameId, function (t) {
    n("lastName", e.taxCollector.lastNameId, function (i) {
      c = t + " " + i;
      a.npcData.nameId = c;
      o.setContent({
        name: c,
        guild: e.guild
      });
      s();
    });
  });
});
h = window.gui.npcDialogHandler;
o = this.header.appendChild(new d());
i = this._addEntry(r("ui.social.CollectTaxCollector"), function () {
  window.dofus.sendMessage("ExchangeRequestOnTaxCollectorMessage", {
    taxCollectorId: a.contextualId
  });
});
t = this._addEntry(r("ui.common.attack"), function () {
  window.gui.openConfirmPopup({
    title: r("ui.popup.warning"),
    message: r("tablet.popup.taxCollectorAttackConfirm"),
    cb: function (e) {
      e && window.dofus.sendMessage("GameRolePlayTaxCollectorFightRequestMessage", {
        taxCollectorId: a.contextualId
      });
    }
  });
});
this._addCancel();
window.gui.on("TaxCollectorDialogQuestionExtendedMessage", function (e) {
  h.nextQuestionAsync(p.guild, [], s(e));
});
window.gui.on("TaxCollectorDialogQuestionBasicMessage", function (e) {
  h.nextQuestionAsync(p.basic, [], s(e));
});
window.gui.on("AllianceTaxCollectorDialogQuestionExtendedMessage", function (e) {
  h.nextQuestionAsync(p.alliance, [], s(e));
});
r || l ? i.enable() : i.disable();
t.hide();
i.hide();
t.show();
0 !== e.taxCollectorAttack ? t.disable() : t.enable();
c = t + " " + i;
a.npcData.nameId = c;
o.setContent({
  name: c,
  guild: e.guild
});
s();
a(o, s);
e.exports = o;
window.dofus.sendMessage("PlayerStatusUpdateRequestMessage", {
  status: {
    statusId: i
  }
});
n.close();
a.call(this, {
  className: "ContextualMenuUserStatus"
});
this.once("open", function () {
  this.header.setText(s("ui.chat.status.title"));
  for (var e = [{
      label: s("ui.chat.status.availiable"),
      className: "available",
      id: c.PLAYER_STATUS_AVAILABLE
    }, {
      label: s("ui.chat.status.away"),
      className: "away",
      id: c.PLAYER_STATUS_AFK
    }, {
      label: s("ui.chat.status.private"),
      className: "private",
      id: c.PLAYER_STATUS_PRIVATE
    }, {
      label: s("ui.chat.status.solo"),
      className: "solo",
      id: c.PLAYER_STATUS_SOLO
    }], t = this.entryList.createChild("ul"), i = 0, o = e.length; i < o; i += 1) {
    var a = e[i];
    t.appendChild(n(a.label, a.className, a.id, this));
  }
  this._addCancel();
});
this.on("open", function (e, t) {
  t();
});
r(o, a);
e.exports = o;
a.call(this, {
  className: "ContextualMenuPlayersList"
});
this.once("open", this._setupDom);
this.on("open", this._setContent);
o(n, a);
e.exports = n;
n.prototype._setupDom = function () {
  var e = this.entryList.createChild("div");
  this.playersList = e.createChild("div", {
    className: "playersList"
  });
  this._addCancel();
};
n.prototype._setContent = function (e, t) {
  function i(e) {
    c.close();
    e.openPlayerContextualMenu(u);
  }
  function n(e) {
    c.close();
    e.openNpcContextualMenu(u);
  }
  function o(e) {
    c.close();
    window.gui.openContextualMenu("monster", e, u);
  }
  function a(e) {
    c.close();
    window.gui.openContextualMenu("prism", e, u);
  }
  function l(e) {
    c.close();
    e.mapId = window.isoEngine.mapRenderer.map.id;
    window.gui.openContextualMenu("taxCollector", e, u);
  }
  var c = this;
  this.playersList.clearContent();
  var d = e.actors,
    u = e.coordinates,
    h = e.npc,
    p = e.monster;
  if (h) {
    switch (h.data.type) {
      case "GameRolePlayPrismInformations":
        this.playersList.appendChild(new s({
          text: h.data.npcData.nameId + " [" + h.data.prism.alliance.allianceTag + "]",
          className: "cmButton"
        }, a.bind(null, h.data)));
        break;
      case "GameRolePlayTaxCollectorInformations":
        this.playersList.appendChild(new s({
          text: r("ui.common.taxCollector"),
          className: "cmButton"
        }, l.bind(null, h.data)));
        break;
      case "GameRolePlayNpcInformations":
      case "GameRolePlayNpcWithQuestInformations":
        this.playersList.appendChild(new s({
          text: r("tablet.npc.cell", h.data.npcData.nameId),
          className: "cmButton"
        }, n.bind(null, h)));
        break;
      default:
        return;
    }
  }
  if (p) {
    var m = p.data || {},
      f = m.staticInfos || {},
      g = f.mainCreatureLightInfos || {};
    g.staticInfos ? this.playersList.appendChild(new s({
      text: r("tablet.monster.cell", g.staticInfos.nameId),
      className: "cmButton"
    }, o.bind(null, m))) : console.error(new Error("Not a monster, type " + m.type));
  }
  for (var _ = 0; _ < d.length; _ += 1) {
    var v = d[_];
    v.data && v.data.playerId ? this.playersList.appendChild(new s({
      text: v.data.name,
      className: "cmButton"
    }, i.bind(null, v))) : console.warn("ContextualMenuPlayersList: skipped actor:", v.actorId);
  }
  t();
};
this.playersList = e.createChild("div", {
  className: "playersList"
});
this._addCancel();
c.close();
e.openPlayerContextualMenu(u);
c.close();
e.openNpcContextualMenu(u);
c.close();
window.gui.openContextualMenu("monster", e, u);
c.close();
window.gui.openContextualMenu("prism", e, u);
c.close();
e.mapId = window.isoEngine.mapRenderer.map.id;
window.gui.openContextualMenu("taxCollector", e, u);
l.forEach(function (e) {
  e.terminate();
});
l = [];
c = null;
window.gui.on("connected", n);
window.gui.on("disconnect", o);
e.exports = i;
i.prototype.rememberPopupTime = function () {
  this._lastPopupTime = Date.now();
};
i.prototype.getLastPopupTime = function () {
  return this._lastPopupTime;
};
this._name = e.configName;
this._coordinator = t;
this._sugTimeout = null;
this._maxFrequency = c;
this._averageDelay = d;
this._delayDelta = u;
this._suggestion = new e(this);
e.exports = n;
n.prototype.terminate = function () {
  s.clearTimeout(this._sugTimeout);
  this._suggestion.terminate();
};
n.prototype.setOptions = function (e) {
  e.maxFrequencyMs && (this._maxFrequency = e.maxFrequencyMs);
  e.averageDelayMs && (this._averageDelay = e.averageDelayMs);
};
n.prototype.takeNoteOfTriggeringEvent = function () {
  r.setValue(p + this._name, Date.now());
};
n.prototype.takeNoteOfPlayerChoice = function () {
  r.setValue(m + this._name, Date.now());
};
n.prototype.getLastProposedTime = function () {
  return r.getValue(m + this._name) || 0;
};
n.prototype._canSuggestionBeProposed = function () {
  if (window.gui.playerData.characterBaseInformations.level < 40) {
    return !1;
  }
  var e = r.getValue(p + this._name);
  if (!e) {
    return !1;
  }
  var t = r.getValue(m + this._name) || 0;
  return !(t > e) && !(Date.now() - t < this._maxFrequency);
};
n.prototype.scheduleCheck = function () {
  this._sugTimeout && s.clearTimeout(this._sugTimeout);
  var e = Math.max(0, this._averageDelay - this._delayDelta),
    t = this._averageDelay + this._delayDelta,
    i = o(e, t);
  this._sugTimeout = s.setTimeout(this._doCheckOrReschedule.bind(this), i);
};
n.prototype._doCheckOrReschedule = function () {
  return this._sugTimeout = null, window.gui.playerData.isFighting ? this.scheduleCheck() : Date.now() - this._coordinator.getLastPopupTime() < h ? this.scheduleCheck() : void (this._canSuggestionBeProposed() && this._suggestion.checkAndShowSuggestion());
};
n.prototype.showPopup = function (e, t) {
  this._coordinator.rememberPopupTime();
  var i = this;
  window.gui.openConfirmPopup({
    title: a("tablet.suggestion"),
    buttonNoLabel: a("ui.connection.notNow"),
    message: e,
    cb: function (e) {
      i.takeNoteOfPlayerChoice(e ? "Y" : "N");
      e && t();
    }
  });
};
s.clearTimeout(this._sugTimeout);
this._suggestion.terminate();
e.maxFrequencyMs && (this._maxFrequency = e.maxFrequencyMs);
e.averageDelayMs && (this._averageDelay = e.averageDelayMs);
i.takeNoteOfPlayerChoice(e ? "Y" : "N");
e && t();
this._controller = e;
this._controller.setOptions({
  maxFrequencyMs: 3 * h,
  averageDelayMs: 5 * u
});
this._eventListener = new s();
this._initializeOnConnect();
r.changeValue("systemNotificationsEnabled", !0);
d.open("options", {
  tab: "notification"
});
e.exports = n;
n.configName = "AllNotif";
n.prototype._initializeOnConnect = function () {
  r.systemNotificationsEnabled ? this._controller.takeNoteOfPlayerChoice() : (this._controller.takeNoteOfTriggeringEvent(), this._controller.scheduleCheck());
};
n.prototype.terminate = function () {
  this._eventListener.stopListening();
};
n.prototype.checkAndShowSuggestion = function () {
  c.isAvailable() && (r.systemNotificationsEnabled || (a.isAndroid && !this._controller.getLastProposedTime() ? (this._controller.takeNoteOfPlayerChoice("F"), r.changeValue("systemNotificationsEnabled", !0)) : this._controller.showPopup(l("tablet.proposeAllNotif"), o)));
};
e.exports = i;
i.prototype.listenTo = function (e, t, i) {
  return this._handlerMap[t] ? console.error("dupe listener: " + e.constructor.name + " on " + t) : (this._handlerMap[t] = [e, i], void e.on(t, i));
};
i.prototype.stopListening = function () {
  for (var e in this._handlerMap) {
    var t = this._handlerMap[e];
    t[0].removeListener(e, t[1]);
  }
  this._handlerMap = {};
};
t.isAvailable = function () {
  return Boolean(o);
};
t.enable = function (e) {
  if (!o || s) {
    return e();
  }
  var t = window.Config.notification;
  if (!t) {
    return e("No notification config");
  }
  s = !0;
  document.addEventListener("push-notification", n, !1);
  var i = t.push;
  o.onDeviceReady({
    appid: i.appId,
    projectid: i.projectId,
    serviceName: ""
  });
  o.setUserId(window.gui.playerData.accountCapabilities.accountId.toString());
  o.registerDevice(function (t) {
    console.info("Registered device for push notifications: ", t.pushToken);
    window.gui.playerData.setPushToken(t.pushToken);
    e();
  }, function (t) {
    window.gui.playerData.setPushToken("");
    e("Error registering push notifications: " + t);
  });
};
t.disable = function (e) {
  return o && s ? (s = !1, document.removeEventListener("push-notification", n, !1), void o.unregisterDevice(function () {
    console.info("Unregistered push notifications");
    window.gui.playerData.setPushToken("");
    e();
  }, function (t) {
    window.gui.playerData.setPushToken("");
    e("Error unregistering push notifications: " + t.error);
  })) : e();
};
t.setCustomTags = function (e) {
  o && s && o.setTags(e, function () {
    console.info("setTags success for: ", Object.keys(e));
  }, function (t) {
    console.error("setTags failed for " + Object.keys(e).join(",") + ": " + t);
  });
};
s = !0;
document.addEventListener("push-notification", n, !1);
o.onDeviceReady({
  appid: i.appId,
  projectid: i.projectId,
  serviceName: ""
});
o.setUserId(window.gui.playerData.accountCapabilities.accountId.toString());
o.registerDevice(function (t) {
  console.info("Registered device for push notifications: ", t.pushToken);
  window.gui.playerData.setPushToken(t.pushToken);
  e();
}, function (t) {
  window.gui.playerData.setPushToken("");
  e("Error registering push notifications: " + t);
});
console.info("Registered device for push notifications: ", t.pushToken);
window.gui.playerData.setPushToken(t.pushToken);
e();
window.gui.playerData.setPushToken("");
e("Error registering push notifications: " + t);
console.info("Unregistered push notifications");
window.gui.playerData.setPushToken("");
e();
window.gui.playerData.setPushToken("");
e("Error unregistering push notifications: " + t.error);
this._controller = e;
this._eventListener = new s();
this._initializeOnConnect();
r.changeValue("systemNotificationsEnabled", !0);
r.changeValue("wantPrismAttackedNotif", !0);
r.changeValue("wantPrismVulnerableNotif", !0);
h.open("options", {
  tab: "notification"
});
e.exports = n;
n.configName = "Prism";
n.prototype._initializeOnConnect = function () {
  this._controller.scheduleCheck();
  this._eventListener.listenTo(u, "receivedServerFlag", this._onReceivedServerFlag.bind(this));
  this._eventListener.listenTo(d, "entityUpdated", this._onEntityUpdate.bind(this));
};
n.prototype.terminate = function () {
  this._eventListener.stopListening();
};
n.prototype._onReceivedServerFlag = function (e) {
  "MISSED_PRISM_NOTIF" === e && o() && (this._controller.takeNoteOfTriggeringEvent(), this._controller.scheduleCheck());
};
n.prototype._onEntityUpdate = function (e) {
  e === d.entityType.prism && o() && (this._controller.takeNoteOfTriggeringEvent(), this._controller.scheduleCheck());
};
n.prototype.checkAndShowSuggestion = function () {
  this._controller.showPopup(l("tablet.proposePrismNotif"), a);
};
this._controller.scheduleCheck();
this._eventListener.listenTo(u, "receivedServerFlag", this._onReceivedServerFlag.bind(this));
this._eventListener.listenTo(d, "entityUpdated", this._onEntityUpdate.bind(this));
v = !1;
T.disable(function (e) {
  e && console.error("Trouble while disabling pushNotifications: " + e);
});
M.disable(function (e) {
  e && console.error("Trouble while disabling localNotifications: " + e);
});
w[N] || e.push(O);
w.wantPrismAttackedNotif && e.push(R);
w.wantPrismVulnerableNotif && e.push(D);
console.error("Failed to enable systemNotifications: " + e);
window.gui.openSimplePopup(b("tablet.notification.cannotEnable"));
w.changeValue(N, !1, E);
n();
i[e] = t;
T.setCustomTags(i);
r("Wants Promo", w.wantPromoNotif);
r("currently_subscribed", e.isSubscriberAtMinLevel(S.NORMAL));
e.characterBaseInformations.name && r("last_character_name", e.characterBaseInformations.name);
e.characterBaseInformations.breed && r("class_id", e.characterBaseInformations.breed);
e.guildData.current && r("guild_name", e.guildData.current.guildName);
t > 0 && r("level_achieved", t);
v = !0;
T.enable(function (e) {
  return e ? a(e) : (l(), void M.enable(function (e) {
    if (e) {
      return a(e);
    }
  }));
});
o();
d(w[N]);
w.changeValue("offlineOptionTimestamp", Date.now(), E);
o();
w.changeValue(N, n.indexOf(O) === -1, E);
w.changeValue("wantPrismAttackedNotif", n.indexOf(R) !== -1, E);
w.changeValue("wantPrismVulnerableNotif", n.indexOf(D) !== -1, E);
n.indexOf(P) !== -1 && (k.emit("receivedServerFlag", "MISSED_PRISM_NOTIF"), h());
d(e);
"OptionsWindow" === i && C.getWindow("options").refreshUi();
m(e, t, i);
l();
m(e, t, i);
t.on("connected", u);
e.on("OfflineOptionsMessage", function (e) {
  p(e.options);
});
w.on(N, f);
w.on("wantPromoNotif", g);
w.on("wantPrismAttackedNotif", m);
w.on("wantPrismVulnerableNotif", m);
i.on("characterSelectedSuccess", l);
i.guildData.on("guildJoin", l);
i.on("characterLevelUp", l);
e.exports = k;
k.initialize = function () {
  _();
};
k.isAvailable = function () {
  return T.isAvailable() || M.isAvailable();
};
k.isEnabled = function () {
  return v;
};
k.sendTagLandedAstrub = function () {
  r("arrive_astrub", !0);
};
k.sendTagAlbueraVillageDiscovered = function () {
  r("albuera_village_discover", !0);
};
k.sendTagAlbueraForestDiscovered = function () {
  r("albuera_forest_discovered", !0);
};
k.sendTagAlbueraDungeonDone = function () {
  r("belladone_dungeon_achieved", !0);
};
k.sendTagAlbueraStarterPackBought = function () {
  r("new_starter_pack_purchase", !0);
};
i.on("itemsCleared", function () {
  b = 0;
});
i.on("itemAdded", function (e) {
  d(e.quantity);
});
i.on("itemRemoved", function (e) {
  d(-e.quantity);
});
i.on("itemQuantityChanged", function (e, t) {
  d(e.quantity - t);
});
h.on("wantPetFeedingNotif", function (e) {
  e ? c() : l();
});
h.on("petFeedingNotifTime", function () {
  c();
});
window.gui.playerData.on("subscriptionChanged", function () {
  s();
});
u.on("trigger", a);
i.setHours(t[0]);
i.setMinutes(t[1]);
i.setSeconds(0);
i < Date.now() && i.setTime(i.getTime() + _);
M = e;
u.schedule({
  id: f.petFeeding,
  title: p("tablet.notification.petFeedingTimeTitle"),
  text: p("tablet.notification.petFeedingTime", e),
  every: "day",
  at: i
});
l();
h.wantPetFeedingNotif && h.petFeedingNotifTime && 0 !== b && r(b);
b += e;
b !== M && (b > 1 && M > 1 || c());
t.isAvailable = function () {
  return !!u || n();
};
t.enable = function (e) {
  return !n() || y ? e() : (y = !0, void u.hasPermission(function (t) {
    if (t) {
      w || o();
      var i = null;
      try {
        c();
        console.info("Registered for local notifications");
      } catch (n) {
        i = n;
      }
      return e(i);
    }
    return e("NO_PERMISSION");
  }));
};
t.disable = function (e) {
  return n() && y ? (y = !1, u.cancelAll(), console.info("Unregistered local notifications"), void e()) : e();
};
c();
console.info("Registered for local notifications");
this.inventory = e;
this.filterFunc = t;
this._startListening();
a(n, o);
e.exports = n;
n.prototype._startListening = function () {
  this.inventory.on("listUpdate", this._onReset.bind(this));
  this.inventory.on("itemsAdded", this._onMapOfItemAdded.bind(this));
  this.inventory.on("itemAdded", this._onItemAdded.bind(this));
  this.inventory.on("itemDeleted", this._onItemRemoved.bind(this));
  this.inventory.on("itemsDeleted", this._onMapOfItemRemoved.bind(this));
  this.inventory.on("itemQuantity", this._onQuantityChanged.bind(this));
  this.inventory.on("itemsQuantity", this._onMapOfQuantityChanged.bind(this));
  this.inventory.on("itemModified", this._onItemChanged.bind(this));
};
n.prototype._onReset = function (e) {
  this.emit("itemsCleared");
  this._onMapOfItemAdded(e);
};
n.prototype._onItemAdded = function (e) {
  this.filterFunc && !this.filterFunc(e) || this.emit("itemAdded", e);
};
n.prototype._onMapOfItemAdded = function (e) {
  for (var t in e) {
    this._onItemAdded(e[t]);
  }
};
n.prototype._onItemRemoved = function (e, t) {
  this.filterFunc && !this.filterFunc(t) || this.emit("itemRemoved", t);
};
n.prototype._onMapOfItemRemoved = function (e, t) {
  for (var i in t) {
    this._onItemRemoved(i, t[i]);
  }
};
n.prototype._onQuantityChanged = function (e, t, i) {
  var n = this.inventory.objects[e];
  if (!this.filterFunc || this.filterFunc(n)) {
    return !t || !i || i < 0 ? console.error("invalid quantity change from " + i + " to " + t) : void this.emit("itemQuantityChanged", n, i);
  }
};
n.prototype._onMapOfQuantityChanged = function (e, t) {
  for (var i in e) {
    this._onQuantityChanged(i, e[i], t[i]);
  }
};
n.prototype._onItemChanged = function (e) {
  this.filterFunc && !this.filterFunc(e) || this.emit("itemChanged", e);
};
this.inventory.on("listUpdate", this._onReset.bind(this));
this.inventory.on("itemsAdded", this._onMapOfItemAdded.bind(this));
this.inventory.on("itemAdded", this._onItemAdded.bind(this));
this.inventory.on("itemDeleted", this._onItemRemoved.bind(this));
this.inventory.on("itemsDeleted", this._onMapOfItemRemoved.bind(this));
this.inventory.on("itemQuantity", this._onQuantityChanged.bind(this));
this.inventory.on("itemsQuantity", this._onMapOfQuantityChanged.bind(this));
this.inventory.on("itemModified", this._onItemChanged.bind(this));
this.emit("itemsCleared");
this._onMapOfItemAdded(e);
L = !0;
window.gui.openSimplePopup(w("ui.common.cantSelectThisCharacter"), w("ui.popup.impossible_action"));
v || window.dofus.sendMessage("CharactersListRequestMessage");
x = !1;
L = !1;
O = [];
i.canRebreed = u(s.rebreed, r.rebreed);
i.canRecolor = u(s.recolor, r.recolor);
i.canReface = u(s.relook, r.relook);
i.canRename = u(s.rename, r.rename);
i.canRegender = u(s.regender, r.regender);
n = !0;
v.canRename && (e.infos.name = y.name);
v.canRebreed && (e.infos.entityLook = y.remodelingInformation.entityLook);
v.canRecolor && (e.infos.entityLook.indexedColors = y.colors);
v.canReface && (e.infos.entityLook.skins[1] = y.headSkin);
L = !1;
M.close("characterSelection");
v && y && (M.close("characterCreation"), f(e));
window.gui.onConnect(e.infos);
window.actorManager.setUserCharacterData(e.infos);
m(e.infos);
window.dofus.sendMessage("ClientKeyMessage", {
  key: R
});
window.dofus.sendMessage("GameContextCreateRequestMessage");
t.confirmNewCharacterCreation = function () {
  x = !0;
  N.characterCreation();
};
t.confirmCharacterRelooking = function (e) {
  var t = v.characterToRemodel.id;
  y = e;
  window.dofus.sendMessage("CharacterSelectionWithRemodelMessage", {
    id: t,
    remodel: y.remodelingInformation
  });
};
t.selectCharacter = function (e) {
  if (!p(e)) {
    return e < 1 ? void console.error(new Error("characterSelection: characterId should be positive")) : void window.dofus.sendMessage("CharacterSelectionMessage", {
      id: e
    });
  }
};
t.backToSelection = function () {
  return M.closeAll(), 0 === O.length ? M.open("serverSelection") : void M.open("characterSelection", O);
};
t.initialize = function (e) {
  var t = window.dofus.connectionManager;
  t.on("CharacterSelectedForceMessage", function () {
    window.dofus.sendMessage("CharacterSelectedForceReadyMessage");
  });
  t.on("CharactersListMessage", l);
  t.on("CharactersListWithRemodelingMessage", l);
  t.on("CharacterSelectedSuccessMessage", g);
  t.on("CharacterSelectedErrorMessage", s);
  e.on("disconnect", c);
};
t.getCharacterList = function () {
  return O;
};
x = !0;
N.characterCreation();
y = e;
window.dofus.sendMessage("CharacterSelectionWithRemodelMessage", {
  id: t,
  remodel: y.remodelingInformation
});
t.on("CharacterSelectedForceMessage", function () {
  window.dofus.sendMessage("CharacterSelectedForceReadyMessage");
});
t.on("CharactersListMessage", l);
t.on("CharactersListWithRemodelingMessage", l);
t.on("CharacterSelectedSuccessMessage", g);
t.on("CharacterSelectedErrorMessage", s);
e.on("disconnect", c);
this._controller = e;
this._eventListener = new a();
this._initializeOnConnect();
s.changeValue("wantPromoNotif", !0);
s.changeValue("systemNotificationsEnabled", !0);
c.open("options", {
  tab: "notification"
});
e.exports = n;
n.configName = "Promo";
n.prototype._initializeOnConnect = function () {
  var e = window.dofus.connectionManager,
    t = this;
  this._controller.scheduleCheck();
  this._eventListener.listenTo(e, "shopBuySuccess", function () {
    t._controller.takeNoteOfTriggeringEvent();
  });
  this._eventListener.listenTo(c, "close", function (e) {
    "market" === e.id && t._controller.scheduleCheck();
  });
};
n.prototype.terminate = function () {
  this._eventListener.stopListening();
};
n.prototype.checkAndShowSuggestion = function () {
  l.isAvailable() && (s.systemNotificationsEnabled && s.wantPromoNotif || this._controller.showPopup(r("tablet.proposePromoNotif"), o));
};
this._controller.scheduleCheck();
this._eventListener.listenTo(e, "shopBuySuccess", function () {
  t._controller.takeNoteOfTriggeringEvent();
});
this._eventListener.listenTo(c, "close", function (e) {
  "market" === e.id && t._controller.scheduleCheck();
});
this._setDimensions(0, 0, 0, 0);
this.clear();
this.lastUpdateTime = 0;
this.x = e;
this.y = t;
this.width = i;
this.height = n;
this.boxType = o;
this.actorId = a;
this.priority = g[o];
this.angle = null;
g[d] = 1;
g[u] = 10;
g[h] = 20;
g[p] = 30;
_[h] = 50;
_[p] = 200;
_[u] = 400;
e.exports = n;
n.prototype.initialize = function (e, t, i, n) {
  this._setDimensions(e, t, i, n);
  this.clear();
  var o = this;
  window.gui.on("resize", function (e) {
    o._setDimensions(e.mapLeft, e.mapTop, e.mapWidth, e.mapHeight);
  });
  window.isoEngine.on("mapLoaded", function (e) {
    e && e.isReload || o.clear();
  });
};
n.prototype.clear = function () {
  this.boxes = [];
};
n.prototype._setDimensions = function (e, t, i, n) {
  this.originX = e;
  this.originY = t;
  this.width = i;
  this.height = n;
};
o.prototype.intersectingSurface = function (e) {
  if (e.x + e.width <= this.x || e.x >= this.x + this.width) {
    return 0;
  }
  if (e.y + e.height <= this.y || e.y >= this.y + this.height) {
    return 0;
  }
  var t = Math.min(this.x + this.width, e.x + e.width) - Math.max(this.x, e.x),
    i = Math.min(this.y + this.height, e.y + e.height) - Math.max(this.y, e.y);
  return t * i;
};
o.prototype.setAsSubboxOf = function (e) {
  this.priority = _[e.boxType];
  var t = this.x + this.width / 2,
    i = this.y + this.height / 2,
    n = e.x + e.width / 2,
    o = e.y + e.height / 2;
  this.angle = Math.atan2(o - i, n - t);
};
o.prototype.getCenter = function () {
  return [this.x + this.width / 2, this.y + this.height / 2];
};
this._setDimensions(e, t, i, n);
this.clear();
window.gui.on("resize", function (e) {
  o._setDimensions(e.mapLeft, e.mapTop, e.mapWidth, e.mapHeight);
});
window.isoEngine.on("mapLoaded", function (e) {
  e && e.isReload || o.clear();
});
this.originX = e;
this.originY = t;
this.width = i;
this.height = n;
n.prototype._moveBoxAround = function (e, t, i) {
  var n, o;
  switch (i) {
    case 0:
      n = t.x + t.width - y;
      o = t.y - e.height;
      break;
    case 1:
      n = t.x - e.width + y;
      o = t.y - e.height;
      break;
    case 2:
      n = t.x - e.width + y;
      o = t.y + t.height;
      break;
    case 3:
      n = t.x + t.width - y;
      o = t.y + t.height;
      break;
    default:
      return console.error(new Error("invalid _moveBoxAround index" + i));
  }
  e.x = Math.round(n);
  e.y = Math.round(o);
};
n.prototype._computeWeight = function (e, t, i) {
  if (e.x < this.originX + l || e.y < this.originY + l) {
    return 1 / 0;
  }
  if (e.x + e.width > this.originX + this.width - l || e.y + e.height > this.originY + this.height - l) {
    return 1 / 0;
  }
  for (var n = 0, o = this.boxes.length - 1; o >= 0; o--) {
    var a = this.boxes[o];
    if (a !== t) {
      var s = e.intersectingSurface(a);
      if (s) {
        if (!a.priority) {
          return 1 / 0;
        }
        if (n += s / a.priority, n >= i) {
          return n;
        }
      }
    }
  }
  return n;
};
n.prototype._recenterBox = function (e) {
  if (0 !== r.mapWidth && 0 !== r.mapHeight) {
    var t = Math.max(r.mapLeft + f.LEFT - e.x, 0),
      i = Math.max(e.x + e.width - (r.mapLeft + r.mapWidth + f.RIGHT), 0),
      n = Math.max(r.mapTop + f.TOP - e.y, 0),
      o = Math.max(e.y + e.height - (r.mapTop + r.mapHeight + f.BOTTOM), 0);
    e.x = e.x - i + t;
    e.y = e.y + n - o;
  }
};
n.prototype._addBoxNextToTarget = function (e, t, i) {
  for (var n = new o(0, 0, t, i, m), a = 1 / 0, s = 0, r = 0; r < v; r++) {
    this._moveBoxAround(n, e, r);
    var l = this._computeWeight(n, e, a);
    if (l < a && (a = l, s = r, 0 === l)) {
      break;
    }
  }
  return 0 !== a && this._moveBoxAround(n, e, s), n.x += 2 * c * (Math.random() - .5), n.y += 2 * c * (Math.random() - .5), this._recenterBox(n), n.setAsSubboxOf(e), this.boxes.push(n), n;
};
n.prototype._newActorBox = function (e, t) {
  var i = window.foreground,
    n = a(e),
    r = i.convertSceneToScreenCoordinate(n[0], n[2]),
    l = i.convertSceneToScreenCoordinate(n[1], n[3]),
    c = l.x - r.x,
    d = l.y - r.y,
    u = s.getCoordinatesRelativeToBody(r.x, r.y),
    h = new o(u.x, u.y, c, d, t, e.actorId);
  return this.boxes.push(h), h;
};
n.prototype.addBoxNextToActor = function (e, t) {
  this._updateActors();
  var i = this._getActorBox(e);
  i || (i = this._newActorBox(e, p));
  var n = t.rootElement;
  return this._addBoxNextToTarget(i, n.clientWidth, n.clientHeight);
};
n.prototype.addObstacle = function (e, t, i, n) {
  var a = new o(e, t, i, n, d);
  return this.boxes.push(a), a;
};
n.prototype.removeBox = function (e) {
  var t = this.boxes.indexOf(e);
  t < 0 || this.boxes.splice(t, 1);
};
n.prototype._removeActors = function () {
  for (var e = [], t = this.boxes.length - 1; t >= 0; t--) {
    var i = this.boxes[t];
    i.actorId || e.push(i);
  }
  this.boxes = e;
};
n.prototype._updateActors = function () {
  this.lastUpdateTime = Date.now();
  this._removeActors();
  this._newActorBox(window.actorManager.userActor, u);
  var e = window.actorManager.actors;
  for (var t in e) {
    var i = e[t],
      n = i.data;
    n && !n.staticInfos && this._newActorBox(i, i.isNPC() ? h : p);
  }
};
n.prototype._getActorBox = function (e) {
  for (var t = e.actorId, i = this.boxes.length - 1; i >= 0; i--) {
    var n = this.boxes[i];
    if (n.actorId === t) {
      return n;
    }
  }
  return null;
};
n = t.x + t.width - y;
o = t.y - e.height;
n = t.x - e.width + y;
o = t.y - e.height;
n = t.x - e.width + y;
o = t.y + t.height;
n = t.x + t.width - y;
o = t.y + t.height;
e.x = Math.round(n);
e.y = Math.round(o);
e.x = e.x - i + t;
e.y = e.y + n - o;
this.lastUpdateTime = Date.now();
this._removeActors();
this._newActorBox(window.actorManager.userActor, u);
s.call(this, "div", {
  className: "ChallengeIndicator",
  hidden: !0
});
r(this);
this.firstTimeDisplayed = !0;
this.challengeSlot = this.createChild("div", {
  className: "challengeSlot"
});
this.iconDetailsListByChallengeId = {};
this.challengesResult = {};
this._hookupEvents(window.gui);
a(n, s);
e.exports = n;
n.prototype._hookupEvents = function (e) {
  var t = this;
  e.on("ChallengeInfoMessage", function (e) {
    t.setChallenge(e);
  });
  e.on("ChallengeResultMessage", function (e) {
    return t.iconDetailsListByChallengeId[e.challengeId] ? void t.setChallengeResult(e) : void (t.challengesResult[e.challengeId] = e);
  });
  h.on("ChallengeTargetsListMessage", function (e) {
    u(e);
  });
  e.on("GameFightEndMessage", function () {
    t.hide();
    t.reset();
  });
  e.on("GameFightJoinMessage", function () {});
  e.on("disconnect", function () {
    t.hide();
    t.reset();
  });
};
n.prototype.updateDescriptionWithFighter = function (e, t) {
  var i = e.name + " (" + l("ui.common.level") + " " + e.level + ")",
    n = t._description.replace("%1", i);
  return n;
};
n.prototype.setChallenge = function (e) {
  var t,
    i = this,
    n = window.gui.fightManager.getFighter(e.targetId);
  t = n ? this.updateDescriptionWithFighter(n, e) : e._description;
  var o = "none",
    a = e.challengeId;
  d.preloadImage("gfx/challenges/" + a + ".png", function (s) {
    o = s;
    var r = i.setupIconGUI(e._name, t || e._description, e.dropBonus, e.xpBonus, a, e._points, o);
    i.iconDetailsListByChallengeId[a] = {
      icon: r.icon,
      details: r.details,
      iconUrl: o,
      success: e.success,
      name: e._name,
      description: t,
      dropBonus: e.dropBonus,
      xpBonus: e.xpBonus,
      targetFighter: n,
      points: e._points
    };
    var l = i.challengesResult[a];
    l && i.setChallengeResult(l);
  });
};
n.prototype.setupIconGUI = function (e, t, i, n, a, r, d) {
  function u() {
    var e = [805, 815],
      t = window.gui.playerData.position.subArea,
      i = t && t.id,
      n = e.indexOf(i) !== -1;
    return r && n;
  }
  var h = this.challengeSlot.createChild("div", {
      className: "challengeBg"
    }),
    p = h.createChild("div", {
      className: "challengeIcon"
    });
  h.challengeState = p.createChild("div", {
    className: "challengeState"
  });
  var m = new s("div", {
    className: "challengeDetails",
    name: "challengeDetails"
  });
  return m.challengeName = m.createChild("div", {
    className: "challengeName",
    text: e
  }), m.challengeDesc = m.createChild("div", {
    className: "challengeDesc",
    text: t
  }), m.challengeLoot = m.createChild("div", {
    className: "challengeLoot",
    text: l("ui.common.loot") + " +" + i + "%"
  }), m.challengeXp = m.createChild("div", {
    className: "challengeXp",
    text: l("ui.common.xp") + " +" + n + "%"
  }), u() && (m.challengePoints = m.createChild("div", {
    className: "challengePoints",
    text: r + " " + l("ui.common.point", r)
  })), m.challengeStatus = m.createChild("div", {
    className: "challengeStatus",
    text: l("ui.fight.challenge.inProgress")
  }), c.addTooltip(p, m, {
    longTapExplanation: !0
  }), p.on("tap", function () {
    window.dofus.sendMessage("ChallengeTargetsListRequestMessage", {
      challengeId: a
    });
  }), p.setStyle("backgroundImage", d), this.show(), this.firstTimeDisplayed && (this.firstTimeDisplayed = !1, this.setStyle("left", o.mapLeft + "px")), {
    icon: h,
    details: m
  };
};
n.prototype.setChallengeResult = function (e) {
  var t = this.iconDetailsListByChallengeId[e.challengeId];
  e.success ? (t.icon.challengeState.addClassNames("success"), t.details.challengeStatus.addClassNames("success"), t.details.challengeStatus.setText(l("ui.fight.challenge.complete"))) : (t.icon.challengeState.addClassNames("fail"), t.details.challengeStatus.addClassNames("fail"), t.details.challengeStatus.setText(l("ui.fight.challenge.failed")));
  t.success = e.success;
};
n.prototype.reset = function () {
  for (var e in this.iconDetailsListByChallengeId) {
    this.iconDetailsListByChallengeId[e].icon.destroy();
    this.iconDetailsListByChallengeId[e].details.destroy();
    delete this.iconDetailsListByChallengeId[e];
  }
  this.challengesResult = {};
};
e.on("ChallengeInfoMessage", function (e) {
  t.setChallenge(e);
});
e.on("ChallengeResultMessage", function (e) {
  return t.iconDetailsListByChallengeId[e.challengeId] ? void t.setChallengeResult(e) : void (t.challengesResult[e.challengeId] = e);
});
h.on("ChallengeTargetsListMessage", function (e) {
  u(e);
});
e.on("GameFightEndMessage", function () {
  t.hide();
  t.reset();
});
e.on("GameFightJoinMessage", function () {});
e.on("disconnect", function () {
  t.hide();
  t.reset();
});
t.hide();
t.reset();
t.hide();
t.reset();
e.success ? (t.icon.challengeState.addClassNames("success"), t.details.challengeStatus.addClassNames("success"), t.details.challengeStatus.setText(l("ui.fight.challenge.complete"))) : (t.icon.challengeState.addClassNames("fail"), t.details.challengeStatus.addClassNames("fail"), t.details.challengeStatus.setText(l("ui.fight.challenge.failed")));
t.success = e.success;
this.iconDetailsListByChallengeId[e].icon.destroy();
this.iconDetailsListByChallengeId[e].details.destroy();
delete this.iconDetailsListByChallengeId[e];
t.isFullScreen ? (p = 0, f = 0, m = o.screenWidth, g = o.screenHeight) : (p = o.mapLeft, f = o.mapTop, m = o.mapRight, g = o.mapBottom);
h();
M > C ? M = C : M < A && (M = A);
T > I ? T = I : T < S && (T = S);
r();
E = M === A;
N = T === S;
x = M === C;
L = T === I;
e.toggleClassName("magnetLeft", E);
e.toggleClassName("magnetTop", N);
e.toggleClassName("magnetRight", x);
e.toggleClassName("magnetBottom", L);
e.toggleClassName("magnetFloating", !(E || N || x || L));
E && (M = A);
N && (T = S);
x && (M = C);
L && (T = I);
e.setStyles({
  webkitTransform: "",
  left: M + "px",
  top: T + "px",
  right: "initial",
  bottom: "initial"
});
r();
c();
e.delClassNames("dragging");
e.emit("dragEnd");
O = !1;
d() && (n(), l(), c());
_.on("slideStart", function (t) {
  v = t.x;
  y = t.y;
  d();
  w = M;
  b = T;
  e.addClassNames("dragging");
  e.emit("dragStart");
});
_.on("slide", function (t) {
  M = w + t.x - v;
  T = b + t.y - y;
  n();
  var i = M - w,
    o = T - b;
  e.setStyle("webkitTransform", "translate3d(" + i + "px, " + o + "px, 0)");
});
_.on("slideEnd", u);
_.on("slideCancel", u);
v = t.x;
y = t.y;
d();
w = M;
b = T;
e.addClassNames("dragging");
e.emit("dragStart");
M = w + t.x - v;
T = b + t.y - y;
n();
i();
window.gui.on("resize", i);
e.on("destroy", function () {
  window.gui.removeListener("resize", i);
});
t.isCollapsable && (_.createChild("div", {
  className: "collapseBtn"
}), s(_), _.on("tap", function () {
  e.collapse(!e.isCollapsed);
}), e.isCollapsed = !1, e.collapse = function (t, i) {
  e.isCollapsed = t;
  e.toggleClassName("collapsed", t);
  O = !0;
  i || e.emit("collapse", t);
  O && h();
});
e.on("resized", h);
e.isCollapsed = t;
e.toggleClassName("collapsed", t);
O = !0;
i || e.emit("collapse", t);
O && h();
P.call(this, "div", {
  className: "chat"
});
this.displayMode = $.ROLEPLAY;
this.keyboardHeight = .6 * v.screenHeight;
this.linkHelper = new S();
this.p2p = new E();
this.censor = new H();
this.presets = null;
this.channelMap = window.gui.databases.ChatChannels;
this.numPresetsListeningToChannel = null;
this.historyBuffers = {};
this.historyBuffers[j] = new C(te);
this._initializeElements();
this._setMessageHandlers();
Z[u.PSEUDO_CHANNEL_FIGHT_LOG] = !0;
Z[u.PSEUDO_CHANNEL_NPC_LOG] = !0;
I(z, P);
I(n, z);
e.exports = n;
n.prototype._initializeAtConnection = function () {
  this.setDisplayMode($.ROLEPLAY);
  this.chatInput.initializeAtConnection();
  this._clearChatHistory();
};
n.prototype._initializeEnabledChannels = function (e, t) {
  this.chatInput.initializeEnabledChannels(e, t);
  this._loadPresetConfig();
  this._setActivePreset(V);
};
n.prototype._clearChatHistory = function () {
  this._logChat.clearContent();
  for (var e in this.historyBuffers) {
    this.historyBuffers[~~e].clear();
  }
  this.chatInput.clearSentMessageHistory();
};
n.prototype._initializeElements = function () {
  var e = this;
  this.logWrapper = this.createChild("div", {
    className: "logWrapper"
  });
  this.fightControls = this.logWrapper.createChild("div", {
    className: "fightControls"
  });
  this.timelineBox = this.fightControls.createChild("div", {
    className: "timelineBox"
  });
  var t = this.fightControls.createChild("div", {
      className: "fightButtons"
    }),
    i = new y("", {
      className: "yourTurnButton",
      hidden: !0
    }, function () {
      e.deactivate();
    }),
    n = this.createChild("div", {
      className: "yourTurnText"
    });
  n.setText(M("tablet.chat.yourTurnButton"));
  i.appendChild(n);
  this.yourTurnButton = t.appendChild(i);
  this.chatInput = new p(this.logWrapper, this.linkHelper);
  this.logWrapper.appendChild(new R({
    className: ["simpleButton", "chatCloseButton"]
  }, function () {
    e.deactivate();
  }));
  k(this.logWrapper, {
    minWidth: W,
    minHeight: G,
    eventOnResize: !0
  });
  this.logWrapper.on("resize", function () {
    e.displayMode === $.FIGHT ? O.setValue("ChatHeightForFight", e.logWrapper.windowHeight) : O.setValue("ChatForRP", {
      width: e.logWrapper.windowWidth,
      height: e.logWrapper.windowHeight
    });
    O.saveNow();
    e._refreshScroller();
  });
  this.logWrapper.on("resizeMove", function (t) {
    e._refreshPresetButtonsSize(t.h);
  });
  this.logScroller = this.logWrapper.appendChild(new N({
    className: "log"
  }, {
    showHintArrows: !0
  }));
  this._logChat = this.logScroller.content;
  this._logChat.addClassNames("showChannel666");
  this.chatInput.on("sentChatMsg", function () {
    e.logScroller.goToBottom();
  });
  this._toggleTopChatBar(O.getValue("option-topChatBar", !0));
  this._toggleChatTimestampDisplay(O.getValue("option-chatTimestamp", !1));
};
n.prototype._updateChannelListenerCount = function (e, t) {
  var i = this.numPresetsListeningToChannel[e],
    n = Math.max(i + t, 0);
  this.numPresetsListeningToChannel[e] = n;
  Z[e] || (0 === i && n > 0 ? window.dofus.sendMessage("ChannelEnablingMessage", {
    channel: e,
    enable: !0
  }) : i > 0 && 0 === n && window.dofus.sendMessage("ChannelEnablingMessage", {
    channel: e,
    enable: !1
  }));
};
n.prototype._toggleChannel = function (e, t, i) {
  this._setChannelInPreset(e, t, i);
  this._updateChannelListenerCount(t, i ? 1 : -1);
};
n.prototype._addPreset = function (e) {
  var t = this.presetButtons.createChild("div", {
    className: "presetButton"
  });
  t.createChild("div", {
    className: ["presetIcon", e.className]
  });
  t.chat = this;
  t.presetId = this.presets.length;
  x(t);
  t.on("tap", a);
  for (var i, n = [], s = 0; s < e.channels.length; s++) {
    i = e.channels[s];
    n.push(i);
  }
  var r = {
    element: t,
    channels: n,
    channelsList: this.channelsLists.createChild("div", {
      className: "channelsList"
    })
  };
  this.presets.push(r);
  for (var l in this.channelMap) {
    i = ~~l;
    var c = r.channelsList.appendChild(new g(this.channelMap[i].nameId));
    c.id = i;
    c.chat = this;
    c.addClassNames("channel" + c.id);
    c.on("change", o);
  }
};
n.prototype._createPresets = function (e) {
  this.presets = [];
  this.activePreset = null;
  this.presetButtons = this.logWrapper.createChild("div", {
    className: "presetButtons"
  });
  this.channelsLists = this.logWrapper.createChild("div", {
    className: "channelsLists"
  });
  for (var t = 0; t < e.length; t++) {
    this._addPreset(e[t]);
  }
};
n.prototype._setChannelInPreset = function (e, t, i) {
  var n = this.presets[e].channels,
    o = !1,
    a = n.indexOf(t);
  a === -1 || i ? a === -1 && i && (n.push(t), o = !0) : (n.splice(a, 1), o = !0);
  o && (e === this.activePreset && this._updateLogFilter(), O.setValue(ee + e, n));
};
n.prototype._updatePresets = function (e) {
  var t = this.numPresetsListeningToChannel = {};
  for (var i in this.channelMap) {
    t[~~i] = 0;
  }
  for (var n, o, a = e.length - 1; a >= 0; a--) {
    var s = this.presets[a];
    o = s.channelsList.getChildren();
    var r = 0;
    for (i in this.channelMap) {
      n = ~~i;
      var l = this.chatInput.isChannelEnabledForSending(n),
        c = s.channels.indexOf(n) >= 0,
        d = o[r];
      r++;
      this.chatInput.isChannelAllowedForSending(n) ? (Z[n] || (!l || c || 0 !== a || t[n] || (this._setChannelInPreset(a, n, !0), c = !0), !l && c && (this._setChannelInPreset(a, n, !1), c = !1)), c ? (d.activate(!0), t[n]++) : d.deactivate(!0)) : d.hide();
    }
  }
};
n.prototype._loadPresetConfig = function () {
  var e = [];
  e.push({
    className: "preset1",
    channels: O.getValue(ee + V, [u.CHANNEL_GLOBAL, u.CHANNEL_TEAM, u.CHANNEL_GUILD, u.CHANNEL_ALLIANCE, u.CHANNEL_PARTY, u.CHANNEL_NOOB, u.PSEUDO_CHANNEL_PRIVATE, u.PSEUDO_CHANNEL_INFO, u.PSEUDO_CHANNEL_FIGHT_LOG, u.CHANNEL_ADS, u.CHANNEL_ARENA])
  });
  e.push({
    className: "preset2",
    channels: O.getValue(ee + X, [u.PSEUDO_CHANNEL_FIGHT_LOG])
  });
  e.push({
    className: "preset3",
    channels: O.getValue(ee + Q, [u.PSEUDO_CHANNEL_PRIVATE])
  });
  e.push({
    className: "preset4",
    channels: O.getValue(ee + K, [u.CHANNEL_GUILD, u.CHANNEL_SALES, u.CHANNEL_SEEK])
  });
  e.push({
    className: "preset5",
    channels: O.getValue(ee + J, [u.PSEUDO_CHANNEL_NPC_LOG])
  });
  this.presets || this._createPresets(e);
  this._updatePresets(e);
};
n.prototype._showMsgAsBubble = function (e, t) {
  if (e.channel === Y) {
    return !1;
  }
  if ("ChatAdminServerMessage" === e._messageType) {
    return !1;
  }
  if (window.gui.playerData.isFighting && !F.showSpeechBubbleInFight) {
    return !1;
  }
  var i = window.actorManager.getActor(e.senderId);
  if (!i) {
    return !1;
  }
  window.gui.newSpeechBubble({
    actor: i,
    msg: e.content,
    objectItems: e.objects,
    channel: e.channel,
    decodeAllPages: t,
    senderId: e.senderId,
    senderName: e.senderName
  });
  var n = D.getOpenWindows();
  return !(n.length >= 2) && (1 !== n.length || "worldMap" === n[0] && !D.getWindow("worldMap").isMaximized());
};
n.prototype._addMsgToChat = function (e, t) {
  if (!e.getDom) {
    return void console.error(new Error("Chat wrong object"));
  }
  this._logChat.appendChild(e.getDom());
  var i = this.historyBuffers[t].push(e);
  i && this._logChat.removeChild(i.getDom());
  this._refreshScroller(!0);
};
n.prototype._addTextNotification = function (e, t) {
  return e.getDom ? void window.gui.textNotification.add(e.getDom(), {
    channel: t
  }) : void console.error(new Error("Chat wrong object for bubble"));
};
n.prototype._logNewMessage = function (e, t) {
  var i = t || {},
    n = i.isCopy || !1,
    o = window.gui.playerData.socialData.isIgnored(e.senderAccountId);
  if (!("ChatAdminServerMessage" !== e._messageType && e.channel !== Y && o || this.p2p.processMsg(e, n))) {
    var a = n || d.isChannelSelective(e.channel, e.senderId);
    e.content = this.censor.filterCensoredWords(e.content);
    r(e);
    var s = e.content.match(/\/([a-zA-Z]+),[b|m]essage:([^\\}]*)/),
      l = new m(console, window.gui.databases.ChatChannels, e, n, a);
    if (this._addMsgToChat(l, e.channel), !s && this.isChannelEnabledInPreset(e.channel) && !this._showMsgAsBubble(e, a)) {
      var c = new m(console, window.gui.databases.ChatChannels, e, n, a, !0);
      this._addTextNotification(c, e.channel);
    }
  }
};
n.prototype._logServerMsgWithObject = function (e, t) {
  l(e.objects);
  e.content = this.linkHelper.replaceLinksReceived(e.content, e.objects);
  this._logNewMessage(e, {
    isCopy: t
  });
};
n.prototype._logServerText = function (e, t) {
  t = t || {};
  var i = void 0 !== t.channel ? t.channel : u.PSEUDO_CHANNEL_INFO,
    n = t.parentClassName,
    o = new f(console, window.gui.databases.ChatChannels, e, i, n, t.important),
    a = new f(console, window.gui.databases.ChatChannels, e, i, n, t.important);
  this._addMsgToChat(o, i);
  this._addTextNotification(a, i);
};
n.prototype.logNPCMsg = function (e, t, i) {
  var n = new f(console, window.gui.databases.ChatChannels, e, u.PSEUDO_CHANNEL_NPC_LOG, null, !1, {
    npcId: t,
    npcName: i,
    showChannelName: !0
  });
  this._addMsgToChat(n, u.PSEUDO_CHANNEL_NPC_LOG);
};
n.prototype.logNPCReplyMsg = function (e) {
  var t = window.gui.playerData,
    i = new f(console, window.gui.databases.ChatChannels, e, u.PSEUDO_CHANNEL_NPC_LOG, null, !1, {
      playerId: t.id,
      playerName: t.characterBaseInformations.name,
      showChannelName: !0
    });
  this._addMsgToChat(i, u.PSEUDO_CHANNEL_NPC_LOG);
};
n.prototype.logMsg = function (e, t, i, n) {
  if (void 0 === t && (t = u.PSEUDO_CHANNEL_INFO), !this.isChannelEnabledInPreset(t)) {
    var o = new f(console, window.gui.databases.ChatChannels, e, t, i);
    return this._addMsgToChat(o, t);
  }
  this._logServerText(e, {
    channel: t,
    parentClassName: i,
    important: n
  });
};
n.prototype.logError = function (e, t) {
  this._logServerText(e, {
    channel: j,
    important: t
  });
};
n.prototype.insertLink = function (e, t) {
  this.chatInput.insertLink(e, t);
};
n.prototype._refreshScroller = function (e) {
  var t = !this.logScroller.canScrollDown();
  return this.logScroller.refresh(), e && !t ? this.logScroller.notify() : void this.logScroller.goToBottom();
};
n.prototype._refreshPresetButtonsSize = function (e) {
  if (this.presetButtons) {
    var t = q - (U - e);
    this.presetButtons.setStyle("height", Math.min(t, q) + "px");
  }
};
n.prototype._togglePresetChannels = function (e) {
  if (this.channelsLists.toggleDisplay(), !this.channelsLists.isVisible()) {
    return this._refreshScroller();
  }
  var t = this.presets[e],
    i = b(t.channelsList, t.element);
  t.channelsList.setStyles({
    left: i.x + "px",
    top: i.y + "px"
  });
};
n.prototype._setActivePreset = function (e) {
  this.activePreset = e;
  this.channelsLists.hide();
  for (var t = 0; t < this.presets.length; t++) {
    var i = this.presets[t];
    i.element.toggleClassName("on", t === e);
    i.channelsList.toggleDisplay(t === e);
  }
  this._updateLogFilter();
  this._refreshScroller();
};
n.prototype.isChannelEnabledInPreset = function (e) {
  if (!this.presets) {
    return !0;
  }
  var t = this.presets[this.activePreset].channels;
  return t.indexOf(e) !== -1;
};
n.prototype._updateLogFilter = function () {
  for (var e = this.presets[this.activePreset].channels, t = Object.keys(u).length, i = 0; i <= t; i++) {
    this._logChat.toggleClassName("showChannel" + i, e.indexOf(i) !== -1);
  }
};
n.prototype._toggleTopChatBar = function (e) {
  this.chatInput.formChat.toggleClassName("formChatBottom", !e);
};
n.prototype._toggleChatTimestampDisplay = function (e) {
  e ? this.delClassNames("hiddenChatTimestamp") : this.addClassNames("hiddenChatTimestamp");
};
n.prototype._setMessageHandlers = function () {
  function e(e) {
    var t = n.playerData.characters.canControlCharacterId(e.id);
    i.yourTurnButton.toggleDisplay(t);
  }
  function t() {
    i.yourTurnButton.hide();
  }
  var i = this,
    n = window.gui,
    o = window.dofus.connectionManager;
  n.on("connected", function () {
    i._initializeAtConnection();
  });
  n.on("gameOptionChanged", function (e) {
    switch (e.gameOptionId) {
      case "chatTimestamp":
        i._toggleChatTimestampDisplay(e.value);
        break;
      case "topChatBar":
        i._toggleTopChatBar(e.value);
    }
  });
  o.on("EnabledChannelsMessage", function (e) {
    i._initializeEnabledChannels(e.channels, e.disallowed);
  });
  o.on("ChatServerWithObjectMessage", function (e) {
    i._logServerMsgWithObject(e, !1);
  });
  o.on("ChatServerCopyWithObjectMessage", function (e) {
    i._logServerMsgWithObject(e, !0);
  });
  o.on("ChatServerMessage", function (e) {
    i._logNewMessage(e);
  });
  o.on("ChatTaggedServerMessage", function (e) {
    i._logNewMessage(e);
  });
  o.on("EntityTalkMessage", function (e) {
    var t = window.actorManager.getActorFromNpcId(e.entityId);
    window.gui.newSpeechBubble({
      actor: t,
      msg: e.text,
      isNonChat: !0
    });
  });
  o.on("ChatAdminServerMessage", function (e) {
    i._logNewMessage(e);
  });
  o.on("ChatServerCopyMessage", function (e) {
    i._logNewMessage(e, {
      isCopy: !0
    });
  });
  o.on("BasicWhoIsMessage", function (e) {
    e.verbose && i._logServerText(B(e));
  });
  o.on("BasicWhoIsNoMatchMessage", function (e) {
    i._logServerText(M("ui.common.playerNotFound", e.search));
  });
  o.on("ChatUpdateMessage", function (e) {
    var t = i._searchMessage(e.id);
    t && (e.type === h.REMOVE ? t.deleteContent() : e.type === h.MARK_REMOVED ? t.updateMessage(e.type) : console.error(new Error("type: " + e.type + " unknown.")));
  });
  o.on("HelpersOnlineMessage", function (e) {
    if (e.playerIds && e.playerIds.length > 0) {
      i._logServerText(M("tablet.chat.helpers.connected", e.playerIds.length));
      for (var t = 0, n = e.playerIds.length; t < n; t++) {
        i._logServerText("{player," + e.playerNames[t] + "," + e.playerIds[t] + "}");
      }
    } else {
      i._logServerText(M("tablet.chat.helpers.none"));
    }
  });
  o.on("CharacterExperienceGainMessage", function (e) {
    e.experienceCharacter && i.logMsg(M("ui.stats.xpgain.mine", e.experienceCharacter));
    e.experienceGuild && i.logMsg(M("ui.stats.xpgain.guild", e.experienceGuild));
    e.experienceIncarnation && i.logMsg(M("ui.stats.xpgain.incarnation", e.experienceIncarnation));
    e.experienceMount && i.logMsg(M("ui.stats.xpgain.mount", e.experienceMount));
  });
  n.fightManager.on("fightEnterPreparation", function () {
    i.deactivate();
  });
  n.fightManager.on("fightStart", function () {
    i.yourTurnButton.hide();
    i.setDisplayMode($.FIGHT);
  });
  n.fightManager.on(w.FIGHT_END, function () {
    t();
    i.setDisplayMode($.ROLEPLAY);
  });
  n.on("GameFightTurnStartMessage", e);
  n.on("GameFightTurnResumeMessage", e);
  n.on("GameFightTurnStartSlaveMessage", e);
  n.on("GameFightTurnEndMessage", t);
  n.on("resize", function () {
    i._resize();
  });
  n.on("disconnect", function () {
    i.deactivate();
  });
  A.on("show", function (e) {
    e && !isNaN(e) || (console.error("Chat: the keyboardHeight is wrong:", e), e = .6 * v.screenHeight);
    i.keyboardHeight = e;
    i.setDimensions();
  });
};
n.prototype._searchMessage = function (e) {
  for (var t in this.historyBuffers) {
    if (this.historyBuffers.hasOwnProperty(~~t)) {
      for (var i = this.historyBuffers[~~t], n = i.getBuffer() || [], o = 0; o < n.length; o += 1) {
        var a = n[o];
        if (a && a.getId() === e) {
          return a;
        }
      }
    }
  }
  return null;
};
n.prototype.setDisplayMode = function (e) {
  if (this.displayMode !== e) {
    if (!this.active) {
      return void (this.displayMode = e);
    }
    this.removeDisplayMode();
    this.displayMode = e;
    this.addDisplayMode();
    this.setDimensions();
  }
};
n.prototype.removeDisplayMode = function () {
  switch (this.displayMode) {
    case $.FIGHT:
      window.gui.timeline.restoreFighterList();
      this.delClassNames("fightMode");
  }
};
n.prototype.addDisplayMode = function () {
  this.displayMode === $.FIGHT && (this.addClassNames("fightMode"), window.gui.timeline.appendFighterListTo(this.timelineBox));
};
n.prototype.setDimensions = function () {
  var e = parseInt(this.logWrapper.getComputedStyle("left"), 10) || 0,
    t = parseInt(this.logWrapper.getComputedStyle("top"), 10) || 0,
    i = v.windowFullScreenWidth - e,
    n = v.windowFullScreenHeight - t;
  switch (this.displayMode) {
    case $.FIGHT:
      this.logWrapper.windowWidth = v.screenWidth;
      var o = v.physicalScreenHeight - this.keyboardHeight,
        a = o * v.physicalToViewportRatio;
      this.logWrapper.windowHeight = O.getValue("ChatHeightForFight", a);
      this.logWrapper.setWidthLock(!0);
      break;
    default:
      var s = Math.max(W, Math.round(.45 * v.mapWidth)),
        r = Math.max(G, Math.round(.45 * v.mapHeight)),
        l = O.getValue("ChatForRP", {
          width: s,
          height: r
        });
      this.logWrapper.windowWidth = Math.min(l.width, i);
      this.logWrapper.windowHeight = l.height;
      this.logWrapper.setWidthLock(!1);
  }
  this.logWrapper.windowHeight = Math.min(this.logWrapper.windowHeight, n);
  this.logWrapper.setStyles({
    width: this.logWrapper.windowWidth + "px",
    height: this.logWrapper.windowHeight + "px"
  });
  this._refreshScroller();
  this._refreshPresetButtonsSize(this.logWrapper.windowHeight);
};
n.prototype.startPrivateMessage = function (e, t) {
  this.chatInput.startPrivateMessage(e, t);
  this.activate();
};
n.prototype.activate = function () {
  var e = this;
  A.disableScroll(!0);
  this.addClassNames("open");
  this.active = !0;
  _.isPhoneGap || this.setDimensions();
  this.addDisplayMode();
  this._refreshScroller();
  window.gui.textNotification && window.gui.textNotification.hide();
  L.tween(this, {
    webkitTransform: "translate3d(0, 0, 0)"
  }, {
    time: 200,
    delay: 0,
    easing: "ease-out"
  }, function () {
    e.chatInput.focus();
  });
  A.setAutomaticHide(!1);
};
n.prototype.deactivate = function () {
  if (this.active) {
    this.active = !1;
    this.chatInput.blur();
    A.disableScroll(!1);
    var e = this;
    L.tween(this, {
      webkitTransform: "translate3d(0, -" + this.logWrapper.windowHeight + "px, 0)"
    }, {
      time: 200,
      delay: 0,
      easing: "ease-out"
    }, function () {
      e.removeDisplayMode();
      e.delClassNames("open");
    });
    window.gui.textNotification && window.gui.textNotification.show();
    this.channelsLists && this.channelsLists.hide();
    this.emit("closed");
    A.setAutomaticHide(!0);
  }
};
n.prototype._resize = function () {
  var e = !this.logWrapper.windowHeight;
  this.setDimensions();
  e && this.deactivate();
};
this.setDisplayMode($.ROLEPLAY);
this.chatInput.initializeAtConnection();
this._clearChatHistory();
this.chatInput.initializeEnabledChannels(e, t);
this._loadPresetConfig();
this._setActivePreset(V);
this.logWrapper = this.createChild("div", {
  className: "logWrapper"
});
this.fightControls = this.logWrapper.createChild("div", {
  className: "fightControls"
});
this.timelineBox = this.fightControls.createChild("div", {
  className: "timelineBox"
});
n.setText(M("tablet.chat.yourTurnButton"));
i.appendChild(n);
this.yourTurnButton = t.appendChild(i);
this.chatInput = new p(this.logWrapper, this.linkHelper);
this.logWrapper.appendChild(new R({
  className: ["simpleButton", "chatCloseButton"]
}, function () {
  e.deactivate();
}));
k(this.logWrapper, {
  minWidth: W,
  minHeight: G,
  eventOnResize: !0
});
this.logWrapper.on("resize", function () {
  e.displayMode === $.FIGHT ? O.setValue("ChatHeightForFight", e.logWrapper.windowHeight) : O.setValue("ChatForRP", {
    width: e.logWrapper.windowWidth,
    height: e.logWrapper.windowHeight
  });
  O.saveNow();
  e._refreshScroller();
});
this.logWrapper.on("resizeMove", function (t) {
  e._refreshPresetButtonsSize(t.h);
});
this.logScroller = this.logWrapper.appendChild(new N({
  className: "log"
}, {
  showHintArrows: !0
}));
this._logChat = this.logScroller.content;
this._logChat.addClassNames("showChannel666");
this.chatInput.on("sentChatMsg", function () {
  e.logScroller.goToBottom();
});
this._toggleTopChatBar(O.getValue("option-topChatBar", !0));
this._toggleChatTimestampDisplay(O.getValue("option-chatTimestamp", !1));
e.displayMode === $.FIGHT ? O.setValue("ChatHeightForFight", e.logWrapper.windowHeight) : O.setValue("ChatForRP", {
  width: e.logWrapper.windowWidth,
  height: e.logWrapper.windowHeight
});
O.saveNow();
e._refreshScroller();
this.numPresetsListeningToChannel[e] = n;
Z[e] || (0 === i && n > 0 ? window.dofus.sendMessage("ChannelEnablingMessage", {
  channel: e,
  enable: !0
}) : i > 0 && 0 === n && window.dofus.sendMessage("ChannelEnablingMessage", {
  channel: e,
  enable: !1
}));
this._setChannelInPreset(e, t, i);
this._updateChannelListenerCount(t, i ? 1 : -1);
t.createChild("div", {
  className: ["presetIcon", e.className]
});
t.chat = this;
t.presetId = this.presets.length;
x(t);
t.on("tap", a);
i = e.channels[s];
n.push(i);
c.id = i;
c.chat = this;
c.addClassNames("channel" + c.id);
c.on("change", o);
this.presets = [];
this.activePreset = null;
this.presetButtons = this.logWrapper.createChild("div", {
  className: "presetButtons"
});
this.channelsLists = this.logWrapper.createChild("div", {
  className: "channelsLists"
});
a === -1 || i ? a === -1 && i && (n.push(t), o = !0) : (n.splice(a, 1), o = !0);
o && (e === this.activePreset && this._updateLogFilter(), O.setValue(ee + e, n));
r++;
this.chatInput.isChannelAllowedForSending(n) ? (Z[n] || (!l || c || 0 !== a || t[n] || (this._setChannelInPreset(a, n, !0), c = !0), !l && c && (this._setChannelInPreset(a, n, !1), c = !1)), c ? (d.activate(!0), t[n]++) : d.deactivate(!0)) : d.hide();
e.push({
  className: "preset1",
  channels: O.getValue(ee + V, [u.CHANNEL_GLOBAL, u.CHANNEL_TEAM, u.CHANNEL_GUILD, u.CHANNEL_ALLIANCE, u.CHANNEL_PARTY, u.CHANNEL_NOOB, u.PSEUDO_CHANNEL_PRIVATE, u.PSEUDO_CHANNEL_INFO, u.PSEUDO_CHANNEL_FIGHT_LOG, u.CHANNEL_ADS, u.CHANNEL_ARENA])
});
e.push({
  className: "preset2",
  channels: O.getValue(ee + X, [u.PSEUDO_CHANNEL_FIGHT_LOG])
});
e.push({
  className: "preset3",
  channels: O.getValue(ee + Q, [u.PSEUDO_CHANNEL_PRIVATE])
});
e.push({
  className: "preset4",
  channels: O.getValue(ee + K, [u.CHANNEL_GUILD, u.CHANNEL_SALES, u.CHANNEL_SEEK])
});
e.push({
  className: "preset5",
  channels: O.getValue(ee + J, [u.PSEUDO_CHANNEL_NPC_LOG])
});
this.presets || this._createPresets(e);
this._updatePresets(e);
i && this._logChat.removeChild(i.getDom());
this._refreshScroller(!0);
e.content = this.censor.filterCensoredWords(e.content);
r(e);
l(e.objects);
e.content = this.linkHelper.replaceLinksReceived(e.content, e.objects);
this._logNewMessage(e, {
  isCopy: t
});
this._addMsgToChat(o, i);
this._addTextNotification(a, i);
this.activePreset = e;
this.channelsLists.hide();
i.element.toggleClassName("on", t === e);
i.channelsList.toggleDisplay(t === e);
this._updateLogFilter();
this._refreshScroller();
n.on("connected", function () {
  i._initializeAtConnection();
});
n.on("gameOptionChanged", function (e) {
  switch (e.gameOptionId) {
    case "chatTimestamp":
      i._toggleChatTimestampDisplay(e.value);
      break;
    case "topChatBar":
      i._toggleTopChatBar(e.value);
  }
});
o.on("EnabledChannelsMessage", function (e) {
  i._initializeEnabledChannels(e.channels, e.disallowed);
});
o.on("ChatServerWithObjectMessage", function (e) {
  i._logServerMsgWithObject(e, !1);
});
o.on("ChatServerCopyWithObjectMessage", function (e) {
  i._logServerMsgWithObject(e, !0);
});
o.on("ChatServerMessage", function (e) {
  i._logNewMessage(e);
});
o.on("ChatTaggedServerMessage", function (e) {
  i._logNewMessage(e);
});
o.on("EntityTalkMessage", function (e) {
  var t = window.actorManager.getActorFromNpcId(e.entityId);
  window.gui.newSpeechBubble({
    actor: t,
    msg: e.text,
    isNonChat: !0
  });
});
o.on("ChatAdminServerMessage", function (e) {
  i._logNewMessage(e);
});
o.on("ChatServerCopyMessage", function (e) {
  i._logNewMessage(e, {
    isCopy: !0
  });
});
o.on("BasicWhoIsMessage", function (e) {
  e.verbose && i._logServerText(B(e));
});
o.on("BasicWhoIsNoMatchMessage", function (e) {
  i._logServerText(M("ui.common.playerNotFound", e.search));
});
o.on("ChatUpdateMessage", function (e) {
  var t = i._searchMessage(e.id);
  t && (e.type === h.REMOVE ? t.deleteContent() : e.type === h.MARK_REMOVED ? t.updateMessage(e.type) : console.error(new Error("type: " + e.type + " unknown.")));
});
o.on("HelpersOnlineMessage", function (e) {
  if (e.playerIds && e.playerIds.length > 0) {
    i._logServerText(M("tablet.chat.helpers.connected", e.playerIds.length));
    for (var t = 0, n = e.playerIds.length; t < n; t++) {
      i._logServerText("{player," + e.playerNames[t] + "," + e.playerIds[t] + "}");
    }
  } else {
    i._logServerText(M("tablet.chat.helpers.none"));
  }
});
o.on("CharacterExperienceGainMessage", function (e) {
  e.experienceCharacter && i.logMsg(M("ui.stats.xpgain.mine", e.experienceCharacter));
  e.experienceGuild && i.logMsg(M("ui.stats.xpgain.guild", e.experienceGuild));
  e.experienceIncarnation && i.logMsg(M("ui.stats.xpgain.incarnation", e.experienceIncarnation));
  e.experienceMount && i.logMsg(M("ui.stats.xpgain.mount", e.experienceMount));
});
n.fightManager.on("fightEnterPreparation", function () {
  i.deactivate();
});
n.fightManager.on("fightStart", function () {
  i.yourTurnButton.hide();
  i.setDisplayMode($.FIGHT);
});
n.fightManager.on(w.FIGHT_END, function () {
  t();
  i.setDisplayMode($.ROLEPLAY);
});
n.on("GameFightTurnStartMessage", e);
n.on("GameFightTurnResumeMessage", e);
n.on("GameFightTurnStartSlaveMessage", e);
n.on("GameFightTurnEndMessage", t);
n.on("resize", function () {
  i._resize();
});
n.on("disconnect", function () {
  i.deactivate();
});
A.on("show", function (e) {
  e && !isNaN(e) || (console.error("Chat: the keyboardHeight is wrong:", e), e = .6 * v.screenHeight);
  i.keyboardHeight = e;
  i.setDimensions();
});
e.experienceCharacter && i.logMsg(M("ui.stats.xpgain.mine", e.experienceCharacter));
e.experienceGuild && i.logMsg(M("ui.stats.xpgain.guild", e.experienceGuild));
e.experienceIncarnation && i.logMsg(M("ui.stats.xpgain.incarnation", e.experienceIncarnation));
e.experienceMount && i.logMsg(M("ui.stats.xpgain.mount", e.experienceMount));
i.yourTurnButton.hide();
i.setDisplayMode($.FIGHT);
t();
i.setDisplayMode($.ROLEPLAY);
e && !isNaN(e) || (console.error("Chat: the keyboardHeight is wrong:", e), e = .6 * v.screenHeight);
i.keyboardHeight = e;
i.setDimensions();
this.removeDisplayMode();
this.displayMode = e;
this.addDisplayMode();
this.setDimensions();
window.gui.timeline.restoreFighterList();
this.delClassNames("fightMode");
this.logWrapper.windowHeight = O.getValue("ChatHeightForFight", a);
this.logWrapper.setWidthLock(!0);
this.logWrapper.windowWidth = Math.min(l.width, i);
this.logWrapper.windowHeight = l.height;
this.logWrapper.setWidthLock(!1);
this.logWrapper.windowHeight = Math.min(this.logWrapper.windowHeight, n);
this.logWrapper.setStyles({
  width: this.logWrapper.windowWidth + "px",
  height: this.logWrapper.windowHeight + "px"
});
this._refreshScroller();
this._refreshPresetButtonsSize(this.logWrapper.windowHeight);
this.chatInput.startPrivateMessage(e, t);
this.activate();
A.disableScroll(!0);
this.addClassNames("open");
this.active = !0;
_.isPhoneGap || this.setDimensions();
this.addDisplayMode();
this._refreshScroller();
window.gui.textNotification && window.gui.textNotification.hide();
L.tween(this, {
  webkitTransform: "translate3d(0, 0, 0)"
}, {
  time: 200,
  delay: 0,
  easing: "ease-out"
}, function () {
  e.chatInput.focus();
});
A.setAutomaticHide(!1);
this.active = !1;
this.chatInput.blur();
A.disableScroll(!1);
L.tween(this, {
  webkitTransform: "translate3d(0, -" + this.logWrapper.windowHeight + "px, 0)"
}, {
  time: 200,
  delay: 0,
  easing: "ease-out"
}, function () {
  e.removeDisplayMode();
  e.delClassNames("open");
});
window.gui.textNotification && window.gui.textNotification.show();
this.channelsLists && this.channelsLists.hide();
this.emit("closed");
A.setAutomaticHide(!0);
e.removeDisplayMode();
e.delClassNames("open");
this.setDimensions();
e && this.deactivate();
d.call(this);
this.linkHelper = t;
this.channelMap = window.gui.databases.ChatChannels;
this.outgoingChannel = C;
this.outgoingChannelMenu = null;
this.sendingEnabledChannels = null;
this.sendingDisallowedChannels = null;
this.previousInput = "";
this.previousPrivateReceiver = "";
this.sentMessageHistory = new v();
this._createElements(e);
this._setMessageHandlers();
p(n, d);
e.exports = n;
n.prototype.initializeAtConnection = function () {
  this.statusIndicator.initialize();
  this.previousInput = "";
  this.previousPrivateReceiver = "";
  this._selectOutgoingChannel(C, !0);
  this.sendingEnabledChannels = T.concat();
  this.sendingDisallowedChannels = [];
};
n.prototype.initializeEnabledChannels = function (e, t) {
  this.sendingEnabledChannels = e;
  this.sendingDisallowedChannels = t;
  this._initOutgoingChannelMenu();
};
n.prototype.clearSentMessageHistory = function () {
  this.sentMessageHistory.reset();
};
n.prototype._createElements = function (e) {
  function t() {
    var e = i.sentMessageHistory.getCurrentEntry();
    i._setInput(e.message);
    i.linkHelper.linksToReplace = e.links;
  }
  this.formChat = e.createChild("div", {
    className: "formChat"
  });
  this.statusIndicator = new w(this.formChat);
  this._createChannelSelector(this.formChat);
  this.inputChat = this.formChat.appendChild(new m({
    className: "inputChat",
    attr: {
      maxlength: _.USER_MAX_CHAT_LEN
    }
  }));
  var i = this;
  this.inputChat.on("validate", function () {
    return "" === i.inputChat.getValue() ? M.hide() : void i._submit();
  });
  var n = this.formChat.appendChild(new s({
      className: "historyUp",
      scaleOnPress: !0,
      hidden: !0
    }, function () {
      i.sentMessageHistory.goBack();
      t();
    })),
    o = this.formChat.appendChild(new s({
      className: "historyDown",
      scaleOnPress: !0,
      hidden: !0
    }, function () {
      i.sentMessageHistory.goForward();
      t();
    }));
  this.formChat.appendChild(new s({
    className: "historyButton",
    scaleOnPress: !0
  }, function () {
    n.toggleDisplay();
    o.toggleDisplay();
  }));
  this.formChat.appendChild(new s({
    className: ["sendButton", "greenButton"],
    addIcon: !0
  }, function () {
    i._submit();
  }));
};
n.prototype._createChannelSelector = function (e) {
  function t() {
    i._selectOutgoingChannel(this.id);
    i.inputChat.focus();
  }
  for (var i = this, n = this.outgoingChannelMenu = [], o = 0; o < T.length; o++) {
    var a = this.channelMap[T[o]];
    n.push({
      id: a.id,
      caption: a.nameId + " (" + a.shortcut + ")",
      cb: t,
      ticked: a.id === this.outgoingChannel
    });
  }
  var s = this.buttonTouchZone = e.createChild("div", {
    className: "buttonTouchZone"
  });
  this.outgoingChannelButtonBg = e.createChild("div", {
    className: "buttonBackground"
  });
  this.outgoingChannelButton = e.createChild("div", {
    className: "outgoingChannelButton"
  });
  b.addTooltip(s, u("ui.option.chat"));
  s.on("tap", function () {
    var e = this.rootElement.getBoundingClientRect();
    window.gui.openContextualMenu("generic", {
      title: u("ui.option.currentChannel"),
      actions: i.outgoingChannelMenu
    }, {
      x: e.left + e.width,
      y: e.top
    });
  });
};
n.prototype._showNotification = function (e) {
  b.showNotification(e, this.inputChat);
};
n.prototype.showNotification = n.prototype._showNotification;
n.prototype._initOutgoingChannelMenu = function () {
  for (var e = this.outgoingChannelMenu, t = 0; t < e.length; t++) {
    var i = e[t];
    i.hidden = this.sendingEnabledChannels.indexOf(i.id) < 0;
    i.ticked = i.id === this.outgoingChannel;
  }
};
n.prototype._getOutgoingChannelMenuOption = function (e) {
  for (var t = this.outgoingChannelMenu, i = 0; i < t.length; i++) {
    if (t[i].id === e) {
      return t[i];
    }
  }
};
n.prototype._setChannelEnabled = function (e, t) {
  var i = this._getOutgoingChannelMenuOption(e);
  i && (i.hidden = !t);
  var n = this.channelMap[e].nameId,
    o = this.sendingEnabledChannels,
    a = o.indexOf(e);
  if (a !== -1) {
    if (this._showNotification(u("tablet.chat.disablingChannel", n)), t) {
      return console.warn("Chat channel already enabled");
    }
    o.splice(a, 1);
  } else {
    if (this._showNotification(u("tablet.chat.enablingChannel", n)), !t) {
      return console.warn("Chat channel already disabled");
    }
    o.push(e);
  }
};
n.prototype.isChannelEnabledForSending = function (e) {
  return this.sendingEnabledChannels.indexOf(e) !== -1;
};
n.prototype.isChannelAllowedForSending = function (e) {
  return this.sendingDisallowedChannels.indexOf(e) === -1;
};
n.prototype._selectOutgoingChannel = function (e, t) {
  var i = this.outgoingChannel;
  (e !== i || t) && (t && e !== I && this.inputChat.setValue(""), i === I && o(this.inputChat, this.previousPrivateReceiver + " "), e === I && this.previousPrivateReceiver && a(this.inputChat, this.previousPrivateReceiver + " "), this.inputChat.setClassNames(["inputChat", "inputBox", "channel" + e]), this.outgoingChannelButtonBg.setClassNames(["buttonBackground", "outgoingChannel" + e]), e === I && (this.previousPrivateReceiver ? this._showNotification(u("tablet.chat.enteringPrivateChannel", this.previousPrivateReceiver)) : this._showNotification(u("tablet.chat.privateReceiverHelp"))), this._getOutgoingChannelMenuOption(i).ticked = !1, this._getOutgoingChannelMenuOption(e).ticked = !0, this.outgoingChannel = e);
};
n.prototype._setMessageHandlers = function () {
  var e = this,
    t = window.dofus.connectionManager;
  t.on("ChannelEnablingChangeMessage", function (t) {
    e._setChannelEnabled(t.channel, t.enable);
  });
  t.on("ChatErrorMessage", function (t) {
    e._showNotification(t.reason);
    e._setInput(e.previousInput, !0);
    e.sentMessageHistory.removeMessage();
  });
};
n.prototype.insertLink = function (e, t) {
  var i = this.linkHelper.newLinkForSending(e, t);
  this.inputChat.setValue(this.inputChat.getValue() + i);
};
n.prototype.focus = function () {
  this.inputChat.focus();
};
n.prototype.blur = function () {
  this.inputChat.blur();
};
n.prototype.sendChatCommand = function (e) {
  "/" !== e.trim().charAt(0) && (e = "/s " + e);
  this.inputChat.setValue(e);
  this._submit();
};
n.prototype._submit = function () {
  h.recordActivity();
  var e = this.inputChat.getValue().trim(),
    t = this.outgoingChannel,
    i = null,
    n = A.exec(e);
  if (n) {
    n = n[1].toLowerCase();
    var o = e.split(" ").slice(1),
      a = y(n, o);
    if (a) {
      return void this._setInput("");
    }
    if (t = S[n], void 0 === t && "me" !== n && "think" !== n) {
      return this._showNotification(u("ui.console.notfound", e.substr(1).split(" ")[0]));
    }
    e = e.substr(n.length + 2);
  }
  if (t === I) {
    var s = e.indexOf(" ");
    if (i = e.substr(0, s), e = e.substr(s), !i || !e || i.length < _.MIN_NICK_LEN || i.length > _.MAX_NICK_LEN) {
      return this._showNotification(u("tablet.chat.privateReceiverHelp"));
    }
    this.previousPrivateReceiver = i;
  }
  if (e = e.trim()) {
    this.previousInput = e;
    var r = {
        allPagesAllowed: f.isChannelSelective(t, i)
      },
      d = l.getUnsendableCharacters(e, r);
    if (d.length) {
      var p = d[0] + " (" + d[0].codePointAt().toString(16) + ")";
      return this._showNotification(u("tablet.chat.unsendableChars", p));
    }
    e = l.encode(e, r);
    e = g(e);
    var m = [];
    e = this.linkHelper.prepareForSending(e, m);
    "me" !== n && "think" !== n || (e = "/" + n + ",message:" + e);
    var v = c.sendMessage(e, t, i, m);
    if (v) {
      return this._showNotification(v);
    }
    this.sentMessageHistory.addMessage(this.previousInput, this.linkHelper.previousLinks);
    this._setInput("");
    this.emit("sentChatMsg");
  }
};
n.prototype._setInput = function (e, t) {
  this.outgoingChannel === I && this.previousPrivateReceiver ? (this.inputChat.setValue(this.previousPrivateReceiver + " " + e), t && this.inputChat.setCaretPosition(this.previousPrivateReceiver.length)) : this.inputChat.setValue(e);
  t && this.linkHelper.undoPrepareForSending();
};
n.prototype.startPrivateMessage = function (e, t) {
  t && (e = "*" + e);
  this.outgoingChannel === I && e !== this.previousPrivateReceiver && o(this.inputChat, this.previousPrivateReceiver + " ");
  this.previousPrivateReceiver = e;
  this._selectOutgoingChannel(I, !0);
};
this.statusIndicator.initialize();
this.previousInput = "";
this.previousPrivateReceiver = "";
this._selectOutgoingChannel(C, !0);
this.sendingEnabledChannels = T.concat();
this.sendingDisallowedChannels = [];
this.sendingEnabledChannels = e;
this.sendingDisallowedChannels = t;
this._initOutgoingChannelMenu();
i._setInput(e.message);
i.linkHelper.linksToReplace = e.links;
this.formChat = e.createChild("div", {
  className: "formChat"
});
this.statusIndicator = new w(this.formChat);
this._createChannelSelector(this.formChat);
this.inputChat = this.formChat.appendChild(new m({
  className: "inputChat",
  attr: {
    maxlength: _.USER_MAX_CHAT_LEN
  }
}));
i.sentMessageHistory.goBack();
t();
i.sentMessageHistory.goForward();
t();
this.formChat.appendChild(new s({
  className: "historyButton",
  scaleOnPress: !0
}, function () {
  n.toggleDisplay();
  o.toggleDisplay();
}));
this.formChat.appendChild(new s({
  className: ["sendButton", "greenButton"],
  addIcon: !0
}, function () {
  i._submit();
}));
n.toggleDisplay();
o.toggleDisplay();
i._selectOutgoingChannel(this.id);
i.inputChat.focus();
this.outgoingChannelButtonBg = e.createChild("div", {
  className: "buttonBackground"
});
this.outgoingChannelButton = e.createChild("div", {
  className: "outgoingChannelButton"
});
b.addTooltip(s, u("ui.option.chat"));
s.on("tap", function () {
  var e = this.rootElement.getBoundingClientRect();
  window.gui.openContextualMenu("generic", {
    title: u("ui.option.currentChannel"),
    actions: i.outgoingChannelMenu
  }, {
    x: e.left + e.width,
    y: e.top
  });
});
i.hidden = this.sendingEnabledChannels.indexOf(i.id) < 0;
i.ticked = i.id === this.outgoingChannel;
t.on("ChannelEnablingChangeMessage", function (t) {
  e._setChannelEnabled(t.channel, t.enable);
});
t.on("ChatErrorMessage", function (t) {
  e._showNotification(t.reason);
  e._setInput(e.previousInput, !0);
  e.sentMessageHistory.removeMessage();
});
e._showNotification(t.reason);
e._setInput(e.previousInput, !0);
e.sentMessageHistory.removeMessage();
"/" !== e.trim().charAt(0) && (e = "/s " + e);
this.inputChat.setValue(e);
this._submit();
e = l.encode(e, r);
e = g(e);
e = this.linkHelper.prepareForSending(e, m);
"me" !== n && "think" !== n || (e = "/" + n + ",message:" + e);
this.sentMessageHistory.addMessage(this.previousInput, this.linkHelper.previousLinks);
this._setInput("");
this.emit("sentChatMsg");
this.outgoingChannel === I && this.previousPrivateReceiver ? (this.inputChat.setValue(this.previousPrivateReceiver + " " + e), t && this.inputChat.setCaretPosition(this.previousPrivateReceiver.length)) : this.inputChat.setValue(e);
t && this.linkHelper.undoPrepareForSending();
t && (e = "*" + e);
this.outgoingChannel === I && e !== this.previousPrivateReceiver && o(this.inputChat, this.previousPrivateReceiver + " ");
this.previousPrivateReceiver = e;
this._selectOutgoingChannel(I, !0);
c = {};
c.experience = n("experience");
c.level = n("level");
c.life = n("life");
c.maxlife = n("maxlife");
c.lifepercent = n("lifepercent");
c.myself = n("myself");
c.stats = n("stats");
c.area = n("area");
c.subarea = n("subarea");
c.position = n("position");
c.guild = n("guild");
c.achievement = n("achievement");
u = f.currentExp - f.expPreviousLevel;
h = f.requiredExpToNextLevel - f.expPreviousLevel;
I += t.position.coordinates.posY + "," + window.gui.playerData.position.worldmapId + "}";
e = e.replace(c.position, I);
i.prototype.reset = function () {
  this._buffer = [];
  this._currentIndex = 0;
};
i.prototype.addMessage = function (e, t) {
  this._buffer.unshift({
    message: e,
    links: t
  });
  this._buffer.length > n && this._buffer.pop();
  this._currentIndex = 0;
};
i.prototype.removeMessage = function () {
  this._buffer.shift();
};
i.prototype.goBack = function () {
  this._currentIndex++;
};
i.prototype.goForward = function () {
  this._currentIndex = Math.max(this._currentIndex - 1, 0);
};
i.prototype._getIndexInRange = function () {
  return this._currentIndex % (this._buffer.length + 1);
};
i.prototype.getCurrentEntry = function () {
  var e = this._getIndexInRange();
  return 0 === e ? o : this._buffer[e - 1];
};
e.exports = i;
this._buffer = [];
this._currentIndex = 0;
this._buffer.unshift({
  message: e,
  links: t
});
this._buffer.length > n && this._buffer.pop();
this._currentIndex = 0;
this.currentStatus = l.PLAYER_STATUS_AVAILABLE;
this._createContent(e);
this._setListeners();
d[l.PLAYER_STATUS_AFK] = "ui.chat.status.away";
d[l.PLAYER_STATUS_IDLE] = "ui.chat.status.idle";
d[l.PLAYER_STATUS_PRIVATE] = "ui.chat.status.private";
d[l.PLAYER_STATUS_SOLO] = "ui.chat.status.solo";
d[l.PLAYER_STATUS_AVAILABLE] = "ui.chat.status.availiable";
e.exports = n;
n.prototype.initialize = function () {
  this.currentStatus = l.PLAYER_STATUS_AVAILABLE;
};
n.prototype._createContent = function (e) {
  this.statusButton = e.createChild("div", {
    className: ["statusButton", "available"]
  });
  var t = this;
  c.addTooltip(this.statusButton, function () {
    return s(d[t.currentStatus]);
  });
  this.statusButton.on("tap", function () {
    var e = this.rootElement.getBoundingClientRect();
    window.gui.openContextualMenu("userStatus", null, {
      x: e.left + e.width,
      y: e.top
    });
  });
};
n.prototype._setCurrentStatus = function (e) {
  e !== l.PLAYER_STATUS_IDLE && (this.currentStatus = e);
  this.statusButton.replaceClassNames(["available", "away", "private", "solo"], [o(e)]);
};
n.prototype._setListeners = function () {
  var e = this;
  a.on("PlayerStatusUpdateMessage", function (t) {
    t.playerId === window.gui.playerData.characterBaseInformations.id && e._setCurrentStatus(t.status.statusId);
  });
  r.on("inactive", function (t) {
    var i = t ? l.PLAYER_STATUS_IDLE : e.currentStatus;
    window.dofus.sendMessage("PlayerStatusUpdateRequestMessage", {
      status: {
        statusId: i
      }
    });
  });
};
c.addTooltip(this.statusButton, function () {
  return s(d[t.currentStatus]);
});
this.statusButton.on("tap", function () {
  var e = this.rootElement.getBoundingClientRect();
  window.gui.openContextualMenu("userStatus", null, {
    x: e.left + e.width,
    y: e.top
  });
});
e !== l.PLAYER_STATUS_IDLE && (this.currentStatus = e);
this.statusButton.replaceClassNames(["available", "away", "private", "solo"], [o(e)]);
a.on("PlayerStatusUpdateMessage", function (t) {
  t.playerId === window.gui.playerData.characterBaseInformations.id && e._setCurrentStatus(t.status.statusId);
});
r.on("inactive", function (t) {
  var i = t ? l.PLAYER_STATUS_IDLE : e.currentStatus;
  window.dofus.sendMessage("PlayerStatusUpdateRequestMessage", {
    status: {
      statusId: i
    }
  });
});
s || (e.error(new Error("The message is missing.")), s = {});
this._id = s.id || -1;
this._content = s.content || "";
this._channel = s.channel;
this._channel || 0 === this._channel || (this._channel = -1);
this._receiverId = s.receiverId;
this._senderId = s.senderId;
this._tag = s.tag;
this._timestamp = s.timestamp;
this._senderAccountId = s.senderAccountId;
this._messageType = s._messageType;
this._content = s.content || "";
this._receiverName = s.receiverName;
this._senderName = s.senderName;
this._isCopy = n || !1;
this._canDecodeAllPages = o || !1;
this._hideTimestamp = a || !1;
this._channelMap = t || {};
this._guildInfo = s.guildInfo;
this._objects = s.objects;
l(n, d);
e.exports = n;
n.prototype._createPlayerText = function () {
  var e = this._isCopy ? this._receiverName : this._senderName,
    t = this._isCopy ? this._receiverId : this._senderId;
  return e ? t ? "{player," + e + "," + t + ",channel:" + this._channel.toString() + "}" : e : "unknownPlayer";
};
n.prototype._createMessageContent = function () {
  var e = u(),
    t = new this._wuidom("div", {
      className: "message"
    }),
    i = "ChatAdminServerMessage" === this._messageType,
    n = this._isRemoved;
  t.addClassNames("channel" + this._channel.toString());
  i && t.addClassNames("mod");
  var o = this._createPlayerText(),
    s = this._content.match(/\/([a-zA-Z]+),[b|m]essage:([^\\}]*)/),
    l = !0,
    d = this._content;
  if (s && (d = s[2], "me" === s[1] ? (l = !1, t.addClassNames("meText")) : "think" === s[1] && (t.addClassNames("thinkText"), o = r("ui.chat.console.think", o))), this._channel !== m && this._channel !== f) {
    var p = this._channelMap[this._channel] || {},
      g = p.nameId || "channel" + this._channel;
    t.createChild("span", {
      text: "(" + g + ") "
    });
  }
  if (this._tag === a.CHAT_TAG_COMMUNITY_HELPER && t.createChild("span", {
    text: "(Helper) ",
    className: "link"
  }), this._channel === f) {
    var _ = r(this._isCopy ? "ui.chat.to" : "ui.chat.from");
    t.createChild("span", {
      text: _ + " "
    });
  }
  if (n && t.createChild("span", {
    text: "[REMOVED] "
  }), !this._hideTimestamp) {
    var v = new h(1e3 * this._timestamp).getServerDate(),
      y = v.minute,
      w = y < 10 ? "0" + y : y;
    t.createChild("span", {
      className: "chatTimestamp",
      text: "[" + v.hour + ":" + w + "] "
    });
  }
  var b = l ? r("ui.common.colon") + " " : " ",
    M = t.createChild("div", {
      className: "icon"
    });
  e.gui.playerData.id !== this._senderId && (e.gui.playerData.socialData.isSpouse(this._senderId) ? M.addClassNames("spouse") : Boolean(this._senderAccountId) && e.gui.playerData.socialData.isFriend(this._senderId) ? M.addClassNames("friend") : Boolean(this._guildInfo) && e.gui.playerData.guildData.isOnSameGuild(this._guildInfo.guildId) ? M.addClassNames("guildMember") : Boolean(this._guildInfo) && e.gui.playerData.alliance.isGuildOnSameAlliance(this._guildInfo.guildId) && M.addClassNames("allianceMember"));
  var T = c.process(o + b);
  return t.appendChild(T), t.appendChild(c.process(d, {
    objectItems: this._objects,
    channel: this._channel,
    decodeAllPages: this._canDecodeAllPages,
    senderId: this._senderId,
    senderName: this._senderName
  })), t;
};
t.addClassNames("channel" + this._channel.toString());
i && t.addClassNames("mod");
this._wuidom = i;
this._id = -1;
this._content = "";
this._channelMap = t || {};
this._dom = null;
this._contentDom = null;
this._isRemoved = !1;
e.exports = n;
n.prototype._createMessageContent = function () {};
n.prototype.getId = function () {
  return this._id;
};
n.prototype.getDom = function () {
  return this._dom ? this._dom : (this._dom = new this._wuidom("div", {
    className: "messageWrapper"
  }), this._contentDom = this._createMessageContent(), this._dom.appendChild(this._contentDom), this._dom);
};
n.prototype.updateContent = function (e) {
  this._content = e;
  var t = this.getDom();
  return this.deleteContent(), this._contentDom = this._createMessageContent(), this._dom.appendChild(this._contentDom), t;
};
n.prototype.updateMessage = function (e) {
  e === o.MARK_REMOVED && (this._isRemoved = !0);
  this.updateContent(this._content);
};
n.prototype.deleteContent = function () {
  this._dom && this._dom.clearContent();
};
e === o.MARK_REMOVED && (this._isRemoved = !0);
this.updateContent(this._content);
this._text = i;
this._channel = n;
this._parentClassName = o || "";
this._important = a || 0;
this._options = c;
l(n, r);
e.exports = n;
n.prototype._createMessageContent = function () {
  var e = new s("div", {
    className: "message"
  });
  if (this._important === c && e.addClassNames("mod"), e.addClassNames("channel" + this._channel), this._options.showChannelName && this._channelMap[this._channel] && this._channelMap[this._channel].nameId && e.createChild("span", {
    text: "(" + this._channelMap[this._channel].nameId + ") "
  }), this._options.npcId) {
    var t = "{npc," + this._options.npcId + "::" + this._options.npcName + "}";
    e.appendChild(a.process(t + o("ui.common.colon") + " "));
  } else if (this._options.playerId) {
    var i = "{player," + this._options.playerName + "," + this._options.playerId + "}";
    e.appendChild(a.process(i + " "));
    e.addClassNames("meText");
  }
  return e.appendChild(a.process(this._text, {
    isNonChat: !0,
    channel: this._channel,
    parentClassName: this._parentClassName
  })), e;
};
e.appendChild(a.process(i + " "));
e.addClassNames("meText");
t = t || {};
a.call(this, "div", {
  className: "CheckboxLabel",
  text: e
});
t.defaultValue ? (this._active = !0, this.addClassNames("on")) : this._active = !1;
this.isRadio = t.isRadio;
s(this);
this.on("tap", function () {
  this._active && !this.isRadio ? (this.deactivate(), r("CHECKBOX_UNCHECKED")) : this._active || (this.activate(), r("CHECKBOX_CHECKED"));
});
this.on("enable", function (e) {
  i.toggleClassName("disabled", !e);
});
o(n, a);
e.exports = n;
n.prototype.activate = function (e) {
  var t = this;
  this._active = !0;
  this.addClassNames("on");
  var i = this.getParent();
  if (this.isRadio && i) {
    var o = i.getChildren();
    o.forEach(function (i) {
      i !== t && t instanceof n && i.deactivate(e);
    });
  }
  e || (this.emit("activate"), this.emit("change", !0));
};
n.prototype.deactivate = function (e) {
  this._active = !1;
  this.delClassNames("on");
  e || (this.emit("deactivate"), this.emit("change", !1));
};
n.prototype.toggleActivation = function (e, t) {
  void 0 === e && (e = !this._active);
  e ? this.activate(t) : this.deactivate(t);
};
n.prototype.isActivate = function () {
  return this._active;
};
this._active = !0;
this.addClassNames("on");
this._active = !1;
this.delClassNames("on");
e || (this.emit("deactivate"), this.emit("change", !1));
void 0 === e && (e = !this._active);
e ? this.activate(t) : this.deactivate(t);
this.linksToReplace = [];
this.previousLinks = [];
e.exports = n;
n.OBJ_REPL_CHAR = r;
n.prototype.newLinkForSending = function (e, t) {
  var i, n, o;
  if (this.linksToReplace.length >= s.MAX_CHAT_OBJECT_REF) {
    return "";
  }
  switch (e) {
    case "recipe":
      i = "[" + a("ui.common.recipes", 1) + a("ui.common.colon") + t.getName() + "]";
      n = "{recipe," + t.getProperty("id") + "}";
      break;
    case "itemStats":
      i = "[" + t.getName() + "]";
      n = r;
      o = t;
      break;
    default:
      return console.error(new Error("Invalid link type: " + e));
  }
  return this.linksToReplace.push([i, n, o]), " " + i + " ";
};
n.prototype.prepareForSending = function (e, t) {
  for (var i = 0; i < this.linksToReplace.length; i++) {
    var n = this.linksToReplace[i],
      a = e.replace(n[0], n[1]);
    n[2] && a !== e && t.push(o(n[2]));
    e = a;
  }
  return this.previousLinks = this.linksToReplace, this.linksToReplace = [], e;
};
n.prototype.undoPrepareForSending = function () {
  this.linksToReplace = this.previousLinks;
};
n.prototype.replaceLinksReceived = function (e, t) {
  for (var i = 0; i < t.length; i++) {
    var n = t[i],
      o = "{itemStats," + n.objectGID + "," + n.objectUID + "}";
    e = e.replace(r, o);
  }
  return e;
};
i = "[" + a("ui.common.recipes", 1) + a("ui.common.colon") + t.getName() + "]";
n = "{recipe," + t.getProperty("id") + "}";
i = "[" + t.getName() + "]";
n = r;
o = t;
n[2] && a !== e && t.push(o(n[2]));
e = a;
this._whoIsMap = {};
this._setEventListeners();
e.exports = n;
n.prototype.processMsg = function (e, t) {
  if (e.channel !== o.PSEUDO_CHANNEL_PRIVATE) {
    return !1;
  }
  var i = e.content;
  if (i.substr(0, l.length) !== l) {
    return !1;
  }
  if (i.substr(i.length - c.length) !== c) {
    return !1;
  }
  if (t) {
    return !0;
  }
  var n = i.substring(l.length, i.length - c.length),
    a = n.split(d);
  switch (a[0]) {
    case "rejoinRequest":
      var s = parseInt(a[1], 10);
      window.gui.playerData.partyData.handleRejoinRequest(s, e.senderId);
      break;
    default:
      window.dofus.sendMessage("IgnoredAddRequestMessage", {
        name: e.senderName,
        session: !0
      });
      console.error("Ignoring player " + e.senderName + " who sent invalid p2p command: " + e.content);
  }
  return !0;
};
n.prototype.sendMsg = function (e, t) {
  for (var i = l + t, n = 2; n < arguments.length; n++) {
    i += d + arguments[n].toString();
  }
  i += c;
  a.sendMessage(i, o.PSEUDO_CHANNEL_PRIVATE, e);
};
n.prototype.checkPlayerOnline = function (e, t) {
  var i = this._whoIsMap[e];
  i ? i.cbs.push(t) : (window.dofus.sendMessage("BasicWhoIsRequestMessage", {
    search: e,
    verbose: !1
  }), this._whoIsMap[e] = {
    cbs: [t],
    timeout: r.setTimeout(this._playerOnlineHandler.bind(this, e, !1), u)
  });
};
n.prototype._playerOnlineHandler = function (e, t) {
  var i = this._whoIsMap[e];
  delete this._whoIsMap[e];
  r.clearTimeout(i.timeout);
  for (var n = i.cbs, o = 0; o < n.length; o++) {
    n[o](e, t);
  }
};
n.prototype._setEventListeners = function () {
  var e = this;
  window.gui.on("disconnect", function () {
    e._whoIsMap = {};
  });
  window.dofus.connectionManager.on("BasicWhoIsMessage", function (t) {
    t.verbose || e._whoIsMap[t.playerName] && e._playerOnlineHandler(t.playerName, t.playerState !== s.NOT_CONNECTED);
  });
};
window.dofus.sendMessage("IgnoredAddRequestMessage", {
  name: e.senderName,
  session: !0
});
console.error("Ignoring player " + e.senderName + " who sent invalid p2p command: " + e.content);
i += c;
a.sendMessage(i, o.PSEUDO_CHANNEL_PRIVATE, e);
delete this._whoIsMap[e];
r.clearTimeout(i.timeout);
window.gui.on("disconnect", function () {
  e._whoIsMap = {};
});
window.dofus.connectionManager.on("BasicWhoIsMessage", function (t) {
  t.verbose || e._whoIsMap[t.playerName] && e._playerOnlineHandler(t.playerName, t.playerState !== s.NOT_CONNECTED);
});
"GuildInformations" === d._type && (r += " " + n("ui.common.guild"), r += " {guild," + d.guildId + "::" + d.guildName + "}");
"AllianceInformations" === d._type && (r += " " + n("ui.common.alliance"), r += " {alliance," + d.allianceId + "::[" + d.allianceTag + "]}");
p = !0;
m.w = g.w = e.rootElement.clientWidth;
m.h = g.h = e.rootElement.clientHeight;
f.x = i.x;
f.y = i.y;
e.emit("resizeStart");
window.gui.wBody.once("dom.touchend", a);
window.gui.wBody.on("dom.touchmove", n);
n(t);
_ && (a = 0);
g.w = m.w + a;
g.h = m.h + r;
g.w = Math.min(Math.max(g.w, u), o.windowFullScreenWidth - c.x);
g.h = Math.min(Math.max(g.h, h), o.windowFullScreenHeight - c.y);
e.setStyles({
  width: g.w + "px",
  height: g.h + "px"
});
t.eventOnResize && e.emit("resizeMove", g);
window.gui.wBody.removeListener("dom.touchmove", n);
p = !1;
e.windowWidth = g.w;
e.windowHeight = g.h;
e.emit("resize");
e.resizeHandle = e.createChild("div", {
  className: "resizeHandle"
});
e.resizeHandle.allowDomEvents();
e.setWidthLock = function (e) {
  _ = !!e;
};
e.resizeHandle.on("dom.touchstart", i);
this.censoredMap = {};
a.getAllDataMap("CensoredWords", function (t, i) {
  t && console.error("Censor getAllDataMap:", t);
  var n = window.Config.language;
  for (var o in i) {
    i[o].language === n && (e.censoredMap[i[o].word] = !0);
  }
});
e.exports = o;
o.prototype.filterCensoredWords = function (e) {
  if (!s.getValue("option-censorship", !0)) {
    return e;
  }
  for (var t = e.split(" "), i = 0; i < t.length; i++) {
    this.censoredMap[t[i].toLowerCase()] && (t[i] = n(t[i].length));
  }
  return t.join(" ");
};
i.on("tapstart", function () {
  e.addClassNames("pressed");
});
i.on("tapend", function () {
  e.delClassNames("pressed");
});
window.gui.on("resize", function () {
  if (this.ipadRatio) {
    e.setStyles({
      left: a.posChatBtn + "px",
      right: "auto",
      top: "auto",
      bottom: 0,
      width: o.CHAT_BTN_MIN_WIDTH + "px",
      height: a.bottomBarHeight + "px"
    });
  } else {
    var t, i;
    t = a.sideBarWidth - o.PING_EMOTE_BTN_WIDE_MIN_WIDTH;
    i = 0;
    e.setStyles({
      left: "auto",
      right: i + "px",
      top: a.posChatBtn + "px",
      bottom: "auto",
      width: t + "px",
      height: o.CHAT_BTN_MIN_HEIGHT + "px"
    });
  }
});
t = a.sideBarWidth - o.PING_EMOTE_BTN_WIDE_MIN_WIDTH;
i = 0;
e.setStyles({
  left: "auto",
  right: i + "px",
  top: a.posChatBtn + "px",
  bottom: "auto",
  width: t + "px",
  height: o.CHAT_BTN_MIN_HEIGHT + "px"
});
s(n, r);
e.exports = n;
t.SMITHMAGIC_RUNE_ID = 78;
t.SMITHMAGIC_POTION_ID = 26;
t.SIGNATURE_RUNE_ID = 7508;
t.SIGNATURE_AVAILABLE_LEVEL = 100;
t.initialize = function (e) {
  e.on("ExchangeOkMultiCraftMessage", n);
  e.on("ExchangeStartOkCraftWithInformationMessage", o);
  e.on("ExchangeStartOkMulticraftCrafterMessage", function (e) {
    a(e, {
      isCrafter: !0
    });
  });
  e.on("ExchangeStartOkMulticraftCustomerMessage", function (e) {
    a(e, {
      isCrafter: !1
    });
  });
  h.on("ObjectUpgradeEffectOpenMessage", s);
};
t.displayAutoCraftStopReasonMessage = function (e) {
  var t = "",
    i = !0;
  switch (e) {
    case r.STOPPED_REASON_OK:
      t = c("ui.craft.autoCraftStopedOk");
      break;
    case r.STOPPED_REASON_USER:
      t = c("ui.craft.autoCraftStoped");
      i = !1;
      break;
    case r.STOPPED_REASON_MISSING_RESSOURCE:
      t = c("ui.craft.autoCraftStopedNoRessource");
      break;
    case r.STOPPED_REASON_IMPOSSIBLE_CRAFT:
      t = c("ui.craft.autoCraftStopedInvalidRecipe");
  }
  var n = window.gui;
  i && n.openSimplePopup(t, c("ui.popup.information"));
  t && n.chat.logMsg(t);
};
e.on("ExchangeOkMultiCraftMessage", n);
e.on("ExchangeStartOkCraftWithInformationMessage", o);
e.on("ExchangeStartOkMulticraftCrafterMessage", function (e) {
  a(e, {
    isCrafter: !0
  });
});
e.on("ExchangeStartOkMulticraftCustomerMessage", function (e) {
  a(e, {
    isCrafter: !1
  });
});
h.on("ObjectUpgradeEffectOpenMessage", s);
t = c("ui.craft.autoCraftStoped");
i = !1;
i && n.openSimplePopup(t, c("ui.popup.information"));
t && n.chat.logMsg(t);
h.getWindow("cancel").update(t, {
  keepDialog: e
});
h.openDialog(["cancel"]);
h.getWindow("confirm").update(t, {
  ignoreEnable: !0,
  keepDialog: e
});
h.openDialog(["confirm"]);
t.askingExchangePopup = function () {
  s = {
    confirm: function () {
      window.dofus.sendMessage("ExchangeAcceptMessage");
    },
    refuse: void 0,
    ignore: function () {
      window.dofus.sendMessage("IgnoredAddRequestMessage", {
        name: l,
        session: !0
      });
    }
  };
  r = void 0;
  n(!0);
};
t.askingChallengePopup = function (e) {
  function t() {
    window.dofus.sendMessage("GameRolePlayPlayerFightFriendlyAnswerMessage", {
      fightId: e,
      accept: !0
    });
  }
  function i() {
    window.dofus.sendMessage("GameRolePlayPlayerFightFriendlyAnswerMessage", {
      fightId: e,
      accept: !1
    });
  }
  function o() {
    i();
    window.dofus.sendMessage("IgnoredAddRequestMessage", {
      name: l,
      session: !0
    });
  }
  s = {
    confirm: t,
    refuse: i,
    ignore: o
  };
  r = i;
  n(!1);
};
t.closingChallengePopup = function (e) {
  var t = e ? "cancel" : "confirm",
    i = h.getWindow(t);
  h.close(i.id);
};
t.setupCancelPopupTexts = function (e) {
  a = e;
};
t.setupConfirmPopupTexts = function (e) {
  o = e;
};
t.setupNames = function (e, t) {
  var i = window.gui.playerData;
  c = i.id;
  d = i.characterBaseInformations.name;
  u = t === c;
  var n = u ? e : t,
    o = window.actorManager.getActor(n);
  if (!o) {
    return console.error(new Error("mutualPopup#setupNames cannot find the other actor: " + n)), null;
  }
  var a = o.data.name;
  l = u ? d : a;
  var s = u ? a : d;
  return {
    sourceName: l,
    targetName: s
  };
};
s = {
  confirm: function () {
    window.dofus.sendMessage("ExchangeAcceptMessage");
  },
  refuse: void 0,
  ignore: function () {
    window.dofus.sendMessage("IgnoredAddRequestMessage", {
      name: l,
      session: !0
    });
  }
};
r = void 0;
n(!0);
i();
window.dofus.sendMessage("IgnoredAddRequestMessage", {
  name: l,
  session: !0
});
s = {
  confirm: t,
  refuse: i,
  ignore: o
};
r = i;
n(!1);
c = i.id;
d = i.characterBaseInformations.name;
u = t === c;
window.gui.on("resize", function () {
  e.setStyles({
    left: o.mapLeft + l + "px",
    bottom: o.screenHeight - o.mapBottom + l + "px"
  });
});
this.mutedChannelsId = {};
a(n, s);
e.exports = n;
n.prototype.add = function (e, t) {
  function i(e) {
    e.delClassNames("on");
    setTimeout(function () {
      e.destroy();
    }, 300);
  }
  t = t || {};
  var n = this.createChild("div", {
      className: "bubble"
    }),
    o = n.createChild("div", {
      className: "bubbleText"
    });
  n.addClassNames(t.className);
  var a = t.channel;
  void 0 === a && (a = r.PSEUDO_CHANNEL_INFO);
  n.addClassNames("channel" + a);
  "object" == typeof e ? o.appendChild(e) : o.setHtml(e.toString());
  setTimeout(function () {
    n.addClassNames("on");
  }, 50);
  setTimeout(function () {
    n.rootElement && i(n);
  }, 7e3);
};
e.delClassNames("on");
setTimeout(function () {
  e.destroy();
}, 300);
void 0 === a && (a = r.PSEUDO_CHANNEL_INFO);
n.addClassNames("channel" + a);
"object" == typeof e ? o.appendChild(e) : o.setHtml(e.toString());
setTimeout(function () {
  n.addClassNames("on");
}, 50);
setTimeout(function () {
  n.rootElement && i(n);
}, 7e3);
u.call(this, "div", {
  className: "shopFloatingToolbar"
});
r(this, {
  grip: this
});
i.once("resize", function () {
  t.setStyles({
    left: Math.round(s.mapRight / 3 * 2) + "px",
    top: "0px"
  });
});
i.on("connected", function () {
  t._toggleDisplay(!0);
});
i.on("disconnect", function () {
  t._toggleDisplay(!1);
});
n.on("stepChanged", function () {
  t._toggleDisplay(!0);
});
i.fightManager.on("fightStart", function () {
  t._toggleDisplay(!1);
});
i.fightManager.on("fightEnd", function () {
  t._toggleDisplay(!0);
});
l(o, u);
e.exports = o;
o.prototype._toggleDisplay = function (e) {
  var t = !window.gui.scenarioManager.isBehaviourEnabled(p.SHOP_BUTTON);
  this.toggleDisplay(!t && e);
};
o.prototype._shopBtnTap = function () {
  n();
  var e = h(this.rootElement);
  d.log("HUD.Click_on_button", {
    interface_id: "ShopFloatingToolbar",
    button_id: "BTN_IG_SHOP",
    clic_parameter_key: "position",
    clic_parameter_value: ~~e.left + "," + ~~e.top,
    clic_type: "Simple_court"
  });
};
this._init();
s.init(this);
c.init();
t.on("connected", this._onConnect.bind(this));
t.on("disconnect", this._onDisconnect.bind(this));
n.on("worldMapUpdate", function () {
  e._changeMap(this.worldmapId);
});
n.on("mapUpdate", function () {
  e._delayedPois.length && e._addDelayedPois();
  i.isFighting && e._compass.setAllMarkersVisibility(!1);
  e._scheduleRendering();
});
t.fightManager.on("fightStart", function () {
  e._compass.setAllMarkersVisibility(!1);
  e._scheduleRendering();
});
t.fightManager.on("fightEnd", function () {
  e._startQuietAnimationPeriod(3e3);
  e._compass.setAllMarkersVisibility(!0);
});
u.on("autoGpsPhoenixes", function () {
  e._compass.showOrHidePhoenixMarkers();
});
e._delayedPois.length && e._addDelayedPois();
i.isFighting && e._compass.setAllMarkersVisibility(!1);
e._scheduleRendering();
e._compass.setAllMarkersVisibility(!1);
e._scheduleRendering();
e._startQuietAnimationPeriod(3e3);
e._compass.setAllMarkersVisibility(!0);
r(n, a);
n.prototype._init = function () {
  this._POIMap = {};
  this._POIMap[v] = {};
  this._lastPhoenixes = [];
  this._delayedPois = [];
  this._isRenderingRequested = !1;
  this._waitingPoiCount = 0;
  this._interval = null;
  this._nextRenderTime = 0;
  this._compass = window.gui.compass;
};
n.prototype._onConnect = function () {
  this._init();
};
n.prototype._onDisconnect = function () {
  this._removeAllPois();
  p.clearInterval(this._interval);
  this._interval = null;
};
n.prototype._startQuietAnimationPeriod = function (e) {
  this._compass.setFlashyAnimationEnabled(!1);
  p.setTimeout(this._compass.setFlashyAnimationEnabled.bind(this._compass, !0), e);
};
n.prototype._requestUpdatePOI = function (e, t, i, n) {
  e.x === t && e.y === i || (e.x = t, e.y = i, n && (e.nameId = n), e.isDestination && this._compass.updateMarker(e.id, e.x, e.y, e.nameId), this.emit("updatePOI", e));
};
n.prototype.updatePOI = function (e) {
  this._updatePOI(e);
  this._scheduleRendering();
};
n.prototype._updatePOI = function (e) {
  var t = e.id,
    i = e.x,
    n = e.y,
    o = e.nameId,
    a = window.gui.playerData.position.worldmapId,
    s = this._getPOI(t, a);
  if (s) {
    this._requestUpdatePOI(s, i, n, o);
  } else {
    if (void 0 === i && void 0 === n) {
      return console.error("unexpected undefined x,y");
    }
    delete e.mapId;
    this._addPOI(e);
  }
};
n.prototype._setTrackingEnabled = function (e, t, i) {
  if (t) {
    this._compass.addMarker({
      type: e.id,
      x: e.x,
      y: e.y,
      arrowType: e.categoryId,
      tooltip: e.nameId
    });
  } else {
    this._compass.removeMarker(e.id);
    var n = this.getObjectiveId(e),
      o = window.gui.playerData.quests.getQuestIdfromObjectiveId(n);
    i && this.questFollower.unfollowQuest(o);
  }
};
n.prototype._requestGuildInfo = function () {
  if (window.gui.playerData.guild.hasGuild()) {
    for (var e in m) {
      var t = m[e];
      window.dofus.sendMessage("GuildGetInformationsMessage", {
        infoType: t
      });
    }
  }
};
n.prototype._removeAllPois = function () {
  for (var e in this._POIMap) {
    var t = this._POIMap[e];
    for (var i in t) {
      this._removePOI(i, e);
    }
  }
};
n.prototype._isDungeonMap = function (e) {
  return e !== g && e !== f && e !== _;
};
n.prototype._addDelayedPois = function () {
  for (var e = this._delayedPois.length, t = 0; t < e; t++) {
    var i = this._delayedPois.shift();
    this._addPOI(i);
  }
  this._scheduleRendering();
};
n.prototype._scheduleRendering = function () {
  this._nextRenderTime = Date.now() + y;
  this._isRenderingRequested = !0;
  this._interval || (this._interval = p.setInterval(this._renderTick.bind(this), y));
};
n.prototype._renderTick = function () {
  this._isRenderingRequested && (this._waitingPoiCount > 0 || Date.now() < this._nextRenderTime || (this._isRenderingRequested = !1, this._compass.renderAllMarkers()));
};
n.prototype.addPOI = function (e) {
  this._addPOI(e);
  this._scheduleRendering();
};
n.prototype._addPOI = function (e) {
  if (0 === window.gui.playerData.position.worldmapId) {
    return void this._delayedPois.push(e);
  }
  if (e.mapId) {
    this._waitingPoiCount++;
    var t = this;
    d.getObject("MapPositions", e.mapId, function (i, n) {
      return t._waitingPoiCount--, i ? console.error("No MapPosition for POI at " + e.mapId + "; " + i) : void t._addPoiSync(e, n);
    });
  } else {
    var i;
    i = "questObjective" === e.categoryId ? f : window.gui.playerData.position.worldmapId;
    this._addPoiSync(e, {
      worldMap: i,
      posX: e.x,
      posY: e.y
    });
  }
};
n.prototype._addPoiSync = function (e, t) {
  var i = t.posX,
    n = t.posY,
    o = window.gui.playerData.position.worldmapId,
    a = t.worldMap || o;
  if (a === -1 && (a = e.worldMapId ? e.worldMapId : o), a === v) {
    return console.error('worldMapId is "fixed"');
  }
  var s = window.gui.databases.WorldMaps[a];
  if (!s) {
    return console.error(new Error("WorldMap missing in DB:" + a));
  }
  a = s.id;
  this._POIMap[a] || (this._POIMap[a] = {});
  var r = this._POIMap[a][e.id];
  if (r) {
    return this._requestUpdatePOI(r, i, n);
  }
  var c = new l(e);
  c.x = i;
  c.y = n;
  c.worldMapId = a;
  this._POIMap[a][c.id] = c;
  c.isDestination && this._addDestination(c);
  this.emit("addPOI", c);
};
n.prototype.addFlag = function (e, t, i) {
  var n = this._compass.addMarker({
    type: e,
    x: t,
    y: i
  });
  return this._scheduleRendering(), n;
};
n.prototype.removeFlag = function (e) {
  this._compass.removeMarker({
    type: e
  });
  this._scheduleRendering();
};
n.prototype.removePOI = function (e, t, i) {
  if (void 0 !== t) {
    this._removePOI(e, t, i);
  } else {
    for (var n in this._POIMap) {
      this._removePOI(e, n, i);
    }
  }
  this._scheduleRendering();
};
n.prototype._removePOI = function (e, t, i) {
  var n = this._getPOI(e, t);
  n && (n.isDestination && this._removeDestination(n, i), delete this._POIMap[t][e], this.emit("removePOI", n), this._POIMap[v] && delete this._POIMap[v][e]);
};
n.prototype._changeMap = function (e) {
  if (void 0 !== e) {
    this._isDungeonMap(e) || this._requestGuildInfo();
    var t, i;
    for (t in this._POIMap[v]) {
      i = this._POIMap[v][t];
      this._removePOI(t, this._lastWorldMapId);
      i.mapId = 0;
      this._addPOI(i);
    }
    var n = this._POIMap[this._lastWorldMapId];
    if (n) {
      for (t in n) {
        i = n[t];
        i.isDestination && this._setTrackingEnabled(i, !1);
      }
    }
    var o = [];
    for (t in this._POIMap[e]) {
      i = this._POIMap[e][t];
      i.isDestination && (this._setTrackingEnabled(i, !0), o.push(i.id));
    }
    var a = this._compass;
    for (t in a.markers) {
      o.indexOf(t) === -1 && a.removeMarker(t);
    }
    this._scheduleRendering();
    this.emit("changedMap", e);
    this._lastWorldMapId = e;
  }
};
n.prototype._getPOI = function (e, t) {
  var i = this._POIMap[t] || {};
  return i[e];
};
n.prototype.isActivePOI = function (e) {
  for (var t in this._POIMap) {
    if (this._POIMap[t][e]) {
      return !0;
    }
  }
  return !1;
};
n.prototype.getPOIs = function (e) {
  return e = e || window.gui.playerData.position.worldmapId, this._POIMap[e] || {};
};
n.prototype._addDestination = function (e) {
  e.worldMapId === window.gui.playerData.position.worldmapId && this._setTrackingEnabled(e, !0);
  this.emit("addDestination", e);
};
n.prototype._removeDestination = function (e, t) {
  e.worldMapId === window.gui.playerData.position.worldmapId && this._setTrackingEnabled(e, !1, t);
  this.emit("removeDestination", e);
};
n.prototype.getQuestObjectivePoiId = function (e) {
  return "quest_" + e;
};
n.prototype.getObjectiveId = function (e) {
  var t = e.id.indexOf("quest_");
  return t < 0 ? 0 : parseInt(e.id.slice(t + 6), 10);
};
n.prototype.addQuestObjectiveFromObjective = function (e) {
  var t = e.objectiveDb,
    i = e.objectiveId,
    n = e.questId,
    a = e.coords || null,
    s = this,
    r = this.getQuestObjectivePoiId(i);
  if (!this.isActivePOI(r)) {
    var l = t.mapId;
    if (!a) {
      if (l) {
        return o(l, function (e, o) {
          return e ? console.error("questId: " + n + ", objectiveId: " + i + ", error: " + e) : (o = o || t.coords, void s.addQuestObjectiveFromObjective({
            objectiveDb: t,
            objectiveId: i,
            coords: o,
            questId: n
          }));
        });
      }
      a = t.coords;
    }
    if (a && void 0 !== a.x && void 0 !== a.y) {
      var c = window.gui.playerData.quests.all[n];
      if (!c) {
        return void console.error(new Error("GPS: Cannot find the quest: " + n + ", objectiveId: " + i));
      }
      for (var d = c.dbQuest ? c.dbQuest.nameId : "", u = "", h = 0; h < c.objectives.length; h++) {
        var p = c.objectives[h];
        if (p.objectiveId === i) {
          u = p.text;
          break;
        }
      }
      var m = {
        id: r,
        x: a.x,
        y: a.y,
        mapId: l,
        worldMapId: a.worldMapId,
        nameId: d + "\n\n" + u + "\n\n(" + a.x + "," + a.y + ")",
        categoryId: "questObjective",
        color: {
          r: 148,
          g: 185,
          b: 35,
          a: 1
        },
        isDestination: !0
      };
      this.addPOI(m);
    }
  }
};
n.prototype.addQuestObjective = function (e, t) {
  var i = window.gui.playerData.quests;
  if (!i[e]) {
    return console.warn("GPS.addQuestObjective: quest id" + e + " is not active.");
  }
  var n = i[e].dbObjectives[t];
  this.addQuestObjectiveFromObjective({
    objectiveDb: n,
    objectiveId: t,
    questId: e
  });
};
n.prototype.addQuestNextObjective = function (e) {
  var t = window.gui.playerData.quests;
  if (!t.active[e]) {
    return console.warn("GPS.addQuestNextObjective: quest id" + e + " is not active.");
  }
  for (var i = t.active[e], n = 0; n < i.objectives.length; n++) {
    var o = i.objectives[n];
    if (o.objectiveStatus) {
      var a = o.objectiveId,
        s = i.dbObjectives[a];
      this.addQuestObjectiveFromObjective({
        objectiveDb: s,
        objectiveId: a,
        questId: e
      });
    }
  }
};
n.prototype.removeQuestObjectives = function (e) {
  var t = window.gui.playerData.quests.all[e];
  if (!t) {
    return console.warn("GPS.removeQuestObjectives: quest id" + e + " not found.");
  }
  for (var i = 0; i < t.objectives.length; i++) {
    var n = t.objectives[i];
    if (n.objectiveStatus) {
      var o = n.objectiveId,
        a = this.getQuestObjectivePoiId(o);
      this.removePOI(a);
    }
  }
};
n.prototype.addAllQuestsObjectives = function () {
  var e = window.gui.playerData.quests;
  for (var t in e.active) {
    this.addQuestNextObjective(t);
  }
};
n.prototype.addAllFollowedQuestsObjectives = function () {
  var e = window.gui.playerData.quests;
  for (var t in e.active) {
    this.questFollower.isQuestFollowed(t) && this.addQuestNextObjective(t);
  }
};
n.prototype.isAtLeastOneQuestObjectiveFollowed = function (e) {
  var t = window.gui.playerData.quests.active[e];
  if (!t) {
    return console.warn("GPS.isAtLeastOneQuestObjectiveFollowed: quest id" + e + " not active."), !1;
  }
  for (var i = 0; i < t.objectives.length; i++) {
    var n = t.objectives[i];
    if (n.objectiveStatus) {
      var o = n.objectiveId,
        a = this.getQuestObjectivePoiId(o);
      if (this.isActivePOI(a)) {
        return !0;
      }
    }
  }
  return !1;
};
n.prototype.addCustomFlag = function (e, t, i) {
  i || (i = "");
  this.addPOI({
    id: "customFlag_" + e + "_" + t,
    x: e,
    y: t,
    categoryId: "customFlag",
    nameId: h("ui.cartography.customFlag") + "\n\n" + i + "(" + e + "," + t + ")",
    color: {
      r: 255,
      g: 221,
      b: 0,
      a: 1
    },
    isDestination: !0
  });
};
n.prototype.removeCustomFlag = function (e, t) {
  this.removePOI("customFlag_" + e + "_" + t);
};
n.prototype.addOrUpdateSpouse = function (e, t, i, n) {
  this.addPOI({
    id: "spouse",
    categoryId: "spouse",
    nameId: h("ui.cartography.positionof", e),
    color: {
      r: 255,
      g: 0,
      b: 137,
      a: 1
    },
    mapId: null !== t ? t : void 0,
    x: i,
    y: n,
    isDestination: !0
  });
};
n.prototype.removeSpouse = function () {
  this.removePOI("spouse");
};
n.prototype.autoGpsFlagOptionUpdate = function () {
  u.autoGpsFlags ? this.addAllFollowedQuestsObjectives() : (this._removeAllPois(), this._scheduleRendering());
};
n.prototype.questFollower = c;
e.exports = n;
this._POIMap = {};
this._POIMap[v] = {};
this._lastPhoenixes = [];
this._delayedPois = [];
this._isRenderingRequested = !1;
this._waitingPoiCount = 0;
this._interval = null;
this._nextRenderTime = 0;
this._compass = window.gui.compass;
this._removeAllPois();
p.clearInterval(this._interval);
this._interval = null;
this._compass.setFlashyAnimationEnabled(!1);
p.setTimeout(this._compass.setFlashyAnimationEnabled.bind(this._compass, !0), e);
this._updatePOI(e);
this._scheduleRendering();
delete e.mapId;
this._addPOI(e);
this._nextRenderTime = Date.now() + y;
this._isRenderingRequested = !0;
this._interval || (this._interval = p.setInterval(this._renderTick.bind(this), y));
this._addPOI(e);
this._scheduleRendering();
i = "questObjective" === e.categoryId ? f : window.gui.playerData.position.worldmapId;
this._addPoiSync(e, {
  worldMap: i,
  posX: e.x,
  posY: e.y
});
a = s.id;
this._POIMap[a] || (this._POIMap[a] = {});
c.x = i;
c.y = n;
c.worldMapId = a;
this._POIMap[a][c.id] = c;
c.isDestination && this._addDestination(c);
this.emit("addPOI", c);
this._compass.removeMarker({
  type: e
});
this._scheduleRendering();
i = this._POIMap[v][t];
this._removePOI(t, this._lastWorldMapId);
i.mapId = 0;
this._addPOI(i);
i = n[t];
i.isDestination && this._setTrackingEnabled(i, !1);
i = this._POIMap[e][t];
i.isDestination && (this._setTrackingEnabled(i, !0), o.push(i.id));
this._scheduleRendering();
this.emit("changedMap", e);
this._lastWorldMapId = e;
e.worldMapId === window.gui.playerData.position.worldmapId && this._setTrackingEnabled(e, !0);
this.emit("addDestination", e);
e.worldMapId === window.gui.playerData.position.worldmapId && this._setTrackingEnabled(e, !1, t);
this.emit("removeDestination", e);
i || (i = "");
this.addPOI({
  id: "customFlag_" + e + "_" + t,
  x: e,
  y: t,
  categoryId: "customFlag",
  nameId: h("ui.cartography.customFlag") + "\n\n" + i + "(" + e + "," + t + ")",
  color: {
    r: 255,
    g: 221,
    b: 0,
    a: 1
  },
  isDestination: !0
});
o.on("AccountHouseMessage", function (e) {
  e.houses.forEach(function (e) {
    t(e);
  });
});
o.on("GuildHousesInformationMessage", function (e) {
  e.housesInformations.forEach(function (e) {
    i(e);
  });
});
o.on("GuildHouseUpdateInformationMessage", function (e) {
  i(e.housesInformations);
});
o.on("GuildHouseRemoveMessage", function (t) {
  e.removePOI("guild_house_" + t.houseId);
});
o.on("GuildInformationsPaddocksMessage", function (e) {
  e.paddocksInformations.forEach(function (e) {
    n(e);
  });
});
o.on("GuildPaddockBoughtMessage", function (e) {
  n(e.paddockInfo);
});
o.on("GuildPaddockRemovedMessage", function (t) {
  e.removePOI("guild_paddock_" + t.paddockId);
});
i.on("objectiveValidated", function (t, i) {
  e.removePOI(e.getQuestObjectivePoiId(i));
});
i.on("stepValidated", function (t, i) {
  for (var n = t.dbSteps[i], o = 0; o < n.objectiveIds.length; o += 1) {
    e.removePOI(e.getQuestObjectivePoiId(n.objectiveIds[o]));
  }
});
i.on("questFinished", function (t) {
  for (var i = t.dbSteps[t.stepId], n = 0; n < i.objectiveIds.length; n += 1) {
    e.removePOI(e.getQuestObjectivePoiId(i.objectiveIds[n]));
  }
});
i.on("questUpdate", function (t) {
  e.questFollower.isQuestFollowed(t) && e.addQuestNextObjective(t);
});
i.on("questStarted", function (t) {
  u.autoGpsFlags && e.questFollower.followQuest(t, !0);
});
i.on("listUpdated", function () {
  e.addAllFollowedQuestsObjectives();
});
n = t.spouse;
n.followSpouse && e.addOrUpdateSpouse(n.spouseName, n.mapId);
i.on("CompassUpdateMessage", t);
i.on("CompassUpdatePartyMemberMessage", t);
i.on("CompassResetMessage", function (t) {
  switch (t.type) {
    case p.COMPASS_TYPE_SPOUSE:
      return e.removeSpouse();
    case p.COMPASS_TYPE_PARTY:
      e.removePOI("party_" + e._lastPartyMemberId);
      break;
    case p.COMPASS_TYPE_QUEST:
      e.removePOI("flag_srv" + t.type);
      break;
    default:
      e.removeFlag(t.type);
  }
});
o(e);
n(e);
a(e);
s(e);
r(e);
e = e || {};
this.id = e.id;
this.categoryId = e.categoryId || "custom";
this.x = e.x;
this.y = e.y;
this.nameId = e.nameId || "";
this.color = e.color;
this.color && !Array.isArray(this.color) && (this.color = [this.color.r / 124, this.color.g / 124, this.color.b / 124, this.color.a]);
this.data = e.data;
this.isDestination = e.isDestination;
this.iconId = e.iconId || n;
this.userPrefKey = null;
this.followedQuests = {};
o(s, n);
s.prototype.init = function () {
  var e = this,
    t = window.gui;
  t.playerData.on("characterSelectedSuccess", function () {
    e.userPrefKey = t.playerData.id + "-followedQuests";
    e.followedQuests = a.getValue(e.userPrefKey, {});
  });
  t.on("disconnect", this._clear);
};
s.prototype._clear = function () {
  this.userPrefKey = null;
  this.followedQuests = {};
};
s.prototype._save = function () {
  a.setValue(this.userPrefKey, this.followedQuests);
};
s.prototype.followQuest = function (e, t) {
  var i = window.gui,
    n = i.playerData.quests.active[e];
  return n ? (this.followedQuests[e] = !0, this._save(), n.objectives ? void (t && i.GPS.addQuestNextObjective(e)) : console.warn("followQuest: quest id " + e + " has no objectives")) : console.warn("followQuest: quest id " + e + " is not active");
};
s.prototype.unfollowQuest = function (e, t) {
  delete this.followedQuests[e];
  this._save();
  t && window.gui.GPS.removeQuestObjectives(e);
};
s.prototype.unfollowAllQuests = function () {
  var e = window.gui,
    t = e.playerData.quests.active;
  for (var i in t) {
    e.GPS.removeQuestObjectives(i);
  }
  this.followedQuests = {};
  this._save();
};
s.prototype.isQuestFollowed = function (e) {
  return !!this.followedQuests[e];
};
e.exports = new s();
t.playerData.on("characterSelectedSuccess", function () {
  e.userPrefKey = t.playerData.id + "-followedQuests";
  e.followedQuests = a.getValue(e.userPrefKey, {});
});
t.on("disconnect", this._clear);
e.userPrefKey = t.playerData.id + "-followedQuests";
e.followedQuests = a.getValue(e.userPrefKey, {});
this.userPrefKey = null;
this.followedQuests = {};
delete this.followedQuests[e];
this._save();
t && window.gui.GPS.removeQuestObjectives(e);
this.followedQuests = {};
this._save();
this._reset();
this._icon = this.createChild("div", {
  className: "icon"
});
this.on("tap", function () {
  e._updateToolTip();
  window.gui.openContextualMenu("generic", e._tooltipParams);
});
this._registerListeners();
e._updateToolTip();
window.gui.openContextualMenu("generic", e._tooltipParams);
c.open("guildHouseSetting");
window.dofus.sendMessage("HouseGuildRightsViewMessage");
s(n, r);
e.exports = n;
n.prototype._reset = function () {
  this._locked = !1;
  this._myHouse = null;
  this._onSale = !1;
  this._tooltipParams = null;
};
n.prototype._registerListeners = function () {
  var e = this,
    t = window.gui,
    i = t.playerData,
    n = i.position;
  t.on("disconnect", function () {
    e._reset();
  });
  n.on("myHouseNotification", function (t) {
    t = t || {};
    var i = t.isInMyHouse,
      n = t.msg || {};
    return i ? (e._myHouse = n.currentHouse, e._onSale = Boolean(n.currentHouse.price), e._locked = n.currentHouse.isLocked, e._updateIcon(), void e.show()) : (e.hide(), void e._reset());
  });
  t.on("HousePropertiesMessage", function (t) {
    var i = t.properties;
    e._tooltipParams && e._myHouse && e._myHouse.houseId === i.houseId && (e._onSale = i.isOnSale, e._updateIcon());
  });
  t.on("LockableStateUpdateHouseDoorMessage", function (t) {
    e._tooltipParams && e._myHouse && e._myHouse.houseId === t.houseId && (e._locked = t.locked, e._updateIcon());
  });
  t.on("HouseSoldMessage", function (t) {
    var n = t.buyerName;
    e._tooltipParams && e._myHouse && n === i.identification.uniqueNickname.toString() && (e._myHouse.price = t.realPrice);
  });
};
n.prototype._updateIcon = function () {
  var e = this._locked ? "locked" : "";
  e = this._onSale ? "onSale" : e;
  this._icon.replaceClassNames(["onSale", "locked"], e ? [e] : []);
};
n.prototype._updateToolTip = function () {
  var e = this;
  this._tooltipParams = {
    title: l("ui.house.homeOf", this._myHouse.displayedName),
    actions: []
  };
  var t = l(this._onSale ? "ui.common.changeHousePrice" : "ui.common.sell");
  this._tooltipParams.actions.push({
    caption: t,
    cb: function () {
      var t = e._myHouse,
        i = c.getWindow("houseBuySell");
      i.prepareDialog(t.modelId, t.ownerName, t.displayedName);
      c.open("houseBuySell", {
        fromInside: !0,
        myHouse: e._myHouse
      });
    }
  });
  var i = l(this._locked ? "ui.common.unlock" : "ui.common.lock");
  this._tooltipParams.actions.push({
    caption: i,
    cb: a
  });
  var n = window.gui.playerData.guild;
  n.hasGuild() && this._tooltipParams.actions.push({
    caption: l("ui.common.guildHouseConfiguration"),
    cb: o
  });
};
this._locked = !1;
this._myHouse = null;
this._onSale = !1;
this._tooltipParams = null;
t.on("disconnect", function () {
  e._reset();
});
n.on("myHouseNotification", function (t) {
  t = t || {};
  var i = t.isInMyHouse,
    n = t.msg || {};
  return i ? (e._myHouse = n.currentHouse, e._onSale = Boolean(n.currentHouse.price), e._locked = n.currentHouse.isLocked, e._updateIcon(), void e.show()) : (e.hide(), void e._reset());
});
t.on("HousePropertiesMessage", function (t) {
  var i = t.properties;
  e._tooltipParams && e._myHouse && e._myHouse.houseId === i.houseId && (e._onSale = i.isOnSale, e._updateIcon());
});
t.on("LockableStateUpdateHouseDoorMessage", function (t) {
  e._tooltipParams && e._myHouse && e._myHouse.houseId === t.houseId && (e._locked = t.locked, e._updateIcon());
});
t.on("HouseSoldMessage", function (t) {
  var n = t.buyerName;
  e._tooltipParams && e._myHouse && n === i.identification.uniqueNickname.toString() && (e._myHouse.price = t.realPrice);
});
e = this._onSale ? "onSale" : e;
this._icon.replaceClassNames(["onSale", "locked"], e ? [e] : []);
i.prepareDialog(t.modelId, t.ownerName, t.displayedName);
c.open("houseBuySell", {
  fromInside: !0,
  myHouse: e._myHouse
});
v.call(this, "div", {
  className: "KohBox",
  hidden: !0
});
m(this);
this.on("tap", function () {
  window.gui.windowsContainer.appendChild(this);
});
this.once("show", function () {
  this._createDom();
});
window.gui.on("KohUpdateMessage", function (t) {
  e.show();
  e._setCurrentState(t);
});
this.isInProbation = !1;
window.gui.on("UpdateSelfAgressableStatusMessage", function (t) {
  switch (t.status) {
    case r.AvA_ENABLED_AGGRESSABLE:
      e.isInProbation = !1;
      break;
    case r.AvA_PREQUALIFIED_AGGRESSABLE:
      e.isInProbation = !0;
  }
});
e.show();
e._setCurrentState(t);
r.setValue(e.allianceEmblem, !0);
l(r, e.allianceName + " [" + e.allianceTag + "]");
p(n, v);
n.prototype._createDom = function () {
  function e() {
    b.replaceClassNames(["full"], ["open"]);
    w = "open";
  }
  var t = window.gui.serversData;
  a = t.sessionConstants[f.SERVER_CONST_KOH_WINNING_SCORE];
  s = Math.floor(t.sessionConstants[f.SERVER_CONST_KOH_DURATION]);
  this.setStyle("left", d.mapLeft + Math.floor(d.mapWidth / 2) + "px");
  var i = this.createChild("div", {
    className: "displaySwitch"
  });
  i.createChild("div", {
    className: "arrow"
  });
  var n = this.createChild("div", {
      className: "mainBox"
    }),
    o = n.createChild("div", {
      className: "topBox"
    }),
    r = n.createChild("div", {
      className: "secondaryBox"
    });
  this.gauge = o.appendChild(new y(["green", "blue", "red"], 380));
  var c = Math.floor(s / 1e3 / 60),
    u = Math.floor(c / 60) + ":" + c % 60,
    p = o.createChild("div", {
      className: "kohInfo"
    });
  l(p, h("ui.koh.tooltip.rules", a, u), {
    openOnTap: !0
  });
  var g = r.createChild("div", {
    className: "allianceBox"
  });
  this.table = g.appendChild(new _({
    colIds: ["side", "emblem", "tag", "characters", "maps", "time"],
    headerContent: ["", "", h("ui.common.alliance"), h("ui.short.characters"), h("ui.common.maps"), h("ui.common.time")]
  }));
  l(this.table.getHeaderCol("characters"), h("ui.koh.tooltip.members"));
  l(this.table.getHeaderCol("maps"), h("ui.koh.tooltip.maps"));
  l(this.table.getHeaderCol("time"), h("ui.koh.tooltip.time"));
  this.winnerInfo = g.createChild("div", {
    className: "info"
  });
  var v = r.createChild("div", {
    className: "statsBox"
  });
  this.winnerStats = v.createChild("div", {
    className: "winnerStats"
  });
  l(this.winnerStats, h("ui.koh.tooltip.mapConquest"));
  this.myStats = v.createChild("div", {
    className: "myStats"
  });
  l(this.myStats, h("ui.koh.tooltip.mapConquestForMyAlliance"));
  var w;
  m(i);
  var b = this;
  i.on("tap", function () {
    switch (w) {
      case "open":
        b.replaceClassNames(["open"], ["full"]);
        w = "full";
        break;
      case "full":
        b.delClassNames("open", "full");
        w = "close";
        break;
      case "close":
        e();
    }
  });
  this.on("hide", e);
  e();
};
n.prototype._setCurrentState = function (e) {
  var t = this;
  this.table.clearContent();
  for (var i = window.gui.playerData, n = i.alliance.current, s = i.position, r = g.entities.prism[s.subAreaId], l = r && r.prism && r.prism.alliance || n, d = 0, u = 0, p = {
      mine: {
        weight: 0,
        type: h("ui.alliance.myAlliance"),
        tooltip: ""
      },
      defense: {
        weight: 0,
        type: h("ui.alliance.allianceInDefense"),
        tooltip: ""
      },
      attack: {
        weight: 0,
        type: h("ui.alliance.allianceInAttack"),
        tooltip: ""
      }
    }, f = 0, _ = e.alliances.length; f < _; f += 1) {
    var y = e.alliances[f],
      w = e.allianceNbMembers[f],
      b = e.allianceMatchScore[f],
      M = e.allianceRoundWeigth[f];
    d += M;
    var T;
    T = y.allianceId === n.allianceId ? "mine" : y.allianceId === l.allianceId ? "defense" : "attack";
    var C = b + "/" + a,
      I = p[T];
    I.weight += M;
    I.tooltip += y.allianceName + " [" + y.allianceTag + "] (" + M + ") : " + C + "\n";
    this.table.addRow(o(y, T, I.type, C, M, w), {
      weight: M
    });
    e.allianceMatchScore[u] < b && (u = f);
  }
  this.table.sort(function (e, t) {
    return t.weight - e.weight;
  });
  d = d || 1;
  p.mine.weight /= d;
  p.mine.tooltip += p.mine.type;
  p.defense.weight /= d;
  p.defense.tooltip += p.defense.type;
  p.attack.weight /= d;
  p.attack.tooltip += p.attack.type;
  this.gauge.setValues([p.mine, p.defense, p.attack]);
  var A = e.alliances[u],
    S = e.allianceMatchScore[u];
  if (A && S >= a) {
    return this.winnerInfo.setText(h("ui.koh.win", A.allianceName)), this.winnerInfo.show(), void setTimeout(function () {
      t.winnerInfo.setText("");
      t.hide();
    }, 6e4);
  }
  var E = e.allianceMapWinner,
    N = e.allianceMapWinnerScore;
  this.winnerStats.clearContent();
  var x = s.coordinates;
  if (this.winnerStats.createChild("span", {
    text: h("ui.option.worldOption") + " [" + x.posX + ", " + x.posY + "]" + h("ui.common.colon")
  }), 0 === N || this.isInProbation) {
    this.winnerStats.createChild("span", {
      text: h("ui.common.neutral")
    });
  } else if ("" === E.allianceTag) {
    this.winnerStats.createChild("span", {
      text: h("ui.koh.draw", N)
    });
  } else {
    var L = this.winnerStats.createChild("span", {
      text: E.allianceTag,
      className: "link"
    });
    m(L);
    L.on("tap", function () {
      c.openAllianceCard(E.allianceId);
    });
    this.winnerStats.appendChild(new v("span", {
      text: " " + N + " " + h("ui.short.points")
    }));
  }
  if (E.allianceId !== n.allianceId && N > 0 && !this.isInProbation) {
    this.myStats.clearContent();
    this.myStats.createChild("span", {
      text: "("
    });
    var O = this.myStats.createChild("span", {
      text: n.allianceTag,
      className: "link"
    });
    m(O);
    O.on("tap", function () {
      c.openAllianceCard(n.allianceId);
    });
    this.myStats.appendChild(new v("span", {
      text: " " + e.allianceMapMyAllianceScore + " " + h("ui.short.points") + ")"
    }));
    this.myStats.show();
  } else {
    this.myStats.hide();
  }
};
e.exports = n;
b.replaceClassNames(["full"], ["open"]);
w = "open";
a = t.sessionConstants[f.SERVER_CONST_KOH_WINNING_SCORE];
s = Math.floor(t.sessionConstants[f.SERVER_CONST_KOH_DURATION]);
this.setStyle("left", d.mapLeft + Math.floor(d.mapWidth / 2) + "px");
this.table = g.appendChild(new _({
  colIds: ["side", "emblem", "tag", "characters", "maps", "time"],
  headerContent: ["", "", h("ui.common.alliance"), h("ui.short.characters"), h("ui.common.maps"), h("ui.common.time")]
}));
l(this.table.getHeaderCol("characters"), h("ui.koh.tooltip.members"));
l(this.table.getHeaderCol("maps"), h("ui.koh.tooltip.maps"));
l(this.table.getHeaderCol("time"), h("ui.koh.tooltip.time"));
this.winnerInfo = g.createChild("div", {
  className: "info"
});
this.winnerStats = v.createChild("div", {
  className: "winnerStats"
});
l(this.winnerStats, h("ui.koh.tooltip.mapConquest"));
this.myStats = v.createChild("div", {
  className: "myStats"
});
l(this.myStats, h("ui.koh.tooltip.mapConquestForMyAlliance"));
i.on("tap", function () {
  switch (w) {
    case "open":
      b.replaceClassNames(["open"], ["full"]);
      w = "full";
      break;
    case "full":
      b.delClassNames("open", "full");
      w = "close";
      break;
    case "close":
      e();
  }
});
this.on("hide", e);
e();
b.replaceClassNames(["open"], ["full"]);
w = "full";
b.delClassNames("open", "full");
w = "close";
I.weight += M;
I.tooltip += y.allianceName + " [" + y.allianceTag + "] (" + M + ") : " + C + "\n";
this.table.addRow(o(y, T, I.type, C, M, w), {
  weight: M
});
e.allianceMatchScore[u] < b && (u = f);
this.table.sort(function (e, t) {
  return t.weight - e.weight;
});
d = d || 1;
p.mine.weight /= d;
p.mine.tooltip += p.mine.type;
p.defense.weight /= d;
p.defense.tooltip += p.defense.type;
p.attack.weight /= d;
p.attack.tooltip += p.attack.type;
this.gauge.setValues([p.mine, p.defense, p.attack]);
t.winnerInfo.setText("");
t.hide();
m(L);
L.on("tap", function () {
  c.openAllianceCard(E.allianceId);
});
this.winnerStats.appendChild(new v("span", {
  text: " " + N + " " + h("ui.short.points")
}));
this.myStats.clearContent();
this.myStats.createChild("span", {
  text: "("
});
m(O);
O.on("tap", function () {
  c.openAllianceCard(n.allianceId);
});
this.myStats.appendChild(new v("span", {
  text: " " + e.allianceMapMyAllianceScore + " " + h("ui.short.points") + ")"
}));
this.myStats.show();
s.call(this);
this.serversRawData = [];
this.serversWithMyCharacter = [];
this.optionalFeatures = {};
this.connectedServerId = null;
this.connectedServerData = null;
this.sessionConstants = {};
this.settings = {};
e.exports = o;
r(o, s);
o.serverConstants = {
  SERVER_CONST_TIME_BEFORE_DISCONNECTION: 1,
  SERVER_CONST_KOH_DURATION: 2,
  SERVER_CONST_KOH_WINNING_SCORE: 3,
  SERVER_CONST_MINIMAL_TIME_BEFORE_KOH: 4,
  SERVER_CONST_TIME_BEFORE_WEIGH_IN_KOH: 5
};
o.prototype._continueSelectServer = function (e) {
  var t = _();
  this.connectedServerId = e;
  this.connectedServerData = this._findServerById(e);
  t.dofus.accessGameServer(e, function (t) {
    if (t) {
      return console.error("accessGameServer serverId: " + e, t);
    }
  });
  this.failTimeout && (console.warn("Clearing previous connection timeout from ServersData.selectServer"), t.clearTimeout(this.failTimeout));
  var i = this;
  this.failTimeout = t.setTimeout(function () {
    i._onSelectedServerRefused({
      serverId: e,
      serverStatus: h.STATUS_UNKNOWN,
      error: p.SERVER_CONNECTION_ERROR_NO_REASON
    });
  }, v);
  t.gui.once("AuthenticationTicketAcceptedMessage", function () {
    t.clearTimeout(i.failTimeout);
    i.failTimeout = null;
  });
};
o.prototype.selectServer = function (e) {
  if (!e) {
    return console.error(new Error("serverId is null")), void this._onSelectedServerRefused({});
  }
  var t = this,
    i = _(),
    n = i.Config.preferredServerId;
  n && n !== e ? i.gui.openConfirmPopup({
    title: d("ui.server.confirmPreferredServerTitle"),
    message: d("ui.server.confirmPreferredServerMessage"),
    cb: function (i) {
      i ? t._continueSelectServer(e) : u.goBackToSelectionOf("server");
    }
  }) : t._continueSelectServer(e);
};
o.prototype.showServerSelectionUi = function () {
  this.serversWithMyCharacter.length > 0 ? c.open("serverSelection", this.serversWithMyCharacter) : c.open("serverSimpleSelection", this.serversRawData);
};
o.prototype._filterMyServersList = function () {
  this.serversWithMyCharacter = this.serversRawData.filter(function (e) {
    return e && e.charactersCount > 0;
  });
  this.serversWithMyCharacter.sort(function (e, t) {
    return t.date - e.date;
  });
};
o.prototype.initialize = function (e) {
  var t = this;
  e.on("disconnect", function (e) {
    t.serversRawData = [];
    t.serversWithMyCharacter = [];
    t.optionalFeatures = {};
    t.connectedServerId = "disconnect" + e;
    t.connectedServerData = null;
    t.sessionConstants = {};
    t.settings = {};
  });
  e.on("ServerStatusUpdateMessage", function (e) {
    if (!e.server) {
      return console.warn("WARN: ServerStatusUpdateMessage message have no server information");
    }
    for (var i = e.server, n = !0, o = 0, a = t.serversRawData.length; o < a; o += 1) {
      if (i.id === t.serversRawData[o].id) {
        t.serversRawData[o] = i;
        n = !1;
        break;
      }
    }
    n && t.serversRawData.push(i);
    t._filterMyServersList();
    t.emit("serversUpdate", i);
  });
  e.on("SelectedServerRefusedMessage", function (e) {
    t._onSelectedServerRefused(e);
  });
  e.on("ServerOptionalFeaturesMessage", function (e) {
    t.optionalFeatures = {};
    for (var i = window.gui.databases.OptionalFeatures, n = 0, o = e.features.length; n < o; n += 1) {
      var a = e.features[n];
      t.optionalFeatures[i[a].keyword] = a;
    }
  });
  e.on("ServerSessionConstantsMessage", function (e) {
    t.sessionConstants = {};
    for (var i = e.variables, n = 0, o = e.variables.length; n < o; n += 1) {
      t.sessionConstants[i[n].id] = i[n].value;
    }
  });
  e.on("ServerSettingsMessage", function (e) {
    t.settings.serverCommunityId = e.community;
    t.settings.serverLang = e.lang;
    t.settings.serverGameType = e.gameType;
  });
  a.on("CharacterSelectedSuccessMessage", function () {
    t.staticContent = null;
  });
  a.on("AuthenticationTicketRefusedMessage", function () {
    t.failTimeout && window.clearTimeout(t.failTimeout);
  });
};
o.prototype.onServerList = function (e) {
  this.serversRawData = e.servers;
  this._filterMyServersList();
  var t = u.connectMethod,
    i = "lastServer" === t || "lastCharacter" === t || "characterId" === t;
  if (i) {
    var n = this.serversWithMyCharacter[0] || {},
      o = n.id;
    if (o && n.status === h.ONLINE && n.isSelectable) {
      return this.selectServer(o);
    }
  }
  this.showServerSelectionUi();
};
o.prototype.isFeatureActive = function (e) {
  return this.optionalFeatures.hasOwnProperty(e);
};
o.prototype.syncServerStaticData = function (e) {
  var t = this;
  if (this.staticContent) {
    return e();
  }
  var i = ["Servers", "ServerGameTypes", "ServerPopulations", "ServerCommunities"];
  l.getAllDataMap(i, function (i, n) {
    return i ? e(i) : (t.staticContent = {}, t.staticContent.data = n.Servers, t.staticContent.gameTypes = n.ServerGameTypes, t.staticContent.populations = n.ServerPopulations, t.staticContent.communities = n.ServerCommunities, e());
  });
};
o.prototype.getAutoChosenServers = function (e) {
  var t = this;
  this.syncServerStaticData(function (i) {
    return i ? e(i) : void f(t.serversRawData, t.staticContent, _().gui.playerData.identification.communityId, e);
  });
};
o.prototype.pickUpOneServerForMe = function () {
  this.getAutoChosenServers(function (e, t) {
    if (e) {
      return window.gui.openSimplePopup(d("tablet.server.noServersForYourCommunity")), void (y || (console.error("pickUpOneServerForMe:", e), y = !0));
    }
    var i = t[Math.floor(Math.random() * t.length)];
    i && c.open("serverDetails", i);
  });
};
o.prototype._findServerById = function (e) {
  for (var t = 0; t < this.serversRawData.length; t++) {
    if (e === this.serversRawData[t].id) {
      return this.serversRawData[t];
    }
  }
  return null;
};
o.prototype.getServerNameById = function (e) {
  for (var t = 0; t < this.serversRawData.length; t++) {
    if (e === this.serversRawData[t].id) {
      return this.serversRawData[t]._name;
    }
  }
  return e.toString();
};
o.prototype.getAllowedServerList = function () {
  for (var e = [], t = 0; t < this.serversRawData.length; t++) {
    var i = this.serversRawData[t];
    i.status !== h.ONLINE && i.status !== h.SAVING && i.status !== h.FULL || i.id === g.TOURNAMENT_PROD_SERVERID || e.push(i);
  }
  return e;
};
o.prototype.getSelectableServerList = function () {
  for (var e = [], t = 0; t < this.serversRawData.length; t++) {
    var i = this.serversRawData[t];
    i.status === h.ONLINE && i.isSelectable && e.push(i);
  }
  return e;
};
o.prototype.getSelectableServerNames = function () {
  var e = this.getSelectableServerList();
  if (0 === e.length) {
    return d("ui.common.none").toLowerCase();
  }
  for (var t = e[0]._name, i = 1; i < e.length; i++) {
    t += ", " + e[i]._name;
  }
  return t;
};
o.prototype._onSelectedServerRefused = function (e) {
  this.failTimeout && window.clearTimeout(this.failTimeout);
  var t = this._findServerById(e.serverId);
  t && (t.status = e.serverStatus);
  var i;
  switch (e.error) {
    case p.SERVER_CONNECTION_ERROR_DUE_TO_STATUS:
      switch (i = "Status", e.serverStatus) {
        case h.OFFLINE:
          i += "Offline";
          break;
        case h.STARTING:
          i += "Starting";
          break;
        case h.NOJOIN:
          i += "Nojoin";
          break;
        case h.SAVING:
          i += "Saving";
          break;
        case h.STOPING:
          i += "Stoping";
          break;
        case h.FULL:
          i += "Full";
          break;
        default:
          i += "Unknown";
      }
      break;
    case p.SERVER_CONNECTION_ERROR_ACCOUNT_RESTRICTED:
      i = "AccountRestricted";
      break;
    case p.SERVER_CONNECTION_ERROR_COMMUNITY_RESTRICTED:
      i = "CommunityRestricted";
      break;
    case p.SERVER_CONNECTION_ERROR_LOCATION_RESTRICTED:
      i = "LocationRestricted";
      break;
    case p.SERVER_CONNECTION_ERROR_SERVER_FULL:
      i = "ServerFull";
      break;
    case p.SERVER_CONNECTION_ERROR_REGULAR_PLAYERS_ONLY:
      i = "RegularPlayersOnly";
      break;
    default:
      i = "NoReason";
  }
  var n;
  switch (i) {
    case "AccountRestricted":
      n = d("ui.server.cantChoose.serverForbidden");
      break;
    case "CommunityRestricted":
      n = d("ui.server.cantChoose.communityRestricted");
      break;
    case "LocationRestricted":
      n = d("ui.server.cantChoose.locationRestricted");
      break;
    case "ServerFull":
      n = d("ui.server.cantChoose.serverFull");
      break;
    case "RegularPlayersOnly":
      n = d("ui.server.cantChoose.regularPlayerRestricted");
      break;
    case "StatusOffline":
      n = d("ui.server.cantChoose.serverDown");
      break;
    case "StatusStarting":
      n = d("ui.server.cantChoose.serverDown");
      break;
    case "StatusNojoin":
      n = d("ui.server.cantChoose.serverForbidden");
      break;
    case "StatusSaving":
      n = d("ui.server.cantChoose.serverSaving");
      break;
    case "StatusStoping":
      n = d("ui.server.cantChoose.serverDown");
      break;
    case "StatusFull":
      n = d("ui.server.cantChoose.serverFull") + "\n\n" + d("ui.server.serversAccessibles", this.getSelectableServerNames());
      break;
    case "NoReason":
    case "StatusUnknown":
      n = d("ui.popup.connectionFailed.text");
  }
  this.showServerSelectionUi();
  window.gui.openSimplePopup(n);
};
o.getServerImage = function (e, t) {
  var i = ["gfx/illus/illu_0.png"];
  n(e) && i.push("gfx/illus/illu_" + e + ".png");
  m.preloadImages(i, function (e) {
    var i = e[0],
      n = e[1];
    return n && "none" !== n ? t(null, n) : t(null, i);
  });
};
o.prototype.getMyServerName = function () {
  return this.connectedServerData && this.connectedServerData._name;
};
o.prototype.isTournamentServer = function () {
  var e = window.parseInt(this.connectedServerId, 10);
  return e === g.TOURNAMENT_TEST_SERVERID || e === g.TOURNAMENT_PROD_SERVERID;
};
this.connectedServerId = e;
this.connectedServerData = this._findServerById(e);
t.dofus.accessGameServer(e, function (t) {
  if (t) {
    return console.error("accessGameServer serverId: " + e, t);
  }
});
this.failTimeout && (console.warn("Clearing previous connection timeout from ServersData.selectServer"), t.clearTimeout(this.failTimeout));
this.failTimeout = t.setTimeout(function () {
  i._onSelectedServerRefused({
    serverId: e,
    serverStatus: h.STATUS_UNKNOWN,
    error: p.SERVER_CONNECTION_ERROR_NO_REASON
  });
}, v);
t.gui.once("AuthenticationTicketAcceptedMessage", function () {
  t.clearTimeout(i.failTimeout);
  i.failTimeout = null;
});
t.clearTimeout(i.failTimeout);
i.failTimeout = null;
this.serversWithMyCharacter = this.serversRawData.filter(function (e) {
  return e && e.charactersCount > 0;
});
this.serversWithMyCharacter.sort(function (e, t) {
  return t.date - e.date;
});
e.on("disconnect", function (e) {
  t.serversRawData = [];
  t.serversWithMyCharacter = [];
  t.optionalFeatures = {};
  t.connectedServerId = "disconnect" + e;
  t.connectedServerData = null;
  t.sessionConstants = {};
  t.settings = {};
});
e.on("ServerStatusUpdateMessage", function (e) {
  if (!e.server) {
    return console.warn("WARN: ServerStatusUpdateMessage message have no server information");
  }
  for (var i = e.server, n = !0, o = 0, a = t.serversRawData.length; o < a; o += 1) {
    if (i.id === t.serversRawData[o].id) {
      t.serversRawData[o] = i;
      n = !1;
      break;
    }
  }
  n && t.serversRawData.push(i);
  t._filterMyServersList();
  t.emit("serversUpdate", i);
});
e.on("SelectedServerRefusedMessage", function (e) {
  t._onSelectedServerRefused(e);
});
e.on("ServerOptionalFeaturesMessage", function (e) {
  t.optionalFeatures = {};
  for (var i = window.gui.databases.OptionalFeatures, n = 0, o = e.features.length; n < o; n += 1) {
    var a = e.features[n];
    t.optionalFeatures[i[a].keyword] = a;
  }
});
e.on("ServerSessionConstantsMessage", function (e) {
  t.sessionConstants = {};
  for (var i = e.variables, n = 0, o = e.variables.length; n < o; n += 1) {
    t.sessionConstants[i[n].id] = i[n].value;
  }
});
e.on("ServerSettingsMessage", function (e) {
  t.settings.serverCommunityId = e.community;
  t.settings.serverLang = e.lang;
  t.settings.serverGameType = e.gameType;
});
a.on("CharacterSelectedSuccessMessage", function () {
  t.staticContent = null;
});
a.on("AuthenticationTicketRefusedMessage", function () {
  t.failTimeout && window.clearTimeout(t.failTimeout);
});
t.serversRawData = [];
t.serversWithMyCharacter = [];
t.optionalFeatures = {};
t.connectedServerId = "disconnect" + e;
t.connectedServerData = null;
t.sessionConstants = {};
t.settings = {};
t.serversRawData[o] = i;
n = !1;
n && t.serversRawData.push(i);
t._filterMyServersList();
t.emit("serversUpdate", i);
t.settings.serverCommunityId = e.community;
t.settings.serverLang = e.lang;
t.settings.serverGameType = e.gameType;
this.serversRawData = e.servers;
this._filterMyServersList();
this.showServerSelectionUi();
window.gui.openSimplePopup(n);
n(e) && i.push("gfx/illus/illu_" + e + ".png");
m.preloadImages(i, function (e) {
  var i = e[0],
    n = e[1];
  return n && "none" !== n ? t(null, n) : t(null, i);
});
a = t[c];
s = a.staticData.server;
o(r, s) && l.push(a);
a.status === r.ONLINE && t === -1 && (t = a.completion);
s.nameId = s.nameId || "n/a";
t !== -1 && s.populationId === t && a.status === r.ONLINE && s.nameId.indexOf("Test") === -1 && i.push(a);
g.completion = s.COMPLETION_AVERAGE;
v.populationId = s.COMPLETION_AVERAGE;
g.completion = s.COMPLETION_AVERAGE;
v.populationId = s.COMPLETION_AVERAGE;
g.completion = s.COMPLETION_FULL;
v.populationId = s.COMPLETION_FULL;
w && (b || M) && l(g);
2 !== y && 1 !== y || d(g);
r(n, o);
e.exports = n;
n.prototype.addRow = function (e, t) {
  var i;
  return this._rowCount < this._rows.length ? (this._rows[this._rowCount]._isEmpty = !1, i = this.updateRow(this._rowCount, e, t)) : i = this._addRow(e, null, t), this._rowCount++, this._updateDisplay(), i;
};
n.prototype.insertRow = function (e, t, i) {
  if (e < 0 || e > this._rows.length) {
    return console.warn("[Table.insertRow] the specified index (" + e + ") is out of range."), null;
  }
  var n = this._rows[e];
  if (n && n._isEmpty) {
    n._isEmpty = !1;
    n = this.updateRow(e, t, i);
  } else {
    n = this._createRow(t, "content");
    for (var o in i) {
      n[o] = i[o];
    }
    e === this._rows.length ? this.content.appendChild(n) : n.insertBefore(this._rows[e]);
    this._rows.splice(e, 0, n);
  }
  return this._rowCount++, this._updateDisplay(), n;
};
n.prototype.sort = function (e) {
  var t = this._rows;
  t.sort(e);
  for (var i = 0, n = t.length; i < n; i += 1) {
    this.content.appendChild(t[i]);
  }
  this._updateDisplay();
};
n.prototype.delRow = function (e) {
  if (e > this._rowCount) {
    return console.error("[Table.delRow] Row index " + e + " does not exist.");
  }
  if (!this._isRowEmpty(e)) {
    var t = this._rows[e];
    this._lastSelected === t && (this._lastSelected = null);
    t.destroy();
    this._rowCount--;
    this._rows.splice(e, 1);
    this._rows.length < this._minRows && this._addRow();
    this._highlightable && !this._disableAutoSelect && this.highlight(0);
    this._updateDisplay();
  }
};
n.prototype.updateRowContent = function (e, t, i) {
  if (!e._isEmpty) {
    for (var n in i) {
      e[n] = i[n];
    }
    if (this._highlightable && e.enable(), Array.isArray(t)) {
      for (var a = {}, s = this._colIds, r = 0; r < s.length; r++) {
        a[s[r]] = t[r];
      }
      t = a;
    }
    for (var l in t) {
      var c = e.getChild(l),
        d = t[l];
      c.clearContent();
      d instanceof o ? c.appendChild(d) : (void 0 !== d && null !== d || (d = ""), c.setHtml(d.toString()));
    }
    return !this._highlightable || this._lastSelected || this._disableAutoSelect || this.highlight(0), e;
  }
};
n.prototype.updateRow = function (e, t, i) {
  if (!this._isRowEmpty(e)) {
    var n = this._rows[e];
    return this.updateRowContent(n, t, i);
  }
};
n.prototype.getRows = function () {
  return this._rows;
};
n.prototype.clearContent = function () {
  for (var e = 0; e < this._rows.length; e++) {
    this._rows[e].destroy();
  }
  this._rows = [];
  this._rowCount = 0;
  this._lastSelected = null;
  this._hiddenRowIds = [];
  this._setupDefaultRows();
};
n.prototype.removeHightlight = function () {
  this._lastSelected && (this._lastSelected.delClassNames("highlight"), this._lastSelected = null);
};
n.prototype.highlightFirstRow = function () {
  for (var e = 0; e < this._rows.length; e++) {
    var t = this._rows[e];
    if (t.isVisible()) {
      return void this.highlightRow(t);
    }
  }
};
n.prototype.highlightRow = function (e) {
  if (this._highlightable) {
    if (!e || e._isEmpty) {
      return void console.warn("Invalid index, row does not exist or empty!");
    }
    e !== this._lastSelected && (this._lastSelected && this._lastSelected.delClassNames("highlight"), this._lastSelected = e, this._lastSelected.addClassNames("highlight"));
    this.emit("selected", e);
  }
};
n.prototype.highlight = function (e) {
  this.highlightRow(this._rows[e]);
};
n.prototype.getRowCount = function () {
  return this._rowCount;
};
n.prototype.getRow = function (e) {
  return this._rows[e] && this._isRowEmpty(e) ? void console.warn("[Table.getRow] Row index " + e + " is empty.") : this._rows[e];
};
n.prototype.getCol = function (e, t) {
  var i = this.getRow(e);
  if (i) {
    return i.getChild(t);
  }
};
n.prototype.getHeaderCol = function (e) {
  return this.header.getChildren()[0].getChild(e);
};
n.prototype.hideRows = function (e) {
  if (e.length) {
    for (var t = 0, i = 0; i < e.length; i++) {
      var n = e[i],
        o = this.getRow(n);
      o && (o.hide(), this._hiddenRowIds.push(n), t++);
    }
    var a = this.getRowCount() - t;
    return this._disableAutoSelect || this.highlightFirstRow(), a < this._minRows ? (a = this._minRows - a, void this._addEmptyRows(a)) : void this._updateDisplay();
  }
};
n.prototype.showRows = function () {
  var e = this._hiddenRowIds;
  if (e.length) {
    for (var t = 0; t < e.length; t++) {
      var i = this.getRow(e[t]);
      i && i.show();
    }
    return this._disableAutoSelect || this.highlightFirstRow(), this._hiddenRowIds = [], this._rows.length > this._minRows ? void this._delEmptyRows(this._rows.length - this._minRows) : void this._updateDisplay();
  }
};
n.prototype._updateDisplay = function () {
  for (var e = !1, t = 0; t < this._rows.length; t++) {
    if (this._rows[t].isVisible()) {
      e = !0;
      break;
    }
  }
  this.noneLabel.toggleDisplay(!e);
  this._updateRowColor();
};
n.prototype._updateRowColor = function () {
  if (this._autoUpdateRowColor) {
    for (var e = !0, t = 0; t < this._rows.length; t++) {
      var i = this._rows[t];
      i.isVisible() && (e ? (i.addClassNames("odd"), e = !1) : (i.delClassNames("odd", "even"), e = !0));
    }
  }
};
n.prototype._isRowEmpty = function (e) {
  return this._rows[e]._isEmpty;
};
n.prototype._createRow = function (e, t) {
  var i = this._colIds || [],
    n = new o("div", {
      className: "row"
    });
  e || (n._isEmpty = !0, e = this._defaultRowContent);
  for (var a, r = Array.isArray(e), l = 0; l < this._colCount; l++) {
    var c = i[l],
      d = n.createChild("div", {
        className: "col",
        name: c || ""
      });
    r ? a = e[l] : (a = e[c], n[c] = a);
    (a || 0 === a) && (a instanceof o ? d.appendChild(a) : d.setHtml(a.toString()));
  }
  if ("content" !== t) {
    return n;
  }
  if (this.noneLabel.hide(), this._highlightable || this._clickable) {
    s(n);
    n.on("disabled", function () {
      n.addClassNames("disabled");
    });
    n.on("enabled", function () {
      n.delClassNames("disabled");
    });
    n._isEmpty && n.disable();
    var u = this;
    n.on("tap", function () {
      u.highlightRow(this);
    });
  }
  return n;
};
n.prototype._addRow = function (e, t, i) {
  t = t || "content";
  var n = this._createRow(e, t);
  this[t].appendChild(n);
  for (var o in i) {
    n[o] = i[o];
  }
  return "content" !== t ? n : (this._rows.push(n), e ? (!this._highlightable || this._lastSelected || this._disableAutoSelect || this.highlight(0), n) : void 0);
};
n.prototype._addEmptyRows = function (e) {
  for (var t = 0; t < e; t++) {
    this._addRow();
  }
  this._updateDisplay();
};
n.prototype._addHeader = function (e) {
  this._addRow(e, "header");
};
n.prototype._addFooter = function (e) {
  this._addRow(e, "footer");
};
n.prototype._setupDefaultRows = function () {
  for (; this._rows.length < this._minRows;) {
    this._addRow();
  }
  this._updateDisplay();
};
n.prototype._delEmptyRows = function (e) {
  for (var t = this._rows.length - 1; t >= 0 && !(0 === e || this._rows.length <= this._minRows); t--) {
    this._isRowEmpty(t) && (this._rows[t].destroy(), this._rows.splice(t, 1), e--);
  }
  this._updateDisplay();
};
n._isEmpty = !1;
n = this.updateRow(e, t, i);
e === this._rows.length ? this.content.appendChild(n) : n.insertBefore(this._rows[e]);
this._rows.splice(e, 0, n);
this._lastSelected === t && (this._lastSelected = null);
t.destroy();
this._rowCount--;
this._rows.splice(e, 1);
this._rows.length < this._minRows && this._addRow();
this._highlightable && !this._disableAutoSelect && this.highlight(0);
this._updateDisplay();
c.clearContent();
d instanceof o ? c.appendChild(d) : (void 0 !== d && null !== d || (d = ""), c.setHtml(d.toString()));
this._rows = [];
this._rowCount = 0;
this._lastSelected = null;
this._hiddenRowIds = [];
this._setupDefaultRows();
e !== this._lastSelected && (this._lastSelected && this._lastSelected.delClassNames("highlight"), this._lastSelected = e, this._lastSelected.addClassNames("highlight"));
this.emit("selected", e);
this.noneLabel.toggleDisplay(!e);
this._updateRowColor();
r ? a = e[l] : (a = e[c], n[c] = a);
(a || 0 === a) && (a instanceof o ? d.appendChild(a) : d.setHtml(a.toString()));
s(n);
n.on("disabled", function () {
  n.addClassNames("disabled");
});
n.on("enabled", function () {
  n.delClassNames("disabled");
});
n._isEmpty && n.disable();
s.call(this, "div", {
  className: "Gauge"
});
this.createChild("div", {
  className: "barBg"
});
r.createChild("div", {
  className: ["bar", e[n]]
});
r.tooltip = i.createChild("div", {
  className: "tooltip"
});
r.tooltipContent = new s("div");
o(r.tooltip, r.tooltipContent, {
  openOnTap: !0
});
this.bars.push(r);
a(n, s);
e.exports = n;
n.prototype.setValues = function (e) {
  for (var t = 0, i = 0, n = this.bars.length; i < n; i += 1) {
    var o = e[i],
      a = this.bars[i],
      s = Math.floor(this.width * o.weight);
    a.setStyles({
      "-webkit-mask-position": t + "px 0",
      "-webkit-mask-size": s + "px 100%"
    });
    a.tooltip.setStyles({
      left: t + "px",
      width: s + "px"
    });
    t += s;
    a.tooltipContent.setText(o.tooltip);
  }
};
a.setStyles({
  "-webkit-mask-position": t + "px 0",
  "-webkit-mask-size": s + "px 100%"
});
a.tooltip.setStyles({
  left: t + "px",
  width: s + "px"
});
t += s;
a.tooltipContent.setText(o.tooltip);
c.call(this, "div", {
  className: "mapCoordinateDisplay",
  hidden: !0
});
this._shouldShowMapInfo = !1;
this._isTransparent = !0;
this._markerCount = 0;
this._setupListeners();
this._createContent();
l(n, c);
e.exports = n;
n.prototype._createContent = function () {
  var e = this.createChild("div", {
    className: "mapInfo"
  });
  this.descriptionElement = e.createChild("div", {
    className: "areaInfo"
  });
  this.coordinatesElement = e.createChild("div", {
    className: "coordsAndLevel"
  });
  this.uniqueDropsElement = e.createChild("div", {
    className: "uniqueDrops"
  });
  this.allianceInfo = this.createChild("div", {
    className: "allianceInfo"
  });
  this.allianceTag = this.allianceInfo.createChild("div", {
    className: "tag"
  });
  this.allianceEmblem = this.allianceInfo.appendChild(new u({
    width: 35,
    height: 35
  }));
  var t = this._smallFlags = this.createChild("div", {
      className: "smallFlagsIcon",
      hidden: !0
    }),
    i = this._markerBox = this.createChild("div", {
      className: "markerBox",
      hidden: !0
    }),
    n = i.createChild("div", {
      className: "minimizeBtn"
    });
  n.createChild("div", {
    className: "icon"
  });
  this._markerList = i.createChild("div", {
    className: "markerList"
  });
  this._markerList.setStyle("maxHeight", w * y + "px");
  h(this);
  window.foreground.handleTapAfter(this);
  this.allianceEmblem.on("longtap", o);
  this.allianceEmblem.allianceInfo = this.allianceInfo;
  this._isMarkerBoxMinimized = !1;
  h(n);
  h(t);
  var a = this._toggleMarkerBox.bind(this);
  n.on("longtap", a);
  t.on("longtap", a);
};
n.prototype._toggleMarkerBox = function () {
  this._isMarkerBoxMinimized = !this._isMarkerBoxMinimized;
  this.toggleClassName("minimizedMarkers", this._isMarkerBoxMinimized);
};
n.prototype._updateMapInfo = function (e) {
  var t = this,
    i = window.gui.playerData.position;
  if (!i.mapPosition) {
    return e(!1);
  }
  var n = m.entities.prism,
    o = i.coordinates.posX + "," + i.coordinates.posY,
    a = i.mapPosition.nameId;
  a || (a = i.area.nameId + " (" + i.subArea.nameId + ")", o += ", " + p("ui.common.averageLevel") + " " + i.subArea.level);
  this.descriptionElement.setText(a);
  this.coordinatesElement.setText(o);
  var s = n[i.subArea.id];
  if (s && s.prism) {
    var r = s.getAlliance();
    this.allianceInfo.allianceId = r.allianceId;
    this.allianceTag.setText("[" + r.allianceTag + "]");
    this.allianceEmblem.setValue(r.allianceEmblem, !0);
    this.allianceInfo.show();
  } else {
    this.allianceInfo.hide();
  }
  return this.uniqueDropsElement.hide(), _.getLWUniqueDropsTextBySubArea(i.subAreaId, function (e, i) {
    return e ? console.error(e) : void ("" !== i && (t.uniqueDropsElement.setText(p("ui.legendaryWeapon.possibleDrop", i)), t.uniqueDropsElement.show()));
  }), e(!0);
};
n.prototype.setMapInfoVisibility = function (e) {
  var t = this;
  if (e !== this._shouldShowMapInfo) {
    return this._shouldShowMapInfo = e, e ? this._updateMapInfo(function (e) {
      e && t._appear();
    }) : void (this._markerCount > 0 ? this.addClassNames("noMapInfo") : this._disappear());
  }
};
n.prototype._appear = function () {
  this.toggleClassName("noMapInfo", !this._shouldShowMapInfo);
  this._isTransparent && (this._isTransparent = !1, this.show(), r.forceReflow(this), f.tween(this, {
    opacity: 1
  }, {
    time: 100,
    easing: "linear"
  }));
};
n.prototype._disappear = function () {
  this._isTransparent || (this._isTransparent = !0, f.tween(this, {
    opacity: 0
  }, {
    time: 100,
    easing: "linear"
  }, this.hide));
};
n.prototype._clear = function () {
  this._isTransparent = !0;
  this.hide();
  this.setStyle("opacity", 0);
  this.addClassNames("noMapInfo");
};
n.prototype._setupListeners = function () {
  var e = this,
    t = window.gui;
  t.on("disconnect", function () {
    e._clear();
  });
  t.playerData.position.on("mapUpdate", function () {
    if (e._shouldShowMapInfo) {
      return e._updateMapInfo(function () {
        e._appear();
      });
    }
  });
  t.on("resize", function () {
    e.setStyles({
      left: s.mapLeft + v + "px",
      top: s.mapTop + v + "px"
    });
  });
  var i = t.fightManager;
  i.on("fightEnterPreparation", this._disappear.bind(this));
  i.on("fightEnterBattle", this._disappear.bind(this));
  i.on("fightEnd", this._appear.bind(this));
};
n.prototype.addMarker = function (e, t) {
  this._markerCount === y && this._createDotDotButton();
  this._markerCount++;
  var i = this._markerList.createChild("div", {
    className: "marker"
  });
  i.createChild("div", {
    className: ["icon", e]
  });
  var n = t ? t.split("\n")[0] : "";
  return i.createChild("div", {
    className: "text",
    text: n
  }), a(i, t), 1 === this._markerCount && (this._markerBox.show(), this._smallFlags.show(), this._appear()), i;
};
n.prototype.removeMarker = function (e) {
  this._markerCount--;
  this._markerList.removeChild(e);
  this._markerCount === y && this._deleteDotDotButton();
  0 === this._markerCount && (this._markerBox.hide(), this._smallFlags.hide(), this._shouldShowMapInfo || this._disappear());
};
n.prototype._createDotDotButton = function () {
  var e = this._markerBox.createChild("div", {
    className: "dotDotBtn",
    text: "..."
  });
  h(e);
  e.on("longtap", function () {
    g["switch"]("worldMap");
  });
  this._dotDotButton = e;
};
n.prototype._deleteDotDotButton = function () {
  this._markerBox.removeChild(this._dotDotButton);
  this._dotDotButton = null;
};
this.descriptionElement = e.createChild("div", {
  className: "areaInfo"
});
this.coordinatesElement = e.createChild("div", {
  className: "coordsAndLevel"
});
this.uniqueDropsElement = e.createChild("div", {
  className: "uniqueDrops"
});
this.allianceInfo = this.createChild("div", {
  className: "allianceInfo"
});
this.allianceTag = this.allianceInfo.createChild("div", {
  className: "tag"
});
this.allianceEmblem = this.allianceInfo.appendChild(new u({
  width: 35,
  height: 35
}));
n.createChild("div", {
  className: "icon"
});
this._markerList = i.createChild("div", {
  className: "markerList"
});
this._markerList.setStyle("maxHeight", w * y + "px");
h(this);
window.foreground.handleTapAfter(this);
this.allianceEmblem.on("longtap", o);
this.allianceEmblem.allianceInfo = this.allianceInfo;
this._isMarkerBoxMinimized = !1;
h(n);
h(t);
n.on("longtap", a);
t.on("longtap", a);
this._isMarkerBoxMinimized = !this._isMarkerBoxMinimized;
this.toggleClassName("minimizedMarkers", this._isMarkerBoxMinimized);
a || (a = i.area.nameId + " (" + i.subArea.nameId + ")", o += ", " + p("ui.common.averageLevel") + " " + i.subArea.level);
this.descriptionElement.setText(a);
this.coordinatesElement.setText(o);
this.allianceInfo.allianceId = r.allianceId;
this.allianceTag.setText("[" + r.allianceTag + "]");
this.allianceEmblem.setValue(r.allianceEmblem, !0);
this.allianceInfo.show();
this.toggleClassName("noMapInfo", !this._shouldShowMapInfo);
this._isTransparent && (this._isTransparent = !1, this.show(), r.forceReflow(this), f.tween(this, {
  opacity: 1
}, {
  time: 100,
  easing: "linear"
}));
this._isTransparent = !0;
this.hide();
this.setStyle("opacity", 0);
this.addClassNames("noMapInfo");
t.on("disconnect", function () {
  e._clear();
});
t.playerData.position.on("mapUpdate", function () {
  if (e._shouldShowMapInfo) {
    return e._updateMapInfo(function () {
      e._appear();
    });
  }
});
t.on("resize", function () {
  e.setStyles({
    left: s.mapLeft + v + "px",
    top: s.mapTop + v + "px"
  });
});
i.on("fightEnterPreparation", this._disappear.bind(this));
i.on("fightEnterBattle", this._disappear.bind(this));
i.on("fightEnd", this._appear.bind(this));
this._markerCount === y && this._createDotDotButton();
this._markerCount++;
this._markerCount--;
this._markerList.removeChild(e);
this._markerCount === y && this._deleteDotDotButton();
0 === this._markerCount && (this._markerBox.hide(), this._smallFlags.hide(), this._shouldShowMapInfo || this._disappear());
h(e);
e.on("longtap", function () {
  g["switch"]("worldMap");
});
this._dotDotButton = e;
this._markerBox.removeChild(this._dotDotButton);
this._dotDotButton = null;
f.call(this, {
  autoClose: !0
});
this.addClassNames("MenuBar");
this._sizeInIcons = -1;
this._iconOrder = [];
this._notificationIconList = {};
this._createDom();
this._listenToServerEvents();
this._listenToInternalEvents();
u(a, f);
e.exports = a;
a.prototype._createDom = function () {
  this._iconsBox = this.content.createChild("div", {
    className: "iconsBoxContainer"
  });
  this._icons = this.content.createChild("div", {
    className: "iconsContainer"
  });
  var e = this;
  this._unlock = !1;
  this._lockBtn = this.content.appendChild(new h({
    className: "lockBtn",
    scaleOnPress: !0
  }, function () {
    e._toggleIconsDrag(!e._unlock);
  }));
  for (var t = 0; t < C.length; t++) {
    this._createIcon(t, C[t]);
  }
};
a.prototype.setIconAvailability = function (e, t) {
  void 0 === t && (console.error(new Error("setIconAvailability: enabled param should not be undefined")), t = !1);
  var i = this._icons.getChild(e);
  i.toggleClassName("disabled", !t);
  i.isDisabled = !t;
};
a.prototype.enableDragButton = function (e) {
  this._lockBtn.setEnable(e);
};
a.prototype._toggleIconsDrag = function (e) {
  for (var t = this._icons.getChildren(), i = 0, n = t.length; i < n; i += 1) {
    c.setDragEnable(t[i], e);
  }
  this._lockBtn.toggleClassName("on", !e);
  this.toggleClassName("draggable", e);
  this._unlock = e;
};
a.prototype._listenToServerEvents = function () {
  function e() {
    return o.playerData.isFighting;
  }
  function t(e) {
    n._removeNotificationIcon(e, "warnRedIconCircle");
  }
  function i(e) {
    n._addNotificationIcon(e, "warnRedIconCircle");
  }
  var n = this,
    o = window.gui;
  o.uiLocker.on("updated", function (e) {
    if (e.menuButtonId) {
      if (!T[e.menuButtonId]) {
        return console.error(new Error("Unknown button id `" + e.menuButtonId + "` in MenuBar."));
      }
      if (n.setIconAvailability(e.menuButtonId, !e.locked), !e.locked) {
        var t = n._getIcon(e.menuButtonId);
        if (t) {
          var i = n._notificationIconList,
            o = e.menuButtonId,
            a = i[o];
          i.hasOwnProperty(o) && t.addClassNames(a);
        }
      }
    }
  });
  o.on("SpouseInformationsMessage", function (e) {
    T.Spouse.param = e.spouse.sex;
  });
  o.fightManager.on("fightStart", function () {
    n._clearNotificationIconsStyle();
  });
  o.fightManager.on("fightEnd", function () {
    n._showNotificationIcons();
  });
  o.playerData.inventory.on("weightUpdated", function (e, n) {
    var o = e / n;
    o < w ? t("Bag") : o >= w && i("Bag");
  });
  o.playerData.quests.on("DQStarted", function () {
    g.isWindowOpen("dailyQuest") || i("DailyQuest");
  });
  o.playerData.characters.on("newSpellLearned", function () {
    n._addNotificationIcon("Spell", "plusIcon", {
      doNotShow: e()
    });
  });
  o.playerData.on("characterLevelUp", function () {
    n._addNotificationIcon("Carac", "plusIcon", {
      doNotShow: e()
    });
  });
  var a = g.getWindow("grimoire");
  a.tabs.on("openTab", function (t) {
    "spells" !== t || e() || n._removeNotificationIcon("Spell", "plusIcon");
  });
  var s = g.getWindow("characteristics");
  s.on("open", function () {
    e() || n._removeNotificationIcon("Carac", "plusIcon");
  });
  var r = g.getWindow("dailyQuest");
  r.on("open", function () {
    t("DailyQuest");
  });
};
a.prototype.enableTutorialRestrictedFeatures = function (e) {
  this._setButtonsOrder(C);
  this.enableDragButton(!1);
  window.gui.uiLocker.lockAllFeaturesExcept(e, "tutorial", d("tablet.tutorial.uiLocker.default"));
  this._clearNotificationIconsStyle(["plusIcon"]);
};
a.prototype.disableTutorialRestrictedFeatures = function () {
  this._setButtonsOrder(this._iconOrder);
  this.enableDragButton(!0);
  window.gui.uiLocker.unlockAllFeatures("tutorial");
  this._showNotificationIcons(["plusIcon"]);
};
a.prototype._listenToInternalEvents = function () {
  var e = this,
    t = window.gui;
  t.on("connected", function () {
    e._loadButtonOrderFromAccountPref();
    e._setButtonsOrder(e._iconOrder);
  });
  t.on("disconnect", function () {
    e._clearNotificationIconsStyle();
    e._resetNotificationIconList();
    e._addedBagWarnRedIcon = !1;
    e._addedBagWarnYellowIcon = !1;
  });
  this.on("close", function () {
    this._toggleIconsDrag(!1);
  });
};
a.prototype._onDrop = function (e, t) {
  if (e.id !== t.id) {
    e.delClassNames("vibrate");
    var i = e.index,
      n = t.index,
      o = this;
    m.tween(e, {
      webkitTransform: "translate3d(" + (t.x - e.x) + "px," + (t.y - e.y) + "px,0)"
    }, {
      time: 100,
      easing: "ease-out"
    }, function () {
      o._positionIcon(e, n);
      o._iconOrder[e.index] = e.id;
      o._iconOrder[t.index] = t.id;
      p.setValue(I, o._iconOrder);
      e.addClassNames("vibrate");
    });
    this._positionIcon(t, i);
  }
};
a.prototype._createIcon = function (e, t) {
  var i = this;
  this._iconsBox.createChild("div", {
    className: "iconBox"
  });
  var o = T[t],
    a = this._icons.appendChild(new h({
      className: ["vibrate", "anim" + Math.floor(9 * Math.random()), "menuIcon" + t, "menuBarIcon"],
      tooltip: function () {
        return d(o.tooltip, o.param);
      },
      name: t,
      scaleOnPress: !0
    }, function () {
      if (this.isDisabled) {
        var e = window.gui.uiLocker.getMenuButtonLockedReasons(t);
        return void v.showNotification(e.join("\r\n"), this);
      }
      i.close();
      var s = t;
      "Carac" === t ? s = "Characteristics" : "Goultine" === t ? s = "Shop" : "Conquest" === t ? s = "Koliseum" : "Book" === t ? s = "Quests" : "Bag" === t && (s = "Equipment");
      _.log("HUD.Click_on_button", {
        interface_id: "MenuBar",
        button_id: "BTN_MENUBAR_" + s.toUpperCase(),
        clic_parameter_key: "position",
        clic_parameter_value: a.index + 1,
        clic_type: "Simple_court"
      });
      o.action ? o.action() : n(o.windowId, o.tabId);
    }));
  a.id = t;
  a.index = e;
  c.setDraggable(a, null, "menuBar", null, {
    dragElement: !0,
    dragOnTouchstart: !0
  });
  c.setDroppable(a, ["menuBar"], {
    matchPositionOnDrop: !0
  });
  c.disableDrag(a);
  a.on("drop", function (e) {
    i._onDrop(this, e);
  });
  a.on("tooltipOn", function () {
    this.setStyle("webkitTransform", "scale(1.1)");
  });
  a.on("tooltipOut", function () {
    this.setStyle("webkitTransform", "scale(1)");
  });
};
a.prototype._getIcon = function (e) {
  return this._icons.getChild(e);
};
a.prototype.getIconForTuto = function (e) {
  return this._getIcon(e);
};
a.prototype._reorderButtons = function () {
  for (var e = this._icons.getChildren(), t = this._iconsBox.getChildren(), i = 0, n = e.length; i < n; i += 1) {
    var o = e[i];
    this._positionIcon(o, o.index);
    this._positionIcon(t[i], o.index);
  }
};
a.prototype._setButtonsOrder = function (e) {
  for (var t = 0; t < e.length; t++) {
    var i = e[t],
      n = this._icons.getChild(i);
    n.index = t;
    this._positionIcon(n, t);
  }
};
a.prototype._loadButtonOrderFromAccountPref = function () {
  if (this._iconOrder = p.getValue(I, null), this._iconOrder) {
    for (var e = 0; e < C.length; e++) {
      this._iconOrder.indexOf(C[e]) === -1 && this._iconOrder.splice(e, 0, C[e]);
    }
  } else {
    this._iconOrder = C.concat();
  }
  for (var t = 0; t < this._iconOrder.length; t++) {
    var i = this._iconOrder[t],
      n = this._icons.getChild(i);
    if (n) {
      var o = window.gui.uiLocker.isMenuButtonAvailable(i);
      this.setIconAvailability(i, o);
    } else {
      this._iconOrder.splice(t, 1);
      t--;
    }
  }
};
a.prototype._positionIcon = function (e, t) {
  window.gui.ipadRatio ? (e.x = (y + 1) * (t % this._iconsPerLine), e.y = (y + 2) * Math.floor(t / this._iconsPerLine)) : (e.x = (y + 4) * Math.floor(t / this._iconsPerColumn), e.y = y * (t % this._iconsPerColumn));
  e.index = t;
  e.setStyles({
    left: e.x + "px",
    top: e.y + "px",
    webkitTransform: ""
  });
};
a.prototype.computeMinimumSize = function (e, t) {
  return this._sizeInIcons = e, e * y + b[t];
};
a.prototype._resize = function () {
  var e,
    t = window.gui.ipadRatio ? "narrow" : "wide";
  window.gui.ipadRatio ? (this._iconsPerLine = this._sizeInIcons, this._iconsPerColumn = Math.ceil(C.length / this._iconsPerLine), this.setStyles({
    top: "",
    right: "",
    bottom: 0,
    left: l.posMenuBar + "px",
    width: l.menuBarSize + "px",
    height: l.bottomBarHeight + "px"
  }), this._icons.setStyle("height", y * this._iconsPerColumn + M[t] + "px"), this._icons.setStyle("width", y * this._iconsPerLine + "px"), e = "top") : (this._iconsPerColumn = this._sizeInIcons, this._iconsPerLine = Math.ceil(C.length / this._iconsPerColumn), this.setStyles({
    bottom: "",
    left: "",
    top: l.posMenuBar + "px",
    right: 0,
    width: l.sideBarWidth + "px",
    height: l.menuBarSize + "px"
  }), this._icons.setStyle("width", y * this._iconsPerLine + M[t] + "px"), e = "left");
  this._reorderButtons();
  this.setOpeningSide(e);
};
a.prototype._addNotificationIcon = function (e, t, i) {
  if (!e) {
    return void console.error("MenuBar._addNotificationIcon: undefined iconName with notificationIcon", t);
  }
  if (!t) {
    return void console.error("MenuBar._addNotificationIcon: undefined notificationIcon on iconName", e);
  }
  i = i || {};
  var n = this._getIcon(e);
  if (n) {
    var o = this._notificationIconList;
    o.hasOwnProperty(e) || (o[e] = t, !i.doNotShow && window.gui.uiLocker.isMenuButtonAvailable(e) && n.addClassNames(t));
  }
};
a.prototype._removeNotificationIcon = function (e, t) {
  if (!e) {
    return void console.error("MenuBar._removeNotificationIcon: undefined iconName with notificationIcon:", t);
  }
  if (!t) {
    return void console.error("MenuBar._removeNotificationIcon: undefined notificationIcon on iconName:", e);
  }
  var i = this._getIcon(e);
  if (i) {
    var n = this._notificationIconList;
    n.hasOwnProperty(e) && (i.delClassNames(t), delete n[e]);
  }
};
a.prototype._clearNotificationIconsStyle = function (e) {
  e ? e instanceof Array || (e = [e]) : e = "all";
  for (var t = this._notificationIconList, i = this._icons.getChildren(), n = 0; n < i.length; n += 1) {
    var o = i[n],
      a = o.id;
    t.hasOwnProperty(a) && ("all" !== e && e.indexOf(t[a]) === -1 || o.delClassNames(t[a]));
  }
};
a.prototype._resetNotificationIconList = function () {
  var e = this._notificationIconList;
  for (var t in e) {
    e.hasOwnProperty(t) && delete e[t];
  }
};
a.prototype._showNotificationIcons = function (e) {
  e ? e instanceof Array || (e = [e]) : e = "all";
  var t = this._notificationIconList;
  for (var i in t) {
    if (t.hasOwnProperty(i)) {
      var n = i,
        o = this._getIcon(n);
      "all" !== e && e.indexOf(t[n]) === -1 || o.addClassNames(t[n]);
    }
  }
};
this._iconsBox = this.content.createChild("div", {
  className: "iconsBoxContainer"
});
this._icons = this.content.createChild("div", {
  className: "iconsContainer"
});
this._unlock = !1;
this._lockBtn = this.content.appendChild(new h({
  className: "lockBtn",
  scaleOnPress: !0
}, function () {
  e._toggleIconsDrag(!e._unlock);
}));
i.toggleClassName("disabled", !t);
i.isDisabled = !t;
this._lockBtn.toggleClassName("on", !e);
this.toggleClassName("draggable", e);
this._unlock = e;
o.uiLocker.on("updated", function (e) {
  if (e.menuButtonId) {
    if (!T[e.menuButtonId]) {
      return console.error(new Error("Unknown button id `" + e.menuButtonId + "` in MenuBar."));
    }
    if (n.setIconAvailability(e.menuButtonId, !e.locked), !e.locked) {
      var t = n._getIcon(e.menuButtonId);
      if (t) {
        var i = n._notificationIconList,
          o = e.menuButtonId,
          a = i[o];
        i.hasOwnProperty(o) && t.addClassNames(a);
      }
    }
  }
});
o.on("SpouseInformationsMessage", function (e) {
  T.Spouse.param = e.spouse.sex;
});
o.fightManager.on("fightStart", function () {
  n._clearNotificationIconsStyle();
});
o.fightManager.on("fightEnd", function () {
  n._showNotificationIcons();
});
o.playerData.inventory.on("weightUpdated", function (e, n) {
  var o = e / n;
  o < w ? t("Bag") : o >= w && i("Bag");
});
o.playerData.quests.on("DQStarted", function () {
  g.isWindowOpen("dailyQuest") || i("DailyQuest");
});
o.playerData.characters.on("newSpellLearned", function () {
  n._addNotificationIcon("Spell", "plusIcon", {
    doNotShow: e()
  });
});
o.playerData.on("characterLevelUp", function () {
  n._addNotificationIcon("Carac", "plusIcon", {
    doNotShow: e()
  });
});
this._setButtonsOrder(C);
this.enableDragButton(!1);
window.gui.uiLocker.lockAllFeaturesExcept(e, "tutorial", d("tablet.tutorial.uiLocker.default"));
this._clearNotificationIconsStyle(["plusIcon"]);
this._setButtonsOrder(this._iconOrder);
this.enableDragButton(!0);
window.gui.uiLocker.unlockAllFeatures("tutorial");
this._showNotificationIcons(["plusIcon"]);
t.on("connected", function () {
  e._loadButtonOrderFromAccountPref();
  e._setButtonsOrder(e._iconOrder);
});
t.on("disconnect", function () {
  e._clearNotificationIconsStyle();
  e._resetNotificationIconList();
  e._addedBagWarnRedIcon = !1;
  e._addedBagWarnYellowIcon = !1;
});
this.on("close", function () {
  this._toggleIconsDrag(!1);
});
e._loadButtonOrderFromAccountPref();
e._setButtonsOrder(e._iconOrder);
e._clearNotificationIconsStyle();
e._resetNotificationIconList();
e._addedBagWarnRedIcon = !1;
e._addedBagWarnYellowIcon = !1;
m.tween(e, {
  webkitTransform: "translate3d(" + (t.x - e.x) + "px," + (t.y - e.y) + "px,0)"
}, {
  time: 100,
  easing: "ease-out"
}, function () {
  o._positionIcon(e, n);
  o._iconOrder[e.index] = e.id;
  o._iconOrder[t.index] = t.id;
  p.setValue(I, o._iconOrder);
  e.addClassNames("vibrate");
});
this._positionIcon(t, i);
o._positionIcon(e, n);
o._iconOrder[e.index] = e.id;
o._iconOrder[t.index] = t.id;
p.setValue(I, o._iconOrder);
e.addClassNames("vibrate");
"Carac" === t ? s = "Characteristics" : "Goultine" === t ? s = "Shop" : "Conquest" === t ? s = "Koliseum" : "Book" === t ? s = "Quests" : "Bag" === t && (s = "Equipment");
_.log("HUD.Click_on_button", {
  interface_id: "MenuBar",
  button_id: "BTN_MENUBAR_" + s.toUpperCase(),
  clic_parameter_key: "position",
  clic_parameter_value: a.index + 1,
  clic_type: "Simple_court"
});
o.action ? o.action() : n(o.windowId, o.tabId);
a.id = t;
a.index = e;
c.setDraggable(a, null, "menuBar", null, {
  dragElement: !0,
  dragOnTouchstart: !0
});
c.setDroppable(a, ["menuBar"], {
  matchPositionOnDrop: !0
});
c.disableDrag(a);
a.on("drop", function (e) {
  i._onDrop(this, e);
});
a.on("tooltipOn", function () {
  this.setStyle("webkitTransform", "scale(1.1)");
});
a.on("tooltipOut", function () {
  this.setStyle("webkitTransform", "scale(1)");
});
this._positionIcon(o, o.index);
this._positionIcon(t[i], o.index);
n.index = t;
this._positionIcon(n, t);
this._iconOrder.splice(t, 1);
t--;
window.gui.ipadRatio ? (e.x = (y + 1) * (t % this._iconsPerLine), e.y = (y + 2) * Math.floor(t / this._iconsPerLine)) : (e.x = (y + 4) * Math.floor(t / this._iconsPerColumn), e.y = y * (t % this._iconsPerColumn));
e.index = t;
e.setStyles({
  left: e.x + "px",
  top: e.y + "px",
  webkitTransform: ""
});
window.gui.ipadRatio ? (this._iconsPerLine = this._sizeInIcons, this._iconsPerColumn = Math.ceil(C.length / this._iconsPerLine), this.setStyles({
  top: "",
  right: "",
  bottom: 0,
  left: l.posMenuBar + "px",
  width: l.menuBarSize + "px",
  height: l.bottomBarHeight + "px"
}), this._icons.setStyle("height", y * this._iconsPerColumn + M[t] + "px"), this._icons.setStyle("width", y * this._iconsPerLine + "px"), e = "top") : (this._iconsPerColumn = this._sizeInIcons, this._iconsPerLine = Math.ceil(C.length / this._iconsPerColumn), this.setStyles({
  bottom: "",
  left: "",
  top: l.posMenuBar + "px",
  right: 0,
  width: l.sideBarWidth + "px",
  height: l.menuBarSize + "px"
}), this._icons.setStyle("width", y * this._iconsPerLine + M[t] + "px"), e = "left");
this._reorderButtons();
this.setOpeningSide(e);
n._resize();
window.setTimeout(function () {
  n._resize();
  n.getCurrentDrawerSize() >= n.getCurrentContentSize() ? (n.setAsAlwaysOpen(!0), i.hide()) : (n.setAsAlwaysOpen(!1), i.show());
  n.refresh();
  e && n.shouldKeepOpen && n.open();
}, 0);
n._resize();
n.getCurrentDrawerSize() >= n.getCurrentContentSize() ? (n.setAsAlwaysOpen(!0), i.hide()) : (n.setAsAlwaysOpen(!1), i.show());
n.refresh();
e && n.shouldKeepOpen && n.open();
e = e || {};
a.call(this, {
  className: "MenuDrawer",
  background: !0,
  autoClose: e.autoClose,
  backDrawerSize: e.backDrawerSize
});
this.shouldKeepOpen = !1;
window.gui.once("connected", function () {
  this.on("resize", function () {
    t();
  });
  t();
});
window.gui.on("disconnect", function () {
  n.close();
});
this.content.createChild("div", {
  className: "topBorder"
});
i = this.content.createChild("div", {
  className: "arrowBtnBg"
});
i.appendChild(new s({
  className: "arrowBtn"
}, function () {
  n.isOpen ? n.close() : n.open();
}));
this.on("resize", function () {
  t();
});
t();
o || i.once("tap", function () {
  var e = window.gui.notificationBar,
    t = {
      type: e.notificationType.PRIORITY_INVITATION,
      title: r("tablet.tutorial.tip"),
      text: r("tablet.tutorial.canSwipeDrawer")
    };
  e.newNotification("tip canSwipeDrawer", t);
  l.setValue("tablet.tutorial.canSwipeDrawer", !0);
});
this.createChild("div", {
  className: "borderBox"
});
e.newNotification("tip canSwipeDrawer", t);
l.setValue("tablet.tutorial.canSwipeDrawer", !0);
o(n, a);
e.exports = n;
n.prototype._resize = function () {};
this.content.setStyle("webkitTransform", i);
this.background && this.background.setStyle("webkitTransform", i);
this.content.setStyle("webkitTransform", i);
this.background && this.background.setStyle("webkitTransform", i);
c || d.close();
c = !1;
r.call(this, "div", {
  className: "SwipingDrawer"
});
e = e || {};
this.addClassNames(e.className);
e.background && (this.backgroundArea = this.createChild("div", {
  className: "drawerBackgroundArea"
}), this.background = this.backgroundArea.createChild("div", {
  className: "drawerBackground"
}));
this.visibleArea = this.createChild("div", {
  className: "visibleArea"
});
this.content = this.visibleArea.createChild("div", {
  className: "drawerContent"
});
this._contentSize = 0;
this._extraContentSize = e.backDrawerSize || 0;
this.isOpen = !1;
this._isAlwaysOpen = !1;
a(this);
this.on("slideStart", function (e) {
  this._isAlwaysOpen || (this.addClassNames("open"), this._tween1 && (this._tween1.cancel(), this._tween1 = null), this._tween2 && (this._tween2.cancel(), this._tween2 = null), l = e[this._axis], s = this.isOpen ? t : i, this.on("slide", s));
});
this.on("slideEnd", function (e, t, i) {
  if (!this._isAlwaysOpen) {
    var n = "x" === this._axis ? t : i;
    this._currentPosition += n;
    var o;
    o = e ? n * this._direction < 0 : this.isOpen;
    o ? this._open(!0) : this._close(!0);
    this.removeListener("slide", s);
  }
});
this.on("slideCancel", function () {
  this._isAlwaysOpen || (this.isOpen ? this._open(!0) : this._close(!0), this.removeListener("slide", s));
});
o = e ? n * this._direction < 0 : this.isOpen;
o ? this._open(!0) : this._close(!0);
this.removeListener("slide", s);
e.autoClose && (this.on("open", function () {
  this.on("dom.touchstart", n);
  window.gui.wBody.on("dom.touchstart", o);
}), this.on("close", function () {
  this.removeListener("dom.touchstart", n);
  window.gui.wBody.removeListener("dom.touchstart", o);
}));
e.openingSide && this.setOpeningSide(e.openingSide);
this.on("dom.touchstart", n);
window.gui.wBody.on("dom.touchstart", o);
this.removeListener("dom.touchstart", n);
window.gui.wBody.removeListener("dom.touchstart", o);
o(n, r);
e.exports = n;
n.prototype.getCurrentDrawerSize = function () {
  return parseInt(this.getStyle(this._dimension), 10);
};
n.prototype.getCurrentContentSize = function () {
  return this.content.rootElement[this._clientProperty];
};
n.prototype.setAsAlwaysOpen = function (e) {
  this._isAlwaysOpen = e;
  this.lockDrawer(e);
};
n.prototype.lockDrawer = function (e) {
  e !== this.drawerLocked && (this.close(), this.drawerLocked = e, this.lockSlide(e));
};
n.prototype.setOpeningSide = function (e) {
  switch (this.side = e, this.replaceClassNames(["top", "bottom", "left", "right"], [e]), e) {
    case "top":
      this._axis = "y";
      this._dimension = "height";
      this._clientProperty = "clientHeight";
      this._direction = 1;
      this.setSlideDirection("vertical");
      break;
    case "bottom":
      this._axis = "y";
      this._dimension = "height";
      this._clientProperty = "clientHeight";
      this._direction = -1;
      this.setSlideDirection("vertical");
      break;
    case "left":
      this._axis = "x";
      this._dimension = "width";
      this._clientProperty = "clientWidth";
      this._direction = 1;
      this.setSlideDirection("horizontal");
      break;
    case "right":
      this._axis = "x";
      this._dimension = "width";
      this._clientProperty = "clientWidth";
      this._direction = -1;
      this.setSlideDirection("horizontal");
  }
};
n.prototype.refresh = function () {
  if (this._visibleSize = this.rootElement[this._clientProperty], this._contentSize = this.getCurrentContentSize(), this._contentSize) {
    this._isAlwaysOpen && (this._contentSize += this._extraContentSize);
    this._contentSize < this._visibleSize && (this._contentSize = this._visibleSize);
    var e, t, i, n, o, a;
    switch (e = t = i = n = o = a = "", this.side) {
      case "top":
        t = this._visibleSize + "px";
        break;
      case "bottom":
        e = this._visibleSize + "px";
        break;
      case "left":
        n = this._visibleSize + "px";
        break;
      case "right":
        i = this._visibleSize + "px";
    }
    if (this.content.setStyles({
      top: e,
      bottom: t,
      left: i,
      right: n,
      width: o,
      height: a,
      webkitTransform: "translate" + this._axis + "(" + 100 * this._direction + "%)"
    }), this.setStyle(this._dimension, this._contentSize + "px"), this.background) {
      var s = {
        top: e,
        bottom: t,
        left: i,
        right: n,
        width: "",
        height: "",
        webkitTransform: "translate" + this._axis + "(" + 100 * this._direction + "%)"
      };
      s[this._dimension] = this._contentSize + "px";
      this.background.setStyles(s);
    }
    this._currentPosition = this._contentSize * this._direction;
    this.isOpen = !1;
    this.delClassNames("open");
  }
};
n.prototype._open = function (e) {
  if (e || !(this._opening || this.isOpen || this.drawerLocked)) {
    this._opening = !0;
    this.addClassNames("open");
    this._tween1 && this._tween1.cancel();
    this._tween2 && this._tween2.cancel();
    e || this.emit("opening");
    var t = this;
    this._tween1 = s.tween(this.content, {
      webkitTransform: "translate" + this._axis + "(" + this._visibleSize * this._direction + "px)"
    }, {
      time: l,
      easing: "ease-out"
    }, function () {
      t._currentPosition = t._visibleSize * t._direction;
      t._tween1 = null;
      t._opening = !1;
      t.isOpen || t.emit("open");
      t.isOpen = !0;
    });
    this.background && (this._tween2 = s.tween(this.background, {
      webkitTransform: "translate" + this._axis + "(" + this._visibleSize * this._direction + "px)"
    }, {
      time: l,
      easing: "ease-out"
    }, function () {
      t._tween2 = null;
    }));
  }
};
n.prototype.open = function () {
  this._open(!1);
};
n.prototype._close = function (e) {
  if (e || !this._closing && this.isOpen && !this.drawerLocked) {
    this._closing = !0;
    this._tween1 && this._tween1.cancel();
    this._tween2 && this._tween2.cancel();
    e || this.emit("closing");
    var t = this;
    this._tween1 = s.tween(this.content, {
      webkitTransform: "translate" + this._axis + "(" + 100 * this._direction + "%)"
    }, {
      time: l,
      easing: "ease-out"
    }, function () {
      t._currentPosition = t._contentSize * t._direction;
      t._tween1 = null;
      t._closing = !1;
      t.emit("close");
      t.isOpen = !1;
      t.delClassNames("open");
    });
    this.background && (this._tween2 = s.tween(this.background, {
      webkitTransform: "translate" + this._axis + "(" + 100 * this._direction + "%)"
    }, {
      time: l,
      easing: "ease-out"
    }, function () {
      t._tween2 = null;
    }));
  }
};
n.prototype.close = function () {
  this._close(!1);
};
this._isAlwaysOpen = e;
this.lockDrawer(e);
this._axis = "y";
this._dimension = "height";
this._clientProperty = "clientHeight";
this._direction = 1;
this.setSlideDirection("vertical");
this._axis = "y";
this._dimension = "height";
this._clientProperty = "clientHeight";
this._direction = -1;
this.setSlideDirection("vertical");
this._axis = "x";
this._dimension = "width";
this._clientProperty = "clientWidth";
this._direction = 1;
this.setSlideDirection("horizontal");
this._axis = "x";
this._dimension = "width";
this._clientProperty = "clientWidth";
this._direction = -1;
this.setSlideDirection("horizontal");
this._isAlwaysOpen && (this._contentSize += this._extraContentSize);
this._contentSize < this._visibleSize && (this._contentSize = this._visibleSize);
s[this._dimension] = this._contentSize + "px";
this.background.setStyles(s);
this._currentPosition = this._contentSize * this._direction;
this.isOpen = !1;
this.delClassNames("open");
this._opening = !0;
this.addClassNames("open");
this._tween1 && this._tween1.cancel();
this._tween2 && this._tween2.cancel();
e || this.emit("opening");
this._tween1 = s.tween(this.content, {
  webkitTransform: "translate" + this._axis + "(" + this._visibleSize * this._direction + "px)"
}, {
  time: l,
  easing: "ease-out"
}, function () {
  t._currentPosition = t._visibleSize * t._direction;
  t._tween1 = null;
  t._opening = !1;
  t.isOpen || t.emit("open");
  t.isOpen = !0;
});
this.background && (this._tween2 = s.tween(this.background, {
  webkitTransform: "translate" + this._axis + "(" + this._visibleSize * this._direction + "px)"
}, {
  time: l,
  easing: "ease-out"
}, function () {
  t._tween2 = null;
}));
t._currentPosition = t._visibleSize * t._direction;
t._tween1 = null;
t._opening = !1;
t.isOpen || t.emit("open");
t.isOpen = !0;
this._closing = !0;
this._tween1 && this._tween1.cancel();
this._tween2 && this._tween2.cancel();
e || this.emit("closing");
this._tween1 = s.tween(this.content, {
  webkitTransform: "translate" + this._axis + "(" + 100 * this._direction + "%)"
}, {
  time: l,
  easing: "ease-out"
}, function () {
  t._currentPosition = t._contentSize * t._direction;
  t._tween1 = null;
  t._closing = !1;
  t.emit("close");
  t.isOpen = !1;
  t.delClassNames("open");
});
this.background && (this._tween2 = s.tween(this.background, {
  webkitTransform: "translate" + this._axis + "(" + 100 * this._direction + "%)"
}, {
  time: l,
  easing: "ease-out"
}, function () {
  t._tween2 = null;
}));
t._currentPosition = t._contentSize * t._direction;
t._tween1 = null;
t._closing = !1;
t.emit("close");
t.isOpen = !1;
t.delClassNames("open");
c.call(this, {
  autoClose: !0
});
this.addClassNames("MainControls");
this._createDom();
this._fightCount = 0;
this._shouldForceCreature = !1;
t.on("connected", function () {
  e._shouldForceCreature = !1;
  y && this.serversData.isTournamentServer() && (e._shouldForceCreature = !0, y = !1);
  e._setPreferences();
  e._setLayout("roleplay", !0);
  e._swapMonsterInfoButton(d.monsterInfoFirstPosition);
});
t.on("disconnect", function () {
  e._fightCount = 0;
  e.fightLocked = !1;
  e._shouldForceCreature = !1;
});
e._shouldForceCreature = !1;
y && this.serversData.isTournamentServer() && (e._shouldForceCreature = !0, y = !1);
e._setPreferences();
e._setLayout("roleplay", !0);
e._swapMonsterInfoButton(d.monsterInfoFirstPosition);
e._fightCount = 0;
e.fightLocked = !1;
e._shouldForceCreature = !1;
i.on("fightEnterPreparation", function () {
  var t = window.gui.playerData.isSpectator ? "spectator" : "battlePreparation";
  e._setLayout(t);
});
i.on("fightEnterBattle", function () {
  var t = window.gui.playerData.isSpectator ? "spectator" : "battle";
  e._setLayout(t);
});
i.on("fightEnd", function () {
  e._setLayout("roleplay");
});
i.on("fightOptionUpdate", function () {
  e._secretButton.toggleClassName("on", window.gui.fightManager.fightSecretOn);
  e._helpButton.toggleClassName("on", window.gui.fightManager.fightHelpOn);
});
d.on("monsterInfoFirstPosition", function (t) {
  e._swapMonsterInfoButton(t);
});
window.gui.scenarioManager.on("stepChanged", function () {
  var t = window.gui.scenarioManager.isBehaviourEnabled(v.FIGHT_LEAVE_BTN);
  e._leaveButton.toggleClassName("disabledBehaviour", !t);
});
e._secretButton.toggleClassName("on", window.gui.fightManager.fightSecretOn);
e._helpButton.toggleClassName("on", window.gui.fightManager.fightHelpOn);
l(n, c);
e.exports = n;
n.prototype._resize = function () {
  var e;
  window.gui.ipadRatio ? (this.setStyles({
    bottom: 0,
    top: "",
    right: "",
    left: s.posMainControlBar + "px",
    width: s.mainControlBarSize + "px",
    height: s.bottomBarHeight + "px"
  }), e = "top") : (this.setStyles({
    bottom: "",
    top: s.posMainControlBar + "px",
    right: 0,
    left: "",
    width: s.sideBarWidth + "px",
    height: s.mainControlBarSize + "px"
  }), e = "left");
  this.setOpeningSide(e);
};
n.prototype._swapMonsterInfoButton = function (e) {
  e ? this._changeButtonPosition("monsterInfoButton", "showFightsButton") : this._changeButtonPosition("monsterInfoButton", "nicknamesButton");
};
n.prototype._changeButtonPosition = function (e, t) {
  if (this.buttonBox) {
    for (var i = this.buttonBox.getChildren(), n = null, o = null, a = 0; a < i.length; a++) {
      i[a].getClassNames().indexOf(e) !== -1 ? n = i[a] : i[a].getClassNames().indexOf(t) !== -1 && (o = i[a]);
    }
    n && o && this.buttonBox.insertChildBefore(n, o);
  }
};
n.prototype._createDom = function () {
  function e(e, t) {
    "function" == typeof e && (t = e);
    e = e || {};
    var n = e.className || [];
    return n.push("controlsButton"), i.appendChild(new a({
      disable: !!e.disable,
      tooltip: e.tooltip,
      className: n,
      scaleOnPress: !0
    }, t));
  }
  var t = this,
    i = this.buttonBox = this.content.createChild("div", {
      className: "buttonBox"
    });
  this.playerPoints = i.appendChild(new u());
  this._fightListBtn = e({
    className: ["showFightsButton", "roleplayButton"],
    disable: !0
  }, function () {
    p.open("fightList");
  });
  o(this._fightListBtn, function () {
    return r("ui.fightsOnMap", t._fightCount);
  });
  window.gui.playerData.position.on("mapChanged", function (e) {
    var i = e.fights || [];
    t._fightCount = i.length;
    t._updateFightListButton();
  });
  window.gui.on("MapFightCountMessage", function (e) {
    t._fightCount = e.fightCount || 0;
    t._updateFightListButton();
  });
  this._tacticalModeBtn = e({
    className: ["tacticalModeButton", "battleButton", "battlePreparationButton", "spectatorButton"],
    tooltip: r("ui.fight.option.tacticMod")
  }, function () {
    var e = h.getValue("tacticModeEngaged", !1);
    e ? (_.turnOff(), t._tacticalModeBtn.delClassNames("on"), h.setValue("tacticModeEngaged", !1)) : (_.turnOn(), t._tacticalModeBtn.addClassNames("on"), h.setValue("tacticModeEngaged", !0));
  });
  this._consoleButton = e({
    className: ["consoleButton", "alwaysShowButton"]
  }, function () {
    p["switch"]("adminConsole");
  });
  this._monsterInfoButton = e({
    className: ["monsterInfoButton", "roleplayButton"]
  });
  this._monsterInfoButton.on("tapstart", function () {
    t._monsterInfoButton.toggleClassName("on", !0);
    window.foreground.showAllMonsterGroupTooltips();
  });
  this._monsterInfoButton.on("tapend", function () {
    t._monsterInfoButton.toggleClassName("on", !1);
    window.foreground.removeAllMonsterGroupTooltips();
  });
  this._nicknamesButton = e({
    className: ["nicknamesButton", "roleplayButton", "battleButton", "battlePreparationButton", "spectatorButton"],
    tooltip: r("ui.shortcuts.displayNames")
  }, function () {
    var e = window.actorManager.areNicknamesOn();
    t._nicknamesButton.toggleClassName("on", !e);
    e ? window.actorManager.turnNicknamesOff() : window.actorManager.turnNicknamesOn();
  });
  this._mapInfoButton = e({
    className: ["mapInfoButton", "roleplayButton"],
    tooltip: r("ui.option.mapInfo")
  }, function () {
    var e = t._isMapInfoDisplayed = !t._isMapInfoDisplayed;
    window.gui.mapCoordinateDisplay.setMapInfoVisibility(e);
    t._mapInfoButton.toggleClassName("on", e);
    h.setValue("showMapCoordinates", e);
  });
  this._fightLockButton = e({
    className: ["fightLockButton", "battlePreparationButton"],
    tooltip: r("ui.fight.option.blockJoiner")
  }, function () {
    t.fightLocked = !t.fightLocked;
    t._fightLockButton.toggleClassName("on", t.fightLocked);
    window.dofus.sendMessage("GameFightOptionToggleMessage", {
      option: f.FIGHT_OPTION_SET_CLOSED
    });
  });
  this._helpButton = e({
    className: ["helpButton", "battlePreparationButton"],
    tooltip: r("ui.fight.option.help")
  }, function () {
    window.dofus.sendMessage("GameFightOptionToggleMessage", {
      option: f.FIGHT_OPTION_ASK_FOR_HELP
    });
  });
  this._secretButton = e({
    className: ["secretButton", "battleButton", "battlePreparationButton"],
    tooltip: r("ui.fight.option.spectator")
  }, function () {
    window.dofus.sendMessage("GameFightOptionToggleMessage", {
      option: f.FIGHT_OPTION_SET_SECRET
    });
  });
  this._leaveButton = e({
    className: ["leaveButton", "battleButton", "battlePreparationButton", "spectatorButton"],
    tooltip: r("ui.common.quit")
  }, function () {
    var e = window.gui,
      t = window.dofus.connectionManager;
    if (e.playerData.isSpectator) {
      return t.sendMessage("GameContextQuitMessage");
    }
    var i,
      n = 1 === e.serversData.settings.serverGameType;
    i = r(n && e.fightManager.fightType !== m.FIGHT_TYPE_CHALLENGE ? "ui.popup.hardcoreGiveup" : "ui.popup.giveup");
    e.fightManager.fightType === m.FIGHT_TYPE_PVP_ARENA && (i += "\n" + r("ui.party.arenaLeaveWarning"));
    e.openConfirmPopup({
      title: r("ui.popup.warning"),
      message: i,
      cb: function (e) {
        e && t.sendMessage("GameContextQuitMessage");
      }
    });
  });
  this._creatureModeButton = e({
    className: ["creatureModeButton", "alwaysShowButton"],
    tooltip: r("ui.fight.option.invisible")
  }, function () {
    var e = window.isoEngine.actorManager,
      i = !h.getValue("creatureMode", !1);
    t._creatureModeButton.toggleClassName("on", i);
    h.setValue("creatureMode", i);
    e.setCreatureMode(i);
  });
  this._transparentModeButton = e({
    className: ["transparentModeButton", "alwaysShowButton"],
    tooltip: r("ui.option.transparentOverlayMode")
  }, function () {
    var e = window.isoEngine.actorManager,
      i = !e.isTransparentModeOn;
    t._transparentModeButton.toggleClassName("on", i);
    h.setValue("transparentMode", i);
    e.setTransparentMode(i);
  });
  this._interactiveBlink = e({
    className: ["interactiveBlinkBtn", "roleplayButton"],
    tooltip: r("ui.option.interactivehaloModeButton")
  }, function () {
    var e = !window.isoEngine.interactiveBlink;
    window.isoEngine.setInteractiveBlink(e);
    e && window.isoEngine.highlightInteractivesWithDifferentType();
    t._interactiveBlink.toggleClassName("on", e);
    h.setValue("interactiveBlink", e);
  });
  this._progressBarPref = e({
    className: ["progressBarPrefBtn", "roleplayButton"],
    tooltip: r("ui.banner.customGauge")
  }, function () {
    window.gui.progressGauge.openPrefMenu();
  });
  e({
    className: ["globalMenu", "alwaysShowButton"],
    tooltip: r("ui.common.mainMenu")
  }, function () {
    p["switch"]("global");
  });
};
n.prototype._setLayout = function (e, t) {
  switch (e) {
    case "roleplay":
      this.replaceClassNames(["battlePreparation", "battle", "spectator"], ["roleplay"]);
      this.playerPoints.actionAndMovement.hide();
      break;
    case "spectator":
      this.replaceClassNames(["roleplay", "battle", "battlePreparation"], ["spectator"]);
      this.playerPoints.actionAndMovement.hide();
      this.buttonBox.getChildren()[2] !== this._leaveButton && this._leaveButton.insertBefore(this._tacticalModeBtn);
      break;
    case "battlePreparation":
      this.replaceClassNames(["roleplay", "battle", "spectator"], ["battlePreparation"]);
      this.fightHelpOn = !1;
      this._helpButton.delClassNames("on");
      this.fightSpectatorOn = !1;
      this._secretButton.addClassNames("on");
      this.buttonBox.getChildren()[2] !== this._leaveButton && this._leaveButton.insertBefore(this._tacticalModeBtn);
      break;
    case "battle":
      this.replaceClassNames(["roleplay", "battlePreparation", "spectator"], ["battle"]);
      this.buttonBox.getChildren()[3] !== this._leaveButton && this._leaveButton.insertBefore(this._consoleButton);
      window.gui.playerData.isSpectator || this.playerPoints.actionAndMovement.show();
  }
  var i = window.gui.playerData,
    n = i.hasRight(g.SHOW_ADMIN_CONSOLE_BUTTON);
  this._consoleButton.toggleDisplay(n);
  this._nicknamesButton.toggleClassName("on", window.actorManager.areNicknamesOn());
  t || (this._resize(), this.refresh());
};
n.prototype._setPreferences = function () {
  var e = this._isMapInfoDisplayed = h.getValue("showMapCoordinates", !0);
  this._mapInfoButton.toggleClassName("on", e);
  window.gui.mapCoordinateDisplay.setMapInfoVisibility(e);
  var t = h.getValue("tacticModeEngaged", !1);
  this._tacticalModeBtn.toggleClassName("on", t);
  var i = h.getValue("interactiveBlink", !0);
  this._interactiveBlink.toggleClassName("on", i);
  window.isoEngine.setInteractiveBlink(i);
  var n = h.getValue("creatureMode", !1);
  this._shouldForceCreature && (n = !0, h.setValue("creatureMode", !0));
  this._creatureModeButton.toggleClassName("on", n);
  window.isoEngine.actorManager.setCreatureMode(n);
  var o = h.getValue("transparentMode", !1);
  this._transparentModeButton.toggleClassName("on", o);
  window.isoEngine.actorManager.setTransparentMode(o);
};
n.prototype._updateFightListButton = function () {
  var e = this._fightCount > 0;
  this._fightListBtn.setEnable(e);
  this._fightListBtn.toggleClassName("on", e);
};
window.gui.ipadRatio ? (this.setStyles({
  bottom: 0,
  top: "",
  right: "",
  left: s.posMainControlBar + "px",
  width: s.mainControlBarSize + "px",
  height: s.bottomBarHeight + "px"
}), e = "top") : (this.setStyles({
  bottom: "",
  top: s.posMainControlBar + "px",
  right: 0,
  left: "",
  width: s.sideBarWidth + "px",
  height: s.mainControlBarSize + "px"
}), e = "left");
this.setOpeningSide(e);
"function" == typeof e && (t = e);
e = e || {};
this.playerPoints = i.appendChild(new u());
this._fightListBtn = e({
  className: ["showFightsButton", "roleplayButton"],
  disable: !0
}, function () {
  p.open("fightList");
});
o(this._fightListBtn, function () {
  return r("ui.fightsOnMap", t._fightCount);
});
window.gui.playerData.position.on("mapChanged", function (e) {
  var i = e.fights || [];
  t._fightCount = i.length;
  t._updateFightListButton();
});
window.gui.on("MapFightCountMessage", function (e) {
  t._fightCount = e.fightCount || 0;
  t._updateFightListButton();
});
this._tacticalModeBtn = e({
  className: ["tacticalModeButton", "battleButton", "battlePreparationButton", "spectatorButton"],
  tooltip: r("ui.fight.option.tacticMod")
}, function () {
  var e = h.getValue("tacticModeEngaged", !1);
  e ? (_.turnOff(), t._tacticalModeBtn.delClassNames("on"), h.setValue("tacticModeEngaged", !1)) : (_.turnOn(), t._tacticalModeBtn.addClassNames("on"), h.setValue("tacticModeEngaged", !0));
});
this._consoleButton = e({
  className: ["consoleButton", "alwaysShowButton"]
}, function () {
  p["switch"]("adminConsole");
});
this._monsterInfoButton = e({
  className: ["monsterInfoButton", "roleplayButton"]
});
this._monsterInfoButton.on("tapstart", function () {
  t._monsterInfoButton.toggleClassName("on", !0);
  window.foreground.showAllMonsterGroupTooltips();
});
this._monsterInfoButton.on("tapend", function () {
  t._monsterInfoButton.toggleClassName("on", !1);
  window.foreground.removeAllMonsterGroupTooltips();
});
this._nicknamesButton = e({
  className: ["nicknamesButton", "roleplayButton", "battleButton", "battlePreparationButton", "spectatorButton"],
  tooltip: r("ui.shortcuts.displayNames")
}, function () {
  var e = window.actorManager.areNicknamesOn();
  t._nicknamesButton.toggleClassName("on", !e);
  e ? window.actorManager.turnNicknamesOff() : window.actorManager.turnNicknamesOn();
});
this._mapInfoButton = e({
  className: ["mapInfoButton", "roleplayButton"],
  tooltip: r("ui.option.mapInfo")
}, function () {
  var e = t._isMapInfoDisplayed = !t._isMapInfoDisplayed;
  window.gui.mapCoordinateDisplay.setMapInfoVisibility(e);
  t._mapInfoButton.toggleClassName("on", e);
  h.setValue("showMapCoordinates", e);
});
this._fightLockButton = e({
  className: ["fightLockButton", "battlePreparationButton"],
  tooltip: r("ui.fight.option.blockJoiner")
}, function () {
  t.fightLocked = !t.fightLocked;
  t._fightLockButton.toggleClassName("on", t.fightLocked);
  window.dofus.sendMessage("GameFightOptionToggleMessage", {
    option: f.FIGHT_OPTION_SET_CLOSED
  });
});
this._helpButton = e({
  className: ["helpButton", "battlePreparationButton"],
  tooltip: r("ui.fight.option.help")
}, function () {
  window.dofus.sendMessage("GameFightOptionToggleMessage", {
    option: f.FIGHT_OPTION_ASK_FOR_HELP
  });
});
this._secretButton = e({
  className: ["secretButton", "battleButton", "battlePreparationButton"],
  tooltip: r("ui.fight.option.spectator")
}, function () {
  window.dofus.sendMessage("GameFightOptionToggleMessage", {
    option: f.FIGHT_OPTION_SET_SECRET
  });
});
this._leaveButton = e({
  className: ["leaveButton", "battleButton", "battlePreparationButton", "spectatorButton"],
  tooltip: r("ui.common.quit")
}, function () {
  var e = window.gui,
    t = window.dofus.connectionManager;
  if (e.playerData.isSpectator) {
    return t.sendMessage("GameContextQuitMessage");
  }
  var i,
    n = 1 === e.serversData.settings.serverGameType;
  i = r(n && e.fightManager.fightType !== m.FIGHT_TYPE_CHALLENGE ? "ui.popup.hardcoreGiveup" : "ui.popup.giveup");
  e.fightManager.fightType === m.FIGHT_TYPE_PVP_ARENA && (i += "\n" + r("ui.party.arenaLeaveWarning"));
  e.openConfirmPopup({
    title: r("ui.popup.warning"),
    message: i,
    cb: function (e) {
      e && t.sendMessage("GameContextQuitMessage");
    }
  });
});
this._creatureModeButton = e({
  className: ["creatureModeButton", "alwaysShowButton"],
  tooltip: r("ui.fight.option.invisible")
}, function () {
  var e = window.isoEngine.actorManager,
    i = !h.getValue("creatureMode", !1);
  t._creatureModeButton.toggleClassName("on", i);
  h.setValue("creatureMode", i);
  e.setCreatureMode(i);
});
this._transparentModeButton = e({
  className: ["transparentModeButton", "alwaysShowButton"],
  tooltip: r("ui.option.transparentOverlayMode")
}, function () {
  var e = window.isoEngine.actorManager,
    i = !e.isTransparentModeOn;
  t._transparentModeButton.toggleClassName("on", i);
  h.setValue("transparentMode", i);
  e.setTransparentMode(i);
});
this._interactiveBlink = e({
  className: ["interactiveBlinkBtn", "roleplayButton"],
  tooltip: r("ui.option.interactivehaloModeButton")
}, function () {
  var e = !window.isoEngine.interactiveBlink;
  window.isoEngine.setInteractiveBlink(e);
  e && window.isoEngine.highlightInteractivesWithDifferentType();
  t._interactiveBlink.toggleClassName("on", e);
  h.setValue("interactiveBlink", e);
});
this._progressBarPref = e({
  className: ["progressBarPrefBtn", "roleplayButton"],
  tooltip: r("ui.banner.customGauge")
}, function () {
  window.gui.progressGauge.openPrefMenu();
});
e({
  className: ["globalMenu", "alwaysShowButton"],
  tooltip: r("ui.common.mainMenu")
}, function () {
  p["switch"]("global");
});
t._fightCount = i.length;
t._updateFightListButton();
t._fightCount = e.fightCount || 0;
t._updateFightListButton();
t._monsterInfoButton.toggleClassName("on", !0);
window.foreground.showAllMonsterGroupTooltips();
t._monsterInfoButton.toggleClassName("on", !1);
window.foreground.removeAllMonsterGroupTooltips();
t._nicknamesButton.toggleClassName("on", !e);
e ? window.actorManager.turnNicknamesOff() : window.actorManager.turnNicknamesOn();
window.gui.mapCoordinateDisplay.setMapInfoVisibility(e);
t._mapInfoButton.toggleClassName("on", e);
h.setValue("showMapCoordinates", e);
t.fightLocked = !t.fightLocked;
t._fightLockButton.toggleClassName("on", t.fightLocked);
window.dofus.sendMessage("GameFightOptionToggleMessage", {
  option: f.FIGHT_OPTION_SET_CLOSED
});
i = r(n && e.fightManager.fightType !== m.FIGHT_TYPE_CHALLENGE ? "ui.popup.hardcoreGiveup" : "ui.popup.giveup");
e.fightManager.fightType === m.FIGHT_TYPE_PVP_ARENA && (i += "\n" + r("ui.party.arenaLeaveWarning"));
e.openConfirmPopup({
  title: r("ui.popup.warning"),
  message: i,
  cb: function (e) {
    e && t.sendMessage("GameContextQuitMessage");
  }
});
t._creatureModeButton.toggleClassName("on", i);
h.setValue("creatureMode", i);
e.setCreatureMode(i);
t._transparentModeButton.toggleClassName("on", i);
h.setValue("transparentMode", i);
e.setTransparentMode(i);
window.isoEngine.setInteractiveBlink(e);
e && window.isoEngine.highlightInteractivesWithDifferentType();
t._interactiveBlink.toggleClassName("on", e);
h.setValue("interactiveBlink", e);
this.replaceClassNames(["battlePreparation", "battle", "spectator"], ["roleplay"]);
this.playerPoints.actionAndMovement.hide();
this.replaceClassNames(["roleplay", "battle", "battlePreparation"], ["spectator"]);
this.playerPoints.actionAndMovement.hide();
this.buttonBox.getChildren()[2] !== this._leaveButton && this._leaveButton.insertBefore(this._tacticalModeBtn);
this.replaceClassNames(["roleplay", "battle", "spectator"], ["battlePreparation"]);
this.fightHelpOn = !1;
this._helpButton.delClassNames("on");
this.fightSpectatorOn = !1;
this._secretButton.addClassNames("on");
this.buttonBox.getChildren()[2] !== this._leaveButton && this._leaveButton.insertBefore(this._tacticalModeBtn);
this.replaceClassNames(["roleplay", "battlePreparation", "spectator"], ["battle"]);
this.buttonBox.getChildren()[3] !== this._leaveButton && this._leaveButton.insertBefore(this._consoleButton);
window.gui.playerData.isSpectator || this.playerPoints.actionAndMovement.show();
this._consoleButton.toggleDisplay(n);
this._nicknamesButton.toggleClassName("on", window.actorManager.areNicknamesOn());
t || (this._resize(), this.refresh());
this._mapInfoButton.toggleClassName("on", e);
window.gui.mapCoordinateDisplay.setMapInfoVisibility(e);
this._interactiveBlink.toggleClassName("on", i);
window.isoEngine.setInteractiveBlink(i);
this._shouldForceCreature && (n = !0, h.setValue("creatureMode", !0));
this._creatureModeButton.toggleClassName("on", n);
window.isoEngine.actorManager.setCreatureMode(n);
this._transparentModeButton.toggleClassName("on", o);
window.isoEngine.actorManager.setTransparentMode(o);
this._fightListBtn.setEnable(e);
this._fightListBtn.toggleClassName("on", e);
a._lifePoints = e;
a.displayLifePoints();
a._maxLifePoints = e;
a.displayLifePoints();
this._lifePoints = 1;
this._maxLifePoints = 1;
this._shieldPoints = 0;
d.on("connected", function () {
  a.lifeDisplay = c.getValue("lifeDisplayMode", "simple");
});
d.on("disconnect", function () {
  a.lifeGauge.setStyle("height", "0%");
  a.lifePointsNumber.clearContent();
  a._shieldPoints = 0;
  a.updateShieldUI();
});
a.lifeGauge.setStyle("height", "0%");
a.lifePointsNumber.clearContent();
a._shieldPoints = 0;
a.updateShieldUI();
this.actionPointsNumber = u.createChild("div", {
  className: ["number", "actionPoints"]
});
this.movementPointsNumber = u.createChild("div", {
  className: ["number", "movementPoints"]
});
o(this.actionPointsNumber, s("ui.common.ap"));
o(this.movementPointsNumber, s("ui.common.mp"));
this.lifeGauge = p.createChild("div", {
  className: "lifeGauge"
});
h.createChild("div", {
  className: "highlights"
});
this.lifePointsNumberWrapper = h.createChild("div", {
  className: "numberWrapper"
});
this.lifePointsNumber = this.lifePointsNumberWrapper.createChild("div", {
  className: "number"
});
h.appendChild(new r());
o(p, s("ui.common.lifePoints"));
p.on("tap", function () {
  a.switchLifeDisplay();
});
m.on("specificCharacteristicsUpdated", function (o, a) {
  switch (o) {
    case "lifePoints":
      e(a);
      break;
    case "maxLifePoints":
      t(a);
      break;
    case "actionPointsCurrent":
      i(a);
      break;
    case "movementPointsCurrent":
      n(a);
  }
});
d.fightManager.on("shieldPointsUpdated", function (e, t) {
  e === m.controlledCharacterId && (a._shieldPoints = t, a.updateShieldUI());
});
a(n, l);
n.prototype.updateShieldUI = function () {
  this._shieldPoints > 0 ? this._addShieldColor() : this._removeShieldColor();
  this.displayLifePoints();
};
n.prototype._addShieldColor = function () {
  this.lifeGauge.addClassNames("shield");
};
n.prototype._removeShieldColor = function () {
  this.lifeGauge.delClassNames("shield");
};
n.prototype.switchLifeDisplay = function () {
  switch (this.lifeDisplay) {
    case "simple":
      this.lifeDisplay = "total";
      break;
    case "total":
      this.lifeDisplay = "percentage";
      break;
    case "percentage":
      this.lifeDisplay = "simple";
  }
  c.setValue("lifeDisplayMode", this.lifeDisplay);
  this.displayLifePoints();
};
n.prototype.displayLifePoints = function () {
  var e = this._lifePoints / this._maxLifePoints * 100;
  switch (this.lifeGauge.setStyle("height", e + "%"), this.lifeDisplay) {
    case "simple":
      this._shieldPoints > 0 ? this.lifePointsNumber.setHtml(this._lifePoints + "<br>" + this._shieldPoints) : this.lifePointsNumber.setHtml(this._lifePoints);
      break;
    case "total":
      this.lifePointsNumber.setHtml(this._lifePoints + "<br>" + this._maxLifePoints);
      break;
    case "percentage":
      this.lifePointsNumber.setHtml(Math.round(e) + "%");
  }
};
e.exports = n;
this._shieldPoints > 0 ? this._addShieldColor() : this._removeShieldColor();
this.displayLifePoints();
c.setValue("lifeDisplayMode", this.lifeDisplay);
this.displayLifePoints();
a.call(this, "div");
this._currentServerLag(0);
o(n, a);
e.exports = n;
n.prototype._currentServerLag = function (e) {
  e > s ? (this.setClassNames(["networkIndicator", "bad"]), console.debug("Current server lag is bad:", e)) : e > r ? this.setClassNames(["networkIndicator", "slow"]) : this.setClassNames(["networkIndicator", "good"]);
};
n.prototype.checkServerLag = function (e, t) {
  if ("start" === t) {
    this.serverLagEventName = e;
    this.serverLagStart = Date.now();
  } else if ("stop" === t) {
    if (this.serverLagEventName !== e) {
      return;
    }
    this._currentServerLag(Date.now() - this.serverLagStart);
    this.serverLagEventName = null;
  } else {
    console.warn("Invalid action emitted to checkServerLag", e, ":", t);
  }
};
this.serverLagEventName = e;
this.serverLagStart = Date.now();
this._currentServerLag(Date.now() - this.serverLagStart);
this.serverLagEventName = null;
e.isReady ? (e.hideGraphics(), e.hideStatedElements(), window.background.hide(), a(), s(), _.show(), g.show()) : e.once("ready", o);
window.gui.fightManager.tacticGraphicsOn();
f = p();
g = h();
_ = u(m.isRoleplayMode);
window.background.show();
e.showGraphics();
e.showStatedElements();
g = null;
_ = null;
f = null;
m.on("gameContextChanged", n);
t.turnOn = o;
t.turnOff = r;
C.cellId = o;
i.push(C);
t.makeTacticalBoxes = n;
t.makeTacticalBackground = o;
t.makeTacticGraphics = a;
e.width = a;
e.height = s;
t.clearRect(0, 0, a, s);
t.fillStyle = "#5A523C";
t.strokeStyle = "#CCCCCC";
t.beginPath();
t.moveTo(0, o / 2);
this.x0 = e;
this.y0 = t;
this.x1 = i;
this.y1 = n;
this.x2 = o;
this.y2 = a;
this.x3 = s;
this.y3 = r;
this.cellId = null;
a.call(this, e);
this._boxes = e.boxes;
this._hueContrast = e.hueContrast;
this._boxByteSize = this.renderer.getNbBytesPerBox();
this._bbox = [1 / 0, -(1 / 0), 1 / 0, -(1 / 0)];
this._createVertexBuffer();
o(n, a);
e.exports = n;
n.prototype._createBox = function (e, t) {
  var i = this._boxes[e];
  this._expandToFitBox(i);
  var n = e * this._boxByteSize / 4;
  this._positions[n + 0] = i.x0;
  this._positions[n + 1] = i.y0;
  this._colorView[n + 3] = t;
  this._positions[n + 5] = i.x2;
  this._positions[n + 6] = i.y2;
  this._colorView[n + 8] = t;
  this._positions[n + 10] = i.x3;
  this._positions[n + 11] = i.y3;
  this._colorView[n + 13] = t;
  this._positions[n + 15] = i.x0;
  this._positions[n + 16] = i.y0;
  this._colorView[n + 18] = t;
  this._positions[n + 20] = i.x1;
  this._positions[n + 21] = i.y1;
  this._colorView[n + 23] = t;
  this._positions[n + 25] = i.x2;
  this._positions[n + 26] = i.y2;
  this._colorView[n + 28] = t;
};
n.prototype._createVertexBuffer = function () {
  var e = this._boxes.length;
  this._vertexBuffer = new window.ArrayBuffer(e * this._boxByteSize);
  this._positions = new window.Float32Array(this._vertexBuffer);
  this._colorView = new window.Uint32Array(this._vertexBuffer);
  var t = 1077952576,
    i = 943734848;
  if (this._hueContrast) {
    for (var n = 0, o = !1, a = 0; a < e; a += 1) {
      var s = this._boxes[a];
      s.x0 > n ? (n = s.x0, this._createBox(a, o ? i : t)) : (n = 0, o = !o, this._createBox(a, o ? i : t));
    }
  } else {
    for (var r = 0; r < e; r += 1) {
      this._createBox(r, t);
    }
  }
  this._bbox[0] += this._x;
  this._bbox[1] += this._x;
  this._bbox[2] += this._y;
  this._bbox[3] += this._y;
  this.renderer.releaseBuffer(this.id);
  this.forceRefresh();
};
n.prototype.draw = function () {
  this.renderer.drawBoxBatch(this.id);
};
n.prototype._expandToFitPoint = function (e, t) {
  this._bbox[0] > e && (this._bbox[0] = e);
  this._bbox[2] > t && (this._bbox[2] = t);
  this._bbox[1] < e && (this._bbox[1] = e);
  this._bbox[3] < t && (this._bbox[3] = t);
};
n.prototype._expandToFitBox = function (e) {
  this._expandToFitPoint(e.x0, e.y0);
  this._expandToFitPoint(e.x1, e.y1);
  this._expandToFitPoint(e.x2, e.y2);
  this._expandToFitPoint(e.x3, e.y3);
};
n.prototype.generateCurrentFrameData = function () {
  var e = this.renderer.getBufferData(this.id);
  if (void 0 === e) {
    var t = this.id,
      i = this._positions,
      n = !1;
    this.renderer.loadSpriteBuffer(t, i, null, this._bbox, n);
    this.renderer.lockBuffer(this.id);
  }
  return this._bbox;
};
n.prototype.clear = function () {
  this.renderer.releaseBuffer(this.id);
};
this._positions[n + 0] = i.x0;
this._positions[n + 1] = i.y0;
this._colorView[n + 3] = t;
this._positions[n + 5] = i.x2;
this._positions[n + 6] = i.y2;
this._colorView[n + 8] = t;
this._positions[n + 10] = i.x3;
this._positions[n + 11] = i.y3;
this._colorView[n + 13] = t;
this._positions[n + 15] = i.x0;
this._positions[n + 16] = i.y0;
this._colorView[n + 18] = t;
this._positions[n + 20] = i.x1;
this._positions[n + 21] = i.y1;
this._colorView[n + 23] = t;
this._positions[n + 25] = i.x2;
this._positions[n + 26] = i.y2;
this._colorView[n + 28] = t;
this._vertexBuffer = new window.ArrayBuffer(e * this._boxByteSize);
this._positions = new window.Float32Array(this._vertexBuffer);
this._colorView = new window.Uint32Array(this._vertexBuffer);
this._bbox[0] += this._x;
this._bbox[1] += this._x;
this._bbox[2] += this._y;
this._bbox[3] += this._y;
this.renderer.releaseBuffer(this.id);
this.forceRefresh();
this._bbox[0] > e && (this._bbox[0] = e);
this._bbox[2] > t && (this._bbox[2] = t);
this._bbox[1] < e && (this._bbox[1] = e);
this._bbox[3] < t && (this._bbox[3] = t);
this._expandToFitPoint(e.x0, e.y0);
this._expandToFitPoint(e.x1, e.y1);
this._expandToFitPoint(e.x2, e.y2);
this._expandToFitPoint(e.x3, e.y3);
this.renderer.loadSpriteBuffer(t, i, null, this._bbox, n);
this.renderer.lockBuffer(this.id);
a.call(this, e);
this.w = e.w || 0;
this.h = e.h || 0;
this.texture = t;
o(n, a);
e.exports = n;
n.prototype.render = function () {
  this.renderer.save();
  this.renderer.multiplyColor(this.tint[0], this.tint[1], this.tint[2], this.tint[3]);
  this.renderer.drawImage(this.texture, this._x, this._y, this.w * this._scaleX, this.h);
  this.renderer.restore();
};
n.prototype.generateCurrentFrameData = function () {
  return [0, this.w, 0, this.h];
};
n.prototype.clear = function () {
  this.texture && this.texture.release();
};
this.renderer.save();
this.renderer.multiplyColor(this.tint[0], this.tint[1], this.tint[2], this.tint[3]);
this.renderer.drawImage(this.texture, this._x, this._y, this.w * this._scaleX, this.h);
this.renderer.restore();
d.call(this, "div", {
  className: "NotificationBar",
  hidden: !0
});
this.notificationType = h.notificationType;
s(this);
this.currentOpenedId = null;
this.dialogs = {};
this.container = this.createChild("div", {
  className: "container"
});
this.counter = this.createChild("div", {
  className: "counter"
});
this.on("dragStart", function () {
  e.hideDialog(e.currentOpenedId);
});
window.gui.on("disconnect", function () {
  e.clearNotifications();
});
a(n, d);
e.exports = n;
n.prototype._updateCounter = function () {
  var e = this.container.getChildren().length;
  this.counter.setText(e);
  this.toggleDisplay(e);
};
n.prototype._repositionDialog = function (e) {
  var t = this.dialogs[e],
    i = this.container.getChild(e);
  r.positionNextTo(t, i);
};
n.prototype._destroyNotification = function (e, t) {
  if (this.dialogs[e]) {
    this.dialogs[e].destroy();
    delete this.dialogs[e];
    var i = this.container.getChild(e),
      n = i.getChild("icon");
    if ("function" == typeof n.cancelTween && n.cancelTween(), i.destroy(), this._updateCounter(), !t && this.currentOpenedId) {
      if (e === this.currentOpenedId) {
        this.currentOpenedId = null;
        var o = this.container.getChildren();
        if (o.length) {
          var a = o[o.length - 1].getWuiName();
          this.showDialog(a, !0);
        }
      } else {
        this._repositionDialog(this.currentOpenedId);
      }
    }
  }
};
n.prototype.clearNotifications = function () {
  for (var e in this.dialogs) {
    this._destroyNotification(e, !0);
  }
  this.currentOpenedId = null;
};
n.prototype._notificationButtonAction = function (e) {
  return this.currentOpenedId === e ? this.hideDialog(e) : void this.showDialog(e);
};
n.prototype._createDialog = function (e, t) {
  function i() {
    o.removeNotification(e);
    t.onClose && t.onClose(-1);
  }
  function n() {
    var i = this.index,
      n = t.buttons[i].action(i);
    switch (n) {
      case "HIDE_DIALOG":
        o.hideDialog(e);
        break;
      default:
        o.removeNotification(e);
    }
  }
  var o = this,
    a = new d("div");
  a.createChild("div", {
    className: "dialogTitle",
    text: t.title
  });
  a.appendChild(new c({
    className: "closeBtn"
  }, i));
  t.wuidom ? (a.createChild("div", {
    className: "dialogText"
  }), a.appendChild(t.wuidom)) : a.createChild("div", {
    className: "dialogText",
    text: t.text
  });
  var s = a.createChild("div", {
    className: "buttons"
  });
  if (t.buttons) {
    t.buttons.length > 1 && !t.onClose && console.warn("Notification needs an onClose function");
    for (var r = 0; r < t.buttons.length; r++) {
      var l = s.appendChild(new c({
        className: "button",
        text: t.buttons[r].label
      }, n));
      l.index = r;
    }
  }
  var u = window.gui.gameGuiContainer.createChild("div", {
    className: "NotificationDialog"
  });
  u.appendChild(a);
  this.dialogs[e] = u;
};
n.prototype._createNotification = function (e, t) {
  var i = this;
  this.isNotificationOpen(e) && (console.error(new Error("notif " + e + " already existing, destroy.")), this._destroyNotification(e));
  var n = this.container.createChild("div", {
      className: "notificationButton",
      name: e
    }),
    a = n.appendChild(new c({
      className: ["icon", "spinner"],
      name: "icon"
    }, function () {
      i._notificationButtonAction(this.notifId);
    }));
  a.notifId = e;
  var s = "",
    r = "";
  if (!isNaN(t.type)) {
    var d = p[t.type] || {};
    s = d.icon || s;
    r = d.color || r;
  }
  s = t.iconId || s;
  r = t.iconColor || r;
  var u = ["gfx/notifications/" + (s || m) + ".png", "gfx/notifications/" + (r || f) + ".png"];
  o.preloadImages(u, function (o) {
    if (a && a.rootElement && (a.setStyle("backgroundImage", o[0] + ", " + o[1]), a.delClassNames("spinner"), t.timer)) {
      var s = parseInt(t.timer, 10),
        r = n.createChild("div", {
          className: "timer"
        }),
        c = l.tween(r, {
          height: "100%"
        }, {
          time: s,
          easing: "linear"
        }, function () {
          i.removeNotification(e);
        });
      a.cancelTween = c.cancel;
    }
  });
};
n.prototype.showDialog = function (e, t) {
  this.hideDialog(this.currentOpenedId);
  this.currentOpenedId = e;
  var i = this.container.getChild(e);
  i.addClassNames("opened");
  t && i.rootElement.scrollIntoView(!1);
  this._repositionDialog(e);
  u("NEW_TIPS");
};
n.prototype.hideDialog = function (e) {
  if (e && e === this.currentOpenedId) {
    var t = this.container.getChild(e);
    t.delClassNames("opened");
    this.currentOpenedId = null;
    this.dialogs[e].hide();
  }
};
n.prototype.removeNotification = function (e) {
  var t = this.dialogs[e];
  if (t) {
    var i = this;
    window.setTimeout(function () {
      i._destroyNotification(e);
    }, 0);
  }
};
n.prototype.newNotification = function (e, t) {
  this._createNotification(e, t);
  this._updateCounter();
  this._createDialog(e, t);
  this.showDialog(e, !0);
};
n.prototype.isNotificationOpen = function (e) {
  return !!this.dialogs[e];
};
this.counter.setText(e);
this.toggleDisplay(e);
this.dialogs[e].destroy();
delete this.dialogs[e];
o.removeNotification(e);
t.onClose && t.onClose(-1);
a.createChild("div", {
  className: "dialogTitle",
  text: t.title
});
a.appendChild(new c({
  className: "closeBtn"
}, i));
t.wuidom ? (a.createChild("div", {
  className: "dialogText"
}), a.appendChild(t.wuidom)) : a.createChild("div", {
  className: "dialogText",
  text: t.text
});
u.appendChild(a);
this.dialogs[e] = u;
s = d.icon || s;
r = d.color || r;
s = t.iconId || s;
r = t.iconColor || r;
this.hideDialog(this.currentOpenedId);
this.currentOpenedId = e;
i.addClassNames("opened");
t && i.rootElement.scrollIntoView(!1);
this._repositionDialog(e);
u("NEW_TIPS");
t.delClassNames("opened");
this.currentOpenedId = null;
this.dialogs[e].hide();
this._createNotification(e, t);
this._updateCounter();
this._createDialog(e, t);
this.showDialog(e, !0);
t.notificationType = i;
t.notificationPriority = [i.ERROR, i.PRIORITY_INVITATION, i.INVITATION, i.INFORMATION, i.TUTORIAL];
n[i.TUTORIAL] = {
  icon: 11,
  color: "green"
};
n[i.ERROR] = {
  icon: 11,
  color: "red"
};
n[i.INVITATION] = {
  icon: 12,
  color: "blue"
};
n[i.PRIORITY_INVITATION] = {
  icon: 10,
  color: "blue"
};
n[i.INFORMATION] = {
  icon: 27,
  color: "yellow"
};
t.notificationImageInfo = n;
this.inDialog = !1;
this.npcData = null;
this.npcActorId = null;
this.uiReplyHandler = this._uiReplyHandler.bind(this);
this._setListeners();
e.exports = n;
n.prototype._setListeners = function () {
  var e = window.dofus.connectionManager,
    t = this;
  e.on("NpcGenericActionFailureMessage", function () {
    window.foreground.unlock("npcActionRequest");
  });
  e.on("NpcDialogCreationMessage", function (e) {
    t.npcActorId = e.npcId;
    window.foreground.lock("npcActionRequest");
  });
  e.on("GameContextCreateMessage", function () {
    window.foreground.unlock("npcActionRequest");
  });
  window.isoEngine.on("mapLoaded", function () {
    window.foreground.unlock("npcActionRequest");
  });
  e.on("NpcDialogQuestionMessage", function (e) {
    if (!t.npcData) {
      var i = window.actorManager.getActor(t.npcActorId).data.npcData;
      t.prepareDialog(i);
    }
    s.log("Game_Action.Talk_To_NPC", {
      message_id: e.messageId,
      npc_id: t.npcData.id
    });
    t.nextQuestionAsync(e.messageId, e.visibleReplies, e.dialogParams);
  });
  e.on("LeaveDialogMessage", function () {
    window.foreground.unlock("npcActionRequest");
    t.inDialog && (window.gui.npcDialogUi.leaveDialog(), t.inDialog = !1);
  });
  e.on("ExchangeLeaveMessage", function () {
    window.foreground.unlock("npcActionRequest");
  });
};
n.prototype.prepareDialog = function (e) {
  this.npcData = e;
  var t,
    i,
    n = this.msgTextIds = {};
  for (i = 0; i < e.dialogMessages.length; i++) {
    t = e.dialogMessages[i];
    n[t[0]] = t[1];
  }
  for (n = this.replyTextIds = {}, i = 0; i < e.dialogReplies.length; i++) {
    t = e.dialogReplies[i];
    n[t[0]] = t[1];
  }
};
n.prototype.nextQuestionAsync = function (e, t, i) {
  this.inDialog = !0;
  this.replyIds = t;
  window.gui.npcDialogUi.prepareForNextQuestion(this.npcData, t.length);
  for (var n = this.msgTextIds[e], s = [n], r = 0; r < t.length; r++) {
    s.push(this.replyTextIds[t[r]]);
  }
  var l = this;
  a.getText(s, function (e, a) {
    if (e) {
      return console.error("Failed to get texts for NPC. textIds:", s, "error:", e), l._closeDialog();
    }
    var c = o(a[n], i),
      d = [];
    for (r = 0; r < t.length; r++) {
      d.push(a[l.replyTextIds[t[r]]]);
    }
    l._showUi(c, d);
  });
};
n.prototype._uiReplyHandler = function (e) {
  (null !== e || null === e && this.replyIds.length > 0) && s.log("Game_Action.Player_Answer_To_NPC", {
    answer_id: this.replyIds[e],
    npc_id: this.npcData.id
  });
  null !== e ? window.dofus.sendMessage("NpcDialogReplyMessage", {
    replyId: this.replyIds[e]
  }) : this._closeDialog();
};
n.prototype._closeDialog = function () {
  window.dofus.sendMessage("LeaveDialogRequestMessage", null);
  this.npcData = null;
  this.npcActorId = null;
};
n.prototype._showUi = function (e, t) {
  var i = {
    npcData: this.npcData,
    actor: window.actorManager.getActor(this.npcActorId)
  };
  window.gui.npcDialogUi.showNpcQuestion(e, t, this.uiReplyHandler, i);
};
e.on("NpcGenericActionFailureMessage", function () {
  window.foreground.unlock("npcActionRequest");
});
e.on("NpcDialogCreationMessage", function (e) {
  t.npcActorId = e.npcId;
  window.foreground.lock("npcActionRequest");
});
e.on("GameContextCreateMessage", function () {
  window.foreground.unlock("npcActionRequest");
});
window.isoEngine.on("mapLoaded", function () {
  window.foreground.unlock("npcActionRequest");
});
e.on("NpcDialogQuestionMessage", function (e) {
  if (!t.npcData) {
    var i = window.actorManager.getActor(t.npcActorId).data.npcData;
    t.prepareDialog(i);
  }
  s.log("Game_Action.Talk_To_NPC", {
    message_id: e.messageId,
    npc_id: t.npcData.id
  });
  t.nextQuestionAsync(e.messageId, e.visibleReplies, e.dialogParams);
});
e.on("LeaveDialogMessage", function () {
  window.foreground.unlock("npcActionRequest");
  t.inDialog && (window.gui.npcDialogUi.leaveDialog(), t.inDialog = !1);
});
e.on("ExchangeLeaveMessage", function () {
  window.foreground.unlock("npcActionRequest");
});
t.npcActorId = e.npcId;
window.foreground.lock("npcActionRequest");
s.log("Game_Action.Talk_To_NPC", {
  message_id: e.messageId,
  npc_id: t.npcData.id
});
t.nextQuestionAsync(e.messageId, e.visibleReplies, e.dialogParams);
window.foreground.unlock("npcActionRequest");
t.inDialog && (window.gui.npcDialogUi.leaveDialog(), t.inDialog = !1);
t = e.dialogMessages[i];
n[t[0]] = t[1];
t = e.dialogReplies[i];
n[t[0]] = t[1];
this.inDialog = !0;
this.replyIds = t;
window.gui.npcDialogUi.prepareForNextQuestion(this.npcData, t.length);
(null !== e || null === e && this.replyIds.length > 0) && s.log("Game_Action.Player_Answer_To_NPC", {
  answer_id: this.replyIds[e],
  npc_id: this.npcData.id
});
null !== e ? window.dofus.sendMessage("NpcDialogReplyMessage", {
  replyId: this.replyIds[e]
}) : this._closeDialog();
window.dofus.sendMessage("LeaveDialogRequestMessage", null);
this.npcData = null;
this.npcActorId = null;
g.call(this, "div", {
  className: "npcDialogUi",
  hidden: !0
});
this.inDialog = !1;
this.replyHandler = null;
this.npcName = null;
this.currentMsg = null;
this.msgBubble = null;
this.singleMsgBubbles = {};
this.isZoomed = !1;
this.isChangingZoom = !1;
this.uiBox = null;
window.gui.on("disconnect", this._closeDialog.bind(this));
this.highlightRepliesFunc = this._highlightReplies.bind(this);
e.leftBtn.setEnable(!!this.leftTab);
e.rightBtn.setEnable(!!this.rightTab);
e.replyId = t;
e.setText(i);
e.enable();
e.setStyles({
  width: n,
  lineHeight: M + "px",
  minHeight: o + "px"
});
e.show();
m(n, g);
e.exports = n;
n.prototype._closeDialog = function () {
  this.inDialog && (this.inDialog = !1, window.foreground.removeListener("dom.touchend", this.highlightRepliesFunc), this.replyHandler && this._sendReply(null), this._closeMsgBubble(), this.hide(), this._restoreZoom(), window.gui.boxArranger.removeBox(this.uiBox), this.uiBox = null, this.emit("closed"));
};
n.prototype._closeMsgBubble = function () {
  this.msgBubble && (this.msgBubble.close(), this.msgBubble = null);
};
n.prototype._newButton = function (e, t, i) {
  var n = e.appendChild(new u({
    className: t,
    addIcon: !0
  }, i));
  return n.myUi = this, n;
};
n.prototype._createContent = function () {
  this.setStyles({
    left: h.mapLeft + w + "px",
    width: h.mapWidth - 2 * w + "px",
    bottom: h.screenHeight - h.screenExceptToolbar.height + y + "px"
  });
  var e = this.frame = this.createChild("div", {
    className: "frame"
  });
  this.leftBtn = this._newButton(e, "leftBtn", s);
  var t = this.replyTabs = e.appendChild(new f({
    noHeader: !0,
    noCycling: !0
  }));
  t.myUi = this;
  t.on("openTab", l);
  this.replyElts = [];
  this.replyBoxes = [];
  this.numReplyTabs = 0;
  this.numUsedReplyTabs = 0;
  this.rightBtn = this._newButton(e, "rightBtn", r);
  this.closeBtn = this._newButton(e, "closeBtn", o);
};
n.prototype._prepareReplyButtons = function () {
  for (var e = this.replies, t = e.length, i = Math.ceil(t / b), n = this.numReplyTabs; n < i; n++) {
    var o = this.replyBoxes[n] = new g("div", {
      className: "replyBox"
    });
    this.replyTabs.addTab("", o, n);
    this.numReplyTabs++;
    for (var s = 0; s < b; s++) {
      var r = o.appendChild(new u({
        className: "reply"
      }, a));
      r.myUi = this;
      this.replyElts.push(r);
    }
  }
  for (n = t; n < this.replyElts.length; n++) {
    this.replyElts[n].hide();
  }
  for (this.leftBtn.toggleDisplay(i > 1), this.rightBtn.toggleDisplay(i > 1), this.replyBoxes[0].setStyle("textAlign", i > 1 ? "left" : "center"), n = this.numUsedReplyTabs; n < this.numReplyTabs; n++) {
    this.replyTabs.toggleTabAvailability(n, n < i);
  }
  this.numUsedReplyTabs = i;
  var l = I[t] || A;
  for (n = 0; n < t; n++) {
    c(this.replyElts[n], n, e[n], l, T);
  }
};
n.prototype._setAllReplyBoxesVisibility = function (e) {
  for (var t = 0; t < this.numUsedReplyTabs; t++) {
    this.replyBoxes[t].toggleDisplay(e);
  }
};
n.prototype._resizeAndAppear = function (e) {
  this.replyTabs.setStyle("opacity", 0);
  this._setAllReplyBoxesVisibility(!1);
  this._prepareReplyButtons();
  this._setAllReplyBoxesVisibility(!0);
  e && (this.setStyle("opacity", 0), this.show());
  var t = S[this.replies.length] || E;
  this.frame.setStyles({
    width: t
  });
  for (var i, n = C, o = this.replies, a = 0; a < o.length; a++) {
    i = this.replyElts[a].rootElement.offsetHeight;
    n = Math.max(n, i);
  }
  for (this.replyTabs.setStyle("min-height", n + "px"), a = 0; a < o.length; a++) {
    var s = this.replyElts[a];
    if (i = s.rootElement.offsetHeight, i !== n) {
      var r = Math.round(1 + (i - T) / M),
        l = Math.round(M + (n - i) / r);
      s.setStyles({
        "line-height": l + "px",
        minHeight: n + "px"
      });
    }
  }
  if (this.replyTabs.reopen(), this.leftBtn.setEnable(!!this.replyTabs.leftTab), this.rightBtn.setEnable(!!this.replyTabs.rightTab), this.replyTabs.setStyle("opacity", 1), e) {
    var c = this.rootElement;
    this.uiBox = window.gui.boxArranger.addObstacle(0, c.offsetTop - v, h.screenWidth, c.offsetHeight);
    this._waitZoomChange(this._appear);
  }
};
n.prototype._appear = function () {
  p.showProgressively(this, _);
};
n.prototype._waitZoomChange = function (e) {
  if (!this.isChangingZoom) {
    return e && e.call(this);
  }
  var t = this,
    i = window.isoEngine.mapScene.camera;
  i.once("atDestination", function () {
    return t.isChangingZoom && (t.isChangingZoom = !1, t.isZoomed && i.freeze()), e && e.call(t);
  });
};
n.prototype._zoomOnActor = function (e) {
  if (this.isZoomed) {
    return this._waitZoomChange(e);
  }
  this.isZoomed = !0;
  this.isChangingZoom = !0;
  var t = this.actor.bbox,
    i = window.isoEngine.mapScene.camera;
  this.previousZoom = i.zoom;
  this.previousCameraX = i.x;
  this.previousCameraY = i.y;
  i.zoom !== i.maxZoom && i.zoomTo(i.maxZoom);
  i.moveTo(t[1], t[2], !0);
  this._waitZoomChange(e);
};
n.prototype._restoreZoom = function (e) {
  if (!this.isZoomed) {
    return this._waitZoomChange(e);
  }
  this.isZoomed = !1;
  this.isChangingZoom = !0;
  var t = window.isoEngine.mapScene.camera;
  t.unfreeze();
  t.zoom !== this.previousZoom && t.zoomTo(this.previousZoom);
  t.moveTo(this.previousCameraX, this.previousCameraY, !0);
  this._waitZoomChange(e);
};
n.prototype._sendReply = function (e) {
  if (this.replyHandler) {
    if (null !== e) {
      this.replyElts[e].disable();
      var t = this.replies[e];
      window.gui.chat.logNPCReplyMsg(t);
    }
    this._closeMsgBubble();
    var i = this.replyHandler;
    this.replyHandler = null;
    i(e);
  }
};
n.prototype._bubbleTapHandler = function () {
  return 1 === this.replies.length ? this._sendReply(0) : void this._highlightReplies();
};
n.prototype._showLockedBubble = function () {
  this.replyHandler && (this.bubbleTapHandler || (this.bubbleTapHandler = this._bubbleTapHandler.bind(this)), this.msgBubble = d({
    msg: this.currentMsg,
    title: this.npcName,
    actor: this.actor,
    isLocked: !0,
    action: this.bubbleTapHandler,
    isNonChat: !0
  }));
};
n.prototype._showSingleMsgBubble = function () {
  var e = this,
    t = this.npcName;
  this.singleMsgBubbles[t] = d({
    msg: this.currentMsg,
    title: t,
    actor: this.actor,
    isNonChat: !0,
    onClose: function () {
      delete e.singleMsgBubbles[t];
    }
  });
  this._sendReply(null);
};
n.prototype._closeSingleMsgBubbles = function () {
  for (var e in this.singleMsgBubbles) {
    this.singleMsgBubbles[e].close();
  }
};
n.prototype._highlightReplies = function () {
  var e = this.frame.createChild("div", {
    className: "highlight"
  });
  window.setTimeout(function () {
    e.destroy();
  }, 250);
};
n.prototype._showQuestion = function () {
  this.frame || this._createContent();
  var e = !this.inDialog;
  this.inDialog = !0;
  this._closeSingleMsgBubbles();
  e ? this._zoomOnActor(this._showLockedBubble) : this._showLockedBubble();
  this._resizeAndAppear(e);
  e && window.foreground.on("dom.touchend", this.highlightRepliesFunc);
  this.emit("opened");
};
n.prototype.prepareForNextQuestion = function (e, t) {
  t ? this.inDialog || (this.actor = window.actorManager.getActorFromNpcId(e.id), this._zoomOnActor()) : this._restoreZoom();
};
n.prototype.showNpcQuestion = function (e, t, i, n) {
  if (null !== this.replyHandler && console.error("previous replyHandler was not called"), n = n || {}, this.replies = t, this.replyHandler = i, this.actor = n.actor || window.actorManager.getActorFromNpcId(n.npcData.id), this.npcName = n.npcData && n.npcData.nameId, this.currentMsg = e, 0 === t.length) {
    if (this.singleMsgBubbles[this.npcName]) {
      return this._sendReply(null);
    }
    this.hide();
    this._restoreZoom(this._showSingleMsgBubble);
  } else {
    this._showQuestion();
  }
};
n.prototype.leaveDialog = function () {
  this._closeDialog();
};
t.myUi = this;
t.on("openTab", l);
this.replyElts = [];
this.replyBoxes = [];
this.numReplyTabs = 0;
this.numUsedReplyTabs = 0;
this.rightBtn = this._newButton(e, "rightBtn", r);
this.closeBtn = this._newButton(e, "closeBtn", o);
this.replyTabs.addTab("", o, n);
this.numReplyTabs++;
r.myUi = this;
this.replyElts.push(r);
this.replyTabs.setStyle("opacity", 0);
this._setAllReplyBoxesVisibility(!1);
this._prepareReplyButtons();
this._setAllReplyBoxesVisibility(!0);
e && (this.setStyle("opacity", 0), this.show());
i = this.replyElts[a].rootElement.offsetHeight;
n = Math.max(n, i);
this.uiBox = window.gui.boxArranger.addObstacle(0, c.offsetTop - v, h.screenWidth, c.offsetHeight);
this._waitZoomChange(this._appear);
this.isZoomed = !0;
this.isChangingZoom = !0;
this.previousZoom = i.zoom;
this.previousCameraX = i.x;
this.previousCameraY = i.y;
i.zoom !== i.maxZoom && i.zoomTo(i.maxZoom);
i.moveTo(t[1], t[2], !0);
this._waitZoomChange(e);
this.isZoomed = !1;
this.isChangingZoom = !0;
t.unfreeze();
t.zoom !== this.previousZoom && t.zoomTo(this.previousZoom);
t.moveTo(this.previousCameraX, this.previousCameraY, !0);
this._waitZoomChange(e);
this.replyHandler = null;
i(e);
this.singleMsgBubbles[t] = d({
  msg: this.currentMsg,
  title: t,
  actor: this.actor,
  isNonChat: !0,
  onClose: function () {
    delete e.singleMsgBubbles[t];
  }
});
this._sendReply(null);
this.inDialog = !0;
this._closeSingleMsgBubbles();
e ? this._zoomOnActor(this._showLockedBubble) : this._showLockedBubble();
this._resizeAndAppear(e);
e && window.foreground.on("dom.touchend", this.highlightRepliesFunc);
this.emit("opened");
this.hide();
this._restoreZoom(this._showSingleMsgBubble);
_.call(this, "div", {
  className: "numberInputPad",
  hidden: !0
});
this.digits = [];
this.overlay = window.gui.gameGuiContainer.createChild("div", {
  className: "numberPadOverlay",
  hidden: !0
});
p(n, _);
e.exports = n;
n.prototype.open = function (e, t, i, n) {
  this.keyboard || this._createContent();
  this.inputBox = e;
  t && this.title.setText(t);
  this.minValue = void 0 !== i ? i : 0;
  this.maxValue = void 0 !== n ? n : y;
  this.setValue(e.getValue());
  this._switchMode(b.DISPLAY);
  this._show();
};
n.prototype._show = function () {
  if (this.overlay.show(), this.setStyle("opacity", 0), this.show(), !s) {
    var e = this.digitBoxes[0].rootElement;
    s = e.offsetTop + e.offsetHeight / 2;
  }
  var t = v(this.inputBox.rootElement),
    i = v(this.rootElement),
    n = t.right - i.width,
    o = t.top + t.height / 2 - s;
  n = Math.min(Math.max(n, C), c.screenWidth - C - i.width);
  o = Math.min(Math.max(o, C), c.screenHeight - C - i.height);
  this.setStyles({
    left: n + "px",
    top: o + "px"
  });
  this.setStyle("opacity", 1);
  this.rootElement.focus();
};
n.prototype._createContent = function () {
  var e = this;
  window.gui.on("disconnect", function () {
    e.hide();
  });
  this.on("hide", function () {
    e.overlay.hide();
  });
  var t = this.createChild("div", {
    className: "titleBar"
  });
  u(this, {
    grip: t,
    isFullScreen: !0
  });
  this.title = t.createChild("div", {
    className: "title"
  });
  var i = t.appendChild(new r({
    className: "closeButton",
    scaleOnPress: !0
  }));
  i.on("tap", function () {
    e.hide();
  });
  this.digitBoxes = [];
  this.digitElements = [];
  this.separators = [];
  for (var n = this.createChild("div", {
      className: "displayContainer"
    }), s = d("ui.common.numberSeparator") || ".", c = 0; c < w; c++) {
    var h = w - 1 - c,
      p = h % 3 === 2;
    p && (this.separators[h + 1] = n.createChild("div", {
      className: "separator",
      text: s
    }));
    var m = this.digitBoxes[h] = n.createChild("div", {
      className: "digitBox"
    });
    p && m.addClassNames("groupStart");
    m.id = h;
    m.numberInput = this;
    f(m);
    m.on("tap", a);
    this.digitElements[h] = m.createChild("div", {
      className: "digit"
    });
  }
  this.keyMap = {};
  var g = this.createChild("div", {
      className: "keyboardContainer"
    }),
    _ = this.keyboard = g.createChild("div", {
      className: "keyboard"
    });
  for (c = 0; c < M.length; c++) {
    var v = M[c],
      y = T[v] || v,
      b = this.keyMap[v] = new l(y, {
        className: ["keyboardKey", "key" + v]
      });
    "@" === y[0] && (y.length > 1 && b.createChild("div", {
      text: y.substr(1)
    }), b.createChild("div", {
      className: "keyIcon"
    }));
    _.appendChild(b);
    b.id = v;
    b.numberInput = this;
    b.on("tap", o);
  }
};
this.keyboard || this._createContent();
this.inputBox = e;
t && this.title.setText(t);
this.minValue = void 0 !== i ? i : 0;
this.maxValue = void 0 !== n ? n : y;
this.setValue(e.getValue());
this._switchMode(b.DISPLAY);
this._show();
n = Math.min(Math.max(n, C), c.screenWidth - C - i.width);
o = Math.min(Math.max(o, C), c.screenHeight - C - i.height);
this.setStyles({
  left: n + "px",
  top: o + "px"
});
this.setStyle("opacity", 1);
this.rootElement.focus();
window.gui.on("disconnect", function () {
  e.hide();
});
this.on("hide", function () {
  e.overlay.hide();
});
u(this, {
  grip: t,
  isFullScreen: !0
});
this.title = t.createChild("div", {
  className: "title"
});
i.on("tap", function () {
  e.hide();
});
this.digitBoxes = [];
this.digitElements = [];
this.separators = [];
p && m.addClassNames("groupStart");
m.id = h;
m.numberInput = this;
f(m);
m.on("tap", a);
this.digitElements[h] = m.createChild("div", {
  className: "digit"
});
"@" === y[0] && (y.length > 1 && b.createChild("div", {
  text: y.substr(1)
}), b.createChild("div", {
  className: "keyIcon"
}));
_.appendChild(b);
b.id = v;
b.numberInput = this;
b.on("tap", o);
n.prototype.setValue = function (e) {
  "string" == typeof e ? (e = e.replace(I, "").toString(), e || (e = "0")) : e = e.toFixed();
  e.length >= w && (e = e.substr(0, w));
  for (var t = w - 1; t >= e.length; t--) {
    this._setDigit(t, "");
  }
  for (var i = 0; i < e.length; i++) {
    this._setDigit(t, e[i]);
    t--;
  }
  "0" === e && this._switchMode(b.DISPLAY);
};
n.prototype._getValue = function () {
  for (var e = "", t = w - 1; t >= 0; t--) {
    e += this.digits[t];
  }
  return parseInt(e, 10);
};
n.prototype._enableKey = function (e, t) {
  t ? this.keyMap[e].enable() : this.keyMap[e].disable();
};
n.prototype._switchMode = function (e) {
  e !== this.mode && (this.mode === b.EDIT && e !== b.EDIT && this._setCursor(-1), this.mode = e, this._enableKey("BS", this.mode === b.INSERT), this._enableKey("0", this.mode !== b.DISPLAY), this._enableKey("000", this.mode !== b.DISPLAY));
};
n.prototype._setCursor = function (e) {
  this.cursor >= 0 && this.digitBoxes[this.cursor].delClassNames("highlight");
  this.cursor = e;
  this.cursor >= 0 && this.digitBoxes[e].addClassNames("highlight");
};
n.prototype._tapOnDisplay = function (e) {
  this.mode !== b.EDIT && this._switchMode(b.EDIT);
  this._setCursor(e);
};
n.prototype._tapOnKey = function (e) {
  switch (e) {
    case "ENTER":
      return this._doEnter();
    case "CLR":
      return this._doClear();
    case "000":
      return this._do000();
    case "BS":
      return this._doBackspace();
    default:
      return this._doDigit(e);
  }
};
n.prototype._doEnter = function () {
  this._switchMode(b.DISPLAY);
  var e = this._getValue();
  return e > this.maxValue ? g.showNotification(d("tablet.common.maxValue", h.intToString(this.maxValue)), this.keyMap.ENTER) : e < this.minValue ? g.showNotification(d("tablet.common.minValue", h.intToString(this.minValue)), this.keyMap.ENTER) : (this.inputBox.setValue(e, !0), void this.hide());
};
n.prototype._doClear = function () {
  this.setValue("0");
};
n.prototype._doBackspace = function () {
  if (this.mode === b.INSERT) {
    var e = Math.floor(this._getValue() / 10);
    this.setValue(e);
  }
};
n.prototype._do000 = function () {
  for (var e = 0; e < 3; e++) {
    this._doDigit("0");
  }
};
n.prototype._doDigit = function (e) {
  switch (this.mode) {
    case b.DISPLAY:
      if ("0" === e && 0 === this._getValue()) {
        return;
      }
      return this.setValue(e), this._switchMode(b.INSERT);
    case b.INSERT:
      if ("" !== this.digits[w - 1]) {
        return;
      }
      return this.setValue(10 * this._getValue() + ~~e);
    case b.EDIT:
      return this._setDigit(this.cursor, e), this._fixZeroes(this.cursor, e), 0 === this.cursor ? this._switchMode(b.INSERT) : this._setCursor(this.cursor - 1);
  }
};
n.prototype._setDigit = function (e, t) {
  this.digitElements[e].setText(t);
  this.digits[e] = t;
  this.separators[e] && this.separators[e].toggleDisplay("" !== t);
};
n.prototype._fixZeroes = function (e, t) {
  if (0 !== e) {
    for (var i = w - 1; i >= e; i--) {
      var n = this.digits[i];
      if ("0" !== n && "" !== n) {
        break;
      }
      "0" === n && this._setDigit(i, "");
    }
    if ("0" !== t) {
      for (i = e - 1; i >= 0 && "" === this.digits[i]; i--) {
        this._setDigit(i, "0");
      }
    }
  }
};
"string" == typeof e ? (e = e.replace(I, "").toString(), e || (e = "0")) : e = e.toFixed();
e.length >= w && (e = e.substr(0, w));
this._setDigit(t, e[i]);
t--;
this.cursor >= 0 && this.digitBoxes[this.cursor].delClassNames("highlight");
this.cursor = e;
this.cursor >= 0 && this.digitBoxes[e].addClassNames("highlight");
this.mode !== b.EDIT && this._switchMode(b.EDIT);
this._setCursor(e);
this.digitElements[e].setText(t);
this.digits[e] = t;
this.separators[e] && this.separators[e].toggleDisplay("" !== t);
d.call(this, "div", {
  className: "Party",
  hidden: !0
});
h(this, {
  isCollapsable: !0
});
this.numParties = 0;
this.hasParty = {};
this.currentPartyType = null;
this.currentParty = null;
this.invitedFrom = {};
this.partyTypesById = {};
this.setupEvents();
c(n, d);
e.exports = n;
n.prototype._reset = function () {
  this.hide();
  this._cleanData(g.PARTY_TYPE_CLASSICAL, !0);
  this._cleanData(g.PARTY_TYPE_ARENA, !0);
};
n.prototype._selectPartyType = function (e) {
  var t = e === g.PARTY_TYPE_ARENA;
  this.toggleClassName("arena", t);
  this.currentPartyType = e;
  this.currentParty = t ? this.arenaParty : this.classicParty;
  this.classicParty.toggleDisplay(!t);
  this.arenaParty.toggleDisplay(t);
};
n.prototype._createContent = function () {
  var e = this;
  this.setStyle("max-height", r.mapHeight + "px");
  this.createChild("div", {
    className: "gripIcon"
  });
  this.scroller = this.appendChild(new b({
    className: "partyScroller"
  }));
  var t = this.switchPartyButton = this.scroller.content.appendChild(new u({
    className: "switchPartyButton",
    hidden: !0
  }));
  t.createChild("div", {
    className: "iconGroup"
  });
  t.createChild("div", {
    className: "separator"
  });
  t.createChild("div", {
    className: "iconArena"
  });
  t.on("tap", function () {
    e._selectPartyType(o(e.currentPartyType));
  });
  var i = this.scroller.content.appendChild(new u({
    className: ["optionsButton", "greenButton"]
  }));
  i.createChild("div", {
    className: "icon"
  });
  i.on("tap", function () {
    var t = e.currentParty;
    window.gui.openContextualMenuAround("partyOptions", i, {
      partyType: e.currentPartyType,
      partyId: e.currentParty.partyId,
      isLoyal: t.isLoyal,
      isRestricted: t.isRestricted,
      isLeader: t.partyLeaderId === window.gui.playerData.id
    });
  });
  this.cogDom = i;
  this.partyBoxes = this.scroller.content.createChild("div", {
    className: "partyBoxes"
  });
  this.classicParty = this.partyBoxes.createChild("div", {
    className: ["partyBox", "classic"],
    name: g.PARTY_TYPE_CLASSICAL
  });
  this.arenaParty = this.partyBoxes.createChild("div", {
    className: ["partyBox", "arena"],
    name: g.PARTY_TYPE_ARENA,
    hidden: !0
  });
  this.setStyles({
    left: r.mapRight - 90 + "px"
  });
  this.show();
  var n = this.scroller.rootElement.offsetTop;
  this.scroller.setStyle("maxHeight", r.mapHeight - n + "px");
  this.scroller.refresh();
};
n.prototype.addMember = function (e, t) {
  var i = this.partyBoxes.getChild(e),
    n = t.id || t.guestId,
    o = i.createChild("div", {
      className: "member",
      name: n
    }),
    a = new _({
      name: "characterDisplay",
      scale: "fitin"
    });
  o.appendChild(a);
  o.on("tap", function () {
    window.gui.openContextualMenuAround("player", o, {
      playerId: t.id || t.guestId,
      playerName: t.name,
      guildId: t.guildInfo.guildId
    });
  });
  var s = o.createChild("div", {
    className: "hpBar",
    name: "hpBar"
  });
  o.hp = s.createChild("div", {
    className: "hp",
    name: "hp"
  });
  o.createChild("div", {
    className: "pendingIcon",
    name: "pendingIcon",
    text: "?"
  });
  o.createChild("div", {
    className: "leaderIcon",
    name: "leaderIcon"
  });
  var r = o.createChild("div", {
    className: "followingBadge"
  });
  r.createChild("div", {
    className: "icon"
  });
  this.updateMember(e, t);
  this.scroller.refresh();
  this.emit("resized");
};
n.prototype.updateMember = function (e, t) {
  var i = this.partyBoxes.getChild(e),
    n = t.id || t.guestId,
    o = i.partyLeaderId === n,
    s = i.getChild(n);
  if (s) {
    s.memberData = t;
    this._updateMemberTooltip(s, o);
    this._updateCogTooltip(this.cogDom);
    for (var r = i.getChildren(), l = r.sort(a), c = 0; c < l.length; c += 1) {
      var d = i.removeChild(l[c]);
      i.appendChild(d);
    }
    var u = s.getChild("characterDisplay"),
      h = t.entityLook || t.guestLook;
    u.setLook(h, {
      riderOnly: !0,
      direction: v.DIRECTION_SOUTH_WEST,
      animation: "AnimArtwork",
      boneType: "timeline/",
      skinType: "timeline/"
    });
    s.hp.setStyle("height", t.lifePoints / t.maxLifePoints * 100 + "%");
    s.toggleClassName("guest", !!t.guestId);
    s.toggleClassName("leader", o);
  }
};
n.prototype.addOrUpdateMember = function (e, t) {
  var i = this._getPartyById(e);
  if (i) {
    var n = i.getChild(t.id);
    n ? (n.memberData = t, this.updateMember(i.type, t)) : this.addMember(i.type, t);
  }
};
n.prototype.getMemberById = function (e, t) {
  var i = this._getPartyById(e);
  if (i) {
    var n = i.getChild(t);
    if (n) {
      return n.memberData;
    }
  }
};
n.prototype._getPartyById = function (e) {
  var t = this.partyTypesById[e];
  return t ? this.partyBoxes.getChild(t) : null;
};
n.prototype._joinParty = function (e, t, i, n, o) {
  this.partyBoxes || this._createContent();
  this.hasParty[e] = !0;
  this.numParties++;
  this.partyTypesById[t] = e;
  var a = this.partyBoxes.getChild(e);
  a.type = e;
  a.partyLeaderId = i;
  a.partyId = t;
  a.isLoyal = !1;
  a.isRestricted = !0;
  for (var s = 0; s < n.length; s += 1) {
    a.getChild(n[s].id) ? this.updateMember(e, n[s]) : this.addMember(e, n[s]);
  }
  for (s = 0; s < o.length; s += 1) {
    a.getChild(o[s].id) ? this.updateMember(e, o[s]) : this.addMember(e, o[s]);
  }
  this._selectPartyType(e);
  this.numParties >= 2 && this.switchPartyButton.show();
  1 === this.numParties && this.show();
  this.emit("resized");
};
n.prototype._cleanData = function (e, t) {
  if (e && this.hasParty[e]) {
    this.hasParty[e] = !1;
    this.numParties--;
    var i = this.partyBoxes.getChild(e);
    i.hide();
    i.clearContent();
    delete i.partyLeaderId;
    for (var n in this.partyTypesById) {
      parseInt(this.partyTypesById[n], 10) === e && delete this.partyTypesById[n];
    }
    this.switchPartyButton.hide();
    this.numParties > 0 ? this._selectPartyType(o(e)) : this.hide();
    e === g.PARTY_TYPE_ARENA && this.removeArenaFightQuestion();
    t || this.emit("resized");
  }
};
n.prototype._removeMember = function (e, t) {
  var i = this._getPartyById(e);
  i && (i.getChild(t).destroy(), this.removeTeleportQuestion(t), this.scroller.refresh(), this.emit("resized"));
};
n.prototype.setupEvents = function () {
  var e = this,
    t = window.gui,
    i = t.playerData.partyData,
    n = window.dofus.connectionManager;
  t.on("disconnect", function () {
    e._reset();
  });
  t.on("PartyJoinMessage", function (t) {
    t.partyType === g.PARTY_TYPE_CLASSICAL && M.trackJoinGroup();
    e._joinParty(t.partyType, t.partyId, t.partyLeaderId, t.members, t.guests);
  });
  i.on("partyLeaderUpdate", function (t, i) {
    var n = e._getPartyById(t);
    if (n) {
      var o = n.getChild(n.partyLeaderId),
        a = n.getChild(i);
      n.partyLeaderId = i;
      e.updateMember(n.type, o.memberData);
      e.updateMember(n.type, a.memberData);
    }
  });
  t.on("PartyNewGuestMessage", function (t) {
    var i = e._getPartyById(t.partyId);
    if (i) {
      var n = t.guest;
      n.hostName = i.getChild(n.hostId).memberData.name;
      e.addMember(i.type, n);
      i.partyId = t.partyId;
    }
  });
  i.on("partyMemberLeaving", function (t, i) {
    e._removeMember(t, i);
  });
  i.on("partyNewMember", function (t, i) {
    e.addOrUpdateMember(t, i);
  });
  i.on("partyUpdateMember", function (t, i) {
    e.addOrUpdateMember(t, i);
  });
  i.on("playerLeavingParty", function (t) {
    e._cleanData(e.partyTypesById[t]);
  });
  t.on("GameRolePlayArenaFightPropositionMessage", function (t) {
    e.showArenaFightQuestion(t.fightId);
  });
  t.on("GameRolePlayArenaFighterStatusMessage", function (t) {
    t.accepted || e.removeArenaFightQuestion(t.fightId);
  });
  i.on("partyInvitationCancelled", function (i, n) {
    if (t.playerData.id !== n) {
      var o = e.invitedFrom[i],
        a = m("ui.party.invitationCancelledForGuest", o);
      t.chat.logMsg(a);
      t.notificationBar.removeNotification("party" + i);
    }
  });
  i.on("partyGuestLeaving", function (n, o, a) {
    var s = i.getGuestName(n, o);
    if (a) {
      if (a !== t.playerData.characterBaseInformations.id) {
        var r = i.getMemberName(a);
        t.chat.logMsg(m("ui.party.invitationCancelled", r, s));
      }
    } else {
      t.chat.logMsg(m("ui.party.invitationRefused", s));
    }
    e._removeMember(n, o);
  });
  t.on("PartyFollowStatusUpdateMessage", function (t) {
    if (t.success) {
      var i = e._getPartyById(t.partyId);
      if (i) {
        var n = i.getChild(e.followedId);
        if (e.followedId && (n ? n.delClassNames("following") : console.error(new Error("Cannot find the previous child " + e.followedId))), e.followedId = t.followedId, e.followedId) {
          var o = i.getChild(e.followedId);
          o ? o.addClassNames("following") : console.error(new Error("Cannot find the new child " + e.followedId));
        }
      }
    }
  });
  t.on("PartyUpdateLightMessage", function (t) {
    var i = e._getPartyById(t.partyId);
    if (i) {
      var n = i.getChild(t.id).getChild("hpBar").getChild("hp");
      n.setStyle("height", t.lifePoints / t.maxLifePoints * 100 + "%");
    }
  });
  n.on("TeleportBuddiesMessage", function () {
    t.openConfirmPopup({
      title: m("ui.common.confirm"),
      message: m("ui.party.teleportMembersProposition"),
      cb: function (e) {
        n.sendMessage("TeleportBuddiesAnswerMessage", {
          accept: e
        });
      }
    });
  });
  n.on("TeleportBuddiesRequestedMessage", function (e) {
    for (var n = i.getMemberName(e.inviterId), o = [], a = 0; a < e.invalidBuddiesIds.length; a++) {
      o.push(i.getMemberName(e.invalidBuddiesIds[a]));
    }
    var s = m("ui.party.teleportWish", n, e._dungeonName);
    o.length && (s += " " + f(m("ui.party.teleportCriterionFallenAngels"), o.length, o.join(", ")));
    t.chat.logMsg(s, y.CHANNEL_PARTY);
  });
  n.on("TeleportToBuddyOfferMessage", function (t) {
    e.showTeleportQuestion(t.buddyId, t.dungeonId, t._dungeonName, 1e3 * t.timeLeft);
  });
  n.on("TeleportToBuddyCloseMessage", function (t) {
    e.removeTeleportQuestion(t.buddyId);
  });
  n.on("PartyRestrictedMessage", function (t) {
    var i = e._getPartyById(t.partyId);
    i && (i.isRestricted = t.restricted);
  });
  n.on("PartyLoyaltyStatusMessage", function (t) {
    var i = e._getPartyById(t.partyId);
    i && (i.isLoyal = t.loyal);
  });
};
n.prototype.showTeleportQuestion = function (e, t, i, n) {
  function o(i) {
    var n = 1 === i;
    n && w.isDialogActive() && w.closeAll();
    window.isoEngine.cancelMoveAndDo(function () {
      window.dofus.connectionManager.sendMessage("TeleportToBuddyAnswerMessage", {
        dungeonId: t,
        buddyId: e,
        accept: n
      });
    });
  }
  var a = window.gui.playerData.partyData.getMemberName(e),
    s = window.gui.notificationBar,
    r = {
      type: s.notificationType.PRIORITY_INVITATION,
      title: m("ui.common.invitation"),
      text: m("ui.party.teleportProposition", a, i),
      timer: n,
      buttons: [{
        label: m("ui.common.refuse"),
        action: o
      }, {
        label: m("ui.common.accept"),
        action: o
      }],
      onClose: o
    };
  s.newNotification("teleport" + e, r);
};
n.prototype.removeTeleportQuestion = function (e) {
  window.gui.notificationBar.removeNotification("teleport" + e);
};
n.prototype.showArenaFightQuestion = function (e) {
  function t(t) {
    var i = 1 === t;
    window.dofus.connectionManager.sendMessage("GameRolePlayArenaFightAnswerMessage", {
      fightId: e,
      accept: i
    });
  }
  this.arenaFightId = e;
  var i = "arena" + e,
    n = window.gui.notificationBar,
    o = {
      type: n.notificationType.PRIORITY_INVITATION,
      title: m("ui.common.koliseum"),
      text: m("ui.party.fightFound"),
      buttons: [{
        label: m("ui.common.refuse"),
        action: t
      }, {
        label: m("ui.common.accept"),
        action: t
      }],
      onClose: t
    };
  n.newNotification(i, o);
};
n.prototype.removeArenaFightQuestion = function (e) {
  e && e !== this.arenaFightId && console.error("removeArenaFightQuestion: bad fightId?");
  this.arenaFightId && (window.gui.notificationBar.removeNotification("arena" + this.arenaFightId), this.arenaFightId = null);
};
n.prototype.showPartyInvitationQuestion = function (e, t, i) {
  function n() {
    return w.getWindow("partyInviteDetails").showPartyDetails(t), "HIDE_DIALOG";
  }
  function o(e) {
    var i = e === -1 ? "PartyRefuseInvitationMessage" : "PartyAcceptInvitationMessage";
    window.dofus.connectionManager.sendMessage(i, {
      partyId: t
    });
  }
  this.invitedFrom[t] = i;
  var a,
    s = "party" + t;
  if (e === g.PARTY_TYPE_CLASSICAL) {
    a = m("ui.party.playerInvitation", i);
  } else {
    if (e !== g.PARTY_TYPE_ARENA) {
      return console.error("Unknown party type " + e);
    }
    a = m("ui.party.playerInvitationArena", i);
  }
  var r = window.gui.notificationBar,
    l = {
      type: r.notificationType.INVITATION,
      title: m("ui.common.invitation"),
      text: a,
      buttons: [{
        label: m("ui.common.details"),
        action: n
      }, {
        label: m("ui.common.accept"),
        action: o
      }],
      onClose: o
    };
  r.newNotification(s, l);
};
n.prototype.showPartyFightQuestion = function (e, t, i, n, o) {
  function a() {
    window.gui.playerData.isSpectator && window.dofus.connectionManager.sendMessage("GameContextQuitMessage");
    window.dofus.connectionManager.sendMessage("GameFightJoinRequestMessage", {
      fightId: e,
      fighterId: t
    });
  }
  var s = window.gui.notificationBar,
    r = {
      type: s.notificationType.PRIORITY_INVITATION,
      title: m("ui.party.teamFightTitle"),
      wuidom: l.process(m("ui.party.joinTeamFightQuestion", n, i)),
      timer: o,
      buttons: [{
        label: m("ui.common.join"),
        action: a
      }]
    };
  s.newNotification("partyFight" + e, r);
};
n.prototype.removePartyFightQuestion = function (e) {
  window.gui.notificationBar.removeNotification("partyFight" + e);
};
n.prototype._updateCogTooltip = function (e) {
  var t = this;
  s(e, function () {
    var i = e.getChild("tooltip");
    i || (i = new d("div", {
      className: "partyTooltip",
      name: "tooltip"
    }), i.createChild("div", {
      className: "stat",
      name: "infosParty"
    }));
    for (var n = 0, o = 0, a = 0, s = 0, r = t.partyBoxes.getChild(t.currentPartyType), l = 0; l < r.getChildCount(); l++) {
      var c = r.getChildren()[l].memberData;
      "?" !== c.level && (n += c.level, o += c.prospecting, a += c.initiative, s++);
    }
    return a /= s, i.getChild("infosParty").setText(m("ui.party.partyInformation", n, o, ~~a)), i;
  });
};
n.prototype._updateMemberTooltip = function (e, t) {
  s(e, function () {
    var i,
      n,
      o = e.memberData,
      a = e.getChild("tooltip");
    a || (a = new d("div", {
      className: "memberTooltip",
      name: "tooltip"
    }), a.createChild("div", {
      className: "stat",
      name: "leaderTitle",
      text: m("ui.party.leader")
    }), a.createChild("div", {
      className: "stat",
      name: "memberName"
    }), i = a.createChild("div", {
      className: "memberTips",
      name: "memberTips"
    }), n = a.createChild("div", {
      className: "guestTips",
      name: "guestTips"
    }), i.createChild("div", {
      className: "stat",
      name: "level"
    }), i.createChild("div", {
      className: "stat",
      name: "hp"
    }), i.createChild("div", {
      className: "stat",
      name: "prospecting"
    }), i.createChild("div", {
      className: "stat",
      name: "initiative"
    }), n.createChild("div", {
      className: "stat",
      name: "invitedBy"
    }));
    a.getChild("memberName").setText(o.name);
    var s = Boolean(o.guestId);
    i = a.getChild("memberTips");
    n = a.getChild("guestTips");
    i.toggleDisplay(!s);
    n.toggleDisplay(s);
    var r = m("ui.common.colon");
    if (s) {
      a.getChild("leaderTitle").hide();
      n.getChild("invitedBy").setText(m("ui.party.invitedBy") + r + "\n" + o.hostName);
    } else {
      var l = o.lifePoints + " / " + o.maxLifePoints;
      a.getChild("leaderTitle").toggleDisplay(t);
      i.getChild("level").setText(m("ui.common.level") + r + o.level);
      i.getChild("hp").setText(m("ui.short.lifePoints") + r + l);
      i.getChild("prospecting").setText(m("ui.stats.prospecting") + r + o.prospecting);
      i.getChild("initiative").setText(m("ui.stats.initiative") + r + o.initiative);
    }
    return a;
  });
};
this.hide();
this._cleanData(g.PARTY_TYPE_CLASSICAL, !0);
this._cleanData(g.PARTY_TYPE_ARENA, !0);
this.toggleClassName("arena", t);
this.currentPartyType = e;
this.currentParty = t ? this.arenaParty : this.classicParty;
this.classicParty.toggleDisplay(!t);
this.arenaParty.toggleDisplay(t);
this.setStyle("max-height", r.mapHeight + "px");
this.createChild("div", {
  className: "gripIcon"
});
this.scroller = this.appendChild(new b({
  className: "partyScroller"
}));
t.createChild("div", {
  className: "iconGroup"
});
t.createChild("div", {
  className: "separator"
});
t.createChild("div", {
  className: "iconArena"
});
t.on("tap", function () {
  e._selectPartyType(o(e.currentPartyType));
});
i.createChild("div", {
  className: "icon"
});
i.on("tap", function () {
  var t = e.currentParty;
  window.gui.openContextualMenuAround("partyOptions", i, {
    partyType: e.currentPartyType,
    partyId: e.currentParty.partyId,
    isLoyal: t.isLoyal,
    isRestricted: t.isRestricted,
    isLeader: t.partyLeaderId === window.gui.playerData.id
  });
});
this.cogDom = i;
this.partyBoxes = this.scroller.content.createChild("div", {
  className: "partyBoxes"
});
this.classicParty = this.partyBoxes.createChild("div", {
  className: ["partyBox", "classic"],
  name: g.PARTY_TYPE_CLASSICAL
});
this.arenaParty = this.partyBoxes.createChild("div", {
  className: ["partyBox", "arena"],
  name: g.PARTY_TYPE_ARENA,
  hidden: !0
});
this.setStyles({
  left: r.mapRight - 90 + "px"
});
this.show();
this.scroller.setStyle("maxHeight", r.mapHeight - n + "px");
this.scroller.refresh();
o.appendChild(a);
o.on("tap", function () {
  window.gui.openContextualMenuAround("player", o, {
    playerId: t.id || t.guestId,
    playerName: t.name,
    guildId: t.guildInfo.guildId
  });
});
o.hp = s.createChild("div", {
  className: "hp",
  name: "hp"
});
o.createChild("div", {
  className: "pendingIcon",
  name: "pendingIcon",
  text: "?"
});
o.createChild("div", {
  className: "leaderIcon",
  name: "leaderIcon"
});
r.createChild("div", {
  className: "icon"
});
this.updateMember(e, t);
this.scroller.refresh();
this.emit("resized");
s.memberData = t;
this._updateMemberTooltip(s, o);
this._updateCogTooltip(this.cogDom);
u.setLook(h, {
  riderOnly: !0,
  direction: v.DIRECTION_SOUTH_WEST,
  animation: "AnimArtwork",
  boneType: "timeline/",
  skinType: "timeline/"
});
s.hp.setStyle("height", t.lifePoints / t.maxLifePoints * 100 + "%");
s.toggleClassName("guest", !!t.guestId);
s.toggleClassName("leader", o);
this.partyBoxes || this._createContent();
this.hasParty[e] = !0;
this.numParties++;
this.partyTypesById[t] = e;
a.type = e;
a.partyLeaderId = i;
a.partyId = t;
a.isLoyal = !1;
a.isRestricted = !0;
this._selectPartyType(e);
this.numParties >= 2 && this.switchPartyButton.show();
1 === this.numParties && this.show();
this.emit("resized");
this.hasParty[e] = !1;
this.numParties--;
i.hide();
i.clearContent();
delete i.partyLeaderId;
this.switchPartyButton.hide();
this.numParties > 0 ? this._selectPartyType(o(e)) : this.hide();
e === g.PARTY_TYPE_ARENA && this.removeArenaFightQuestion();
t || this.emit("resized");
t.on("disconnect", function () {
  e._reset();
});
t.on("PartyJoinMessage", function (t) {
  t.partyType === g.PARTY_TYPE_CLASSICAL && M.trackJoinGroup();
  e._joinParty(t.partyType, t.partyId, t.partyLeaderId, t.members, t.guests);
});
i.on("partyLeaderUpdate", function (t, i) {
  var n = e._getPartyById(t);
  if (n) {
    var o = n.getChild(n.partyLeaderId),
      a = n.getChild(i);
    n.partyLeaderId = i;
    e.updateMember(n.type, o.memberData);
    e.updateMember(n.type, a.memberData);
  }
});
t.on("PartyNewGuestMessage", function (t) {
  var i = e._getPartyById(t.partyId);
  if (i) {
    var n = t.guest;
    n.hostName = i.getChild(n.hostId).memberData.name;
    e.addMember(i.type, n);
    i.partyId = t.partyId;
  }
});
i.on("partyMemberLeaving", function (t, i) {
  e._removeMember(t, i);
});
i.on("partyNewMember", function (t, i) {
  e.addOrUpdateMember(t, i);
});
i.on("partyUpdateMember", function (t, i) {
  e.addOrUpdateMember(t, i);
});
i.on("playerLeavingParty", function (t) {
  e._cleanData(e.partyTypesById[t]);
});
t.on("GameRolePlayArenaFightPropositionMessage", function (t) {
  e.showArenaFightQuestion(t.fightId);
});
t.on("GameRolePlayArenaFighterStatusMessage", function (t) {
  t.accepted || e.removeArenaFightQuestion(t.fightId);
});
i.on("partyInvitationCancelled", function (i, n) {
  if (t.playerData.id !== n) {
    var o = e.invitedFrom[i],
      a = m("ui.party.invitationCancelledForGuest", o);
    t.chat.logMsg(a);
    t.notificationBar.removeNotification("party" + i);
  }
});
i.on("partyGuestLeaving", function (n, o, a) {
  var s = i.getGuestName(n, o);
  if (a) {
    if (a !== t.playerData.characterBaseInformations.id) {
      var r = i.getMemberName(a);
      t.chat.logMsg(m("ui.party.invitationCancelled", r, s));
    }
  } else {
    t.chat.logMsg(m("ui.party.invitationRefused", s));
  }
  e._removeMember(n, o);
});
t.on("PartyFollowStatusUpdateMessage", function (t) {
  if (t.success) {
    var i = e._getPartyById(t.partyId);
    if (i) {
      var n = i.getChild(e.followedId);
      if (e.followedId && (n ? n.delClassNames("following") : console.error(new Error("Cannot find the previous child " + e.followedId))), e.followedId = t.followedId, e.followedId) {
        var o = i.getChild(e.followedId);
        o ? o.addClassNames("following") : console.error(new Error("Cannot find the new child " + e.followedId));
      }
    }
  }
});
t.on("PartyUpdateLightMessage", function (t) {
  var i = e._getPartyById(t.partyId);
  if (i) {
    var n = i.getChild(t.id).getChild("hpBar").getChild("hp");
    n.setStyle("height", t.lifePoints / t.maxLifePoints * 100 + "%");
  }
});
n.on("TeleportBuddiesMessage", function () {
  t.openConfirmPopup({
    title: m("ui.common.confirm"),
    message: m("ui.party.teleportMembersProposition"),
    cb: function (e) {
      n.sendMessage("TeleportBuddiesAnswerMessage", {
        accept: e
      });
    }
  });
});
n.on("TeleportBuddiesRequestedMessage", function (e) {
  for (var n = i.getMemberName(e.inviterId), o = [], a = 0; a < e.invalidBuddiesIds.length; a++) {
    o.push(i.getMemberName(e.invalidBuddiesIds[a]));
  }
  var s = m("ui.party.teleportWish", n, e._dungeonName);
  o.length && (s += " " + f(m("ui.party.teleportCriterionFallenAngels"), o.length, o.join(", ")));
  t.chat.logMsg(s, y.CHANNEL_PARTY);
});
n.on("TeleportToBuddyOfferMessage", function (t) {
  e.showTeleportQuestion(t.buddyId, t.dungeonId, t._dungeonName, 1e3 * t.timeLeft);
});
n.on("TeleportToBuddyCloseMessage", function (t) {
  e.removeTeleportQuestion(t.buddyId);
});
n.on("PartyRestrictedMessage", function (t) {
  var i = e._getPartyById(t.partyId);
  i && (i.isRestricted = t.restricted);
});
n.on("PartyLoyaltyStatusMessage", function (t) {
  var i = e._getPartyById(t.partyId);
  i && (i.isLoyal = t.loyal);
});
t.partyType === g.PARTY_TYPE_CLASSICAL && M.trackJoinGroup();
e._joinParty(t.partyType, t.partyId, t.partyLeaderId, t.members, t.guests);
n.partyLeaderId = i;
e.updateMember(n.type, o.memberData);
e.updateMember(n.type, a.memberData);
n.hostName = i.getChild(n.hostId).memberData.name;
e.addMember(i.type, n);
i.partyId = t.partyId;
t.chat.logMsg(a);
t.notificationBar.removeNotification("party" + i);
o.length && (s += " " + f(m("ui.party.teleportCriterionFallenAngels"), o.length, o.join(", ")));
t.chat.logMsg(s, y.CHANNEL_PARTY);
n && w.isDialogActive() && w.closeAll();
window.isoEngine.cancelMoveAndDo(function () {
  window.dofus.connectionManager.sendMessage("TeleportToBuddyAnswerMessage", {
    dungeonId: t,
    buddyId: e,
    accept: n
  });
});
e && e !== this.arenaFightId && console.error("removeArenaFightQuestion: bad fightId?");
this.arenaFightId && (window.gui.notificationBar.removeNotification("arena" + this.arenaFightId), this.arenaFightId = null);
window.gui.playerData.isSpectator && window.dofus.connectionManager.sendMessage("GameContextQuitMessage");
window.dofus.connectionManager.sendMessage("GameFightJoinRequestMessage", {
  fightId: e,
  fighterId: t
});
a || (a = new d("div", {
  className: "memberTooltip",
  name: "tooltip"
}), a.createChild("div", {
  className: "stat",
  name: "leaderTitle",
  text: m("ui.party.leader")
}), a.createChild("div", {
  className: "stat",
  name: "memberName"
}), i = a.createChild("div", {
  className: "memberTips",
  name: "memberTips"
}), n = a.createChild("div", {
  className: "guestTips",
  name: "guestTips"
}), i.createChild("div", {
  className: "stat",
  name: "level"
}), i.createChild("div", {
  className: "stat",
  name: "hp"
}), i.createChild("div", {
  className: "stat",
  name: "prospecting"
}), i.createChild("div", {
  className: "stat",
  name: "initiative"
}), n.createChild("div", {
  className: "stat",
  name: "invitedBy"
}));
a.getChild("memberName").setText(o.name);
i = a.getChild("memberTips");
n = a.getChild("guestTips");
i.toggleDisplay(!s);
n.toggleDisplay(s);
a.getChild("leaderTitle").hide();
n.getChild("invitedBy").setText(m("ui.party.invitedBy") + r + "\n" + o.hostName);
a.getChild("leaderTitle").toggleDisplay(t);
i.getChild("level").setText(m("ui.common.level") + r + o.level);
i.getChild("hp").setText(m("ui.short.lifePoints") + r + l);
i.getChild("prospecting").setText(m("ui.stats.prospecting") + r + o.prospecting);
i.getChild("initiative").setText(m("ui.stats.initiative") + r + o.initiative);
F = e._applicationName;
t.identification = {
  accountCreation: e.accountCreation,
  accountId: e.accountId,
  communityId: e.communityId,
  hasRights: e.hasRights,
  hasConsoleRight: e.hasConsoleRight,
  accountSessionUid: e.login,
  login: t.loginName,
  uniqueNickname: e.uniqueNickname,
  secretQuestion: e.secretQuestion,
  wasAlreadyConnected: e.wasAlreadyConnected
};
l.setItem("UNIQUE_NICKNAME", e.uniqueNickname.toString());
s.setAccountInfo(e._groupFlags, e.accountId);
t._setApplicationUsername(F);
this._pushToken = "";
this.loginName = null;
this.identification = {};
this.subscriptionLevels = [];
this.characterBaseInformations = {};
this.characterBreed = null;
this.accountCapabilities = {};
this.achievements = {};
this.lifePoints = 0;
this.maxLifePoints = 0;
this.movementPoints = 0;
this.actionPoints = 0;
this.isFightLeader = !1;
this.isFighting = !1;
this.isSpectator = !1;
this.state = d.STATUS_ALIVE_AND_KICKING;
this.experienceFactor = 0;
this.forcedAccount = null;
this.shieldTutorialQuestId = 1620;
this.shieldTutorialQuestObjective = 9560;
this.alliance = new y();
this.characters = new b();
this.emoteData = new M();
this.fightRequests = new T();
this.guild = this.guildData = new C();
this.houseData = new I();
this.inventory = new A();
this.belongings = new w(this.inventory);
this.jobs = new S();
this.achievements = new E();
this.position = new N();
this.partyData = new x();
this.quests = new L();
this.socialData = new O();
this.alignment = new R();
this.adminMenu = new D();
this.ToaData = new P();
this.ShopData = new B();
window.dofus.connectionManager.on("IdentificationSuccessMessage", e);
window.dofus.connectionManager.on("IdentificationSuccessWithLoginTokenMessage", e);
c(n, a);
e.exports = n;
n.prototype.initialize = function (e, t, i) {
  o = i;
  this._setApplicationUsername(F);
  this.alliance.initialize(e);
  this.characters.initialize(e);
  this.emoteData.initialize(e);
  this.fightRequests.initialize(e);
  this.guildData.initialize(e);
  this.houseData.initialize(e);
  this.inventory.initialize(e);
  this.jobs.initialize(e);
  this.achievements.initialize(e);
  this.position.initialize(e);
  this.partyData.initialize(e);
  this.quests.initialize();
  this.socialData.initialize(e);
  this.alignment.initialize(e);
  this.adminMenu.initialize({
    lang: window.Config.language
  });
  this.ToaData.initialize(e);
  this.ShopData.initialize(e);
  this._setupListeners(e);
};
n.prototype.connectModules = function (e, t) {
  this._selectCharacter(e);
  this.alliance.connect();
  this.belongings.connect();
  this.characters.connect(e.id);
  this.inventory.connect();
  this.partyData.connect();
  this.quests.connect(t);
  this.socialData.connect();
  this.adminMenu.connect({
    lang: window.Config.language
  });
};
n.prototype.disconnectModules = function () {
  this.characters.disconnect();
  this.emoteData.disconnect();
  this.fightRequests.disconnect();
  this.guildData.disconnect();
  this.inventory.disconnect();
  this.jobs.disconnect();
  this.achievements.disconnect();
  this.position.disconnect();
  this.partyData.disconnect();
  this.quests.disconnect();
  this.socialData.disconnect();
  this.adminMenu.disconnect();
  this.ToaData.disconnect();
  this.experienceFactor = 0;
  this.accountCapabilities = {};
  this.loginName = null;
  this.characterBaseInformations = {};
  this.characterBreed = null;
  this.forcedAccount = null;
  this.state = d.STATUS_ALIVE_AND_KICKING;
  this._removeMount();
};
n.prototype._selectCharacter = function (e) {
  this.id = e.id;
  r.storeMapAndEmit(this, this.characterBaseInformations, e, "characterInfosUpdated");
  this.characterBreed = window.gui.databases.Breeds[e.breed];
  this.emit("setCharacterBreed");
  this.emit("characterSelectedSuccess");
  this.emit("lookUpdate", e.entityLook);
};
n.prototype.getPushToken = function () {
  return this._pushToken;
};
n.prototype.setPushToken = function (e) {
  this._pushToken = e;
};
n.prototype._removeMount = function () {
  delete this.equippedMount;
  this.isRiding = !1;
};
n.prototype._setupListeners = function (e) {
  function t(e) {
    e.informations.contextualId === i.id && (i.characterBaseInformations.entityLook = e.informations.look, i.emit("lookUpdate", e.informations.look));
  }
  var i = this,
    n = window.dofus.connectionManager;
  n.on("AccountCapabilitiesMessage", function (e) {
    i.adminMenu.setAccountCapabilities(e);
    i.accountCapabilities = e;
    i.isSubscriberAtMinLevel(_.NORMAL) && k.trackBonusPack();
    window.dofus.send("pingSession", parseInt((1e9 * Math.random() + 1).toString(), 10));
  });
  e.on("ServerExperienceModificatorMessage", function (e) {
    i.experienceFactor = e.experiencePercent - 100;
  });
  e.on("GameContextRefreshEntityLookMessage", function (e) {
    e.id === i.id && (i.characterBaseInformations.entityLook = e.look, i.emit("lookUpdate", e.look));
  });
  n.on("GameFightRefreshFighterMessage", function (e) {
    t(e);
  });
  n.on("GameRolePlayShowActorMessage", function (e) {
    t(e);
  });
  e.on("mapComplementaryInformationsData", function (t) {
    for (var n = e.playerData.characters.controlledCharacterId, o = 0; o < t.actors.length; o++) {
      var a = t.actors[o];
      if (a.contextualId === n) {
        var s = i.characterBaseInformations.entityLook,
          l = a.look,
          c = r.differenceBetweenTwoArrays(s.skins, l.skins);
        return c = c || r.differenceBetweenTwoArrays(s.indexedColors, l.indexedColors), void (c && (i.characterBaseInformations.entityLook = a.look, i.emit("lookUpdate", a.look)));
      }
    }
  });
  e.on("CharacterLevelUpMessage", function (e) {
    var t = i.characterBaseInformations.level;
    i.characterBaseInformations.level = e.newLevel;
    i.emit("characterLevelUp", {
      newLevel: e.newLevel,
      previousLevel: t
    });
    i.emit("characterInfosUpdated");
    i.evaluateRatingOpening("levelUp");
  });
  n.on("CharactersListMessage", function () {
    i.adminMenu.runStartupCmd({
      isOnCharacterSelection: !0
    });
  });
  n.on("StartupActionsListMessage", function () {
    i.adminMenu.runStartupCmd({
      isOnRP: !0
    });
  });
  n.on("MountUnSetMessage", function () {
    if (i.equippedMount) {
      var e = i.equippedMount.id;
      i._removeMount();
      i.emit("unsetMount", e);
    }
  });
  n.on("MountRidingMessage", function (e) {
    i.isRiding = e.isRiding;
    i.emit("mountRiding", e.isRiding);
  });
  n.on("MountSetMessage", function (e) {
    i.equippedMount && i.equippedMount.level < e.mountData.level && window.gui.chat.logMsg(p("ui.mount.levelUp", [e.mountData.level]));
    i.equippedMount = e.mountData;
    i.equippedMount.mountLocation = "equip";
    i.equippedMount.xpRatio = i.mountXpRatio;
    i.emit("setMount", e);
  });
  n.on("MountXpRatioMessage", function (e) {
    i.equippedMount && (i.equippedMount.xpRatio = i.mountXpRatio = e.ratio, i.emit("setMountRatio", e.ratio));
  });
  e.on("GameRolePlayPlayerLifeStatusMessage", function (e) {
    var t = e.state;
    if (i.state = t, t === d.STATUS_TOMBSTONE) {
      var n = {
        title: p("ui.login.news"),
        message: p("ui.gameuicore.playerDied") + "\n\n" + p("ui.gameuicore.freeSoul"),
        cb: function (e) {
          e && window.dofus.sendMessage("GameRolePlayFreeSoulRequestMessage");
        }
      };
      h.getWindow("confirm").update(n);
      h.openDialog(["confirm"]);
    } else {
      t === d.STATUS_PHANTOM && window.gui.openSimplePopup(p("ui.gameuicore.soulsWorld"), p("ui.login.news"));
    }
  });
  e.on("GameRolePlayGameOverMessage", function () {
    h.openDialog(["hardcoreDeath"]);
  });
  n.on("SubscriptionStatusMessage", function (e) {
    i.subscriptionLevels = [];
    for (var t = 0; t < e.levels.length; t++) {
      var n = e.levels[t];
      i.subscriptionLevels[n.level] = n;
    }
    i.emit("subscriptionChanged");
  });
  window.developmentMode && (n.on("ExchangeStartedBidSellerMessage", function (e) {
    r.checkBidHouseCategoriesAddendumIntegrity(e.sellerDescriptor.types, window.gui.databases.BidHouseCategories);
  }), n.on("ExchangeStartedBidBuyerMessage", function (e) {
    r.checkBidHouseCategoriesAddendumIntegrity(e.buyerDescriptor.types, window.gui.databases.BidHouseCategories);
  }));
};
n.prototype.setForcedAccount = function (e) {
  this.forcedAccount = e;
};
n.prototype.setLoginName = function (e) {
  return e ? void (this.loginName = e) : console.error(new Error("PlayerData.setLoginName: login is emtpy"));
};
n.prototype.isAlive = function () {
  return this.state === d.STATUS_ALIVE_AND_KICKING;
};
n.prototype.isAdmin = function () {
  return this.hasRight(g.RIGHT_IS_ADMIN);
};
n.prototype.isModeratorOrMore = function () {
  return this.accountCapabilities.status >= u.MODERATOR;
};
n.prototype.isCommunityHelper = function () {
  return this.hasRight(g.IS_COMMUNITY_HELPER);
};
n.prototype.isAbleToSeeId = function () {
  return this.hasRight(g.SHOW_ID);
};
n.prototype.hasRight = function (e) {
  return !!this.accountCapabilities._accountRightsMap && Boolean(this.accountCapabilities._accountRightsMap[e]);
};
n.prototype.isModerator = function () {
  return this.accountCapabilities.status >= u.MODERATOR && this.accountCapabilities.status <= u.GAMEMASTER;
};
n.prototype.isSubscriberAtMinLevel = function (e) {
  for (var t = _.ELITE; t >= e; t--) {
    var i = this.subscriptionLevels[t] && this.subscriptionLevels[t].expiration_date > f.now();
    if (i) {
      return !0;
    }
  }
  return !1;
};
n.prototype.getSubscriptionMaxExpiration = function () {
  var e = 0;
  for (var t in this.subscriptionLevels) {
    e = Math.max(e, this.subscriptionLevels[t].expiration_date);
  }
  return e;
};
n.prototype.getSubscriptionRemainingTime = function (e) {
  if (!this.subscriptionLevels[e]) {
    return 0;
  }
  for (var t = f.now(), i = e + 1; i <= _.ELITE; i++) {
    if (this.subscriptionLevels[i]) {
      t = this.subscriptionLevels[i].expiration_date;
      break;
    }
  }
  return Math.max(0, this.subscriptionLevels[e].expiration_date - t);
};
n.prototype.getSubscriptionMaxDays = function () {
  var e = this.getSubscriptionMaxExpiration();
  if (0 === e) {
    return 0;
  }
  var t = e - f.now(),
    i = Math.ceil(t / 1e3 / 60 / 60 / 24);
  return Math.ceil(i);
};
n.prototype.isMutant = function () {
  return "GameRolePlayMutantInformations" === window.isoEngine.actorManager.userActor.data.type;
};
n.prototype.getRestrictions = function () {
  return window.isoEngine.actorManager.userActor.data.humanoidInfo.restrictions;
};
n.prototype.isPvpAggressable = function () {
  return this.alignment.alignmentInfos.aggressable === m.PvP_ENABLED_AGGRESSABLE || this.alignment.alignmentInfos.aggressable === m.PvP_ENABLED_NON_AGGRESSABLE;
};
n.prototype.getLevelDiff = function (e) {
  var t,
    i,
    n = this.characterBaseInformations.level;
  return e < n ? (t = -1, i = n / e) : (t = 1, i = e / n), Math.abs(e - n) > 20 || i >= 1.2 ? t : 0;
};
n.prototype.isIncarnation = function () {
  var e = window.gui.playerData.characterBaseInformations.entityLook;
  if (!e) {
    return !1;
  }
  var t = e.bonesId;
  if (void 0 !== H[t]) {
    return H[t];
  }
  var i = window.gui.databases.Incarnation;
  for (var n in i) {
    var o = i[n],
      a = o.lookMale.slice(1, o.lookMale.indexOf("|")),
      s = o.lookFemale.slice(1, o.lookFemale.indexOf("|"));
    if (t === ~~a || t === ~~s) {
      return H[t] = !0, !0;
    }
  }
  return H[t] = !1, !1;
};
n.prototype.isShopDisabled = function () {
  var e = window.Config || {},
    t = e.disabledFeatures || {};
  if (t.shop) {
    return !0;
  }
  var i = window.parseInt(window.gui.serversData.connectedServerId, 10);
  if (isNaN(i) || !i) {
    return !1;
  }
  i = i.toString();
  var n = t.shopByServerIdList || [];
  return n.indexOf(i) !== -1;
};
n.prototype.isOnShieldTutorial = function () {
  return !!window.gui.playerData.quests.active[this.shieldTutorialQuestId];
};
n.prototype.isShieldTutorialFortified = function () {
  if (!this.isOnShieldTutorial()) {
    return !1;
  }
  for (var e = window.gui.playerData.quests.active[this.shieldTutorialQuestId], t = 0; t < e.objectives.length; t++) {
    if (e.objectives[t].objectiveId === this.shieldTutorialQuestObjective) {
      return !e.objectives[t].objectiveStatus;
    }
  }
};
n.prototype._setApplicationUsername = function (e) {
  if (e) {
    var t = this;
    o && o.isAvailable() && o.setApplicationUsername(e, function (i) {
      if (i) {
        var n = "purchaseWrapper#setApplicationUsername failure: for token " + e + " and accountId ";
        return n += t.identification.accountId + " with the error " + i, void console.error(n);
      }
    });
  }
};
n.prototype.evaluateRatingOpening = function (e, t) {
  var i = this.characterBaseInformations.level;
  if ("levelUp" === e && i % 20 === 0) {
    this._openRatingWindow();
  } else if ("fightEnd" === e && t && t.fighters) {
    for (var n = Object.keys(t.fighters), o = 0; o < n.length; o++) {
      if (t.fighters[n[o]].isBoss && i >= 200) {
        this._openRatingWindow();
        break;
      }
    }
  } else if ("arenaFightWin" === e && t && t.fighters && i >= 200) {
    for (var a = this.id, s = t.fighters, r = 0; r < s.length; r++) {
      if (a === s[r].id) {
        s[r].outcome && this._openRatingWindow();
        break;
      }
    }
  }
};
n.prototype._openRatingWindow = function () {
  if (window && window.cordova && window.LaunchReview) {
    var e = v.getValue("rateDofus", null);
    e ? e.numAsked < 4 && !e.isNeverAsk && h.open("ratingWindow") : this.characterBaseInformations.level >= 40 && h.open("ratingWindow");
  }
};
o = i;
this._setApplicationUsername(F);
this.alliance.initialize(e);
this.characters.initialize(e);
this.emoteData.initialize(e);
this.fightRequests.initialize(e);
this.guildData.initialize(e);
this.houseData.initialize(e);
this.inventory.initialize(e);
this.jobs.initialize(e);
this.achievements.initialize(e);
this.position.initialize(e);
this.partyData.initialize(e);
this.quests.initialize();
this.socialData.initialize(e);
this.alignment.initialize(e);
this.adminMenu.initialize({
  lang: window.Config.language
});
this.ToaData.initialize(e);
this.ShopData.initialize(e);
this._setupListeners(e);
this._selectCharacter(e);
this.alliance.connect();
this.belongings.connect();
this.characters.connect(e.id);
this.inventory.connect();
this.partyData.connect();
this.quests.connect(t);
this.socialData.connect();
this.adminMenu.connect({
  lang: window.Config.language
});
this.characters.disconnect();
this.emoteData.disconnect();
this.fightRequests.disconnect();
this.guildData.disconnect();
this.inventory.disconnect();
this.jobs.disconnect();
this.achievements.disconnect();
this.position.disconnect();
this.partyData.disconnect();
this.quests.disconnect();
this.socialData.disconnect();
this.adminMenu.disconnect();
this.ToaData.disconnect();
this.experienceFactor = 0;
this.accountCapabilities = {};
this.loginName = null;
this.characterBaseInformations = {};
this.characterBreed = null;
this.forcedAccount = null;
this.state = d.STATUS_ALIVE_AND_KICKING;
this._removeMount();
this.id = e.id;
r.storeMapAndEmit(this, this.characterBaseInformations, e, "characterInfosUpdated");
this.characterBreed = window.gui.databases.Breeds[e.breed];
this.emit("setCharacterBreed");
this.emit("characterSelectedSuccess");
this.emit("lookUpdate", e.entityLook);
delete this.equippedMount;
this.isRiding = !1;
n.on("AccountCapabilitiesMessage", function (e) {
  i.adminMenu.setAccountCapabilities(e);
  i.accountCapabilities = e;
  i.isSubscriberAtMinLevel(_.NORMAL) && k.trackBonusPack();
  window.dofus.send("pingSession", parseInt((1e9 * Math.random() + 1).toString(), 10));
});
e.on("ServerExperienceModificatorMessage", function (e) {
  i.experienceFactor = e.experiencePercent - 100;
});
e.on("GameContextRefreshEntityLookMessage", function (e) {
  e.id === i.id && (i.characterBaseInformations.entityLook = e.look, i.emit("lookUpdate", e.look));
});
n.on("GameFightRefreshFighterMessage", function (e) {
  t(e);
});
n.on("GameRolePlayShowActorMessage", function (e) {
  t(e);
});
e.on("mapComplementaryInformationsData", function (t) {
  for (var n = e.playerData.characters.controlledCharacterId, o = 0; o < t.actors.length; o++) {
    var a = t.actors[o];
    if (a.contextualId === n) {
      var s = i.characterBaseInformations.entityLook,
        l = a.look,
        c = r.differenceBetweenTwoArrays(s.skins, l.skins);
      return c = c || r.differenceBetweenTwoArrays(s.indexedColors, l.indexedColors), void (c && (i.characterBaseInformations.entityLook = a.look, i.emit("lookUpdate", a.look)));
    }
  }
});
e.on("CharacterLevelUpMessage", function (e) {
  var t = i.characterBaseInformations.level;
  i.characterBaseInformations.level = e.newLevel;
  i.emit("characterLevelUp", {
    newLevel: e.newLevel,
    previousLevel: t
  });
  i.emit("characterInfosUpdated");
  i.evaluateRatingOpening("levelUp");
});
n.on("CharactersListMessage", function () {
  i.adminMenu.runStartupCmd({
    isOnCharacterSelection: !0
  });
});
n.on("StartupActionsListMessage", function () {
  i.adminMenu.runStartupCmd({
    isOnRP: !0
  });
});
n.on("MountUnSetMessage", function () {
  if (i.equippedMount) {
    var e = i.equippedMount.id;
    i._removeMount();
    i.emit("unsetMount", e);
  }
});
n.on("MountRidingMessage", function (e) {
  i.isRiding = e.isRiding;
  i.emit("mountRiding", e.isRiding);
});
n.on("MountSetMessage", function (e) {
  i.equippedMount && i.equippedMount.level < e.mountData.level && window.gui.chat.logMsg(p("ui.mount.levelUp", [e.mountData.level]));
  i.equippedMount = e.mountData;
  i.equippedMount.mountLocation = "equip";
  i.equippedMount.xpRatio = i.mountXpRatio;
  i.emit("setMount", e);
});
n.on("MountXpRatioMessage", function (e) {
  i.equippedMount && (i.equippedMount.xpRatio = i.mountXpRatio = e.ratio, i.emit("setMountRatio", e.ratio));
});
e.on("GameRolePlayPlayerLifeStatusMessage", function (e) {
  var t = e.state;
  if (i.state = t, t === d.STATUS_TOMBSTONE) {
    var n = {
      title: p("ui.login.news"),
      message: p("ui.gameuicore.playerDied") + "\n\n" + p("ui.gameuicore.freeSoul"),
      cb: function (e) {
        e && window.dofus.sendMessage("GameRolePlayFreeSoulRequestMessage");
      }
    };
    h.getWindow("confirm").update(n);
    h.openDialog(["confirm"]);
  } else {
    t === d.STATUS_PHANTOM && window.gui.openSimplePopup(p("ui.gameuicore.soulsWorld"), p("ui.login.news"));
  }
});
e.on("GameRolePlayGameOverMessage", function () {
  h.openDialog(["hardcoreDeath"]);
});
n.on("SubscriptionStatusMessage", function (e) {
  i.subscriptionLevels = [];
  for (var t = 0; t < e.levels.length; t++) {
    var n = e.levels[t];
    i.subscriptionLevels[n.level] = n;
  }
  i.emit("subscriptionChanged");
});
window.developmentMode && (n.on("ExchangeStartedBidSellerMessage", function (e) {
  r.checkBidHouseCategoriesAddendumIntegrity(e.sellerDescriptor.types, window.gui.databases.BidHouseCategories);
}), n.on("ExchangeStartedBidBuyerMessage", function (e) {
  r.checkBidHouseCategoriesAddendumIntegrity(e.buyerDescriptor.types, window.gui.databases.BidHouseCategories);
}));
i.adminMenu.setAccountCapabilities(e);
i.accountCapabilities = e;
i.isSubscriberAtMinLevel(_.NORMAL) && k.trackBonusPack();
window.dofus.send("pingSession", parseInt((1e9 * Math.random() + 1).toString(), 10));
i.characterBaseInformations.level = e.newLevel;
i.emit("characterLevelUp", {
  newLevel: e.newLevel,
  previousLevel: t
});
i.emit("characterInfosUpdated");
i.evaluateRatingOpening("levelUp");
i._removeMount();
i.emit("unsetMount", e);
i.isRiding = e.isRiding;
i.emit("mountRiding", e.isRiding);
i.equippedMount && i.equippedMount.level < e.mountData.level && window.gui.chat.logMsg(p("ui.mount.levelUp", [e.mountData.level]));
i.equippedMount = e.mountData;
i.equippedMount.mountLocation = "equip";
i.equippedMount.xpRatio = i.mountXpRatio;
i.emit("setMount", e);
h.getWindow("confirm").update(n);
h.openDialog(["confirm"]);
a.call(this);
this.current = null;
r(n, a);
e.exports = n;
n.prototype.connect = function () {
  this.current = null;
};
n.prototype.hasAlliance = function () {
  return null !== this.current;
};
n.prototype.isBoss = function () {
  if (!this.current || !this.current.guilds.length) {
    return !1;
  }
  var e = this.current.guilds[0],
    t = window.gui.playerData.guild;
  return e.guildId === t.current.guildId && t.isBoss();
};
n.prototype.isGuildOnSameAlliance = function (e) {
  if (!this.hasAlliance()) {
    return !1;
  }
  for (var t = 0; t < this.current.guilds.length; t++) {
    if (this.current.guilds[t].guildId === e) {
      return !0;
    }
  }
  return !1;
};
n.prototype.getPrismBonusPercent = function (e) {
  if (!this.hasAlliance()) {
    return 0;
  }
  var t = Object.keys(this.current.prisms);
  return t.indexOf(e.toString()) === -1 ? 0 : d;
};
n.prototype.initialize = function (e) {
  var t = this;
  e.on("AllianceMembershipMessage", function (e) {
    t.current ? t.current.setInfo(e.allianceInfo) : t.current = o.createAlliance(e.allianceInfo);
    t.current.enabled = e.enabled;
  });
  e.on("AllianceJoinedMessage", function (i) {
    t.current = o.createAlliance(i.allianceInfo);
    t.current.enabled = i.enabled;
    e.chat.logMsg(s("ui.alliance.joinAllianceMessage", [i.allianceInfo.allianceName]));
    t.emit("allianceJoined");
  });
  e.on("AllianceGuildLeavingMessage", function (e) {
    for (var i = t.current.guilds, n = 0, o = i.length; n < o; n += 1) {
      if (i[n].guildId === e.guildId) {
        return i.splice(n, 1), void t.emit("guildLeft", e.guildId);
      }
    }
  });
  e.on("AllianceLeftMessage", function () {
    t.current = null;
    t.emit("allianceLeft");
  });
  e.on("AllianceInsiderInfoMessage", function (e) {
    var i = e.allianceInfos;
    i.guilds = e.guilds;
    i.prisms = e.prisms;
    t.current ? t.current.setInfo(i) : t.current = o.createAlliance(i);
    t.emit("allianceUpdated", t.current);
  });
  e.on("AllianceInvitationStateRecruterMessage", function (t) {
    return t.invitationState !== l.SOCIAL_GROUP_INVITATION_SENT ? c.close("cancel") : void e.openCancelPopup({
      title: s("ui.common.invitation"),
      message: s("ui.craft.waitForCraftClient", t.recrutedName),
      cb: function () {
        window.dofus.sendMessage("AllianceInvitationAnswerMessage", {
          accept: !1
        });
      }
    });
  });
  e.on("AllianceInvitationStateRecrutedMessage", function (e) {
    if (e.invitationState === l.SOCIAL_GROUP_INVITATION_CANCELED) {
      return c.close("confirm");
    }
  });
  e.on("AllianceInvitedMessage", function (e) {
    window.gui.openConfirmPopup({
      title: s("ui.common.invitation"),
      message: s("ui.alliance.youAreInvited", e.recruterName, e.allianceInfo.allianceName),
      cb: function (e) {
        window.dofus.sendMessage("GuildInvitationAnswerMessage", {
          accept: e
        });
      }
    });
  });
  e.on("PrismsListUpdateMessage", function (e) {
    if (t.current) {
      for (var i = e.prisms, n = [], o = [], a = t.current.prisms, s = 0, r = i.length; s < r; s += 1) {
        var l = i[s];
        "PrismGeolocalizedInformation" === l._type && "AllianceInsiderPrismInformation" === l.prism._type ? (l.prism.alliance = t.current, a[l.subAreaId] = l, n.push(l)) : a[l.subAreaId] && (delete a[l.subAreaId], o.push(l.subAreaId));
      }
      n.length && t.emit("prismUpdatedList", n);
      o.length && t.emit("prismDeletedList", o);
    }
  });
};
e.on("AllianceMembershipMessage", function (e) {
  t.current ? t.current.setInfo(e.allianceInfo) : t.current = o.createAlliance(e.allianceInfo);
  t.current.enabled = e.enabled;
});
e.on("AllianceJoinedMessage", function (i) {
  t.current = o.createAlliance(i.allianceInfo);
  t.current.enabled = i.enabled;
  e.chat.logMsg(s("ui.alliance.joinAllianceMessage", [i.allianceInfo.allianceName]));
  t.emit("allianceJoined");
});
e.on("AllianceGuildLeavingMessage", function (e) {
  for (var i = t.current.guilds, n = 0, o = i.length; n < o; n += 1) {
    if (i[n].guildId === e.guildId) {
      return i.splice(n, 1), void t.emit("guildLeft", e.guildId);
    }
  }
});
e.on("AllianceLeftMessage", function () {
  t.current = null;
  t.emit("allianceLeft");
});
e.on("AllianceInsiderInfoMessage", function (e) {
  var i = e.allianceInfos;
  i.guilds = e.guilds;
  i.prisms = e.prisms;
  t.current ? t.current.setInfo(i) : t.current = o.createAlliance(i);
  t.emit("allianceUpdated", t.current);
});
e.on("AllianceInvitationStateRecruterMessage", function (t) {
  return t.invitationState !== l.SOCIAL_GROUP_INVITATION_SENT ? c.close("cancel") : void e.openCancelPopup({
    title: s("ui.common.invitation"),
    message: s("ui.craft.waitForCraftClient", t.recrutedName),
    cb: function () {
      window.dofus.sendMessage("AllianceInvitationAnswerMessage", {
        accept: !1
      });
    }
  });
});
e.on("AllianceInvitationStateRecrutedMessage", function (e) {
  if (e.invitationState === l.SOCIAL_GROUP_INVITATION_CANCELED) {
    return c.close("confirm");
  }
});
e.on("AllianceInvitedMessage", function (e) {
  window.gui.openConfirmPopup({
    title: s("ui.common.invitation"),
    message: s("ui.alliance.youAreInvited", e.recruterName, e.allianceInfo.allianceName),
    cb: function (e) {
      window.dofus.sendMessage("GuildInvitationAnswerMessage", {
        accept: e
      });
    }
  });
});
e.on("PrismsListUpdateMessage", function (e) {
  if (t.current) {
    for (var i = e.prisms, n = [], o = [], a = t.current.prisms, s = 0, r = i.length; s < r; s += 1) {
      var l = i[s];
      "PrismGeolocalizedInformation" === l._type && "AllianceInsiderPrismInformation" === l.prism._type ? (l.prism.alliance = t.current, a[l.subAreaId] = l, n.push(l)) : a[l.subAreaId] && (delete a[l.subAreaId], o.push(l.subAreaId));
    }
    n.length && t.emit("prismUpdatedList", n);
    o.length && t.emit("prismDeletedList", o);
  }
});
t.current ? t.current.setInfo(e.allianceInfo) : t.current = o.createAlliance(e.allianceInfo);
t.current.enabled = e.enabled;
t.current = o.createAlliance(i.allianceInfo);
t.current.enabled = i.enabled;
e.chat.logMsg(s("ui.alliance.joinAllianceMessage", [i.allianceInfo.allianceName]));
t.emit("allianceJoined");
t.current = null;
t.emit("allianceLeft");
i.guilds = e.guilds;
i.prisms = e.prisms;
t.current ? t.current.setInfo(i) : t.current = o.createAlliance(i);
t.emit("allianceUpdated", t.current);
n.length && t.emit("prismUpdatedList", n);
o.length && t.emit("prismDeletedList", o);
this._inventory = e;
this._bankCache = new o("bankCache", o.PER_SERVER, !0);
this._mountCache = new o("mountCache", o.PER_CHARACTER);
e.exports = n;
n.prototype.connect = function () {
  var e = window.gui.playerData,
    t = e.identification.accountId,
    i = window.gui.serversData.connectedServerId,
    n = e.id;
  this._bankCache.load(t, i, n);
  this._mountCache.load(t, i, n);
};
n.prototype.getItemCounts = function (e) {
  return [this._inventory.quantityList[e] || 0, this._bankCache.getItemCount(e), this._mountCache.getItemCount(e)];
};
n.prototype.setBankItems = function (e) {
  this._bankCache.setItems(e);
};
n.prototype.updateBankItems = function (e) {
  this._bankCache.updateItems(e);
};
n.prototype.removeBankItems = function (e) {
  this._bankCache.removeItems(e);
};
n.prototype.setMountItems = function (e) {
  this._mountCache.setItems(e);
};
n.prototype.updateMountItems = function (e) {
  this._mountCache.updateItems(e);
};
n.prototype.removeMountItems = function (e) {
  this._mountCache.removeItems(e);
};
this._bankCache.load(t, i, n);
this._mountCache.load(t, i, n);
this._cacheLevel = t;
this._isSingleCopy = !!i;
this._isUnknown = !0;
this._localStore = new o(e);
this._entryName = null;
this._countByGid = {};
this._countByUid = {};
this._gidByUid = {};
e.exports = n;
n.PER_ACCOUNT = 1;
n.PER_SERVER = 2;
n.PER_CHARACTER = 3;
n.prototype.load = function (e, t, i) {
  switch (this._localStore.load(), this._cacheLevel) {
    case n.PER_ACCOUNT:
      this._entryName = "a" + e;
      break;
    case n.PER_SERVER:
      this._entryName = "a" + e + "-s" + t;
      break;
    case n.PER_CHARACTER:
      this._entryName = "a" + e + "-s" + t + "-c" + i;
      break;
    default:
      return console.error("Invalid cache level: " + this._cacheLevel);
  }
  if (this._isSingleCopy) {
    var o = this._localStore.getValue(a);
    this._entryName !== o && (this._erase(o), this._localStore.setValue(a, this._entryName));
  }
  var s = this._localStore.getValue(this._entryName + "-countByGid");
  this._isUnknown = !s;
  this._countByGid = s || {};
  this._countByUid = this._localStore.getValue(this._entryName + "-countByUid") || {};
  this._gidByUid = this._localStore.getValue(this._entryName + "-gidByUid") || {};
};
n.prototype.isUnknown = function () {
  return this._isUnknown;
};
n.prototype._erase = function (e) {
  this._localStore.delValue(e + "-countByGid");
  this._localStore.delValue(e + "-countByUid");
  this._localStore.delValue(e + "-gidByUid");
};
n.prototype._save = function () {
  this._isUnknown || (this._localStore.setValue(this._entryName + "-countByGid", this._countByGid), this._localStore.setValue(this._entryName + "-countByUid", this._countByUid), this._localStore.setValue(this._entryName + "-gidByUid", this._gidByUid), this._localStore.save());
};
n.prototype.setItems = function (e) {
  this._isUnknown = !1;
  this._countByGid = {};
  this._countByUid = {};
  this._gidByUid = {};
  for (var t = 0; t < e.length; t++) {
    var i = e[t],
      n = i.objectGID,
      o = i.objectUID,
      a = i.quantity;
    this._countByGid[n] = (this._countByGid[n] || 0) + a;
    this._countByUid[o] = a;
    this._gidByUid[o] = n;
  }
  this._save();
};
n.prototype.updateItems = function (e) {
  for (var t = 0; t < e.length; t++) {
    var i,
      n = e[t],
      o = n.objectGID,
      a = n.objectUID,
      s = n.quantity,
      r = this._countByUid[a];
    void 0 === r ? (i = s, this._gidByUid[a] = o) : i = s - r;
    this._countByGid[o] = (this._countByGid[o] || 0) + i;
    this._countByUid[a] = s;
  }
  this._save();
};
n.prototype.removeItems = function (e) {
  for (var t = 0; t < e.length; t++) {
    var i = e[t],
      n = this._gidByUid[i];
    n ? (this._countByGid[n] -= this._countByUid[i], 0 === this._countByGid[n] && delete this._countByGid[n], delete this._countByUid[i], delete this._gidByUid[i]) : console.error("Invalid UID: " + i);
  }
  this._save();
};
n.prototype.getItemCount = function (e) {
  return this._isUnknown ? null : this._countByGid[e] || 0;
};
this._isUnknown = !s;
this._countByGid = s || {};
this._countByUid = this._localStore.getValue(this._entryName + "-countByUid") || {};
this._gidByUid = this._localStore.getValue(this._entryName + "-gidByUid") || {};
this._localStore.delValue(e + "-countByGid");
this._localStore.delValue(e + "-countByUid");
this._localStore.delValue(e + "-gidByUid");
this._isUnknown = !1;
this._countByGid = {};
this._countByUid = {};
this._gidByUid = {};
this._countByGid[n] = (this._countByGid[n] || 0) + a;
this._countByUid[o] = a;
this._gidByUid[o] = n;
void 0 === r ? (i = s, this._gidByUid[a] = o) : i = s - r;
this._countByGid[o] = (this._countByGid[o] || 0) + i;
this._countByUid[a] = s;
this._storeName = e;
this._keyName = "localStore-" + e;
this._valueMap = {};
this._needsSave = !1;
e.exports = n;
n.prototype.load = function () {
  this._valueMap = {};
  this._needsSave = !1;
  try {
    var e = o.getItem(this._keyName);
    e && (this._valueMap = JSON.parse(e));
  } catch (t) {
    console.error("Failed to load LocalStore " + this._keyName + ": " + t);
  }
};
n.prototype.save = function () {
  if (this._needsSave) {
    var e,
      t = Date.now();
    try {
      var i = JSON.stringify(this._valueMap);
      e = i.length;
      o.setItem(this._keyName, i);
      this._needsSave = !1;
      console.info("LocalStore saved " + e + " characters to " + this._keyName + " in " + (Date.now() - t) + "ms");
    } catch (n) {
      console.error("Failed to save LocalStore, size " + e + " into " + this._keyName + ": " + n);
    }
    e > 1e5 && console.error("LocalStore size is " + e + " for " + this._keyName);
    var a = Date.now() - t;
    a > 500 && console.error("LocalStore took " + a + "ms to save");
  }
};
n.prototype.getValue = function (e) {
  return this._valueMap[e];
};
n.prototype.setValue = function (e, t) {
  this._valueMap[e] = t;
  this._needsSave = !0;
};
n.prototype.delValue = function (e) {
  delete this._valueMap[e];
  this._needsSave = !0;
};
this._valueMap = {};
this._needsSave = !1;
e = i.length;
o.setItem(this._keyName, i);
this._needsSave = !1;
console.info("LocalStore saved " + e + " characters to " + this._keyName + " in " + (Date.now() - t) + "ms");
this._valueMap[e] = t;
this._needsSave = !0;
delete this._valueMap[e];
this._needsSave = !0;
o.call(this);
this.slaves = {};
this.mainCharacter = new r();
this.controlledCharacterId = 0;
this.mainCharacterId = 0;
a(n, o);
e.exports = n;
n.prototype.connect = function (e) {
  this.controlledCharacterId = e;
  this.mainCharacterId = e;
  this.mainCharacter.connect();
  this.mainCharacter.setCharacterId(e);
};
n.prototype.disconnect = function () {
  this.clearSlaves();
  this.mainCharacter.disconnect();
  this.controlledCharacterId = 0;
  this.mainCharacterId = 0;
  this.stopRegen();
};
n.prototype.clearSlaves = function () {
  for (var e in this.slaves) {
    this.slaves[e].disconnect();
  }
  this.slaves = {};
};
n.prototype._removeSlave = function (e) {
  var t = this.slaves[e];
  return t ? (t.disconnect(), void delete this.slaves[e]) : void console.error(new Error("CharactersData: Cannot remove slave " + e));
};
n.prototype.switchControlledCharacter = function (e) {
  if (e !== this.controlledCharacterId) {
    this.controlledCharacterId = e;
    window.actorManager.switchUserActor(e);
    this.emit("switchControlledCharacter");
    var t = this.getControlledCharacter();
    t.characteristics && this.emitCharacteristicsUpdate(t);
  }
};
n.prototype.canControlCharacterId = function (e) {
  return !(e !== this.mainCharacterId && !this.slaves[e]);
};
n.prototype.getControlledCharacter = function () {
  return this.controlledCharacterId === this.mainCharacterId ? this.mainCharacter : this.slaves[this.controlledCharacterId];
};
n.prototype.isMainCharacterControlled = function () {
  return this.controlledCharacterId === this.mainCharacterId;
};
n.prototype.getCharacterById = function (e) {
  return e === this.mainCharacterId ? this.mainCharacter : this.slaves[e];
};
n.prototype.addSummonedCreature = function (e) {
  var t = e ? this.getCharacterById(e) : this.getControlledCharacter();
  t.currentSummonedCreature += 1;
};
n.prototype.removeSummonedCreature = function (e) {
  var t = e ? this.getCharacterById(e) : this.getControlledCharacter();
  t.currentSummonedCreature > 0 && (t.currentSummonedCreature -= 1);
};
n.prototype.canSummonCreature = function (e) {
  var t = e ? this.getCharacterById(e) : this.getControlledCharacter();
  return t.getMaxSummonedCreature() > t.currentSummonedCreature;
};
n.prototype.addSummonedBomb = function (e) {
  var t = e ? this.getCharacterById(e) : this.getControlledCharacter();
  t.currentSummonedBomb += 1;
};
n.prototype.removeSummonedBomb = function (e) {
  var t = e ? this.getCharacterById(e) : this.getControlledCharacter();
  t.currentSummonedBomb > 0 && (t.currentSummonedBomb -= 1);
};
n.prototype.canSummonBomb = function (e) {
  var t = e ? this.getCharacterById(e) : this.getControlledCharacter();
  return t.characteristics.summonableMaximumBombs.getTotalStat() > t.currentSummonedBomb;
};
n.prototype.getSpellModifications = function (e, t, i) {
  if (!e) {
    return console.warn("getSpellModifications: the character id is missing for spell: " + t), null;
  }
  var n = window.gui.playerData.characters.getCharacterById(e);
  if (!n) {
    return console.warn("getSpellModifications: the character cannot be found for character: " + e + " spell: " + t), null;
  }
  var o = n.characteristics.spellModifications;
  if (!o) {
    return null;
  }
  for (var a = 0; a < o.length; a++) {
    var s = o[a];
    if (s.spellId === t && s.modificationType === i) {
      return s;
    }
  }
  return null;
};
n.prototype.stopRegen = function () {
  window.clearInterval(this.regenTimer);
};
n.prototype.startRegen = function () {
  this.regenTimer = window.setInterval(this._autoRegenerateLife.bind(this), this.regenRate);
};
n.prototype._autoRegenerateLife = function () {
  return this.mainCharacter && this.mainCharacter.characteristics ? void (this.mainCharacter.characteristics.lifePoints >= this.mainCharacter.characteristics.maxLifePoints ? this.stopRegen() : this.setCharacteristic(this.mainCharacter, "lifePoints", this.mainCharacter.characteristics.lifePoints + 1)) : void this.stopRegen();
};
n.prototype.emitCharacteristicsUpdate = function (e) {
  if (!e) {
    return void console.warn("emitCharacteristicsUpdate: the character does not exist");
  }
  for (var t in p) {
    void 0 !== e.characteristics[t] ? this.emit("specificCharacteristicsUpdated", t, e.characteristics[t]) : console.error(new Error("emitCharacteristicsUpdate: No characteristic named: " + t));
  }
  this.emit("characteristicsUpdated", e.characteristics);
};
n.prototype.setCharacteristics = function (e, t) {
  if (!e) {
    return void console.warn("setCharacteristics: the character does not exist");
  }
  e.setCharacteristics(t);
  var i = this.getControlledCharacter() === e;
  i && this.emitCharacteristicsUpdate(e);
};
n.prototype.setCharacteristic = function (e, t, i) {
  if (!e) {
    return void console.warn("setCharacteristic: the character does not exist");
  }
  e.setCharacteristic(t, i);
  var n = this.getControlledCharacter() === e;
  n && p[t] && this.emit("specificCharacteristicsUpdated", t, i);
};
n.prototype.initialize = function (e) {
  function t(e) {
    for (var t = n.mainCharacter.spellData, i = {}, o = window.gui.playerData.characterBreed, a = e.spellPrevisualization ? l.VISIBLE : l.UNAVAILABLE, s = 0; s < o.breedSpellsId.length; s++) {
      i[o.breedSpellsId[s]] = {
        spellStatus: a
      };
    }
    for (s = 0; s < e.spells.length; s++) {
      i[e.spells[s].spellId] = {
        spellStatus: l.USABLE,
        spellLevel: e.spells[s].spellLevel,
        position: e.spells[s].position
      };
    }
    t.resetSpellsStatus();
    t.addSpells(i, function () {
      n.emit("spellList");
    });
  }
  function i(e) {
    var t = n.mainCharacter.characteristics.alignmentInfos;
    t.aggressable = e;
    n.setCharacteristic(n.mainCharacter, "alignmentInfos", t);
  }
  var n = this;
  u.on("CharacterStatsListMessage", function (t) {
    if (n.mainCharacter.characteristics) {
      var i = n.mainCharacter.characteristics.energyPoints,
        o = t.stats.energyPoints;
      i > o && e.playerData.emit("playerIsDead");
    }
    n.setCharacteristics(n.mainCharacter, t.stats);
  });
  u.on("SlaveSwitchContextMessage", function (e) {
    var t = e.summonerId;
    if (t === n.mainCharacterId) {
      var i = e.slaveId,
        o = n.slaves[i];
      o || (o = n.slaves[i] = new r(), o.connect(), o.setCharacterId(i));
      for (var a = {}, s = 0; s < e.slaveSpells.length; s++) {
        a[e.slaveSpells[s].spellId] = {
          spellStatus: l.USABLE,
          spellLevel: e.slaveSpells[s].spellLevel,
          position: e.slaveSpells[s].position
        };
      }
      o.spellData.addSpells(a, function () {
        n.emit("spellList");
      });
      n.setCharacteristics(o, e.slaveStats);
      n.switchControlledCharacter(i);
    }
  });
  e.on("FighterStatsListMessage", function (e) {
    var t = n.getControlledCharacter(),
      i = new h(s, e.stats, !1);
    n.setCharacteristics(t, i);
    c.getWindow("characteristics").updateStats(i);
  });
  e.on("LifePointsRegenBeginMessage", function (e) {
    n.regenRate = 100 * e.regenRate;
    n.stopRegen();
    n.startRegen();
  });
  e.on("LifePointsRegenEndMessage", function (e) {
    n.stopRegen();
    n.setCharacteristic(n.mainCharacter, "lifePoints", e.lifePoints);
    n.setCharacteristic(n.mainCharacter, "maxLifePoints", e.maxLifePoints);
  });
  e.on("SpellListMessage", function (e) {
    var i = window.gui.playerData;
    return i.characterBreed ? void t(e) : i.once("setCharacterBreed", function () {
      t(e);
    });
  });
  e.on("SpellChangeSuccessMessage", function (e) {
    var t = n.mainCharacter.spellData;
    e.spells.forEach(function (e) {
      var i = t.spells[e.spellId],
        o = !i || 1 === i.level && i.level === e.spellLevel;
      t.upgradeSpell(e.spellId, e.spellLevel, l.USABLE, function () {
        o && n.emit("newSpellLearned", e.spellId, e.spellLevel);
        n.emit("spellUpgrade", e.spellId, e.spellLevel);
      });
    });
  });
  e.playerData.inventory.on("weaponChanged", function () {
    n.mainCharacter.spellData.weaponChanged(function () {
      n.emit("weaponChanged");
    });
  });
  e.on("UpdateSelfAgressableStatusMessage", function (e) {
    var t = e.status;
    i(t);
    window.actorManager.updateActorsAggressableStatus([n.mainCharacterId], [t]);
  });
  e.on("UpdateMapPlayersAgressableStatusMessage", function (e) {
    var t = e.playerIds,
      o = t.indexOf(n.mainCharacterId);
    o !== -1 && i(e.enable[o]);
  });
  e.fightManager.on("BuffRemove", function (e) {
    e.actionId === d.ACTION_CONTROL_ENTITY && n._removeSlave(e.targetId);
    var t = n.getControlledCharacter();
    t.characteristics && n.emitCharacteristicsUpdate(t);
  });
};
this.controlledCharacterId = e;
this.mainCharacterId = e;
this.mainCharacter.connect();
this.mainCharacter.setCharacterId(e);
this.clearSlaves();
this.mainCharacter.disconnect();
this.controlledCharacterId = 0;
this.mainCharacterId = 0;
this.stopRegen();
this.controlledCharacterId = e;
window.actorManager.switchUserActor(e);
this.emit("switchControlledCharacter");
t.resetSpellsStatus();
t.addSpells(i, function () {
  n.emit("spellList");
});
t.aggressable = e;
n.setCharacteristic(n.mainCharacter, "alignmentInfos", t);
u.on("CharacterStatsListMessage", function (t) {
  if (n.mainCharacter.characteristics) {
    var i = n.mainCharacter.characteristics.energyPoints,
      o = t.stats.energyPoints;
    i > o && e.playerData.emit("playerIsDead");
  }
  n.setCharacteristics(n.mainCharacter, t.stats);
});
u.on("SlaveSwitchContextMessage", function (e) {
  var t = e.summonerId;
  if (t === n.mainCharacterId) {
    var i = e.slaveId,
      o = n.slaves[i];
    o || (o = n.slaves[i] = new r(), o.connect(), o.setCharacterId(i));
    for (var a = {}, s = 0; s < e.slaveSpells.length; s++) {
      a[e.slaveSpells[s].spellId] = {
        spellStatus: l.USABLE,
        spellLevel: e.slaveSpells[s].spellLevel,
        position: e.slaveSpells[s].position
      };
    }
    o.spellData.addSpells(a, function () {
      n.emit("spellList");
    });
    n.setCharacteristics(o, e.slaveStats);
    n.switchControlledCharacter(i);
  }
});
e.on("FighterStatsListMessage", function (e) {
  var t = n.getControlledCharacter(),
    i = new h(s, e.stats, !1);
  n.setCharacteristics(t, i);
  c.getWindow("characteristics").updateStats(i);
});
e.on("LifePointsRegenBeginMessage", function (e) {
  n.regenRate = 100 * e.regenRate;
  n.stopRegen();
  n.startRegen();
});
e.on("LifePointsRegenEndMessage", function (e) {
  n.stopRegen();
  n.setCharacteristic(n.mainCharacter, "lifePoints", e.lifePoints);
  n.setCharacteristic(n.mainCharacter, "maxLifePoints", e.maxLifePoints);
});
e.on("SpellListMessage", function (e) {
  var i = window.gui.playerData;
  return i.characterBreed ? void t(e) : i.once("setCharacterBreed", function () {
    t(e);
  });
});
e.on("SpellChangeSuccessMessage", function (e) {
  var t = n.mainCharacter.spellData;
  e.spells.forEach(function (e) {
    var i = t.spells[e.spellId],
      o = !i || 1 === i.level && i.level === e.spellLevel;
    t.upgradeSpell(e.spellId, e.spellLevel, l.USABLE, function () {
      o && n.emit("newSpellLearned", e.spellId, e.spellLevel);
      n.emit("spellUpgrade", e.spellId, e.spellLevel);
    });
  });
});
e.playerData.inventory.on("weaponChanged", function () {
  n.mainCharacter.spellData.weaponChanged(function () {
    n.emit("weaponChanged");
  });
});
e.on("UpdateSelfAgressableStatusMessage", function (e) {
  var t = e.status;
  i(t);
  window.actorManager.updateActorsAggressableStatus([n.mainCharacterId], [t]);
});
e.on("UpdateMapPlayersAgressableStatusMessage", function (e) {
  var t = e.playerIds,
    o = t.indexOf(n.mainCharacterId);
  o !== -1 && i(e.enable[o]);
});
e.fightManager.on("BuffRemove", function (e) {
  e.actionId === d.ACTION_CONTROL_ENTITY && n._removeSlave(e.targetId);
  var t = n.getControlledCharacter();
  t.characteristics && n.emitCharacteristicsUpdate(t);
});
o.spellData.addSpells(a, function () {
  n.emit("spellList");
});
n.setCharacteristics(o, e.slaveStats);
n.switchControlledCharacter(i);
n.setCharacteristics(t, i);
c.getWindow("characteristics").updateStats(i);
n.regenRate = 100 * e.regenRate;
n.stopRegen();
n.startRegen();
n.stopRegen();
n.setCharacteristic(n.mainCharacter, "lifePoints", e.lifePoints);
n.setCharacteristic(n.mainCharacter, "maxLifePoints", e.maxLifePoints);
o && n.emit("newSpellLearned", e.spellId, e.spellLevel);
n.emit("spellUpgrade", e.spellId, e.spellLevel);
i(t);
window.actorManager.updateActorsAggressableStatus([n.mainCharacterId], [t]);
o.call(this);
this.list = {};
s(n, o);
e.exports = n;
n.prototype.disconnect = function () {
  this.list = {};
};
n.prototype.initialize = function (e) {
  var t = this;
  e.on("EmoteListMessage", function (e) {
    r.getDataMap("Emoticons", e.emoteIds, function (e, i) {
      if (e) {
        return console.error("could not retrieve emotes data", e);
      }
      for (var n in i) {
        i[n] && (t.list[n] = i[n]);
      }
      t.emit("emoteListUpdated", t.list);
    });
  });
  e.on("EmoteAddMessage", function (e) {
    r.getData("Emoticons", e.emoteId, function (e, i) {
      if (e) {
        return console.error("could not retrieve emotes data", e);
      }
      var n = i.id;
      t.list[n] || (t.list[n] = i, window.gui.chat.logMsg(a("ui.common.emoteAdded", [i.nameId])), t.emit("emoteAdded", i));
    });
  });
  e.on("EmoteRemoveMessage", function (e) {
    var i = t.list[e.emoteId];
    i && (window.gui.chat.logMsg(a("ui.common.emoteRemoved", [i.nameId])), delete t.list[e.emoteId], t.emit("emoteRemoved", e.emoteId));
  });
};
e.on("EmoteListMessage", function (e) {
  r.getDataMap("Emoticons", e.emoteIds, function (e, i) {
    if (e) {
      return console.error("could not retrieve emotes data", e);
    }
    for (var n in i) {
      i[n] && (t.list[n] = i[n]);
    }
    t.emit("emoteListUpdated", t.list);
  });
});
e.on("EmoteAddMessage", function (e) {
  r.getData("Emoticons", e.emoteId, function (e, i) {
    if (e) {
      return console.error("could not retrieve emotes data", e);
    }
    var n = i.id;
    t.list[n] || (t.list[n] = i, window.gui.chat.logMsg(a("ui.common.emoteAdded", [i.nameId])), t.emit("emoteAdded", i));
  });
});
e.on("EmoteRemoveMessage", function (e) {
  var i = t.list[e.emoteId];
  i && (window.gui.chat.logMsg(a("ui.common.emoteRemoved", [i.nameId])), delete t.list[e.emoteId], t.emit("emoteRemoved", e.emoteId));
});
e.exports = n;
n.prototype.disconnect = function () {
  this._targetInfo = {};
};
n.prototype.initialize = function (e) {
  function t(e) {
    var t = a.setupNames(i._targetInfo.targetId, e.sourceId);
    t && (a.setupCancelPopupTexts({
      title: o("ui.fight.challenge"),
      message: o("ui.fight.youChallenge", t.targetName)
    }), a.setupConfirmPopupTexts({
      title: o("ui.fight.challenge"),
      message: o("ui.fight.aChallengeYou", t.sourceName)
    }), a.askingChallengePopup(e.fightId));
  }
  var i = this;
  e.on("GameRolePlayPlayerFightFriendlyRequestedMessage", t);
  e.on("GameRolePlayPlayerFightFriendlyAnsweredMessage", function (e) {
    a.closingChallengePopup(e.sourceId === window.gui.playerData.id);
  });
  e.on("ChallengeFightJoinRefusedMessage", function (e) {
    i.alertChallengeRefused(e.reason);
  });
  e.on("GameRolePlayAggressionMessage", function (e) {
    i.alertAggression(e);
  });
};
n.prototype.requestChallenge = function (e) {
  this._targetInfo = e;
  this.sendRequest(e, !1, !0, !1);
};
n.prototype.requestAssault = function (e, t) {
  this._targetInfo = e;
  this.sendRequest(e, t, !1, !0);
};
n.prototype.sendRequest = function (e, t, i, n) {
  var o = e.targetId,
    a = e.targetCellId;
  if (n) {
    var s = window.isoEngine.actorManager,
      l = s.getActor(o).data;
    if ("GameRolePlayCharacterInformations" === l.type) {
      if (t) {
        return this.confirmAttackTarget(e, !0, null);
      }
      var c = "GameRolePlayMutantInformations" === s.userActor.data.type;
      if (l.alignmentInfos.alignmentSide === r.ALIGNMENT_NEUTRAL && !c) {
        return this.confirmAttackTarget(e, !1, 2);
      }
      var d = l.alignmentInfos.characterPower - o,
        u = window.gui.playerData.getLevelDiff(d);
      if (u) {
        return this.confirmAttackTarget(e, !1, u);
      }
    }
  }
  window.dofus.sendMessage("GameRolePlayPlayerFightRequestMessage", {
    targetId: o,
    targetCellId: a,
    friendly: i
  });
};
n.prototype.confirmAttackTarget = function (e, t, i) {
  var n,
    a = e.targetName;
  t || 0 === i ? n = o("ui.pvp.doUAttack", a) : 2 === i ? n = o("ui.pvp.doUAttackNeutral") : i === -1 ? n = o("ui.pvp.doUAttackNoGain", a) : 1 === i && (n = o("ui.pvp.doUAttackBonusGain", a));
  var s = this;
  window.gui.openConfirmPopup({
    title: o("ui.popup.warning"),
    message: n,
    cb: function (i) {
      1 === i && s.sendRequest(e, t, !1, !1);
    }
  });
};
n.prototype.alertAggression = function (e) {
  var t = window.isoEngine.actorManager,
    i = t.getActor(e.attackerId),
    n = t.getActor(e.defenderId);
  if (!i || !n) {
    return console.error("Could not find aggressed actors.");
  }
  var a = o("ui.pvp.aAttackB", i.data.name, n.data.name);
  window.gui.chat.logMsg(a);
};
n.prototype.alertChallengeRefused = function (e) {
  var t;
  switch (e) {
    case s.CHALLENGE_FULL:
      t = o("ui.fight.challengeFull");
      break;
    case s.TEAM_FULL:
      t = o("ui.fight.teamFull");
      break;
    case s.WRONG_ALIGNMENT:
      t = o("ui.wrongAlignment");
      break;
    case s.WRONG_GUILD:
      t = o("ui.fight.wrongGuild");
      break;
    case s.TOO_LATE:
      t = o("ui.fight.tooLate");
      break;
    case s.MUTANT_REFUSED:
      t = o("ui.fight.mutantRefused");
      break;
    case s.WRONG_MAP:
      t = o("ui.fight.wrongMap");
      break;
    case s.JUST_RESPAWNED:
      t = o("ui.fight.justRespawned");
      break;
    case s.IM_OCCUPIED:
      t = o("ui.fight.imOccupied");
      break;
    case s.OPPONENT_OCCUPIED:
      t = o("ui.fight.opponentOccupied");
      break;
    case s.MULTIACCOUNT_NOT_ALLOWED:
      t = o("ui.fight.onlyOneAllowedAccount");
      break;
    case s.INSUFFICIENT_RIGHTS:
      t = o("ui.fight.insufficientRights");
      break;
    case s.MEMBER_ACCOUNT_NEEDED:
      t = o("ui.fight.MemberAccountNeeded");
      break;
    case s.OPPONENT_NOT_MEMBER:
      t = o("ui.fight.opponentNotMember");
      break;
    case s.TEAM_LIMITED_BY_MAINCHARACTER:
      t = o("ui.fight.teamLimitedByMainCharacter");
      break;
    case s.GHOST_REFUSED:
      t = o("ui.fight.ghostRefused");
      break;
    case s.AVA_ZONE:
      t = o("ui.fight.cantAttackAvAZone");
      break;
    default:
      return;
  }
  window.gui.chat.logMsg(t);
};
e.on("GameRolePlayPlayerFightFriendlyRequestedMessage", t);
e.on("GameRolePlayPlayerFightFriendlyAnsweredMessage", function (e) {
  a.closingChallengePopup(e.sourceId === window.gui.playerData.id);
});
e.on("ChallengeFightJoinRefusedMessage", function (e) {
  i.alertChallengeRefused(e.reason);
});
e.on("GameRolePlayAggressionMessage", function (e) {
  i.alertAggression(e);
});
this._targetInfo = e;
this.sendRequest(e, !1, !0, !1);
this._targetInfo = e;
this.sendRequest(e, t, !1, !0);
c.call(this);
this._reset();
h(n, c);
e.exports = n;
n.prototype._reset = function () {
  this.current = null;
  this._requestedSocialInfoMap = {};
  this._awaitedSocialInfoMap = {};
};
n.prototype.initialize = function (e) {
  this._setupListeners(e);
};
n.prototype.disconnect = function () {
  this._reset();
};
n.prototype.hasGuild = function () {
  return null !== this.current;
};
n.prototype.checkRight = function (e, t) {
  return (e & t) > 0;
};
n.prototype.getGuildMemberInfo = function (e) {
  if (this.hasGuild()) {
    return this.current.members[e];
  }
};
n.prototype.hasRight = function (e) {
  return !!this.isBoss() || this.checkRight(e, this.current.memberRights);
};
n.prototype.isBoss = function () {
  return this.current.leaderId === window.gui.playerData.id || this.checkRight(r.GUILD_RIGHT_BOSS, this.current.memberRights);
};
n.prototype.isAMember = function (e) {
  return this.current.members.hasOwnProperty(e);
};
n.prototype.isOnSameGuild = function (e) {
  return !!this.hasGuild() && this.current.guildId === e;
};
n.prototype._initPerceptors = function () {
  return this.current.perceptors = {
    nbcollectorMax: 0,
    informationsOrderList: [],
    perceptorsMap: {}
  }, this.current.perceptors;
};
n.prototype.getPerceptors = function () {
  var e = this.current.perceptors;
  return e || (e = this._initPerceptors()), e;
};
n.prototype.getPerceptor = function (e) {
  var t = this.getPerceptors();
  return t.perceptorsMap[e];
};
n.prototype._setupListeners = function (e) {
  var t = this;
  e.on("GuildMembershipMessage", function (e) {
    t.current && t.current.guildId === e.guildInfo.guildId || (t.current = s.createGuild(e.guildInfo));
    t.current.enabled = e.enabled;
    t.current.memberRights = e.memberRights;
    t.requestSocialInfo(m.SOCIAL_INFO_GUILD_MOTD, !0);
  });
  e.on("GuildJoinedMessage", function (i) {
    t.current = s.createGuild(i.guildInfo);
    t.current.enabled = i.enabled;
    t.current.memberRights = i.memberRights;
    y.trackJoinGuild();
    e.chat.logMsg(d("ui.guild.JoinGuildMessage", [i.guildInfo.guildName]));
    t.emit("guildJoin");
  });
  a.on("GuildInformationsGeneralMessage", function (i) {
    if (e.isConnected) {
      var n = t.current;
      n.level = i.level;
      n.creationDate = i.creationDate;
      n.abandonnedPaddock = i.abandonnedPaddock;
      n.experience = i.experience;
      n.expNextLevelFloor = i.expNextLevelFloor;
      n.experiencePercentage = (i.experience - i.expLevelFloor) / (i.expNextLevelFloor - i.expLevelFloor);
      t.emit("GuildGeneralInformationUpdate");
    }
  });
  e.on("GuildInformationsMembersMessage", function (i) {
    if (e.isConnected) {
      for (var n = t.current, o = 0, a = {}, s = i.members.length, r = 0, l = 0; l < s; l++) {
        var c = i.members[l];
        r += c.level;
        c.rank === w && (n.leaderId = c.id);
        c.connected && (o += 1);
        a[c.id] = c;
      }
      n.members = a;
      n.averageMemberLevel = Math.floor(r / s);
      n.nbMembers = s;
      n.nbConnectedMembers = o;
      t.emit("guildMemberCountUpdate");
      t.emit("guildMember", n.getMembersByRank());
    }
  });
  a.on("GuildInformationsMemberUpdateMessage", function (e) {
    var i = t.current,
      n = e.member;
    i.members[n.id] = n;
    n.rank === w && (i.leaderId = n.id);
    t.emit("guildMember", i.getMembersByRank());
  });
  e.on("GuildMemberLeavingMessage", function (e) {
    var i = t.current,
      n = i.members;
    delete n[e.memberId];
    var o = 0,
      a = 0;
    for (var s in n) {
      var r = n[s];
      r.connected && (o += 1);
      a += 1;
    }
    i.nbMembers = a;
    i.nbConnectedMembers = o;
    t.emit("guildMemberCountUpdate");
    t.emit("guildMember", t.current.getMembersByRank());
  });
  e.on("GuildMemberOnlineStatusMessage", function (e) {
    var i = t.current,
      n = i.members[e.memberId];
    n && (e.online ? (n.connected = 1, n.status.statusId = g.PLAYER_STATUS_AVAILABLE, i.nbConnectedMembers++) : (n.connected = 0, n.status.statusId = g.PLAYER_STATUS_OFFLINE, i.nbConnectedMembers--), t.emit("guildMemberCountUpdate"), t.emit("guildMember", i.getMembersByRank()));
  });
  a.on("PlayerStatusUpdateMessage", function (e) {
    if (t.current) {
      var i = t.current.members[e.playerId];
      i && (i.status = e.status, t.emit("guildMemberStatusUpdate", i));
    }
  });
  e.on("GuildMemberWarnOnConnectionStateMessage", function (e) {
    t.current && (t.current.warnMemberOnConnectionState = e.enable);
  });
  e.on("GuildLeftMessage", function () {
    t.current = null;
    t.emit("guildLeft");
  });
  e.on("GuildInvitationStateRecruterMessage", function (t) {
    return t.invitationState === p.SOCIAL_GROUP_INVITATION_OK && window.dofus.sendMessage("GuildGetInformationsMessage", {
      infoType: l.INFO_MEMBERS
    }), t.invitationState !== p.SOCIAL_GROUP_INVITATION_SENT ? f.close("cancel") : void e.openCancelPopup({
      title: d("ui.common.invitation"),
      message: d("ui.craft.waitForCraftClient", t.recrutedName),
      cb: function () {
        window.dofus.sendMessage("GuildInvitationAnswerMessage", {
          accept: !1
        });
      }
    });
  });
  e.on("GuildInvitationStateRecrutedMessage", function (e) {
    if (e.invitationState === p.SOCIAL_GROUP_INVITATION_CANCELED) {
      return f.close("confirm");
    }
  });
  e.on("GuildInvitedMessage", function (e) {
    window.gui.openConfirmPopup({
      title: d("ui.common.invitation"),
      message: d("ui.social.aInvitYouInGuild", e.recruterName, e.guildInfo.guildName),
      cb: function (e) {
        window.dofus.sendMessage("GuildInvitationAnswerMessage", {
          accept: e
        });
      }
    });
  });
  e.on("GuildInformationsPaddocksMessage", function (e) {
    t.current && (t.current.paddocks = e.paddocksInformations || [], t.emit("guildPaddockUpdate"));
  });
  e.on("GuildPaddockBoughtMessage", function (e) {
    t.current && (t.current.paddocks || (t.current.paddocks = []), t.current.paddocks.push(e.paddockInfo), t.emit("guildPaddockBought", e.paddockInfo));
  });
  e.on("GuildPaddockRemovedMessage", function (e) {
    if (t.current && t.current.paddocks) {
      var i = e.paddockId;
      u.removeObjectInArrayById(t.current.paddocks, "paddockId", i) && t.emit("guildPaddockRemoved", i);
    }
  });
  e.on("GuildHousesInformationMessage", function (e) {
    t.current && (t.current.houses = e.housesInformations || [], t.emit("guildHouseUpdateAll"));
  });
  e.on("GuildHouseUpdateInformationMessage", function (e) {
    t.current && (t.current.houses || (t.current.houses = []), t.current.houses.push(e.housesInformations), t.emit("guildHouseUpdateInfo", e.housesInformations));
  });
  e.on("GuildHouseRemoveMessage", function (e) {
    if (t.current && t.current.houses) {
      var i = e.houseId;
      u.removeObjectInArrayById(t.current.houses, "houseId", i) && t.emit("guildHouseRemoved", i);
    }
  });
  e.on("MoodSmileyUpdateMessage", function (e) {
    var i = t.current && t.current.members[e.playerId];
    i && (i.moodSmileyId = e.smileyId, t.emit("guildMember", t.current.getMembersByRank()));
  });
  e.on("MoodSmileyResultMessage", function (e) {
    if (e.resultCode === _.MOOD_OK) {
      var i = t.current && t.current.members[window.gui.playerData.id];
      i && (i.moodSmileyId = e.smileyId, t.emit("guildMember", t.current.getMembersByRank()));
    }
  });
  a.on("SocialInfoDataMessage", function (e) {
    t._receiveSocialInfo(e.infoTypes, e.contents);
  });
};
n.prototype.requestSocialInfo = function (e, t) {
  this._requestedSocialInfoMap[e] = this._requestedSocialInfoMap[e] || Boolean(t);
  this._socialInfoRequestTimeout || (this._socialInfoRequestTimeout = window.setTimeout(function (e) {
    e._socialInfoRequestTimeout = null;
    var t = [];
    for (var i in e._requestedSocialInfoMap) {
      e._requestedSocialInfoMap.hasOwnProperty(i) && (t.push(i), e._awaitedSocialInfoMap[i] = e._awaitedSocialInfoMap[i] || e._requestedSocialInfoMap[i]);
    }
    e._requestedSocialInfoMap = {};
    window.dofus.sendMessage("SocialInfoRequestMessage", {
      infoTypes: t
    });
  }, 0, this));
};
n.prototype._receiveSocialInfo = function (e, t) {
  for (var i = 0; i < e.length; i++) {
    var n = e[i],
      a = t[i],
      s = this._awaitedSocialInfoMap[n];
    if (delete this._awaitedSocialInfoMap[n], (void 0 === s || s) && n === m.SOCIAL_INFO_GUILD_MOTD && a.value) {
      var r = v.decode(a.value, b);
      r = u.encodeSpecialChars(r);
      var l = d("tablet.social.motd") + d("ui.common.colon") + r;
      window.gui.chat.logMsg(l, o.CHANNEL_GUILD);
    }
    this.emit("socialInfoUpdated", n, a);
  }
};
this.current = null;
this._requestedSocialInfoMap = {};
this._awaitedSocialInfoMap = {};
e.on("GuildMembershipMessage", function (e) {
  t.current && t.current.guildId === e.guildInfo.guildId || (t.current = s.createGuild(e.guildInfo));
  t.current.enabled = e.enabled;
  t.current.memberRights = e.memberRights;
  t.requestSocialInfo(m.SOCIAL_INFO_GUILD_MOTD, !0);
});
e.on("GuildJoinedMessage", function (i) {
  t.current = s.createGuild(i.guildInfo);
  t.current.enabled = i.enabled;
  t.current.memberRights = i.memberRights;
  y.trackJoinGuild();
  e.chat.logMsg(d("ui.guild.JoinGuildMessage", [i.guildInfo.guildName]));
  t.emit("guildJoin");
});
a.on("GuildInformationsGeneralMessage", function (i) {
  if (e.isConnected) {
    var n = t.current;
    n.level = i.level;
    n.creationDate = i.creationDate;
    n.abandonnedPaddock = i.abandonnedPaddock;
    n.experience = i.experience;
    n.expNextLevelFloor = i.expNextLevelFloor;
    n.experiencePercentage = (i.experience - i.expLevelFloor) / (i.expNextLevelFloor - i.expLevelFloor);
    t.emit("GuildGeneralInformationUpdate");
  }
});
e.on("GuildInformationsMembersMessage", function (i) {
  if (e.isConnected) {
    for (var n = t.current, o = 0, a = {}, s = i.members.length, r = 0, l = 0; l < s; l++) {
      var c = i.members[l];
      r += c.level;
      c.rank === w && (n.leaderId = c.id);
      c.connected && (o += 1);
      a[c.id] = c;
    }
    n.members = a;
    n.averageMemberLevel = Math.floor(r / s);
    n.nbMembers = s;
    n.nbConnectedMembers = o;
    t.emit("guildMemberCountUpdate");
    t.emit("guildMember", n.getMembersByRank());
  }
});
a.on("GuildInformationsMemberUpdateMessage", function (e) {
  var i = t.current,
    n = e.member;
  i.members[n.id] = n;
  n.rank === w && (i.leaderId = n.id);
  t.emit("guildMember", i.getMembersByRank());
});
e.on("GuildMemberLeavingMessage", function (e) {
  var i = t.current,
    n = i.members;
  delete n[e.memberId];
  var o = 0,
    a = 0;
  for (var s in n) {
    var r = n[s];
    r.connected && (o += 1);
    a += 1;
  }
  i.nbMembers = a;
  i.nbConnectedMembers = o;
  t.emit("guildMemberCountUpdate");
  t.emit("guildMember", t.current.getMembersByRank());
});
e.on("GuildMemberOnlineStatusMessage", function (e) {
  var i = t.current,
    n = i.members[e.memberId];
  n && (e.online ? (n.connected = 1, n.status.statusId = g.PLAYER_STATUS_AVAILABLE, i.nbConnectedMembers++) : (n.connected = 0, n.status.statusId = g.PLAYER_STATUS_OFFLINE, i.nbConnectedMembers--), t.emit("guildMemberCountUpdate"), t.emit("guildMember", i.getMembersByRank()));
});
a.on("PlayerStatusUpdateMessage", function (e) {
  if (t.current) {
    var i = t.current.members[e.playerId];
    i && (i.status = e.status, t.emit("guildMemberStatusUpdate", i));
  }
});
e.on("GuildMemberWarnOnConnectionStateMessage", function (e) {
  t.current && (t.current.warnMemberOnConnectionState = e.enable);
});
e.on("GuildLeftMessage", function () {
  t.current = null;
  t.emit("guildLeft");
});
e.on("GuildInvitationStateRecruterMessage", function (t) {
  return t.invitationState === p.SOCIAL_GROUP_INVITATION_OK && window.dofus.sendMessage("GuildGetInformationsMessage", {
    infoType: l.INFO_MEMBERS
  }), t.invitationState !== p.SOCIAL_GROUP_INVITATION_SENT ? f.close("cancel") : void e.openCancelPopup({
    title: d("ui.common.invitation"),
    message: d("ui.craft.waitForCraftClient", t.recrutedName),
    cb: function () {
      window.dofus.sendMessage("GuildInvitationAnswerMessage", {
        accept: !1
      });
    }
  });
});
e.on("GuildInvitationStateRecrutedMessage", function (e) {
  if (e.invitationState === p.SOCIAL_GROUP_INVITATION_CANCELED) {
    return f.close("confirm");
  }
});
e.on("GuildInvitedMessage", function (e) {
  window.gui.openConfirmPopup({
    title: d("ui.common.invitation"),
    message: d("ui.social.aInvitYouInGuild", e.recruterName, e.guildInfo.guildName),
    cb: function (e) {
      window.dofus.sendMessage("GuildInvitationAnswerMessage", {
        accept: e
      });
    }
  });
});
e.on("GuildInformationsPaddocksMessage", function (e) {
  t.current && (t.current.paddocks = e.paddocksInformations || [], t.emit("guildPaddockUpdate"));
});
e.on("GuildPaddockBoughtMessage", function (e) {
  t.current && (t.current.paddocks || (t.current.paddocks = []), t.current.paddocks.push(e.paddockInfo), t.emit("guildPaddockBought", e.paddockInfo));
});
e.on("GuildPaddockRemovedMessage", function (e) {
  if (t.current && t.current.paddocks) {
    var i = e.paddockId;
    u.removeObjectInArrayById(t.current.paddocks, "paddockId", i) && t.emit("guildPaddockRemoved", i);
  }
});
e.on("GuildHousesInformationMessage", function (e) {
  t.current && (t.current.houses = e.housesInformations || [], t.emit("guildHouseUpdateAll"));
});
e.on("GuildHouseUpdateInformationMessage", function (e) {
  t.current && (t.current.houses || (t.current.houses = []), t.current.houses.push(e.housesInformations), t.emit("guildHouseUpdateInfo", e.housesInformations));
});
e.on("GuildHouseRemoveMessage", function (e) {
  if (t.current && t.current.houses) {
    var i = e.houseId;
    u.removeObjectInArrayById(t.current.houses, "houseId", i) && t.emit("guildHouseRemoved", i);
  }
});
e.on("MoodSmileyUpdateMessage", function (e) {
  var i = t.current && t.current.members[e.playerId];
  i && (i.moodSmileyId = e.smileyId, t.emit("guildMember", t.current.getMembersByRank()));
});
e.on("MoodSmileyResultMessage", function (e) {
  if (e.resultCode === _.MOOD_OK) {
    var i = t.current && t.current.members[window.gui.playerData.id];
    i && (i.moodSmileyId = e.smileyId, t.emit("guildMember", t.current.getMembersByRank()));
  }
});
a.on("SocialInfoDataMessage", function (e) {
  t._receiveSocialInfo(e.infoTypes, e.contents);
});
t.current && t.current.guildId === e.guildInfo.guildId || (t.current = s.createGuild(e.guildInfo));
t.current.enabled = e.enabled;
t.current.memberRights = e.memberRights;
t.requestSocialInfo(m.SOCIAL_INFO_GUILD_MOTD, !0);
t.current = s.createGuild(i.guildInfo);
t.current.enabled = i.enabled;
t.current.memberRights = i.memberRights;
y.trackJoinGuild();
e.chat.logMsg(d("ui.guild.JoinGuildMessage", [i.guildInfo.guildName]));
t.emit("guildJoin");
n.level = i.level;
n.creationDate = i.creationDate;
n.abandonnedPaddock = i.abandonnedPaddock;
n.experience = i.experience;
n.expNextLevelFloor = i.expNextLevelFloor;
n.experiencePercentage = (i.experience - i.expLevelFloor) / (i.expNextLevelFloor - i.expLevelFloor);
t.emit("GuildGeneralInformationUpdate");
r += c.level;
c.rank === w && (n.leaderId = c.id);
c.connected && (o += 1);
a[c.id] = c;
n.members = a;
n.averageMemberLevel = Math.floor(r / s);
n.nbMembers = s;
n.nbConnectedMembers = o;
t.emit("guildMemberCountUpdate");
t.emit("guildMember", n.getMembersByRank());
i.members[n.id] = n;
n.rank === w && (i.leaderId = n.id);
t.emit("guildMember", i.getMembersByRank());
r.connected && (o += 1);
a += 1;
i.nbMembers = a;
i.nbConnectedMembers = o;
t.emit("guildMemberCountUpdate");
t.emit("guildMember", t.current.getMembersByRank());
t.current = null;
t.emit("guildLeft");
this._requestedSocialInfoMap[e] = this._requestedSocialInfoMap[e] || Boolean(t);
this._socialInfoRequestTimeout || (this._socialInfoRequestTimeout = window.setTimeout(function (e) {
  e._socialInfoRequestTimeout = null;
  var t = [];
  for (var i in e._requestedSocialInfoMap) {
    e._requestedSocialInfoMap.hasOwnProperty(i) && (t.push(i), e._awaitedSocialInfoMap[i] = e._awaitedSocialInfoMap[i] || e._requestedSocialInfoMap[i]);
  }
  e._requestedSocialInfoMap = {};
  window.dofus.sendMessage("SocialInfoRequestMessage", {
    infoTypes: t
  });
}, 0, this));
e._requestedSocialInfoMap = {};
window.dofus.sendMessage("SocialInfoRequestMessage", {
  infoTypes: t
});
r(n, o);
e.exports = n;
n.prototype.initialize = function (e) {
  this._setupListeners(e);
};
n.prototype._setupListeners = function (e) {
  e.on("HouseSoldMessage", function (t) {
    e.playerData.identification.uniqueNickname.toString() !== t.buyerName && e.chat.logMsg(a("ui.common.houseSold", s.kamasToString(t.realPrice, "")));
  });
};
o.call(this);
this.objects = {};
this.isLoaded = !1;
this.presets = {};
this.kamas = 0;
this.goultines = 0;
this.weight = 0;
this.maxWeight = 0;
this.quantityList = {};
this.equippedItems = {};
this._lastUpdatedPosition = {};
this.itemSets = {};
r(n, o);
e.exports = n;
n.prototype.connect = function () {
  window.dofus.send("moneyGoultinesAmountRequest");
};
n.prototype.isOverloaded = function () {
  return this.weight > this.maxWeight;
};
n.prototype.disconnect = function () {
  this.objects = {};
  this.isLoaded = !1;
  this.presets = {};
  this.weight = 0;
  this.maxWeight = 0;
  this.quantityList = {};
  this.equippedItems = {};
  this._lastUpdatedPosition = {};
  this.itemSets = {};
  this.kamas = null;
  this.goultines = null;
  this.emit("unloaded");
};
n.prototype.initialize = function (e) {
  function t() {
    var e = M.quantityList = {},
      t = M.objects;
    for (var i in t) {
      var n = t[i],
        o = n.objectGID;
      e[o] = (e[o] || 0) + n.quantity;
    }
  }
  function i(e) {
    for (var i = 0, n = e.length; i < n; i += 1) {
      var o = e[i];
      M.objects[o.objectUID] = o;
      o.position !== u.notEquipped && (M.equippedItems[o.position] = o, o.position === u.weapon && M.emit("weaponChanged"));
    }
    t();
  }
  function n(e) {
    for (var t = 0; t < e.length; t++) {
      if (e[t].objectGID === y) {
        return !0;
      }
    }
    return !1;
  }
  function o() {
    M.isLoaded = !0;
    M.emit("loaded");
    M.emit("listUpdate", M.objects);
  }
  function r(e) {
    M.kamas = e.kamas;
    M.emit("kamasUpdated", e.kamas);
    n(e.objects) && p.error(new Error("Inventory: player should not have tournament buff on production"));
    var t = c.createItemInstances(e.objects, function (t) {
      if (t) {
        return console.error(t);
      }
      if (!e.presets) {
        return o();
      }
      e.presets = e.presets || [];
      M.presets = {};
      for (var i = [], n = 0; n < e.presets.length; n += 1) {
        var a = e.presets[n];
        M.presets[a.presetId] = a;
        for (var s = 0; s < a.objects.length; s += 1) {
          var r = a.objects[s].objGid;
          c.items[r] || i.push(r);
        }
      }
      c.getItems(i, function (e) {
        return e ? console.error(e) : void o();
      });
    });
    i(t);
  }
  function d(e) {
    var t = c.createItemInstances(e.object, function (e, t) {
      return e ? console.error(e) : void M.emit("itemAdded", t.array[0]);
    });
    i(t);
  }
  function v(e, t, i) {
    var n = e.presets[i.presetId];
    if (!n) {
      return t.retry(new Error("Preset is missing for presetId " + i.presetId)) ? void console.warn("Preset is missing for presetId " + i.presetId + " will retry...") : void console.error(t.mainError());
    }
    for (var o = 0; o < n.objects.length; o += 1) {
      if (n.objects[o].position === i.presetItem.position) {
        n.objects[o] = i.presetItem;
        break;
      }
    }
    e.emit("presetItemUpdated", i.presetId);
  }
  function w(e) {
    var i = M.objects[e.objectUID],
      n = i.quantity;
    i.quantity = e.quantity;
    t();
    i.isInitialised && M.emit("itemQuantity", e.objectUID, e.quantity, n);
  }
  function b(e) {
    var i = M.objects[e];
    return i ? (i.position !== u.notEquipped && (delete M.equippedItems[i.position], i.position === u.weapon && M.emit("weaponChanged")), i.emit("deleted"), delete M.objects[e], t(), i) : console.error("[ObjectDeletedMessage] unknown object UID");
  }
  var M = this,
    T = window.dofus.connectionManager;
  e.on("ObjectAddedMessage", function (e) {
    d(e);
  });
  T.on("ObjectAddedWithReasonMessage", function (e) {
    d(e);
  });
  e.on("ObjectsAddedMessage", function (e) {
    var t = c.createItemInstances(e.object, function (e, t) {
      return e ? console.error(e) : void M.emit("itemsAdded", t.map);
    });
    i(t);
  });
  e.on("ObjectModifiedMessage", function (e) {
    var t = c.createItemInstances(e.object, function (t, i) {
      if (t) {
        return console.error(t);
      }
      var n = i.array[0];
      return M.objects[e.object.objectUID] || n.livingObjectCategory ? void (n.isInitialised && (n.emit("modified"), M.emit("itemModified", n))) : console.error("[ObjectModifiedMessage] unknown object UID");
    });
    i(t);
  });
  e.on("ObjectMovementMessage", function (e) {
    var t = M.objects[e.objectUID],
      i = !1;
    if (t) {
      t.position !== u.weapon && e.position !== u.weapon || (i = !0);
      var n = t.position;
      t.position = e.position;
      M.equippedItems[n] && delete M.equippedItems[n];
      e.position !== u.notEquipped && (M.equippedItems[e.position] = t);
      t.isInitialised && (i && M.emit("weaponChanged"), t.emit("moved"), M.emit("itemMoved", t, n, e.position));
    }
  });
  e.on("InventoryContentMessage", r);
  e.on("InventoryContentAndPresetMessage", r);
  e.on("InventoryPresetDeleteResultMessage", function (e) {
    switch (e.code) {
      case m.PRESET_DEL_OK:
        delete M.presets[e.presetId];
        M.emit("presetDeleted", e.presetId);
        break;
      case m.PRESET_DEL_ERR_TOO_MANY:
        M.emit("presetDeleted", e.presetId, "tooMany");
        break;
      case m.PRESET_DEL_ERR_UNKNOWN:
        M.emit("presetDeleted", e.presetId, "unknown");
        break;
      case m.PRESET_DEL_ERR_BAD_PRESET_ID:
        M.emit("presetDeleted", e.presetId, "badId");
    }
  });
  e.on("InventoryPresetSaveResultMessage", function (e) {
    switch (e.code) {
      case f.PRESET_SAVE_OK:
        M.emit("presetSaved", e.presetId);
        break;
      case f.PRESET_SAVE_ERR_TOO_MANY:
        M.emit("presetSaved", e.presetId, "tooMany");
        break;
      case f.PRESET_SAVE_ERR_UNKNOWN:
        M.emit("presetSaved", e.presetId, "unknown");
    }
  });
  e.on("InventoryPresetUseResultMessage", function (e) {
    switch (e.code) {
      case _.PRESET_USE_OK:
        M.emit("presetUsed", e.presetId);
        break;
      case _.PRESET_USE_OK_PARTIAL:
        M.emit("presetUsed", e.presetId, "usePartial");
        break;
      case _.PRESET_USE_ERR_UNKNOWN:
        M.emit("presetUsed", e.presetId, "unknown");
        break;
      case _.PRESET_USE_ERR_CRITERION:
        M.emit("presetUsed", e.presetId, "criterion");
        break;
      case _.PRESET_USE_ERR_BAD_PRESET_ID:
        M.emit("presetUsed", e.presetId, "badId");
    }
  });
  e.on("InventoryPresetUpdateMessage", function (e) {
    M.presets[e.preset.presetId] = e.preset;
    M.emit("presetUpdated", e.preset.presetId);
  });
  e.on("InventoryPresetItemUpdateMessage", function (e) {
    var t = h.operation({
      retries: 4,
      randomize: !0
    });
    t.attempt(function () {
      v(M, t, e);
    });
  });
  e.on("InventoryPresetItemUpdateErrorMessage", function (e) {
    switch (e.code) {
      case g.PRESET_UPDATE_ERR_UNKNOWN:
        M.emit("presetItemUpdateError", "unknown");
        break;
      case g.PRESET_UPDATE_ERR_BAD_PRESET_ID:
        M.emit("presetItemUpdateError", "badId");
        break;
      case g.PRESET_UPDATE_ERR_BAD_POSITION:
        M.emit("presetItemUpdateError", "badPosition");
        break;
      case g.PRESET_UPDATE_ERR_BAD_OBJECT_ID:
        M.emit("presetItemUpdateError", "badObjectId");
    }
  });
  T.on("GoultinesGivenMessage", function () {
    window.dofus.send("moneyGoultinesAmountRequest");
  });
  T.on("InventoryWeightMessage", function (e) {
    M.weight = e.weight;
    M.maxWeight = e.weightMax;
    M.emit("weightUpdated", e.weight, e.weightMax);
  });
  e.on("SetUpdateMessage", function (e) {
    var t = e.setId;
    M.itemSets[t] = {
      setEffects: e.setEffects,
      setObjects: e.setObjects
    };
  });
  T.on("ObjectsQuantityMessage", function (e) {
    for (var i = {}, n = {}, o = 0, a = e.objectsUIDAndQty.length; o < a; o += 1) {
      var s = e.objectsUIDAndQty[o],
        r = s.objectUID,
        l = s.quantity,
        c = M.objects[r],
        d = c.quantity;
      c.quantity = l;
      c.isInitialised && (i[r] = l, n[r] = d);
    }
    t();
    M.emit("itemsQuantity", i, n);
  });
  T.on("ObjectQuantityMessage", function (e) {
    w(e);
  });
  T.on("ObjectQuantityWithReasonMessage", function (e) {
    w(e);
  });
  T.on("ObjectsDeletedMessage", function (e) {
    for (var t = {}, i = 0, n = e.objectUID.length; i < n; i += 1) {
      var o = e.objectUID[i];
      t[o] = b(o);
    }
    M.emit("itemsDeleted", e.objectUID, t);
  });
  T.on("ObjectDeletedMessage", function (e) {
    var t = b(e.objectUID);
    M.emit("itemDeleted", e.objectUID, t);
  });
  T.on("ObjectErrorMessage", function (t) {
    var i;
    switch (t.reason) {
      case l.INVENTORY_FULL:
        i = s("ui.objectError.InventoryFull");
        break;
      case l.CANNOT_EQUIP_TWICE:
        i = s("ui.objectError.CannotEquipTwice");
        break;
      case l.CANNOT_DROP:
        i = s("ui.objectError.CannotDrop");
        break;
      case l.CANNOT_DROP_NO_PLACE:
        i = s("ui.objectError.CannotDropNoPlace");
        break;
      case l.CANNOT_DESTROY:
        i = s("ui.objectError.CannotDelete");
        break;
      case l.LEVEL_TOO_LOW:
        i = s("ui.objectError.levelTooLow");
        break;
      case l.LIVING_OBJECT_REFUSED_FOOD:
        i = s("ui.objectError.LivingObjectRefusedFood");
    }
    i && e.chat.logError(i);
  });
  e.on("KamasUpdateMessage", function (e) {
    a.storeValueAndEmit(M, M, "kamas", e.kamasTotal, "kamasUpdated");
  });
  T.on("CharacterStatsListMessage", function (e) {
    a.storeValueAndEmit(M, M, "kamas", e.stats.kamas, "kamasUpdated");
  });
  T.on("moneyGoultinesAmountSuccess", function (e) {
    a.storeValueAndEmit(M, M, "goultines", e.goultinesAmount, "goultinesUpdated");
  });
};
n.prototype.getCurrentWeapon = function () {
  return this.equippedItems[u.weapon];
};
this.objects = {};
this.isLoaded = !1;
this.presets = {};
this.weight = 0;
this.maxWeight = 0;
this.quantityList = {};
this.equippedItems = {};
this._lastUpdatedPosition = {};
this.itemSets = {};
this.kamas = null;
this.goultines = null;
this.emit("unloaded");
M.objects[o.objectUID] = o;
o.position !== u.notEquipped && (M.equippedItems[o.position] = o, o.position === u.weapon && M.emit("weaponChanged"));
M.isLoaded = !0;
M.emit("loaded");
M.emit("listUpdate", M.objects);
M.kamas = e.kamas;
M.emit("kamasUpdated", e.kamas);
n(e.objects) && p.error(new Error("Inventory: player should not have tournament buff on production"));
e.presets = e.presets || [];
M.presets = {};
i.quantity = e.quantity;
t();
i.isInitialised && M.emit("itemQuantity", e.objectUID, e.quantity, n);
e.on("ObjectAddedMessage", function (e) {
  d(e);
});
T.on("ObjectAddedWithReasonMessage", function (e) {
  d(e);
});
e.on("ObjectsAddedMessage", function (e) {
  var t = c.createItemInstances(e.object, function (e, t) {
    return e ? console.error(e) : void M.emit("itemsAdded", t.map);
  });
  i(t);
});
e.on("ObjectModifiedMessage", function (e) {
  var t = c.createItemInstances(e.object, function (t, i) {
    if (t) {
      return console.error(t);
    }
    var n = i.array[0];
    return M.objects[e.object.objectUID] || n.livingObjectCategory ? void (n.isInitialised && (n.emit("modified"), M.emit("itemModified", n))) : console.error("[ObjectModifiedMessage] unknown object UID");
  });
  i(t);
});
e.on("ObjectMovementMessage", function (e) {
  var t = M.objects[e.objectUID],
    i = !1;
  if (t) {
    t.position !== u.weapon && e.position !== u.weapon || (i = !0);
    var n = t.position;
    t.position = e.position;
    M.equippedItems[n] && delete M.equippedItems[n];
    e.position !== u.notEquipped && (M.equippedItems[e.position] = t);
    t.isInitialised && (i && M.emit("weaponChanged"), t.emit("moved"), M.emit("itemMoved", t, n, e.position));
  }
});
e.on("InventoryContentMessage", r);
e.on("InventoryContentAndPresetMessage", r);
e.on("InventoryPresetDeleteResultMessage", function (e) {
  switch (e.code) {
    case m.PRESET_DEL_OK:
      delete M.presets[e.presetId];
      M.emit("presetDeleted", e.presetId);
      break;
    case m.PRESET_DEL_ERR_TOO_MANY:
      M.emit("presetDeleted", e.presetId, "tooMany");
      break;
    case m.PRESET_DEL_ERR_UNKNOWN:
      M.emit("presetDeleted", e.presetId, "unknown");
      break;
    case m.PRESET_DEL_ERR_BAD_PRESET_ID:
      M.emit("presetDeleted", e.presetId, "badId");
  }
});
e.on("InventoryPresetSaveResultMessage", function (e) {
  switch (e.code) {
    case f.PRESET_SAVE_OK:
      M.emit("presetSaved", e.presetId);
      break;
    case f.PRESET_SAVE_ERR_TOO_MANY:
      M.emit("presetSaved", e.presetId, "tooMany");
      break;
    case f.PRESET_SAVE_ERR_UNKNOWN:
      M.emit("presetSaved", e.presetId, "unknown");
  }
});
e.on("InventoryPresetUseResultMessage", function (e) {
  switch (e.code) {
    case _.PRESET_USE_OK:
      M.emit("presetUsed", e.presetId);
      break;
    case _.PRESET_USE_OK_PARTIAL:
      M.emit("presetUsed", e.presetId, "usePartial");
      break;
    case _.PRESET_USE_ERR_UNKNOWN:
      M.emit("presetUsed", e.presetId, "unknown");
      break;
    case _.PRESET_USE_ERR_CRITERION:
      M.emit("presetUsed", e.presetId, "criterion");
      break;
    case _.PRESET_USE_ERR_BAD_PRESET_ID:
      M.emit("presetUsed", e.presetId, "badId");
  }
});
e.on("InventoryPresetUpdateMessage", function (e) {
  M.presets[e.preset.presetId] = e.preset;
  M.emit("presetUpdated", e.preset.presetId);
});
e.on("InventoryPresetItemUpdateMessage", function (e) {
  var t = h.operation({
    retries: 4,
    randomize: !0
  });
  t.attempt(function () {
    v(M, t, e);
  });
});
e.on("InventoryPresetItemUpdateErrorMessage", function (e) {
  switch (e.code) {
    case g.PRESET_UPDATE_ERR_UNKNOWN:
      M.emit("presetItemUpdateError", "unknown");
      break;
    case g.PRESET_UPDATE_ERR_BAD_PRESET_ID:
      M.emit("presetItemUpdateError", "badId");
      break;
    case g.PRESET_UPDATE_ERR_BAD_POSITION:
      M.emit("presetItemUpdateError", "badPosition");
      break;
    case g.PRESET_UPDATE_ERR_BAD_OBJECT_ID:
      M.emit("presetItemUpdateError", "badObjectId");
  }
});
T.on("GoultinesGivenMessage", function () {
  window.dofus.send("moneyGoultinesAmountRequest");
});
T.on("InventoryWeightMessage", function (e) {
  M.weight = e.weight;
  M.maxWeight = e.weightMax;
  M.emit("weightUpdated", e.weight, e.weightMax);
});
e.on("SetUpdateMessage", function (e) {
  var t = e.setId;
  M.itemSets[t] = {
    setEffects: e.setEffects,
    setObjects: e.setObjects
  };
});
T.on("ObjectsQuantityMessage", function (e) {
  for (var i = {}, n = {}, o = 0, a = e.objectsUIDAndQty.length; o < a; o += 1) {
    var s = e.objectsUIDAndQty[o],
      r = s.objectUID,
      l = s.quantity,
      c = M.objects[r],
      d = c.quantity;
    c.quantity = l;
    c.isInitialised && (i[r] = l, n[r] = d);
  }
  t();
  M.emit("itemsQuantity", i, n);
});
T.on("ObjectQuantityMessage", function (e) {
  w(e);
});
T.on("ObjectQuantityWithReasonMessage", function (e) {
  w(e);
});
T.on("ObjectsDeletedMessage", function (e) {
  for (var t = {}, i = 0, n = e.objectUID.length; i < n; i += 1) {
    var o = e.objectUID[i];
    t[o] = b(o);
  }
  M.emit("itemsDeleted", e.objectUID, t);
});
T.on("ObjectDeletedMessage", function (e) {
  var t = b(e.objectUID);
  M.emit("itemDeleted", e.objectUID, t);
});
T.on("ObjectErrorMessage", function (t) {
  var i;
  switch (t.reason) {
    case l.INVENTORY_FULL:
      i = s("ui.objectError.InventoryFull");
      break;
    case l.CANNOT_EQUIP_TWICE:
      i = s("ui.objectError.CannotEquipTwice");
      break;
    case l.CANNOT_DROP:
      i = s("ui.objectError.CannotDrop");
      break;
    case l.CANNOT_DROP_NO_PLACE:
      i = s("ui.objectError.CannotDropNoPlace");
      break;
    case l.CANNOT_DESTROY:
      i = s("ui.objectError.CannotDelete");
      break;
    case l.LEVEL_TOO_LOW:
      i = s("ui.objectError.levelTooLow");
      break;
    case l.LIVING_OBJECT_REFUSED_FOOD:
      i = s("ui.objectError.LivingObjectRefusedFood");
  }
  i && e.chat.logError(i);
});
e.on("KamasUpdateMessage", function (e) {
  a.storeValueAndEmit(M, M, "kamas", e.kamasTotal, "kamasUpdated");
});
T.on("CharacterStatsListMessage", function (e) {
  a.storeValueAndEmit(M, M, "kamas", e.stats.kamas, "kamasUpdated");
});
T.on("moneyGoultinesAmountSuccess", function (e) {
  a.storeValueAndEmit(M, M, "goultines", e.goultinesAmount, "goultinesUpdated");
});
t.position = e.position;
M.equippedItems[n] && delete M.equippedItems[n];
e.position !== u.notEquipped && (M.equippedItems[e.position] = t);
t.isInitialised && (i && M.emit("weaponChanged"), t.emit("moved"), M.emit("itemMoved", t, n, e.position));
delete M.presets[e.presetId];
M.emit("presetDeleted", e.presetId);
M.presets[e.preset.presetId] = e.preset;
M.emit("presetUpdated", e.preset.presetId);
M.weight = e.weight;
M.maxWeight = e.weightMax;
M.emit("weightUpdated", e.weight, e.weightMax);
c.quantity = l;
c.isInitialised && (i[r] = l, n[r] = d);
t();
M.emit("itemsQuantity", i, n);
n.prototype._equip = function (e, t, i) {
  this._lastUpdatedPosition[i.superTypeId] = e;
  window.dofus.sendMessage("ObjectSetPositionMessage", {
    objectUID: t.objectUID,
    position: e,
    quantity: 1
  });
  var n = w[e];
  n && d(n);
};
n.prototype.equipItem = function (e, t) {
  var i = this.objects[e];
  if (i && i.position === u.notEquipped) {
    var n = i.item,
      o = n.type;
    if (o.category === c.categories.equipment) {
      if (n.typeId === v) {
        return this._equip(t, i, o);
      }
      var a = o.possiblePositions;
      if (a.length) {
        if (t && a.indexOf(t) !== -1) {
          return this._equip(t, i, o);
        }
        var s,
          r,
          l,
          d,
          h = this.equippedItems;
        if (9 !== o.id || i.belongsToSet) {
          for (s = 0, r = a.length; s < r; s += 1) {
            if (l = a[s], d = h[l], d && d.objectGID === i.objectGID) {
              return this._equip(l, i, o);
            }
          }
        }
        for (s = 0, r = a.length; s < r; s += 1) {
          if (l = a[s], !h[l]) {
            return this._equip(l, i, o);
          }
        }
        var p = this._lastUpdatedPosition[o.superTypeId] || 0,
          m = p < a.length - 1 ? p + 1 : 0;
        this._equip(a[m], i, o);
      }
    }
  }
};
n.prototype.unEquipItem = function (e) {
  var t = this.objects[e];
  t && t.position !== u.notEquipped && (window.isoEngine.actionQueue.isActive() || window.dofus.sendMessage("ObjectSetPositionMessage", {
    objectUID: e,
    position: u.notEquipped,
    quantity: 1
  }));
};
n.prototype.confirmDestroyItem = function (e, t) {
  window.gui.openConfirmPopup({
    title: s("ui.common.delete.item"),
    message: s("ui.common.doYouDestroy", t, e.item.nameId),
    cb: function (i) {
      i && window.dofus.sendMessage("ObjectDeleteMessage", {
        objectUID: e.objectUID,
        quantity: t
      });
    }
  });
};
n.prototype.getGenericItem = function (e) {
  var t,
    i = this.objects;
  for (var n in i) {
    if (t = i[n], t.objectGID === e) {
      return t;
    }
  }
  return null;
};
n.prototype.getGenericItemCount = function (e) {
  var t = this.objects,
    i = 0;
  for (var n in t) {
    var o = t[n];
    o.objectGID === e && (i += o.quantity);
  }
  return i;
};
n.prototype.isGenericItemEquipped = function (e) {
  var t = this.objects;
  for (var i in t) {
    var n = t[i];
    if (n.objectGID === e && n.position !== u.notEquipped) {
      return !0;
    }
  }
  return !1;
};
n.prototype.isPetFood = function (e, t) {
  var i = e.foodItems,
    n = e.foodTypes;
  return !(!i || !n) && (i.indexOf(t.getProperty("objectGID")) !== -1 || n.indexOf(t.getProperty("typeId")) !== -1);
};
this._lastUpdatedPosition[i.superTypeId] = e;
window.dofus.sendMessage("ObjectSetPositionMessage", {
  objectUID: t.objectUID,
  position: e,
  quantity: 1
});
u = {};
h = {};
p = {};
m = {
  Jobs: u,
  Skills: h,
  Recipes: p
};
p || (p = t[d] = {
  id: d
});
p.description = c;
u[d] || (n[d] = !0);
f.call(this);
this.SKILLID_WRAP_GIFT = 209;
this.SKILLID_DECRAFT = 181;
this.ITEMID_MAGIC_FRAGMENT = 8378;
this.RUNE_SIGNATURE_GID = T;
this.SMITHMAGIC_RUNE_ID = I;
this.SMITHMAGIC_POTION_ID = A;
this.MAX_CRAFT_SLOTS = 8;
this.list = {};
this._publicMode = !1;
this._playersMultiCraftSkillById = {};
this._existingSlotCount = 0;
this._onCraftTable = {};
this._stackCount = 0;
this._stackCountPerGid = {};
this.jobXpBonus = 0;
_(l, f);
e.exports = l;
l.prototype.disconnect = function () {
  n();
  this.list = {};
  this._publicMode = !1;
  this._playersMultiCraftSkillById = {};
  this.jobXpBonus = 0;
  this.craftersSettings = null;
  this.jobOriginalOrder = null;
  this.clearAfterCraft();
};
l.prototype.startCraftingSession = function (e, t, i) {
  this.craftSide = e;
  this.craftType = this.getCraftType(t);
  this._setupSkillData(t);
  this.setExistingSlotCount(i);
  this.isMagicCraft = "craftMagus" === this.craftType;
  this._stackCount = 0;
  this.canUseCrafterIngredient = !1;
  this.isCrafterWorking = !1;
  this.isCombining = !1;
  this._startListeningForCraft();
};
l.prototype.setCrafterIngredientsAllowed = function (e) {
  this.canUseCrafterIngredient = e;
};
l.prototype.switchToCrafter = function (e) {
  this.isCrafterWorking = e;
};
l.prototype.startCombining = function () {
  this.isCombining = !0;
};
l.prototype.stopCombining = function () {
  this.isCombining = !1;
};
l.prototype.clearAfterCraft = function () {
  this._onCraftTable = {};
  this._stackCountPerGid = {};
  this._stopListeningForCraft();
  this.removeAllListeners("objectAdded");
  this.removeAllListeners("objectModified");
  this.removeAllListeners("objectRemoved");
};
l.prototype._startListeningForCraft = function () {
  if (!this.isListeningForCraft) {
    this.isListeningForCraft = !0;
    this._objectAddedHandler || (this._objectAddedHandler = this._onCraftObjectAddedMessage.bind(this), this._objectModifiedHandler = this._onCraftObjectModifiedMessage.bind(this), this._objectRemovedHandler = this._onCraftObjectRemovedMessage.bind(this));
    var e = window.dofus.connectionManager;
    e.on("ExchangeObjectAddedMessage", this._objectAddedHandler);
    e.on("ExchangeObjectModifiedMessage", this._objectModifiedHandler);
    e.on("ExchangeObjectRemovedMessage", this._objectRemovedHandler);
  }
};
l.prototype._stopListeningForCraft = function () {
  if (this.isListeningForCraft) {
    this.isListeningForCraft = !1;
    var e = window.dofus.connectionManager;
    e.removeListener("ExchangeObjectAddedMessage", this._objectAddedHandler);
    e.removeListener("ExchangeObjectModifiedMessage", this._objectModifiedHandler);
    e.removeListener("ExchangeObjectRemovedMessage", this._objectRemovedHandler);
  }
};
l.prototype._onCraftObjectAddedMessage = function (e) {
  var t = e.remote,
    i = e.object,
    n = i.objectUID,
    o = i.objectGID,
    a = i.quantity,
    s = this._onCraftTable[n];
  return s ? console.warn("ExchangeObjectAddedMessage received for existing object " + n) : (this._onCraftTable[n] = {
    GID: o,
    quantity: a
  }, this._stackCount++, this._stackCountPerGid[o] = (this._stackCountPerGid[o] || 0) + 1, void this.emit("objectAdded", i, t));
};
l.prototype._onCraftObjectModifiedMessage = function (e) {
  var t = e.object,
    i = e.remote,
    n = t.objectUID,
    o = this._onCraftTable[n];
  return o ? (o.quantity = t.quantity, void this.emit("objectModified", t, i)) : console.error("craftObjectModified of unknown object " + n);
};
l.prototype._onCraftObjectRemovedMessage = function (e) {
  var t = e.remote,
    i = e.objectUID,
    n = this._onCraftTable[i];
  if (!n) {
    return console.error("craftObjectRemoved of unknown object " + i);
  }
  var o = n.GID;
  delete this._onCraftTable[i];
  this._stackCount--;
  0 === --this._stackCountPerGid[o] && delete this._stackCountPerGid[o];
  this.emit("objectRemoved", i, t);
};
l.prototype._setupSkillData = function (e) {
  this.currentSkillId = e;
  this.skillData = h[e];
  var t = this.list[this.skillData.parentJobId] || {},
    i = t.experience || {};
  this.crafterSkillLevel = i.jobLevel;
  this.canCrafterSign = this.crafterSkillLevel >= C;
};
l.prototype.getCraftType = function (e) {
  var t = h[e];
  return t ? t.isForgemagus || t.modifiableItemType !== -1 ? "craftMagus" : e === this.SKILLID_DECRAFT ? "decrafting" : e === this.SKILLID_WRAP_GIFT ? "wrapping" : "crafting" : console.error("Invalid skillId: " + e);
};
l.prototype.isCraftableItem = function (e) {
  return this.skillData.modifiableItemType === e.getProperty("typeId") && e.getProperty("enhanceable");
};
l.prototype._getReplacedItemOnMagicTable = function (e) {
  return this._onCraftTable[e.objectUID] ? null : e.objectGID === T ? this._getSignatureRuneOnTable() : this._isMagicRuneOrPotion(e) ? this._getRuneOrPotionOnMagicTable() : this._getItemOnMagicTable();
};
l.prototype._getSignatureRuneOnTable = function () {
  for (var e in this._onCraftTable) {
    var t = this._onCraftTable[e];
    if (t.GID === T) {
      return e;
    }
  }
  return null;
};
l.prototype._getRuneOrPotionOnMagicTable = function () {
  for (var e in this._onCraftTable) {
    var t = this._onCraftTable[e],
      i = y.items[t.GID].typeId;
    if (i === I || i === A) {
      return e;
    }
  }
  return null;
};
l.prototype._getItemOnMagicTable = function () {
  for (var e in this._onCraftTable) {
    var t = this._onCraftTable[e];
    if (t.GID !== T) {
      var i = y.items[t.GID].typeId;
      if (i !== I && i !== A) {
        return e;
      }
    }
  }
  return null;
};
l.prototype._isMagicRuneOrPotion = function (e) {
  var t = e.item.typeId;
  return t === I || t === A;
};
l.prototype._getItemMoveTargets = function (e, t) {
  if (this.isMagicCraft) {
    switch (this.craftSide) {
      case "SOLO":
        switch (e) {
          case "craftInventory":
            return ["crafting"];
          case "crafting":
            return ["craftInventory"];
          default:
            return [];
        }
      case "CLIENT":
        if (this.isCrafterWorking) {
          return [];
        }
        switch (e) {
          case "craftInventory":
            return ["ingredientsBag", "craftPayment"];
          case "ingredientsBag":
            return ["craftInventory"];
          case "craftPayment":
            return ["craftInventory"];
          default:
            return [];
        }
      case "CRAFTER":
        if (!this.isCrafterWorking) {
          return [];
        }
        switch (e) {
          case "craftInventory":
            return this.canUseCrafterIngredient || t.objectGID === T ? ["crafting"] : [];
          case "crafting":
            return c(t) ? ["craftInventory"] : ["ingredientsBag"];
          case "ingredientsBag":
            return ["crafting"];
          default:
            return [];
        }
      default:
        return [];
    }
  } else {
    switch (this.craftSide) {
      case "SOLO":
        switch (e) {
          case "craftInventory":
            return ["crafting"];
          case "crafting":
            return ["craftInventory"];
          default:
            return [];
        }
      case "CRAFTER":
        switch (e) {
          case "craftInventory":
            return ["crafting"];
          case "crafting":
            return ["craftInventory"];
          default:
            return [];
        }
      case "CLIENT":
        switch (e) {
          case "craftInventory":
            return ["crafting", "craftPayment"];
          case "crafting":
            return ["craftInventory"];
          case "craftPayment":
            return ["craftInventory"];
          default:
            return [];
        }
      default:
        return [];
    }
  }
};
l.prototype.canItemMove = function (e, t, i) {
  var n = this._getItemMoveTargets(e, i);
  return n.indexOf(t) !== -1;
};
l.prototype.getQuickTransferPreference = function (e) {
  var t = null;
  return t || d(this.craftType, this.craftSide, e);
};
l.prototype.getQuickTransferInfo = function (e, t, i) {
  if (this.isCombining) {
    return {
      targets: [],
      movedQty: 0,
      proposedQty: 0
    };
  }
  var n = this._getItemMoveTargets(e, t);
  if (0 === n.length) {
    return {
      targets: [],
      movedQty: 0,
      proposedQty: 0
    };
  }
  var o,
    a = this.isMagicCraft && "CLIENT" === this.craftSide ? "ingredientsBag" : "crafting";
  if (o = n.indexOf(a) !== -1 ? this.howManyCanBeAddedToCraft(e, t, i) : t.quantity, 0 === o) {
    return {
      targets: [],
      movedQty: 0,
      proposedQty: 0
    };
  }
  var s = this.getQuickTransferPreference(e);
  return s.move ? {
    targets: n,
    movedQty: "max" === s.move ? o : 1
  } : {
    targets: n,
    proposedQty: "max" === s.propose ? o : 1,
    maxQty: o
  };
};
l.prototype.howManyCanBeAddedToCraft = function (e, t, i) {
  if (this.isCombining) {
    return 0;
  }
  if (i < 1) {
    return 0;
  }
  if (t.objectGID === T) {
    return !this._getSignatureRuneOnTable() && "CLIENT" !== this.craftSide && this.canCrafterSign ? 1 : 0;
  }
  if (this.isMagicCraft) {
    if ("CLIENT" === this.craftSide && this.isCrafterWorking) {
      return 0;
    }
    if ("CRAFTER" === this.craftSide && !this.isCrafterWorking) {
      return 0;
    }
    var n = "CRAFTER" === this.craftSide && "craftInventory" === e;
    return this._isMagicRuneOrPotion(t) ? n && !this.canUseCrafterIngredient ? 0 : i : this.isCraftableItem(t) ? n ? 0 : this._onCraftTable[t.objectUID] ? 0 : 1 : 0;
  }
  return "SOLO" === this.craftSide ? this.getFreeSlotCount() || this._onCraftTable[t.objectUID] ? i : 0 : this.getFreeSlotCount() || this._stackCountPerGid[t.objectGID] ? i : 0;
};
l.prototype.moveItemToCraft = function (e, t, i) {
  if (!(i >= 1)) {
    return console.error("moveItemToCraft quantity: " + i);
  }
  if (this.isMagicCraft) {
    var n = this._getReplacedItemOnMagicTable(t);
    n && this.removeItemFromCraft(n, this._onCraftTable[n].quantity);
  }
  var o = t.objectUID;
  "CRAFTER" === this.craftSide && "craftInventory" !== e ? window.dofus.sendMessage("ExchangeObjectUseInWorkshopMessage", {
    objectUID: o,
    quantity: i
  }) : window.dofus.sendMessage("ExchangeObjectMoveMessage", {
    objectUID: o,
    quantity: i
  });
};
l.prototype.removeItemFromCraft = function (e, t) {
  return t >= 1 ? void ("CRAFTER" === this.craftSide && this.isMagicCraft ? window.dofus.sendMessage("ExchangeObjectUseInWorkshopMessage", {
    objectUID: e,
    quantity: -t
  }) : window.dofus.sendMessage("ExchangeObjectMoveMessage", {
    objectUID: e,
    quantity: -t
  })) : console.error("removeItemFromCraft quantity: " + t);
};
l.prototype.initialize = function (e) {
  function t(e, t) {
    var i;
    i = t ? g("ui.craft.referenceAdd", e.nameId) : g("ui.craft.referenceRemove", e.nameId);
    window.gui.chat.logMsg(i);
  }
  function i(e) {
    var t = o.list[e.jobId];
    t || (t = {}, o.list[e.jobId] = t);
    t.experience = e;
  }
  var o = this;
  n();
  s();
  var a = w.createFifo();
  e.on("JobDescriptionMessage", function (e) {
    a.push(function (t) {
      r(e.jobsDescription, o.list, function (i) {
        if (i) {
          return t(i);
        }
        o.jobOriginalOrder = [];
        for (var n = 0; n < e.jobsDescription.length; n++) {
          o.jobOriginalOrder.push(e.jobsDescription[n].jobId);
        }
        o.emit("jobListUpdated");
        t();
      });
    });
  });
  e.on("JobCrafterDirectorySettingsMessage", function (e) {
    a.push(function (t) {
      o.craftersSettings = e.craftersSettings;
      t();
    });
  });
  e.on("JobListedUpdateMessage", function (e) {
    a.push(function (i) {
      var n = o.list[e.jobId];
      return n ? (t(n.info, e.addedOrDeleted), i()) : void v.getData("Jobs", e.jobId, function (n, o) {
        return n ? i(n) : (t(o, e.addedOrDeleted), void i());
      });
    });
  });
  e.on("JobExperienceUpdateMessage", function (e) {
    a.push(function (t) {
      i(e.experiencesUpdate);
      var n = e.experiencesUpdate.jobId;
      o.emit("jobExperienceUpdate", o.getJobExperience(n));
      t();
    });
  });
  e.on("JobExperienceMultiUpdateMessage", function (e) {
    a.push(function (t) {
      for (var n = 0, a = e.experiencesUpdate.length; n < a; n += 1) {
        i(e.experiencesUpdate[n]);
        var s = e.experiencesUpdate[n].jobId;
        o.emit("jobExperienceUpdate", o.getJobExperience(s));
      }
      t();
    });
  });
  e.on("JobLevelUpMessage", function (e) {
    a.push(function (t) {
      r([e.jobsDescription], o.list, function (i) {
        if (i) {
          return t(i);
        }
        var n = e.newLevel,
          a = o.list[e.jobsDescription.jobId];
        a.experience.jobLevel = n;
        var s = g("ui.craft.newJobLevel", a.info.nameId, n);
        window.gui.chat.logMsg(s);
        window.gui.openSimplePopup(s, g("ui.common.informations"));
        b("LEVEL_UP");
        o.emit("jobLevelUp", a, n);
        t();
      });
    });
  });
  e.on("JobUnlearntMessage", function (e) {
    a.push(function (t) {
      delete o.list[e.jobId];
      o.jobOriginalOrder.splice(o.jobOriginalOrder.indexOf(e.jobId), 1);
      o.emit("jobListUpdated");
      t();
    });
  });
  e.on("JobAllowMultiCraftRequestMessage", function (e) {
    a.push(function (t) {
      o._publicMode = e.enabled;
      delete o._playersMultiCraftSkillById[window.gui.playerData.id];
      o.emit("jobPublicMode", o._publicMode);
      t();
    });
  });
  e.on("JobMultiCraftAvailableSkillsMessage", function (e) {
    a.push(function (t) {
      o._updateMultiCraftAvailableSkills(e);
      t();
    });
  });
  e.on("CurrentMapMessage", function () {
    a.push(function (e) {
      o._playersMultiCraftSkillById = {};
      e();
    });
  });
  M.on("ServerBonusMessage", function (e) {
    o.jobXpBonus = e.jobXpBonus;
  });
  M.on("ServerBonusUpdateMessage", function (e) {
    o.jobXpBonus = e.jobXpBonus;
  });
};
l.prototype.getCraftTable = function () {
  return this._onCraftTable;
};
l.prototype.setExistingSlotCount = function (e) {
  this._existingSlotCount = Math.min(Math.max(e, 0), this.MAX_CRAFT_SLOTS);
};
l.prototype.getExistingSlotCount = function () {
  return this._existingSlotCount;
};
l.prototype.getFreeSlotCount = function () {
  var e = this._stackCountPerGid[T] ? 1 : 0;
  return "SOLO" === this.craftSide ? this._existingSlotCount - this._stackCount + e : this._existingSlotCount - Object.keys(this._stackCountPerGid).length + e;
};
l.prototype.prepareSkillRecipes = function (e, t) {
  a([e], t);
};
l.prototype.getRecipesBySkill = function (e) {
  return h[e].recipes;
};
l.prototype.getSkill = function (e) {
  return h[e];
};
l.prototype.getJobFromSkillId = function (e) {
  var t = h[e] || {};
  return u[t.parentJobId] || {};
};
l.prototype.getAvailableSkills = function () {
  for (var e = {}, t = Object.keys(this.list), i = 0; i < t.length; i++) {
    for (var n = this.list[t[i]], o = n.description.skills, a = 0; a < o.length; a++) {
      e[o[a].skillId] = o[a].info;
    }
  }
  return e;
};
l.prototype.getStorageCraftFilterMap = function (e, t) {
  for (var i = this._getRecipeByNbIngredient(e, 1, t), n = {}, o = 0, a = i.length; o < a; o += 1) {
    for (var s = i[o].ingredientIds, r = 0, l = s.length; r < l; r += 1) {
      var c = s[r];
      n[c] = !0;
    }
  }
  return this.canCrafterSign && "CLIENT" !== this.craftSide && (n[T] = !0), n;
};
l.prototype._getRecipeByNbIngredient = function (e, t, i) {
  i = i || t;
  for (var n = this.getRecipesBySkill(e), o = [], a = 0, s = n.length; a < s; a += 1) {
    var r = n[a],
      l = r.ingredientIds.length;
    l >= t && l <= i && o.push(r);
  }
  return o;
};
l.prototype._getRecipesWithItemsOnCraftTable = function (e) {
  function t() {
    var e = {};
    for (var t in i._onCraftTable) {
      var n = i._onCraftTable[t],
        o = n.GID,
        a = n.quantity;
      o !== T && (e[o] || (e[o] = 0), e[o] += a);
    }
    return e;
  }
  for (var i = this, n = [], o = t(), a = Object.keys(o).length, s = this._getRecipeByNbIngredient(e, a), r = 0, l = s.length; r < l; r += 1) {
    var c = s[r],
      d = !0;
    for (var u in o) {
      for (var h = parseInt(u, 10), p = o[h], m = !1, f = 0, g = c.ingredientIds.length; f < g; f += 1) {
        var _ = c.ingredientIds[f],
          v = c.quantities[f];
        if (h === _ && p === v) {
          m = !0;
          break;
        }
      }
      if (!m) {
        d = !1;
        break;
      }
    }
    d && n.push(c);
  }
  return n;
};
l.prototype.checkRecipe = function (e) {
  var t,
    i = !1,
    n = this._getRecipesWithItemsOnCraftTable(e);
  return 1 === n.length ? (t = n[0], i = !0) : e === this.SKILLID_DECRAFT && (i = !0, t = {
    resultId: this.ITEMID_MAGIC_FRAGMENT,
    resultLevel: 1,
    ingredientIds: [],
    quantities: []
  }), {
    isRecipeKnown: i,
    itemToCraft: t
  };
};
l.prototype._updateMultiCraftAvailableSkills = function (e) {
  var t = this,
    i = e.playerId,
    n = e.skills,
    a = {};
  if (!e.enabled) {
    return void delete this._playersMultiCraftSkillById[i];
  }
  for (var s = [], r = 0, l = n.length; r < l; r += 1) {
    var c = n[r];
    h[c] || s.push(c);
  }
  o("Skills", s, function (e) {
    if (e) {
      return console.error("JobData: Cannot get missing skills for ids", s, e);
    }
    for (var o = 0, r = n.length; o < r; o += 1) {
      var l = n[o],
        c = h[l];
      c ? a[l] = c : console.warn("JobsData: No data for skillId", l);
    }
    t._playersMultiCraftSkillById[i] = a;
  });
};
l.prototype.playersMultiCraftSkillById = function (e) {
  return this._playersMultiCraftSkillById[e];
};
l.prototype.getMaxSlotsByJobId = function (e) {
  var t = this.list[e],
    i = 0;
  if (!t) {
    return 0;
  }
  for (var n = t.description.skills, o = 0, a = n.length; o < a; o += 1) {
    var s = n[o].maxSlots;
    s && s > i && (i = s);
  }
  return i;
};
l.prototype.getUsableSkillsInMap = function (e, t) {
  var i = [];
  if (!t) {
    return i;
  }
  var n = e === window.gui.playerData.id ? this.getAvailableSkills() : this.playersMultiCraftSkillById(e);
  if (!n) {
    return i;
  }
  var o = {};
  for (var a in t) {
    for (var s = t[a], r = s.enabledSkills, l = s.disabledSkills, c = r.concat(l), d = 0, u = c.length; d < u; d += 1) {
      var h = c[d].skillId;
      n[h] && !o[h] && (i.push(n[h]), o[h] = !0);
    }
  }
  return i;
};
l.prototype.getJobNpcNameById = function (e) {
  return x[e];
};
l.prototype.getJobExperience = function (e) {
  var t = this.list[e];
  if (!t) {
    return null;
  }
  var i = t.experience || {},
    n = {
      jobId: e
    };
  return n.currentLevel = i.jobLevel, n.currentExperience = i.jobXP, n.levelExperienceFloor = i.jobXpLevelFloor, n.levelExperienceCeil = i.jobXpNextLevelFloor, n.percentage = 100, n.levelExperienceCeil && (n.percentage = Math.floor((n.currentExperience - n.levelExperienceFloor) / (n.levelExperienceCeil - n.levelExperienceFloor) * 100)), n;
};
n();
this.list = {};
this._publicMode = !1;
this._playersMultiCraftSkillById = {};
this.jobXpBonus = 0;
this.craftersSettings = null;
this.jobOriginalOrder = null;
this.clearAfterCraft();
this.craftSide = e;
this.craftType = this.getCraftType(t);
this._setupSkillData(t);
this.setExistingSlotCount(i);
this.isMagicCraft = "craftMagus" === this.craftType;
this._stackCount = 0;
this.canUseCrafterIngredient = !1;
this.isCrafterWorking = !1;
this.isCombining = !1;
this._startListeningForCraft();
this._onCraftTable = {};
this._stackCountPerGid = {};
this._stopListeningForCraft();
this.removeAllListeners("objectAdded");
this.removeAllListeners("objectModified");
this.removeAllListeners("objectRemoved");
this.isListeningForCraft = !0;
this._objectAddedHandler || (this._objectAddedHandler = this._onCraftObjectAddedMessage.bind(this), this._objectModifiedHandler = this._onCraftObjectModifiedMessage.bind(this), this._objectRemovedHandler = this._onCraftObjectRemovedMessage.bind(this));
e.on("ExchangeObjectAddedMessage", this._objectAddedHandler);
e.on("ExchangeObjectModifiedMessage", this._objectModifiedHandler);
e.on("ExchangeObjectRemovedMessage", this._objectRemovedHandler);
e.removeListener("ExchangeObjectAddedMessage", this._objectAddedHandler);
e.removeListener("ExchangeObjectModifiedMessage", this._objectModifiedHandler);
e.removeListener("ExchangeObjectRemovedMessage", this._objectRemovedHandler);
delete this._onCraftTable[i];
this._stackCount--;
0 === --this._stackCountPerGid[o] && delete this._stackCountPerGid[o];
this.emit("objectRemoved", i, t);
this.currentSkillId = e;
this.skillData = h[e];
this.crafterSkillLevel = i.jobLevel;
this.canCrafterSign = this.crafterSkillLevel >= C;
i = t ? g("ui.craft.referenceAdd", e.nameId) : g("ui.craft.referenceRemove", e.nameId);
window.gui.chat.logMsg(i);
t || (t = {}, o.list[e.jobId] = t);
t.experience = e;
n();
s();
e.on("JobDescriptionMessage", function (e) {
  a.push(function (t) {
    r(e.jobsDescription, o.list, function (i) {
      if (i) {
        return t(i);
      }
      o.jobOriginalOrder = [];
      for (var n = 0; n < e.jobsDescription.length; n++) {
        o.jobOriginalOrder.push(e.jobsDescription[n].jobId);
      }
      o.emit("jobListUpdated");
      t();
    });
  });
});
e.on("JobCrafterDirectorySettingsMessage", function (e) {
  a.push(function (t) {
    o.craftersSettings = e.craftersSettings;
    t();
  });
});
e.on("JobListedUpdateMessage", function (e) {
  a.push(function (i) {
    var n = o.list[e.jobId];
    return n ? (t(n.info, e.addedOrDeleted), i()) : void v.getData("Jobs", e.jobId, function (n, o) {
      return n ? i(n) : (t(o, e.addedOrDeleted), void i());
    });
  });
});
e.on("JobExperienceUpdateMessage", function (e) {
  a.push(function (t) {
    i(e.experiencesUpdate);
    var n = e.experiencesUpdate.jobId;
    o.emit("jobExperienceUpdate", o.getJobExperience(n));
    t();
  });
});
e.on("JobExperienceMultiUpdateMessage", function (e) {
  a.push(function (t) {
    for (var n = 0, a = e.experiencesUpdate.length; n < a; n += 1) {
      i(e.experiencesUpdate[n]);
      var s = e.experiencesUpdate[n].jobId;
      o.emit("jobExperienceUpdate", o.getJobExperience(s));
    }
    t();
  });
});
e.on("JobLevelUpMessage", function (e) {
  a.push(function (t) {
    r([e.jobsDescription], o.list, function (i) {
      if (i) {
        return t(i);
      }
      var n = e.newLevel,
        a = o.list[e.jobsDescription.jobId];
      a.experience.jobLevel = n;
      var s = g("ui.craft.newJobLevel", a.info.nameId, n);
      window.gui.chat.logMsg(s);
      window.gui.openSimplePopup(s, g("ui.common.informations"));
      b("LEVEL_UP");
      o.emit("jobLevelUp", a, n);
      t();
    });
  });
});
e.on("JobUnlearntMessage", function (e) {
  a.push(function (t) {
    delete o.list[e.jobId];
    o.jobOriginalOrder.splice(o.jobOriginalOrder.indexOf(e.jobId), 1);
    o.emit("jobListUpdated");
    t();
  });
});
e.on("JobAllowMultiCraftRequestMessage", function (e) {
  a.push(function (t) {
    o._publicMode = e.enabled;
    delete o._playersMultiCraftSkillById[window.gui.playerData.id];
    o.emit("jobPublicMode", o._publicMode);
    t();
  });
});
e.on("JobMultiCraftAvailableSkillsMessage", function (e) {
  a.push(function (t) {
    o._updateMultiCraftAvailableSkills(e);
    t();
  });
});
e.on("CurrentMapMessage", function () {
  a.push(function (e) {
    o._playersMultiCraftSkillById = {};
    e();
  });
});
M.on("ServerBonusMessage", function (e) {
  o.jobXpBonus = e.jobXpBonus;
});
M.on("ServerBonusUpdateMessage", function (e) {
  o.jobXpBonus = e.jobXpBonus;
});
o.emit("jobListUpdated");
t();
o.craftersSettings = e.craftersSettings;
t();
o.emit("jobExperienceUpdate", o.getJobExperience(n));
t();
window.gui.chat.logMsg(s);
window.gui.openSimplePopup(s, g("ui.common.informations"));
b("LEVEL_UP");
o.emit("jobLevelUp", a, n);
t();
delete o.list[e.jobId];
o.jobOriginalOrder.splice(o.jobOriginalOrder.indexOf(e.jobId), 1);
o.emit("jobListUpdated");
t();
o._publicMode = e.enabled;
delete o._playersMultiCraftSkillById[window.gui.playerData.id];
o.emit("jobPublicMode", o._publicMode);
t();
o._updateMultiCraftAvailableSkills(e);
t();
o._playersMultiCraftSkillById = {};
e();
o.call(this);
this.finishedAchievementsIds = [];
this.accountAchievementsIds = [];
this.rewardableAchievements = {};
this.maximumNumberOfAchievements = 0;
this.achievementCategories = [];
this.categories = {};
this.categoriesPercentage = {};
this.categoriesAchievementCount = {};
this.categoriesCurrentAchievementCount = {};
this.categoriesTotal = {};
this.categoriesTotalPercentage = {};
this.categoriesTotalAchievementCount = {};
this.categoriesTotalCurrentAchievementCount = {};
this.subCategories = {};
this.subCategoriesPercentage = {};
this.subCategoriesAchievementCount = {};
this.subCategoriesCurentAchievementCount = {};
this.points = 0;
a(n, o);
e.exports = n;
n.prototype.disconnect = function () {
  this.finishedAchievementsIds = [];
  this.accountAchievementsIds = [];
  this.rewardableAchievements = {};
  this.points = 0;
  this.categoriesPercentage = {};
  this.categoriesCurrentAchievementCount = {};
  this.categoriesTotalPercentage = {};
  this.categoriesTotalCurrentAchievementCount = {};
  this.subCategoriesPercentage = {};
  this.subCategoriesCurentAchievementCount = {};
};
n.prototype.initialize = function (e) {
  var t = this;
  e.on("AchievementListMessage", function (e) {
    var i = e.enrichData.points;
    e.enrichData.achievementsTotal && (t.maximumNumberOfAchievements = e.enrichData.achievementsTotal);
    t.finishedAchievementsIds = e.finishedAchievementsIds;
    for (var n = 0; n < e.rewardableAchievements.length; n++) {
      t.finishedAchievementsIds.push(e.rewardableAchievements[n].id);
      t.rewardableAchievements[e.rewardableAchievements[n].id] = e.rewardableAchievements[n];
    }
    for (var o = 0; o < e.accountAchievements.length; o++) {
      e.accountAchievements[o].isFirstForAccount || t.accountAchievementsIds.push(e.accountAchievements[o].id);
    }
    t.points = i;
    t.emit("achievementListUpdated", e);
  });
  e.on("AchievementFinishedMessage", function (e) {
    window.gui.chat.logMsg(s("ui.achievement.achievementUnlockWithLink", e.id));
    var i = e.enrichData.points;
    t.finishedAchievementsIds.push(e.id);
    t.rewardableAchievements[e.id] = e;
    t.points += i;
    var n = null,
      o = e.enrichData.categoryID;
    if (t.categories[o]) {
      t.categoriesTotalCurrentAchievementCount[o]++;
      t.categoriesCurrentAchievementCount[o]++;
      t.categoriesPercentage[o] = t.categoriesCurrentAchievementCount[o] / t.categoriesAchievementCount[o];
    } else {
      for (var a in t.categoriesTotal) {
        if (t.categoriesTotal.hasOwnProperty(a) && t.categoriesTotal[a].indexOf(o) !== -1) {
          n = a;
          break;
        }
      }
      n && (t.categoriesTotalCurrentAchievementCount[n]++, t.subCategoriesCurentAchievementCount[o]++, t.subCategoriesPercentage[o] = t.subCategoriesCurentAchievementCount[o] / t.subCategoriesAchievementCount[o]);
    }
    n ? t.categoriesTotalPercentage[n] = t.categoriesTotalCurrentAchievementCount[n] / t.categoriesTotalAchievementCount[n] : t.categoriesTotalPercentage[o] = t.categoriesTotalCurrentAchievementCount[o] / t.categoriesTotalAchievementCount[o];
    e.parentCategoryID = n;
    e.id === l.ALBUERA_VILLAGE_ACHIEVEMENT && u.sendTagAlbueraVillageDiscovered();
    e.id === l.ALBUERA_FOREST_ACHIEVEMENT && u.sendTagAlbueraForestDiscovered();
    e.id === l.ALBUERA_DUNGEON_ACHIEVEMENT && u.sendTagAlbueraDungeonDone();
    e.id === l.ASTRUB_ACHIEVEMENT && (d.landedAstrub(), u.sendTagLandedAstrub());
    t.emit("achievementFinished", e);
  });
  e.on("AchievementRewardSuccessMessage", function (e) {
    delete t.rewardableAchievements[e.achievementId];
    t.emit("achievementRewardSuccess", e.achievementId);
  });
  r.getAllDataBulk("AchievementCategories", function (e, i) {
    return e ? console.error("AchievementCategories error", e) : (t.achievementCategories = i, void i.forEach(function (e) {
      var i = e.achievementIds.length;
      0 === e.parentId ? i > 0 && (t.categoriesTotalAchievementCount[e.id] ? t.categoriesTotalAchievementCount[e.id] += i : t.categoriesTotalAchievementCount[e.id] = i, t.categoriesAchievementCount[e.id] = i, t.categories[e.id] = e.achievementIds) : (t.categoriesTotal[e.parentId] ? t.categoriesTotal[e.parentId].push(e.id) : t.categoriesTotal[e.parentId] = [e.id], t.categoriesTotalAchievementCount[e.parentId] ? t.categoriesTotalAchievementCount[e.parentId] += i : t.categoriesTotalAchievementCount[e.parentId] = i, t.subCategoriesAchievementCount[e.id] = i, t.subCategories[e.id] = e.achievementIds);
    }));
  });
};
n.prototype.getCategoryPercentage = function (e) {
  var t = this,
    i = this.categoriesTotal[e];
  this.categoriesTotalCurrentAchievementCount[e] = 0;
  i && i.forEach(function (i) {
    var n = t.subCategories[i];
    t.subCategoriesCurentAchievementCount[i] = 0;
    n ? (n.forEach(function (n) {
      t.finishedAchievementsIds.indexOf(n) !== -1 && (t.subCategoriesCurentAchievementCount[i]++, t.categoriesTotalCurrentAchievementCount[e]++);
    }), t.subCategoriesPercentage[i] = t.subCategoriesCurentAchievementCount[i] / t.subCategoriesAchievementCount[i]) : console.error("getCategoryPercentage : Cannot get sub category ID ", i);
  });
  var n = this.categories[e];
  this.categoriesCurrentAchievementCount[e] = 0;
  n && (n.forEach(function (i) {
    t.finishedAchievementsIds.indexOf(i) !== -1 && (t.categoriesCurrentAchievementCount[e]++, t.categoriesTotalCurrentAchievementCount[e]++);
  }), this.categoriesPercentage[e] = this.categoriesCurrentAchievementCount[e] / this.categoriesAchievementCount[e]);
  this.categoriesTotalPercentage[e] = this.categoriesTotalCurrentAchievementCount[e] / this.categoriesTotalAchievementCount[e];
};
n.prototype.getAchievementKamasReward = function (e, t, i) {
  if (!e) {
    return 0;
  }
  var n = e.kamasScaleWithPlayerLevel ? i : t;
  return Math.floor((Math.pow(n, 2) + 20 * n - 20) * e.kamasRatio);
};
n.prototype.getAchievementExperienceReward = function (e, t, i) {
  if (!e) {
    return 0;
  }
  var n = e.experienceRatio,
    o = window.gui.playerData.experienceFactor;
  return c.calculateAchievementXp(n, t, i, o);
};
n.prototype.completedData = function (e) {
  var t = this.finishedAchievementsIds.indexOf(e) !== -1,
    i = this.rewardableAchievements[e],
    n = this.accountAchievementsIds.indexOf(e) !== -1,
    o = {
      isAccountCompleted: n,
      isCompleted: t && !i,
      finishedlevel: null
    };
  if (o.isCompleted) {
    return o;
  }
  var a = this.rewardableAchievements;
  for (var s in a) {
    if (a.hasOwnProperty(s)) {
      var r = a[s];
      if (r.id === e) {
        o.isCompleted = !0;
        o.finishedlevel = r.finishedlevel;
        break;
      }
    }
  }
  return o;
};
n.prototype.getAchievementPercent = function () {
  return 0 === this.maximumNumberOfAchievements ? 0 : Math.round(this.finishedAchievementsIds.length / this.maximumNumberOfAchievements * 100);
};
this.finishedAchievementsIds = [];
this.accountAchievementsIds = [];
this.rewardableAchievements = {};
this.points = 0;
this.categoriesPercentage = {};
this.categoriesCurrentAchievementCount = {};
this.categoriesTotalPercentage = {};
this.categoriesTotalCurrentAchievementCount = {};
this.subCategoriesPercentage = {};
this.subCategoriesCurentAchievementCount = {};
e.on("AchievementListMessage", function (e) {
  var i = e.enrichData.points;
  e.enrichData.achievementsTotal && (t.maximumNumberOfAchievements = e.enrichData.achievementsTotal);
  t.finishedAchievementsIds = e.finishedAchievementsIds;
  for (var n = 0; n < e.rewardableAchievements.length; n++) {
    t.finishedAchievementsIds.push(e.rewardableAchievements[n].id);
    t.rewardableAchievements[e.rewardableAchievements[n].id] = e.rewardableAchievements[n];
  }
  for (var o = 0; o < e.accountAchievements.length; o++) {
    e.accountAchievements[o].isFirstForAccount || t.accountAchievementsIds.push(e.accountAchievements[o].id);
  }
  t.points = i;
  t.emit("achievementListUpdated", e);
});
e.on("AchievementFinishedMessage", function (e) {
  window.gui.chat.logMsg(s("ui.achievement.achievementUnlockWithLink", e.id));
  var i = e.enrichData.points;
  t.finishedAchievementsIds.push(e.id);
  t.rewardableAchievements[e.id] = e;
  t.points += i;
  var n = null,
    o = e.enrichData.categoryID;
  if (t.categories[o]) {
    t.categoriesTotalCurrentAchievementCount[o]++;
    t.categoriesCurrentAchievementCount[o]++;
    t.categoriesPercentage[o] = t.categoriesCurrentAchievementCount[o] / t.categoriesAchievementCount[o];
  } else {
    for (var a in t.categoriesTotal) {
      if (t.categoriesTotal.hasOwnProperty(a) && t.categoriesTotal[a].indexOf(o) !== -1) {
        n = a;
        break;
      }
    }
    n && (t.categoriesTotalCurrentAchievementCount[n]++, t.subCategoriesCurentAchievementCount[o]++, t.subCategoriesPercentage[o] = t.subCategoriesCurentAchievementCount[o] / t.subCategoriesAchievementCount[o]);
  }
  n ? t.categoriesTotalPercentage[n] = t.categoriesTotalCurrentAchievementCount[n] / t.categoriesTotalAchievementCount[n] : t.categoriesTotalPercentage[o] = t.categoriesTotalCurrentAchievementCount[o] / t.categoriesTotalAchievementCount[o];
  e.parentCategoryID = n;
  e.id === l.ALBUERA_VILLAGE_ACHIEVEMENT && u.sendTagAlbueraVillageDiscovered();
  e.id === l.ALBUERA_FOREST_ACHIEVEMENT && u.sendTagAlbueraForestDiscovered();
  e.id === l.ALBUERA_DUNGEON_ACHIEVEMENT && u.sendTagAlbueraDungeonDone();
  e.id === l.ASTRUB_ACHIEVEMENT && (d.landedAstrub(), u.sendTagLandedAstrub());
  t.emit("achievementFinished", e);
});
e.on("AchievementRewardSuccessMessage", function (e) {
  delete t.rewardableAchievements[e.achievementId];
  t.emit("achievementRewardSuccess", e.achievementId);
});
r.getAllDataBulk("AchievementCategories", function (e, i) {
  return e ? console.error("AchievementCategories error", e) : (t.achievementCategories = i, void i.forEach(function (e) {
    var i = e.achievementIds.length;
    0 === e.parentId ? i > 0 && (t.categoriesTotalAchievementCount[e.id] ? t.categoriesTotalAchievementCount[e.id] += i : t.categoriesTotalAchievementCount[e.id] = i, t.categoriesAchievementCount[e.id] = i, t.categories[e.id] = e.achievementIds) : (t.categoriesTotal[e.parentId] ? t.categoriesTotal[e.parentId].push(e.id) : t.categoriesTotal[e.parentId] = [e.id], t.categoriesTotalAchievementCount[e.parentId] ? t.categoriesTotalAchievementCount[e.parentId] += i : t.categoriesTotalAchievementCount[e.parentId] = i, t.subCategoriesAchievementCount[e.id] = i, t.subCategories[e.id] = e.achievementIds);
  }));
});
e.enrichData.achievementsTotal && (t.maximumNumberOfAchievements = e.enrichData.achievementsTotal);
t.finishedAchievementsIds = e.finishedAchievementsIds;
t.finishedAchievementsIds.push(e.rewardableAchievements[n].id);
t.rewardableAchievements[e.rewardableAchievements[n].id] = e.rewardableAchievements[n];
t.points = i;
t.emit("achievementListUpdated", e);
t.finishedAchievementsIds.push(e.id);
t.rewardableAchievements[e.id] = e;
t.points += i;
t.categoriesTotalCurrentAchievementCount[o]++;
t.categoriesCurrentAchievementCount[o]++;
t.categoriesPercentage[o] = t.categoriesCurrentAchievementCount[o] / t.categoriesAchievementCount[o];
n ? t.categoriesTotalPercentage[n] = t.categoriesTotalCurrentAchievementCount[n] / t.categoriesTotalAchievementCount[n] : t.categoriesTotalPercentage[o] = t.categoriesTotalCurrentAchievementCount[o] / t.categoriesTotalAchievementCount[o];
e.parentCategoryID = n;
e.id === l.ALBUERA_VILLAGE_ACHIEVEMENT && u.sendTagAlbueraVillageDiscovered();
e.id === l.ALBUERA_FOREST_ACHIEVEMENT && u.sendTagAlbueraForestDiscovered();
e.id === l.ALBUERA_DUNGEON_ACHIEVEMENT && u.sendTagAlbueraDungeonDone();
e.id === l.ASTRUB_ACHIEVEMENT && (d.landedAstrub(), u.sendTagLandedAstrub());
t.emit("achievementFinished", e);
delete t.rewardableAchievements[e.achievementId];
t.emit("achievementRewardSuccess", e.achievementId);
this.categoriesTotalCurrentAchievementCount[e] = 0;
i && i.forEach(function (i) {
  var n = t.subCategories[i];
  t.subCategoriesCurentAchievementCount[i] = 0;
  n ? (n.forEach(function (n) {
    t.finishedAchievementsIds.indexOf(n) !== -1 && (t.subCategoriesCurentAchievementCount[i]++, t.categoriesTotalCurrentAchievementCount[e]++);
  }), t.subCategoriesPercentage[i] = t.subCategoriesCurentAchievementCount[i] / t.subCategoriesAchievementCount[i]) : console.error("getCategoryPercentage : Cannot get sub category ID ", i);
});
t.subCategoriesCurentAchievementCount[i] = 0;
n ? (n.forEach(function (n) {
  t.finishedAchievementsIds.indexOf(n) !== -1 && (t.subCategoriesCurentAchievementCount[i]++, t.categoriesTotalCurrentAchievementCount[e]++);
}), t.subCategoriesPercentage[i] = t.subCategoriesCurentAchievementCount[i] / t.subCategoriesAchievementCount[i]) : console.error("getCategoryPercentage : Cannot get sub category ID ", i);
this.categoriesCurrentAchievementCount[e] = 0;
n && (n.forEach(function (i) {
  t.finishedAchievementsIds.indexOf(i) !== -1 && (t.categoriesCurrentAchievementCount[e]++, t.categoriesTotalCurrentAchievementCount[e]++);
}), this.categoriesPercentage[e] = this.categoriesCurrentAchievementCount[e] / this.categoriesAchievementCount[e]);
this.categoriesTotalPercentage[e] = this.categoriesTotalCurrentAchievementCount[e] / this.categoriesTotalAchievementCount[e];
o.isCompleted = !0;
o.finishedlevel = r.finishedlevel;
t.calculateStepXpRatio = function (e, t, i) {
  var n = e.duration * e.xpRatio,
    a = 1 + i / 100,
    s = o(e.optimalLevel, t);
  return Math.floor(Math.floor(s * n) * a);
};
t.calculateAchievementXp = function (e, t, i, n) {
  var a = 1 + n / 100,
    s = o(t, i);
  return Math.floor(Math.floor(s * e) * a);
};
o.call(this);
this._reset();
a(n, o);
e.exports = n;
n.prototype.disconnect = function () {
  this._reset();
};
n.prototype._reset = function () {
  this.mapId = 0;
  this.subAreaId = 0;
  this.worldmapId = 0;
  this.mapPosition = null;
  this.subArea = null;
  this.area = null;
  this.superArea = null;
  this.coordinates = {
    posX: 0,
    posY: 0
  };
  this.isInMyHouse = !1;
  this.currentMapHouses = {};
};
n.prototype.initialize = function (e) {
  function t(e) {
    o.currentMapHouses = {};
    o.emit("mapChanged", e);
  }
  function i(t, i) {
    o.mapId = t.mapId;
    s.getObject("MapPositions", t.mapId, function (n, a) {
      if (n) {
        return console.error("MapPositions missing or error", t.mapId, n);
      }
      o.mapPosition = a;
      var l = i ? i.worldX : a.posX,
        c = i ? i.worldY : a.posY;
      return o.coordinates.posX = l, o.coordinates.posY = c, o.subArea && o.subArea.id === t.subAreaId && o.subAreaId === t.subAreaId ? (o.emit("mapUpdate"), void r.mapChange(o.subArea.ambientSounds, a.sounds)) : (o.subAreaId = t.subAreaId, void s.getData("SubAreas", o.subAreaId, function (t, i) {
        if (t) {
          return console.warn("SubAreas error", t);
        }
        r.mapChange(i.ambientSounds, a.sounds);
        o.subArea = i;
        o.area = e.databases.Areas[i.areaId];
        o.superArea = e.databases.SuperAreas[o.area.superAreaId];
        var n = a.worldMap >= 0 ? a.worldMap : o.superArea.worldmapId;
        o.worldmapId !== n && (o.worldmapId = n, o.emit("worldMapUpdate"));
        o.emit("mapUpdate");
      }));
    });
  }
  function n(e) {
    var t = e.currentHouse;
    if (t) {
      if (t.displayedName = t.ownerName, "?" !== t.ownerName && "" !== t.ownerName) {
        var i = new l(c, t.ownerName);
        t.displayedName = i.getForDisplay();
      }
      var n = window.gui.playerData;
      o.isInMyHouse = t.ownerId === n.identification.accountId;
      o.emit("myHouseNotification", {
        isInMyHouse: o.isInMyHouse,
        msg: e
      });
    } else {
      !t && o.isInMyHouse && (o.isInMyHouse = !1, o.emit("myHouseNotification", {
        isInMyHouse: o.isInMyHouse
      }));
    }
  }
  var o = this;
  e.on("mapComplementaryInformationsData", function (e) {
    t(e);
    "MapComplementaryInformationsWithCoordsMessage" === e._messageType ? i(e, {
      worldX: e.worldX,
      worldY: e.worldY
    }) : "MapComplementaryInformationsDataInHouseMessage" === e._messageType ? i(e, e.currentHouse) : i(e);
    n(e);
  });
  e.on("HousePropertiesMessage", function (e) {
    var t = e.properties;
    if (t) {
      if (t._displayedName = t.ownerName, "?" !== t.ownerName && "" !== t.ownerName) {
        var i = new l(c, t.ownerName);
        t._displayedName = i.getForDisplay();
      }
      var n = t.houseId;
      o.currentMapHouses[n] = t;
    }
  });
};
n.prototype.getHousePropertiesById = function (e) {
  return this.currentMapHouses[e];
};
n.prototype.isInIncarnam = function () {
  return this.area ? this.area.id === d : (console.warn("isInIncarnam called before we know our area"), !1);
};
this.mapId = 0;
this.subAreaId = 0;
this.worldmapId = 0;
this.mapPosition = null;
this.subArea = null;
this.area = null;
this.superArea = null;
this.coordinates = {
  posX: 0,
  posY: 0
};
this.isInMyHouse = !1;
this.currentMapHouses = {};
o.currentMapHouses = {};
o.emit("mapChanged", e);
o.mapId = t.mapId;
s.getObject("MapPositions", t.mapId, function (n, a) {
  if (n) {
    return console.error("MapPositions missing or error", t.mapId, n);
  }
  o.mapPosition = a;
  var l = i ? i.worldX : a.posX,
    c = i ? i.worldY : a.posY;
  return o.coordinates.posX = l, o.coordinates.posY = c, o.subArea && o.subArea.id === t.subAreaId && o.subAreaId === t.subAreaId ? (o.emit("mapUpdate"), void r.mapChange(o.subArea.ambientSounds, a.sounds)) : (o.subAreaId = t.subAreaId, void s.getData("SubAreas", o.subAreaId, function (t, i) {
    if (t) {
      return console.warn("SubAreas error", t);
    }
    r.mapChange(i.ambientSounds, a.sounds);
    o.subArea = i;
    o.area = e.databases.Areas[i.areaId];
    o.superArea = e.databases.SuperAreas[o.area.superAreaId];
    var n = a.worldMap >= 0 ? a.worldMap : o.superArea.worldmapId;
    o.worldmapId !== n && (o.worldmapId = n, o.emit("worldMapUpdate"));
    o.emit("mapUpdate");
  }));
});
r.mapChange(i.ambientSounds, a.sounds);
o.subArea = i;
o.area = e.databases.Areas[i.areaId];
o.superArea = e.databases.SuperAreas[o.area.superAreaId];
o.worldmapId !== n && (o.worldmapId = n, o.emit("worldMapUpdate"));
o.emit("mapUpdate");
o.isInMyHouse = t.ownerId === n.identification.accountId;
o.emit("myHouseNotification", {
  isInMyHouse: o.isInMyHouse,
  msg: e
});
e.on("mapComplementaryInformationsData", function (e) {
  t(e);
  "MapComplementaryInformationsWithCoordsMessage" === e._messageType ? i(e, {
    worldX: e.worldX,
    worldY: e.worldY
  }) : "MapComplementaryInformationsDataInHouseMessage" === e._messageType ? i(e, e.currentHouse) : i(e);
  n(e);
});
e.on("HousePropertiesMessage", function (e) {
  var t = e.properties;
  if (t) {
    if (t._displayedName = t.ownerName, "?" !== t.ownerName && "" !== t.ownerName) {
      var i = new l(c, t.ownerName);
      t._displayedName = i.getForDisplay();
    }
    var n = t.houseId;
    o.currentMapHouses[n] = t;
  }
});
t(e);
"MapComplementaryInformationsWithCoordsMessage" === e._messageType ? i(e, {
  worldX: e.worldX,
  worldY: e.worldY
}) : "MapComplementaryInformationsDataInHouseMessage" === e._messageType ? i(e, e.currentHouse) : i(e);
n(e);
a.call(this);
this._pastParties = null;
this._dangerSetting = !0;
this._reset();
this._partyId = t;
this._partyType = e;
this._leaderId = i;
this._myCharacterId = n;
this._timeWhenDisconnected = 0;
this._inviterName = null;
this._members = {};
this._guests = {};
this._pastMembers = {};
s(n, a);
e.exports = n;
n.NUM_SLOTS_ARENA = u.MAX_MEMBERS_PER_ARENA_PARTY;
n.NUM_SLOTS_CLASSIC = u.MAX_MEMBERS_PER_PARTY;
n.prototype._reset = function () {
  this._partyFromId = {};
  this._dangerSetting = !0;
  this.arenaStats = {};
  this.arenaRegistered = !1;
  this.arenaStep = h.ARENA_STEP_UNREGISTER;
  this._followedCharacterId = 0;
  this._partyFights = {};
};
n.prototype.connect = function () {
  null === this._pastParties && this._reloadRecentParties();
  this._tryToRejoin(window.gui.playerData.id);
};
n.prototype.disconnect = function () {
  for (var e in this._partyFromId) {
    this._archiveParty(this._partyFromId[e]);
  }
  this._reset();
};
n.prototype.getDangerDisplay = function () {
  return this._dangerSetting;
};
n.prototype.toggleDangerDisplay = function () {
  this._dangerSetting = !this._dangerSetting;
};
o.unserializeFrom = function (e) {
  var t = new o(e._partyType, e._partyId, e._leaderId, e._myCharacterId);
  return t._timeWhenDisconnected = e._timeWhenDisconnected, t._members = e._members, t._guests = e._guests, t._pastMembers = e._pastMembers, t;
};
o.prototype._purgeExpiredPastMembers = function () {
  for (var e in this._pastMembers) {
    var t = this._pastMembers[e];
    Date.now() - t._timeWhenLeft > _ && delete this._pastMembers[e];
  }
};
o.prototype.getPartyId = function () {
  return this._partyId;
};
o.prototype.getLeaderId = function () {
  return this._leaderId;
};
o.prototype.getMember = function (e) {
  return this._members[e];
};
o.prototype.getMembers = function () {
  return this._members;
};
o.prototype.getGuest = function (e) {
  return this._guests[e];
};
o.prototype.getSlotCount = function () {
  return this._partyType === g ? n.NUM_SLOTS_ARENA : n.NUM_SLOTS_CLASSIC;
};
o.prototype.getFreeSlotCount = function () {
  return this.getSlotCount() - this.getMemberCount() - this.getGuestCount();
};
o.prototype.getGuestCount = function () {
  return Object.keys(this._guests).length;
};
o.prototype.getMemberCount = function () {
  return Object.keys(this._members).length + 1;
};
o.prototype.getMembersTotalLevel = function () {
  var e = window.gui.playerData.characterBaseInformations.level;
  for (var t in this._members) {
    this._members.hasOwnProperty(t) && (e += this._members[t].level);
  }
  return e;
};
o.prototype.getMembersLevelAverage = function () {
  return this.getMembersTotalLevel() / this.getMemberCount();
};
o.prototype._addMember = function (e, t, i) {
  e !== this._myCharacterId && (this._members[e] = {
    name: t,
    level: i
  }, this._pastMembers[e] && delete this._pastMembers[e]);
};
o.prototype._removeMember = function (e, t) {
  this._purgeExpiredPastMembers();
  var i = this._members[e];
  i && (t || (this._pastMembers[e] = i, i._timeWhenLeft = Date.now()), delete this._members[e]);
};
o.prototype._addGuest = function (e) {
  this._guests[e.guestId] = {
    hostId: e.hostId,
    guestName: e.name,
    guestId: e.guestId
  };
};
o.prototype._removeGuest = function (e) {
  delete this._guests[e];
};
n.prototype._joinParty = function (e, t, i, n, a) {
  var s = new o(e, t, a, window.gui.playerData.id);
  this._partyFromId[t] = s;
  for (var r = 0; r < i.length; r += 1) {
    var l = i[r];
    s._addMember(l.id, l.name, l.level);
  }
  for (r = 0; r < n.length; r++) {
    s._addGuest(n[r]);
  }
  e === g && this.emit("arenaJoined");
  this._rememberRecentParties(v);
};
n.prototype._leaveParty = function (e, t, i) {
  var n = this._partyFromId[e];
  n && (this.emit("playerLeavingParty", e, t), i && this._archiveParty(n), delete this._partyFromId[e], this.emit("playerLeftParty", e, t), this._rememberRecentParties());
};
n.prototype._updatePartyLeader = function (e, t) {
  var i = this._partyFromId[e];
  i && (this.emit("partyLeaderUpdate", e, t), i._partyType === g && this.emit("arenaLeaderUpdate", t), i._leaderId = t);
};
n.prototype._getPartyFromType = function (e) {
  for (var t in this._partyFromId) {
    var i = this._partyFromId[t];
    if (i._partyType === e) {
      return i;
    }
  }
  return null;
};
n.prototype.getClassicalParty = function () {
  return this._getPartyFromType(f);
};
n.prototype.getArenaParty = function () {
  return this._getPartyFromType(g);
};
n.prototype.getMemberName = function (e) {
  var t = window.gui.playerData;
  if (e === t.id) {
    return t.characterBaseInformations.name;
  }
  for (var i in this._partyFromId) {
    var n = this._partyFromId[i],
      o = n._members[e];
    if (o) {
      return o.name;
    }
  }
  return "?";
};
n.prototype._addPartyGuest = function (e, t) {
  var i = this._partyFromId[e];
  i && (i._addGuest(t), this.emit("partyNewGuest", e, t));
};
n.prototype._removePartyGuest = function (e, t, i) {
  var n = this._partyFromId[e];
  n && (this.emit("partyGuestLeaving", e, t, i), n._removeGuest(t));
};
n.prototype._addPartyMember = function (e, t) {
  var i = this._partyFromId[e];
  i && (i._removeGuest(t.id), i._addMember(t.id, t.name, t.level), i._partyType === g && this.emit("arenaNewMember", t), this.emit("partyNewMember", e, t), this._rememberRecentParties());
};
n.prototype._removePartyMember = function (e, t, i) {
  var n = this._partyFromId[e];
  n && (this.emit("partyMemberLeaving", e, t, i), n._partyType === g && this.emit("arenaMemberLeaving", t), n._removeMember(t, !!i), this._rememberRecentParties());
};
n.prototype.getGuestName = function (e, t) {
  var i = this._partyFromId[e];
  if (!i) {
    return "?";
  }
  var n = i._guests[t];
  return n ? n.guestName : "?";
};
n.prototype._enrichGuestInfo = function (e) {
  e.isGuest = !0;
  e.level = "?";
  e.id = e.guestId;
  e.entityLook = e.guestLook;
};
n.prototype.getFollowedCharacterId = function () {
  return this._followedCharacterId;
};
n.prototype.initialize = function (e) {
  var t = this,
    i = window.dofus.connectionManager;
  i.on("PartyInvitationMessage", function (i) {
    t._handleRequestedInvitation(i.partyType, i.partyId, i.fromName) || e.party.showPartyInvitationQuestion(i.partyType, i.partyId, i.fromName);
  });
  e.on("PartyInvitationDetailsMessage", function (e) {
    for (var i = 0; i < e.guests.length; i++) {
      t._enrichGuestInfo(e.guests[i]);
    }
    t.emit("partyInvitationDetails", e);
  });
  e.on("PartyNewGuestMessage", function (e) {
    t._enrichGuestInfo(e.guest);
    t._addPartyGuest(e.partyId, e.guest);
  });
  e.on("PartyNewMemberMessage", function (e) {
    t._addPartyMember(e.partyId, e.memberInformations);
  });
  e.on("PartyUpdateMessage", function (e) {
    t.emit("partyUpdateMember", e.partyId, e.memberInformations);
  });
  i.on("PartyDeletedMessage", function (e) {
    t._leaveParty(e.partyId, 0, !0);
  });
  i.on("PartyLeaveMessage", function (e) {
    t._leaveParty(e.partyId, 0);
  });
  i.on("PartyKickedByMessage", function (e) {
    t._leaveParty(e.partyId, e.kickerId);
  });
  i.on("PartyCancelInvitationNotificationMessage", function (e) {
    t._removePartyGuest(e.partyId, e.guestId, e.cancelerId);
  });
  i.on("PartyInvitationCancelledForGuestMessage", function (e) {
    t.emit("partyInvitationCancelled", e.partyId, e.cancelerId);
  });
  e.on("PartyJoinMessage", function (e) {
    t._joinParty(e.partyType, e.partyId, e.members, e.guests, e.partyLeaderId);
  });
  i.on("PartyMemberRemoveMessage", function (e) {
    t._removePartyMember(e.partyId, e.leavingPlayerId);
  });
  i.on("PartyMemberEjectedMessage", function (e) {
    t._removePartyMember(e.partyId, e.leavingPlayerId, e.kickerId);
  });
  i.on("PartyLeaderUpdateMessage", function (e) {
    t._updatePartyLeader(e.partyId, e.partyLeaderId);
  });
  i.on("PartyRefuseInvitationNotificationMessage", function (e) {
    t._removePartyGuest(e.partyId, e.guestId);
  });
  e.on("PartyFollowStatusUpdateMessage", function (e) {
    e.success && (t._followedCharacterId = e.followedId);
  });
  e.on("GameRolePlayArenaRegistrationStatusMessage", function (e) {
    t.arenaStep = e.step;
    t.arenaRegistered = e.registered;
    1 !== e.step || e.registered || (t.nbArenaFigthersReady = 0);
    t.emit("arenaRegistrationStatus");
  });
  e.on("GameFightJoinMessage", function (e) {
    e.fightType !== d.FIGHT_TYPE_PVP_ARENA || e.isSpectator || (t.arenaStep = h.ARENA_STEP_STARTING_FIGHT, t.arenaRegistered = !1, t.emit("arenaRegistrationStatus"));
    t._cleanPartyFightNotifications();
  });
  e.on("GameFightEndMessage", function (e) {
    t.arenaStep === h.ARENA_STEP_STARTING_FIGHT && (t.arenaStep = h.ARENA_STEP_UNREGISTER, t.emit("arenaRegistrationStatus"), t.emit("arenaFightEnd"), window.gui.playerData.evaluateRatingOpening("arenaFightWin", {
      fighters: e.results
    }));
  });
  e.on("GameRolePlayArenaUpdatePlayerInfosMessage", function (e) {
    t.arenaStats = {
      rank: e.rank,
      bestDailyRank: e.bestDailyRank,
      bestRank: e.bestRank,
      victoryCount: e.victoryCount,
      arenaFightCount: e.arenaFightcount
    };
    t.emit("arenaStatsUpdated");
  });
  e.on("GameRolePlayArenaFighterStatusMessage", function (e) {
    e.accepted ? (t.nbArenaFigthersReady++, t.emit("arenaFighterReady", t.nbArenaFigthersReady)) : t.emit("arenaFightDeclined", e.fightId, e.playerId);
  });
  e.on("PartyCannotJoinErrorMessage", function (e) {
    var t;
    switch (e.reason) {
      case l.PARTY_JOIN_ERROR_UNKNOWN:
        t = r("ui.party.cantInvit");
        break;
      case l.PARTY_JOIN_ERROR_PLAYER_NOT_FOUND:
        break;
      case l.PARTY_JOIN_ERROR_PARTY_NOT_FOUND:
        t = r("ui.party.cantFindParty");
        break;
      case l.PARTY_JOIN_ERROR_PARTY_FULL:
        t = r("ui.party.partyFull");
        break;
      case l.PARTY_JOIN_ERROR_PLAYER_BUSY:
        t = r("ui.party.cantInvitPlayerBusy");
        break;
      case l.PARTY_JOIN_ERROR_PLAYER_ALREADY_INVITED:
        t = r("ui.party.playerAlreayBeingInvited");
        break;
      case l.PARTY_JOIN_ERROR_PLAYER_TOO_SOLLICITED:
        t = r("ui.party.playerTooSollicited");
        break;
      case l.PARTY_JOIN_ERROR_UNMODIFIABLE:
        t = r("ui.party.partyUnmodifiable");
        break;
      case l.PARTY_JOIN_ERROR_UNMET_CRITERION:
      case l.PARTY_JOIN_ERROR_PLAYER_LOYAL:
    }
    t && this.openSimplePopup(t);
  });
  e.on("PartyMemberInFightMessage", function (i) {
    var n = e.playerData.isFighting && !e.playerData.isSpectator;
    if (!n) {
      var o,
        a = i.fightMap.mapId;
      switch (i.reason) {
        case p.FIGHT_REASON_MONSTER_ATTACK:
          o = r("ui.party.memberStartFight.monsterAttack", i.memberName, i.memberId, a);
          break;
        case p.FIGHT_REASON_PLAYER_ATTACK:
          o = r("ui.party.memberStartFight.playerAttack", i.memberName, i.memberId, a);
          break;
        case p.FIGHT_REASON_MEMBER_ATTACKED_PLAYERS:
          o = r("ui.party.memberStartFight.attackPlayer", i.memberName, i.memberId, a);
          break;
        default:
          o = r("ui.party.memberStartFight.unknownReason", i.memberName, i.memberId, a);
      }
      e.chat.logMsg(o);
      var s = i.secondsBeforeFightStart;
      if (t._addFightInfo(a, i.fightId, i.memberId, i.memberName, s), e.playerData.position.mapId === a) {
        var l = i.memberId;
        e.party.showPartyFightQuestion(i.fightId, l, i.memberId, i.memberName, s);
      }
    }
  });
  e.on("GameRolePlayRemoveChallengeMessage", function (i) {
    e.party.removePartyFightQuestion(i.fightId);
    t._deleteFightInfo(e.playerData.position.mapId, i.fightId);
  });
  e.on("mapComplementaryInformationsData", function (i) {
    t._cleanPartyFightNotifications();
    var n = t._partyFights[i.mapId];
    if (n) {
      for (var o = i.fights, a = 0; a < o.length; a++) {
        var s = n[o[a].fightId];
        if (s) {
          var r = s.memberId;
          e.party.showPartyFightQuestion(s.fightId, r, s.memberId, s.memberName, s.startTime - Date.now());
        }
      }
    }
  });
};
n.prototype._addFightInfo = function (e, t, i, n, o) {
  var a = this._partyFights[e];
  a || (a = this._partyFights[e] = {});
  a[t] = {
    fightId: t,
    memberId: i,
    memberName: n,
    startTime: Date.now() + o
  };
  var s = this;
  window.setTimeout(function () {
    s._deleteFightInfo(e, t);
  }, o);
};
n.prototype._deleteFightInfo = function (e, t) {
  var i = this._partyFights[e];
  i && (delete i[t], 0 === Object.keys(i).length && delete this._partyFights[e]);
};
n.prototype._cleanPartyFightNotifications = function () {
  for (var e in this._partyFights) {
    var t = this._partyFights[e];
    for (var i in t) {
      window.gui.party.removePartyFightQuestion(i);
    }
  }
};
n.prototype._archiveParty = function (e) {
  e._timeWhenDisconnected = Date.now();
  this._pastParties[e._partyId] = e;
};
n.prototype._purgeExpiredPastParties = function () {
  var e,
    t = {};
  for (var i in this._pastParties) {
    e = this._pastParties[i];
    t[e._partyType] = Math.max(t[e._partyType] || 0, e._timeWhenDisconnected);
    Date.now() - e._timeWhenDisconnected > _ && delete this._pastParties[i];
  }
  for (i in this._pastParties) {
    e = this._pastParties[i];
    e._timeWhenDisconnected < t[e._partyType] && delete this._pastParties[i];
  }
};
n.prototype._rememberRecentParties = function (e) {
  var t = {};
  for (var i in this._partyFromId) {
    t[i] = this._partyFromId[i];
  }
  this._purgeExpiredPastParties();
  for (i in this._pastParties) {
    t[i] = this._pastParties[i];
  }
  m.setValue("recentParties", t, e);
};
n.prototype._reloadRecentParties = function () {
  var e = m.getValue("recentParties", {});
  this._pastParties = {};
  for (var t in e) {
    var i = o.unserializeFrom(e[t]);
    this._pastParties[t] = i;
    i._timeWhenDisconnected || (i._timeWhenDisconnected = Date.now());
  }
};
n.prototype._tryToRejoin = function (e) {
  this._purgeExpiredPastParties();
  for (var t in this._pastParties) {
    var i = this._pastParties[t];
    if (!i._inviterName && e === i._myCharacterId) {
      var n = [];
      for (var o in i._members) {
        n.push(i._members[o].name);
      }
      i._purgeExpiredPastMembers();
      for (o in i._pastMembers) {
        n.push(i._pastMembers[o].name);
      }
      if (n.length) {
        var a = i._members[i._leaderId] || i._pastMembers[i._leaderId];
        a && (n.splice(n.indexOf(a.name), 1), n.unshift(a.name));
        this._findOnlineInviter(i, n);
      }
    }
  }
};
n.prototype._findOnlineInviter = function (e, t) {
  var i = this;
  window.gui.chat.p2p.checkPlayerOnline(t[0], function (n, o) {
    return o ? (e._inviterName = n, window.gui.chat.p2p.sendMsg(n, "rejoinRequest", e._partyId)) : (t.shift(), t.length ? i._findOnlineInviter(e, t) : void 0);
  });
};
n.prototype.handleRejoinRequest = function (e, t) {
  var i, n;
  this._purgeExpiredPastParties();
  var o = this._partyFromId[e];
  if (o) {
    if (n = o._partyType, o._purgeExpiredPastMembers(), i = o._pastMembers[t], !i) {
      return;
    }
    if (0 === o.getFreeSlotCount()) {
      return;
    }
  } else {
    var a = this._pastParties[e];
    if (!a) {
      return;
    }
    if (a._purgeExpiredPastMembers(), i = a._members[t] || a._pastMembers[t], !i) {
      return;
    }
    if (n = a._partyType, this._getPartyFromType(n)) {
      return;
    }
  }
  var s = n === g ? "PartyInvitationArenaRequestMessage" : "PartyInvitationRequestMessage";
  window.dofus.sendMessage(s, {
    name: i.name
  });
};
n.prototype._handleRequestedInvitation = function (e, t, i) {
  this._purgeExpiredPastParties();
  var n = this._pastParties[t];
  if (!n) {
    var o = !1;
    for (var a in this._pastParties) {
      var s = this._pastParties[a];
      if (s._partyType === e && s._inviterName === i) {
        o = !0;
        break;
      }
    }
    if (!o) {
      return !1;
    }
  }
  return window.dofus.sendMessage("PartyAcceptInvitationMessage", {
    partyId: t
  }), !0;
};
this._partyFromId = {};
this._dangerSetting = !0;
this.arenaStats = {};
this.arenaRegistered = !1;
this.arenaStep = h.ARENA_STEP_UNREGISTER;
this._followedCharacterId = 0;
this._partyFights = {};
null === this._pastParties && this._reloadRecentParties();
this._tryToRejoin(window.gui.playerData.id);
e === g && this.emit("arenaJoined");
this._rememberRecentParties(v);
e.isGuest = !0;
e.level = "?";
e.id = e.guestId;
e.entityLook = e.guestLook;
i.on("PartyInvitationMessage", function (i) {
  t._handleRequestedInvitation(i.partyType, i.partyId, i.fromName) || e.party.showPartyInvitationQuestion(i.partyType, i.partyId, i.fromName);
});
e.on("PartyInvitationDetailsMessage", function (e) {
  for (var i = 0; i < e.guests.length; i++) {
    t._enrichGuestInfo(e.guests[i]);
  }
  t.emit("partyInvitationDetails", e);
});
e.on("PartyNewGuestMessage", function (e) {
  t._enrichGuestInfo(e.guest);
  t._addPartyGuest(e.partyId, e.guest);
});
e.on("PartyNewMemberMessage", function (e) {
  t._addPartyMember(e.partyId, e.memberInformations);
});
e.on("PartyUpdateMessage", function (e) {
  t.emit("partyUpdateMember", e.partyId, e.memberInformations);
});
i.on("PartyDeletedMessage", function (e) {
  t._leaveParty(e.partyId, 0, !0);
});
i.on("PartyLeaveMessage", function (e) {
  t._leaveParty(e.partyId, 0);
});
i.on("PartyKickedByMessage", function (e) {
  t._leaveParty(e.partyId, e.kickerId);
});
i.on("PartyCancelInvitationNotificationMessage", function (e) {
  t._removePartyGuest(e.partyId, e.guestId, e.cancelerId);
});
i.on("PartyInvitationCancelledForGuestMessage", function (e) {
  t.emit("partyInvitationCancelled", e.partyId, e.cancelerId);
});
e.on("PartyJoinMessage", function (e) {
  t._joinParty(e.partyType, e.partyId, e.members, e.guests, e.partyLeaderId);
});
i.on("PartyMemberRemoveMessage", function (e) {
  t._removePartyMember(e.partyId, e.leavingPlayerId);
});
i.on("PartyMemberEjectedMessage", function (e) {
  t._removePartyMember(e.partyId, e.leavingPlayerId, e.kickerId);
});
i.on("PartyLeaderUpdateMessage", function (e) {
  t._updatePartyLeader(e.partyId, e.partyLeaderId);
});
i.on("PartyRefuseInvitationNotificationMessage", function (e) {
  t._removePartyGuest(e.partyId, e.guestId);
});
e.on("PartyFollowStatusUpdateMessage", function (e) {
  e.success && (t._followedCharacterId = e.followedId);
});
e.on("GameRolePlayArenaRegistrationStatusMessage", function (e) {
  t.arenaStep = e.step;
  t.arenaRegistered = e.registered;
  1 !== e.step || e.registered || (t.nbArenaFigthersReady = 0);
  t.emit("arenaRegistrationStatus");
});
e.on("GameFightJoinMessage", function (e) {
  e.fightType !== d.FIGHT_TYPE_PVP_ARENA || e.isSpectator || (t.arenaStep = h.ARENA_STEP_STARTING_FIGHT, t.arenaRegistered = !1, t.emit("arenaRegistrationStatus"));
  t._cleanPartyFightNotifications();
});
e.on("GameFightEndMessage", function (e) {
  t.arenaStep === h.ARENA_STEP_STARTING_FIGHT && (t.arenaStep = h.ARENA_STEP_UNREGISTER, t.emit("arenaRegistrationStatus"), t.emit("arenaFightEnd"), window.gui.playerData.evaluateRatingOpening("arenaFightWin", {
    fighters: e.results
  }));
});
e.on("GameRolePlayArenaUpdatePlayerInfosMessage", function (e) {
  t.arenaStats = {
    rank: e.rank,
    bestDailyRank: e.bestDailyRank,
    bestRank: e.bestRank,
    victoryCount: e.victoryCount,
    arenaFightCount: e.arenaFightcount
  };
  t.emit("arenaStatsUpdated");
});
e.on("GameRolePlayArenaFighterStatusMessage", function (e) {
  e.accepted ? (t.nbArenaFigthersReady++, t.emit("arenaFighterReady", t.nbArenaFigthersReady)) : t.emit("arenaFightDeclined", e.fightId, e.playerId);
});
e.on("PartyCannotJoinErrorMessage", function (e) {
  var t;
  switch (e.reason) {
    case l.PARTY_JOIN_ERROR_UNKNOWN:
      t = r("ui.party.cantInvit");
      break;
    case l.PARTY_JOIN_ERROR_PLAYER_NOT_FOUND:
      break;
    case l.PARTY_JOIN_ERROR_PARTY_NOT_FOUND:
      t = r("ui.party.cantFindParty");
      break;
    case l.PARTY_JOIN_ERROR_PARTY_FULL:
      t = r("ui.party.partyFull");
      break;
    case l.PARTY_JOIN_ERROR_PLAYER_BUSY:
      t = r("ui.party.cantInvitPlayerBusy");
      break;
    case l.PARTY_JOIN_ERROR_PLAYER_ALREADY_INVITED:
      t = r("ui.party.playerAlreayBeingInvited");
      break;
    case l.PARTY_JOIN_ERROR_PLAYER_TOO_SOLLICITED:
      t = r("ui.party.playerTooSollicited");
      break;
    case l.PARTY_JOIN_ERROR_UNMODIFIABLE:
      t = r("ui.party.partyUnmodifiable");
      break;
    case l.PARTY_JOIN_ERROR_UNMET_CRITERION:
    case l.PARTY_JOIN_ERROR_PLAYER_LOYAL:
  }
  t && this.openSimplePopup(t);
});
e.on("PartyMemberInFightMessage", function (i) {
  var n = e.playerData.isFighting && !e.playerData.isSpectator;
  if (!n) {
    var o,
      a = i.fightMap.mapId;
    switch (i.reason) {
      case p.FIGHT_REASON_MONSTER_ATTACK:
        o = r("ui.party.memberStartFight.monsterAttack", i.memberName, i.memberId, a);
        break;
      case p.FIGHT_REASON_PLAYER_ATTACK:
        o = r("ui.party.memberStartFight.playerAttack", i.memberName, i.memberId, a);
        break;
      case p.FIGHT_REASON_MEMBER_ATTACKED_PLAYERS:
        o = r("ui.party.memberStartFight.attackPlayer", i.memberName, i.memberId, a);
        break;
      default:
        o = r("ui.party.memberStartFight.unknownReason", i.memberName, i.memberId, a);
    }
    e.chat.logMsg(o);
    var s = i.secondsBeforeFightStart;
    if (t._addFightInfo(a, i.fightId, i.memberId, i.memberName, s), e.playerData.position.mapId === a) {
      var l = i.memberId;
      e.party.showPartyFightQuestion(i.fightId, l, i.memberId, i.memberName, s);
    }
  }
});
e.on("GameRolePlayRemoveChallengeMessage", function (i) {
  e.party.removePartyFightQuestion(i.fightId);
  t._deleteFightInfo(e.playerData.position.mapId, i.fightId);
});
e.on("mapComplementaryInformationsData", function (i) {
  t._cleanPartyFightNotifications();
  var n = t._partyFights[i.mapId];
  if (n) {
    for (var o = i.fights, a = 0; a < o.length; a++) {
      var s = n[o[a].fightId];
      if (s) {
        var r = s.memberId;
        e.party.showPartyFightQuestion(s.fightId, r, s.memberId, s.memberName, s.startTime - Date.now());
      }
    }
  }
});
t._enrichGuestInfo(e.guest);
t._addPartyGuest(e.partyId, e.guest);
t.arenaStep = e.step;
t.arenaRegistered = e.registered;
1 !== e.step || e.registered || (t.nbArenaFigthersReady = 0);
t.emit("arenaRegistrationStatus");
e.fightType !== d.FIGHT_TYPE_PVP_ARENA || e.isSpectator || (t.arenaStep = h.ARENA_STEP_STARTING_FIGHT, t.arenaRegistered = !1, t.emit("arenaRegistrationStatus"));
t._cleanPartyFightNotifications();
t.arenaStats = {
  rank: e.rank,
  bestDailyRank: e.bestDailyRank,
  bestRank: e.bestRank,
  victoryCount: e.victoryCount,
  arenaFightCount: e.arenaFightcount
};
t.emit("arenaStatsUpdated");
e.party.removePartyFightQuestion(i.fightId);
t._deleteFightInfo(e.playerData.position.mapId, i.fightId);
a || (a = this._partyFights[e] = {});
a[t] = {
  fightId: t,
  memberId: i,
  memberName: n,
  startTime: Date.now() + o
};
e._timeWhenDisconnected = Date.now();
this._pastParties[e._partyId] = e;
e = this._pastParties[i];
t[e._partyType] = Math.max(t[e._partyType] || 0, e._timeWhenDisconnected);
Date.now() - e._timeWhenDisconnected > _ && delete this._pastParties[i];
e = this._pastParties[i];
e._timeWhenDisconnected < t[e._partyType] && delete this._pastParties[i];
this._pastParties[t] = i;
i._timeWhenDisconnected || (i._timeWhenDisconnected = Date.now());
a && (n.splice(n.indexOf(a.name), 1), n.unshift(a.name));
this._findOnlineInviter(i, n);
r.call(this);
this._reset();
d(a, r);
e.exports = a;
a.prototype._reset = function () {
  this.finished = {};
  this.startable = {};
  this.active = {};
  this.all = {};
  this.dailyQuests = {};
  this.dailyQuests.finished = {};
  this.dailyQuests.active = {};
  this.dailyQuests.all = {};
  this.dailyQuests.mainQuest = {};
  this.initialized = !1;
};
a.prototype.connect = function (e) {
  return e ? window.connectionManager.once("GameFightStartingMessage", function () {
    window.dofus.sendMessage("QuestListRequestMessage");
  }) : void window.dofus.sendMessage("QuestListRequestMessage");
};
a.prototype.disconnect = function () {
  this._reset();
};
a.prototype.rerollDQ = function (e) {
  window.dofus.sendMessage("RerollDailyQuestRequestMessage", {
    questId: e
  });
  this._pendingOldDaily = e;
};
a.prototype.getDQClassName = function (e) {
  return p[e] ? p[e].categoryClassName : "";
};
a.prototype.isRareDQ = function (e) {
  return !!p[e] && p[e].isRare;
};
a.prototype.getQuestIdfromObjectiveId = function (e) {
  function t(t) {
    return t.objectiveId === e;
  }
  for (var i = Object.getOwnPropertyNames(this.active), n = 0; n < i.length; n++) {
    var o = this.active[i[n]];
    if (o.objectives.find(t)) {
      return o.questId;
    }
  }
  return 0;
};
a.prototype.getDqQuestIdfromObjectiveId = function (e) {
  function t(t) {
    return t.objectiveId === e;
  }
  for (var i = Object.getOwnPropertyNames(this.dailyQuests.active), n = 0; n < i.length; n++) {
    var o = this.dailyQuests.active[i[n]];
    if (o.objectives.find(t)) {
      return o.questId;
    }
  }
  return 0;
};
a.prototype.getCurrentCompletion = function (e, t) {
  if (!this.dailyQuests.active[e] && !this.active[e]) {
    return "";
  }
  for (var i = this.dailyQuests.active[e] ? this.dailyQuests.active[e] : this.active[e], n = 0; n < i.objectives.length; n++) {
    if (i.objectives[n].objectiveId === t) {
      return !i.objectives[n].maxCompletion || i.objectives[n].maxCompletion < 2 ? "" : " (" + i.objectives[n].curCompletion + "/" + i.objectives[n].maxCompletion + ")";
    }
  }
  return "";
};
a.prototype.initialize = function () {
  var e = this;
  h.on("QuestListMessage", function (t) {
    e._reset();
    s.parallel([function (i) {
      e.startable = {};
      for (var n in t.startableQuestsIds) {
        t.startableQuestsIds.hasOwnProperty(n) && (e.startable[t.startableQuestsIds[n]] = !0);
      }
      i();
    }, function (i) {
      c.createFinishedQuestsMap(t.finishedQuestsIds, t.finishedQuestsCounts, function (t, n) {
        if (t) {
          return i(t);
        }
        for (var o in n) {
          o === f ? e.dailyQuests.mainQuest = n[o] : n[o].dbQuest.repeatType === m ? e.dailyQuests.finished[o] = e.dailyQuests.all[o] = n[o] : e.finished[o] = e.all[o] = n[o];
        }
        i();
      });
    }, function (i) {
      c.initializeActiveQuests(t.activeQuests, function (t, n) {
        if (t) {
          return i(t);
        }
        for (var o in n) {
          n[o].questId === f ? e.dailyQuests.mainQuest = n[o] : n[o].dbQuest.repeatType === m ? e.dailyQuests.active[o] = e.dailyQuests.all[o] = n[o] : e.active[o] = e.all[o] = n[o];
        }
        i();
      });
    }], function (t) {
      return t ? console.error(t) : (e.initialized = !0, void e.emit("listUpdated"));
    });
  });
  h.on("QuestStartedMessage", function (t) {
    delete e.finished[t.questId];
    delete e.dailyQuests.finished[t.questId];
    window.dofus.sendMessage("QuestStepInfoRequestMessage", {
      questId: t.questId
    });
  });
  h.on("QuestsUpdatedMessage", function (t) {
    t.quests.forEach(function (t) {
      u.push(function (i) {
        var n;
        if (n = t.questId === f ? e.dailyQuests.mainQuest : e.active[t.questId] || e.dailyQuests.active[t.questId], !n) {
          return i(new Error("QuestsUpdatedMessage: quest gone for " + t.questId));
        }
        if (t.stepId !== n.stepId) {
          return i(new Error("QuestsUpdatedMessage: not the same stepId " + t.stepId + " on quest " + t.questId));
        }
        for (var o = 0, a = t.objectives.length; o < a; o += 1) {
          for (var s = t.objectives[o], r = 0; r < n.objectives.length; r += 1) {
            var l = n.objectives[r];
            l.objectiveId === s.objectiveId && (l.curCompletion = s.curCompletion, e.emit("questUpdate", t.questId));
          }
        }
        i();
      });
    });
  });
  h.on("QuestObjectiveValidatedMessage", function (t) {
    u.push(function (i) {
      var n = e.active[t.questId];
      if (!n) {
        return i(new Error("QuestObjectiveValidatedMessage: quest gone for " + t.questId));
      }
      window.dofus.sendMessage("QuestStepInfoRequestMessage", {
        questId: n.questId
      });
      for (var a = 0, s = n.objectives.length; a < s; a += 1) {
        var r = n.objectives[a];
        if (r.objectiveId === t.objectiveId) {
          return r.objectiveStatus = !1, e.emit("objectiveValidated", n, t.objectiveId), o(window.gui.chat, n, !!e.dailyQuests.all[n.questId], e, !0), e.emit("questUpdate", t.questId), i();
        }
      }
      i();
    });
  });
  h.on("QuestStepInfoMessage", function (t) {
    u.push(function (i) {
      if (!t.infos.objectives) {
        return i();
      }
      var n = t.infos;
      if (!n) {
        return i();
      }
      var a = n.questId,
        s = e.active[a] || n;
      s.stepId = n.stepId;
      s.objectives = n.objectives;
      var r;
      s.dbQuest ? c.updateQuestObjectives(s, function (t) {
        return t ? i(t) : (e.emit("questUpdate", s.questId), void i());
      }) : c.initializeActiveQuests([s], function (t, n) {
        return t ? i(t) : (r = n[a].dbQuest.repeatType === m ? e.dailyQuests : e, a === f ? (e.dailyQuests.mainQuest = n[a], e.emit("mainDQStarted", a)) : n[a].dbQuest.repeatType === m ? (e.dailyQuests.active[a] = e.dailyQuests.all[a] = n[a], e.emit("DQStarted", a), e._pendingDailyQuest === a && (delete e.dailyQuests.all[e._pendingOldDaily], delete e.dailyQuests.active[e._pendingOldDaily], e.emit("rerollDQ", {
          oldDQId: e._pendingOldDaily,
          newDQId: a
        }), e._pendingOldDaily = 0, e._pendingDailyQuest = 0)) : (e.active[a] = e.all[a] = n[a], e.emit("questStarted", a)), o(window.gui.chat, s, !!e.dailyQuests.all[a], r), void i());
      });
    });
  });
  h.on("RerollDailyQuestNotificationMessage", function (t) {
    e._pendingDailyQuest = t.questId;
  });
  h.on("RerollDailyQuestErrorMessage", function () {
    e._pendingOldDaily = 0;
    e._pendingDailyQuest = 0;
    e.emit("rerollDQFailed");
  });
  h.on("QuestStepStartedMessage", function (t) {
    var i = e.active[t.questId];
    return i ? (i.stepId = t.stepId, o(window.gui.chat, i, !!e.dailyQuests.all[i.questId], e, !0), void window.dofus.sendMessage("QuestStepInfoRequestMessage", {
      questId: i.questId
    })) : void console.error(new Error("QuestStepStartedMessage: quest gone for " + t.questId));
  });
  h.on("QuestStepValidatedMessage", function (t) {
    var i = e.active[t.questId];
    if (!i) {
      return void console.error(new Error("QuestStepValidatedMessage: quest gone for " + t.questId));
    }
    n(window.gui.chat, i, t.stepId, window.gui.playerData.characterBaseInformations.level);
    o(window.gui.chat, i, !!e.dailyQuests.all[t.questId], e, !0);
    var a = i.dbQuest.stepIds,
      s = a.indexOf(t.stepId);
    i.stepId = a[s + 1];
    e.emit("stepValidated", i, t.stepId);
    window.dofus.sendMessage("QuestStepInfoRequestMessage", {
      questId: i.questId
    });
  });
  h.on("QuestValidatedMessage", function (t) {
    u.push(function (i) {
      var a,
        s = window.gui.playerData.characterBaseInformations.level;
      if (t.questId === f) {
        return a = e.dailyQuests, a.mainQuest.finishedCount = 1, e.emit("DQFinished", t.questId), n(window.gui.chat, a.mainQuest, -1, s), o(window.gui.chat, a.mainQuest, !!e.dailyQuests.all[t.questId], a), i();
      }
      e.dailyQuests.all[t.questId] ? (a = e.dailyQuests, e.emit("DQFinished", t.questId)) : t.questId !== f && (e.emit("QuestFinished", t.questId), a = e);
      var r = a.active[t.questId];
      return delete a.active[t.questId], r || t.questId === f ? (a.finished[t.questId] = a.all[t.questId] = r, r.finishedCount = 1, n(window.gui.chat, r, r.stepId, s), o(window.gui.chat, r, !!e.dailyQuests.all[t.questId], a), e.emit("questFinished", r), void i()) : i(new Error("QuestValidatedMessage: quest gone for " + t.questId));
    });
  });
};
this.finished = {};
this.startable = {};
this.active = {};
this.all = {};
this.dailyQuests = {};
this.dailyQuests.finished = {};
this.dailyQuests.active = {};
this.dailyQuests.all = {};
this.dailyQuests.mainQuest = {};
this.initialized = !1;
window.dofus.sendMessage("RerollDailyQuestRequestMessage", {
  questId: e
});
this._pendingOldDaily = e;
h.on("QuestListMessage", function (t) {
  e._reset();
  s.parallel([function (i) {
    e.startable = {};
    for (var n in t.startableQuestsIds) {
      t.startableQuestsIds.hasOwnProperty(n) && (e.startable[t.startableQuestsIds[n]] = !0);
    }
    i();
  }, function (i) {
    c.createFinishedQuestsMap(t.finishedQuestsIds, t.finishedQuestsCounts, function (t, n) {
      if (t) {
        return i(t);
      }
      for (var o in n) {
        o === f ? e.dailyQuests.mainQuest = n[o] : n[o].dbQuest.repeatType === m ? e.dailyQuests.finished[o] = e.dailyQuests.all[o] = n[o] : e.finished[o] = e.all[o] = n[o];
      }
      i();
    });
  }, function (i) {
    c.initializeActiveQuests(t.activeQuests, function (t, n) {
      if (t) {
        return i(t);
      }
      for (var o in n) {
        n[o].questId === f ? e.dailyQuests.mainQuest = n[o] : n[o].dbQuest.repeatType === m ? e.dailyQuests.active[o] = e.dailyQuests.all[o] = n[o] : e.active[o] = e.all[o] = n[o];
      }
      i();
    });
  }], function (t) {
    return t ? console.error(t) : (e.initialized = !0, void e.emit("listUpdated"));
  });
});
h.on("QuestStartedMessage", function (t) {
  delete e.finished[t.questId];
  delete e.dailyQuests.finished[t.questId];
  window.dofus.sendMessage("QuestStepInfoRequestMessage", {
    questId: t.questId
  });
});
h.on("QuestsUpdatedMessage", function (t) {
  t.quests.forEach(function (t) {
    u.push(function (i) {
      var n;
      if (n = t.questId === f ? e.dailyQuests.mainQuest : e.active[t.questId] || e.dailyQuests.active[t.questId], !n) {
        return i(new Error("QuestsUpdatedMessage: quest gone for " + t.questId));
      }
      if (t.stepId !== n.stepId) {
        return i(new Error("QuestsUpdatedMessage: not the same stepId " + t.stepId + " on quest " + t.questId));
      }
      for (var o = 0, a = t.objectives.length; o < a; o += 1) {
        for (var s = t.objectives[o], r = 0; r < n.objectives.length; r += 1) {
          var l = n.objectives[r];
          l.objectiveId === s.objectiveId && (l.curCompletion = s.curCompletion, e.emit("questUpdate", t.questId));
        }
      }
      i();
    });
  });
});
h.on("QuestObjectiveValidatedMessage", function (t) {
  u.push(function (i) {
    var n = e.active[t.questId];
    if (!n) {
      return i(new Error("QuestObjectiveValidatedMessage: quest gone for " + t.questId));
    }
    window.dofus.sendMessage("QuestStepInfoRequestMessage", {
      questId: n.questId
    });
    for (var a = 0, s = n.objectives.length; a < s; a += 1) {
      var r = n.objectives[a];
      if (r.objectiveId === t.objectiveId) {
        return r.objectiveStatus = !1, e.emit("objectiveValidated", n, t.objectiveId), o(window.gui.chat, n, !!e.dailyQuests.all[n.questId], e, !0), e.emit("questUpdate", t.questId), i();
      }
    }
    i();
  });
});
h.on("QuestStepInfoMessage", function (t) {
  u.push(function (i) {
    if (!t.infos.objectives) {
      return i();
    }
    var n = t.infos;
    if (!n) {
      return i();
    }
    var a = n.questId,
      s = e.active[a] || n;
    s.stepId = n.stepId;
    s.objectives = n.objectives;
    var r;
    s.dbQuest ? c.updateQuestObjectives(s, function (t) {
      return t ? i(t) : (e.emit("questUpdate", s.questId), void i());
    }) : c.initializeActiveQuests([s], function (t, n) {
      return t ? i(t) : (r = n[a].dbQuest.repeatType === m ? e.dailyQuests : e, a === f ? (e.dailyQuests.mainQuest = n[a], e.emit("mainDQStarted", a)) : n[a].dbQuest.repeatType === m ? (e.dailyQuests.active[a] = e.dailyQuests.all[a] = n[a], e.emit("DQStarted", a), e._pendingDailyQuest === a && (delete e.dailyQuests.all[e._pendingOldDaily], delete e.dailyQuests.active[e._pendingOldDaily], e.emit("rerollDQ", {
        oldDQId: e._pendingOldDaily,
        newDQId: a
      }), e._pendingOldDaily = 0, e._pendingDailyQuest = 0)) : (e.active[a] = e.all[a] = n[a], e.emit("questStarted", a)), o(window.gui.chat, s, !!e.dailyQuests.all[a], r), void i());
    });
  });
});
h.on("RerollDailyQuestNotificationMessage", function (t) {
  e._pendingDailyQuest = t.questId;
});
h.on("RerollDailyQuestErrorMessage", function () {
  e._pendingOldDaily = 0;
  e._pendingDailyQuest = 0;
  e.emit("rerollDQFailed");
});
h.on("QuestStepStartedMessage", function (t) {
  var i = e.active[t.questId];
  return i ? (i.stepId = t.stepId, o(window.gui.chat, i, !!e.dailyQuests.all[i.questId], e, !0), void window.dofus.sendMessage("QuestStepInfoRequestMessage", {
    questId: i.questId
  })) : void console.error(new Error("QuestStepStartedMessage: quest gone for " + t.questId));
});
h.on("QuestStepValidatedMessage", function (t) {
  var i = e.active[t.questId];
  if (!i) {
    return void console.error(new Error("QuestStepValidatedMessage: quest gone for " + t.questId));
  }
  n(window.gui.chat, i, t.stepId, window.gui.playerData.characterBaseInformations.level);
  o(window.gui.chat, i, !!e.dailyQuests.all[t.questId], e, !0);
  var a = i.dbQuest.stepIds,
    s = a.indexOf(t.stepId);
  i.stepId = a[s + 1];
  e.emit("stepValidated", i, t.stepId);
  window.dofus.sendMessage("QuestStepInfoRequestMessage", {
    questId: i.questId
  });
});
h.on("QuestValidatedMessage", function (t) {
  u.push(function (i) {
    var a,
      s = window.gui.playerData.characterBaseInformations.level;
    if (t.questId === f) {
      return a = e.dailyQuests, a.mainQuest.finishedCount = 1, e.emit("DQFinished", t.questId), n(window.gui.chat, a.mainQuest, -1, s), o(window.gui.chat, a.mainQuest, !!e.dailyQuests.all[t.questId], a), i();
    }
    e.dailyQuests.all[t.questId] ? (a = e.dailyQuests, e.emit("DQFinished", t.questId)) : t.questId !== f && (e.emit("QuestFinished", t.questId), a = e);
    var r = a.active[t.questId];
    return delete a.active[t.questId], r || t.questId === f ? (a.finished[t.questId] = a.all[t.questId] = r, r.finishedCount = 1, n(window.gui.chat, r, r.stepId, s), o(window.gui.chat, r, !!e.dailyQuests.all[t.questId], a), e.emit("questFinished", r), void i()) : i(new Error("QuestValidatedMessage: quest gone for " + t.questId));
  });
});
e._reset();
s.parallel([function (i) {
  e.startable = {};
  for (var n in t.startableQuestsIds) {
    t.startableQuestsIds.hasOwnProperty(n) && (e.startable[t.startableQuestsIds[n]] = !0);
  }
  i();
}, function (i) {
  c.createFinishedQuestsMap(t.finishedQuestsIds, t.finishedQuestsCounts, function (t, n) {
    if (t) {
      return i(t);
    }
    for (var o in n) {
      o === f ? e.dailyQuests.mainQuest = n[o] : n[o].dbQuest.repeatType === m ? e.dailyQuests.finished[o] = e.dailyQuests.all[o] = n[o] : e.finished[o] = e.all[o] = n[o];
    }
    i();
  });
}, function (i) {
  c.initializeActiveQuests(t.activeQuests, function (t, n) {
    if (t) {
      return i(t);
    }
    for (var o in n) {
      n[o].questId === f ? e.dailyQuests.mainQuest = n[o] : n[o].dbQuest.repeatType === m ? e.dailyQuests.active[o] = e.dailyQuests.all[o] = n[o] : e.active[o] = e.all[o] = n[o];
    }
    i();
  });
}], function (t) {
  return t ? console.error(t) : (e.initialized = !0, void e.emit("listUpdated"));
});
delete e.finished[t.questId];
delete e.dailyQuests.finished[t.questId];
window.dofus.sendMessage("QuestStepInfoRequestMessage", {
  questId: t.questId
});
s.stepId = n.stepId;
s.objectives = n.objectives;
e._pendingOldDaily = 0;
e._pendingDailyQuest = 0;
e.emit("rerollDQFailed");
n(window.gui.chat, i, t.stepId, window.gui.playerData.characterBaseInformations.level);
o(window.gui.chat, i, !!e.dailyQuests.all[t.questId], e, !0);
i.stepId = a[s + 1];
e.emit("stepValidated", i, t.stepId);
window.dofus.sendMessage("QuestStepInfoRequestMessage", {
  questId: i.questId
});
e[n.id] || (e[n.id] = [], o[n.id] = n.type);
e[n.id].push(t[i]);
l || (u.error(new Error("ptop " + e + ": missing db for param " + s + " on id " + a.id)), l = {});
t[o] = l.nameId || "";
e[t] = o;
i(n);
e[t] = o;
i(n);
e.exports.updateQuestObjectives = function (e, t) {
  s([e], t);
};
e.exports.createFinishedQuestsMap = function (e, t, i) {
  var n = {};
  c.getDataMap("Quests", e, function (o, a) {
    if (o) {
      return i(o);
    }
    for (var s = 0, r = e.length; s < r; s += 1) {
      var l = e[s];
      n[l] = {
        questId: l,
        dbQuest: a[l],
        finishedCount: t[s]
      };
    }
    i(null, n);
  });
};
e.exports.initializeActiveQuests = function (e, t) {
  for (var i = [], n = {}, o = 0, a = e.length; o < a; o += 1) {
    var l = e[o];
    n[l.questId] = l;
    i.push(l.questId);
  }
  c.getDataMap("Quests", i, function (i, o) {
    if (i) {
      return t(i);
    }
    var a = [];
    for (var l in o) {
      if (o.hasOwnProperty(l)) {
        var u = o[l];
        n[l].dbQuest = u;
        a = a.concat(u.stepIds);
      }
    }
    c.getDataMap("QuestSteps", a, function (i, a) {
      if (i) {
        return t(i);
      }
      var l = [],
        u = [];
      for (var h in o) {
        if (o.hasOwnProperty(h)) {
          var p = n[h],
            m = p.dbQuest.stepIds;
          p.dbSteps = {};
          var f, g;
          for (f = 0, g = m.length; f < g; f += 1) {
            var _ = m[f],
              v = a[_];
            p.dbSteps[_] = v;
            l = l.concat(v.rewardsIds);
            u = u.concat(v.objectiveIds);
          }
        }
      }
      var y = [{
        ids: u,
        table: "QuestObjectives"
      }, {
        ids: l,
        table: "QuestStepRewards"
      }];
      r.each(y, function (e, t) {
        c.getDataMap(e.table, e.ids, function (i, n) {
          e.data = n;
          t(i);
        });
      }, function (i) {
        if (i) {
          return t(i);
        }
        for (var a in o) {
          if (o.hasOwnProperty(a)) {
            var r = n[a];
            r.dbObjectives = {};
            r.dbRewards = {};
            for (var l in r.dbSteps) {
              if (r.dbSteps.hasOwnProperty(l)) {
                var c,
                  u,
                  h,
                  p = r.dbSteps[l];
                for (c = 0, u = p.objectiveIds.length; c < u; c += 1) {
                  h = p.objectiveIds[c];
                  r.dbObjectives[h] = y[0].data[h];
                  0 === r.dbObjectives[h].mapId && (r.dbObjectives[h].mapId = d[h] || 0);
                }
                for (c = 0, u = p.rewardsIds.length; c < u; c += 1) {
                  h = p.rewardsIds[c];
                  r.dbRewards[h] = y[1].data[h];
                }
              }
            }
          }
        }
        s(e, function (e) {
          t(e, n);
        });
      });
    });
  });
};
n[l.questId] = l;
i.push(l.questId);
n[l].dbQuest = u;
a = a.concat(u.stepIds);
p.dbSteps[_] = v;
l = l.concat(v.rewardsIds);
u = u.concat(v.objectiveIds);
e.data = n;
t(i);
r.dbObjectives = {};
r.dbRewards = {};
h = p.objectiveIds[c];
r.dbObjectives[h] = y[0].data[h];
0 === r.dbObjectives[h].mapId && (r.dbObjectives[h].mapId = d[h] || 0);
h = p.rewardsIds[c];
r.dbRewards[h] = y[1].data[h];
l.call(this);
this.friendsList = {};
this.enemiesList = {};
this.ignoredList = {};
this.spouse = null;
this.onConnectNotification = !1;
c(n, l);
e.exports = n;
n.prototype.connect = function () {
  window.dofus.sendMessage("FriendsGetListMessage");
  window.dofus.sendMessage("IgnoredGetListMessage");
  window.dofus.sendMessage("SpouseGetInformationsMessage");
};
n.prototype.disconnect = function () {
  this.friendsList = {};
  this.enemiesList = {};
  this.ignoredList = {};
  this.spouse = null;
  this.onConnectNotification = !1;
};
n.prototype.initialize = function (e) {
  var t = this,
    i = {
      0: s("ui.common.unknownFail"),
      1: s("ui.social.friend.addFailureListFull"),
      2: s("ui.social.friend.addFailureNotFound"),
      3: s("ui.social.friend.addFailureEgocentric"),
      4: s("ui.social.friend.addFailureAlreadyInList")
    };
  a.on("PlayerStatusUpdateMessage", function (e) {
    t.friendsList[e.accountId] && (t.friendsList[e.accountId].status = e.status, t.emit("friendUpdate", t.friendsList[e.accountId]));
    t.enemiesList[e.accountId] && (t.enemiesList[e.accountId].status = e.status, t.emit("enemyUpdate", t.enemiesList[e.accountId]));
    t.ignoredList[e.accountId] && (t.ignoredList[e.accountId].status = e.status, t.emit("ignoredUpdate", t.ignoredList[e.accountId]));
  });
  e.on("FriendUpdateMessage", function (e) {
    t.friendsList[e.friendUpdated.accountId] = e.friendUpdated;
    t.emit("friendUpdate", e.friendUpdated);
    t.emit("enemyUpdate", e.friendUpdated);
    t.emit("ignoredUpdate", e.friendUpdated);
  });
  e.on("FriendsListMessage", function (e) {
    t.friendsList = o(e.friendsList);
    t.emit("newFriendList");
  });
  e.on("IgnoredListMessage", function (e) {
    t.enemiesList = o(e.ignoredList);
    t.emit("newEnemyList");
  });
  e.on("FriendAddedMessage", function (e) {
    t.friendsList[e.friendAdded.accountId] = e.friendAdded;
    d.trackAddFriend();
    t.emit("friendAdded", e.friendAdded);
  });
  e.on("IgnoredAddedMessage", function (e) {
    var i = e.session ? t.ignoredList : t.enemiesList;
    i[e.ignoreAdded.accountId] = e.ignoreAdded;
    t.emit(e.session ? "ignoredAdded" : "enemyAdded", e.ignoreAdded);
  });
  a.on("FriendDeleteResultMessage", function (i) {
    if (i.success) {
      e.chat.logError(s("ui.social.friend.delete"));
      for (var n in t.friendsList) {
        if (t.friendsList[n].uniqueNickname.toString() === i.name) {
          return delete t.friendsList[n], t.emit("friendDeleted", n);
        }
      }
    }
  });
  e.on("IgnoredDeleteResultMessage", function (e) {
    if (e.success) {
      var i = e.session ? t.ignoredList : t.enemiesList;
      for (var n in i) {
        if (i[n].uniqueNickname.toString() === e.name) {
          return delete i[n], t.emit(e.session ? "ignoredDeleted" : "enemyDeleted", n);
        }
      }
    }
  });
  a.on("FriendAddFailureMessage", function (t) {
    e.chat.logError(i[t.reason]);
  });
  a.on("IgnoredAddFailureMessage", function (t) {
    e.chat.logError(i[t.reason]);
  });
  e.on("FriendWarnOnConnectionStateMessage", function (e) {
    t.onConnectNotification = e.enable;
  });
  e.on("SpouseInformationsMessage", function (e) {
    var i = e.spouse;
    t.spouse = {
      spouseAccountId: i.spouseAccountId,
      spouseId: i.spouseId,
      spouseName: i.spouseName,
      spouseLevel: i.spouseLevel,
      breed: i.breed,
      sex: i.sex,
      spouseEntityLook: i.spouseEntityLook,
      guildInfo: i.guildInfo,
      alignmentSide: i.alignmentSide,
      mapId: i.mapId,
      subAreaId: i.subAreaId,
      inFight: i.inFight,
      followSpouse: i.followSpouse
    };
    t.emit("spouseUpdate", t.spouse);
  });
  e.on("SpouseStatusMessage", function (e) {
    t.spouse && e.hasSpouse === !1 && (t.spouse = null, t.emit("spouseLeft"));
  });
  e.on("MoodSmileyUpdateMessage", function (e) {
    var i = t.friendsList[e.accountId];
    i && (i.moodSmileyId = e.smileyId, t.emit("friendUpdate", i), t.emit("enemyUpdate", i), t.emit("ignoredUpdate", i));
  });
};
n.prototype.isIgnored = function (e) {
  return Boolean(this.ignoredList[e]);
};
n.prototype.isFriend = function (e) {
  for (var t in this.friendsList) {
    var i = this.friendsList[t];
    if (i.playerId === e) {
      return !0;
    }
  }
  return !1;
};
n.prototype.isSpouse = function (e) {
  return Boolean(this.spouse) && this.spouse.spouseId === e;
};
n.prototype.searchOnlineFriendById = function (e) {
  for (var t in this.friendsList) {
    var i = this.friendsList[t];
    if (i.playerId === e) {
      return i;
    }
  }
  return null;
};
n.prototype.searchOnlineFriendByName = function (e) {
  var t = r.simplifyString(e);
  for (var i in this.friendsList) {
    var n = this.friendsList[i];
    if (n.playerName && r.simplifyString(n.playerName) === t) {
      return n;
    }
  }
  return null;
};
n.prototype.isMutualFriend = function (e) {
  return e.level > 0;
};
window.dofus.sendMessage("FriendsGetListMessage");
window.dofus.sendMessage("IgnoredGetListMessage");
window.dofus.sendMessage("SpouseGetInformationsMessage");
this.friendsList = {};
this.enemiesList = {};
this.ignoredList = {};
this.spouse = null;
this.onConnectNotification = !1;
a.on("PlayerStatusUpdateMessage", function (e) {
  t.friendsList[e.accountId] && (t.friendsList[e.accountId].status = e.status, t.emit("friendUpdate", t.friendsList[e.accountId]));
  t.enemiesList[e.accountId] && (t.enemiesList[e.accountId].status = e.status, t.emit("enemyUpdate", t.enemiesList[e.accountId]));
  t.ignoredList[e.accountId] && (t.ignoredList[e.accountId].status = e.status, t.emit("ignoredUpdate", t.ignoredList[e.accountId]));
});
e.on("FriendUpdateMessage", function (e) {
  t.friendsList[e.friendUpdated.accountId] = e.friendUpdated;
  t.emit("friendUpdate", e.friendUpdated);
  t.emit("enemyUpdate", e.friendUpdated);
  t.emit("ignoredUpdate", e.friendUpdated);
});
e.on("FriendsListMessage", function (e) {
  t.friendsList = o(e.friendsList);
  t.emit("newFriendList");
});
e.on("IgnoredListMessage", function (e) {
  t.enemiesList = o(e.ignoredList);
  t.emit("newEnemyList");
});
e.on("FriendAddedMessage", function (e) {
  t.friendsList[e.friendAdded.accountId] = e.friendAdded;
  d.trackAddFriend();
  t.emit("friendAdded", e.friendAdded);
});
e.on("IgnoredAddedMessage", function (e) {
  var i = e.session ? t.ignoredList : t.enemiesList;
  i[e.ignoreAdded.accountId] = e.ignoreAdded;
  t.emit(e.session ? "ignoredAdded" : "enemyAdded", e.ignoreAdded);
});
a.on("FriendDeleteResultMessage", function (i) {
  if (i.success) {
    e.chat.logError(s("ui.social.friend.delete"));
    for (var n in t.friendsList) {
      if (t.friendsList[n].uniqueNickname.toString() === i.name) {
        return delete t.friendsList[n], t.emit("friendDeleted", n);
      }
    }
  }
});
e.on("IgnoredDeleteResultMessage", function (e) {
  if (e.success) {
    var i = e.session ? t.ignoredList : t.enemiesList;
    for (var n in i) {
      if (i[n].uniqueNickname.toString() === e.name) {
        return delete i[n], t.emit(e.session ? "ignoredDeleted" : "enemyDeleted", n);
      }
    }
  }
});
a.on("FriendAddFailureMessage", function (t) {
  e.chat.logError(i[t.reason]);
});
a.on("IgnoredAddFailureMessage", function (t) {
  e.chat.logError(i[t.reason]);
});
e.on("FriendWarnOnConnectionStateMessage", function (e) {
  t.onConnectNotification = e.enable;
});
e.on("SpouseInformationsMessage", function (e) {
  var i = e.spouse;
  t.spouse = {
    spouseAccountId: i.spouseAccountId,
    spouseId: i.spouseId,
    spouseName: i.spouseName,
    spouseLevel: i.spouseLevel,
    breed: i.breed,
    sex: i.sex,
    spouseEntityLook: i.spouseEntityLook,
    guildInfo: i.guildInfo,
    alignmentSide: i.alignmentSide,
    mapId: i.mapId,
    subAreaId: i.subAreaId,
    inFight: i.inFight,
    followSpouse: i.followSpouse
  };
  t.emit("spouseUpdate", t.spouse);
});
e.on("SpouseStatusMessage", function (e) {
  t.spouse && e.hasSpouse === !1 && (t.spouse = null, t.emit("spouseLeft"));
});
e.on("MoodSmileyUpdateMessage", function (e) {
  var i = t.friendsList[e.accountId];
  i && (i.moodSmileyId = e.smileyId, t.emit("friendUpdate", i), t.emit("enemyUpdate", i), t.emit("ignoredUpdate", i));
});
t.friendsList[e.accountId] && (t.friendsList[e.accountId].status = e.status, t.emit("friendUpdate", t.friendsList[e.accountId]));
t.enemiesList[e.accountId] && (t.enemiesList[e.accountId].status = e.status, t.emit("enemyUpdate", t.enemiesList[e.accountId]));
t.ignoredList[e.accountId] && (t.ignoredList[e.accountId].status = e.status, t.emit("ignoredUpdate", t.ignoredList[e.accountId]));
t.friendsList[e.friendUpdated.accountId] = e.friendUpdated;
t.emit("friendUpdate", e.friendUpdated);
t.emit("enemyUpdate", e.friendUpdated);
t.emit("ignoredUpdate", e.friendUpdated);
t.friendsList = o(e.friendsList);
t.emit("newFriendList");
t.enemiesList = o(e.ignoredList);
t.emit("newEnemyList");
t.friendsList[e.friendAdded.accountId] = e.friendAdded;
d.trackAddFriend();
t.emit("friendAdded", e.friendAdded);
i[e.ignoreAdded.accountId] = e.ignoreAdded;
t.emit(e.session ? "ignoredAdded" : "enemyAdded", e.ignoreAdded);
t.spouse = {
  spouseAccountId: i.spouseAccountId,
  spouseId: i.spouseId,
  spouseName: i.spouseName,
  spouseLevel: i.spouseLevel,
  breed: i.breed,
  sex: i.sex,
  spouseEntityLook: i.spouseEntityLook,
  guildInfo: i.guildInfo,
  alignmentSide: i.alignmentSide,
  mapId: i.mapId,
  subAreaId: i.subAreaId,
  inFight: i.inFight,
  followSpouse: i.followSpouse
};
t.emit("spouseUpdate", t.spouse);
this.alignmentInfos = null;
this.playerRank = null;
this.alignmentRank = null;
this.alignmentTitles = null;
this.alignmentRanks = null;
this._imagePaths = ["gfx/alignments/Alignement_tx_IllusNeutre.png", "gfx/alignments/Alignement_tx_IllusBontarien.png", "gfx/alignments/Alignement_tx_IllusBrakmarien.png", "gfx/alignments/Alignement_tx_IllusMercenaire.png"];
this._orderImagePaths = ["gfx/alignments/order_0.png", "gfx/alignments/order_1.png", "gfx/alignments/order_2.png", "gfx/alignments/order_3.png", "gfx/alignments/order_4.png", "gfx/alignments/order_5.png", "gfx/alignments/order_6.png", "gfx/alignments/order_7.png", "gfx/alignments/order_8.png", "gfx/alignments/order_9.png"];
this._sideImagePaths = {
  1: "gfx/alignments/wings/tx_alignment1_frame0.png",
  2: "gfx/alignments/wings/tx_alignment2_frame0.png"
};
a(n, o);
e.exports = n;
n.prototype.initialize = function (e) {
  var t = this;
  e.on("AlignmentRankUpdateMessage", function (e) {
    t.playerRank = e.alignmentRank;
    t.emit("alignmentChanged");
  });
  e.on("initialized", function () {
    var i = ["AlignmentTitles", "AlignmentRank"];
    s.getAllDataTable(i, function (e, i) {
      return e ? console.error("Unable to load data for alignment window", e) : (t.alignmentTitles = i.AlignmentTitles, void (t.alignmentRanks = i.AlignmentRank));
    });
    e.playerData.characters.on("specificCharacteristicsUpdated", function (i) {
      "alignmentInfos" === i && (t.alignmentInfos = e.playerData.characters.mainCharacter.characteristics.alignmentInfos, t.alignmentSide = e.databases.AlignmentSides[t.alignmentInfos.alignmentSide], t.emit("alignmentChanged"));
    });
  });
  var i = "gfx/alignments/wings.json";
  r.loadJson(i, function (e) {
    e.meta && e.symbols && (e = e.symbols);
    t._wingsData = e;
  });
};
n.prototype.getRank = function (e) {
  s.getData("AlignmentRank", this.playerRank, e);
};
n.prototype.getOrder = function (e, t) {
  s.getData("AlignmentOrder", e.orderId, t);
};
n.prototype.getAlignmentImageUrl = function (e) {
  this.alignmentInfos ? r.preloadImage(this._imagePaths[this.alignmentInfos.alignmentSide], e) : r.preloadImage(this._imagePaths[0], e);
};
n.prototype.getTopWings = function (e, t) {
  var i = this,
    n = e.alignmentSide,
    o = e.alignmentGrade,
    a = 10 * (n - 1) + o,
    s = "gfx/alignments/wings/demonAngel_frame" + a + ".png",
    r = i._wingsData[l].frames[a].position,
    c = {
      imagePath: s,
      left: r.x,
      top: r.y,
      width: r.w,
      height: r.h
    };
  t(c);
};
n.prototype.getBottomWings = function (e, t) {
  var i = this,
    n = e.alignmentSide,
    o = e.alignmentGrade,
    a = 10 * (n - 1) + o;
  if (i._wingsData[c].frames[a]) {
    var s = "gfx/alignments/wings/demonAngel2_frame" + a + ".png",
      r = i._wingsData[c].frames[a].position,
      l = {
        imagePath: s,
        left: r.x,
        top: r.h + r.y,
        width: r.w,
        height: r.h
      };
    return t(l);
  }
  return t(null);
};
n.prototype.getSmallWingsUrl = function (e, t) {
  var i = this._sideImagePaths[e];
  r.preloadImage(i, t);
};
n.prototype.getOrderImageUrl = function (e, t) {
  var i = this._orderImagePaths[e];
  r.preloadImage(i, t);
};
n.prototype.getAlignmentGradeString = function () {
  var e = this.alignmentInfos,
    t = e.alignmentGrade,
    i = e.alignmentSide,
    n = this.alignmentTitles;
  return t + " (" + n[i].namesId[t] + ")";
};
n.prototype.getHonor = function () {
  var e = this.alignmentInfos,
    t = (e.honor - e.honorGradeFloor) / (e.honorNextGradeFloor - e.honorGradeFloor);
  return t;
};
n.prototype.getNameId = function () {
  return this.alignmentSide.nameId;
};
e.on("AlignmentRankUpdateMessage", function (e) {
  t.playerRank = e.alignmentRank;
  t.emit("alignmentChanged");
});
e.on("initialized", function () {
  var i = ["AlignmentTitles", "AlignmentRank"];
  s.getAllDataTable(i, function (e, i) {
    return e ? console.error("Unable to load data for alignment window", e) : (t.alignmentTitles = i.AlignmentTitles, void (t.alignmentRanks = i.AlignmentRank));
  });
  e.playerData.characters.on("specificCharacteristicsUpdated", function (i) {
    "alignmentInfos" === i && (t.alignmentInfos = e.playerData.characters.mainCharacter.characteristics.alignmentInfos, t.alignmentSide = e.databases.AlignmentSides[t.alignmentInfos.alignmentSide], t.emit("alignmentChanged"));
  });
});
t.playerRank = e.alignmentRank;
t.emit("alignmentChanged");
s.getAllDataTable(i, function (e, i) {
  return e ? console.error("Unable to load data for alignment window", e) : (t.alignmentTitles = i.AlignmentTitles, void (t.alignmentRanks = i.AlignmentRank));
});
e.playerData.characters.on("specificCharacteristicsUpdated", function (i) {
  "alignmentInfos" === i && (t.alignmentInfos = e.playerData.characters.mainCharacter.characteristics.alignmentInfos, t.alignmentSide = e.databases.AlignmentSides[t.alignmentInfos.alignmentSide], t.emit("alignmentChanged"));
});
e.meta && e.symbols && (e = e.symbols);
t._wingsData = e;
this._adminMenuId = null;
this._myRank = null;
this._lang = null;
this._url = null;
this._isModerator = null;
this._isModeratorOrMore = null;
e.exports = n;
n.prototype.initialize = function (e) {
  e = e || {};
  this._initTheLang(e.lang);
};
n.prototype.connect = function (e) {
  e = e || {};
  this._initTheLang(e.lang);
};
n.prototype.disconnect = function () {
  this._adminMenuId = null;
  this._myRank = null;
  this._url = null;
  this._lang = null;
  this._isModeratorOrMore = null;
  this._isModerator = null;
};
n.prototype._initTheLang = function (e) {
  this._lang = e;
  this._lang || (this._lang = "fr", console.error("AdminMenu#initialize: lang is missing, fallback to fr."));
  c.indexOf(this._lang) === -1 && (console.warn("AdminMenu#initialize: lang", this._lang, "is not authorized, fallback to en."), this._lang = "en");
};
n.prototype.setAccountCapabilities = function (e) {
  e._url && (this._url = e._url);
  e._myModeratorRank && Array.isArray(e._myModeratorRank) && (this._myRank = e._myModeratorRank, this.setAdminMenuId(this._myRank[this._myRank.length - 1]));
  this._isModeratorOrMore = e.status >= l.MODERATOR;
  this._isModerator = e.status === l.MODERATOR;
  this._hasSpecialStartupCmds = e._hasSpecialStartupCmds;
};
n.prototype.runStartupCmd = function (e) {
  if (e = e || {}, this._isModerator) {
    var t;
    if (e.isOnCharacterSelection) {
      for (t = 0; t < s.length; t += 1) {
        o.getWindow("adminConsole").runCommand(s[t]);
      }
    }
    if (e.isOnRP) {
      for (t = 0; t < a.length; t += 1) {
        o.getWindow("adminConsole").runCommand(a[t]);
      }
    }
  }
  if (this._hasSpecialStartupCmds && e.isOnRP) {
    for (t = 0; t < r.length; t += 1) {
      o.getWindow("adminConsole").runCommand(r[t]);
    }
  }
};
n.prototype.getAdminMenuId = function () {
  var e = null,
    t = this._adminMenuId;
  return this._isModeratorOrMore && t && this.getURL() && (e = t), e;
};
n.prototype.getURL = function () {
  return this._url ? this._url + this._lang + "/" : null;
};
n.prototype.setAdminMenuId = function (e) {
  return !!this._canUse(e) && (this._adminMenuId = e, o.getWindow("adminConsole").logMessage('adminMenu "' + e + '" loaded.', "Debug"), !0);
};
n.prototype._canUse = function (e) {
  return !(null === this._myRank || !this.getURL()) && this._myRank.indexOf(e) !== -1;
};
n.prototype.helpToString = function () {
  var e = [];
  if (!Array.isArray(this._myRank)) {
    return e.join("\n");
  }
  for (var t = 0; t < this._myRank.length; t += 1) {
    var i = this._myRank[t];
    this._canUse(i) && e.push(i);
  }
  return e.join("\n");
};
e = e || {};
this._initTheLang(e.lang);
e = e || {};
this._initTheLang(e.lang);
this._adminMenuId = null;
this._myRank = null;
this._url = null;
this._lang = null;
this._isModeratorOrMore = null;
this._isModerator = null;
this._lang = e;
this._lang || (this._lang = "fr", console.error("AdminMenu#initialize: lang is missing, fallback to fr."));
c.indexOf(this._lang) === -1 && (console.warn("AdminMenu#initialize: lang", this._lang, "is not authorized, fallback to en."), this._lang = "en");
e._url && (this._url = e._url);
e._myModeratorRank && Array.isArray(e._myModeratorRank) && (this._myRank = e._myModeratorRank, this.setAdminMenuId(this._myRank[this._myRank.length - 1]));
this._isModeratorOrMore = e.status >= l.MODERATOR;
this._isModerator = e.status === l.MODERATOR;
this._hasSpecialStartupCmds = e._hasSpecialStartupCmds;
o.call(this);
this.current = {};
this.current.ladder = {};
this._reset();
a(n, o);
e.exports = n;
n.prototype.GENERAL_TAB_NAME = "general";
n.prototype.COMPOSITION_TAB_NAME = "composition";
n.prototype.LADDER_TAB_NAME = "ladder";
n.prototype._reset = function () {
  this.current = {};
  this.current.ladder = {};
  this._requestedSocialInfoMap = {};
  this._awaitedSocialInfoMap = {};
};
n.prototype.initialize = function (e) {
  this._setupListeners(e);
  this._setupTheRetryPopup(e);
};
n.prototype.disconnect = function () {
  this._reset();
};
n.prototype.isQuestAccomplished = function () {
  return !!window.gui.playerData.quests.finished[c.TOA_QUEST_ID];
};
n.prototype.canTabBeDisable = function (e) {
  var t = this.current.steps;
  return e !== this.GENERAL_TAB_NAME && e !== this.LADDER_TAB_NAME && (e !== this.COMPOSITION_TAB_NAME || !t);
};
n.prototype.gatheringCompositionData = function (e, t, i) {
  s.getDataMap("Monsters", e, function (e, n) {
    return e ? i(e) : void s.getDataMap("Challenge", t, function (e, t) {
      return e ? i(e) : i(null, n, t);
    });
  });
};
n.prototype.calculateMaxStageScore = function (e, t) {
  var i = h;
  e > 0 && e <= 50 ? i += p : e > 50 && e <= 100 && (i += m);
  50 === e ? i += f : 100 === e && (i += g);
  for (var n in t) {
    i += t[n].points;
  }
  return i;
};
n.prototype.getMonsterIds = function (e, t) {
  var i = this.current.steps,
    n = [];
  if (!e || !t) {
    return n;
  }
  for (var o = 0; o < i.length; o++) {
    if (i[o].stepNumber === t) {
      for (var a = 0; a < i[o].stages.length; a++) {
        if (i[o].stages[a].stageLevel === e) {
          for (var s = 0; s < i[o].stages[a].monsters.length; s++) {
            n.push(i[o].stages[a].monsters[s].creatureGenericId);
          }
          return n;
        }
      }
    }
  }
};
n.prototype.getChallengeIds = function (e, t) {
  if (!e || !t) {
    return [];
  }
  for (var i = this.current.steps, n = 0; n < i.length; n++) {
    if (i[n].stepNumber === t) {
      for (var o = 0; o < i[n].stages.length; o++) {
        if (i[n].stages[o].stageLevel === e) {
          return i[n].stages[o].challengeId;
        }
      }
    }
  }
};
n.prototype.getSelectedStageScore = function (e) {
  var t = this.current.scoreStageList,
    i = 0;
  if (!e || !t) {
    return i;
  }
  for (var n = 0; n < t.length; n++) {
    if (t[n].stageLevel === e && t[n].scorer.length > 0) {
      for (var o = !1, a = 0; a < t[n].scorer.length; a++) {
        o || (i = t[n].scorer[a].score, o = t[n].scorer[a].validated);
      }
      return i;
    }
  }
  return i;
};
n.prototype.getSelectedMalusScore = function (e) {
  var t = this.current.scoreStageList,
    i = 0;
  if (!e || !t) {
    return i;
  }
  for (var n = 0; n < t.length; n++) {
    if (t[n].stageLevel === e && t[n].scorer.length > 0) {
      for (var o = !1, a = 0; a < t[n].scorer.length; a++) {
        o || (i = -20 * t[n].scorer[a].nbDeath, o = t[n].scorer[a].validated);
      }
      return i;
    }
  }
  return i;
};
n.prototype.isSelectedStageDone = function (e) {
  var t = this.current.scoreStageList,
    i = !1;
  if (!e || !t) {
    return i;
  }
  for (var n = 0; n < t.length; n++) {
    if (t[n].stageLevel === e && t[n].scorer.length > 0) {
      return i = !0;
    }
  }
  return i;
};
n.prototype.getStepsScoreRatio = function () {
  var e = this.current.steps,
    t = [];
  if (!e) {
    return t;
  }
  for (var i = 0; i < e.length; i++) {
    for (var n = 0, o = 0, a = 0; a < e[i].stages.length; a++) {
      n += this.getSelectedStageScore(e[i].stages[a].stageLevel);
      for (var s = {}, r = 0; r < e[i].stages[a]._challengePts.length; r++) {
        var l = e[i].stages[a].challengeId[r];
        s[l] = {
          points: e[i].stages[a]._challengePts[r]
        };
      }
      o += this.calculateMaxStageScore(e[i].stages[a].stageLevel, s);
    }
    t.push(Math.trunc(n / o * 100));
  }
  return t;
};
n.prototype.getSelectedStageSucceedChallengeIds = function (e) {
  var t = this.current.scoreStageList,
    i = [],
    n = !1;
  if (!e || !t) {
    return i;
  }
  for (var o = 0; o < t.length; o++) {
    if (t[o].stageLevel === e && t[o].scorer.length > 0) {
      var a = !1;
      n = !0;
      for (var s = 0; s < t[o].scorer.length; s++) {
        a || (i = t[o].scorer[s].challengeId, a = t[o].scorer[s].validated);
      }
      return i;
    }
  }
  return !!n && i;
};
n.prototype.getMonstersData = function (e, t) {
  var i = this.current.steps,
    n = [];
  if (!e || !t) {
    return n;
  }
  for (var o = 0; o < i.length; o++) {
    if (i[o].stepNumber === t) {
      for (var a = 0; a < i[o].stages.length; a++) {
        if (i[o].stages[a].stageLevel === e) {
          return n = i[o].stages[a].monsters;
        }
      }
    }
  }
};
n.prototype._setupListeners = function () {
  var e = this,
    t = window.dofus.connectionManager;
  t.on("toaLadderSuccess", function (t) {
    for (var i = {}, n = 0; n < t.ladderResult.length; n += 1) {
      i[n] = {
        rank: t.ladderResult[n].rank,
        name: t.ladderResult[n].character.name,
        breed: window.gui.databases.Breeds[t.ladderResult[n].character.breed].shortNameId,
        level: t.ladderResult[n].character.level,
        server: t.ladderResult[n].character.server,
        score: t.ladderResult[n].score
      };
    }
    e.current.ladder.nbPlayer = t.nbPlayer;
    e.current.ladder.data = i;
    e.emit("toaLadderDataSuccess");
  });
  t.on("toaLadderError", function () {
    e.emit("toaLadderDataFailure");
  });
  t.on("toaLadderRankCountSuccess", function (t) {
    e._setRank(t.rankCountResult, t.lastRankTop100);
    e._getCurrentPlayersData();
  });
  t.on("toaLadderRankCountError", function () {
    e.emit("toaPlayerRankDataFailure");
  });
  t.on("ToARewardsGivenMessage", function (t) {
    e._displayToaRewards(t.rankId);
  });
  t.on("toaPlayerRankSuccess", function (t) {
    var i = {},
      n = 0;
    t.ladderResult.score && (n = t.ladderResult.score);
    i[0] = {
      rank: t.ladderResult.rank || 0 === t.ladderResult.rank ? t.ladderResult.rank : -1,
      score: n,
      name: t.ladderResult.character ? t.ladderResult.character.name : "-"
    };
    e.current.ladder.player = i;
    e._setPlayersData();
  });
  t.on("TowerOfAscensionCompositionMessage", function (t) {
    e.current.steps = t.steps;
  });
  t.on("TowerOfAscensionResultsMessage", function (t) {
    e.current.scoreStageList ? t.steps.forEach(function (t) {
      for (var i = !1, n = 0; n < e.current.scoreStageList.length; n++) {
        if (e.current.scoreStageList[n].stageLevel === t.stageLevel) {
          e.current.scoreStageList[n] = t;
          i = !0;
          break;
        }
      }
      i || e.current.scoreStageList.push(t);
    }) : (e.current.scoreStageList = t.steps, e.current.scoreStageList.sort(function (e, t) {
      return e.stageLevel > t.stageLevel ? 1 : -1;
    }));
    var i = 0;
    e.current.scoreStageList.forEach(function (e) {
      e.scorer.forEach(function (e) {
        i += e.validated ? e.score : 0;
      });
    });
    e.current.score = i;
  });
};
n.prototype._setPlayersData = function () {
  var e = this.current.ladder.player,
    t = this.current.scoreStageList;
  if ((e[0].rank || 0 === e[0].rank) && 0 !== _.length) {
    var i;
    if (t && t.length > 0) {
      for (var n = 0; n < _.length; n++) {
        if (e[0].rank + 1 <= _[n].rank && e[0].score >= this.ranks[_[n].rankId].score) {
          i = _[n].rankId;
          break;
        }
      }
    }
    var o = {};
    o[0] = {
      rank: e[0].rank,
      score: e[0].score,
      name: e[0].name,
      rankId: i
    };
    this.current.ladder.player = o;
    this.emit("toaPlayerRankDataSuccess");
  }
};
n.prototype.getCurrentStage = function () {
  var e = this,
    t = {
      step: 1,
      stage: 1
    },
    i = e.current.scoreStageList,
    n = e.current.steps;
  if (!i || 0 === i.length) {
    return t;
  }
  for (var o = i.length - 1; o >= 0; o--) {
    if (i[o].scorer.length > 0) {
      t.stage = i[o].stageLevel;
      t.stage = 100 === t.stage ? t.stage : t.stage++;
      break;
    }
  }
  for (var a = 0; a < n.length; a++) {
    for (var s = 0; s < n[a].stages.length; s++) {
      if (n[a].stages[s].stageLevel === t.stage) {
        return t.step = n[a].stepNumber, t;
      }
    }
  }
};
n.prototype._displayToaRewards = function (e) {
  if (e) {
    this.initRanksData();
    var t = this.ranks[e];
    if (t && t.rewards && 0 !== !t.rewards.length) {
      for (var i, n = t.rewards, o = "", a = 0; a < n.length; a++) {
        i = a + 1 === n.length ? "." : ", ";
        o = o + n[a].quantity + " x $item" + n[a].itemId + i;
      }
      var s = l("ui.toa.infoRewards", o);
      window.gui.chat.logMsg(s, u.PSEUDO_CHANNEL_INFO);
    }
  }
};
n.prototype._setupTheRetryPopup = function () {
  var e = this,
    t = window.dofus.connectionManager;
  t.on("ContinueTOAWithCreditErrorMessage", function (e) {
    window.gui.openPopup({
      title: l("ui.common.error"),
      message: l("ui.common.error") + " (reason: CreditError" + e.reason + ")"
    });
    console.error("ContinueTOAWithCreditErrorMessage reason", e.reason);
  });
  t.on("PlayerCanContinueStageWithCreditNotificationMessage", function (t) {
    e.openTheRetryPopup(t.stepNumber);
  });
};
n.prototype.openTheRetryPopup = function (e) {
  r.open("toaRetryPopup", {
    stepNumber: e
  });
};
n.prototype.initRanksData = function () {
  if (!this.hasOwnProperty("ranks")) {
    for (var e = {}, t = [l("ui.toa.rewardsBoardTop1"), l("ui.toa.rewardsBoardTop2"), l("ui.toa.rewardsBoardTop3"), l("ui.toa.rewardsBoardTop15"), l("ui.toa.rewardsBoardTop16"), l("ui.toa.rewardsBoardTop4"), l("ui.toa.rewardsBoardTop5"), l("ui.toa.rewardsBoardTop6"), l("ui.toa.rewardsBoardTop7"), l("ui.toa.rewardsBoardTop8"), l("ui.toa.rewardsBoardTop9"), l("ui.toa.rewardsBoardTop10"), l("ui.toa.rewardsBoardTop11"), l("ui.toa.rewardsBoardTop12"), l("ui.toa.rewardsBoardTop13"), l("ui.toa.rewardsBoardTop14")], i = [80, 79, 79, 78, 77, 76, 75, 75], n = window.gui.databases.ToaRank, o = 0; o < t.length; o += 1) {
      e[n[o + 1].id] = {
        id: n[o + 1].id,
        rankName: n[o + 1].nameId,
        score: n[o + 1].minScore,
        rewards: n[o + 1].rewards,
        goultines: n[o + 1].goultines,
        ornament: i[o] || -1,
        details: t[o]
      };
    }
    this.ranks = e;
  }
};
n.prototype.requestMaxRankLadderData = function () {
  d.send("toaLadderRankCount");
};
n.prototype.requestLadderData = function (e, t) {
  d.send("toaLadder", {
    page: e,
    server: t,
    order: "desc"
  });
};
n.prototype._getCurrentPlayersData = function () {
  d.send("toaPlayerRank", {
    name: window.gui.playerData.identification.uniqueNickname.toString()
  });
};
n.prototype.getRank = function (e) {
  var t = window.gui.databases.ToaRank,
    i = [];
  if (e && !(e <= 0)) {
    for (var n = 0; n < t.length; n++) {
      if (e === t[n].id) {
        i = t[n];
        break;
      }
    }
    return i;
  }
};
n.prototype._setRank = function (e, t) {
  this.initRanksData();
  var i = [1, 2, 3, 10, 30, 100, .1 * (e - t) + t, .2 * (e - t) + t, .3 * (e - t) + t, .4 * (e - t) + t, .5 * (e - t) + t, .6 * (e - t) + t, .7 * (e - t) + t, .8 * (e - t) + t, .9 * (e - t) + t, e],
    n = [];
  for (var o in this.ranks) {
    this.ranks.hasOwnProperty(o) && n.push(o);
  }
  for (var a = [], s = 0; s < i.length; s++) {
    a.push({
      rank: i[s],
      rankId: n[s]
    });
  }
  _ = a;
};
n.prototype.getMonsterLevelScaled = function (e) {
  if (!Number.isInteger(e) || e < 0) {
    return 0;
  }
  var t = Math.floor(c.BASE_MONSTER_LEVEL + e * ((c.MAX_MONSTER_LEVEL - c.BASE_MONSTER_LEVEL) / c.NB_SCALE_LEVEL));
  return t;
};
this.current = {};
this.current.ladder = {};
this._requestedSocialInfoMap = {};
this._awaitedSocialInfoMap = {};
this._setupListeners(e);
this._setupTheRetryPopup(e);
e > 0 && e <= 50 ? i += p : e > 50 && e <= 100 && (i += m);
50 === e ? i += f : 100 === e && (i += g);
t.on("toaLadderSuccess", function (t) {
  for (var i = {}, n = 0; n < t.ladderResult.length; n += 1) {
    i[n] = {
      rank: t.ladderResult[n].rank,
      name: t.ladderResult[n].character.name,
      breed: window.gui.databases.Breeds[t.ladderResult[n].character.breed].shortNameId,
      level: t.ladderResult[n].character.level,
      server: t.ladderResult[n].character.server,
      score: t.ladderResult[n].score
    };
  }
  e.current.ladder.nbPlayer = t.nbPlayer;
  e.current.ladder.data = i;
  e.emit("toaLadderDataSuccess");
});
t.on("toaLadderError", function () {
  e.emit("toaLadderDataFailure");
});
t.on("toaLadderRankCountSuccess", function (t) {
  e._setRank(t.rankCountResult, t.lastRankTop100);
  e._getCurrentPlayersData();
});
t.on("toaLadderRankCountError", function () {
  e.emit("toaPlayerRankDataFailure");
});
t.on("ToARewardsGivenMessage", function (t) {
  e._displayToaRewards(t.rankId);
});
t.on("toaPlayerRankSuccess", function (t) {
  var i = {},
    n = 0;
  t.ladderResult.score && (n = t.ladderResult.score);
  i[0] = {
    rank: t.ladderResult.rank || 0 === t.ladderResult.rank ? t.ladderResult.rank : -1,
    score: n,
    name: t.ladderResult.character ? t.ladderResult.character.name : "-"
  };
  e.current.ladder.player = i;
  e._setPlayersData();
});
t.on("TowerOfAscensionCompositionMessage", function (t) {
  e.current.steps = t.steps;
});
t.on("TowerOfAscensionResultsMessage", function (t) {
  e.current.scoreStageList ? t.steps.forEach(function (t) {
    for (var i = !1, n = 0; n < e.current.scoreStageList.length; n++) {
      if (e.current.scoreStageList[n].stageLevel === t.stageLevel) {
        e.current.scoreStageList[n] = t;
        i = !0;
        break;
      }
    }
    i || e.current.scoreStageList.push(t);
  }) : (e.current.scoreStageList = t.steps, e.current.scoreStageList.sort(function (e, t) {
    return e.stageLevel > t.stageLevel ? 1 : -1;
  }));
  var i = 0;
  e.current.scoreStageList.forEach(function (e) {
    e.scorer.forEach(function (e) {
      i += e.validated ? e.score : 0;
    });
  });
  e.current.score = i;
});
e.current.ladder.nbPlayer = t.nbPlayer;
e.current.ladder.data = i;
e.emit("toaLadderDataSuccess");
e._setRank(t.rankCountResult, t.lastRankTop100);
e._getCurrentPlayersData();
t.ladderResult.score && (n = t.ladderResult.score);
i[0] = {
  rank: t.ladderResult.rank || 0 === t.ladderResult.rank ? t.ladderResult.rank : -1,
  score: n,
  name: t.ladderResult.character ? t.ladderResult.character.name : "-"
};
e.current.ladder.player = i;
e._setPlayersData();
e.current.scoreStageList[n] = t;
i = !0;
e.current.scoreStageList.forEach(function (e) {
  e.scorer.forEach(function (e) {
    i += e.validated ? e.score : 0;
  });
});
e.current.score = i;
o[0] = {
  rank: e[0].rank,
  score: e[0].score,
  name: e[0].name,
  rankId: i
};
this.current.ladder.player = o;
this.emit("toaPlayerRankDataSuccess");
t.stage = i[o].stageLevel;
t.stage = 100 === t.stage ? t.stage : t.stage++;
i = a + 1 === n.length ? "." : ", ";
o = o + n[a].quantity + " x $item" + n[a].itemId + i;
t.on("ContinueTOAWithCreditErrorMessage", function (e) {
  window.gui.openPopup({
    title: l("ui.common.error"),
    message: l("ui.common.error") + " (reason: CreditError" + e.reason + ")"
  });
  console.error("ContinueTOAWithCreditErrorMessage reason", e.reason);
});
t.on("PlayerCanContinueStageWithCreditNotificationMessage", function (t) {
  e.openTheRetryPopup(t.stepNumber);
});
window.gui.openPopup({
  title: l("ui.common.error"),
  message: l("ui.common.error") + " (reason: CreditError" + e.reason + ")"
});
console.error("ContinueTOAWithCreditErrorMessage reason", e.reason);
o.call(this);
this.popups = [];
a(n, o);
e.exports = n;
n.prototype._displayMarketingPopup = function (e) {
  s.open("marketingWindow", e);
};
n.prototype.getPromoDisplayUserPrefKey = function () {
  return "promoDisplayed";
};
n.prototype.initialize = function (e) {
  function t(e) {
    window.gui.playerData.isShopDisabled() || d.getMarketingPopups(function (t, n) {
      return t ? e(t) : (i.popups = n, i._processPopups(n), e());
    });
  }
  var i = this,
    n = window.dofus.connectionManager;
  this.alreadyOpenedPopup = !1;
  e.on("connected", function () {
    c.reset();
    window.gui.playerData.isShopDisabled() || c.getStoreInfos(function (e) {
      if (e) {
        return console.error(e);
      }
    });
  });
  e.on("disconnect", function () {
    i.alreadyOpenedPopup = !1;
  });
  e.playerData.on("characterLevelUp", function () {
    return i.popups.length <= 0 || !i.alreadyOpenedPopup ? t(function (e) {
      if (e) {
        return console.error(e);
      }
    }) : void i._processPopupsWithTriggers();
  });
  window.isoEngine.on("mapLoaded", function () {
    i._processPopupsWithTriggers();
  });
  n.on("setShopDetailsSuccess", function () {
    t(function (e) {
      if (e) {
        return console.error(e);
      }
    });
  });
};
n.prototype._processPopupsWithTriggers = function () {
  if (!(this.popups.length <= 0)) {
    var e = r.getValue(this.getPromoDisplayUserPrefKey(), {}),
      t = u.getMarketingItemToDisplayWithTrigger(this.popups, e, l);
    t && this._displayMarketingPopup(t);
  }
};
n.prototype._processPopups = function (e) {
  if (!this.alreadyOpenedPopup) {
    var t = r.getValue(this.getPromoDisplayUserPrefKey(), {}),
      i = u.getMarketingItemToDisplay(e, t, l);
    i ? (this.alreadyOpenedPopup = !0, this._displayMarketingPopup(i)) : this._processPopupsWithTriggers();
  }
};
this.alreadyOpenedPopup = !1;
e.on("connected", function () {
  c.reset();
  window.gui.playerData.isShopDisabled() || c.getStoreInfos(function (e) {
    if (e) {
      return console.error(e);
    }
  });
});
e.on("disconnect", function () {
  i.alreadyOpenedPopup = !1;
});
e.playerData.on("characterLevelUp", function () {
  return i.popups.length <= 0 || !i.alreadyOpenedPopup ? t(function (e) {
    if (e) {
      return console.error(e);
    }
  }) : void i._processPopupsWithTriggers();
});
window.isoEngine.on("mapLoaded", function () {
  i._processPopupsWithTriggers();
});
n.on("setShopDetailsSuccess", function () {
  t(function (e) {
    if (e) {
      return console.error(e);
    }
  });
});
c.reset();
window.gui.playerData.isShopDisabled() || c.getStoreInfos(function (e) {
  if (e) {
    return console.error(e);
  }
});
Y = !1;
j = {};
V = [];
X = null;
o._parsedPrice = a;
j[n] = o;
ue || (ue = e.currency);
he || (he = e.country);
e = e || {};
ae.send("setShopDetailsRequest", e);
n.isMysteryBox = l;
n.itemsId = r;
t.push(n);
i !== X.currency && console.error("Currency is not the same as the storeInfos: storeInfos.currency: " + X.currency + ", currency: " + i);
n = o;
n !== e.product._parsedPrice && console.error("Amount is not the same as the article: _parsedPrice: " + e.product._parsedPrice + ", amount: " + n);
console.error("[Haapi info] ShopWindow sending shopBuyIAPRequest with data: " + JSON.stringify(a) + ", from price: " + e.product.price + ", from priceMicros: " + e.product.priceMicros);
window.dofus.send("shopBuyIAPRequest", a);
ae.send("moneyGoultinesAmountRequest");
Q.finishPurchase(e, function (n) {
  if (n) {
    var o = new Error("Finish purchase failed for key " + e + " and order id " + t + " with error: " + n);
    return i(o, e);
  }
  return i(null, e);
});
window.gui.openSimplePopup(ee("tablet.shop.validateIAPSuccess"), ee("ui.common.informations"));
A(e.iapKey, e.buyResult.order_id, function () {
  H();
});
H();
F(e.reason);
H();
window.gui.openSimplePopup(ee("tablet.shop.buySuccess"), ee("ui.common.informations"));
e.currency === Z.GOULTINE && window.dofus.send("moneyGoultinesAmountRequest");
"android" === t.platform ? console.error("[Haapi info] ShopWindow sending shopMobileValidateOrderRequest with data: " + JSON.stringify({
  orderId: e,
  receipt: i,
  iapKey: n
})) : console.error("[Haapi info] ShopWindow sending shopMobileValidateOrderRequest with data: " + JSON.stringify({
  orderId: e,
  iapKey: n
}));
window.dofus.send("shopMobileValidateOrderRequest", {
  orderId: e,
  receipt: i,
  iapKey: n
});
H();
F(e.reason);
X ? o ? (K.trackIAPBought(i, o._parsedPrice, X.currency, n), "com.ankama.dofustouchnext.starterpackalbueraios" !== i && "com.ankama.dofustouch.starterpackalbueraios" !== i && "com.ankama.dofustouchnext.starterpackalbueraandroid" !== i && "com.ankama.dofustouch.starterpackalbueraandroid" !== i || re.sendTagAlbueraStarterPackBought()) : console.error(new Error("Could not send event to Adjust, no product found for key: " + i)) : console.error(new Error("Could not send event to Adjust, store infos are no longer available"));
P(n, t);
"android" === e.platform ? console.error("[Haapi info] ShopWindow sending shopMobileValidatePendingOrderRequest with data: " + JSON.stringify({
  receipt: t,
  iapKey: i
})) : console.error("[Haapi info] ShopWindow sending shopMobileValidatePendingOrderRequest with data: " + JSON.stringify({
  iapKey: i
}));
window.dofus.send("shopMobileValidatePendingOrderRequest", {
  receipt: t,
  iapKey: i,
  productInfo: n,
  currency: X.currency
});
se.on("setShopDetailsSuccess", g);
se.on("setShopDetailsError", f);
se.on("shopIAPListSuccess", d);
se.on("shopIAPListError", c);
se.on("shopMobileValidateOrderError", S);
se.on("shopMobileValidateOrderSuccess", E);
se.on("shopBuyError", N);
se.on("shopBuySuccess", x);
se.on("mysteryBoxError", L);
se.on("mysteryBoxSuccess", O);
se.on("restoreMysteryBoxError", R);
se.on("restoreMysteryBoxSuccess", D);
se.on("shopBuyIAPError", B);
se.on("shopBuyIAPSuccess", k);
se.on("shopMobileValidatePendingOrderError", z);
se.on("shopMobileValidatePendingOrderSuccess", W);
t.doubleCheckAmount = function (e, t) {
  var i = 0;
  return Q.isAvailable() ? void Q.getProductDetails([e], function (e, n) {
    if (e) {
      return t(e);
    }
    var o = n.currency,
      a = n.products;
    for (var s in a) {
      if (a.hasOwnProperty(s)) {
        var r = a[s],
          l = oe.parsePriceMicros(r.priceMicros);
        if (isNaN(l)) {
          continue;
        }
        i = l;
      }
    }
    return i ? t(null, o, i) : t(new Error("No amounts."));
  }) : t(new Error("purchase not available."));
};
t.initialize = n;
t.reset = a;
t.getStoreInfos = s;
t.enrichWithSoftPrice = v;
t.validateArticles = w;
t.purchaseArticleOnStore = T;
t.purchaseArticleOnAnkama = C;
t.openNotEnoughHardCurrencyPopup = M;
t.validatePendingIAP = G;
t.checkPendingPurchases = q;
window.dofus.connectionManager.send("bakSoftToHardCurrentRateRequest");
window.dofus.connectionManager.send("bakHardToSoftCurrentRateRequest");
i.on("connected", function () {
  window.gui.playerData.isShopDisabled() || (n(), s.setInterval(n, c));
});
e.on("bakSoftToHardCurrentRateSuccess", function (e) {
  null !== r && r === e.rate || (r = e.rate, t.emit("computedSoftPricesChange"));
});
e.on("bakHardToSoftCurrentRateSuccess", function (e) {
  null !== l && l === e.rate || (l = e.rate, t.emit("computedHardPricesChange"));
});
e.on("bakSoftToHardCurrentRateError", function () {
  r = null;
  t.emit("canNotComputeSoftPrices");
});
e.on("bakHardToSoftCurrentRateError", function () {
  l = null;
  t.emit("canNotComputeHardPrices");
});
r = null;
t.emit("canNotComputeSoftPrices");
l = null;
t.emit("canNotComputeHardPrices");
t.initialize = function () {
  o();
};
t.isRateAvailable = function () {
  return null !== r && null !== l;
};
t.computeHardPrice = function (e) {
  return l || 0 === l ? Math.ceil(e / l) : null;
};
t.computeSoftPrice = function (e) {
  return r || 0 === r ? Math.ceil(e * r) : null;
};
n.config({
  ROUNDING_MODE: n.ROUND_HALF_EVEN
});
n.DEBUG = !0;
t.parsePriceMicros = function (e) {
  var t;
  try {
    var i = new n(e);
    t = i.times("0.000001").toNumber();
  } catch (a) {
    return o.error(new Error("Could not parse price " + e)), NaN;
  }
  return t === 1 / 0 || t === -(1 / 0) ? (o.error(new Error("Parsed price is Infinity: " + e)), NaN) : t;
};
(s = u.indexOf(".")) > -1 && (u = u.replace(".", ""));
(r = u.search(/e/i)) > 0 ? (s < 0 && (s = r), s += +u.slice(r + 1), u = u.substring(0, r)) : s < 0 && (s = u.length);
a = !0;
r = -1;
s = 0;
u = S(u, i, 10, h.s);
(s = u.indexOf(".")) > -1 ? u = u.replace(".", "") : s = u.length;
u = u.slice(r);
r = w - u.length;
m = r(e.c);
m = 1 == o || 2 == o && l <= R ? u(m, l) : h(m, l, "0");
a += w;
s = t;
l = u[c = 0];
d = l / h[o - s - 1] % 10 | 0;
l = d = 0;
o = 1;
a %= w;
s = a - w + 1;
a %= w;
s = a - w + o;
d = s < 0 ? 0 : l / h[o - s - 1] % 10 | 0;
u[c--] = 0;
r = 1;
c(i[0], -C, -1, t);
c(i[1], 1, C, t);
P = i[0];
B = i[1];
r = 131072 * n[l] + (n[l + 1] >>> 11);
r >= 9e15 ? (o = crypto.getRandomValues(new Uint32Array(2)), n[l] = o[0], n[l + 1] = o[1]) : (d.push(r % 1e14), l += 2);
r = 281474976710656 * (31 & n[l]) + 1099511627776 * n[l + 1] + 4294967296 * n[l + 2] + 16777216 * n[l + 3] + (n[l + 4] << 16) + (n[l + 5] << 8) + n[l + 6];
r >= 9e15 ? crypto.randomBytes(7).copy(n, l) : (d.push(r % 1e14), l += 7);
r = i();
r < 9e15 && (d[l++] = r % 1e14);
g[d] = 0;
d || (++u, g = [1].concat(g));
a = e[l] % T;
s = e[l] / T | 0;
n = d * a + s * c;
o = c * a + n % T * T + r;
r = (o / i | 0) + (n / T | 0) + d * s;
e[l] = o % i;
e[i] -= o;
o = e[i] < t[i] ? 1 : 0;
e[i] = o * n + e[i] - t[i];
M.push(1);
m = !0;
x = R.slice();
x = [0].concat(x);
E = R[0];
R[1] >= c / 2 && E++;
f--;
n(_, N < v ? x : R, v, c);
v = _.length;
d = 1;
0 == f && (d = f = 1);
_ = R.slice();
v = _.length;
f++;
n(T, N < C ? x : R, C, c);
C = T.length;
M[h++] = f;
T[0] ? T[C++] = O[A] || 0 : (T = [O[A]], C = 1);
m = null != T[0];
M[0] || M.splice(0, 1);
b.e = u;
b.r = +m;
s.s = isNaN(u) ? null : u < 0 ? -1 : 1;
s.c = s.e = null;
o = !c && m.isInteger() && i.isInteger();
o && (m = m.mod(i));
m = m.times(m);
s ? m.c && m.c.length > s && (m.c.length = s) : o && (m = m.mod(i));
--p[n];
p[a] += y;
h = C[--c] % b;
p = C[c] / b | 0;
d = g * h + p * f;
h = f * h + d % b * b + _[l] + n;
n = (h / v | 0) + (d / b | 0) + g * p;
_[l--] = h % v;
r = (d[--i] = d[i] + u[i] + r) / y | 0;
d[i] = y === d[i] ? 0 : d[i] % y;
h += 4;
d += 4;
o = 1;
l > 0 && (d += c + p.slice(a));
h && (d = "-" + d);
n = o;
o = a;
u = d.plus(h.times(a = u));
d = a;
i = c.minus(h.times(a = i));
c = a;
p = a();
p["default"] = p.BigNumber = p;
n = function () {
  return p;
}.call(t, i, t, e);
!(void 0 !== n && (e.exports = n));
t.getMarketingItemToDisplayWithTrigger = n;
t.getMarketingItemToDisplay = o;
a.call(this, "div", {
  className: "progressGauge"
});
this.gaugeBg = this.createChild("div", {
  className: "gaugeBg"
});
this.gaugeMask = this.createChild("div", {
  className: "gaugeMask"
});
this.gaugeFill = this.gaugeMask.createChild("div", {
  className: "gaugeFill"
});
this._resetAnimInfo();
this._initEvents();
o(n, a);
e.exports = n;
n.prototype._initEvents = function () {
  var e = this,
    t = window.dofus.connectionManager,
    i = window.gui,
    n = i.playerData;
  i.on("resize", function () {
    e._resize();
  });
  n.on("characterSelectedSuccess", function () {
    var t = c.getValue(n.id + u, d.PLAYER_EXPERIENCE);
    t && (e.defaultMode = t, e._setMode(e.defaultMode), e._setPercentage(0));
  });
  t.on("CharacterStatsListMessage", function (t) {
    var i = t.stats;
    e.playerPercentage = e._convertXpToPercentage(i.experience, i.experienceLevelFloor, i.experienceNextLevelFloor);
    e.gaugeMode === d.PLAYER_EXPERIENCE && e._setPercentage(e.playerPercentage);
  });
  t.on("GuildInformationsGeneralMessage", function (t) {
    e.guildPercentage = e._convertXpToPercentage(t.experience, t.expLevelFloor, t.expNextLevelFloor);
    e.gaugeMode === d.GUILD_EXPERIENCE && e._setPercentage(e.guildPercentage);
  });
  t.on("MountSetMessage", function (t) {
    var i = t.mountData;
    e.mountPercentage = e._convertXpToPercentage(i.experience, i.experienceForLevel, i.experienceForNextLevel);
    e.gaugeMode === d.MOUNT_EXPERIENCE && e._setPercentage(e.mountPercentage);
  });
  n.jobs.on("jobExperienceUpdate", function (t) {
    e["job" + t.jobId + "Percentage"] = t.percentage;
    e.gaugeMode === "job" + t.jobId && e._setPercentage(e["job" + t.jobId + "Percentage"]);
  });
  n.inventory.on("weightUpdated", function () {
    e.gaugeMode === d.INVENTORY_PODS && e._updateGaugeWithInventoryPods();
  });
  i.fightManager.on("fightEnterPreparation", function (t) {
    t.isSpectator || e._setMode(d.FIGHT_TIMER, {
      duration: t.timeMaxBeforeFightStart
    });
  });
  i.fightManager.on("fightEnterBattle", function () {
    n.isSpectator || (e.gaugeMode !== d.FIGHT_TIMER && e._setMode(d.FIGHT_TIMER), e._pauseAnimation());
  });
  i.timeline.on("setTurnOf", function (t, i) {
    if (e.gaugeMode === d.FIGHT_TIMER) {
      var o = n.characters.controlledCharacterId;
      t.id === o ? e._animate(i) : (e._setStatic(), e._setPercentage(0));
    }
  });
  i.fightManager.on("fightEnd", function () {
    e._setMode(e.defaultMode);
  });
};
n.prototype._updateGaugeWithInventoryPods = function () {
  var e = window.gui.playerData.inventory;
  this._setPercentage(Math.round(e.weight / e.maxWeight * 100));
};
n.prototype._setMode = function (e, t) {
  var i = t && "number" == typeof t.duration ? t.duration : null,
    n = t && "number" == typeof t.percentage ? t.percentage : 0;
  this.gaugeMode = e;
  var o = null;
  e.indexOf("job") !== -1 && (o = parseInt(e.split("job")[1], 10), e = "job");
  var a;
  switch (e) {
    case d.FIGHT_TIMER:
      a = "fightTimer";
      null !== i ? this._animate(i, n) : (this._setStatic(), this._setPercentage(n));
      break;
    case d.GUILD_EXPERIENCE:
      a = "guildXp";
      this._setStatic();
      this._setPercentage(this.guildPercentage);
      break;
    case d.MOUNT_EXPERIENCE:
      a = "mountXp";
      this._setStatic();
      this._setPercentage(this.mountPercentage);
      break;
    case d.INVENTORY_PODS:
      a = "inventoryPods";
      this._setStatic();
      this._updateGaugeWithInventoryPods();
      break;
    case "job":
      a = "jobXp";
      this._setStatic();
      this._setPercentage(this["job" + o + "Percentage"]);
      break;
    case d.PLAYER_EXPERIENCE:
    default:
      a = "playerXp";
      this._setStatic();
      this._setPercentage(this.playerPercentage);
  }
  this.setClassNames(["progressGauge", a]);
};
n.prototype._resetAnimInfo = function () {
  this.animationInfo = {
    startTime: 0,
    duration: 0,
    startFrom: 0
  };
};
n.prototype._setStatic = function () {
  this.gaugeFill.setStyles({
    webkitAnimation: "initial",
    webkitAnimationPlayState: "initial"
  });
  this._resetAnimInfo();
};
n.prototype._setPercentage = function (e) {
  e || (e = 0);
  e = Math.max(0, Math.min(100, e));
  this.gaugeFill.setStyle("webkitTransform", "translate3d(-" + (100 - e) / 2 + "%,0,0) scaleX(" + e / 100 + ")");
};
n.prototype._convertXpToPercentage = function (e, t, i) {
  return (e - t) / (i - t) * 100;
};
n.prototype._animate = function (e, t) {
  if (this.gaugeMode !== d.FIGHT_TIMER) {
    return console.error(new Error("ProgressGauge._animate: ProgressGauge is not in timer mode"));
  }
  t = t || 0;
  t = Math.max(0, Math.min(100, t));
  var i = e / 100 * t;
  this._setStatic();
  this._setPercentage(100);
  r.forceReflow(this.gaugeFill);
  this.animationInfo = {
    startTime: Date.now(),
    duration: e,
    startFrom: t
  };
  this.gaugeFill.setStyles({
    webkitAnimation: "progressGaugeAnimation " + e + "ms linear -" + i + "ms",
    webkitAnimationPlayState: "running"
  });
};
n.prototype._pauseAnimation = function () {
  return this.gaugeMode !== d.FIGHT_TIMER ? console.error(new Error("ProgressGauge._pauseAnimation: ProgressGauge is not in timer mode")) : void this.gaugeFill.setStyle("webkitAnimationPlayState", "paused");
};
n.prototype._resize = function () {
  window.gui.ipadRatio ? this.setStyle("width", "100%") : this.setStyle("width", s.shortcutBarSize - 9 + "px");
  var e = this.animationInfo;
  if (this.gaugeMode === d.FIGHT_TIMER && 0 !== e.startTime) {
    var t = Date.now() - e.startTime;
    if (t < e.duration) {
      var i = t / e.duration * (100 - e.startFrom),
        n = e.startFrom + i;
      this._animate(e.duration - t, n);
    }
  }
};
n.prototype.openPrefMenu = function () {
  function e() {
    i.defaultMode = this.value;
    i._setMode(i.defaultMode);
    c.setValue(window.gui.playerData.id + u, i.defaultMode);
  }
  function t(t, o) {
    n.push({
      caption: t,
      value: o,
      cb: e,
      ticked: i.defaultMode === o
    });
  }
  var i = this,
    n = [];
  t(l("ui.banner.xpCharacter"), "playerExperience");
  t(l("ui.common.weight"), "inventoryPods");
  window.gui.playerData.guild.current && t(l("ui.banner.xpGuild"), "guildExperience");
  window.gui.playerData.equippedMount && t(l("ui.banner.xpMount"), "mountExperience");
  for (var o in window.gui.playerData.jobs.list) {
    var a = window.gui.playerData.jobs.list[o];
    t(l("ui.common.xp") + " " + a.info.nameId, "job" + a.id);
  }
  window.gui.openContextualMenu("generic", {
    title: l("ui.banner.customGauge"),
    actions: n
  });
};
i.on("resize", function () {
  e._resize();
});
n.on("characterSelectedSuccess", function () {
  var t = c.getValue(n.id + u, d.PLAYER_EXPERIENCE);
  t && (e.defaultMode = t, e._setMode(e.defaultMode), e._setPercentage(0));
});
t.on("CharacterStatsListMessage", function (t) {
  var i = t.stats;
  e.playerPercentage = e._convertXpToPercentage(i.experience, i.experienceLevelFloor, i.experienceNextLevelFloor);
  e.gaugeMode === d.PLAYER_EXPERIENCE && e._setPercentage(e.playerPercentage);
});
t.on("GuildInformationsGeneralMessage", function (t) {
  e.guildPercentage = e._convertXpToPercentage(t.experience, t.expLevelFloor, t.expNextLevelFloor);
  e.gaugeMode === d.GUILD_EXPERIENCE && e._setPercentage(e.guildPercentage);
});
t.on("MountSetMessage", function (t) {
  var i = t.mountData;
  e.mountPercentage = e._convertXpToPercentage(i.experience, i.experienceForLevel, i.experienceForNextLevel);
  e.gaugeMode === d.MOUNT_EXPERIENCE && e._setPercentage(e.mountPercentage);
});
n.jobs.on("jobExperienceUpdate", function (t) {
  e["job" + t.jobId + "Percentage"] = t.percentage;
  e.gaugeMode === "job" + t.jobId && e._setPercentage(e["job" + t.jobId + "Percentage"]);
});
n.inventory.on("weightUpdated", function () {
  e.gaugeMode === d.INVENTORY_PODS && e._updateGaugeWithInventoryPods();
});
i.fightManager.on("fightEnterPreparation", function (t) {
  t.isSpectator || e._setMode(d.FIGHT_TIMER, {
    duration: t.timeMaxBeforeFightStart
  });
});
i.fightManager.on("fightEnterBattle", function () {
  n.isSpectator || (e.gaugeMode !== d.FIGHT_TIMER && e._setMode(d.FIGHT_TIMER), e._pauseAnimation());
});
i.timeline.on("setTurnOf", function (t, i) {
  if (e.gaugeMode === d.FIGHT_TIMER) {
    var o = n.characters.controlledCharacterId;
    t.id === o ? e._animate(i) : (e._setStatic(), e._setPercentage(0));
  }
});
i.fightManager.on("fightEnd", function () {
  e._setMode(e.defaultMode);
});
e.playerPercentage = e._convertXpToPercentage(i.experience, i.experienceLevelFloor, i.experienceNextLevelFloor);
e.gaugeMode === d.PLAYER_EXPERIENCE && e._setPercentage(e.playerPercentage);
e.guildPercentage = e._convertXpToPercentage(t.experience, t.expLevelFloor, t.expNextLevelFloor);
e.gaugeMode === d.GUILD_EXPERIENCE && e._setPercentage(e.guildPercentage);
e.mountPercentage = e._convertXpToPercentage(i.experience, i.experienceForLevel, i.experienceForNextLevel);
e.gaugeMode === d.MOUNT_EXPERIENCE && e._setPercentage(e.mountPercentage);
e["job" + t.jobId + "Percentage"] = t.percentage;
e.gaugeMode === "job" + t.jobId && e._setPercentage(e["job" + t.jobId + "Percentage"]);
a = "fightTimer";
null !== i ? this._animate(i, n) : (this._setStatic(), this._setPercentage(n));
a = "guildXp";
this._setStatic();
this._setPercentage(this.guildPercentage);
a = "mountXp";
this._setStatic();
this._setPercentage(this.mountPercentage);
a = "inventoryPods";
this._setStatic();
this._updateGaugeWithInventoryPods();
a = "jobXp";
this._setStatic();
this._setPercentage(this["job" + o + "Percentage"]);
a = "playerXp";
this._setStatic();
this._setPercentage(this.playerPercentage);
this.gaugeFill.setStyles({
  webkitAnimation: "initial",
  webkitAnimationPlayState: "initial"
});
this._resetAnimInfo();
e || (e = 0);
e = Math.max(0, Math.min(100, e));
this.gaugeFill.setStyle("webkitTransform", "translate3d(-" + (100 - e) / 2 + "%,0,0) scaleX(" + e / 100 + ")");
t = t || 0;
t = Math.max(0, Math.min(100, t));
this._setStatic();
this._setPercentage(100);
r.forceReflow(this.gaugeFill);
this.animationInfo = {
  startTime: Date.now(),
  duration: e,
  startFrom: t
};
this.gaugeFill.setStyles({
  webkitAnimation: "progressGaugeAnimation " + e + "ms linear -" + i + "ms",
  webkitAnimationPlayState: "running"
});
i.defaultMode = this.value;
i._setMode(i.defaultMode);
c.setValue(window.gui.playerData.id + u, i.defaultMode);
t(l("ui.banner.xpCharacter"), "playerExperience");
t(l("ui.common.weight"), "inventoryPods");
window.gui.playerData.guild.current && t(l("ui.banner.xpGuild"), "guildExperience");
window.gui.playerData.equippedMount && t(l("ui.banner.xpMount"), "mountExperience");
window.gui.on("disconnect", function () {
  e.hide();
});
window.gui.on("resize", function () {
  e._initPosition();
});
this.on("show", function () {
  c("NEW_REWARD");
});
o(n, a);
e.exports = n;
n.prototype._initPosition = function () {
  this.setStyle("left", l.mapLeft + l.mapWidth / 2 - 32 + "px");
  this.setStyle("top", l.mapBottom - 64 + "px");
};
this.setStyle("left", l.mapLeft + l.mapWidth / 2 - 32 + "px");
this.setStyle("top", l.mapBottom - 64 + "px");
this._isActive = !1;
this._activePictoMap = {};
t.once("initialized", function () {
  var i = window.gui.gameGuiContainer;
  e._pingBtn = i.appendChild(new o());
  e._pingBox = i.appendChild(new a());
  e._emoteBox = i.appendChild(new s());
  e._setupEvents(t);
  e._emoteBox.refreshPosition();
  e._emoteBox.hide();
});
t.on("disconnect", function () {
  e._reset();
  e._resetPicto();
});
r.on("PingMessage", function (t) {
  function i(e, t) {
    return "ui.pingSystem.context" + e + ".hyperlink" + t;
  }
  e.addPingPicto(t.cell, t.type, t.targetType);
  var n = t.cell,
    o = t.type,
    a = t.targetType,
    s = c(i(a, o)),
    r = window.actorManager.getActor(t.sender);
  if (r) {
    var l = r.data;
    window.gui.chat.logMsg("{player," + l.name + "," + l.playerId + "}" + c("ui.common.colon") + "{pingsystem," + n + "," + o + "," + a + "::[" + s + "]}");
  }
});
t.fightManager.on("fightStart", function () {
  e._pingBtn.enterFightState();
});
t.fightManager.on("fightEnd", function () {
  e._pingBtn.enterRolePlayState();
});
e._pingBtn = i.appendChild(new o());
e._pingBox = i.appendChild(new a());
e._emoteBox = i.appendChild(new s());
e._setupEvents(t);
e._emoteBox.refreshPosition();
e._emoteBox.hide();
e._reset();
e._resetPicto();
e.exports = n;
n.prototype.PING_CELL_COLOR = {
  r: 240,
  g: 160,
  b: 65,
  a: .75
};
n.prototype._setupEvents = function () {
  var e = this,
    t = window.gui,
    i = this._pingBtn,
    n = this._pingBox;
  t.on("GameFightEndMessage", function () {
    e._reset();
    e._resetPicto();
  });
  i.on("selected", function () {
    t.playerData.isFighting && (l.setPriorityBehavior("TOUCH"), e._isActive = !0);
  });
  i.on("unselected", function () {
    t.playerData.isFighting && (e._isActive = !1, e._pingBox.close());
  });
  i.on("emoteBtnTap", function () {
    if (e._emoteBox.isOpen) {
      e._emoteBox.hide();
    } else {
      if (t.playerData.isFighting) {
        return;
      }
      e._emoteBox.show();
      e._emoteBox.refreshPosition();
    }
  });
  n.on("actionSent", function () {
    e._reset();
  });
};
n.prototype.cancelPingBox = function () {
  this._pingBox.close();
};
n.prototype.openPingBox = function (e, t) {
  this._pingBox.open(e, t);
};
n.prototype.isPingBoxOpen = function () {
  return this._pingBox.isOpen();
};
n.prototype.addPingPicto = function (e, t, i) {
  function n(e) {
    return window.setTimeout(function () {
      window.isoEngine.mapRenderer.removePingPicto(e);
      delete o._activePictoMap[e];
    }, d);
  }
  if (window.gui.playerData.isFighting && e !== -1) {
    var o = this;
    this._activePictoMap[e] && (window.isoEngine.mapRenderer.removePingPicto(e), delete o._activePictoMap[e]);
    window.isoEngine.mapRenderer.addPingPictoOnCell(e, t, i);
    this._activePictoMap[e] = n(e);
  }
};
n.prototype._removePingPicto = function () {
  for (var e in this._activePictoMap) {
    this._activePictoMap.hasOwnProperty(e) && (window.clearTimeout(this._activePictoMap[e]), window.isoEngine.mapRenderer.removePingPicto(e), delete this._activePictoMap[e]);
  }
};
n.prototype._reset = function () {
  this._isActive = !1;
  this._pingBtn && (this._pingBtn.unselect(), this._pingBox.close());
};
n.prototype._resetPicto = function () {
  this._removePingPicto();
  this._activePictoMap = {};
};
n.prototype.isActive = function () {
  return this._isActive;
};
n.prototype.getChatIcons = function () {
  return this._emoteBox.getChatIcons();
};
t.on("GameFightEndMessage", function () {
  e._reset();
  e._resetPicto();
});
i.on("selected", function () {
  t.playerData.isFighting && (l.setPriorityBehavior("TOUCH"), e._isActive = !0);
});
i.on("unselected", function () {
  t.playerData.isFighting && (e._isActive = !1, e._pingBox.close());
});
i.on("emoteBtnTap", function () {
  if (e._emoteBox.isOpen) {
    e._emoteBox.hide();
  } else {
    if (t.playerData.isFighting) {
      return;
    }
    e._emoteBox.show();
    e._emoteBox.refreshPosition();
  }
});
n.on("actionSent", function () {
  e._reset();
});
e._reset();
e._resetPicto();
e._emoteBox.show();
e._emoteBox.refreshPosition();
window.isoEngine.mapRenderer.removePingPicto(e);
delete o._activePictoMap[e];
this._activePictoMap[e] && (window.isoEngine.mapRenderer.removePingPicto(e), delete o._activePictoMap[e]);
window.isoEngine.mapRenderer.addPingPictoOnCell(e, t, i);
this._activePictoMap[e] = n(e);
this._isActive = !1;
this._pingBtn && (this._pingBtn.unselect(), this._pingBox.close());
this._removePingPicto();
this._activePictoMap = {};
this._pingBtn = t.appendChild(new o({
  className: "pingBtn",
  scaleOnPress: !0,
  tooltip: s("tablet.pingsystem.pingsystem"),
  hidden: !0
}, function () {
  window.gui.playerData.isFighting && (e._isActivated ? (e.unselect(), u.log("HUD.Click_on_button", {
    interface_id: "mainUI",
    button_id: "BTN_PING",
    clic_parameter_key: "using",
    clic_parameter_value: !1,
    clic_type: "Simple_court"
  })) : (e.select(), u.log("HUD.Click_on_button", {
    interface_id: "mainUI",
    button_id: "BTN_PING",
    clic_parameter_key: "using",
    clic_parameter_value: !0,
    clic_type: "Simple_court"
  })));
}));
this._emoteBtn = t.appendChild(new o({
  className: "emoteBtn",
  tooltip: s("tablet.common.emotesAndSmilies")
}, function () {
  window.gui.playerData.isFighting || (e.unselect(), e.emit("emoteBtnTap"));
}));
this._setupEvents();
this._resize();
this.exclusiveSelector = d("shortcutSlots");
this.exclusiveSelector.register(this);
r(n, a);
e.exports = n;
n.prototype._setupEvents = function () {
  var e = this,
    t = window.gui;
  t.on("resize", function () {
    e._resize();
  });
};
n.prototype._resize = function () {
  var e = l.pingEmoteBtnSize;
  if (window.gui.ipadRatio) {
    this.setStyles({
      top: "",
      right: "",
      left: l.posPingEmoteBtn + "px",
      bottom: "0",
      width: e + "px",
      height: l.bottomBarHeight + "px"
    });
  } else {
    var t = l.sideBarWidth - c.PING_EMOTE_BTN_WIDE_MIN_WIDTH;
    this.setStyles({
      bottom: "",
      left: "",
      right: t + "px",
      top: l.posPingEmoteBtn + "px",
      width: c.PING_EMOTE_BTN_WIDE_MIN_WIDTH + "px",
      height: e + "px"
    });
  }
};
n.prototype.select = function () {
  this._pingBtn.addClassNames("on");
  this._isActivated = !0;
  this.emit("selected");
};
n.prototype.unselect = function () {
  this._pingBtn.delClassNames("on");
  this._isActivated = !1;
  this.emit("unselected");
};
n.prototype.enterFightState = function () {
  this._pingBtn.show();
  this._emoteBtn.hide();
  this._resize();
};
n.prototype.enterRolePlayState = function () {
  this._emoteBtn.show();
  this._pingBtn.hide();
  this._resize();
};
this._pingBtn.addClassNames("on");
this._isActivated = !0;
this.emit("selected");
this._pingBtn.delClassNames("on");
this._isActivated = !1;
this.emit("unselected");
this._pingBtn.show();
this._emoteBtn.hide();
this._resize();
this._emoteBtn.show();
this._pingBtn.hide();
this._resize();
a.call(this);
this._currentSelection = null;
this._onSelected = function () {
  e._selectionChanged(this, !0);
};
this._onUnselected = function () {
  e._selectionChanged(this, !1);
};
o.inherits(n, a);
t.ExclusiveSelector = n;
n.prototype.register = function (e) {
  return "function" != typeof e.unselect ? console.error(new Error("ExclusiveSelector.register: target does not have an unselect method")) : e.listeners("selected").indexOf(this._onSelected) !== -1 ? console.error(new Error("Dupe call to ExclusiveSelector.register")) : (e.on("selected", this._onSelected), void e.on("unselected", this._onUnselected));
};
n.prototype.unregister = function (e) {
  return e.listeners("selected").indexOf(this._onSelected) === -1 ? console.error(new Error("ExclusiveSelector extra unregister")) : (e.removeListener("selected", this._onSelected), void e.removeListener("unselected", this._onUnselected));
};
n.prototype._selectionChanged = function (e, t) {
  if (t) {
    if (this._currentSelection) {
      if (e === this._currentSelection) {
        return;
      }
      this._currentSelection.unselect();
    }
    this._currentSelection = e;
  } else {
    e === this._currentSelection && (this._currentSelection = null);
  }
  this.emit("selectionChanged", this._currentSelection);
};
t.getExclusiveSelectorByGroup = function (e) {
  if (e || (e = "default"), e in s) {
    return s[e];
  }
  var t = new n();
  return s[e] = t, t;
};
this._isOpen = !1;
this._cellId = -1;
this._setWheel();
this.on("hide", function () {
  window.isoEngine.mapRenderer.deletePingHighlight(this._cellId);
  this._isOpen = !1;
});
t.on("disconnect", function () {
  e.close();
});
window.isoEngine.mapRenderer.deletePingHighlight(this._cellId);
this._isOpen = !1;
s(n, o);
e.exports = n;
n.prototype._setContext = function (e) {
  function t(e, t) {
    return "ui.pingSystem.context" + e + ".text" + t;
  }
  if (this._buttons.length) {
    var i = this;
    this._context = e;
    this._buttons.forEach(function (n) {
      i._svg.setAttributes({
        fill: "url(#imgPatternContext" + e + "Icon" + (n._id - 1) + ")"
      }, n.icon);
      n.text.setText(c(t(e, n._id)));
    });
    i._svg.setAttributes({
      fill: "url(#contextCircleBorder" + e + ")"
    }, this._circle);
  }
};
n.prototype._setButtonEvent = function (e) {
  function t(e, t, n) {
    window.dofus.sendMessage("PingRequestMessage", {
      cell: e,
      type: t,
      targetType: n
    });
    i.emit("actionSent");
  }
  var i = this;
  e.on("tap", function () {
    u.log("HUD.Click_on_button", {
      interface_id: "PingBox",
      button_id: "BTN_PING_" + this._id,
      clic_parameter_key: "context",
      clic_parameter_value: i._context,
      clic_type: "Simple_court"
    });
    t(i._cellId, this._id, i._context);
  });
};
n.prototype._setWheel = function () {
  function e(e, t, i, n, o) {
    var a = Math.PI / 180,
      s = i / 2,
      r = Math.cos(a * o) * s + e,
      l = -Math.sin(a * o) * s + t,
      c = Math.cos(a * n) * s + e,
      d = -Math.sin(a * n) * s + t;
    return "M" + e + " " + t + " " + r + " " + l + " A" + s + " " + s + " 0 0 1 " + c + " " + d + "Z";
  }
  var t = 2 * l.mapLeft,
    i = window.gui.ipadRatio ? 0 : 2 * l.mapTop,
    n = l.screenWidth,
    o = l.screenHeight,
    s = l.mapWidth + t,
    c = l.mapHeight + i,
    u = l.mapHeight > 720 ? 680 : l.mapHeight - 40,
    g = this;
  this._svg = this.appendChild(new a({
    attr: {
      viewBox: "0 0 " + n + " " + o
    }
  }));
  var _ = this._svg.newElement("g"),
    v = this._svg.newElement("defs", {
      parent: _
    }),
    y = this._svg.newElement("pattern", {
      parent: v,
      attr: {
        id: "imgPattern",
        width: "1",
        height: "1"
      }
    });
  Object.keys(f).forEach(function (e) {
    d.preloadImageUrls(f[e].icons, function (t) {
      for (var i = 0; i < t.length; i++) {
        var n = g._svg.newElement("pattern", {
          parent: v,
          attr: {
            id: "imgPatternContext" + e + "Icon" + i,
            width: "1",
            height: "1"
          }
        });
        g._svg.newElement("image", {
          parent: n,
          attr: {
            href: t[i],
            width: .24 * u
          }
        });
      }
    });
    d.preloadImageUrl(f[e].circle, function (t) {
      var i = g._svg.newElement("pattern", {
        parent: v,
        attr: {
          id: "contextCircleBorder" + e,
          width: "1",
          height: "1"
        }
      });
      g._svg.newElement("image", {
        parent: i,
        attr: {
          href: t,
          width: u / 3.5 + "px"
        }
      });
    });
  });
  d.preloadImageUrl(h, function (e) {
    g._svg.newElement("image", {
      parent: y,
      attr: {
        href: e,
        transform: "translate(5, 0)",
        width: Math.sin(30 * (Math.PI / 180)) * (.5 * (u - 20)) * 2 + "px"
      }
    });
  });
  var w = this._svg.newElement("pattern", {
    parent: v,
    attr: {
      id: "imgPatternClose",
      width: "1",
      height: "1"
    }
  });
  d.preloadImageUrl(p, function (e) {
    g._svg.newElement("image", {
      parent: w,
      attr: {
        href: e,
        width: "60px"
      }
    });
  });
  var b = this._svg.newElement("pattern", {
    parent: v,
    attr: {
      id: "imgPatternCancel",
      width: "1",
      height: "1"
    }
  });
  d.preloadImageUrl(m, function (e) {
    g._svg.newElement("image", {
      parent: b,
      attr: {
        href: e,
        width: "60px"
      }
    });
  });
  var M = {
    icon: {
      width: .24 * u,
      height: .21 * u,
      x: .5 * s - .12 * u,
      y: .5 * c - .23 * u
    },
    elements: [{
      arc: {},
      icon: {
        transform: "translate(0, " + .25 * -u + ")"
      },
      text: {
        x: .5 * s,
        y: .5 * c - .25 * u,
        textanchor: "middle",
        fill: "white",
        style: "font-size: 18px; font-weight: bold;"
      }
    }, {
      arc: {
        transform: "rotate(60 " + .5 * s + " " + .5 * c + ")"
      },
      icon: {
        transform: "translate(" + .275 * u + ", " + .1 * -u + ")"
      },
      text: {
        x: .5 * s + .275 * u,
        y: .5 * c - .1 * u,
        textanchor: "middle",
        fill: "white",
        style: "font-size: 18px; font-weight: bold;"
      }
    }, {
      arc: {
        transform: "rotate(120 " + .5 * s + " " + .5 * c + ")"
      },
      icon: {
        transform: "translate(" + .275 * u + ", " + .225 * u + ")"
      },
      text: {
        x: .5 * s + .275 * u,
        y: .5 * c + .225 * u,
        textanchor: "middle",
        fill: "white",
        style: "font-size: 18px; font-weight: bold;"
      }
    }, {
      arc: {
        transform: "rotate(180 " + .5 * s + " " + .5 * c + ")"
      },
      icon: {
        transform: "translate(0, " + .375 * u + ")"
      },
      text: {
        x: .5 * s,
        y: .5 * c + .375 * u,
        textanchor: "middle",
        fill: "white",
        style: "font-size: 18px; font-weight: bold;"
      }
    }, {
      arc: {
        transform: "rotate(240 " + .5 * s + " " + .5 * c + ")"
      },
      icon: {
        transform: "translate(" + .275 * -u + ", " + .225 * u + ")"
      },
      text: {
        x: .5 * s - .275 * u,
        y: .5 * c + .225 * u,
        textanchor: "middle",
        fill: "white",
        style: "font-size: 18px; font-weight: bold;"
      }
    }, {
      arc: {
        transform: "rotate(300 " + .5 * s + " " + .5 * c + ")"
      },
      icon: {
        transform: "translate(" + .275 * -u + ", " + .1 * -u + ")"
      },
      text: {
        x: .5 * s - .275 * u,
        y: .5 * c - .1 * u,
        textanchor: "middle",
        fill: "white",
        style: "font-size: 18px; font-weight: bold;"
      }
    }]
  };
  this._buttons = [];
  var T = this._svg.newElement("pattern", {
      parent: v,
      attr: {
        id: "contextCircle",
        width: "1",
        height: "1"
      }
    }),
    C = l.mapHeight / l.mapWidth,
    I = (u / 3.55 * C - u / 3.55) / 2 - 10;
  this._contextCircle = this._svg.newElement("image", {
    parent: T,
    attr: {
      height: u / 3.55 + "px",
      transform: "translate(" + I + ", 0)"
    }
  });
  for (var A = 0; A < M.elements.length; A++) {
    var S = this._svg.newElement("g", {
      parent: _
    });
    S._id = this._buttons.length + 1;
    r(S, null);
    this._setButtonEvent(S);
    this._svg.newElement("path", {
      parent: S,
      attr: {
        d: e(.5 * s, .5 * c, u, 60, 120),
        fill: "url(#imgPattern)",
        transform: M.elements[A].arc.transform || ""
      }
    });
    S.icon = this._svg.newElement("rect", {
      parent: S,
      attr: {
        width: M.icon.width,
        height: M.icon.height,
        x: M.icon.x,
        y: M.icon.y,
        transform: M.elements[A].icon.transform
      }
    });
    S.text = this._svg.newElement("text", {
      parent: S,
      attr: {
        width: M.icon.width,
        x: M.elements[A].text.x,
        y: M.elements[A].text.y,
        "text-anchor": "middle",
        fill: M.elements[A].text.fill,
        style: M.elements[A].text.style
      }
    });
    this._buttons.push(S);
  }
  this._svg.newElement("circle", {
    parent: _,
    attr: {
      cx: .5 * s,
      cy: .5 * c,
      r: u / 7.1,
      fill: "url(#contextCircle)"
    }
  });
  this._circle = this._svg.newElement("circle", {
    parent: _,
    attr: {
      cx: .5 * s,
      cy: .5 * c,
      r: u / 7,
      fill: "url(#contextCircleBorder)"
    }
  });
  var E = this._svg.newElement("circle", {
    parent: _,
    attr: {
      cx: .8 * s,
      cy: .86 * c,
      r: "30",
      fill: "url(#imgPatternClose)"
    }
  });
  r(E, null);
  E.on("tap", function () {
    g.emit("actionSent");
  });
  var N = this._svg.newElement("circle", {
    parent: _,
    attr: {
      cx: .8 * s + 60,
      cy: .86 * c - 65,
      r: "30",
      fill: "url(#imgPatternCancel)"
    }
  });
  r(N, null);
  N.on("tap", function () {
    g.close();
  });
  this.hide();
};
n.prototype.isOpen = function () {
  return this._isOpen;
};
n.prototype.open = function (e, t) {
  if (!this.isOpen()) {
    this._isOpen = !0;
    var i = this;
    this._setContext(t);
    var n = window.foreground;
    this._cellId = e;
    n.confirmBox.close();
    n.deselectSpell();
    window.gui.shortcutBar.deselectCurrentSlot();
    var o = l.mapHeight > 720 ? 680 : l.mapHeight - 40,
      a = window.isoEngine.mapRenderer.getCellSceneCoordinate(e),
      s = window.background.scene.getImage(a, o / 3.55);
    s || console.error(new Error("Preview is missing inside the PingBox"));
    i._svg.setAttributes({
      href: s
    }, i._contextCircle);
    i.show();
  }
};
n.prototype.close = function () {
  this._isOpen && (this._isOpen = !1, this.hide(), this._cellId = -1);
};
this._context = e;
this._buttons.forEach(function (n) {
  i._svg.setAttributes({
    fill: "url(#imgPatternContext" + e + "Icon" + (n._id - 1) + ")"
  }, n.icon);
  n.text.setText(c(t(e, n._id)));
});
i._svg.setAttributes({
  fill: "url(#contextCircleBorder" + e + ")"
}, this._circle);
i._svg.setAttributes({
  fill: "url(#imgPatternContext" + e + "Icon" + (n._id - 1) + ")"
}, n.icon);
n.text.setText(c(t(e, n._id)));
window.dofus.sendMessage("PingRequestMessage", {
  cell: e,
  type: t,
  targetType: n
});
i.emit("actionSent");
u.log("HUD.Click_on_button", {
  interface_id: "PingBox",
  button_id: "BTN_PING_" + this._id,
  clic_parameter_key: "context",
  clic_parameter_value: i._context,
  clic_type: "Simple_court"
});
t(i._cellId, this._id, i._context);
Object.keys(f).forEach(function (e) {
  d.preloadImageUrls(f[e].icons, function (t) {
    for (var i = 0; i < t.length; i++) {
      var n = g._svg.newElement("pattern", {
        parent: v,
        attr: {
          id: "imgPatternContext" + e + "Icon" + i,
          width: "1",
          height: "1"
        }
      });
      g._svg.newElement("image", {
        parent: n,
        attr: {
          href: t[i],
          width: .24 * u
        }
      });
    }
  });
  d.preloadImageUrl(f[e].circle, function (t) {
    var i = g._svg.newElement("pattern", {
      parent: v,
      attr: {
        id: "contextCircleBorder" + e,
        width: "1",
        height: "1"
      }
    });
    g._svg.newElement("image", {
      parent: i,
      attr: {
        href: t,
        width: u / 3.5 + "px"
      }
    });
  });
});
d.preloadImageUrl(h, function (e) {
  g._svg.newElement("image", {
    parent: y,
    attr: {
      href: e,
      transform: "translate(5, 0)",
      width: Math.sin(30 * (Math.PI / 180)) * (.5 * (u - 20)) * 2 + "px"
    }
  });
});
d.preloadImageUrls(f[e].icons, function (t) {
  for (var i = 0; i < t.length; i++) {
    var n = g._svg.newElement("pattern", {
      parent: v,
      attr: {
        id: "imgPatternContext" + e + "Icon" + i,
        width: "1",
        height: "1"
      }
    });
    g._svg.newElement("image", {
      parent: n,
      attr: {
        href: t[i],
        width: .24 * u
      }
    });
  }
});
d.preloadImageUrl(f[e].circle, function (t) {
  var i = g._svg.newElement("pattern", {
    parent: v,
    attr: {
      id: "contextCircleBorder" + e,
      width: "1",
      height: "1"
    }
  });
  g._svg.newElement("image", {
    parent: i,
    attr: {
      href: t,
      width: u / 3.5 + "px"
    }
  });
});
S._id = this._buttons.length + 1;
r(S, null);
this._setButtonEvent(S);
this._svg.newElement("path", {
  parent: S,
  attr: {
    d: e(.5 * s, .5 * c, u, 60, 120),
    fill: "url(#imgPattern)",
    transform: M.elements[A].arc.transform || ""
  }
});
S.icon = this._svg.newElement("rect", {
  parent: S,
  attr: {
    width: M.icon.width,
    height: M.icon.height,
    x: M.icon.x,
    y: M.icon.y,
    transform: M.elements[A].icon.transform
  }
});
S.text = this._svg.newElement("text", {
  parent: S,
  attr: {
    width: M.icon.width,
    x: M.elements[A].text.x,
    y: M.elements[A].text.y,
    "text-anchor": "middle",
    fill: M.elements[A].text.fill,
    style: M.elements[A].text.style
  }
});
this._buttons.push(S);
this._svg.newElement("circle", {
  parent: _,
  attr: {
    cx: .5 * s,
    cy: .5 * c,
    r: u / 7.1,
    fill: "url(#contextCircle)"
  }
});
this._circle = this._svg.newElement("circle", {
  parent: _,
  attr: {
    cx: .5 * s,
    cy: .5 * c,
    r: u / 7,
    fill: "url(#contextCircleBorder)"
  }
});
r(E, null);
E.on("tap", function () {
  g.emit("actionSent");
});
r(N, null);
N.on("tap", function () {
  g.close();
});
this.hide();
this._cellId = e;
n.confirmBox.close();
n.deselectSpell();
window.gui.shortcutBar.deselectCurrentSlot();
s || console.error(new Error("Preview is missing inside the PingBox"));
i._svg.setAttributes({
  href: s
}, i._contextCircle);
i.show();
e = e || {};
a.call(this, document.createElementNS("http://www.w3.org/2000/svg", "svg"));
this.addClassNames("Svg");
this.style = this.rootElement.style;
e.attr && this.setAttributes(e.attr);
o(n, a);
e.exports = n;
n.prototype.newElement = function (e, t) {
  t = t || {};
  var i = t.parent ? t.parent : this,
    n = new a(document.createElementNS("http://www.w3.org/2000/svg", e));
  return t.attr && this.setAttributes(t.attr, n), i.appendChild(n);
};
n.prototype.setAttributes = function (e, t) {
  t = t || this;
  t.rootElement && (e = e || {}, Object.keys(e).forEach(function (i) {
    t.rootElement.setAttribute(i, e[i]);
  }));
};
Object.defineProperty(n.prototype, "width", {
  get: function () {
    return this.rootElement.width;
  },
  set: function (e) {
    this.rootElement.width = e;
  }
});
Object.defineProperty(n.prototype, "height", {
  get: function () {
    return this.rootElement.height;
  },
  set: function (e) {
    this.rootElement.height = e;
  }
});
t = t || this;
t.rootElement && (e = e || {}, Object.keys(e).forEach(function (i) {
  t.rootElement.setAttribute(i, e[i]);
}));
a.call(this, "div", {
  className: "EmoteBox"
});
this._chatIcons = new o();
this.appendChild(this._chatIcons);
this._chatIcons.on("closing", function () {
  e.hide();
});
this.isOpen = !1;
this._emoteBoxSize = 85;
this._time = 200;
this._delay = 0;
this._easing = "ease-out";
s(n, a);
e.exports = n;
n.prototype.refreshPosition = function () {
  window.gui.ipadRatio ? (this._chatIcons.setPanelsStyle("right", "auto"), this._chatIcons.setPanelsStyle("left", r.pingEmoteBtnSize + "px"), this._chatIcons.setPanelsStyle("bottom", this._emoteBoxSize + "px"), this.setStyle("left", l.CHAT_BTN_MIN_WIDTH + "px"), this.setStyle("width", r.pingEmoteBtnSize + "px"), this.setStyle("height", this._emoteBoxSize + "px"), this.setStyle("bottom", r.bottomBarHeight + "px"), this.setStyle("line-height", "inherit")) : (this._chatIcons.setPanelsStyle("left", "auto"), this._chatIcons.setPanelsStyle("right", this._emoteBoxSize + "px"), this._chatIcons.setPanelsStyle("bottom", r.pingEmoteBtnSize + "px"), this.setStyle("left", r.mapRight - this._emoteBoxSize + "px"), this.setStyle("width", this._emoteBoxSize + "px"), this.setStyle("height", r.pingEmoteBtnSize + "px"), this.setStyle("bottom", "0px"), this.setStyle("line-height", r.pingEmoteBtnSize + "px"));
};
n.prototype.getChatIcons = function () {
  return this._chatIcons;
};
n.prototype.show = function () {
  var e = this;
  e.setStyle("visibility", "visible");
  c.tween(this, {
    webkitTransform: "translate3d(0, 0, 0)"
  }, {
    time: this._time,
    delay: this._delay,
    easing: this._easing
  }, function () {
    e.isOpen = !0;
  });
};
n.prototype.hide = function () {
  var e = this;
  window.gui.ipadRatio ? c.tween(this, {
    webkitTransform: "translate3d(0, " + this._emoteBoxSize + "px, 0)"
  }, {
    time: this._time,
    delay: this._delay,
    easing: this._easing
  }, function () {
    e.setStyle("visibility", "collapse");
    e.isOpen = !1;
  }) : c.tween(this, {
    webkitTransform: "translate3d(" + this._emoteBoxSize + "px, 0, 0)"
  }, {
    time: this._time,
    delay: this._delay,
    easing: this._easing
  }, function () {
    e.setStyle("visibility", "collapse");
    e.isOpen = !1;
  });
};
e.setStyle("visibility", "visible");
c.tween(this, {
  webkitTransform: "translate3d(0, 0, 0)"
}, {
  time: this._time,
  delay: this._delay,
  easing: this._easing
}, function () {
  e.isOpen = !0;
});
e.setStyle("visibility", "collapse");
e.isOpen = !1;
e.setStyle("visibility", "collapse");
e.isOpen = !1;
r.call(this, "div", {
  className: "ChatIcons"
});
this.openPanel = null;
this.smileysButton = t.createChild("div", {
  className: "smileysButton",
  tooltip: a("ui.chat.smilies")
});
this.attitudesButton = t.createChild("div", {
  className: "attitudesButton",
  tooltip: a("ui.common.emotes")
});
o(this.smileysButton, a("ui.chat.smilies"));
o(this.attitudesButton, a("ui.common.emotes"));
this.smileysPanel = i.createChild("div", {
  className: "smileysPanel"
});
this.attitudesPanel = i.createChild("div", {
  className: "attitudesPanel"
});
this.smileysPanel.hide();
this.attitudesPanel.hide();
this.smileysButton.on("tap", function () {
  u.hide();
  "smileys" === e.openPanel ? e.closePanels() : (e.openSmileys(), e.emit("activated"));
});
this.attitudesButton.on("tap", function () {
  u.hide();
  "attitudes" === e.openPanel ? e.closePanels() : (e.openAttitudes(), e.emit("activated"));
});
u.on("show", function () {
  "smileys" !== e.openPanel && "attitudes" !== e.openPanel || e.closePanels();
});
this.once("open", this.loadIcons);
this.attitudeList = {};
this.currentMood = null;
this.previousMood = -1;
this.setMessageHandlers();
u.hide();
"smileys" === e.openPanel ? e.closePanels() : (e.openSmileys(), e.emit("activated"));
u.hide();
"attitudes" === e.openPanel ? e.closePanels() : (e.openAttitudes(), e.emit("activated"));
s(n, r);
e.exports = n;
n.prototype.setMessageHandlers = function () {
  var e = this,
    t = window.gui;
  t.on("MoodSmileyResultMessage", function (i) {
    var n = i.resultCode;
    return n === p.MOOD_ERROR_UNKNOWN ? (e.setCurrentMood(e.previousMood), t.openSimplePopup(a("ui.smiley.errorMood"))) : n === p.MOOD_ERROR_FLOOD ? (e.setCurrentMood(e.previousMood), t.openSimplePopup(a("ui.smiley.errorFloodMood"))) : (e.setCurrentMood(i.smileyId), void (e.previousMood = i.smileyId));
  });
  t.on("disconnect", function () {
    e.setCurrentMood(-1);
    e.previousMood = -1;
  });
};
n.prototype.bindToPlayerEmoteData = function () {
  var e = this,
    t = window.gui.playerData.emoteData;
  t.on("emoteAdded", function (t) {
    c.preloadImage("gfx/emotes/" + t.id + ".png", function (i) {
      e.addAttitudeIcon(t, i);
    });
  });
  t.on("emoteRemoved", function (t) {
    e.removeAttitudeIcon(t);
  });
  t.on("emoteListUpdated", function (t) {
    e.loadEmotes(t);
  });
};
n.prototype.loadIcons = function () {
  var e = this;
  this.loadEmotes(window.gui.playerData.emoteData.list);
  this.smileysPanel.addClassNames("spinner");
  for (var t = window.gui.databases.Smileys, i = Object.keys(t), n = [], o = 0; o < i.length; o++) {
    n.push("gfx/smilies/" + t[i[o]].gfxId + ".png");
  }
  c.preloadImages(n, function (n) {
    for (var o = 0; o < n.length; o++) {
      e.addSmileyIcon(t[i[o]], n[o]);
    }
    e.smileysPanel.delClassNames("spinner");
  });
  this.bindToPlayerEmoteData();
};
n.prototype.loadEmotes = function (e) {
  var t = this;
  this.attitudesPanel.clearContent();
  this.attitudeList = {};
  this.attitudesPanel.addClassNames("spinner");
  var i = Object.keys(e);
  i = i.map(function (e) {
    return parseInt(e, 10);
  });
  i = i.sort(function (e, t) {
    return e - t;
  });
  for (var n = [], o = 0; o < i.length; o++) {
    n.push("gfx/emotes/" + i[o] + ".png");
  }
  c.preloadImages(n, function (n) {
    for (var o = 0; o < n.length; o++) {
      t.addAttitudeIcon(e[i[o]], n[o]);
    }
    t.attitudesPanel.delClassNames("spinner");
  });
};
n.prototype._addDraggableBehaviourTo = function (e, t, i) {
  var n = {
      prepareForDrag: function (t, i) {
        return i.setStyle("backgroundImage", e.getStyle("backgroundImage")), e.once("dragEnd", function () {
          i.setStyle("backgroundImage", null);
        }), !0;
      }
    },
    o = {
      id: i
    },
    a = {
      dragOnTouchstart: !1,
      dragElement: !1,
      noHover: !1
    };
  h.setDraggable(e, n, t, o, a);
};
n.prototype.addAttitudeIcon = function (e, t) {
  function i() {
    window.dofus.sendMessage("EmotePlayRequestMessage", {
      emoteId: this.id
    });
    n.closePanels();
  }
  var n = this,
    o = this.attitudesPanel.createChild("div", {
      className: ["chatIcon", "attitudeIcon"]
    });
  o.id = e.id;
  o.setStyle("backgroundImage", t);
  this.attitudeList[e.id] = o;
  this._addDraggableBehaviourTo(o, "attitude", o.id);
  l(o);
  o.on("tap", i);
};
n.prototype.removeAttitudeIcon = function (e) {
  var t = this.attitudeList[e];
  t && (t.destroy(), delete this.attitudeList[e]);
};
n.prototype.setCurrentMood = function (e) {
  var t = this.smileysPanel.getChild(e);
  this.currentMood !== t && (this.currentMood && this.currentMood.delClassNames("mood"), t && t.addClassNames("mood"), this.currentMood = t);
};
n.prototype.addSmileyIcon = function (e, t) {
  function i() {
    window.dofus.sendMessage("ChatSmileyRequestMessage", {
      smileyId: this.id
    });
    o.closePanels();
  }
  function n() {
    var e = o.currentMood === this ? -1 : this.id;
    o.setCurrentMood(e);
    window.dofus.sendMessage("MoodSmileyRequestMessage", {
      smileyId: e
    });
  }
  if (e.forPlayers) {
    var o = this,
      a = new r("div", {
        name: e.id,
        className: ["chatIcon", "smileyIcon"]
      });
    a.id = e.id;
    a.setStyle("backgroundImage", t);
    l(a);
    a.on("tap", i);
    a.on("longtap", n);
    this.smileysPanel.appendChild(a);
    this._addDraggableBehaviourTo(a, "smiley", a.id);
  }
};
n.prototype.openSmileys = function () {
  this.emit("open");
  this.attitudesPanel.hide();
  this.smileysPanel.show();
  this.openPanel = "smileys";
};
n.prototype.openAttitudes = function () {
  this.emit("open");
  this.smileysPanel.hide();
  this.attitudesPanel.show();
  this.openPanel = "attitudes";
};
n.prototype.closePanels = function () {
  this.emit("closing");
  this.smileysPanel.hide();
  this.attitudesPanel.hide();
  this.openPanel = null;
};
n.prototype.setPanelsStyle = function (e, t) {
  this.smileysPanel.setStyle(e, t);
  this.attitudesPanel.setStyle(e, t);
};
n.prototype.positionPanel = function () {
  function e(e, t) {
    var i = d(e, t);
    e.setStyles({
      left: i.x + "px",
      top: i.y + "px"
    });
  }
  e(this.smileysPanel, this.smileysButton);
  e(this.attitudesPanel, this.attitudesButton);
};
t.on("MoodSmileyResultMessage", function (i) {
  var n = i.resultCode;
  return n === p.MOOD_ERROR_UNKNOWN ? (e.setCurrentMood(e.previousMood), t.openSimplePopup(a("ui.smiley.errorMood"))) : n === p.MOOD_ERROR_FLOOD ? (e.setCurrentMood(e.previousMood), t.openSimplePopup(a("ui.smiley.errorFloodMood"))) : (e.setCurrentMood(i.smileyId), void (e.previousMood = i.smileyId));
});
t.on("disconnect", function () {
  e.setCurrentMood(-1);
  e.previousMood = -1;
});
e.setCurrentMood(-1);
e.previousMood = -1;
t.on("emoteAdded", function (t) {
  c.preloadImage("gfx/emotes/" + t.id + ".png", function (i) {
    e.addAttitudeIcon(t, i);
  });
});
t.on("emoteRemoved", function (t) {
  e.removeAttitudeIcon(t);
});
t.on("emoteListUpdated", function (t) {
  e.loadEmotes(t);
});
this.loadEmotes(window.gui.playerData.emoteData.list);
this.smileysPanel.addClassNames("spinner");
c.preloadImages(n, function (n) {
  for (var o = 0; o < n.length; o++) {
    e.addSmileyIcon(t[i[o]], n[o]);
  }
  e.smileysPanel.delClassNames("spinner");
});
this.bindToPlayerEmoteData();
this.attitudesPanel.clearContent();
this.attitudeList = {};
this.attitudesPanel.addClassNames("spinner");
i = i.map(function (e) {
  return parseInt(e, 10);
});
i = i.sort(function (e, t) {
  return e - t;
});
window.dofus.sendMessage("EmotePlayRequestMessage", {
  emoteId: this.id
});
n.closePanels();
o.id = e.id;
o.setStyle("backgroundImage", t);
this.attitudeList[e.id] = o;
this._addDraggableBehaviourTo(o, "attitude", o.id);
l(o);
o.on("tap", i);
window.dofus.sendMessage("ChatSmileyRequestMessage", {
  smileyId: this.id
});
o.closePanels();
o.setCurrentMood(e);
window.dofus.sendMessage("MoodSmileyRequestMessage", {
  smileyId: e
});
a.id = e.id;
a.setStyle("backgroundImage", t);
l(a);
a.on("tap", i);
a.on("longtap", n);
this.smileysPanel.appendChild(a);
this._addDraggableBehaviourTo(a, "smiley", a.id);
this.emit("open");
this.attitudesPanel.hide();
this.smileysPanel.show();
this.openPanel = "smileys";
this.emit("open");
this.smileysPanel.hide();
this.attitudesPanel.show();
this.openPanel = "attitudes";
this.emit("closing");
this.smileysPanel.hide();
this.attitudesPanel.hide();
this.openPanel = null;
this.smileysPanel.setStyle(e, t);
this.attitudesPanel.setStyle(e, t);
e(this.smileysPanel, this.smileysButton);
e(this.attitudesPanel, this.attitudesButton);
this._characterList = [];
this._charaListMinusDeadPeople = [];
this._giftList = [];
this._assigningGifts = {};
this._autoAssign = !1;
this._toaRetryPending = [];
t.once("initialized", function () {
  e._setupEvents();
});
t.on("disconnect", function () {
  e._reset();
});
o(n, a);
e.exports = n;
n.prototype._setupEvents = function () {
  function e(e) {
    for (var t = [], n = 0; n < e.length; n += 1) {
      for (var o = e[n], a = o.uid, s = o.items || [], r = null, l = 0; l < s.length; l += 1) {
        if (s[l].objectGID === c.TOA_RETRY_ITEM_ID) {
          r = s[l];
          break;
        }
      }
      r ? i._autoAssign ? (i.assignGift(a, window.gui.playerData.id), i._autoAssign = !1) : i._toaRetryPending.push(a) : t.push(o);
    }
    return t;
  }
  function t(t) {
    var o = e(t);
    o.length && (r.getWindow("giftSelection").openState || n || i._reset(), n = !0, i.setCharacterList(l.getCharacterList()), i._createGiftList(o, function (e) {
      return e ? console.error(new Error("Gifts module: " + e)) : i._giftList.length ? void (i.getCharaListMinusDeadPeople().length && (r.open("giftSelection", i._giftList), n = !1)) : console.error(new Error("Gifts module: _giftList is empty"));
    }));
  }
  var i = this,
    n = !1;
  window.dofus.connectionManager.on("StartupActionsListMessage", function (e) {
    t(e.actions);
  });
  window.dofus.connectionManager.on("StartupActionAddMessage", function (e) {
    t([e.newAction]);
  });
  window.dofus.connectionManager.on("StartupActionFinishedMessage", function (e) {
    return e.success ? void (i._assigningGifts[e.actionId] ? (i._assigningGifts[e.actionId] = !1, i.emit("giftAssigned", e)) : (i._assigningGifts[e.actionId] = e.success, i.emit("giftAssignRequestResult", e))) : (window.gui.openSimplePopup(d("tablet.gift.unableToAssign"), d("tablet.gift.unableToAssignTitle")), void i.emit("giftAssignFailed", e));
  });
};
n.prototype._createGiftList = function (e, t) {
  for (var i = this, n = [], o = 0, a = e.length; o < a; o += 1) {
    for (var r = e[o], l = r.items, c = 0, d = l.length; c < d; c += 1) {
      var u = l[c];
      u && n.push(u);
    }
  }
  s.createItemInstances(n, function (n, o) {
    if (n) {
      return t(n);
    }
    for (var a = 0, s = 0, r = e.length; s < r; s += 1) {
      for (var l = e[s], c = [], d = l.items, u = 0, h = d.length; u < h; u += 1) {
        var p = o.array[a] || null;
        a += 1;
        p && c.push(p);
      }
      c.length && i._giftList.push({
        uid: l.uid,
        title: l.title,
        text: l.text,
        items: c
      });
    }
    t();
  });
};
n.prototype._reset = function () {
  this._characterList = [];
  this._charaListMinusDeadPeople = [];
  this._giftList = [];
  this._assigningGifts = {};
  this._autoAssign = !1;
  this._toaRetryPending = [];
};
n.prototype.getCharacterList = function () {
  return this._characterList;
};
n.prototype.getCharaListMinusDeadPeople = function () {
  return this._charaListMinusDeadPeople;
};
n.prototype.setCharacterList = function (e) {
  this._characterList = e;
  this._charaListMinusDeadPeople = [];
  var t = window.gui.playerData.characterBaseInformations;
  if (t.id) {
    for (var i = 0, n = e.length; i < n; i += 1) {
      var o = e[i];
      t.id === o.id && (o.deathState && 0 !== o.deathState || this._charaListMinusDeadPeople.push(o));
    }
  }
};
n.prototype.assignGift = function (e, t) {
  window.dofus.sendMessage("StartupActionsObjetAttributionMessage", {
    actionId: e,
    characterId: t
  });
};
n.prototype.setAutoAssign = function (e) {
  this._autoAssign = e;
};
n.prototype.getToaRetryPendingUid = function () {
  return this._toaRetryPending;
};
n.prototype.assignPendingToaRetry = function (e) {
  if (!this._toaRetryPending.length) {
    return console.error(new Error("Pending retry are empty " + e)), !1;
  }
  var t = this._toaRetryPending.indexOf(e);
  return t === -1 ? (console.error(new Error("No pending retry " + e)), !1) : (this.assignGift(e, window.gui.playerData.id), this._toaRetryPending.splice(t, 1), !0);
};
window.dofus.connectionManager.on("StartupActionsListMessage", function (e) {
  t(e.actions);
});
window.dofus.connectionManager.on("StartupActionAddMessage", function (e) {
  t([e.newAction]);
});
window.dofus.connectionManager.on("StartupActionFinishedMessage", function (e) {
  return e.success ? void (i._assigningGifts[e.actionId] ? (i._assigningGifts[e.actionId] = !1, i.emit("giftAssigned", e)) : (i._assigningGifts[e.actionId] = e.success, i.emit("giftAssignRequestResult", e))) : (window.gui.openSimplePopup(d("tablet.gift.unableToAssign"), d("tablet.gift.unableToAssignTitle")), void i.emit("giftAssignFailed", e));
});
a += 1;
p && c.push(p);
this._characterList = [];
this._charaListMinusDeadPeople = [];
this._giftList = [];
this._assigningGifts = {};
this._autoAssign = !1;
this._toaRetryPending = [];
this._characterList = e;
this._charaListMinusDeadPeople = [];
this._panels = null;
this._currentPanelType = null;
this._selectedSlot = null;
this._panelLoadingCb = {};
this._currentCharacterId = null;
this.isOrganizing = !1;
_.call(this, {
  backDrawerSize: d.SHORTCUT_GAUGE_SIZE
});
this._createDom();
this._setupEvents();
this.openPanel("item");
e.exclusiveSelector = A("shortcutSlots");
e.exclusiveSelector.register(e);
n.push(e);
O[l.GENERAL_SHORTCUT_BAR] = "item";
O[l.SPELL_SHORTCUT_BAR] = "spell";
g(n, _);
e.exports = n;
n.prototype._createDom = function () {
  function e(e) {
    t._pagination.setCurrent(e);
  }
  var t = this;
  this.addClassNames("ShortcutBar");
  this._panelBox = this.content.createChild("div", {
    className: "panelBox"
  });
  this._panels = {
    spell: this._panelBox.appendChild(this._createPanel("spell")),
    item: this._panelBox.appendChild(this._createPanel("item"))
  };
  this._buttonBox = this.content.createChild("div", {
    className: "buttonBox"
  });
  this.spellBtn = this._buttonBox.appendChild(new c({
    className: "spellBtn",
    tooltip: f("ui.charcrea.spells"),
    sound: "BANNER_SPELL_TAB"
  }, function () {
    t.openPanel("spell");
  }));
  this.itemBtn = this._buttonBox.appendChild(new c({
    className: "itemBtn",
    tooltip: f("ui.common.objects"),
    sound: "BANNER_SPELL_TAB"
  }, function () {
    t.openPanel("item");
  }));
  this._pagination = this._buttonBox.appendChild(new v({
    disableInput: !0,
    btnAlwaysEnabled: !0,
    soundPrev: "SCROLL_DOWN",
    soundNext: "SCROLL_UP"
  }));
  this._pagination.setPageCount(B);
  this._pagination.setCurrent(0);
  this._pagination.on("next", function () {
    t._panels[t._currentPanelType].openTab((this.current + 1) % B);
  });
  this._pagination.on("previous", function () {
    t._panels[t._currentPanelType].openTab(h.mod(this.current - 1, B));
  });
  this._panels.spell.on("openTab", e);
  this._panels.item.on("openTab", e);
  this._organizeBtn = this._buttonBox.appendChild(new c({
    className: "lockBtn",
    scaleOnPress: !0
  }, function () {
    t._setOrganizeMode(!t.isOrganizing);
  }));
  this._trashZone = this.createChild("div", {
    className: "trashZone"
  });
  this._trashZone.createChild("div", {
    className: "trashBin",
    text: f("ui.common.remove")
  });
  p.setDroppable(this._trashZone, ["shortcutBar"], {
    isDropAllowed: function () {
      return t.isOrganizing;
    }
  });
  this._trashZone.on("drop", function (e) {
    t._removeShortcutFromSlotRequestWith1Animation(e);
  });
  this.on("open", function () {
    I("WINDOW_OPEN");
  });
  this.on("close", function () {
    I("WINDOW_CLOSE");
    this.isOrganizing && this._setOrganizeMode(!1);
  });
};
n.prototype._createPanel = function (e) {
  var t = new y({
    noHeader: !0
  });
  t.slotList = new Array(P * B);
  t.slotMap = {};
  for (var i = "spell" === e ? N : E, n = 0; n < B; n++) {
    var o = new T("div", {
      className: "page"
    });
    t.addTab("", o, n);
    for (var a = 0; a < P; a++) {
      var s = n * P + a,
        r = new i(this, s);
      t.slotList[s] = r;
      o.appendChild(r);
      this._positionSlot(r);
    }
  }
  return t.openTab(0), t;
};
n.prototype._setupEvents = function () {
  var e = this,
    t = window.gui,
    i = t.playerData.characters,
    n = t.playerData.inventory,
    o = window.gui.scenarioManager;
  t.on("disconnect", function () {
    e.close();
    e.delClassNames("dragging");
    e._selectedSlot = null;
    e._emptyPanel("spell");
    e._emptyPanel("item");
    e._currentCharacterId = null;
    C.removeAllListeners("ShortcutBarAddErrorMessage");
    C.removeAllListeners("ShortcutBarRemoveErrorMessage");
    C.removeAllListeners("ShortcutBarSwapErrorMessage");
  });
  C.on("ShortcutBarContentMessage", function (t) {
    for (var n = O[t.barType], o = [], a = 0; a < t.shortcuts.length; a++) {
      o.push(new S(t.shortcuts[a]));
    }
    "spell" === n && i.getControlledCharacter().setSpellShortcuts(o);
    e._setPanelContentRequest(n, o);
  });
  C.on("ShortcutBarRefreshMessage", function (t) {
    var n = O[t.barType],
      o = new S(t.shortcut);
    e._isSlotIndexValid(o.slotIndex) && ("spell" === n && i.getControlledCharacter().updateSpellShortcut(o), e._setShortcutClient(o));
  });
  C.on("ShortcutBarRemovedMessage", function (t) {
    var i = O[t.barType];
    e._removeShortcutClient(i, t.slot);
  });
  i.on("switchControlledCharacter", function () {
    var t = i.getControlledCharacter();
    t.spellShortcuts ? e._setPanelContentRequest("spell", t.spellShortcuts) : e._emptyPanel("spell");
  });
  i.on("weaponChanged", function () {
    e._currentCharacterId === this.mainCharacter.spellData.characterId && e._updateWeaponSpell();
  });
  n.on("itemsDeleted", this._disableItems.bind(this));
  n.on("itemDeleted", this._disableItem.bind(this));
  n.on("itemsQuantity", this._updateItemsQuantity.bind(this));
  n.on("itemQuantity", this._updateItemQuantity.bind(this));
  n.on("itemModified", this._updateModifiedItem.bind(this));
  t.fightManager.on("fightEnterPreparation", this._fightPreparation.bind(this));
  t.fightManager.on("fightEnterBattle", this._fightEntered.bind(this));
  t.fightManager.on("fightEnd", this._fightExited.bind(this));
  o.on("stepChanged", function () {
    e.setAvailability(o.isBehaviourEnabled(L.SHORTCUT_BAR));
    o.isBehaviourEnabled(L.ORGANIZE_BTN) ? e._organizeBtn.enable() : e._organizeBtn.disable();
  });
  C.on("CurrentMapMessage", function () {
    o.isBehaviourEnabled(L.SHORTCUT_BAR) && e.setAvailability(!1);
  });
  window.isoEngine.on("mapLoaded", function () {
    o.isBehaviourEnabled(L.SHORTCUT_BAR) && e.setAvailability(!0);
  });
  t.playerData.characters.on("specificCharacteristicsUpdated", function (t) {
    "actionPointsCurrent" === t && e.updateSpellsAvailability();
  });
  t.fightManager.on("UpdatePreFightersList", this.updateSpellsAvailability.bind(this));
  t.fightManager.on("updateSpellsAvailability", this.updateSpellsAvailability.bind(this));
  t.on("GameFightTurnStartMessage", this.updateSpellsAvailability.bind(this));
  var a = A("shortcutSlots");
  a.on("selectionChanged", function (t) {
    t instanceof N || t instanceof E ? e._selectedSlot = t : null === t && (e._selectedSlot = null);
  });
};
n.prototype._isSlotIndexValid = function (e) {
  return e < P * B;
};
n.prototype._isShortcutValid = function (e) {
  return e instanceof S && this._isSlotIndexValid(e.slotIndex);
};
n.prototype.getSpellSlotByIndex = function (e) {
  var t = this._panels.spell.slotList;
  return t[e];
};
n.prototype.getSpellSlotBySpellId = function (e) {
  for (var t = this._panels.spell.slotList, i = 0; i < t.length; i++) {
    var n = t[i];
    if (n.data && n.data.id === e) {
      return n;
    }
  }
  return null;
};
n.prototype.enableSpellSlots = function (e) {
  for (var t = this._panels.spell.slotList, i = 0; i < t.length; i++) {
    var n = t[i];
    n.enableBehaviour(e);
  }
};
n.prototype._updateItemQuantity = function (e, t) {
  var i = this._panels.item.slotMap["item" + e];
  if (i) {
    for (var n = 0; n < i.length; n++) {
      i[n].setQuantity(t);
    }
  }
};
n.prototype._updateItemsQuantity = function (e) {
  for (var t in e) {
    this._updateItemQuantity(t, e[t]);
  }
};
n.prototype._disableItem = function (e) {
  var t = this._panels.item.slotMap["item" + e];
  if (t) {
    for (var i = 0; i < t.length; i++) {
      var n = t[i];
      n.icon.addClassNames("disabled");
      n.isDisabled = !0;
    }
  }
};
n.prototype._disableItems = function (e) {
  for (var t = 0; t < e.length; t++) {
    this._disableItem(e[t]);
  }
};
n.prototype._updateModifiedItem = function (e) {
  var t = this._panels.item.slotMap["item" + e.objectUID];
  if (t) {
    for (var i = 0; i < t.length; i++) {
      t[i].refreshShortcut();
    }
  }
};
n.prototype._updateSpellSlotAvailability = function (e) {
  if ("spell" === e.type) {
    var t;
    if (x.isFightMode && !e.isEmpty()) {
      var i = e.shortcut.spellId;
      e.isDisabled = !window.gui.fightManager.canCastThisSpell(i);
      t = window.gui.fightManager.getSpellCooldown(i);
    } else {
      e.isDisabled = !1;
      t = 0;
    }
    e.isDisabled && this._unSelectSlot(e);
    e.icon.toggleClassName("disabled", e.isDisabled);
    e.setCooldown(t);
  }
};
n.prototype.updateSpellAvailability = function (e) {
  if (this._currentCharacterId === window.gui.playerData.characters.controlledCharacterId) {
    var t = this._panels.spell.slotMap["spell" + e];
    if (t) {
      for (var i = 0; i < t.length; i++) {
        this._updateSpellSlotAvailability(t[i]);
      }
    }
  }
};
n.prototype.updateSpellsAvailability = function () {
  if (this._currentCharacterId === window.gui.playerData.characters.controlledCharacterId) {
    for (var e = this._panels.spell.slotList, t = 0; t < e.length; t++) {
      var i = e[t];
      i.isEmpty() || this._updateSpellSlotAvailability(i);
    }
  }
};
n.prototype.setAvailability = function (e) {
  this.overlay ? this.overlay.toggleDisplay(!e) : this.overlay = this.content.createChild("div", {
    className: "overlay",
    hidden: e
  });
  this.lockDrawer(!e);
};
n.prototype.computeBestSize = function (e, t) {
  var i;
  return "narrow" === t ? (i = d.ICONBAR_TAB_WIDTH + d.ICONBAR_CORNER_WIDTH, this._iconsVisiblePerLine = ~~((e - i) / D), this._iconsVisiblePerLine * D + i) : (i = d.ICONBAR_TAB_HEIGHT, this._iconsVisiblePerColumn = ~~((e - i) / D), this._iconsVisiblePerColumn * D + i);
};
n.prototype._setPlaceHolder = function (e, t) {
  for (var i = this._panels[e], n = i.slotList, o = 0, a = t.length; o < a; o += 1) {
    var s = t[o];
    this._isSlotIndexValid(s.slotIndex) && (n[s.slotIndex].isEmpty() ? n[s.slotIndex].setImage(w.placeHolder) : console.error(new Error("ShortcutBar._setPlaceHolder: cannot change image of non empty slot")));
  }
};
n.prototype._resize = function () {
  var e,
    t,
    i = this._panels.spell,
    n = this._panels.item;
  window.gui.ipadRatio ? (this.setStyles({
    top: "",
    right: "",
    left: u.posShortcutBar + "px",
    bottom: "0px",
    width: u.shortcutBarSize + "px",
    height: u.bottomBarHeight + "px"
  }), e = u.shortcutBarSize - 75, this._columns = Math.floor(e / D), this._lines = Math.ceil(P / this._columns), t = this._lines * D + 8, this.setOpeningSide("top"), i.setSwipeDirection("horizontal"), n.setSwipeDirection("horizontal"), this._trashZone.setStyle("width", e + "px"), this._buttonBox.appendChild(this._organizeBtn), this._buttonBox.appendChild(this._pagination), this._pagination.setDirection("horizontal")) : (this.setStyles({
    bottom: "",
    left: "",
    right: "0px",
    top: u.posShortcutBar + "px",
    width: u.sideBarWidth + "px",
    height: u.shortcutBarSize + "px"
  }), t = u.shortcutBarSize - 29, this._lines = Math.floor(t / D), this._columns = Math.ceil(P / this._lines), e = this._columns * D + 13 + 30, this.setOpeningSide("left"), i.setSwipeDirection("vertical"), n.setSwipeDirection("vertical"), this._trashZone.setStyle("height", t + "px"), this._panelBox.appendChild(this._organizeBtn), this._panelBox.appendChild(this._pagination), this._pagination.setDirection("vertical"));
  this._panelBox.setStyles({
    width: e + "px",
    height: t + "px"
  });
  for (var o = i.slotList, a = n.slotList, s = 0; s < o.length; s++) {
    this._positionSlot(o[s]);
    this._positionSlot(a[s]);
  }
};
n.prototype._positionSlot = function (e) {
  var t,
    i,
    n,
    o,
    a = e.slotIndex,
    s = a % P;
  window.gui.ipadRatio ? (t = s % this._columns, i = Math.floor(s / this._columns), n = t * D, o = i * D) : (t = s % this._lines, i = Math.floor(s / this._lines), n = i * D, o = t * D);
  e.x = n;
  e.y = o;
  e.setStyles({
    left: n + "px",
    top: o + "px",
    webkitTransform: ""
  });
};
n.prototype._enableSlotContextMenus = function (e) {
  o(this._panels.item.slotList, e);
  o(this._panels.spell.slotList, e);
};
n.prototype.showTrash = function () {
  this.addClassNames("dragging");
};
n.prototype.hideTrash = function () {
  this.delClassNames("dragging");
};
n.prototype._setShortcutRequest = function (e) {
  if (!this._isShortcutValid(e)) {
    return console.error(new Error("ShortcutBar._setShortcutRequest: invalid shortcut"));
  }
  var t = this,
    i = e.getShortcutBarPanelType(),
    n = this._panels[i],
    o = e.slotIndex,
    a = n.slotList[o],
    s = a.shorcut;
  this._setShortcutClient(e);
  C.removeAllListeners("ShortcutBarAddErrorMessage");
  C.once("ShortcutBarAddErrorMessage", function () {
    a.isEmpty() ? t._removeShortcutClient(i, o) : t._setShortcutClient(s);
  });
  window.dofus.sendMessage("ShortcutBarAddRequestMessage", {
    barType: R[a.type],
    shortcut: e.serialize()
  });
};
n.prototype._setShortcutClient = function (e) {
  if (!this._isShortcutValid(e)) {
    return console.error(new Error("ShortcutBar._setShortcutClient: invalid shortcut"));
  }
  var t = e.getShortcutBarPanelType(),
    i = this._panels[t],
    n = i.slotList[e.slotIndex];
  n.setStyles({
    webkitTransform: "scale(1)",
    opacity: 1
  });
  n.getShortcutHash() !== e.getHash() && (this._selectedSlot === n && this._unSelectSlot(n), s(n, i.slotMap), n.setShortcut(e), a(n, i.slotMap), b.enableTooltip(n, !n.isEmpty() && !this.isOrganizing), this.isOrganizing ? n.enableDrag() : n.disableDrag());
};
n.prototype._removeShortcutFromSlotRequestWith1Animation = function (e) {
  this._removeShortcutRequest(e.type, e.slotIndex);
  e.setStyles({
    webkitTransform: "scale(0)",
    opacity: 1
  });
  h.forceReflow(e);
  M.tween(e, {
    webkitTransform: "scale(1)"
  }, {
    time: 100,
    easing: "ease-out"
  });
};
n.prototype._removeShortcutFromSlotRequestWith2Animations = function (e) {
  var t = this;
  h.forceReflow(e);
  M.tween(e, {
    opacity: 0
  }, {
    time: 100,
    easing: "ease-out"
  }, function () {
    t._removeShortcutFromSlotRequestWith1Animation(e);
  });
};
n.prototype._removeShortcutRequest = function (e, t) {
  var i = this,
    n = this._panels[e],
    o = n.slotList[t],
    a = o.shortcut,
    s = R[o.type];
  this._removeShortcutClient(e, t);
  C.removeAllListeners("ShortcutBarRemoveErrorMessage");
  C.once("ShortcutBarRemoveErrorMessage", function () {
    i._setShortcutClient(a);
  });
  window.dofus.sendMessage("ShortcutBarRemoveRequestMessage", {
    barType: s,
    slot: t
  });
};
n.prototype._removeShortcutClient = function (e, t) {
  if (this._isSlotIndexValid(t)) {
    var i = this._panels[e],
      n = i.slotList[t];
    n.isEmpty() || (s(n, i.slotMap), this._selectedSlot === n && this._unSelectSlot(n), n.unset(), n.disableDrag());
  }
};
n.prototype._enableDragOnSpell = function () {
  this._enableSlotContextMenus(!1);
  this._setSpellsSlotsDraggability(!0);
};
n.prototype._fightPreparation = function () {
  this.openPanel("item");
};
n.prototype._fightEntered = function () {
  this.openPanel("spell");
  this._enableDragOnSpell();
};
n.prototype._fightExited = function () {
  this.openPanel("item");
  this._enableSlotContextMenus(!0);
  this._setSpellsSlotsDraggability(this.isOrganizing);
  this._unSelectSlot(this._selectedSlot);
};
n.prototype.openPanel = function (e, t) {
  var i = "spell" === e ? "item" : "spell";
  this._currentPanelType = e;
  var n = this._panels[e];
  n.show();
  this._panels[i].hide();
  this.replaceClassNames([i], [e]);
  this._pagination.setCurrent(n.currentTab.id);
  Number.isInteger(t) && this._panels[this._currentPanelType].openTab(t % B);
};
n.prototype._emptyPanel = function (e) {
  var t = this._panels[e],
    i = t.slotList;
  r(i);
  t.slotMap = {};
  for (var n = 0; n < i.length; n++) {
    var o = i[n];
    o.isEmpty() ? o.image && o.setImage() : o.unset();
  }
  this._cancelPanelLoadingCb(e);
};
n.prototype._setPanelContent = function (e, t) {
  var i = this,
    n = window.gui.playerData.characters.getControlledCharacter();
  this._cancelPanelLoadingCb(e);
  var o = i._panels[e],
    l = o.slotList;
  r(l);
  var c,
    d,
    u = o.slotMap = {},
    h = new Array(l.length);
  for (c = 0; c < t.length; c++) {
    d = t[c];
    this._isSlotIndexValid(d.slotIndex) && (h[d.slotIndex] = d);
  }
  for (c = 0; c < l.length; c++) {
    d = h[c];
    var p = l[c];
    d ? (p.isEmpty() || p.getShortcutHash() !== d.getHash()) && (p.setShortcut(d), a(p, u)) : p.isEmpty() || (p.unset(), s(p, u));
  }
  "spell" === e && (this._currentCharacterId = n.spellData.characterId, this.updateSpellsAvailability(), window.gui.fightManager.isInBattle() && this._enableDragOnSpell());
};
n.prototype._setPanelContentRequest = function (e, t) {
  var i,
    n = window.gui.playerData.characters.getControlledCharacter();
  if (this._emptyPanel(e), "spell" === e ? (this._currentCharacterId = null, i = n.spellData) : i = window.gui.playerData.inventory, i.isLoaded) {
    this._setPanelContent(e, t);
  } else {
    this._setPlaceHolder(e, t);
    var o = this._setPanelContent.bind(this, e, t);
    this._panelLoadingCb[e] = o;
    i.once("loaded", o);
  }
};
n.prototype._cancelPanelLoadingCb = function (e) {
  if (this._panelLoadingCb[e]) {
    var t = window.gui.playerData.characters.getControlledCharacter(),
      i = "spell" === e ? t.spellData : window.gui.playerData.inventory;
    i.removeListener("loaded", this._panelLoadingCb[e]);
    delete this._panelLoadingCb[e];
  }
};
n.prototype._setItemsSlotsDraggability = function (e) {
  for (var t = this._panels.item.slotList, i = 0; i < t.length; i++) {
    t[i].setDraggability(e && !t[i].isEmpty());
  }
};
n.prototype._setSpellsSlotsDraggability = function (e) {
  for (var t = this._panels.spell.slotList, i = 0; i < t.length; i++) {
    t[i].setDraggability(e && !t[i].isEmpty());
  }
};
n.prototype._selectSlot = function (e, t) {
  if (!this.isOrganizing) {
    if (t && window.isoEngine.clearSpellDisplay(), this._selectedSlot === e) {
      return this._unSelectSlot(e);
    }
    if (this._selectedSlot && this._selectedSlot.unselect(), e.isEmpty()) {
      return void (this._selectedSlot = null);
    }
    this._selectedSlot = e;
    e.select();
    window.gui.fightManager.isInBattle() && this._close(!0);
  }
};
n.prototype._unSelectSlot = function (e) {
  e && this._selectedSlot === e && (this._selectedSlot.unselect(), this._selectedSlot = null);
};
n.prototype.deselectCurrentSlot = function () {
  this._unSelectSlot(this._selectedSlot);
};
n.prototype.getIdOfSelectedSpellIfAny = function () {
  var e = this._selectedSlot;
  return !e || "spell" !== e.type || e.isEmpty() ? null : e.shortcut.spellId;
};
n.prototype._updateWeaponSpell = function () {
  var e = window.gui.playerData.characters.mainCharacter.spellData.spells[k];
  if (!e) {
    return console.warn("the player weapon spell has not been created yet");
  }
  var t = this._panels.spell.slotMap["spell" + k];
  if (t) {
    for (var i = 0; i < t.length; i++) {
      t[i].setSpell(e);
    }
  }
};
n.prototype._swapSlots = function (e, t) {
  var i = this;
  if (e.type !== t.type) {
    return console.error(new Error("Impossible to swap a slot from panel " + e.type + " and panel " + t.type));
  }
  var n = this._panels[e.type];
  if ((!window.gui.fightManager.isInBattle() || this.isOrganizing) && this._dragStartPage === this._pagination.current) {
    if (e.slotIndex === t.slotIndex) {
      return t.setStyle("webkitTransform", "translate3d(0,0,0)");
    }
    C.removeAllListeners("ShortcutBarSwapErrorMessage");
    var o = t.slotIndex,
      a = t.getParent(),
      s = t.x - e.x,
      r = t.y - e.y;
    t.slotIndex = e.slotIndex;
    n.slotList[t.slotIndex] = e.getParent().appendChild(t);
    this._positionSlot(t);
    e.slotIndex = o;
    n.slotList[e.slotIndex] = a.appendChild(e);
    M.tween(e, {
      webkitTransform: "translate3d(" + s + "px," + r + "px,0)"
    }, {
      time: 100,
      easing: "ease-out"
    }, function () {
      i._positionSlot(e);
      window.dofus.sendMessage("ShortcutBarSwapRequestMessage", {
        barType: R[t.type],
        firstSlot: t.slotIndex,
        secondSlot: e.slotIndex
      });
    });
    C.once("ShortcutBarSwapErrorMessage", function () {
      var n = t.slotIndex;
      t.slotIndex = e.slotIndex;
      e.slotIndex = n;
      i._positionSlot(t);
      i._positionSlot(e);
    });
  }
};
n.prototype._onDropOnSlot = function (e, t, i, n) {
  switch (i) {
    case "shortcutBar":
      this._swapSlots(e, t);
      break;
    case "characterBox":
    case "equipment":
      var o = t.itemInstance;
      this._setShortcutRequest(new S({
        _type: "ShortcutObjectItem",
        slot: e.slotIndex,
        itemUID: o.objectUID,
        itemGID: o.objectGID
      }));
      break;
    case "presets":
      this._setShortcutRequest(new S({
        _type: "ShortcutObjectPreset",
        slot: e.slotIndex,
        presetId: t.preset.presetId
      }));
      break;
    case "spellsWindow":
      this._setShortcutRequest(new S({
        _type: "ShortcutSpell",
        slot: e.slotIndex,
        spellId: n.spellId
      }));
      break;
    case "attitude":
      this._setShortcutRequest(new S({
        _type: "ShortcutEmote",
        slot: e.slotIndex,
        emoteId: n.id
      }));
      break;
    case "smiley":
      this._setShortcutRequest(new S({
        _type: "ShortcutSmiley",
        slot: e.slotIndex,
        smileyId: n.id
      }));
  }
};
n.prototype._setOrganizeMode = function (e) {
  var t = window.gui.playerData.characters.isMainCharacterControlled();
  if (!e || "spell" !== this._currentPanelType || t) {
    if (this._tempToolbarResize || (this._tempToolbarResize = {
      active: !1,
      previousPanel: null
    }), this.isOrganizing = e, this.toggleClassName("draggable", this.isOrganizing), this._setItemsSlotsDraggability(this.isOrganizing), this._setSpellsSlotsDraggability(this.isOrganizing), this.isOrganizing) {
      this.spellBtn.disable();
      this.itemBtn.disable();
      var i = "spell" === this._currentPanelType,
        n = m.menubarSizeInFight !== m.menubarSize,
        o = i !== window.gui.playerData.isFighting;
      if (n && o) {
        this._tempToolbarResize.active = !0;
        this._tempToolbarResize.previousPanel = i ? "spell" : "item";
        this.shouldKeepOpen = !0;
        var a = i ? "tablet.nowShowingFightToolbar" : "tablet.nowShowingRpToolbar";
        b.showNotification(f(a), this);
        window.gui.showFightingToolbar(i);
      }
    } else {
      this.spellBtn.enable();
      this.itemBtn.enable();
      this._tempToolbarResize.active ? (this.shouldKeepOpen = !1, "spell" === this._tempToolbarResize.previousPanel ? window.gui.resizeToolbarForRoleplay() : window.gui.resizeToolbarForFight(), this._tempToolbarResize.active = !1, this._tempToolbarResize.previousPanel = null) : this.close();
    }
  }
};
this.addClassNames("ShortcutBar");
this._panelBox = this.content.createChild("div", {
  className: "panelBox"
});
this._panels = {
  spell: this._panelBox.appendChild(this._createPanel("spell")),
  item: this._panelBox.appendChild(this._createPanel("item"))
};
this._buttonBox = this.content.createChild("div", {
  className: "buttonBox"
});
this.spellBtn = this._buttonBox.appendChild(new c({
  className: "spellBtn",
  tooltip: f("ui.charcrea.spells"),
  sound: "BANNER_SPELL_TAB"
}, function () {
  t.openPanel("spell");
}));
this.itemBtn = this._buttonBox.appendChild(new c({
  className: "itemBtn",
  tooltip: f("ui.common.objects"),
  sound: "BANNER_SPELL_TAB"
}, function () {
  t.openPanel("item");
}));
this._pagination = this._buttonBox.appendChild(new v({
  disableInput: !0,
  btnAlwaysEnabled: !0,
  soundPrev: "SCROLL_DOWN",
  soundNext: "SCROLL_UP"
}));
this._pagination.setPageCount(B);
this._pagination.setCurrent(0);
this._pagination.on("next", function () {
  t._panels[t._currentPanelType].openTab((this.current + 1) % B);
});
this._pagination.on("previous", function () {
  t._panels[t._currentPanelType].openTab(h.mod(this.current - 1, B));
});
this._panels.spell.on("openTab", e);
this._panels.item.on("openTab", e);
this._organizeBtn = this._buttonBox.appendChild(new c({
  className: "lockBtn",
  scaleOnPress: !0
}, function () {
  t._setOrganizeMode(!t.isOrganizing);
}));
this._trashZone = this.createChild("div", {
  className: "trashZone"
});
this._trashZone.createChild("div", {
  className: "trashBin",
  text: f("ui.common.remove")
});
p.setDroppable(this._trashZone, ["shortcutBar"], {
  isDropAllowed: function () {
    return t.isOrganizing;
  }
});
this._trashZone.on("drop", function (e) {
  t._removeShortcutFromSlotRequestWith1Animation(e);
});
this.on("open", function () {
  I("WINDOW_OPEN");
});
this.on("close", function () {
  I("WINDOW_CLOSE");
  this.isOrganizing && this._setOrganizeMode(!1);
});
I("WINDOW_CLOSE");
this.isOrganizing && this._setOrganizeMode(!1);
t.slotList = new Array(P * B);
t.slotMap = {};
t.slotList[s] = r;
o.appendChild(r);
this._positionSlot(r);
t.on("disconnect", function () {
  e.close();
  e.delClassNames("dragging");
  e._selectedSlot = null;
  e._emptyPanel("spell");
  e._emptyPanel("item");
  e._currentCharacterId = null;
  C.removeAllListeners("ShortcutBarAddErrorMessage");
  C.removeAllListeners("ShortcutBarRemoveErrorMessage");
  C.removeAllListeners("ShortcutBarSwapErrorMessage");
});
C.on("ShortcutBarContentMessage", function (t) {
  for (var n = O[t.barType], o = [], a = 0; a < t.shortcuts.length; a++) {
    o.push(new S(t.shortcuts[a]));
  }
  "spell" === n && i.getControlledCharacter().setSpellShortcuts(o);
  e._setPanelContentRequest(n, o);
});
C.on("ShortcutBarRefreshMessage", function (t) {
  var n = O[t.barType],
    o = new S(t.shortcut);
  e._isSlotIndexValid(o.slotIndex) && ("spell" === n && i.getControlledCharacter().updateSpellShortcut(o), e._setShortcutClient(o));
});
C.on("ShortcutBarRemovedMessage", function (t) {
  var i = O[t.barType];
  e._removeShortcutClient(i, t.slot);
});
i.on("switchControlledCharacter", function () {
  var t = i.getControlledCharacter();
  t.spellShortcuts ? e._setPanelContentRequest("spell", t.spellShortcuts) : e._emptyPanel("spell");
});
i.on("weaponChanged", function () {
  e._currentCharacterId === this.mainCharacter.spellData.characterId && e._updateWeaponSpell();
});
n.on("itemsDeleted", this._disableItems.bind(this));
n.on("itemDeleted", this._disableItem.bind(this));
n.on("itemsQuantity", this._updateItemsQuantity.bind(this));
n.on("itemQuantity", this._updateItemQuantity.bind(this));
n.on("itemModified", this._updateModifiedItem.bind(this));
t.fightManager.on("fightEnterPreparation", this._fightPreparation.bind(this));
t.fightManager.on("fightEnterBattle", this._fightEntered.bind(this));
t.fightManager.on("fightEnd", this._fightExited.bind(this));
o.on("stepChanged", function () {
  e.setAvailability(o.isBehaviourEnabled(L.SHORTCUT_BAR));
  o.isBehaviourEnabled(L.ORGANIZE_BTN) ? e._organizeBtn.enable() : e._organizeBtn.disable();
});
C.on("CurrentMapMessage", function () {
  o.isBehaviourEnabled(L.SHORTCUT_BAR) && e.setAvailability(!1);
});
window.isoEngine.on("mapLoaded", function () {
  o.isBehaviourEnabled(L.SHORTCUT_BAR) && e.setAvailability(!0);
});
t.playerData.characters.on("specificCharacteristicsUpdated", function (t) {
  "actionPointsCurrent" === t && e.updateSpellsAvailability();
});
t.fightManager.on("UpdatePreFightersList", this.updateSpellsAvailability.bind(this));
t.fightManager.on("updateSpellsAvailability", this.updateSpellsAvailability.bind(this));
t.on("GameFightTurnStartMessage", this.updateSpellsAvailability.bind(this));
e.close();
e.delClassNames("dragging");
e._selectedSlot = null;
e._emptyPanel("spell");
e._emptyPanel("item");
e._currentCharacterId = null;
C.removeAllListeners("ShortcutBarAddErrorMessage");
C.removeAllListeners("ShortcutBarRemoveErrorMessage");
C.removeAllListeners("ShortcutBarSwapErrorMessage");
"spell" === n && i.getControlledCharacter().setSpellShortcuts(o);
e._setPanelContentRequest(n, o);
e.setAvailability(o.isBehaviourEnabled(L.SHORTCUT_BAR));
o.isBehaviourEnabled(L.ORGANIZE_BTN) ? e._organizeBtn.enable() : e._organizeBtn.disable();
n.icon.addClassNames("disabled");
n.isDisabled = !0;
e.isDisabled = !window.gui.fightManager.canCastThisSpell(i);
t = window.gui.fightManager.getSpellCooldown(i);
e.isDisabled = !1;
t = 0;
e.isDisabled && this._unSelectSlot(e);
e.icon.toggleClassName("disabled", e.isDisabled);
e.setCooldown(t);
this.overlay ? this.overlay.toggleDisplay(!e) : this.overlay = this.content.createChild("div", {
  className: "overlay",
  hidden: e
});
this.lockDrawer(!e);
window.gui.ipadRatio ? (this.setStyles({
  top: "",
  right: "",
  left: u.posShortcutBar + "px",
  bottom: "0px",
  width: u.shortcutBarSize + "px",
  height: u.bottomBarHeight + "px"
}), e = u.shortcutBarSize - 75, this._columns = Math.floor(e / D), this._lines = Math.ceil(P / this._columns), t = this._lines * D + 8, this.setOpeningSide("top"), i.setSwipeDirection("horizontal"), n.setSwipeDirection("horizontal"), this._trashZone.setStyle("width", e + "px"), this._buttonBox.appendChild(this._organizeBtn), this._buttonBox.appendChild(this._pagination), this._pagination.setDirection("horizontal")) : (this.setStyles({
  bottom: "",
  left: "",
  right: "0px",
  top: u.posShortcutBar + "px",
  width: u.sideBarWidth + "px",
  height: u.shortcutBarSize + "px"
}), t = u.shortcutBarSize - 29, this._lines = Math.floor(t / D), this._columns = Math.ceil(P / this._lines), e = this._columns * D + 13 + 30, this.setOpeningSide("left"), i.setSwipeDirection("vertical"), n.setSwipeDirection("vertical"), this._trashZone.setStyle("height", t + "px"), this._panelBox.appendChild(this._organizeBtn), this._panelBox.appendChild(this._pagination), this._pagination.setDirection("vertical"));
this._panelBox.setStyles({
  width: e + "px",
  height: t + "px"
});
this._positionSlot(o[s]);
this._positionSlot(a[s]);
window.gui.ipadRatio ? (t = s % this._columns, i = Math.floor(s / this._columns), n = t * D, o = i * D) : (t = s % this._lines, i = Math.floor(s / this._lines), n = i * D, o = t * D);
e.x = n;
e.y = o;
e.setStyles({
  left: n + "px",
  top: o + "px",
  webkitTransform: ""
});
o(this._panels.item.slotList, e);
o(this._panels.spell.slotList, e);
this._setShortcutClient(e);
C.removeAllListeners("ShortcutBarAddErrorMessage");
C.once("ShortcutBarAddErrorMessage", function () {
  a.isEmpty() ? t._removeShortcutClient(i, o) : t._setShortcutClient(s);
});
window.dofus.sendMessage("ShortcutBarAddRequestMessage", {
  barType: R[a.type],
  shortcut: e.serialize()
});
n.setStyles({
  webkitTransform: "scale(1)",
  opacity: 1
});
n.getShortcutHash() !== e.getHash() && (this._selectedSlot === n && this._unSelectSlot(n), s(n, i.slotMap), n.setShortcut(e), a(n, i.slotMap), b.enableTooltip(n, !n.isEmpty() && !this.isOrganizing), this.isOrganizing ? n.enableDrag() : n.disableDrag());
this._removeShortcutRequest(e.type, e.slotIndex);
e.setStyles({
  webkitTransform: "scale(0)",
  opacity: 1
});
h.forceReflow(e);
M.tween(e, {
  webkitTransform: "scale(1)"
}, {
  time: 100,
  easing: "ease-out"
});
h.forceReflow(e);
M.tween(e, {
  opacity: 0
}, {
  time: 100,
  easing: "ease-out"
}, function () {
  t._removeShortcutFromSlotRequestWith1Animation(e);
});
this._removeShortcutClient(e, t);
C.removeAllListeners("ShortcutBarRemoveErrorMessage");
C.once("ShortcutBarRemoveErrorMessage", function () {
  i._setShortcutClient(a);
});
window.dofus.sendMessage("ShortcutBarRemoveRequestMessage", {
  barType: s,
  slot: t
});
this._enableSlotContextMenus(!1);
this._setSpellsSlotsDraggability(!0);
this.openPanel("spell");
this._enableDragOnSpell();
this.openPanel("item");
this._enableSlotContextMenus(!0);
this._setSpellsSlotsDraggability(this.isOrganizing);
this._unSelectSlot(this._selectedSlot);
n.show();
this._panels[i].hide();
this.replaceClassNames([i], [e]);
this._pagination.setCurrent(n.currentTab.id);
Number.isInteger(t) && this._panels[this._currentPanelType].openTab(t % B);
r(i);
t.slotMap = {};
d = t[c];
this._isSlotIndexValid(d.slotIndex) && (h[d.slotIndex] = d);
this._panelLoadingCb[e] = o;
i.once("loaded", o);
i.removeListener("loaded", this._panelLoadingCb[e]);
delete this._panelLoadingCb[e];
this._selectedSlot = e;
e.select();
window.gui.fightManager.isInBattle() && this._close(!0);
t.slotIndex = e.slotIndex;
n.slotList[t.slotIndex] = e.getParent().appendChild(t);
this._positionSlot(t);
e.slotIndex = o;
n.slotList[e.slotIndex] = a.appendChild(e);
M.tween(e, {
  webkitTransform: "translate3d(" + s + "px," + r + "px,0)"
}, {
  time: 100,
  easing: "ease-out"
}, function () {
  i._positionSlot(e);
  window.dofus.sendMessage("ShortcutBarSwapRequestMessage", {
    barType: R[t.type],
    firstSlot: t.slotIndex,
    secondSlot: e.slotIndex
  });
});
C.once("ShortcutBarSwapErrorMessage", function () {
  var n = t.slotIndex;
  t.slotIndex = e.slotIndex;
  e.slotIndex = n;
  i._positionSlot(t);
  i._positionSlot(e);
});
i._positionSlot(e);
window.dofus.sendMessage("ShortcutBarSwapRequestMessage", {
  barType: R[t.type],
  firstSlot: t.slotIndex,
  secondSlot: e.slotIndex
});
t.slotIndex = e.slotIndex;
e.slotIndex = n;
i._positionSlot(t);
i._positionSlot(e);
this.spellBtn.disable();
this.itemBtn.disable();
this._tempToolbarResize.active = !0;
this._tempToolbarResize.previousPanel = i ? "spell" : "item";
this.shouldKeepOpen = !0;
b.showNotification(f(a), this);
window.gui.showFightingToolbar(i);
this.spellBtn.enable();
this.itemBtn.enable();
this._tempToolbarResize.active ? (this.shouldKeepOpen = !1, "spell" === this._tempToolbarResize.previousPanel ? window.gui.resizeToolbarForRoleplay() : window.gui.resizeToolbarForFight(), this._tempToolbarResize.active = !1, this._tempToolbarResize.previousPanel = null) : this.close();
r.call(this, "div", {
  className: "PaginationUI"
});
e = e || {};
this._leftArrow = n("previous", this, e.soundPrev);
this._centeringContainer = this.createChild("div", {
  className: "centeringContainer"
});
this.isInputDisabled = !!e.disableInput;
t.setReadonly(this.isInputDisabled);
this.isBtnAlwaysEnabled = !!e.btnAlwaysEnabled;
t.on("change", function (e) {
  i.emit("page", e - 1);
});
this._pageCountLabel = this._centeringContainer.createChild("div", {
  className: "pageCount"
});
this._rightArrow = n("next", this, e.soundNext);
a(o, r);
o.prototype.setDirection = function (e) {
  this.toggleClassName("vertical", "vertical" === e);
};
o.prototype._checkPosition = function () {
  this.isBtnAlwaysEnabled || (this._leftArrow.setEnable(0 !== this.current), this._rightArrow.setEnable(this.current < this._pageCount - 1));
  var e = this._pageCount <= 1 || this.isInputDisabled;
  this._numberInputBox.setReadonly(e);
  this._centeringContainer.toggleClassName("readOnly", e);
};
o.prototype.setCurrent = function (e) {
  this.current = e;
  this._numberInputBox.setValue(e + 1);
  this._checkPosition();
};
o.prototype.setPageCount = function (e) {
  this._numberInputBox.maxValue = e;
  this._pageCount = e;
  this._pageCountLabel.setText("/ " + e);
  this._checkPosition();
};
e.exports = o;
this._numberInputBox.setReadonly(e);
this._centeringContainer.toggleClassName("readOnly", e);
this.current = e;
this._numberInputBox.setValue(e + 1);
this._checkPosition();
this._numberInputBox.maxValue = e;
this._pageCount = e;
this._pageCountLabel.setText("/ " + e);
this._checkPosition();
this._type = e._type;
this.slotIndex = e.slot;
e.exports = i;
i.prototype.serialize = function () {
  var e = {};
  e._type = this._type;
  e.slot = this.slotIndex;
  for (var t = n[this._type], i = 0; i < t.length; i++) {
    e[t[i]] = this[t[i]];
  }
  return e;
};
i.prototype.getHash = function () {
  switch (this._type) {
    case "ShortcutSpell":
      return "spell" + this.spellId;
    case "ShortcutObjectItem":
      return "item" + this.itemUID;
    case "ShortcutObjectPreset":
      return "preset" + this.presetId;
    case "ShortcutEmote":
      return "emote" + this.emoteId;
    case "ShortcutSmiley":
      return "smiley" + this.smileyId;
    default:
      return null;
  }
};
i.prototype.isHandled = function () {
  return null !== this.getHash();
};
i.prototype.getShortcutBarPanelType = function () {
  switch (this._type) {
    case "ShortcutSpell":
      return "spell";
    case "ShortcutObjectItem":
    case "ShortcutObjectPreset":
    case "ShortcutEmote":
    case "ShortcutSmiley":
      return "item";
    default:
      return null;
  }
};
e._type = this._type;
e.slot = this.slotIndex;
r.call(this, {
  scaleOnPress: !0
});
this.type = "item";
l.constructor.call(this, e, t);
this.on("doubletap", this._doubleTapHandler);
a(n, r);
e.exports = n;
n.prototype.setShortcut = function (e) {
  var t = this;
  if (!this._isShortcutValid(e)) {
    return !this.isEmpty() && this.unset();
  }
  var i = window.gui.playerData.inventory;
  if (this.shortcut = e, e.hasOwnProperty("presetId")) {
    this.icon.delClassNames("disabled");
    this.isDisabled = !1;
    this.setQuantity(1);
    var n = i.presets[e.presetId];
    o.preloadImage("gfx/presets/icon_" + n.symbolId + ".png", function (e) {
      t.setImage(e);
    });
    this.setData(n);
    this.setContextMenu("preset", {
      presetId: e.presetId,
      canRemove: !0,
      onClose: this._onContextualMenuClosed.bind(this)
    });
  } else if (e.hasOwnProperty("emoteId")) {
    this.icon.delClassNames("disabled");
    this.isDisabled = !1;
    this.setQuantity(1);
    this.setData({
      emoteId: e.emoteId
    });
    this.setContextMenu("emote", {
      emoteId: e.emoteId,
      canRemove: !0,
      onClose: this._onContextualMenuClosed.bind(this)
    });
    o.preloadImage("gfx/emotes/" + e.emoteId + ".png", function (e) {
      t.setImage(e);
    });
  } else if (e.hasOwnProperty("smileyId")) {
    this.icon.delClassNames("disabled");
    this.isDisabled = !1;
    this.setQuantity(1);
    this.setData({
      smileyId: e.smileyId
    });
    this.setContextMenu("smiley", {
      smileyId: e.smileyId,
      canRemove: !0,
      onClose: this._onContextualMenuClosed.bind(this)
    });
    var a = window.gui.databases.Smileys;
    o.preloadImage("gfx/smilies/" + a[e.smileyId].gfxId + ".png", function (e) {
      t.setImage(e);
    });
  } else {
    var r = i.objects[e.itemUID];
    if (r) {
      if (!r.isInitialised) {
        return r.once("initialised", function () {
          t.setShortcut(e);
        });
      }
      this.isDisabled = !1;
      this.icon.delClassNames("disabled");
      this.setContextMenu("item", {
        item: r,
        onClose: this._onContextualMenuClosed.bind(this),
        remove: !0,
        enableActions: !0,
        enableDestroy: !0
      });
      this.setItem(r);
    } else {
      this.isDisabled = !0;
      this.icon.addClassNames("disabled");
      s.getItems([e.itemGID], function (e, i) {
        if (e) {
          return console.error(e);
        }
        var n = i[0];
        t.setContextMenu("item", {
          item: n,
          onClose: t._onContextualMenuClosed.bind(t),
          remove: !0,
          enableActions: !0,
          enableDestroy: !0
        });
        t.setItem(n);
      });
    }
  }
};
n.prototype._doubleTapHandler = function () {
  if (this.shortcut) {
    switch (this.shortcut._type) {
      case "ShortcutObjectItem":
        var e = this.getItem();
        e.isItemInstance && e.doDefaultAction();
        break;
      case "ShortcutEmote":
        window.dofus.sendMessage("EmotePlayRequestMessage", {
          emoteId: this.shortcut.emoteId
        });
        break;
      case "ShortcutSmiley":
        window.dofus.sendMessage("ChatSmileyRequestMessage", {
          smileyId: this.shortcut.smileyId
        });
        break;
      case "ShortcutObjectPreset":
        window.dofus.sendMessage("InventoryPresetUseMessage", {
          presetId: this.shortcut.presetId
        });
    }
  }
};
l.appendPrototypeTo(n);
this.icon.delClassNames("disabled");
this.isDisabled = !1;
this.setQuantity(1);
o.preloadImage("gfx/presets/icon_" + n.symbolId + ".png", function (e) {
  t.setImage(e);
});
this.setData(n);
this.setContextMenu("preset", {
  presetId: e.presetId,
  canRemove: !0,
  onClose: this._onContextualMenuClosed.bind(this)
});
this.icon.delClassNames("disabled");
this.isDisabled = !1;
this.setQuantity(1);
this.setData({
  emoteId: e.emoteId
});
this.setContextMenu("emote", {
  emoteId: e.emoteId,
  canRemove: !0,
  onClose: this._onContextualMenuClosed.bind(this)
});
o.preloadImage("gfx/emotes/" + e.emoteId + ".png", function (e) {
  t.setImage(e);
});
this.icon.delClassNames("disabled");
this.isDisabled = !1;
this.setQuantity(1);
this.setData({
  smileyId: e.smileyId
});
this.setContextMenu("smiley", {
  smileyId: e.smileyId,
  canRemove: !0,
  onClose: this._onContextualMenuClosed.bind(this)
});
this.isDisabled = !1;
this.icon.delClassNames("disabled");
this.setContextMenu("item", {
  item: r,
  onClose: this._onContextualMenuClosed.bind(this),
  remove: !0,
  enableActions: !0,
  enableDestroy: !0
});
this.setItem(r);
this.isDisabled = !0;
this.icon.addClassNames("disabled");
s.getItems([e.itemGID], function (e, i) {
  if (e) {
    return console.error(e);
  }
  var n = i[0];
  t.setContextMenu("item", {
    item: n,
    onClose: t._onContextualMenuClosed.bind(t),
    remove: !0,
    enableActions: !0,
    enableDestroy: !0
  });
  t.setItem(n);
});
t.setContextMenu("item", {
  item: n,
  onClose: t._onContextualMenuClosed.bind(t),
  remove: !0,
  enableActions: !0,
  enableDestroy: !0
});
t.setItem(n);
e = e || {};
o.call(this, e);
this.addClassNames("ItemSlot");
this.itemTypeStyle = "";
this.descriptionOptions = e.descriptionOptions || {};
this.setItem(e.itemData, e.quantity);
s(n, o);
e.exports = n;
n.prototype._getContextualMenuProperties = function () {
  return this._contextMenuParams.item = this.data, o.prototype._getContextualMenuProperties.call(this);
};
n.prototype.setItem = function (e, t) {
  if (!e) {
    return this.unset();
  }
  this.toggleClassName("cosmeticSlot", e.isCosmetic());
  this.toggleClassName("legendaryWeaponSlot", e.isLegendaryWeapon());
  this._itemData = e;
  this.itemInstance = e.getItemInstance();
  this.dbItem = e.getItem();
  var i = e.getProperty("image");
  if (!i && e.isItemInstance && !e.isInitialised) {
    var n = this;
    e.once("initialised", function () {
      n._itemData === e && (n.setImage(e.getProperty("image")), n.toggleClassName("cosmeticSlot", e.isCosmetic()), n.toggleClassName("legendaryWeaponSlot", e.isLegendaryWeapon()));
    });
  }
  t = t || e.getProperty("quantity") || 1;
  this.setImage(i);
  this.setQuantity(t);
  this.setTooltip(this._getTooltipContent);
  this.setData(e);
};
n.prototype.getItem = function () {
  return this._itemData;
};
n.prototype.unset = function () {
  o.prototype.unset.call(this);
  this._itemData = null;
  this.itemInstance = null;
  this.dbItem = null;
};
n.prototype.lock = function () {
  var e = this;
  this.unset();
  r.preloadImage("ui/slots/tx_slotLockedimg.png", function (t) {
    e.setImage(t);
  });
};
n.prototype._getTooltipContent = function () {
  return new a(this._itemData, this.descriptionOptions);
};
n.prototype.setBackgroundImageByItemType = function (e) {
  c.indexOf(e) === -1 && (e = l);
  var t = "itemType" + e;
  this.replaceClassNames([this.itemTypeStyle], [t]);
  this.itemTypeStyle = t;
};
this.toggleClassName("cosmeticSlot", e.isCosmetic());
this.toggleClassName("legendaryWeaponSlot", e.isLegendaryWeapon());
this._itemData = e;
this.itemInstance = e.getItemInstance();
this.dbItem = e.getItem();
t = t || e.getProperty("quantity") || 1;
this.setImage(i);
this.setQuantity(t);
this.setTooltip(this._getTooltipContent);
this.setData(e);
o.prototype.unset.call(this);
this._itemData = null;
this.itemInstance = null;
this.dbItem = null;
this.unset();
r.preloadImage("ui/slots/tx_slotLockedimg.png", function (t) {
  e.setImage(t);
});
this.replaceClassNames([this.itemTypeStyle], [t]);
this.itemTypeStyle = t;
e = e || {};
r.call(this, "div", {
  className: "Slot",
  name: e.name || ""
});
s(this, e.noDoubleTap ? {
  doubletapTimeout: 1
} : null);
this._quantity = 0;
this.enabledBehaviour = !0;
e.errorIcon && (this.errorIcon = this.createChild("div", {
  className: "errorIcon"
}));
this.icon = this.createChild("div", {
  className: "slotIcon"
});
this.iconBorder = this.createChild("div", {
  className: "slotIconBorder"
});
this.quantityBox = this.createChild("div", {
  className: "quantity"
});
this.forceQuantity = e.forceQuantity;
e.quantity && this.setQuantity(e.quantity);
e.image && this.setImage(e.image);
this.tooltipOptions = e.tooltipOptions;
e.tooltip && this.setTooltip(e.tooltip, this.tooltipOptions);
this.on("destroy", this._onDestroy);
this.on("tap", this._openContextMenu);
this.on("tooltipOn", this._removeHoverStyle);
this.on("tooltipOut", this._applyHoverStyle);
e.scaleOnPress && (this.on("tapstart", this._showAsPressed), this.on("tapend", this._showAsReleased));
this.enableContextMenu(!e.hasOwnProperty("enableContextMenu") || e.enableContextMenu);
a(n, r);
e.exports = n;
n.prototype._onDestroy = function () {
  this.destroyed = !0;
};
n.prototype._openContextMenu = function () {
  this._contextMenuId && this.isContextEnabled && window.gui.openContextualMenuAround(this._contextMenuId, this, this._getContextualMenuProperties());
};
n.prototype._showAsPressed = function () {
  this.data && this.icon.setStyle("webkitTransform", "scale(0.9)");
};
n.prototype._showAsReleased = function () {
  this.icon.setStyle("webkitTransform", "scale(1)");
};
n.prototype._removeHoverStyle = function () {
  this.icon.setStyle("webkitTransform", "scale(1.1)");
};
n.prototype._applyHoverStyle = function () {
  this.icon.setStyle("webkitTransform", "scale(1)");
};
n.prototype._getContextualMenuProperties = function () {
  return this._contextMenuParams;
};
n.prototype.unset = function () {
  o.enableTooltip(this, !1);
  this.quantityBox.hide();
  this.setContextMenu();
  this.enableBehaviour(!0);
  this.setImage();
  this.setData();
  this.emit("unset");
};
n.prototype.setQuantity = function (e) {
  this._quantity = e;
  this.quantityBox.setText(e);
  this.quantityBox.toggleDisplay(!!this.forceQuantity || e && e > 1);
};
n.prototype.getQuantity = function () {
  return this._quantity;
};
n.prototype.select = function (e) {
  var t = e && e.extraStyle ? e.extraStyle : null;
  t !== this.extraStyle && (this.extraStyle && this.delClassNames(this.extraStyle), t && this.addClassNames(t), this.extraStyle = t);
  this.selected || (this.selected = !0, this.addClassNames("selected"), this.emit("selected"));
};
n.prototype.enableBehaviour = function (e) {
  if (this.rootElement) {
    this.enabledBehaviour = e;
    this.setStyle("pointerEvents", e ? "" : "none");
    var t = this.image || "none",
      i = "linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5))," + t;
    this.icon.setStyle("backgroundImage", e ? t : i);
  }
};
n.prototype.unselect = function () {
  this.extraStyle && this.delClassNames(this.extraStyle);
  this.delClassNames("selected");
  this.selected = !1;
  this.emit("unselected");
};
n.prototype.setImage = function (e) {
  return this.rootElement ? (this.image = e, e = e || "none", this.icon.setStyle("backgroundImage", e), this.loadingImage = !1, this.requestedImages = null, void this.emit("setImage", this.image)) : console.warn("trying to set an image on a destroyed object");
};
n.prototype.getImage = function () {
  return this.image;
};
n.prototype.setTooltip = function (e, t) {
  return this.hasTooltip ? void o.enableTooltip(this, !0) : (o.addTooltip(this, e, t || this.tooltipOptions), void (this.hasTooltip = !0));
};
n.prototype.setContextMenu = function (e, t) {
  this._contextMenuId = e;
  this._contextMenuParams = t;
};
n.prototype.setData = function (e) {
  if (this.data = e, this.data) {
    if (this.data.mountLocation) {
      for (var t = this.data.effectList || [], i = 0, n = t.length; i < n; i += 1) {
        var o = t[i];
        o.effectCaller || (o.effectCaller = "Slot: mount " + this.data.model + " from location " + this.data.mountLocation);
      }
    }
    this.emit("setData", this.data);
  }
};
n.prototype.preloadAndSetImages = function (e) {
  e = e || [];
  this.requestedImages = e;
  var t = this;
  this.loadingImage = !0;
  l.preloadImages(e, function (i) {
    if (t.requestedImages === e && !this.destroyed) {
      for (var n = "none", o = 0; o < i.length && (n = i[o], "none" === n); o += 1) {
        ;
      }
      t.loadingImage && t.setImage(n);
    }
  });
};
n.prototype.enableContextMenu = function (e) {
  this.isContextEnabled = !arguments.length || e;
};
o.enableTooltip(this, !1);
this.quantityBox.hide();
this.setContextMenu();
this.enableBehaviour(!0);
this.setImage();
this.setData();
this.emit("unset");
this._quantity = e;
this.quantityBox.setText(e);
this.quantityBox.toggleDisplay(!!this.forceQuantity || e && e > 1);
t !== this.extraStyle && (this.extraStyle && this.delClassNames(this.extraStyle), t && this.addClassNames(t), this.extraStyle = t);
this.selected || (this.selected = !0, this.addClassNames("selected"), this.emit("selected"));
this.enabledBehaviour = e;
this.setStyle("pointerEvents", e ? "" : "none");
this.extraStyle && this.delClassNames(this.extraStyle);
this.delClassNames("selected");
this.selected = !1;
this.emit("unselected");
this._contextMenuId = e;
this._contextMenuParams = t;
e = e || [];
this.requestedImages = e;
this.loadingImage = !0;
l.preloadImages(e, function (i) {
  if (t.requestedImages === e && !this.destroyed) {
    for (var n = "none", o = 0; o < i.length && (n = i[o], "none" === n); o += 1) {
      ;
    }
    t.loadingImage && t.setImage(n);
  }
});
e.exports = a;
a.constructor = function (e, t) {
  var i = this;
  this.slotIndex = t;
  this.shortcutBar = e;
  this.shortcut = null;
  this.isDisabled = !1;
  this._addDraggableBehaviour();
  this._addDroppableBehaviour();
  this.addClassNames("empty", "ShortcutSlot", "vibrate", "anim" + Math.round(9 * Math.random()));
  this.on("unset", function () {
    i.shortcut = null;
    i.isDisabled = !1;
    n.disableDrag(i);
    i.icon.delClassNames("disabled");
    i.addClassNames("empty");
    e._selectedSlot === i && e._unSelectSlot(i);
  });
  this.on("setData", function () {
    i.delClassNames("empty");
    e._selectedSlot === i && e._unSelectSlot(i);
  });
  this.on("dragStart", function () {
    e._dragStartPage = e._pagination.current;
    e.isOrganizing && e.showTrash();
    "spell" === i.type && window.gui.fightManager.isInBattle() && !e.isOrganizing && (i.selected || e._selectSlot(i, !1), i.customScale = 1, i.customXOffset = 0, i.customYOffset = -24, i.customRotation = 45);
  });
  this.on("dragEnd", function (t, n) {
    e.hideTrash();
    "spell" === i.type && window.gui.fightManager.isInBattle() && !e.isOrganizing && (window.background.dragCellRelease(t, n, i), window.foreground.confirmBox.isOpen || e._unSelectSlot(i), i.customScale = null, i.customXOffset = null, i.customYOffset = null, i.customRotation = null);
  });
  this.on("drop", function (t, n, o) {
    e._onDropOnSlot(i, t, n, o);
  });
  this.on("tap", function () {
    if (!("spell" === i.type && i.isDisabled || "item" === i.type && window.gui.fightManager.isInBattle())) {
      var t = !0;
      e._selectSlot(i, t);
    }
  });
};
a.prototype._addDraggableBehaviour = function () {
  var e = null,
    t = "shortcutBar",
    i = null,
    o = {
      dragOnTouchstart: !1,
      dragElement: !0,
      noHover: !0
    };
  n.setDraggable(this, e, t, i, o);
  n.setDragEnable(this, !1);
};
a.prototype._addDroppableBehaviour = function () {
  var e = s[this.type],
    t = {
      matchPositionOnDrop: !0,
      isDropAllowed: this._isDropAllowed.bind(this)
    };
  n.setDroppable(this, e, t);
};
a.prototype._isDropAllowed = function (e, t, i) {
  return !window.gui.fightManager.isInBattle() || !!this.shortcutBar.isOrganizing || "shortcutBar" !== i || !t || "spell" !== t.type;
};
a.prototype._onContextualMenuClosed = function (e) {
  this.shortcutBar._unSelectSlot(this);
  "remove" === e && this.shortcutBar._removeShortcutFromSlotRequestWith2Animations(this);
};
a.prototype.enableDrag = function () {
  this.setDraggability(!0);
};
a.prototype.disableDrag = function () {
  this.setDraggability(!1);
};
a.prototype.setDraggability = function (e) {
  this.isEmpty() ? e = !1 : !e && "spell" === this.type && window.gui.fightManager.isInBattle() && (e = !0);
  n.setDragEnable(this, e);
};
a.prototype._isShortcutValid = function (e) {
  return e && e instanceof o && e.isHandled();
};
a.prototype.isEmpty = function () {
  return !this.shortcut;
};
a.prototype.getShortcutHash = function () {
  return this.shortcut ? this.shortcut.getHash() : null;
};
a.prototype.refreshShortcut = function () {
  this.setShortcut(this.shortcut);
};
this.slotIndex = t;
this.shortcutBar = e;
this.shortcut = null;
this.isDisabled = !1;
this._addDraggableBehaviour();
this._addDroppableBehaviour();
this.addClassNames("empty", "ShortcutSlot", "vibrate", "anim" + Math.round(9 * Math.random()));
this.on("unset", function () {
  i.shortcut = null;
  i.isDisabled = !1;
  n.disableDrag(i);
  i.icon.delClassNames("disabled");
  i.addClassNames("empty");
  e._selectedSlot === i && e._unSelectSlot(i);
});
this.on("setData", function () {
  i.delClassNames("empty");
  e._selectedSlot === i && e._unSelectSlot(i);
});
this.on("dragStart", function () {
  e._dragStartPage = e._pagination.current;
  e.isOrganizing && e.showTrash();
  "spell" === i.type && window.gui.fightManager.isInBattle() && !e.isOrganizing && (i.selected || e._selectSlot(i, !1), i.customScale = 1, i.customXOffset = 0, i.customYOffset = -24, i.customRotation = 45);
});
this.on("dragEnd", function (t, n) {
  e.hideTrash();
  "spell" === i.type && window.gui.fightManager.isInBattle() && !e.isOrganizing && (window.background.dragCellRelease(t, n, i), window.foreground.confirmBox.isOpen || e._unSelectSlot(i), i.customScale = null, i.customXOffset = null, i.customYOffset = null, i.customRotation = null);
});
this.on("drop", function (t, n, o) {
  e._onDropOnSlot(i, t, n, o);
});
this.on("tap", function () {
  if (!("spell" === i.type && i.isDisabled || "item" === i.type && window.gui.fightManager.isInBattle())) {
    var t = !0;
    e._selectSlot(i, t);
  }
});
i.shortcut = null;
i.isDisabled = !1;
n.disableDrag(i);
i.icon.delClassNames("disabled");
i.addClassNames("empty");
e._selectedSlot === i && e._unSelectSlot(i);
i.delClassNames("empty");
e._selectedSlot === i && e._unSelectSlot(i);
e._dragStartPage = e._pagination.current;
e.isOrganizing && e.showTrash();
"spell" === i.type && window.gui.fightManager.isInBattle() && !e.isOrganizing && (i.selected || e._selectSlot(i, !1), i.customScale = 1, i.customXOffset = 0, i.customYOffset = -24, i.customRotation = 45);
e.hideTrash();
"spell" === i.type && window.gui.fightManager.isInBattle() && !e.isOrganizing && (window.background.dragCellRelease(t, n, i), window.foreground.confirmBox.isOpen || e._unSelectSlot(i), i.customScale = null, i.customXOffset = null, i.customYOffset = null, i.customRotation = null);
n.setDraggable(this, e, t, i, o);
n.setDragEnable(this, !1);
this.shortcutBar._unSelectSlot(this);
"remove" === e && this.shortcutBar._removeShortcutFromSlotRequestWith2Animations(this);
this.isEmpty() ? e = !1 : !e && "spell" === this.type && window.gui.fightManager.isInBattle() && (e = !0);
n.setDragEnable(this, e);
a.call(this, {
  scaleOnPress: !0
});
this.type = "spell";
this.delayedSetShortcutData = null;
s.constructor.call(this, e, t);
this.on("dragMove", function (t, n) {
  window.gui.fightManager.isInBattle() && !e.isOrganizing && window.background.colorCurrentDragCell(t, n, i);
});
this.on("selected", function () {
  i.isEmpty() || window.gui.emit("spellSlotSelected", i.shortcut.spellId);
});
this.on("unselected", function () {
  window.gui.emit("spellSlotDeselected");
});
window.gui.on("disconnect", function () {
  i._resetDelayedSetShortcut();
});
o(n, a);
e.exports = n;
n.prototype._resetDelayedSetShortcut = function () {
  if (this.delayedSetShortcutData) {
    var e = this.delayedSetShortcutData.character;
    e && e.spellData && (e.spellData.removeListener("loaded", this.delayedSetShortcutData.cb), this.delayedSetShortcutData = null);
  }
};
n.prototype.setShortcut = function (e) {
  if (this._resetDelayedSetShortcut(), !this._isShortcutValid(e)) {
    return !this.isEmpty() && this.unset();
  }
  var t = window.gui.playerData.characters.getControlledCharacter(),
    i = t.spellData.spells[e.spellId];
  return this.shortcut = e, i ? (this.setSpell(i), void this.setContextMenu("spell", {
    spell: i,
    canRemove: !0,
    onClose: this._onContextualMenuClosed.bind(this)
  })) : (this.delayedSetShortcutData = {
    shortcut: e,
    character: t,
    cb: this.setShortcut.bind(this, e)
  }, t.spellData.once("loaded", this.delayedSetShortcutData.cb));
};
s.appendPrototypeTo(n);
e = e || {};
o.call(this, e);
this.addClassNames("SpellSlot");
this.setSpell(e.spellData, e.descriptionOptions);
this.customScale = null;
this.customXOffset = null;
this.customYOffset = null;
this.customRotation = null;
this._setSpellCount = 0;
r(n, o);
e.exports = n;
n.prototype.setSpell = function (e, t) {
  if (this.descriptionOptions = t || this.descriptionOptions, !e) {
    return this.unset();
  }
  var i = ++this._setSpellCount,
    n = this.spellInstance = e._uid ? e : null,
    o = this.dbSpell = n ? n.spell : e,
    s = this;
  if (n && n.isItem) {
    var r = n._item;
    if (!r.isInitialised) {
      return r.once("initialised", function () {
        s._setSpellCount === i && s.setSpell(e);
      });
    }
    this.setImage(r.getProperty("image"));
  } else {
    o.image ? this.setImage(o.image) : (this.setImage(a.placeHolder), o.iconId < 0 && console.error(new Error("iconId < 0 for spellId " + o.id + ": " + o.iconId)), l.preloadImage("gfx/spells/sort_" + o.iconId + ".png", function (e) {
      s._setSpellCount === i && (o.image = e, s.setImage(o.image));
    }));
  }
  this.setTooltip(this._getTooltipContent);
  this.setData(e);
};
n.prototype._getTooltipContent = function () {
  return new s({
    spell: this.spellInstance || this.dbSpell
  }, this.descriptionOptions);
};
n.prototype.setCooldown = function (e) {
  var t = e >= 63 ? c.INFINITE_CHARACTER : e;
  this.quantityBox.setText(t);
  this.quantityBox.toggleDisplay(e > 0);
};
this.setTooltip(this._getTooltipContent);
this.setData(e);
this.quantityBox.setText(t);
this.quantityBox.toggleDisplay(e > 0);
this.updateVisibleBlocks(!0);
this.updateUI(e);
this._domElements.points.ap.setText(I("ui.common.ap") + I("ui.common.colon") + i);
this._domElements.points.ra.setText(I("ui.common.ra") + I("ui.common.colon") + n);
o !== n ? this._domElements.points.range.setText(" - " + o) : this._domElements.points.range.clearContent();
o && (n = N.totalCriticalHitRate(i, o));
i > 0 && n > 0 && this._domElements.criticalHit.isVisible() ? this._domElements.criticalReal.setText(I("ui.itemtooltip.itemCriticalReal", "1/" + n)) : this._domElements.criticalReal.clearContent();
A(n, S);
e.exports = n;
n.prototype.updateVisibleBlocks = function (e) {
  var t = this._domElements;
  for (var i in L) {
    var n = this.visibilityOptions[i],
      o = this.visibilityBoundToOptions ? E[i] : !!this.visibilityOptions[i];
    if (e || o !== n) {
      this.visibilityOptions[i] = o;
      for (var a = L[i], s = 0; s < a.length; s++) {
        t[a[s]].toggleDisplay(o);
      }
    }
  }
};
n.prototype._buildDomElements = function (e, t) {
  var i = this._domElements = {};
  i.spellName = this.createChild("div", {
    className: "spellName"
  });
  i.pointsLine = this.createChild("div", {
    className: "pointsLine"
  });
  i.points = {
    ap: i.pointsLine.createChild("span", {
      className: "ap"
    }),
    ra: i.pointsLine.createChild("span", {
      className: "ra"
    }),
    range: i.pointsLine.createChild("span")
  };
  i.criticalReal = this.createChild("div");
  i.criticalHit = this.createChild("div");
  i.areaOfEffect = this.createChild("div");
  i.level = this.createChild("div");
  i.breed = this.createChild("div");
  i.rangeBoost = this.createChild("div");
  i.castWithoutLos = this.createChild("div");
  i.castInLine = this.createChild("div");
  i.maxStack = this.createChild("div");
  i.maxCastPerTarget = this.createChild("div");
  i.maxCastPerTurn = this.createChild("div");
  i.initialCooldown = this.createChild("div");
  i.minCastInterval = this.createChild("div");
  i.globalCooldown = this.createChild("div");
  i.forbiddenStates = this.createChild("div");
  i.requiredStates = this.createChild("div");
  i.effectsAndDamage = this.appendChild(new C(t));
  i.description = this.createChild("div", {
    className: "description"
  });
};
n.prototype.updateUI = function (e) {
  if (e && e.spell && e.spell.isLoaded) {
    this.updateVisibleBlocks();
    var t = e.spell,
      i = void 0 !== e.level ? e.level : t.level;
    o.call(this, t);
    a.call(this, t, i);
    s.call(this, t, i);
    r.call(this, t, i);
    l.call(this, t);
    c.call(this, t, i);
    d.call(this, t, i);
    u.call(this, t, i);
    h.call(this, t, i);
    p.call(this, t, i);
    m.call(this, t, i);
    f.call(this, t, i);
    g.call(this, t, i);
    y.call(this, t, i);
    _.call(this, t, i);
    v.call(this, t, i);
    b.call(this, t, i);
    w.call(this, t, i);
    M.call(this, t, i);
    T.call(this, t, i);
  }
};
i.spellName = this.createChild("div", {
  className: "spellName"
});
i.pointsLine = this.createChild("div", {
  className: "pointsLine"
});
i.points = {
  ap: i.pointsLine.createChild("span", {
    className: "ap"
  }),
  ra: i.pointsLine.createChild("span", {
    className: "ra"
  }),
  range: i.pointsLine.createChild("span")
};
i.criticalReal = this.createChild("div");
i.criticalHit = this.createChild("div");
i.areaOfEffect = this.createChild("div");
i.level = this.createChild("div");
i.breed = this.createChild("div");
i.rangeBoost = this.createChild("div");
i.castWithoutLos = this.createChild("div");
i.castInLine = this.createChild("div");
i.maxStack = this.createChild("div");
i.maxCastPerTarget = this.createChild("div");
i.maxCastPerTurn = this.createChild("div");
i.initialCooldown = this.createChild("div");
i.minCastInterval = this.createChild("div");
i.globalCooldown = this.createChild("div");
i.forbiddenStates = this.createChild("div");
i.requiredStates = this.createChild("div");
i.effectsAndDamage = this.appendChild(new C(t));
i.description = this.createChild("div", {
  className: "description"
});
o.call(this, t);
a.call(this, t, i);
s.call(this, t, i);
r.call(this, t, i);
l.call(this, t);
c.call(this, t, i);
d.call(this, t, i);
u.call(this, t, i);
h.call(this, t, i);
p.call(this, t, i);
m.call(this, t, i);
f.call(this, t, i);
g.call(this, t, i);
y.call(this, t, i);
_.call(this, t, i);
v.call(this, t, i);
b.call(this, t, i);
w.call(this, t, i);
M.call(this, t, i);
T.call(this, t, i);
d && d.length >= b * T && (l = d, a = S);
l || (l = t, a = S);
n += l.length;
i.push(s + l + a);
s = a === S ? S : "";
a = "";
l(n, h);
e.exports = n;
n.prototype._createContent = function (e) {
  this.addClassNames("speechBubble");
  this.isLocked && this.addClassNames("frozen");
  c(this, {
    doubletapTimeout: 1
  });
  this.on("tap", this._tapHandler);
  e.title && (this.title = this.createChild("div", {
    className: "title"
  }));
  this.content = this.createChild("div", {
    className: "content"
  });
  this.arrow = this.createChild("div");
  e.channel && this.addClassNames("channel" + e.channel);
};
n.prototype._resize = function () {
  var e = this.content,
    t = e.rootElement.clientWidth;
  if (t > m) {
    var i = this.contentLength < f ? m : p;
    e.setStyle("width", i + "px");
  }
};
n.prototype._setArrow = function (e) {
  this.arrow.setClassNames("arrow");
  var t = e.angle;
  t > 0 ? t > Math.PI / 2 ? this.arrow.addClassNames("bottomLeft") : this.arrow.addClassNames("bottomRight") : t < -Math.PI / 2 ? this.arrow.addClassNames("topLeft") : this.arrow.addClassNames("topRight");
};
n.prototype.setTitle = function (e) {
  this.title.setText(e);
};
n.prototype._setPage = function (e) {
  this.content.appendChild(r.process(e, {
    objectItems: this.objectItems,
    channel: this.channel,
    decodeAllPages: this.decodeAllPages,
    senderId: this._senderId,
    senderName: this._senderName,
    isNonChat: this._isNonChat
  }));
  this.contentLength = e.length;
};
n.prototype._setContent = function (e, t) {
  if (this.objectItems = t, "string" == typeof e) {
    e.length > b && (this.nextBtn = this.createChild("div", {
      className: "nextBtn"
    }), this.msgPages = a(e), this.currentPage = 0, e = this.msgPages[0] + C);
    this._setPage(e);
  } else {
    if (!(e instanceof h)) {
      return console.error(new Error("SpeechBubble: unknown msg type (" + typeof e + ")"));
    }
    this.content.appendChild(e);
    this.contentLength = e.rootElement.innerText.length;
  }
};
n.prototype._displayNextPage = function () {
  return !!this.msgPages && !(this.currentPage >= this.msgPages.length - 1) && (u.tween(this, {
    opacity: 0
  }, {
    time: w
  }, function () {
    if (this.isAlive) {
      this.currentPage++;
      this.currentPage === this.msgPages.length - 1 && this.nextBtn.hide();
      var e = this.msgPages[this.currentPage] + C;
      this.content.setStyle("width", null);
      this.content.clearContent();
      this._setPage(e);
      this._resize();
      this._findPosition();
      s.forceReflow(this);
      u.tween(this, {
        opacity: 1
      }, {
        time: g
      });
    }
  }), !0);
};
n.prototype._openNextToActor = function () {
  this.setStyle("opacity", 0);
  window.gui.gameGuiContainer.appendChild(this);
  this._resize();
  var e = window.isoEngine.mapScene.camera;
  e.emitAtDestination ? e.once("atDestination", this._findPositionAppearAndListen.bind(this)) : this._findPositionAppearAndListen();
};
n.prototype._findPositionAppearAndListen = function () {
  this.isAlive && (this._findPosition(), this._appearAndListen());
};
n.prototype._findPosition = function () {
  var e = window.gui.boxArranger;
  this.box && e.removeBox(this.box);
  var t = this.box = window.gui.boxArranger.addBoxNextToActor(this.actor, this);
  this.setStyles({
    left: t.x + "px",
    top: t.y + "px"
  });
  this._setArrow(t);
};
n.prototype._appearAndListen = function () {
  window.gui.on("disconnect", this.closeFunc);
  this.isLocked || window.isoEngine.on("mapLoaded", this.closeFunc);
  var e = this.isLocked || this.msgPages,
    t = e ? 1 : _;
  this.tweener = u.tween(this, {
    opacity: t
  }, {
    time: g
  }, function () {
    if (!e) {
      var t = d.computeNotificationDisplayTime(this.contentLength);
      this.timeout = window.setTimeout(function (e) {
        e._dimBeforeDisappearing();
      }, t, this);
    }
  });
};
n.prototype._dimBeforeDisappearing = function () {
  this.tweener = u.tween(this, {
    opacity: y
  }, {
    time: 400
  }, this._disappearLater);
};
n.prototype._disappearLater = function () {
  this.timeout = window.setTimeout(this.closeFunc, v);
};
n.prototype._tapHandler = function () {
  if (!this._displayNextPage()) {
    if (this.isLocked) {
      if (!this.actionHandler) {
        return;
      }
      return this.actionHandler();
    }
    return this.msgPages ? this.close() : this.tweener || this.timeout ? void this._freeze() : this.close();
  }
};
n.prototype._freeze = function () {
  this.addClassNames("frozen");
  this.setStyle("opacity", 1);
  this.tweener.cancel();
  this.tweener = null;
  this.timeout && (window.clearTimeout(this.timeout), this.timeout = null);
  window.foreground.on("dom.touchend", this.closeFunc);
};
n.prototype.close = function (e) {
  e && e.isReload || this.isAlive && (this.isAlive = !1, this.setEnable(!1), this.tweener && this.tweener.cancel(), window.clearTimeout(this.timeout), window.isoEngine.removeListener("mapLoaded", this.closeFunc), window.foreground.removeListener("dom.touchend", this.closeFunc), window.gui.removeListener("disconnect", this.closeFunc), this.closeHandler && this.closeHandler(), window.gui.boxArranger.removeBox(this.box), u.tween(this, {
    opacity: 0
  }, {
    time: w
  }, this.destroy));
};
this.addClassNames("speechBubble");
this.isLocked && this.addClassNames("frozen");
c(this, {
  doubletapTimeout: 1
});
this.on("tap", this._tapHandler);
e.title && (this.title = this.createChild("div", {
  className: "title"
}));
this.content = this.createChild("div", {
  className: "content"
});
this.arrow = this.createChild("div");
e.channel && this.addClassNames("channel" + e.channel);
this.content.appendChild(r.process(e, {
  objectItems: this.objectItems,
  channel: this.channel,
  decodeAllPages: this.decodeAllPages,
  senderId: this._senderId,
  senderName: this._senderName,
  isNonChat: this._isNonChat
}));
this.contentLength = e.length;
e.length > b && (this.nextBtn = this.createChild("div", {
  className: "nextBtn"
}), this.msgPages = a(e), this.currentPage = 0, e = this.msgPages[0] + C);
this._setPage(e);
this.content.appendChild(e);
this.contentLength = e.rootElement.innerText.length;
this.currentPage++;
this.currentPage === this.msgPages.length - 1 && this.nextBtn.hide();
this.content.setStyle("width", null);
this.content.clearContent();
this._setPage(e);
this._resize();
this._findPosition();
s.forceReflow(this);
u.tween(this, {
  opacity: 1
}, {
  time: g
});
this.setStyle("opacity", 0);
window.gui.gameGuiContainer.appendChild(this);
this._resize();
this.setStyles({
  left: t.x + "px",
  top: t.y + "px"
});
this._setArrow(t);
window.gui.on("disconnect", this.closeFunc);
this.isLocked || window.isoEngine.on("mapLoaded", this.closeFunc);
this.addClassNames("frozen");
this.setStyle("opacity", 1);
this.tweener.cancel();
this.tweener = null;
this.timeout && (window.clearTimeout(this.timeout), this.timeout = null);
window.foreground.on("dom.touchend", this.closeFunc);
s.call(this, "div", {
  className: "Timeline",
  hidden: !0
});
this._createContent();
this.statsDetails = null;
this.currentFighter = null;
this.selectedFighter = null;
this.isCollapsed = !1;
this._registerListeners(window.gui);
this.timerTimestamp = null;
this.timerDuration = null;
this.timerTween = null;
this._previousFighter = null;
o(n, s);
e.exports = n;
n.prototype._registerListeners = function (e) {
  function t(e, t, i) {
    t || (t = [], e.length > 0 && t.push(e[0]));
    for (var n = s.getAvailableFighters(), o = 0, a = t.length; o < a; o++) {
      var r = t[o],
        l = n[r];
      l && i(l);
    }
  }
  function i(e, i) {
    t(e, i, function (e) {
      o.unsetTurnOf(e);
      o.onOrderFightersSwitched();
      a.hideDeadFighters && o.refreshTimeline();
    });
  }
  function n(e) {
    e.refreshHP();
    e.refreshShield();
  }
  var o = this,
    s = e.fightManager;
  s.on("GameFightTurnEnd", function (e) {
    var t = this.getFighter(e);
    t && t.data.alive && o.unsetTurnOf(t);
  });
  s.on("FightersListUpdated", function () {
    o.refreshTimeline();
  });
  s.on("UpdatePreFightersList", function () {
    o.refreshTimeline();
  });
  s.on("GameFightTurnStart", function (e, t) {
    var i = this.getFighter(e);
    i && i.data.alive && o.setTurnOf(i, t);
  });
  s.on(h.FIGHTER_DEATH, i);
  s.on(h.FIGHTER_LEAVE, i);
  s.on("FoldAll", function () {});
  s.on("BuffAdd", function (e, t) {
    n(t);
    o._refreshAfterResize();
  });
  s.on("BuffDispell", function (e) {
    n(e);
  });
  s.on("BuffRemove", function (e, t) {
    n(t);
    o._refreshAfterResize();
  });
  s.on("BuffUpdate", function (e, t) {
    n(t);
  });
  s.on("TurnCountUpdated", function (e) {
    o.turnCountLabel.setText(u("ui.fight.turnNumber", e + 1));
  });
  s.on("OrderFightersSwitched", function () {
    o.onOrderFightersSwitched();
  });
  a.on("hideDeadFighters", function () {
    o.refreshTimeline();
  });
  a.on("orderFighters", function (e) {
    var t = s.getAvailableFighters();
    for (var i in t) {
      t[i].picto.fighterNumber.toggleDisplay(e);
    }
    o.refreshTimeline();
    e || window.actorManager.allTurnNumbersOff();
  });
  e.on("resize", function (e) {
    w = Math.floor(.7 * e.mapWidth);
  });
  this.on("collapse", function (e) {
    this.isCollapsed = e;
    this._refreshAfterResize();
  });
  this.on("dragEnd", function () {
    this.fighterListScroller.refresh();
  });
};
n.prototype._createContent = function () {
  r(this, {
    isCollapsable: !0
  });
  var e = this.infoAndFighters = this.createChild("div", {
    className: "infoAndFighters"
  });
  this.fighterListContainer = e.createChild("div", {
    name: "fighterListContainer",
    className: "fighterListContainer"
  });
  this.fighterListScroller = this.fighterListContainer.appendChild(new p({
    name: "fighterListScroller",
    className: "fighterList"
  }, {
    isHorizontal: !0
  }));
  this.fighterList = this.fighterListScroller.content;
  this.infoContainer = e.createChild("div", {
    className: "infoContainer"
  });
  this.turnCountLabel = this.infoContainer.createChild("div", {
    className: "turnCountLabel"
  });
  this.fightControlButtons = this.infoContainer.appendChild(new l());
  this.fightControlButtons.on("TurnReadyPressed", function () {
    window.gui.fightManager.finishTurn();
  });
  this.buffList = this.appendChild(new c());
};
n.prototype.close = function () {
  this.currentFighter && this.unsetTurnOf(this.currentFighter);
  this.selectedFighter = null;
  this.buffList.close();
  this.hide();
  this.fighterList.clearContent();
  this.turnCountLabel.clearContent();
};
n.prototype.restoreFighterList = function () {
  this.infoAndFighters.insertAsFirstChild(this.fighterListContainer);
  this.restartTimerAnimation();
  this.refreshTimeline();
};
n.prototype.appendFighterListTo = function (e) {
  e.appendChild(this.fighterListContainer);
  this.restartTimerAnimation();
  this.refreshTimeline();
};
n.prototype.refreshTimeline = function () {
  var e,
    t,
    i,
    n = "fightPlacement" === window.foreground.tapOptions.mode,
    o = window.gui.fightManager,
    s = o.getFighters(),
    r = o.getDeadFighters(),
    l = o.getAvailableFighters(),
    c = {},
    d = 1;
  if (n) {
    var u = this.fighterList.getChildren();
    for (i = 0; i < u.length; i++) {
      this.fighterList.removeChild(u[i]);
    }
  }
  var h,
    p = s.length,
    m = 0;
  for (i = 0; i < p; i++) {
    if (e = s[i], c[e] = !0, t = l[e]) {
      var f = r.indexOf(e) < 0;
      if (t.setAlive(f, !0), (f || !a.hideDeadFighters) && (t.updateNumber(f && d++), m += t.isSummon() ? y : v, !this.fighterList.getChild(e))) {
        h = null;
        for (var g = i + 1; g < p && !(h = this.fighterList.getChild(s[g])); g++) {
          ;
        }
        this.fighterList.insertChildBefore(t.picto, h);
        t.resizeFighterIllustration();
      }
    } else {
      console.error(new Error("Fighter " + e + " not found when refreshing timeline during fight state " + o.fightState));
    }
  }
  if (!n) {
    for (e in l) {
      if (!c[e]) {
        var _ = this.fighterList.getChild(e);
        _ && this.fighterList.removeChild(_);
      }
    }
  }
  m = Math.min(m, w);
  this.fighterListContainer.setStyle("width", m + "px");
  this._refreshAfterResize();
};
n.prototype._refreshAfterResize = function () {
  this.emit("resized");
  this.fighterListScroller.refresh();
  this.isCollapsed && this.currentFighter && this.fighterListScroller.showElement(this.currentFighter.picto);
};
n.prototype.onOrderFightersSwitched = function () {
  for (var e = this.fighterList.getChildren(), t = window.gui.fightManager, i = 1, n = 0, o = e.length; n < o; n++) {
    var a = e[n].getWuiName(),
      s = t.getFighter(a);
    if (!s) {
      return console.error("Fighters' order switch failed, fighter does not exist.");
    }
    s.data.alive ? (s.updateNumber(i), i++) : s.updateNumber();
  }
};
n.prototype.linkToTimeline = function (e) {
  var t = this;
  d(e.picto, function () {
    if (!window.gui.fightManager.isInFightPreparation() || e.data.disposition.cellId !== -1) {
      return t.statsDetails ? e.refreshStatsTooltipContent(t.statsDetails) : t.statsDetails = e.createStatsTooltipContent(), t.statsDetails;
    }
  });
  e.picto.on("tap", function () {
    t.onFighterSelected(e);
  });
  e.picto.on("tooltipOn", function () {
    t.onPressEntity(e, !1);
    window.isoEngine.displayEnemyMovementZone(e);
  });
  e.picto.on("tooltipOut", function () {
    t.onReleaseEntity();
    window.isoEngine.removeEnemyMovementZone();
  });
  f.setDroppable(e.picto, ["shortcutBar"]);
  e.picto.on("beforeDragEnd", function () {
    t.onFighterSelected(e);
  });
};
n.prototype.onFighterSelected = function (e) {
  if (window.gui.scenarioManager.isBehaviourEnabled(_.TIMELINE_CAST)) {
    var t = window.gui.shortcutBar.getIdOfSelectedSpellIfAny();
    if (t || 0 === t) {
      var i = window.gui,
        n = i.playerData.characters.controlledCharacterId;
      return void (e.data.alive && i.fightManager.currentFighterId === n && (i.fightManager.castSpell(t, e.data.disposition.cellId, i.playerData.characters.controlledCharacterId), window.isoEngine.clearSpellDisplay(), i.shortcutBar.deselectCurrentSlot()));
    }
    if (this.selectedFighter) {
      window.actorManager.selectionIndicatorOff(this.selectedFighter);
      var o = this.selectedFighter.picto;
      o && o.rootElement && o.delClassNames("selected");
    }
    if (window.gui.pingSystem.isActive()) {
      var a = e.data.disposition.cellId;
      return window.isoEngine.mapRenderer.addPingHighlight(a, window.isoEngine.getContext(a), !0);
    }
    this.selectedFighter === e ? (this.selectedFighter = null, this.buffList.hide()) : (window.actorManager.selectionIndicatorOn(e), e.picto.addClassNames("selected"), this.selectedFighter = e, this.buffList.open(e));
    this._refreshAfterResize();
  }
};
n.prototype.onPressEntity = function (e) {
  e && e.data.disposition.cellId !== -1 && e.data.stats.invisibilityState !== g.INVISIBLE && window.isoEngine.highlightActorOnAction(e.id, 1e3);
};
n.prototype.onReleaseEntity = function () {
  window.isoEngine.clearHighlights();
};
n.prototype.restartTimerAnimation = function () {
  if (this.currentFighter && this.timerTween) {
    this.timerTween.cancel();
    var e = Date.now() - this.timerTimestamp;
    if (!(e < 0 || e >= this.timerDuration)) {
      var t = this.timerDuration - e,
        i = Math.ceil(100 * e / this.timerDuration);
      this.playTimerAnimation(t, i);
    }
  }
};
n.prototype.startTimerAnimation = function (e) {
  this.timerTimestamp = Date.now();
  this.timerDuration = e;
  this.playTimerAnimation(e, 0);
};
n.prototype.stopTimerAnimation = function () {
  this.timerTimestamp = null;
  this.timerDuration = null;
  this.timerTween.cancel();
  this.timerTween = null;
  var e = this.currentFighter.picto;
  e.delClassNames("current");
  e.fighterTimeValue.setStyles({
    webkitTransition: "",
    webkitTransform: "translate3d(0,100%,0)"
  });
};
n.prototype.playTimerAnimation = function (e, t) {
  var i = this.currentFighter.picto;
  i.fighterTimeValue.setStyle("webkitTransform", "translate3d(0, " + (100 - t) + "%, 0)");
  this.timerTween = m.tween(i.fighterTimeValue, {
    webkitTransform: "translate3d(0, 0, 0)"
  }, {
    time: e,
    easing: "linear"
  });
  i.addClassNames("current");
  this.isCollapsed && this.fighterListScroller.showElement(i);
};
n.prototype.unsetTurnOf = function (e) {
  this.currentFighter && this.currentFighter === e && (window.actorManager.turnIndicatorOff(e), this.stopTimerAnimation(), this.currentFighter = null);
};
n.prototype.setTurnOf = function (e, t) {
  this.currentFighter && this.unsetTurnOf(this.currentFighter);
  this.currentFighter = e;
  this.startTimerAnimation(t);
  this.emit("setTurnOf", e, t);
  this._previousFighter && window.actorManager.turnIndicatorOff(this._previousFighter);
  window.actorManager.turnIndicatorOn(e);
  this._previousFighter = e;
};
o.unsetTurnOf(e);
o.onOrderFightersSwitched();
a.hideDeadFighters && o.refreshTimeline();
e.refreshHP();
e.refreshShield();
s.on("GameFightTurnEnd", function (e) {
  var t = this.getFighter(e);
  t && t.data.alive && o.unsetTurnOf(t);
});
s.on("FightersListUpdated", function () {
  o.refreshTimeline();
});
s.on("UpdatePreFightersList", function () {
  o.refreshTimeline();
});
s.on("GameFightTurnStart", function (e, t) {
  var i = this.getFighter(e);
  i && i.data.alive && o.setTurnOf(i, t);
});
s.on(h.FIGHTER_DEATH, i);
s.on(h.FIGHTER_LEAVE, i);
s.on("FoldAll", function () {});
s.on("BuffAdd", function (e, t) {
  n(t);
  o._refreshAfterResize();
});
s.on("BuffDispell", function (e) {
  n(e);
});
s.on("BuffRemove", function (e, t) {
  n(t);
  o._refreshAfterResize();
});
s.on("BuffUpdate", function (e, t) {
  n(t);
});
s.on("TurnCountUpdated", function (e) {
  o.turnCountLabel.setText(u("ui.fight.turnNumber", e + 1));
});
s.on("OrderFightersSwitched", function () {
  o.onOrderFightersSwitched();
});
a.on("hideDeadFighters", function () {
  o.refreshTimeline();
});
a.on("orderFighters", function (e) {
  var t = s.getAvailableFighters();
  for (var i in t) {
    t[i].picto.fighterNumber.toggleDisplay(e);
  }
  o.refreshTimeline();
  e || window.actorManager.allTurnNumbersOff();
});
e.on("resize", function (e) {
  w = Math.floor(.7 * e.mapWidth);
});
this.on("collapse", function (e) {
  this.isCollapsed = e;
  this._refreshAfterResize();
});
this.on("dragEnd", function () {
  this.fighterListScroller.refresh();
});
n(t);
o._refreshAfterResize();
n(t);
o._refreshAfterResize();
o.refreshTimeline();
e || window.actorManager.allTurnNumbersOff();
this.isCollapsed = e;
this._refreshAfterResize();
this.fighterListContainer = e.createChild("div", {
  name: "fighterListContainer",
  className: "fighterListContainer"
});
this.fighterListScroller = this.fighterListContainer.appendChild(new p({
  name: "fighterListScroller",
  className: "fighterList"
}, {
  isHorizontal: !0
}));
this.fighterList = this.fighterListScroller.content;
this.infoContainer = e.createChild("div", {
  className: "infoContainer"
});
this.turnCountLabel = this.infoContainer.createChild("div", {
  className: "turnCountLabel"
});
this.fightControlButtons = this.infoContainer.appendChild(new l());
this.fightControlButtons.on("TurnReadyPressed", function () {
  window.gui.fightManager.finishTurn();
});
this.buffList = this.appendChild(new c());
this.currentFighter && this.unsetTurnOf(this.currentFighter);
this.selectedFighter = null;
this.buffList.close();
this.hide();
this.fighterList.clearContent();
this.turnCountLabel.clearContent();
this.infoAndFighters.insertAsFirstChild(this.fighterListContainer);
this.restartTimerAnimation();
this.refreshTimeline();
e.appendChild(this.fighterListContainer);
this.restartTimerAnimation();
this.refreshTimeline();
this.fighterList.insertChildBefore(t.picto, h);
t.resizeFighterIllustration();
m = Math.min(m, w);
this.fighterListContainer.setStyle("width", m + "px");
this._refreshAfterResize();
this.emit("resized");
this.fighterListScroller.refresh();
this.isCollapsed && this.currentFighter && this.fighterListScroller.showElement(this.currentFighter.picto);
d(e.picto, function () {
  if (!window.gui.fightManager.isInFightPreparation() || e.data.disposition.cellId !== -1) {
    return t.statsDetails ? e.refreshStatsTooltipContent(t.statsDetails) : t.statsDetails = e.createStatsTooltipContent(), t.statsDetails;
  }
});
e.picto.on("tap", function () {
  t.onFighterSelected(e);
});
e.picto.on("tooltipOn", function () {
  t.onPressEntity(e, !1);
  window.isoEngine.displayEnemyMovementZone(e);
});
e.picto.on("tooltipOut", function () {
  t.onReleaseEntity();
  window.isoEngine.removeEnemyMovementZone();
});
f.setDroppable(e.picto, ["shortcutBar"]);
e.picto.on("beforeDragEnd", function () {
  t.onFighterSelected(e);
});
t.onPressEntity(e, !1);
window.isoEngine.displayEnemyMovementZone(e);
t.onReleaseEntity();
window.isoEngine.removeEnemyMovementZone();
this.selectedFighter === e ? (this.selectedFighter = null, this.buffList.hide()) : (window.actorManager.selectionIndicatorOn(e), e.picto.addClassNames("selected"), this.selectedFighter = e, this.buffList.open(e));
this._refreshAfterResize();
this.timerTimestamp = Date.now();
this.timerDuration = e;
this.playTimerAnimation(e, 0);
this.timerTimestamp = null;
this.timerDuration = null;
this.timerTween.cancel();
this.timerTween = null;
e.delClassNames("current");
e.fighterTimeValue.setStyles({
  webkitTransition: "",
  webkitTransform: "translate3d(0,100%,0)"
});
i.fighterTimeValue.setStyle("webkitTransform", "translate3d(0, " + (100 - t) + "%, 0)");
this.timerTween = m.tween(i.fighterTimeValue, {
  webkitTransform: "translate3d(0, 0, 0)"
}, {
  time: e,
  easing: "linear"
});
i.addClassNames("current");
this.isCollapsed && this.fighterListScroller.showElement(i);
this.currentFighter && this.unsetTurnOf(this.currentFighter);
this.currentFighter = e;
this.startTimerAnimation(t);
this.emit("setTurnOf", e, t);
this._previousFighter && window.actorManager.turnIndicatorOff(this._previousFighter);
window.actorManager.turnIndicatorOn(e);
this._previousFighter = e;
d.show();
c._isReadyForFight = e;
e ? d.addClassNames("readyForFight") : d.delClassNames("readyForFight");
d.hide();
c.setTurnReadyButtonAvailability(!1);
u.show();
c.emit("TurnReadyPressed");
n();
this.appendChild(u);
window.gui.on("GameFightJoinMessage", function (t) {
  e(!1);
  t.canSayReady ? d.enable() : d.disable();
});
window.gui.fightManager.on("playerReady", e);
window.gui.on("GameFightStartMessage", t);
window.gui.on("GameFightResumeMessage", t);
window.gui.on("GameFightResumeWithSlavesMessage", t);
window.gui.on("GameFightTurnStartPlayingMessage", function () {
  i(null);
});
window.gui.on("GameFightTurnStartMessage", i);
window.gui.on("GameFightTurnStartSlaveMessage", i);
window.gui.on("GameFightTurnResumeMessage", i);
window.gui.on("GameFightTurnEndMessage", n);
window.gui.on("GameFightEndMessage", o);
window.gui.on("disconnect", o);
window.gui.scenarioManager.on("stepChanged", function () {
  var e = window.gui.scenarioManager.isBehaviourEnabled(l.FIGHT_BTN);
  c.toggleClassName("disabled", !e);
});
e(!1);
t.canSayReady ? d.enable() : d.disable();
o(n, s);
e.exports = n;
n.prototype.toggleReadyForFight = function () {
  window.dofus.sendMessage("GameFightReadyMessage", {
    isReady: !this._isReadyForFight
  });
};
n.prototype.isReadyForFightButtonVisible = function () {
  return window.gui.fightManager.isInFight() && this._fightReadyBtn.isVisible() && window.gui.scenarioManager.isBehaviourEnabled(l.FIGHT_BTN);
};
n.prototype.setTurnReadyButtonAvailability = function (e) {
  var t = this._turnReadyBtn;
  e ? t.enable() : t.disable();
};
n.prototype.getButtonForTuto = function (e) {
  var t;
  switch (e) {
    case "fightReadyBtn":
      t = this._fightReadyBtn;
      break;
    case "turnReadyBtn":
      t = this._turnReadyBtn;
      break;
    default:
      return null;
  }
  return t.isVisible() ? t : null;
};
a.call(this, "div", {
  className: "FightBuffs"
});
this.buffList = this.createChild("div", {
  className: "buffList"
});
this.buffItems = {};
this._registerListeners(window.gui.fightManager);
this.fighter = null;
this.lastWasPlayer = !1;
this.buffDescription = new l();
this.hide();
o(n, a);
e.exports = n;
n.prototype._registerListeners = function (e) {
  var t = this;
  e.on("GameFightTurnStart", function (e) {
    if (e === window.gui.playerData.id) {
      t.lastWasPlayer = !0;
    } else if (t.lastWasPlayer) {
      for (var i = t.buffList.getChildren(), n = 0; n < i.length; n++) {
        i[n].updateCooldown();
      }
      t.lastWasPlayer = !1;
    }
  });
  e.on("BuffUpdate", function (e, i) {
    t.fighter === i && t.updateBuff(e);
  });
  e.on("BuffRemove", function (e, i) {
    t.fighter === i && t.removeBuff(e);
  });
  e.on("BuffAdd", function (e, i) {
    t.fighter === i && (t._addBuff(e), t.updateUi());
  });
};
n.prototype.open = function (e) {
  this.fighter !== e && (this.clean(), this.fighter = e, this.makeItemBuffs(e), this.updateUi());
  this.show();
};
n.prototype.close = function () {
  this.clean();
  this.hide();
};
n.prototype.clean = function () {
  this.fighter = null;
  this.buffList.clearContent();
  this.buffItems = {};
};
n.prototype.makeItemBuffs = function (e) {
  for (var t = e.buffs, i = 0, n = t.length; i < n; i++) {
    this._addBuff(t[i]);
  }
};
e.on("GameFightTurnStart", function (e) {
  if (e === window.gui.playerData.id) {
    t.lastWasPlayer = !0;
  } else if (t.lastWasPlayer) {
    for (var i = t.buffList.getChildren(), n = 0; n < i.length; n++) {
      i[n].updateCooldown();
    }
    t.lastWasPlayer = !1;
  }
});
e.on("BuffUpdate", function (e, i) {
  t.fighter === i && t.updateBuff(e);
});
e.on("BuffRemove", function (e, i) {
  t.fighter === i && t.removeBuff(e);
});
e.on("BuffAdd", function (e, i) {
  t.fighter === i && (t._addBuff(e), t.updateUi());
});
this.fighter !== e && (this.clean(), this.fighter = e, this.makeItemBuffs(e), this.updateUi());
this.show();
this.clean();
this.hide();
this.fighter = null;
this.buffList.clearContent();
this.buffItems = {};
n.prototype.updateUi = function () {
  for (var e = [], t = [], i = this.buffList.getChildren(), n = 0; n < i.length; n++) {
    var o = i[n];
    0 !== o.parentBoostUid ? t.push(o) : e.push(o);
  }
  for (e.sort(c), n = 0; n < t.length; n++) {
    for (var a = t[n], s = !1, r = 0, l = 0; l < e.length; l++) {
      if (e[l].maxCooldown() < a.cooldown && (r = l), e[l].hasUid(a.parentBoostUid)) {
        e.splice(l + 1, 0, a);
        s = !0;
        break;
      }
    }
    s || e.splice(r, 0, a);
  }
  for (n = 0; n < e.length; n++) {
    var d = e[n];
    this.buffList.appendChild(d);
  }
};
n.prototype._addBuff = function (e) {
  function t() {
    for (var e = [], t = -1, i = 0; i < n.buffs.length; i++) {
      var a = n.buffs[i];
      e.push(a.effect);
      t = a.source;
    }
    var s = window.gui.fightManager,
      r = s.getFighter(t);
    if (!r) {
      return null;
    }
    var c = {};
    return c.spellName = n.spell.getName(), c.casterName = r.name, c.effects = e, o ? o.updateUI(c) : o = new l(c), o;
  }
  if (e.visibleInBuffUI) {
    var i = s.getKey(e),
      n = this.buffItems[i];
    if (n) {
      return void n.addBuff(e);
    }
    n = new s(e);
    var o;
    r(n, t);
    this.buffItems[i] = n;
    this.buffList.appendChild(n);
    n.addBuff(e);
  }
};
n.prototype.updateBuff = function (e) {
  var t = s.getKey(e),
    i = this.buffItems[t];
  if (i) {
    i.updateCooldown(e);
    this.updateUi();
  } else {
    var n = s.getDelayKey(e);
    if (i = this.buffItems[n], !i) {
      return void console.warn("Trying to update a non-existing buff.");
    }
    this.buffItems[t] = i;
    delete this.buffItems[n];
  }
};
n.prototype.removeBuff = function (e) {
  this.removeBuffItem(e, s.getKey(e));
  this.removeBuffItem(e, s.getDelayKey(e));
  this.updateUi();
};
n.prototype.removeBuffItem = function (e, t) {
  var i = this.buffItems[t];
  i && (i.removeBuff(e), 0 === i.buffs.length && (this.buffList.removeChild(i), i.destroy(), delete this.buffItems[t]));
};
e.splice(l + 1, 0, a);
s = !0;
e.push(a.effect);
t = a.source;
r(n, t);
this.buffItems[i] = n;
this.buffList.appendChild(n);
n.addBuff(e);
i.updateCooldown(e);
this.updateUi();
this.buffItems[t] = i;
delete this.buffItems[n];
this.removeBuffItem(e, s.getKey(e));
this.removeBuffItem(e, s.getDelayKey(e));
this.updateUi();
a > 0 ? this.key = t + "#" + i + "#" + o + "#" + a : this.key = t + "#" + i + "#" + o;
this.parentBoostUid = 0;
this.spell = e.castingSpell.spell;
this.spell.getIconUri && c.preloadImage(this.spell.getIconUri(), function (e) {
  s && s.rootElement && s.setStyle("backgroundImage", e);
});
this.buffs = [];
this.cooldownLabel = this.createChild("div", {
  className: "cooldown"
});
this.setCooldown(0);
r(o, l);
e.exports = o;
e.exports.getDelayKey = a;
e.exports.getKey = s;
o.prototype.hasUid = function (e) {
  for (var t = 0; t < this.buffs.length; t++) {
    if (this.buffs[t].uid === e) {
      return !0;
    }
  }
  return !1;
};
o.prototype.addBuff = function (e) {
  this.buffs.push(e);
  0 !== e.parentBoostUid && (this.parentBoostUid = e.parentBoostUid);
  this.updateCooldown();
};
o.prototype.isUnusableNextTurn = function () {
  for (var e = 0; e < this.buffs.length; e++) {
    if (!this.buffs[e].isUnusableNextTurn()) {
      return !1;
    }
  }
  return !0;
};
o.prototype.updateCooldown = function () {
  for (var e = 0, t = !1, i = 0, n = 0, o = this.buffs.length; n < o; n++) {
    var a = this.buffs[n];
    t && e !== a.duration && this.setCooldown(this.cooldown - 1);
    (0 === i || a.effect.delay < i) && (i = a.effect.delay);
    e = a.duration;
    t = !0;
  }
  i > 0 ? this.setCooldown(i) : this.setCooldown(e);
  this.isUnusableNextTurn() && this.addClassNames("disabled");
};
o.prototype.setCooldown = function (e) {
  this.cooldown = e;
  e === -1 ? (this.cooldownLabel.setText("+"), this.cooldownLabel.show()) : 0 === e || e === Number.MAX_VALUE ? (this.cooldownLabel.setText(""), this.cooldownLabel.hide()) : e < -1 ? (this.cooldownLabel.setText(d.INFINITE_CHARACTER), this.cooldownLabel.show()) : (this.cooldownLabel.setText(e), this.cooldownLabel.show());
};
o.prototype.maxCooldown = function () {
  if (this.cooldown !== -1) {
    return this.cooldown;
  }
  for (var e = 0, t = 0, i = this.buffs.length; t < i; t++) {
    var n = this.buffs[t];
    (n.duration > e || n.duration < -1) && (e = n.duration);
  }
  return e;
};
o.prototype.removeBuff = function (e) {
  for (var t = 0; t < this.buffs.length; t++) {
    if (this.buffs[t] === e) {
      this.buffs.splice(t, 1);
      this.updateCooldown();
      break;
    }
  }
};
this.buffs.push(e);
0 !== e.parentBoostUid && (this.parentBoostUid = e.parentBoostUid);
this.updateCooldown();
t && e !== a.duration && this.setCooldown(this.cooldown - 1);
(0 === i || a.effect.delay < i) && (i = a.effect.delay);
e = a.duration;
t = !0;
i > 0 ? this.setCooldown(i) : this.setCooldown(e);
this.isUnusableNextTurn() && this.addClassNames("disabled");
this.cooldown = e;
e === -1 ? (this.cooldownLabel.setText("+"), this.cooldownLabel.show()) : 0 === e || e === Number.MAX_VALUE ? (this.cooldownLabel.setText(""), this.cooldownLabel.hide()) : e < -1 ? (this.cooldownLabel.setText(d.INFINITE_CHARACTER), this.cooldownLabel.show()) : (this.cooldownLabel.setText(e), this.cooldownLabel.show());
this.buffs.splice(t, 1);
this.updateCooldown();
d.call(this, "div", t);
this.addClassNames("BuffDescription");
this._buildDomElements(t);
this.updateUI(e);
c(n, d);
e.exports = n;
n.prototype._buildDomElements = function (e, t) {
  var i = this._domElements = {};
  i.spellName = this.createChild("div", {
    className: "spellName"
  });
  i.casterName = this.createChild("div", {
    className: "casterName"
  });
  i.effectsAndDamage = this.appendChild(new r(t, {
    alwaysVisible: !0
  }));
};
n.prototype.updateUI = function (e) {
  if (e) {
    var t = e.spellName,
      i = e.casterName,
      n = e.effects;
    o.call(this, t);
    a.call(this, i);
    s.call(this, n);
  }
};
i.spellName = this.createChild("div", {
  className: "spellName"
});
i.casterName = this.createChild("div", {
  className: "casterName"
});
i.effectsAndDamage = this.appendChild(new r(t, {
  alwaysVisible: !0
}));
o.call(this, t);
a.call(this, i);
s.call(this, n);
h.call(this, "div", {
  className: "DamagePreview"
});
this.damagePreviewManager = new g();
this.tooltips = [];
this._listeners();
this.hide();
m.left = y.left;
m.top = y.top;
l(s, v) && (h = !1);
l(r, v) && (p = !1);
l(d, v) && (m = !1);
l(u, v) && (f = !1);
s.top -= o.height;
r.top += o.height;
d.top -= o.width;
u.top += o.width;
p(n, h);
e.exports = n;
n.prototype._listeners = function () {
  var e = window.gui,
    t = this;
  f.on("allowDamagePreview", function () {
    t._hideTooltips();
    t._clearTooltips();
  });
  window.foreground.on("confirmBoxClosed", function () {
    t._hideTooltips();
  });
  e.fightManager.on("fightEnd", function () {
    t._hideTooltips();
    t._clearTooltips();
  });
  e.fightManager.on("GameFightTurnStart", function (e) {
    e === window.gui.playerData.id && t.damagePreviewManager.resetMark();
  });
};
n.prototype.cancel = function () {
  this._hideTooltips();
};
n.prototype.confirm = function () {
  this._hideTooltips();
  this.damagePreviewManager.confirmAffectedMark();
};
n.prototype._hideTooltips = function () {
  for (var e in this.tooltips) {
    if (this.tooltips.hasOwnProperty(e)) {
      var t = this.tooltips[e];
      t && t.isVisible() && t.hide();
    }
  }
  this.hide();
};
n.prototype._clearTooltips = function () {
  for (var e in this.tooltips) {
    if (this.tooltips.hasOwnProperty(e)) {
      var t = this.tooltips[e];
      t && t.destroy();
    }
  }
  this.tooltips = [];
};
n.prototype.preview = function (e, t, i) {
  i = i || {};
  var n = this,
    o = window.actorManager,
    a = window.gui.fightManager;
  f.allowDamagePreview && (this.show(), this.damagePreviewManager.resetTemporaryMark(), this.damagePreviewManager.getPreview(e, t, function (e, r) {
    if (e) {
      return console.error("The spell could not be previewed ", e);
    }
    for (var l in r) {
      if (r.hasOwnProperty(l)) {
        l = parseInt(l, 10);
        var c = o.getActor(l),
          d = r[l],
          h = a.getFighter(l),
          p = n.tooltips[l];
        if (0 !== d.length) {
          p || (n.tooltips[l] = new _(l), p = n.tooltips[l], n.appendChild(p));
          var m = !1;
          i.hasConfirmBox && h && h.data.disposition.cellId === t && (m = !0);
          var f = c && c.parentActor && c.parentActor.actorId || l,
            g = u(f);
          p.show();
          p.update(g.x, g.y, d, {
            insideConfirmBox: m
          });
        } else {
          p && p.isVisible() && p.hide();
        }
      }
    }
    s(n.tooltips);
  }));
};
f.on("allowDamagePreview", function () {
  t._hideTooltips();
  t._clearTooltips();
});
window.foreground.on("confirmBoxClosed", function () {
  t._hideTooltips();
});
e.fightManager.on("fightEnd", function () {
  t._hideTooltips();
  t._clearTooltips();
});
e.fightManager.on("GameFightTurnStart", function (e) {
  e === window.gui.playerData.id && t.damagePreviewManager.resetMark();
});
t._hideTooltips();
t._clearTooltips();
t._hideTooltips();
t._clearTooltips();
this._hideTooltips();
this.damagePreviewManager.confirmAffectedMark();
p.show();
p.update(g.x, g.y, d, {
  insideConfirmBox: m
});
e.exports = i(880);
i(895);
this._alreadyUsedMark = [];
this._temporaryUsedMark = [];
this._allSpellDamageInfo = [];
this._buffsWithSpellsTriggered = [];
this._spellCache = {};
this.transposition = [];
this.triggeredStates = [];
this._callStacks = [];
this._setupListeners();
e.exports = n;
n.prototype._setupListeners = function () {
  var e = m.gui,
    t = this;
  e.fightManager.on("fightEnd", function () {
    t._spellCache = {};
  });
};
n.prototype._resetData = function () {
  this._callStacks = [];
  this._allSpellDamageInfo = [];
  this._buffsWithSpellsTriggered = [];
  this.transposition = [];
  this.triggeredStates = [];
};
n.prototype.getPreview = function (e, t, i) {
  var n = this,
    o = m.gui.playerData.characters,
    a = o.getControlledCharacter().spellData.spells[e];
  if (!a) {
    return i(new Error("Spell " + e + " not available"));
  }
  var s = o.controlledCharacterId,
    r = m.actorManager.userActor.cellId;
  return a.isInSpellRange(r, t) ? (this._resetData(), void this._computeSpell(a, s, r, t, {
    statsBonus: {}
  }, function (e) {
    if (e) {
      return a.resetCellZoneEffect(), i(e);
    }
    var o = n._allSpellDamageInfo,
      l = n._temporaryUsedMark;
    n._temporaryUsedMark = [];
    n._resetData();
    n._computeSpell(a, s, r, t, {
      isCriticalEffect: !0,
      statsBonus: {}
    }, function (e) {
      if (a.resetCellZoneEffect(), e) {
        return i(e);
      }
      var t = n._allSpellDamageInfo;
      n._temporaryUsedMark = l;
      var s = u.getDamageData(o, t);
      return i(null, s);
    });
  })) : i(null, []);
};
n.prototype._refreshPositions = function (e) {
  for (var t = 0; t < e.length; t++) {
    var i = e[t],
      n = i.newCellId;
    this.changePosition(i.id, n);
  }
};
n.prototype.changePosition = function (e, t) {
  var i = m.actorManager.getActor(e);
  i && (this.transposition[i.cellId] = t);
};
n.prototype._checkChangeOfPosition = function (e, t, i, n, o) {
  o = o || {};
  for (var a = m.gui.damagePreview.damagePreviewManager.transposition, s = u.getActorOnCell(n), l = o.isCriticalEffect ? e.getEffectInstances().criticalEffects : e.getEffectInstances().effects, c = 0; c < l.length; c++) {
    var d = l[c];
    if (0 === d.order && d.isDirectEffect() && "I" === d.triggers && "P" === d.rawZone) {
      if (d.effectId === r.ACTION_CHARACTER_EXCHANGE_PLACES && s && u.verifySpellEffectMask(d, t, s.actorId, o)) {
        return a[i] = n, a[n] = i, !0;
      }
      if (d.effectId === r.ACTION_CHARACTER_TELEPORT_ON_SAME_MAP && !s) {
        return a[i] = n, !0;
      }
    }
  }
  return !1;
};
n.prototype._computeSpell = function (e, t, i, n, a, r) {
  a = a || {};
  var l = this,
    d = m.gui.fightManager,
    u = m.actorManager;
  if (!e) {
    return r(new Error("The casting spell does not exist"));
  }
  var h = this._callStacks[e + "-" + t] || 0;
  if (h > f) {
    return r(new Error("The spell " + e.id + " seems to be looped."));
  }
  if (this._callStacks[e + "-" + t] = ++h, !o(e, n)) {
    return r(null, []);
  }
  var p = e.getEffectInstances();
  (a.isCriticalEffect || !p.effects.length) && p.criticalEffects.length > 0 ? a.isCriticalEffect = !0 : a.isCriticalEffect = !1;
  var g = [];
  e.refreshCellZoneEffect(i, n);
  var _,
    v,
    y,
    w = d.getAvailableFighters();
  for (_ in w) {
    if (w.hasOwnProperty(_)) {
      _ = parseInt(_, 10);
      var b = u.getActor(_);
      if (b && !b.isDead && !b.isInvisibleInFight()) {
        var M = this._getLifeLostFromFighter(t),
          T = this._getLifeLostFromFighter(_);
        g[_] = new c(e, i, n, t, _, {
          isCriticalEffect: a.isCriticalEffect,
          isGlyph: a.isGlyph,
          isTrap: a.isTrap,
          comboBonus: a.comboBonus,
          casterLifeLost: M,
          targetLifeLost: T,
          statsBonus: a.statsBonus,
          specificTarget: a.specificTarget,
          triggeredBy: a.triggeredBy
        });
      }
    }
  }
  this._checkChangeOfPosition(e, t, i, n, a) && (i = this.getVirtualCellFromRealCell(i));
  var C = g[t];
  if (!C) {
    return r(new Error("Unable to preview the spell as the caster " + t + " is dead"));
  }
  for (var I = this.getPushedEntities(e, t, i, n, a), A = 0; A < I.length; A++) {
    var S = I[A];
    v = g[S.id];
    v && v.pushedEntities.push(S);
  }
  for (_ in g) {
    g.hasOwnProperty(_) && g[_].addSplashDamages(this._allSpellDamageInfo[t]);
  }
  var E = [],
    N = [];
  for (_ in g) {
    g.hasOwnProperty(_) && g[_].addSharedDamages(E, N);
  }
  for (_ in g) {
    g.hasOwnProperty(_) && g[_].computeSpellDamage();
  }
  for (_ in g) {
    g.hasOwnProperty(_) && (y = g[_], C.addCounteredDamagesReceived(y.counteredDamagesGiven));
  }
  Object.keys(C.counteredDamagesReceived).length && C.computeSpellDamage();
  var x = [];
  for (_ in g) {
    if (g.hasOwnProperty(_)) {
      y = g[_];
      C.addLifeStealingDamagesReceived(y.lifeStealingDamagesGiven);
      var L = y.damagesOutputTo;
      0 !== L && (v = g[L], v && (v.addInterceptionDamages(y.damagesOutput), x[L] = !0));
    }
  }
  Object.keys(C.lifeStealingDamagesReceived).length && (x[t] = !0);
  for (_ in x) {
    g.hasOwnProperty(_) && g[_].computeSpellDamage();
  }
  for (_ in g) {
    g.hasOwnProperty(_) && (this._allSpellDamageInfo[_] = this._allSpellDamageInfo[_] || [], this._allSpellDamageInfo[_].push(g[_]));
  }
  s.series([function (e) {
    s.eachSeries(Object.keys(g), function (e, i) {
      l._triggeredSpellByBuffs(g[e], t, a, i);
    }, function (t) {
      return l._refreshPositions(I), e(t);
    });
  }, function (e) {
    s.eachSeries(Object.keys(g), function (e, i) {
      l._bombSpells(g[e], t, a, i);
    }, e);
  }, function (e) {
    s.eachSeries(Object.keys(g), function (e, i) {
      l._trapSpells(g[e], t, a, i);
    }, e);
  }, function (e) {
    s.eachSeries(Object.keys(g), function (e, i) {
      l._triggeredSpellsByCaster(g[e], t, a, i);
    }, e);
  }, function (e) {
    l._glyphSpellsFromMarks(C, t, i, a, e);
  }, function (e) {
    return a.fromMark ? l._triggeredSpellsByGlyphs(C, t, i, n, a, e) : e();
  }], function (e) {
    return r(e);
  });
};
n.prototype._triggeredSpellByBuffs = function (e, t, i, n) {
  var o = this;
  e.getTargetTriggeredSpellsByBuffs(this._buffsWithSpellsTriggered, function (e, a) {
    return !e && a ? s.eachSeries(a, function (e, n) {
      var a = e.casterId === t ? i.statsBonus : null;
      o._computeSpell(e.spell, e.casterId, e.casterCellId, e.targetCellId, {
        triggeredBy: t,
        isCriticalEffect: i.isCriticalEffect,
        statsBonus: a
      }, n);
    }, n) : n(e);
  });
};
n.prototype._bombSpells = function (e, t, i, n) {
  var o = this;
  e.getBombSpells(function (e, a) {
    return !e && a ? s.eachSeries(a, function (e, n) {
      var a = e.spell.ownerId === t ? i.statsBonus : null;
      o._computeSpell(e.spell, e.spell.ownerId, e.casterCellId, e.targetCellId, {
        comboBonus: e.comboBonus,
        statsBonus: a,
        specificTarget: e.target
      }, n);
    }, n) : n(e);
  });
};
n.prototype._trapSpells = function (e, t, i, n) {
  var o = this;
  e.getTrapSpells(function (e, a) {
    return !e && a ? s.eachSeries(a, function (e, n) {
      var a = e.spell.ownerId === t ? i.statsBonus : null;
      o._computeSpell(e.spell, e.spell.ownerId, e.casterCellId, e.targetCellId, {
        specificTarget: e.target,
        isTrap: !0,
        statsBonus: a
      }, n);
    }, n) : n(e);
  });
};
n.prototype._triggeredSpellsByCaster = function (e, t, i, n) {
  var o = this;
  e.getTriggeredSpellsByCasterOnTarget(function (e, a) {
    return !e && a ? s.eachSeries(a, function (e, n) {
      var a = e.casterId === t ? i.statsBonus : null;
      o._computeSpell(e.spell, e.casterId, e.casterCellId, e.targetCellId, {
        isGlyph: i.isGlyph,
        isCriticalEffect: i.isCriticalEffect,
        statsBonus: a
      }, n);
    }, n) : n(e);
  });
};
n.prototype._glyphSpellsFromMarks = function (e, t, i, n, o) {
  var a = this;
  e.getGlyphSpellsFromMarks(function (e, r) {
    return !e && r ? s.eachSeries(r, function (e, o) {
      var s = e.casterId === t ? n.statsBonus : null;
      a._computeSpell(e.spell, e.casterId, i, e.targetCellId, {
        fromMark: !0,
        statsBonus: s
      }, o);
    }, o) : o(e);
  });
};
n.prototype._triggeredSpellsByGlyphs = function (e, t, i, n, o, a) {
  var r = this;
  e.getTriggeredSpellsByGlyphs(function (e, l) {
    return !e && l ? s.eachSeries(l, function (e, a) {
      r._computeSpell(e.spell, t, i, n, {
        isGlyph: !0,
        statsBonus: o.statsBonus
      }, a);
    }, a) : a(e);
  });
};
n.prototype._getLifeLostFromFighter = function (e) {
  var t = new h();
  if (this._allSpellDamageInfo[e]) {
    for (var i = 0; i < this._allSpellDamageInfo[e].length; i++) {
      var n = this._allSpellDamageInfo[e][i].finalSpellDamage.damage;
      n && (t.min += n.min, t.max += n.max, t.minCritical += n.minCritical, t.maxCritical += n.maxCritical);
    }
  }
  return t;
};
n.prototype.createSpells = function (e, t) {
  var i = this,
    n = {};
  s.each(e, function (e, t) {
    return i._spellCache[e] ? (n[e] = i._spellCache[e].clone(), t()) : void l.createSpells([e], function (o, a) {
      return o ? t(o) : (n[e] = i._spellCache[e] = a[e], t());
    });
  }, function (e) {
    return e ? t(e) : t(null, n);
  });
};
n.prototype.hasAlreadyBeenAffectedByMark = function (e, t) {
  var i = m.background.zones,
    n = a(e),
    o = this._alreadyUsedMark[n],
    s = this._temporaryUsedMark[n];
  if (!t) {
    return o || s;
  }
  if (o) {
    return o[t];
  }
  if (s) {
    return s[t];
  }
  var r = m.actorManager.getActor(t);
  if (!r) {
    return !1;
  }
  for (var l = 0; l < i.length; l++) {
    var c = i[l],
      u = c.data;
    if (u) {
      var h = a(u);
      if (h === n && u.markCell === r.cellId && u.type === d.MARK.BOMB) {
        return !0;
      }
    }
  }
  return !1;
};
n.prototype.confirmAffectedMark = function () {
  for (var e in this._temporaryUsedMark) {
    if (this._temporaryUsedMark.hasOwnProperty(e)) {
      this._alreadyUsedMark[e] || (this._alreadyUsedMark[e] = []);
      for (var t in this._temporaryUsedMark[e]) {
        this._temporaryUsedMark[e].hasOwnProperty(t) && (this._alreadyUsedMark[e][t] = !0);
      }
    }
  }
  this.resetTemporaryMark();
};
n.prototype.affectedByMark = function (e, t) {
  var i = a(t);
  this._temporaryUsedMark[i] || (this._temporaryUsedMark[i] = []);
  this._temporaryUsedMark[i][e] = !0;
};
n.prototype.resetTemporaryMark = function () {
  this._temporaryUsedMark = [];
};
n.prototype.resetMark = function () {
  this._alreadyUsedMark = [];
};
n.prototype.getVirtualCellFromRealCell = function (e) {
  return this.transposition[e] || e;
};
n.prototype.getCell = function (e) {
  for (var t in this.transposition) {
    if (this.transposition.hasOwnProperty(t) && (t = parseInt(t, 10), this.transposition[t] === e)) {
      return t;
    }
  }
  return this.getVirtualCellFromRealCell(e);
};
this._callStacks = [];
this._allSpellDamageInfo = [];
this._buffsWithSpellsTriggered = [];
this.transposition = [];
this.triggeredStates = [];
n._temporaryUsedMark = [];
n._resetData();
n._computeSpell(a, s, r, t, {
  isCriticalEffect: !0,
  statsBonus: {}
}, function (e) {
  if (a.resetCellZoneEffect(), e) {
    return i(e);
  }
  var t = n._allSpellDamageInfo;
  n._temporaryUsedMark = l;
  var s = u.getDamageData(o, t);
  return i(null, s);
});
v = g[S.id];
v && v.pushedEntities.push(S);
y = g[_];
C.addLifeStealingDamagesReceived(y.lifeStealingDamagesGiven);
this._temporaryUsedMark[i] || (this._temporaryUsedMark[i] = []);
this._temporaryUsedMark[i][e] = !0;
e.exports = i(882);
i(892);
i(893);
i(894);
this._initVariables();
this._retrieveData(e, t, i, n, o, a);
t[o] || (t[o] = []);
t[o].push(n);
e.exports = n;
n.prototype._initVariables = function () {
  this.caster = null;
  this.target = null;
  this.effectMaskOptions = {};
  this.triggeredBy = 0;
  this.isCriticalEffect = !1;
  this.isGlyph = !1;
  this.isTrap = !1;
  this.spellLevel = 1;
  this.spellCenterCellId = 0;
  this.spellWeaponCriticalBonus = 0;
  this.spellTargetEffectsDurationReduction = 0;
  this.maximizeEffect = !1;
  this.minimizeEffect = !1;
  this.baseDamages = [];
  this.pushedEntities = [];
  this.splashDamages = [];
  this.lifeStealingDamagesGiven = [];
  this.lifeStealingDamagesReceived = [];
  this.sharedDamages = [];
  this.sharedFighters = [];
  this.damagesOutputTo = 0;
  this.damagesOutput = [];
  this.damagesInput = [];
  this.counteredDamagesGiven = [];
  this.counteredDamagesReceived = [];
  this.isAccurate = !0;
  this.finalSpellDamage = null;
  this.finalSpellDamageWithoutBuff = null;
};
n.prototype._retrieveData = function (e, t, i, n, o, a) {
  var s = window.gui,
    r = window.actorManager;
  if (!s.playerData.isFighting) {
    return console.warn("We are not in a fight");
  }
  var l = r.getActor(o);
  if (!l) {
    return console.warn("Actor " + o + " does not exist");
  }
  var d = r.getActor(n);
  if (!d) {
    return console.warn("Actor " + n + " does not exist");
  }
  var u = l.getFighter();
  if (!u) {
    return console.warn("Fighter " + o + " does not exist");
  }
  var h = d.getFighter();
  if (!h) {
    return console.warn("Fighter " + n + " does not exist");
  }
  if (this.spellId = e.id, this.spellLevel = e.level, this.isCriticalEffect = a.isCriticalEffect, this.spellCenterCellId = i, this.triggeredBy = a.triggeredBy, this.isGlyph = a.isGlyph, this.isTrap = a.isTrap, this.isWeapon = e.isItem, this.effectMaskOptions = {
    triggeredBy: a.triggeredBy
  }, this.caster = new c(n, a.statsBonus), this.target = new c(o, {}), this.caster.retrieveStats(), this.target.retrieveStats(), this.isAccurate = this.caster.isAccurate, this.caster.comboBonus = a.comboBonus || 0, this.caster.cellId = t, a.casterLifeLost && (this.caster.lifeLost = a.casterLifeLost), a.targetLifeLost && (this.target.lifeLost = a.targetLifeLost), this.effectInstances = this.isCriticalEffect ? e.getEffectInstances().criticalEffects : e.getEffectInstances().effects, this.isWeapon && this.isCriticalEffect) {
    var p = s.playerData.inventory.getCurrentWeapon();
    this.spellWeaponCriticalBonus = p.item.criticalHitBonus;
  }
  (!a.specificTarget || a.specificTarget === this.target.id || r.getActorsOnCell(l.cellId).length <= 1) && this._computeBaseDamage(e);
  this._manageCasterBuffs();
  this._manageTargetBuffs();
  for (var m in this.baseDamages) {
    if (this.baseDamages.hasOwnProperty(m)) {
      var f = this.baseDamages[m];
      this.maximizeEffect ? (f.damage.min = f.damage.max, f.erosionPercent.min = f.erosionPercent.max, f.lifePointsAdded.min = f.lifePointsAdded.max) : this.minimizeEffect && (f.damage.max = f.damage.min, f.erosionPercent.max = f.erosionPercent.min, f.lifePointsAdded.max = f.lifePointsAdded.min);
    }
  }
};
n.prototype._computeBaseDamage = function (e) {
  function t(t) {
    return ~~u[l.BUFF_EFFECT_TO_STAT_EFFECT[t]] >= e.spellLevel.maxStack && e.spellLevel.maxStack !== -1;
  }
  var i = window.gui,
    n = i.fightManager.getFighter(this.caster.id);
  if (!n) {
    return console.warn("Fighter " + this.caster.id + " does not exist"), !1;
  }
  var o = i.fightManager.getFighter(this.target.id);
  if (!o) {
    return console.warn("Fighter " + this.target.id + " does not exist"), !1;
  }
  var c,
    u = {};
  for (c = 0; c < this.caster.buffs.length; c++) {
    var h = this.caster.buffs[c],
      p = h.castingSpell && h.castingSpell.spell && h.castingSpell.spell.id;
    h.statName && h.source === this.caster.id && p === e.id && (u[h.actionId] = (u[h.actionId] || 0) + h.stack.length);
  }
  var m,
    f,
    g,
    _ = a(this.caster.id, this.target.id, this.effectInstances);
  for (c = 0; c < this.effectInstances.length; c++) {
    var v = this.effectInstances[c],
      y = s.isInZoneEffect(v, this.target.cellId),
      w = s.getElementEffect(this.caster, v.effect);
    if (f = this.caster.id + "-" + this.spellId + "-" + c + "-" + v.targetMask + "-" + v.effectId, v.isDirectEffect() && y && (!this.isWeapon || this.caster.id !== this.target.id) && (0 === this.spellId || s.verifySpellEffectMask(v, this.caster.id, this.target.id, this.effectMaskOptions))) {
      var b = s.getShapeEfficiency(this.isWeapon ? i.playerData.inventory.getCurrentWeapon().item.type.rawZone : v.rawZone, this.spellCenterCellId, this.target.cellId);
      if (v.isDamageEffect() && !s.isHealingEffect(v) && w !== -1) {
        this.baseDamages[f] = new r(f, v.effectId, w, v.random || -1);
        m = this.baseDamages[f];
        m.efficiencyMultiplier = b;
        this.caster.id === this.target.id && "C" === v.targetMask && "I" === v.triggers && (m.efficiencyMultiplier = 1);
        var M = l.EFFECTS_IDS.TARGET_EROSION_DAMAGE[v.effectId],
          T = l.EFFECTS_IDS.CASTER_EROSION_DAMAGE[v.effectId];
        M || T ? (m.type = l.TYPE.EROSION, m.erosionLifePoints = M ? this.target.erosionLifePoints : this.caster.erosionLifePoints, m.erosionPercent.normal = v.diceNum) : (g = s.getMinMaxDamageFromRawEffect(v), this.isGlyph ? m.origin = l.ORIGIN.GLYPH : this.isTrap && (m.origin = l.ORIGIN.TRAP), m.damage.min = g.min + this.spellWeaponCriticalBonus, m.damage.max = g.max + this.spellWeaponCriticalBonus);
      } else if (s.isHealingEffect(v)) {
        this.baseDamages[f] = new r(f, v.effectId, -1, v.random);
        m = this.baseDamages[f];
        m.efficiencyMultiplier = b;
        m.type = l.TYPE.HEAL;
        var C = n.data.stats.lifePoints,
          I = o.data.stats.maxLifePoints;
        v.effectId === d.ACTION_CHARACTER_DISPATCH_LIFE_POINTS_PERCENT ? this.target.id !== this.caster.id ? m.lifePointsAddedBasedOnLifePercent.normal = v.diceNum * C / 100 : (m.type = l.TYPE.FIXED, m.damage.normal = v.diceNum * C / 100) : v.effectId === d.ACTION_FIGHT_LIFE_POINTS_WIN_PERCENT ? m.lifePointsAddedBasedOnLifePercent.normal = v.diceNum * I / 100 : (g = s.getMinMaxDamageFromRawEffect(v), m.lifePointsAdded.min = g.min + this.spellWeaponCriticalBonus, m.lifePointsAdded.max = g.max + this.spellWeaponCriticalBonus);
      } else if (l.EFFECT_ADD_STATS_PROPERTY[v.effectId] && v.order < _ && !t(v.effectId)) {
        var A;
        A = this.isCriticalEffect ? l.EFFECT_ADD_STATS_PROPERTY_CRITICAL[v.effectId] : l.EFFECT_ADD_STATS_PROPERTY[v.effectId];
        this.caster.newStatsBonus[A] = this.caster.newStatsBonus[A] || 0;
        this.caster.newStatsBonus[A] += v.diceNum;
      }
      v.effectId === d.ACTION_CHARACTER_SHORTEN_ACTIVE_EFFECTS_DURATION && (_ === -1 || v.order < _) && (this.spellTargetEffectsDurationReduction = v.diceNum);
    }
  }
  for (f in this.baseDamages) {
    this.baseDamages.hasOwnProperty(f) && (m = this.baseDamages[f], this.caster.id === i.playerData.characters.controlledCharacterId && s.applySpellModificationsOnEffect(m, e));
  }
};
n.prototype._manageCasterBuffs = function () {
  var e = o(this.caster.buffs);
  for (var t in e) {
    if (e.hasOwnProperty(t)) {
      for (var i = e[t], n = 0; n < i.length; n++) {
        var a = i[n];
        if (a.effect.effect.category === l.DAMAGE_EFFECT_CATEGORY) {
          var c = a.effect;
          if (a.castingSpell.spell.id === this.spellId) {
            for (var u = 0; u < this.effectInstances.length; u++) {
              if (this.effectInstances[u].effectId === a.effect.effectId) {
                c = this.effectInstances[u];
                break;
              }
            }
          }
          if (!s.verifySpellEffectMask(c, this.caster.id, this.target.id, this.effectMaskOptions) || !this.verifyBuffTrigger(a) || this.caster.id === this.target.id) {
            continue;
          }
          var h = s.getElementEffect(this.caster, c.effect),
            p = "buff-" + this.caster.id + "-" + a.castingSpell.spell.id + "-" + c.targetMask + "-" + c.effectId;
          this.baseDamages[p] = new r(p, c.effectId, h, c.random);
          this.baseDamages[p].type = l.TYPE.BUFF;
          var m = s.getMinMaxDamageFromRawEffect(c);
          this.baseDamages[p].damage.min = m.min;
          this.baseDamages[p].damage.max = m.max;
          this.baseDamages[p].efficiencyMultiplier = s.getShapeEfficiency(c.rawZone, this.target.cellId, this.target.cellId);
        } else {
          l.BUFF_ADD_DAMAGES[a.actionId] ? this.caster[l.BUFF_ADD_DAMAGES[a.actionId]] += a.getParam1() : a.actionId === d.ACTION_CHARACTER_UNLUCKY ? this.minimizeEffect = !0 : a.actionId === d.ACTION_CHARACTER_BOOST_PERMANENT_DAMAGE_PERCENT && (this.caster.erosionPercentBonus += a.getParam1());
        }
      }
    }
  }
};
n.prototype._manageTargetBuffs = function () {
  for (var e = 0; e < this.target.buffs.length; e++) {
    var t = this.target.buffs[e];
    if (!t.trigger && t.effect.effectId === d.ACTION_FIGHT_DISABLE_STATE) {
      switch (t.effect.getParams()[0]) {
        case u.STATE_INVULNERABLE:
        case u.STATE_INVULNERABLE_COPY:
          this.target.isInvulnerable = !1;
          break;
        case u.STATE_INCURABLE:
          this.target.isUnhealable = !1;
      }
    }
    t.actionId === d.ACTION_CHARACTER_MAXIMIZE_ROLL && (this.maximizeEffect = !0);
    var i = t.getParam1();
    i && t.actionId === d.ACTION_CHARACTER_BOOST_PERMANENT_DAMAGE_PERCENT && (this.target.erosionPercentBonus += i);
  }
};
n.prototype.computeSpellDamage = function () {
  this.finalSpellDamageWithoutBuff = this.getSpellDamage();
  this.finalSpellDamage = this.getSpellDamage({
    withTargetBuffs: !0
  });
};
this.caster = null;
this.target = null;
this.effectMaskOptions = {};
this.triggeredBy = 0;
this.isCriticalEffect = !1;
this.isGlyph = !1;
this.isTrap = !1;
this.spellLevel = 1;
this.spellCenterCellId = 0;
this.spellWeaponCriticalBonus = 0;
this.spellTargetEffectsDurationReduction = 0;
this.maximizeEffect = !1;
this.minimizeEffect = !1;
this.baseDamages = [];
this.pushedEntities = [];
this.splashDamages = [];
this.lifeStealingDamagesGiven = [];
this.lifeStealingDamagesReceived = [];
this.sharedDamages = [];
this.sharedFighters = [];
this.damagesOutputTo = 0;
this.damagesOutput = [];
this.damagesInput = [];
this.counteredDamagesGiven = [];
this.counteredDamagesReceived = [];
this.isAccurate = !0;
this.finalSpellDamage = null;
this.finalSpellDamageWithoutBuff = null;
(!a.specificTarget || a.specificTarget === this.target.id || r.getActorsOnCell(l.cellId).length <= 1) && this._computeBaseDamage(e);
this._manageCasterBuffs();
this._manageTargetBuffs();
this.baseDamages[f] = new r(f, v.effectId, w, v.random || -1);
m = this.baseDamages[f];
m.efficiencyMultiplier = b;
this.caster.id === this.target.id && "C" === v.targetMask && "I" === v.triggers && (m.efficiencyMultiplier = 1);
this.baseDamages[f] = new r(f, v.effectId, -1, v.random);
m = this.baseDamages[f];
m.efficiencyMultiplier = b;
m.type = l.TYPE.HEAL;
A = this.isCriticalEffect ? l.EFFECT_ADD_STATS_PROPERTY_CRITICAL[v.effectId] : l.EFFECT_ADD_STATS_PROPERTY[v.effectId];
this.caster.newStatsBonus[A] = this.caster.newStatsBonus[A] || 0;
this.caster.newStatsBonus[A] += v.diceNum;
this.baseDamages[p] = new r(p, c.effectId, h, c.random);
this.baseDamages[p].type = l.TYPE.BUFF;
this.baseDamages[p].damage.min = m.min;
this.baseDamages[p].damage.max = m.max;
this.baseDamages[p].efficiencyMultiplier = s.getShapeEfficiency(c.rawZone, this.target.cellId, this.target.cellId);
this.finalSpellDamageWithoutBuff = this.getSpellDamage();
this.finalSpellDamage = this.getSpellDamage({
  withTargetBuffs: !0
});
t.getActorOnCell = function (e) {
  var t = y.gui.damagePreview.damagePreviewManager,
    i = t.getCell(e),
    n = y.actorManager.getActorsOnCell(i)[0];
  return !n || n.isInvisibleInFight() ? null : n;
};
t.isInGlyph = function (e, t, i) {
  for (var n = y.background.zones, o = 0; o < n.length; o++) {
    var a = n[o];
    if (a.data.type === u.MARK.GLYPH && a.data.sourceId === e && a.data.spellId === t) {
      if (a.data.markSize > 0) {
        return a.data.markSize >= s.getDistance(i, a.data.markCell);
      }
      if (i === a.data.markCell) {
        return !0;
      }
    }
  }
  return !1;
};
t.isBombOf = function (e, t, i) {
  if (!e) {
    return null;
  }
  var n = e.getFighter();
  return n && e.data.creatureGenericId === t && n.data.stats.summoner === i;
};
t.getBombFromWall = function (e, i, n) {
  function a(i, o) {
    for (var a = 0; a < u.WALL_MAX_SIZE; a++) {
      if (i = r.getNearestCellInDirection(i, o), !i) {
        return null;
      }
      var s = t.getActorOnCell(i.cellId);
      if (t.isBombOf(s, n, e)) {
        return s.actorId;
      }
    }
    return null;
  }
  for (var s = r.fromCellId(i), l = y.background.zones, c = [], d = 0; d < l.length; d++) {
    var h = l[d];
    h.data && h.data.markCell && h.data.type === u.MARK.BOMB && (c[h.data.markCell] = h.data);
  }
  if (!o(c[i], n, e)) {
    return null;
  }
  var m = a(s, p.DIRECTION_SOUTH_EAST),
    f = a(s, p.DIRECTION_NORTH_WEST),
    g = a(s, p.DIRECTION_SOUTH_WEST),
    _ = a(s, p.DIRECTION_NORTH_EAST);
  return m && f ? m : g && _ ? g : null;
};
t.getChainReactionBomb = function (e, i) {
  function a(t) {
    for (var i in c.actors) {
      if (c.actors.hasOwnProperty(i)) {
        i = parseInt(i, 10);
        var n = c.actors[i],
          o = n.getFighter(),
          d = s.getDistance(t.cellId, n.cellId);
        !o.isBomb || d > u.BOMB_ZONE_SIZE || o.data.stats.summoner !== e || h.indexOf(i) !== -1 || (h.push(i), a(n), l(r.fromCellId(n.cellId), -1, n.data.creatureGenericId));
      }
    }
  }
  function l(i, s, c) {
    if (i) {
      var d = f[i.cellId];
      s !== -1 && (o(d, c, e) || n(i.cellId)) && l(r.getNearestCellInDirection(i, s), s, c);
      var u = t.getActorOnCell(i.cellId);
      t.isBombOf(u, c, e) && (h.indexOf(u.actorId) === -1 && (h.push(u.actorId), a(u)), s !== p.DIRECTION_NORTH_WEST && l(r.getNearestCellInDirection(i, p.DIRECTION_SOUTH_EAST), p.DIRECTION_SOUTH_EAST, c), s !== p.DIRECTION_NORTH_EAST && l(r.getNearestCellInDirection(i, p.DIRECTION_SOUTH_WEST), p.DIRECTION_SOUTH_WEST, c), s !== p.DIRECTION_SOUTH_EAST && l(r.getNearestCellInDirection(i, p.DIRECTION_NORTH_WEST), p.DIRECTION_NORTH_WEST, c), s !== p.DIRECTION_SOUTH_WEST && l(r.getNearestCellInDirection(i, p.DIRECTION_NORTH_EAST), p.DIRECTION_NORTH_EAST, c));
    }
  }
  var c = y.actorManager,
    d = y.background.zones,
    h = [],
    m = c.getActor(i);
  if (!m) {
    return h;
  }
  for (var f = [], g = 0; g < d.length; g++) {
    var _ = d[g];
    _.data && _.data.markCell && _.data.type === u.MARK.BOMB && (f[_.data.markCell] = _.data);
  }
  return a(m), h;
};
t.getComboCoeffBomb = function (e, t) {
  for (var i = y.actorManager, n = 0, o = 0; o < e.length; o++) {
    var a = i.getActor(e[o]);
    if (a && (!t || a.data.creatureGenericId === t)) {
      for (var s = a.getFighter(), r = 0; r < s.buffs.length; r++) {
        var l = s.buffs[r];
        l instanceof v && l.actionId === c.ACTION_BOMB_COMBO_BONUS && (n += l.effect.diceNum);
      }
    }
  }
  return n;
};
t.getBuffMinMaxDamageFromRawEffect = function (e) {
  return e.diceNum && e.diceNum > 0 ? {
    min: e.value + e.diceNum,
    max: e.value + e.diceSide
  } : e.min && e.max ? {
    min: e.min,
    max: e.max
  } : e.value && e.value > 0 ? {
    min: e.value,
    max: e.value
  } : {
    min: 0,
    max: 0
  };
};
t.getMinMaxDamageFromRawEffect = function (e) {
  return e.diceNum && e.diceNum > 0 ? {
    min: e.diceNum,
    max: 0 === e.diceSide ? e.diceNum : e.diceSide
  } : e.min && e.max ? {
    min: e.min,
    max: e.max
  } : e.value && e.value > 0 ? {
    min: e.value,
    max: e.value
  } : {
    min: 0,
    max: 0
  };
};
t.applySpellModificationsOnEffect = function (e, t) {
  var i = y.gui.playerData.characters.controlledCharacterId,
    n = y.gui.playerData.characters.getSpellModifications(i, t.id, m.BASE_DAMAGE);
  if (n) {
    var o = n.value.getTotalStat();
    e.damage.min += e.damage.min > 0 ? o : 0;
    e.damage.max += e.damage.max > 0 ? o : 0;
  }
};
t.verifySpellEffectMask = function (e, t, i, n) {
  n = n || {};
  var o = y.gui,
    a = o.damagePreview.damagePreviewManager,
    s = y.actorManager.getActor(t),
    r = y.actorManager.getActor(i);
  if (!s || !r) {
    return !1;
  }
  var l = s.getFighter(),
    d = r.getFighter();
  if (!l || !d) {
    return !1;
  }
  var u = i === t,
    h = d.data.teamId === l.data.teamId,
    p = d.data.isCarryied,
    m = l.states.concat(a.triggeredStates[t]),
    f = d.states.concat(a.triggeredStates[i]),
    g = i === t || (0 !== d.data.stats.summoner || 0 !== l.data.stats.summoner) && (d.data.stats.summoner === l.data.stats.summoner || d.data.stats.summoner === t || l.data.stats.summoner === i);
  if (!e.targetMask || t === i && 0 === e.effect.category && "C" === e.targetMask) {
    return !0;
  }
  var _ = "";
  if (u) {
    if (e.effectId === c.ACTION_CHARACTER_DISPATCH_LIFE_POINTS_PERCENT) {
      return !0;
    }
    if (e.targetMask.indexOf("g") !== -1) {
      return !1;
    }
    _ = "caC";
  } else {
    if (p && e.rawZone.indexOf("A") !== -1 && e.rawZone.indexOf("a") !== -1) {
      return !1;
    }
    _ = d.isSummon() && 0 === d.data.stats.maxMovementPoints ? h ? "agsj" : "ASJ" : d.isSummon() ? h ? "agij" : "AIJ" : "GameFightCompanionInformations" === d.data._type ? h ? "agdl" : "ADL" : "GameFightMonsterInformations" === d.data._type ? h ? "agm" : "AM" : h ? "gahl" : "AHL";
  }
  var v = e.targetMask.match(new RegExp("[" + _ + "]", "g"));
  if (!v || !v.length) {
    return !1;
  }
  var b = e.targetMask.match(w);
  if (!b || !b.length) {
    return !0;
  }
  for (var M = !1, T = [], C = 0; C < b.length; C++) {
    var I = b[C],
      A = !1;
    "*" === I.charAt(0) && (A = !0, I = I.substr(1));
    var S = I.charAt(0),
      E = I.substr(1),
      N = ~~E;
    switch (S) {
      case "e":
        M = A ? !m || m.indexOf(N) === -1 : !f || f.indexOf(N) === -1;
        break;
      case "E":
        M = !0;
        A ? T.E = T.E || m && m.indexOf(N) !== -1 : T.E = T.E || f && f.indexOf(N) !== -1;
        break;
      case "f":
        M = !r.data.creatureGenericId || r.data.creatureGenericId !== ~~E;
        break;
      case "F":
        M = !0;
        T.F = T.F || r.data.creatureGenericId === ~~E;
        break;
      case "o":
      case "O":
        M = n.triggeredBy === i;
        break;
      case "p":
        M = !g;
        break;
      case "P":
        M = g;
        break;
      case "v":
        M = d.data.stats.lifePoints / d.data.stats.maxLifePoints * 100 > ~~E;
        break;
      case "V":
        M = d.data.stats.lifePoints / d.data.stats.maxLifePoints * 100 <= ~~E;
    }
    if (!M) {
      return !1;
    }
  }
  for (var x in T) {
    if (!T.hasOwnProperty(x) || !T[x]) {
      return !1;
    }
  }
  return !0;
};
t.isHealingEffect = function (e) {
  return e && u.EFFECTS_IDS.HEALING[e.effectId];
};
t.isLifeStealingEffect = function (e) {
  return e && u.EFFECTS_IDS.STEALING[e.effectId];
};
t.getShapeEfficiency = function (e, t, i) {
  if (!e) {
    return 0;
  }
  var n = l.parseZone(e),
    o = e.charAt(0),
    r = n.zoneSize || u.EFFECTSHAPE_DEFAULT.AREA_SIZE,
    c = n.zoneMinSize || u.EFFECTSHAPE_DEFAULT.MIN_AREA_SIZE,
    d = n.zoneEfficiencyPercent || u.EFFECTSHAPE_DEFAULT.EFFICIENCY,
    p = n.zoneMaxEfficiency || u.EFFECTSHAPE_DEFAULT.MAX_EFFICIENCY_APPLY,
    m = 0;
  switch (o) {
    case h.A:
    case h.a:
    case h.Z:
    case h.I:
    case h.O:
    case h.semicolon:
    case h.empty:
    case h.P:
      return u.DAMAGE_NOT_BOOSTED;
    case h.B:
    case h.V:
    case h.G:
    case h.W:
      m = s.getSquareDistance(t, i);
      break;
    case h.minus:
    case h.plus:
    case h.U:
      m = s.getDistance(t, i) / 2;
      break;
    default:
      m = s.getDistance(t, i);
  }
  return a(m, r, c, d, p);
};
t.isInZoneEffect = function (e, t) {
  if (!e) {
    return !1;
  }
  var i = "a" === e.rawZone || "A" === e.rawZone,
    n = e.targetMask && (e.targetMask.indexOf("O") !== -1 || e.targetMask.indexOf("C") !== -1);
  return i || n || e.isInZoneEffect(t);
};
t.getElementEffect = function (e, t) {
  var i = y.gui.databases.TypeActions;
  if (!t || !e) {
    return -1;
  }
  var n = [];
  n[_.EARTH] = e.strength + e.strengthBonus;
  n[_.FIRE] = e.intelligence + e.intelligenceBonus;
  n[_.WATER] = e.chance + e.chanceBonus;
  n[_.AIR] = e.agility + e.agilityBonus;
  var o = [];
  o[_.EARTH] = e.earthDamageBonus;
  o[_.FIRE] = e.fireDamageBonus;
  o[_.WATER] = e.waterDamageBonus;
  o[_.AIR] = e.airDamageBonus;
  for (var a = _.EARTH, s = 2; s < 5; s++) {
    n[a] === n[s] && o[a] < o[s] ? a = s : n[a] < n[s] && (a = s);
  }
  if (u.EFFECTS_IDS.BEST_ELEMENT[t.id]) {
    return a;
  }
  var r = i[t.id];
  return r ? r.elementId : -1;
};
t.getDamageData = function (e, t) {
  function i(e, i) {
    for (var n in e) {
      if (t.hasOwnProperty(n)) {
        var a = o[n] || new d();
        o[n] = a;
        for (var s = 0; s < e[n].length; s++) {
          var r = e[n][s];
          a.isAccurate = a.isAccurate && (!r.finalSpellDamage.doesDamageOrHeal() || r.isAccurate);
          a.invulnerableState = a.invulnerableState || r.target.isInvulnerable;
          a.unhealableState = a.unhealableState || r.target.isUnhealable;
          for (var l = 0; l < r.finalSpellDamage.effectDamages.length; l++) {
            var c = r.finalSpellDamage.effectDamages[l];
            i.critical ? (c.damage.convertToCritical(), c.lifePointsAdded.convertToCritical()) : (c.damage.resetCritical(), c.lifePointsAdded.resetCritical());
            var u = c.element + "," + c.random,
              h = a.getEffectDamageByNameId(u);
            h ? (h.damage.addFromDamage(c.damage), h.lifePointsAdded.addFromDamage(c.lifePointsAdded)) : (c.nameId = u, a.addEffectDamage(c));
          }
        }
      }
    }
  }
  var n = y.gui.fightManager,
    o = [];
  i(e, {
    critical: !1
  });
  i(t, {
    critical: !0
  });
  var a = [];
  for (var s in o) {
    if (o.hasOwnProperty(s)) {
      s = parseInt(s, 10);
      var r = o[s];
      r.updateDamage();
      var l = n.getFighter(s).data.stats,
        c = l.maxLifePoints - l.lifePoints,
        u = new f(c + r.damage.min, c + r.damage.max, c + r.damage.minCritical, c + r.damage.maxCritical);
      a[s] = r.toData(u);
    }
  }
  return a;
};
e.damage.min += e.damage.min > 0 ? o : 0;
e.damage.max += e.damage.max > 0 ? o : 0;
M = !0;
A ? T.E = T.E || m && m.indexOf(N) !== -1 : T.E = T.E || f && f.indexOf(N) !== -1;
M = !0;
T.F = T.F || r.data.creatureGenericId === ~~E;
n[_.EARTH] = e.strength + e.strengthBonus;
n[_.FIRE] = e.intelligence + e.intelligenceBonus;
n[_.WATER] = e.chance + e.chanceBonus;
n[_.AIR] = e.agility + e.agilityBonus;
o[_.EARTH] = e.earthDamageBonus;
o[_.FIRE] = e.fireDamageBonus;
o[_.WATER] = e.waterDamageBonus;
o[_.AIR] = e.airDamageBonus;
a.isAccurate = a.isAccurate && (!r.finalSpellDamage.doesDamageOrHeal() || r.isAccurate);
a.invulnerableState = a.invulnerableState || r.target.isInvulnerable;
a.unhealableState = a.unhealableState || r.target.isUnhealable;
i(e, {
  critical: !1
});
i(t, {
  critical: !0
});
r[n] = {
  x: t + e,
  y: i + e
};
n++;
r[n] = {
  x: t + e,
  y: i + e
};
n++;
n();
t.fromCellId = function (e) {
  var t = r[e];
  if (void 0 === t) {
    throw new Error("Cell identifier out of bounds");
  }
  return {
    cellId: e,
    x: t.x,
    y: t.y
  };
};
t.fromMapPoint = function (e) {
  return {
    cellId: e.cellId,
    x: e.x,
    y: e.y
  };
};
t.fromCoords = function (e, t) {
  var i = (e - t) * a + t + (e - t) / 2;
  return {
    cellId: ~~i,
    x: e,
    y: t
  };
};
t.getNearestCellInDirection = function (e, i) {
  var n;
  switch (i) {
    case 0:
      n = t.fromCoords(e.x + 1, e.y + 1);
      break;
    case 1:
      n = t.fromCoords(e.x + 1, e.y);
      break;
    case 2:
      n = t.fromCoords(e.x + 1, e.y - 1);
      break;
    case 3:
      n = t.fromCoords(e.x, e.y - 1);
      break;
    case 4:
      n = t.fromCoords(e.x - 1, e.y - 1);
      break;
    case 5:
      n = t.fromCoords(e.x - 1, e.y);
      break;
    case 6:
      n = t.fromCoords(e.x - 1, e.y + 1);
      break;
    case 7:
      n = t.fromCoords(e.x, e.y + 1);
  }
  return t.isInMap(n.x, n.y) ? n : null;
};
t.orientationTo = function (e, t) {
  if (t.x === e.x && t.y === e.y) {
    return 1;
  }
  var i = {
    x: e.x < t.x ? -1 : 0,
    y: e.y < t.y ? -1 : 0
  };
  i.x = e.x > t.x ? 1 : i.x;
  i.y = e.y > t.y ? 1 : i.y;
  var n;
  return 1 === i.x && 1 === i.y ? n = o.DIRECTION_EAST : 1 === i.x && 0 === i.y ? n = o.DIRECTION_SOUTH_EAST : 1 === i.x && i.y === -1 ? n = o.DIRECTION_SOUTH : 0 === i.x && i.y === -1 ? n = o.DIRECTION_SOUTH_WEST : i.x === -1 && i.y === -1 ? n = o.DIRECTION_WEST : i.x === -1 && 0 === i.y ? n = o.DIRECTION_NORTH_WEST : i.x === -1 && 1 === i.y ? n = o.DIRECTION_NORTH : 0 === i.x && 1 === i.y && (n = o.DIRECTION_NORTH_EAST), n;
};
t.advancedOrientationTo = function (e, t, i) {
  i = i || {};
  var n = !0;
  if (void 0 !== i.fourDir && null !== i.fourDir && (n = i.fourDir), !e || !t || e.cellId === t.cellId) {
    return 0;
  }
  var o = e.x - t.x,
    a = t.y - e.y,
    s = 180 * Math.acos(o / Math.sqrt(Math.pow(o, 2) + Math.pow(a, 2))) / Math.PI * (e.y > t.y ? -1 : 1);
  return s = n ? 2 * Math.round(s / 90) + 1 : Math.round(s / 45) + 1, s < 0 && (s += 8), s;
};
t.isInMap = function (e, t) {
  return e + t >= 0 && e - t >= 0 && e - t < 2 * s && e + t < 2 * a;
};
t.distanceToCell = function (e, t) {
  return Math.abs(e.x - t.x) + Math.abs(e.y - t.y);
};
i.x = e.x > t.x ? 1 : i.x;
i.y = e.y > t.y ? 1 : i.y;
this.invulnerableState = !1;
this.unhealableState = !1;
this.isAccurate = !0;
this.effectDamages = [];
this._initProperties();
e.exports = n;
n.prototype._initProperties = function () {
  this.damage = new c();
  this.lifePointsAdded = new c();
  this.lifePointsAddedBasedOnLifePercent = new c();
};
n.prototype.updateFromEffectDamage = function (e) {
  this.damage.addFromDamage(e.damage);
  this.lifePointsAdded.addFromDamage(e.lifePointsAdded);
  this.lifePointsAddedBasedOnLifePercent.addFromDamage(e.lifePointsAddedBasedOnLifePercent);
};
n.prototype.updateDamage = function () {
  this._initProperties();
  for (var e = new l(-1, -1, -1, -1), t = 0; t < this.effectDamages.length; t++) {
    var i = this.effectDamages[t];
    i.random > 0 ? (e.damage.min = e.damage.min > 0 ? Math.min(e.damage.min, i.damage.min) : i.damage.min, e.damage.max = Math.max(e.damage.max, i.damage.max), e.damage.minCritical = e.damage.minCritical > 0 ? Math.min(e.damage.minCritical, i.damage.minCritical) : i.damage.minCritical, e.damage.maxCritical = Math.max(e.damage.maxCritical, i.damage.maxCritical), e.lifePointsAdded.min = e.lifePointsAdded.min > 0 ? Math.min(e.lifePointsAdded.min, i.lifePointsAdded.min) : i.lifePointsAdded.min, e.lifePointsAdded.max = Math.max(e.lifePointsAdded.max, i.lifePointsAdded.max), e.lifePointsAdded.minCritical = e.lifePointsAdded.minCritical > 0 ? Math.min(e.lifePointsAdded.minCritical, i.lifePointsAdded.minCritical) : i.lifePointsAdded.minCritical, e.lifePointsAdded.maxCritical = Math.max(e.lifePointsAdded.maxCritical, i.lifePointsAdded.maxCritical), e.lifePointsAddedBasedOnLifePercent.normal = e.lifePointsAddedBasedOnLifePercent.normal > 0 ? Math.min(e.lifePointsAddedBasedOnLifePercent.normal, i.lifePointsAddedBasedOnLifePercent.normal) : i.lifePointsAddedBasedOnLifePercent.normal) : this.updateFromEffectDamage(i);
  }
  this.updateFromEffectDamage(e);
};
n.prototype.addEffectDamage = function (e) {
  e && this.effectDamages.push(e);
};
n.prototype.getEffectDamageByNameId = function (e) {
  for (var t = 0; t < this.effectDamages.length; t++) {
    if (this.effectDamages[t].nameId === e) {
      return this.effectDamages[t];
    }
  }
  return null;
};
n.prototype.doesDamageOrHeal = function () {
  return this.damage.min > 0 || this.damage.max > 0 || this.damage.minCritical > 0 || this.damage.maxCritical > 0 || this.lifePointsAdded.min > 0 || this.lifePointsAdded.max > 0 || this.lifePointsAdded.minCritical > 0 || this.lifePointsAdded.maxCritical > 0;
};
n.prototype.toData = function (e) {
  for (var t = [], i = new c(), n = null, l = !1, d = 0; d < this.effectDamages.length; d++) {
    var u = this.effectDamages[d];
    if (!this.invulnerableState && u.random > 0 && u.doesDamage() && t.push({
      color: o(u.element),
      content: this.getEffectString(u.damage, u.random)
    }), u.random <= 0) {
      var h = u.element;
      u.effectId === r.ACTION_CHARACTER_PUSH && (h = s.PUSH);
      h === -1 || h !== n && null !== n ? h !== -1 && h !== n && (n = -1) : n = h;
      i.min += u.damage.min;
      i.max += u.damage.max;
      i.minCritical += u.damage.minCritical;
      i.maxCritical += u.damage.maxCritical;
    }
    u.type !== a.TYPE.HEAL && (l = !0);
  }
  !this.invulnerableState && l && t.push({
    color: o(n),
    content: this.getEffectString(i, -1)
  });
  var p = a.TEXT_COLOR.HEAL,
    m = this.lifePointsAdded.clone();
  if (e && (m.min = Math.min(m.min, e.min), m.max = Math.min(m.max, e.max), m.minCritical = Math.min(m.minCritical, e.minCritical), m.maxCritical = Math.min(m.maxCritical, e.maxCritical)), m.min > 0 || m.max > 0 || m.minCritical > 0 || m.maxCritical > 0) {
    var f = this.getEffectString(m, -1);
    t.push({
      color: p,
      content: this.unhealableState ? window.gui.databases.SpellStates[76].nameId : f
    });
  }
  return t;
};
n.prototype.getEffectString = function (e, t) {
  var i = e.clone();
  i.truncate();
  var n = "",
    o = "" + i.min,
    a = "" + i.max,
    s = "" + i.minCritical,
    r = "" + i.maxCritical;
  return this.isAccurate || (o = "±" + o, s = "±" + s, i.max && (a = "±" + a), i.maxCritical && (r = "±" + r)), n = i.min === i.max ? a : o + (0 !== i.max ? " - " + a : ""), (i.minCritical > 0 && i.min !== i.minCritical || i.maxCritical > 0 && i.max !== i.maxCritical) && (n += i.minCritical === i.maxCritical ? " (<b>" + r + "</b>)" : " (<b>" + s + (0 !== i.maxCritical ? " - " + r : "") + "</b>)"), t > 0 ? t + "% " + n : n;
};
this.damage = new c();
this.lifePointsAdded = new c();
this.lifePointsAddedBasedOnLifePercent = new c();
this.damage.addFromDamage(e.damage);
this.lifePointsAdded.addFromDamage(e.lifePointsAdded);
this.lifePointsAddedBasedOnLifePercent.addFromDamage(e.lifePointsAddedBasedOnLifePercent);
u.effectId === r.ACTION_CHARACTER_PUSH && (h = s.PUSH);
h === -1 || h !== n && null !== n ? h !== -1 && h !== n && (n = -1) : n = h;
i.min += u.damage.min;
i.max += u.damage.max;
i.minCritical += u.damage.minCritical;
i.maxCritical += u.damage.maxCritical;
m[o.NEUTRAL] = "neutralElementResistPercent";
m[o.EARTH] = "earthElementResistPercent";
m[o.FIRE] = "fireElementResistPercent";
m[o.WATER] = "waterElementResistPercent";
m[o.AIR] = "airElementResistPercent";
f[o.NEUTRAL] = "neutralElementReduction";
f[o.EARTH] = "earthElementReduction";
f[o.FIRE] = "fireElementReduction";
f[o.WATER] = "waterElementReduction";
f[o.AIR] = "airElementReduction";
g[n.ACTION_CHARACTER_STEAL_CHANCE] = "chanceBonus";
g[n.ACTION_CHARACTER_STEAL_AGILITY] = "agilityBonus";
g[n.ACTION_CHARACTER_STEAL_INTELLIGENCE] = "intelligenceBonus";
g[n.ACTION_CHARACTER_STEAL_STRENGTH] = "strengthBonus";
g[n.ACTION_CHARACTER_BOOST_PUSH_DAMAGE] = "pushDamageBonus";
g[n.ACTION_CHARACTER_BOOST_DAMAGES_PERCENT] = "damagesBonusPercent";
_[n.ACTION_CHARACTER_STEAL_CHANCE] = "criticalChanceBonus";
_[n.ACTION_CHARACTER_STEAL_AGILITY] = "criticalAgilityBonus";
_[n.ACTION_CHARACTER_STEAL_INTELLIGENCE] = "criticalIntelligenceBonus";
_[n.ACTION_CHARACTER_STEAL_STRENGTH] = "criticalStrengthBonus";
_[n.ACTION_CHARACTER_BOOST_PUSH_DAMAGE] = "criticalPushDamageBonus";
_[n.ACTION_CHARACTER_BOOST_DAMAGES_PERCENT] = "damagesBonusPercent";
v[n.ACTION_CHARACTER_STEAL_CHANCE] = n.ACTION_CHARACTER_BOOST_CHANCE;
v[n.ACTION_CHARACTER_STEAL_AGILITY] = n.ACTION_CHARACTER_BOOST_AGILITY;
v[n.ACTION_CHARACTER_STEAL_INTELLIGENCE] = n.ACTION_CHARACTER_BOOST_INTELLIGENCE;
v[n.ACTION_CHARACTER_STEAL_STRENGTH] = n.ACTION_CHARACTER_BOOST_STRENGTH;
v[n.ACTION_CHARACTER_BOOST_PUSH_DAMAGE] = n.ACTION_CHARACTER_BOOST_PUSH_DAMAGE;
y[n.ACTION_CHARACTER_BOOST_DAMAGES_PERCENT_SPELLS] = "spellDamagesBonus";
y[n.ACTION_FIGHT_BOOST_WEAPON_DAMAGE_POWER] = "weaponDamagesBonus";
y[n.ACTION_CHARACTER_BOOST_DEALT_DAMAGE_PERCENT_MULTIPLIER] = "damageBoostPercent";
y[n.ACTION_CHARACTER_DEBOOST_DEALT_DAMAGE_PERCENT_MULTIPLIER] = "damageDeboostPercent";
w[n.ACTION_CHARACTER_LIFE_LOST_REFLECTOR] = 1;
w[n.ACTION_CHARACTER_SACRIFY] = 2;
w[n.ACTION_CHARACTER_PUNISHMENT] = 3;
b.TARGET_EROSION_DAMAGE = [];
b.TARGET_EROSION_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_MISSING_MAX_LIFE] = !0;
b.TARGET_EROSION_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_MISSING_MAX_LIFE_AIR] = !0;
b.TARGET_EROSION_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_MISSING_MAX_LIFE_FIRE] = !0;
b.TARGET_EROSION_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_MISSING_MAX_LIFE_WATER] = !0;
b.TARGET_EROSION_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_MISSING_MAX_LIFE_EARTH] = !0;
b.TARGET_EROSION_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_MISSING_MAX_LIFE_BEST_ELEMENT] = !0;
b.CASTER_EROSION_DAMAGE = [];
b.CASTER_EROSION_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_MISSING_MAX_LIFE] = !0;
b.CASTER_EROSION_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_MISSING_MAX_LIFE_AIR] = !0;
b.CASTER_EROSION_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_MISSING_MAX_LIFE_FIRE] = !0;
b.CASTER_EROSION_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_MISSING_MAX_LIFE_WATER] = !0;
b.CASTER_EROSION_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_MISSING_MAX_LIFE_EARTH] = !0;
b.CASTER_EROSION_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_MISSING_MAX_LIFE_BEST_ELEMENT] = !0;
b.HEALING = [];
b.HEALING[n.ACTION_CHARACTER_LIFE_POINTS_WIN_WITHOUT_ELEMENT] = !0;
b.HEALING[n.ACTION_CHARACTER_LIFE_POINTS_WIN] = !0;
b.HEALING[n.ACTION_FIGHT_LIFE_POINTS_WIN_PERCENT] = !0;
b.HEALING[n.ACTION_CHARACTER_DISPATCH_LIFE_POINTS_PERCENT] = !0;
b.STEALING = [];
b.STEALING[n.ACTION_CHARACTER_LIFE_POINTS_STEAL_WITHOUT_BOOST] = !0;
b.STEALING[n.ACTION_CHARACTER_LIFE_POINTS_STEAL_FROM_WATER] = !0;
b.STEALING[n.ACTION_CHARACTER_LIFE_POINTS_STEAL_FROM_EARTH] = !0;
b.STEALING[n.ACTION_CHARACTER_LIFE_POINTS_STEAL_FROM_AIR] = !0;
b.STEALING[n.ACTION_CHARACTER_LIFE_POINTS_STEAL_FROM_FIRE] = !0;
b.STEALING[n.ACTION_CHARACTER_LIFE_POINTS_STEAL_FROM_BEST_ELEMENT] = !0;
b.STEALING[n.ACTION_CHARACTER_LIFE_POINTS_STEAL] = !0;
b.BEST_ELEMENT = [];
b.BEST_ELEMENT[n.ACTION_CHARACTER_LIFE_POINTS_LOST_FROM_BEST_ELEMENT] = !0;
b.BEST_ELEMENT[n.ACTION_CHARACTER_LIFE_POINTS_LOST_NO_BOOST_FROM_BEST_ELEMENT] = !0;
b.BEST_ELEMENT[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_FROM_BEST_ELEMENT] = !0;
b.BEST_ELEMENT[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_LIFE_FROM_BEST_ELEMENT] = !0;
b.BEST_ELEMENT[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_MISSING_MAX_LIFE_BEST_ELEMENT] = !0;
b.BEST_ELEMENT[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_MISSING_MAX_LIFE_BEST_ELEMENT] = !0;
b.BEST_ELEMENT[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_MISSING_FROM_BEST_ELEMENT] = !0;
b.BEST_ELEMENT[n.ACTION_CHARACTER_LIFE_POINTS_STEAL_FROM_BEST_ELEMENT] = !0;
b.BEST_ELEMENT[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_MOVEMENT_POINTS_FROM_BEST_ELEMENT] = !0;
b.SPLASH = [];
b.SPLASH[n.ACTION_FIGHT_SPLASH_DAMAGE] = !0;
b.SPLASH[n.ACTION_FIGHT_SPLASH_DAMAGE_NEUTRAL] = !0;
b.SPLASH[n.ACTION_FIGHT_SPLASH_DAMAGE_AIR] = !0;
b.SPLASH[n.ACTION_FIGHT_SPLASH_DAMAGE_FIRE] = !0;
b.SPLASH[n.ACTION_FIGHT_SPLASH_DAMAGE_WATER] = !0;
b.SPLASH[n.ACTION_FIGHT_SPLASH_DAMAGE_EARTH] = !0;
b.SPLASH_HEAL = [];
b.SPLASH_HEAL[n.ACTION_FIGHT_SPLASH_HEAL] = !0;
b.SPLASH_FINAL = [];
b.SPLASH_FINAL[n.ACTION_FIGHT_SPLASH_FINAL_TAKEN_DAMAGE] = !0;
b.SPLASH_FINAL[n.ACTION_FIGHT_SPLASH_FINAL_TAKEN_DAMAGE_NEUTRAL] = !0;
b.SPLASH_FINAL[n.ACTION_FIGHT_SPLASH_FINAL_TAKEN_DAMAGE_AIR] = !0;
b.SPLASH_FINAL[n.ACTION_FIGHT_SPLASH_FINAL_TAKEN_DAMAGE_FIRE] = !0;
b.SPLASH_FINAL[n.ACTION_FIGHT_SPLASH_FINAL_TAKEN_DAMAGE_WATER] = !0;
b.SPLASH_FINAL[n.ACTION_FIGHT_SPLASH_FINAL_TAKEN_DAMAGE_EARTH] = !0;
b.MP_BASED_DAMAGE = [];
b.MP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_MOVEMENT_POINTS] = !0;
b.MP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_MOVEMENT_POINTS_FROM_AIR] = !0;
b.MP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_MOVEMENT_POINTS_FROM_WATER] = !0;
b.MP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_MOVEMENT_POINTS_FROM_FIRE] = !0;
b.MP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_MOVEMENT_POINTS_FROM_EARTH] = !0;
b.HP_BASED_DAMAGE = [];
b.HP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_MIDLIFE] = !0;
b.HP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_FROM_WATER] = !0;
b.HP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_FROM_EARTH] = !0;
b.HP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_FROM_AIR] = !0;
b.HP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_FROM_FIRE] = !0;
b.HP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_FROM_BEST_ELEMENT] = !0;
b.HP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE] = !0;
b.HP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_MISSING_FROM_WATER] = !0;
b.HP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_MISSING_FROM_EARTH] = !0;
b.HP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_MISSING_FROM_AIR] = !0;
b.HP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_MISSING_FROM_FIRE] = !0;
b.HP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_MISSING_FROM_BEST_ELEMENT] = !0;
b.HP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_MISSING] = !0;
b.TARGET_HP_BASED_DAMAGE = [];
b.TARGET_HP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_LIFE_FROM_AIR] = !0;
b.TARGET_HP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_LIFE_FROM_WATER] = !0;
b.TARGET_HP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_LIFE_FROM_FIRE] = !0;
b.TARGET_HP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_LIFE_FROM_EARTH] = !0;
b.TARGET_HP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_LIFE_FROM_BEST_ELEMENT] = !0;
b.TARGET_HP_BASED_DAMAGE[n.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_LIFE] = !0;
b.GLYPH_TRIGGERING_SPELLS = [];
b.GLYPH_TRIGGERING_SPELLS[n.ACTION_FIGHT_ADD_GLYPH_CASTING_SPELL] = !0;
b.GLYPH_TRIGGERING_SPELLS[n.ACTION_FIGHT_ADD_GLYPH_CASTING_SPELL_ENDTURN] = !0;
b.GLYPH_TRIGGERING_SPELLS[n.ACTION_FIGHT_ADD_GLYPH_AURA] = !0;
b.TRIGGERING_SPELL = [];
b.TRIGGERING_SPELL[n.ACTION_SOURCE_EXECUTE_SPELL_ON_TARGET] = d.SPELL_ON_TARGET;
b.TRIGGERING_SPELL[n.ACTION_SOURCE_EXECUTE_SPELL_ON_SOURCE] = d.SPELL_ON_CASTER;
b.TRIGGERING_SPELL[n.ACTION_CASTER_EXECUTE_SPELL] = d.SPELL_ON_TARGET;
b.TRIGGERING_SPELL[n.ACTION_CASTER_EXECUTE_SPELL_GLOBAL_LIMITATION] = d.SPELL_ON_FIRST_TARGET;
b.TRIGGERING_SPELL[n.ACTION_CHARACTER_EXECUTE_SPELL] = d.SPELL_ON_TARGET_TARGET_IS_CASTER;
b.TRIGGERING_SPELL[n.ACTION_CHARACTER_EXECUTE_SPELL_WITH_ANIMATION] = d.SPELL_ON_TARGET_TARGET_IS_CASTER;
b.TRIGGERING_SPELL[n.ACTION_CHARACTER_EXECUTE_SPELL_ON_SOURCE] = d.SPELL_ON_CASTER_TARGET_IS_CASTER;
b.NO_BOOST = [];
b.NO_BOOST[n.ACTION_CHARACTER_LIFE_POINTS_LOST_WITHOUT_BOOST] = !0;
b.NO_BOOST[n.ACTION_CHARACTER_LIFE_POINTS_STEAL_WITHOUT_BOOST] = !0;
e.exports = {
  TEXT_COLOR: a,
  TYPE: s,
  ORIGIN: r,
  MARK: l,
  NAME_RESISTANCE_ELEMENT: m,
  NAME_REDUCTION_ELEMENT: f,
  BUFF_EFFECT_TO_STAT_EFFECT: v,
  EFFECT_ADD_STATS_PROPERTY: g,
  EFFECT_ADD_STATS_PROPERTY_CRITICAL: _,
  BUFF_ADD_DAMAGES: y,
  EFFECTSHAPE_DEFAULT: c,
  TRIGGERING_SPELL_TYPE: d,
  MISSING_TRIGGERS: u,
  MARK_TO_BOMB: p,
  BUFF_EFFECT_ORDER: w,
  EFFECTS_IDS: b,
  DISABLED_SPELL: h,
  DAMAGE_NOT_BOOSTED: 1,
  UNLIMITED_ZONE_SIZE: 50,
  DAMAGE_EFFECT_CATEGORY: 2,
  BOMB_ZONE_SIZE: 2,
  WALL_MAX_SIZE: 7,
  MAX_RESISTANCE: 50,
  FIGHT_CHARACTER_TYPE: "GameFightCharacterInformations",
  RESISTANCE_NAME: "ResistPercent"
};
this.nameId = e;
this.effectId = t;
this.element = i;
this.random = n;
this.type = a.TYPE.NORMAL;
this.origin = a.ORIGIN.NONE;
this.efficiencyMultiplier = 0;
this.erosionLifePoints = 0;
this.damage = new s();
this.damageWithoutResist = new s();
this.erosionPercent = new s();
this.lifePointsAdded = new s();
this.lifePointsAddedBasedOnLifePercent = new s();
e.exports = n;
n.prototype.clone = function () {
  var e = new n(),
    t = o.getOwnProperties(this);
  return o.shallowCopyProperties(this, e, t), e.damage = this.damage.clone(), e.erosionPercent = this.erosionPercent.clone(), e.lifePointsAdded = this.lifePointsAdded.clone(), e.lifePointsAddedBasedOnLifePercent = this.lifePointsAddedBasedOnLifePercent.clone(), e;
};
n.prototype.doesDamage = function () {
  return this.damage.min > 0 || this.damage.max > 0 || this.damage.minCritical > 0 || this.damage.maxCritical > 0;
};
n.prototype.doesHeal = function () {
  return this.lifePointsAdded.min > 0 || this.lifePointsAdded.max > 0 || this.lifePointsAdded.minCritical > 0 || this.lifePointsAdded.maxCritical > 0;
};
n.prototype.applyHealMultiplier = function (e) {
  this.lifePointsAdded.applyMultiplier(e);
};
n.prototype.applyDamageMultiplier = function (e) {
  this.damage.applyMultiplier(e);
  this.damageWithoutResist.applyMultiplier(e);
};
n.prototype.convertDamageToHeal = function () {
  this.lifePointsAdded.addFromDamage(this.damage);
  this.damage.reset();
  this.damageWithoutResist.reset();
  this.type = a.TYPE.HEAL;
};
this.damage.applyMultiplier(e);
this.damageWithoutResist.applyMultiplier(e);
this.lifePointsAdded.addFromDamage(this.damage);
this.damage.reset();
this.damageWithoutResist.reset();
this.type = a.TYPE.HEAL;
this.min = e || 0;
this.max = t || 0;
this.minCritical = i || 0;
this.maxCritical = n || 0;
Object.defineProperty(this, "normal", {
  get: function () {
    return this.min;
  },
  set: function (e) {
    this.min = e;
    this.max = e;
  }
});
Object.defineProperty(this, "critical", {
  get: function () {
    return this.minCritical;
  },
  set: function (e) {
    this.minCritical = e;
    this.maxCritical = e;
  }
});
this.min = e;
this.max = e;
this.minCritical = e;
this.maxCritical = e;
e.exports = i;
i.prototype.applyMultiplier = function (e) {
  this.min *= e;
  this.max *= e;
  this.minCritical *= e;
  this.maxCritical *= e;
};
i.prototype.reset = function () {
  this.min = 0;
  this.max = 0;
  this.minCritical = 0;
  this.maxCritical = 0;
};
i.prototype.resetCritical = function () {
  this.minCritical = 0;
  this.maxCritical = 0;
};
i.prototype.clone = function () {
  return new i(this.min, this.max, this.minCritical, this.maxCritical);
};
i.prototype.truncate = function () {
  this.min = ~~this.min;
  this.max = ~~this.max;
  this.minCritical = ~~this.minCritical;
  this.maxCritical = ~~this.maxCritical;
};
i.prototype.addFromDamage = function (e) {
  this.min += e.min;
  this.max += e.max;
  this.minCritical += e.minCritical;
  this.maxCritical += e.maxCritical;
};
i.prototype.substractFromDamage = function (e) {
  this.min -= e.min;
  this.max -= e.max;
  this.minCritical -= e.minCritical;
  this.maxCritical -= e.maxCritical;
};
i.prototype.addFrom = function (e) {
  this.min += e;
  this.max += e;
  this.minCritical += e;
  this.maxCritical += e;
};
i.prototype.unsignedNumber = function () {
  this.min = Math.max(0, this.min);
  this.max = Math.max(0, this.max);
  this.minCritical = Math.max(0, this.minCritical);
  this.maxCritical = Math.max(0, this.maxCritical);
};
i.prototype.convertToCritical = function () {
  this.minCritical = this.min;
  this.maxCritical = this.max;
  this.min = 0;
  this.max = 0;
};
this.min *= e;
this.max *= e;
this.minCritical *= e;
this.maxCritical *= e;
this.min = 0;
this.max = 0;
this.minCritical = 0;
this.maxCritical = 0;
this.minCritical = 0;
this.maxCritical = 0;
this.min = ~~this.min;
this.max = ~~this.max;
this.minCritical = ~~this.minCritical;
this.maxCritical = ~~this.maxCritical;
this.min += e.min;
this.max += e.max;
this.minCritical += e.minCritical;
this.maxCritical += e.maxCritical;
this.min -= e.min;
this.max -= e.max;
this.minCritical -= e.minCritical;
this.maxCritical -= e.maxCritical;
this.min += e;
this.max += e;
this.minCritical += e;
this.maxCritical += e;
this.min = Math.max(0, this.min);
this.max = Math.max(0, this.max);
this.minCritical = Math.max(0, this.minCritical);
this.maxCritical = Math.max(0, this.maxCritical);
this.minCritical = this.min;
this.maxCritical = this.max;
this.min = 0;
this.max = 0;
this.id = e;
this.level = 0;
this.cellId = -1;
this.type = null;
this.isAccurate = !0;
this.isInvulnerable = !1;
this.isUnhealable = !1;
this.isBomb = !1;
this.states = [];
this.lifePointsAfterDamages = new o();
this.lifeLost = new o();
this.buffs = [];
this.strength = 0;
this.chance = 0;
this.agility = 0;
this.intelligence = 0;
this.strengthBonus = 0;
this.chanceBonus = 0;
this.agilityBonus = 0;
this.intelligenceBonus = 0;
this.criticalStrengthBonus = 0;
this.criticalChanceBonus = 0;
this.criticalAgilityBonus = 0;
this.criticalIntelligenceBonus = 0;
this.newStatsBonus = t || {};
this.criticalHit = 0;
this.criticalHitWeapon = 0;
this.baseDamageBonus = 0;
this.healBonus = 0;
this.allDamagesBonus = 0;
this.damagesBonusPercent = 0;
this.spellDamagesBonus = 0;
this.weaponDamagesBonus = 0;
this.comboBonus = 0;
this.trapBonus = 0;
this.trapBonusPercent = 0;
this.permanentDamagePercent = 0;
this.pushDamageBonus = 0;
this.criticalPushDamageBonus = 0;
this.criticalDamageBonus = 0;
this.neutralDamageBonus = 0;
this.earthDamageBonus = 0;
this.waterDamageBonus = 0;
this.airDamageBonus = 0;
this.fireDamageBonus = 0;
this.damageBoostPercent = 0;
this.damageDeboostPercent = 0;
this.dealtDamageMultiplierDistance = 0;
this.dealtDamageMultiplierMelee = 0;
this.dealtDamageMultiplierSpells = 0;
this.dealtDamageMultiplierWeapon = 0;
this.neutralElementResistPercent = 0;
this.earthElementResistPercent = 0;
this.waterElementResistPercent = 0;
this.airElementResistPercent = 0;
this.fireElementResistPercent = 0;
this.neutralElementReduction = 0;
this.earthElementReduction = 0;
this.waterElementReduction = 0;
this.airElementReduction = 0;
this.fireElementReduction = 0;
this.criticalDamageFixedResist = 0;
this.pushDamageFixedResist = 0;
this.receivedDamageMultiplierDistance = 0;
this.receivedDamageMultiplierMelee = 0;
this.receivedDamageMultiplierSpells = 0;
this.receivedDamageMultiplierWeapon = 0;
this.erosionLifePoints = 0;
this.spellErosionLifePoints = new o();
this.erosionPercentBonus = 0;
e.exports = n;
n.prototype.retrieveStats = function () {
  var e = window.gui,
    t = e.damagePreview.damagePreviewManager,
    i = e.playerData.characters.controlledCharacterId,
    n = window.actorManager.getActor(this.id);
  if (!n) {
    return console.warn("Actor " + this.id + " does not exist");
  }
  var o = n.getFighter();
  if (!o) {
    return console.warn("Fighter " + this.id + " does not exist");
  }
  var r = o.data,
    l = r.stats,
    c = o.data.stats.summoner === e.playerData.characters.mainCharacterId;
  this.type = r._type;
  this.level = o.level;
  this.isBomb = o.isBomb;
  this.cellId = t.getVirtualCellFromRealCell(n.cellId);
  this.erosionLifePoints = l.baseMaxLifePoints - l.maxLifePoints;
  this.states = o.states.concat(t.triggeredStates[this.id]);
  this.isInvulnerable = this.states.indexOf(s.STATE_INVULNERABLE) !== -1 || this.states.indexOf(s.STATE_INVULNERABLE_COPY) !== -1;
  this.isUnhealable = this.states.indexOf(s.STATE_INCURABLE) !== -1;
  this.buffs = o.buffs.sort(function (e, t) {
    var i = a.BUFF_EFFECT_ORDER[e.actionId] || 0,
      n = a.BUFF_EFFECT_ORDER[t.actionId] || 0;
    return i - n;
  });
  var d;
  for (d in l) {
    0 === this[d] && (this[d] = l[d]);
  }
  if (this.id === i || (this.isAccurate = !1, c)) {
    this.isBomb && (this.isAccurate = !0);
    var u = e.playerData.characters.getControlledCharacter().characteristics;
    for (d in u) {
      if (0 === this[d]) {
        var h = u[d];
        this[d] = c ? h.getBasePts() + h.getEquipmentPts() : h.getTotalStat();
      }
    }
  }
};
this.type = r._type;
this.level = o.level;
this.isBomb = o.isBomb;
this.cellId = t.getVirtualCellFromRealCell(n.cellId);
this.erosionLifePoints = l.baseMaxLifePoints - l.maxLifePoints;
this.states = o.states.concat(t.triggeredStates[this.id]);
this.isInvulnerable = this.states.indexOf(s.STATE_INVULNERABLE) !== -1 || this.states.indexOf(s.STATE_INVULNERABLE_COPY) !== -1;
this.isUnhealable = this.states.indexOf(s.STATE_INCURABLE) !== -1;
this.buffs = o.buffs.sort(function (e, t) {
  var i = a.BUFF_EFFECT_ORDER[e.actionId] || 0,
    n = a.BUFF_EFFECT_ORDER[t.actionId] || 0;
  return i - n;
});
o.data._type === w.FIGHT_CHARACTER_TYPE && e.indexOf(w.RESISTANCE_NAME) !== -1 && (a = Math.min(w.MAX_RESISTANCE, a));
i += a;
t.stat = t.ignoreStats || !t.stat ? 0 : t.stat;
t.statBonus = t.ignoreStats || !t.statBonus ? 0 : t.statBonus;
t.comboBonus = t.ignoreStats || !t.comboBonus ? 0 : t.comboBonus;
t.damageSharingMultiplicator = t.damageSharingMultiplicator || 1;
t.baseDamageBonus = t.baseDamageBonus || 0;
t.damageBonus = t.damageBonus || 0;
t.dealtDamageMultiplierBonus = t.dealtDamageMultiplierBonus || 0;
t.allDamagesBonus = t.allDamagesBonus || 0;
t.spellModifBonus = t.spellModifBonus || 0;
t.damageReduction = t.damageReduction || 0;
t.resistPercent = void 0 !== t.resistPercent ? t.resistPercent : 100;
t.efficiencyPercent = void 0 !== t.efficiencyPercent ? t.efficiencyPercent : 100;
e += t.baseDamageBonus;
h.prototype.getBuffElementReduction = function (e, t) {
  var i = window.gui.fightManager.getFighter(t);
  if (!i) {
    return 0;
  }
  for (var n = 0, o = 0; o < i.buffs.length; o++) {
    var a = i.buffs[o],
      s = a.canBeDispell() && a.duration - this.spellTargetEffectsDurationReduction <= 0,
      r = u(this.caster, a);
    if (!s && (e.element === r || r === -1) && (a.actionId === m.ACTION_CHARACTER_LIFE_LOST_CASTER_MODERATOR || a.actionId === m.ACTION_CHARACTER_LIFE_LOST_MODERATOR) && this.verifyEffectDamageTrigger(e, a.effect.triggers, {
      isWeapon: this.isWeapon,
      targetId: t
    })) {
      var l = window.gui.fightManager.getFighter(a.source),
        c = l ? l.level : 1;
      n += (c / 20 + 1) * a.effect.value;
    }
  }
  return n;
};
h.prototype.getAverageBuffElementReduction = function (e, t) {
  for (var i = 0, n = 0; n < t.length; n++) {
    var o = t[n];
    i += this.getBuffElementReduction(e, o);
  }
  return i / t.length;
};
h.prototype.applyResistanceAndReduction = function (e) {
  var t = this.getResistancePercent(e.element),
    i = this.getReduction(e.element) + this.getBuffElementReduction(e, this.target.id),
    n = new y(e.nameId, e.effectId, e.element, e.random);
  return n.damage.addFromDamage(e.damage), n.damage.addFrom(-i), n.damage.truncate(), n.damage.applyMultiplier(t / 100), n.damage.truncate(), n;
};
h.prototype.getResistancePercent = function (e) {
  var t = 0;
  return w.NAME_RESISTANCE_ELEMENT[e] && (t = this.target[w.NAME_RESISTANCE_ELEMENT[e]]), 100 - t;
};
h.prototype.getReduction = function (e) {
  var t = 0;
  return w.NAME_REDUCTION_ELEMENT[e] && (t = this.target[w.NAME_REDUCTION_ELEMENT[e]]), t;
};
h.prototype.resetReusableValues = function () {
  var e = window.gui.fightManager;
  this.target.spellErosionLifePoints.reset();
  var t = e.getFighter(this.target.id),
    i = t && t.data.stats.lifePoints;
  this.target.lifePointsAfterDamages.min = i - this.target.lifeLost.min;
  this.target.lifePointsAfterDamages.max = i - this.target.lifeLost.max;
  var n = e.getFighter(this.caster.id),
    o = n && n.data.stats.lifePoints;
  this.caster.lifePointsAfterDamages.min = o - this.caster.lifeLost.min;
  this.caster.lifePointsAfterDamages.max = o - this.caster.lifeLost.max;
};
h.prototype._computeAllSharedDamages = function (e, t, i) {
  for (var n = 0; n < this.sharedDamages.length; n++) {
    for (var o = this.sharedDamages[n], a = 0; a < o.effectDamages.length; a++) {
      var s = o.effectDamages[a];
      if (s.doesDamage() || s.type === w.TYPE.EROSION) {
        var r;
        if (_.isLifeStealingEffect(s)) {
          var l = this._computeSharedDamages(s, .5);
          l.convertDamageToHeal();
          r = "sharedsteal" + s.element + "-" + s.effectId;
          t[r] ? t[r].lifePointsAdded.addFromDamage(l.lifePointsAdded) : t[r] = l;
        }
        if (!i.onlyShareableEffects) {
          var c = this._computeSharedDamages(s, 1);
          c.type = w.TYPE.SHARED;
          r = "shared" + s.element + "-" + s.effectId;
          e[r] ? e[r].damage.addFromDamage(c.damage) : e[r] = c;
        }
      }
    }
  }
};
h.prototype._computeAllElementaryDamages = function (e, t) {
  var i;
  for (var n in this.baseDamages) {
    if (this.baseDamages.hasOwnProperty(n)) {
      switch (i = this.baseDamages[n], i.type) {
        case w.TYPE.NORMAL:
        case w.TYPE.EROSION:
          e[n] = this._computeDamage(i);
          break;
        case w.TYPE.FIXED:
          e[n] = i.clone();
      }
      _.isLifeStealingEffect(i) && (t[n] = this._computeDamage(i, {
        extraMultiplier: .5
      }));
    }
  }
  for (var o = 0; o < this.splashDamages.length; o++) {
    i = this.splashDamages[o];
    i = this._computeDamage(i, {
      ignoreCasterStats: !0
    });
    e["splash" + i.element + "-" + i.effectId] = i;
    i.type = w.TYPE.SPLASH;
  }
};
h.prototype._getComputedHealDamages = function () {
  var e = Math.max(1, this.caster.intelligence + this.caster.intelligenceBonus),
    t = new y(-1, -1, -1, -1);
  t.type = w.TYPE.HEAL;
  var i;
  for (var n in this.baseDamages) {
    this.baseDamages.hasOwnProperty(n) && this.baseDamages[n].type === w.TYPE.HEAL && (i = this.baseDamages[n], t.lifePointsAdded.min += (Math.floor(i.lifePointsAdded.min * (100 + e) / 100) + (i.lifePointsAdded.min > 0 ? this.caster.healBonus : 0)) * i.efficiencyMultiplier, t.lifePointsAdded.max += (Math.floor(i.lifePointsAdded.max * (100 + e) / 100) + (i.lifePointsAdded.max > 0 ? this.caster.healBonus : 0)) * i.efficiencyMultiplier, t.lifePointsAdded.min += i.lifePointsAddedBasedOnLifePercent.normal, t.lifePointsAdded.max += i.lifePointsAddedBasedOnLifePercent.normal);
  }
  for (var o = 0; o < this.splashDamages.length; o++) {
    i = this.splashDamages[o];
    t.lifePointsAdded.addFromDamage(i.lifePointsAdded);
  }
  return t.lifePointsAdded.truncate(), t;
};
h.prototype._computeTargetBuffs = function (e, t, i, o, s) {
  function r(e, t) {
    if (e.doesDamage()) {
      var i = new y(-1, e.effectId, e.element, e.random),
        n = u.getResistancePercent(e.element),
        o = u.getReduction(e.element),
        a = (t - o) * n / 100;
      i.damage.max = Math.min(a, e.damage.max);
      i.damage.min = Math.min(a, e.damage.min);
      i.type = e.type;
      i.origin = e.origin;
      u.counteredDamagesGiven.push(i);
    }
  }
  function l(e, t, i, n) {
    e.random > 0 ? (e.lifePointsAdded.min = Math.min(i, e.damage.min * n / 2), e.lifePointsAdded.max = Math.min(i, e.damage.max * n / 2)) : (t.lifePointsAdded.min = Math.min(i, t.lifePointsAdded.min + e.damage.min * n / 2), t.lifePointsAdded.max = Math.min(i, t.lifePointsAdded.max + e.damage.max * n / 2));
  }
  function c(e, t) {
    if (e.doesDamage() || 0 !== e.erosionPercent.min) {
      var i = new y(e.nameId, e.effectId, e.element, e.random);
      if (i.damage.min = e.damage.min, i.damage.max = e.damage.max, i.origin = e.origin, e.type === w.TYPE.EROSION) {
        var o = (10 + u.target.erosionPercentBonus) / 100,
          a = u.target.lifeLost.clone();
        a.applyMultiplier(o);
        a.addFrom(t.data.stats.baseMaxLifePoints - t.data.stats.maxLifePoints);
        a.addFromDamage(u.target.spellErosionLifePoints);
        i.damage = n(a, e.erosionPercent, 100, 1);
        i.damageWithoutResist = i.damage.clone();
        i = u.applyResistanceAndReduction(i);
      }
      u.damagesOutput.push(i);
    }
  }
  for (var d, u = this, h = window.gui.fightManager, p = window.gui.damagePreview.damagePreviewManager, f = [], g = 0; g < this.target.buffs.length; g++) {
    var v,
      b = this.target.buffs[g],
      M = b.canBeDispell() && b.duration - this.spellTargetEffectsDurationReduction <= 0 && b.duration !== -1e3,
      C = !(b instanceof T && b.statName);
    if (!b.delay && C && this.verifyBuffTrigger(b) && !M) {
      switch (f[b.actionId] = f[b.actionId] || 0, f[b.actionId]++, b.actionId) {
        case m.ACTION_FIGHT_SET_STATE:
          b.effect.trigger && (p.triggeredStates[this.target.id] = p.triggeredStates[this.target.id] || [], p.triggeredStates[this.target.id].push(b.effect.getParams()[0]));
          break;
        case m.ACTION_CHARACTER_MULTIPLY_RECEIVED_HEAL:
          i.applyHealMultiplier(b.getParam1() / 100);
          break;
        case m.ACTION_CHARACTER_MULTIPLY_RECEIVED_DAMAGE:
          var I = b.getParam1() / 100;
          for (d in e) {
            e.hasOwnProperty(d) && (e[d].type !== w.TYPE.NORMAL && e[d].type !== w.TYPE.EROSION && e[d].type !== w.TYPE.SPLASH || e[d].applyDamageMultiplier(I));
          }
          for (d in t) {
            t.hasOwnProperty(d) && t[d].applyDamageMultiplier(I);
          }
          break;
        case m.ACTION_CHARACTER_LIFE_LOST_REFLECTOR:
          if (v = h.getFighter(b.source), !v) {
            break;
          }
          var A = v.isSummon() && h.getFighter(v.data.stats.summoner),
            S = A ? A.level : v.level,
            E = a(b.effect.value, S);
          this.counteredDamagesGiven = [];
          for (d in e) {
            e.hasOwnProperty(d) && (e[d].type !== w.TYPE.NORMAL && e[d].type !== w.TYPE.EROSION && e[d].type !== w.TYPE.SHARED && e[d].type !== w.TYPE.SPLASH || r(e[d], E));
          }
          break;
        case m.ACTION_CHARACTER_PUNISHMENT:
          if (b.effect.diceNum !== m.ACTION_CHARACTER_LIFE_POINTS_WIN_NO_BOOST) {
            break;
          }
          var N = new y(-1, -1, -1, -1);
          for (d in e) {
            e.hasOwnProperty(d) && (e[d].type === w.TYPE.NORMAL || e[d].type === w.TYPE.EROSION ? l(e[d], N, b.effect.diceSide, 1) : e[d].type === w.TYPE.SPLASH && l(e[d], N, b.effect.diceSide, 2));
          }
          o.addEffectDamage(N);
          break;
        case m.ACTION_CHARACTER_SACRIFY:
          if (v = h.getFighter(b.source), b.source === this.caster.id && (this.counteredDamagesGiven = []), this.sharedDamages.length > 0 || f[b.actionId] > 1 || !v) {
            break;
          }
          for (d in t) {
            delete t[d];
          }
          this.damagesOutputTo = b.source;
          this.damagesOutput = [];
          for (d in e) {
            e.hasOwnProperty(d) && (e[d].type !== w.TYPE.NORMAL && e[d].type !== w.TYPE.EROSION && e[d].type !== w.TYPE.COUNTERED && e[d].type !== w.TYPE.SPLASH || c(e[d], v));
          }
      }
      if (b.effect.effect.category === w.DAMAGE_EFFECT_CATEGORY && !_.isHealingEffect(b.effect)) {
        var x = _.getElementEffect(this.caster, b.effect.effect),
          L = _.getBuffMinMaxDamageFromRawEffect(b.effect),
          O = b.effect.duration,
          R = new y(-1, b.effect.effectId, x, -1);
        R.damage.min = O - this.spellTargetEffectsDurationReduction > 0 ? L.min : 0;
        R.damage.max = O - this.spellTargetEffectsDurationReduction > 0 ? L.max : 0;
        R.type = w.TYPE.BUFF;
        var D,
          P = 0,
          B = [];
        for (D = 0; D < this.damagesInput.length; D++) {
          (w.EFFECTS_IDS.TARGET_EROSION_DAMAGE[this.damagesInput[D].effectId] || w.EFFECTS_IDS.CASTER_EROSION_DAMAGE[this.damagesInput[D].effectId] || this.verifyEffectDamageTrigger(this.damagesInput[D], b.effect.triggers, {
            isWeapon: this.isWeapon
          })) && (this.damagesInput[D].nameId !== -1 && (B[this.damagesInput[D].nameId] = !0), P++);
        }
        for (d in e) {
          if (e.hasOwnProperty(d) && !B[d]) {
            var k = e[d].type,
              F = this.verifyEffectDamageTrigger(e[d], b.effect.triggers, {
                isWeapon: this.isWeapon
              });
            (k === w.TYPE.EROSION || F && k === w.TYPE.NORMAL) && P++;
          }
        }
        for (D = 0; D < o.effectDamages.length; D++) {
          var H = o.effectDamages[D];
          H.effectId === m.ACTION_CHARACTER_PUSH && this.verifyEffectDamageTrigger(H, b.effect.triggers) && P++;
        }
        for (P += this.splashDamages.length, D = 0; D < P; D++) {
          if (w.EFFECTS_IDS.TARGET_HP_BASED_DAMAGE[b.actionId] || w.EFFECTS_IDS.HP_BASED_DAMAGE[b.actionId]) {
            s.push(R);
          } else {
            var z = this._computeDamage(R, {
              efficiencyMultiplier: 1,
              isBuffDamage: !0
            });
            o.addEffectDamage(z);
          }
        }
      }
    }
  }
};
h.prototype.getSpellDamage = function (e) {
  e = e || {};
  var t,
    i,
    n,
    a = new p();
  this.resetReusableValues();
  var s = [],
    r = [];
  this.sharedDamages.length > 0 ? this._computeAllSharedDamages(s, r, e) : this._computeAllElementaryDamages(s, r);
  var l = this._getComputedHealDamages();
  for (t = 0; t < this.lifeStealingDamagesReceived.length; t++) {
    n = this.lifeStealingDamagesReceived[t];
    n.convertDamageToHeal();
    a.addEffectDamage(n);
  }
  if (!e.onlyShareableEffects) {
    for (t = 0; t < this.pushedEntities.length; t++) {
      var c = this.pushedEntities[t],
        d = o(this.caster, this.target, c.force, c.pushedIndexes[0]);
      if (d && !c.mark && c.doesDamage) {
        var u = new y(-1, m.ACTION_CHARACTER_PUSH, -1, -1);
        u.damage.addFrom(~~d);
        a.addEffectDamage(u);
      }
    }
  }
  var h = this.caster.damageBoostPercent > 0 ? (100 + this.caster.damageBoostPercent) / 100 : 1,
    g = this.caster.damageDeboostPercent > 0 ? Math.max(0, (100 - this.caster.damageDeboostPercent) / 100) : 1,
    _ = h * g;
  for (i in s) {
    s.hasOwnProperty(i) && s[i].type === w.TYPE.NORMAL && s[i].applyDamageMultiplier(_);
  }
  for (i in r) {
    r.hasOwnProperty(i) && r[i].applyDamageMultiplier(_);
  }
  for (t = 0; t < this.counteredDamagesReceived.length; t++) {
    n = this.counteredDamagesReceived[t];
    n = n.type !== w.TYPE.SHARED ? this.applyResistanceAndReduction(n) : n.clone();
    n.type = w.TYPE.COUNTERED;
    s["countered-" + t + "-" + n.effectId] = n;
  }
  var v = [];
  e.withTargetBuffs && !e.onlyShareableEffects && this._computeTargetBuffs(s, r, l, a, v);
  l.doesHeal() && a.addEffectDamage(l);
  for (i in s) {
    s.hasOwnProperty(i) && a.addEffectDamage(s[i]);
  }
  if (0 !== this.damagesOutputTo) {
    for (t = 0; t < a.effectDamages.length; t++) {
      n = a.effectDamages[t];
      n.effectId !== m.ACTION_CHARACTER_PUSH && (n.damage.reset(), n.damageWithoutResist.reset(), n.erosionPercent.reset());
    }
  }
  for (t = 0; t < this.damagesInput.length; t++) {
    a.addEffectDamage(this.damagesInput[t]);
  }
  if (!e.onlyShareableEffects) {
    a.updateDamage();
    this.caster.lifePointsAfterDamages.substractFromDamage(a.damage);
    for (i in this.baseDamages) {
      if (this.baseDamages.hasOwnProperty(i) && this.baseDamages[i].type === w.TYPE.BUFF) {
        var b = this._computeDamage(this.baseDamages[i], {
          efficiencyMultiplier: 1,
          ignoreCasterStats: !1
        });
        a.addEffectDamage(b);
        this.caster.lifePointsAfterDamages.substractFromDamage(b.damage);
      }
    }
  }
  if (v.length > 0 && !e.onlyShareableEffects && 0 === this.damagesOutputTo) {
    for (a.updateDamage(), this.target.lifePointsAfterDamages.substractFromDamage(a.damage), t = 0; t < v.length; t++) {
      var M = this._computeDamage(v[t], {
        efficiencyMultiplier: 1,
        ignoreCasterStats: !1,
        isBuffDamage: !0
      });
      a.addEffectDamage(M);
      this.target.lifePointsAfterDamages.substractFromDamage(M.damage);
    }
  }
  if (a.updateDamage(), this.caster.states.indexOf(f.STATE_PACIFIST) !== -1) {
    for (t = 0; t < a.effectDamages.length; t++) {
      a.effectDamages[t].damage.reset();
      a.effectDamages[t].damageWithoutResist.reset();
    }
  }
  return this.lifeStealingDamagesGiven = r, a;
};
h.prototype._computeSharedDamages = function (e, t) {
  if (!this.sharedFighters.length) {
    return e;
  }
  var i = new y(-1, e.effectId, e.element, e.random),
    n = 100 - c(w.NAME_RESISTANCE_ELEMENT[e.element], this.sharedFighters),
    o = c(w.NAME_REDUCTION_ELEMENT[e.element], this.sharedFighters);
  o += this.getAverageBuffElementReduction(e, this.sharedFighters);
  this.isCriticalEffect && (o += c("criticalDamageFixedResist", this.sharedFighters));
  var a = 1 / this.sharedFighters.length * t,
    s = d(e.damageWithoutResist.min, {
      ignoreStats: !0,
      damageReduction: o,
      resistPercent: n,
      damageSharingMultiplicator: a
    }),
    r = d(e.damageWithoutResist.max, {
      ignoreStats: !0,
      damageReduction: o,
      resistPercent: n,
      damageSharingMultiplicator: a
    });
  return i.damage.min = ~~s, i.damage.max = ~~r, i.type = e.type, i.origin = e.origin, i;
};
h.prototype._computeDamage = function (e, t) {
  var i = window.gui;
  t = t || {};
  var o = 0,
    a = 0,
    r = 0,
    c = 0,
    u = 0,
    h = 0,
    p = 0 !== this.spellId || this.isWeapon ? this.caster.criticalDamageBonus : 0,
    f = t.ignoreCriticalResist ? 0 : this.target.criticalDamageFixedResist,
    _ = this.caster.allDamagesBonus,
    b = this.caster.baseDamageBonus,
    T = 0,
    C = 0,
    I = this.sharedFighters.length ? 1 / this.sharedFighters.length : 1,
    A = 0,
    S = 0,
    E = i.fightManager.getFighter(this.caster.id);
  if (!E) {
    return console.warn("Fighter " + this.caster.id + " does not exist"), e.clone();
  }
  var N = E.data,
    x = N.stats.movementPoints / N.stats.maxMovementPoints,
    L = Math.max(0, this.caster.lifePointsAfterDamages.min),
    O = Math.max(0, this.caster.lifePointsAfterDamages.max),
    R = Math.max(0, this.target.lifePointsAfterDamages.min),
    D = Math.max(0, this.target.lifePointsAfterDamages.max),
    P = e.effectId,
    B = g.getDistance(this.caster.cellId, this.target.cellId);
  switch (B <= 1 ? (A += this.caster.dealtDamageMultiplierMelee, S += this.caster.receivedDamageMultiplierMelee) : (A += this.caster.dealtDamageMultiplierDistance, S += this.caster.receivedDamageMultiplierDistance), this.isWeapon ? (A += this.caster.dealtDamageMultiplierWeapon, S += this.caster.receivedDamageMultiplierWeapon) : (A += this.caster.dealtDamageMultiplierSpells, S += this.caster.receivedDamageMultiplierSpells), w.EFFECTS_IDS.NO_BOOST[P] && (t.ignoreCasterStats = !0), e.element) {
    case M.NEUTRAL:
      u = Math.max(0, this.caster.strength);
      a = this.caster.strengthBonus + (this.caster.newStatsBonus.strengthBonus || 0);
      r = this.caster.criticalStrengthBonus + (this.caster.newStatsBonus.criticalStrengthBonus || 0);
      c = this.target.neutralElementResistPercent;
      h = this.target.neutralElementReduction;
      T = this.caster.neutralDamageBonus;
      break;
    case M.EARTH:
      u = Math.max(0, this.caster.strength);
      a = this.caster.strengthBonus + (this.caster.newStatsBonus.strengthBonus || 0);
      r = this.caster.criticalStrengthBonus + (this.caster.newStatsBonus.criticalStrengthBonus || 0);
      c = this.target.earthElementResistPercent;
      h = this.target.earthElementReduction;
      T = this.caster.earthDamageBonus;
      break;
    case M.FIRE:
      u = Math.max(0, this.caster.intelligence);
      a = this.caster.intelligenceBonus + (this.caster.newStatsBonus.intelligenceBonus || 0);
      r = this.caster.criticalIntelligenceBonus + (this.caster.newStatsBonus.criticalIntelligenceBonus || 0);
      c = this.target.fireElementResistPercent;
      h = this.target.fireElementReduction;
      T = this.caster.fireDamageBonus;
      break;
    case M.WATER:
      u = Math.max(0, this.caster.chance);
      a = this.caster.chanceBonus + (this.caster.newStatsBonus.chanceBonus || 0);
      r = this.caster.criticalChanceBonus + (this.caster.newStatsBonus.criticalChanceBonus || 0);
      c = this.target.waterElementResistPercent;
      h = this.target.waterElementReduction;
      T = this.caster.waterDamageBonus;
      break;
    case M.AIR:
      u = Math.max(0, this.caster.agility);
      a = this.caster.agilityBonus + (this.caster.newStatsBonus.agilityBonus || 0);
      r = this.caster.criticalAgilityBonus + (this.caster.newStatsBonus.criticalAgilityBonus || 0);
      c = this.target.airElementResistPercent;
      h = this.target.airElementReduction;
      T = this.caster.airDamageBonus;
  }
  if (t.ignoreCasterStats && (u = 0, a = 0, r = 0, T = 0, _ = 0, p = 0), !t.ignoreCasterStats && e.element !== -1) {
    var k = this.caster.damagesBonusPercent + (this.caster.newStatsBonus.damagesBonusPercent || 0);
    o = u + .8 * k + C;
    o += this.isWeapon || !this.spellId ? this.caster.weaponDamagesBonus : this.caster.spellDamagesBonus;
  }
  h += this.getBuffElementReduction(e, this.target.id);
  c = 100 - (c + S);
  this.target.type === w.FIGHT_CHARACTER_TYPE && (c = Math.max(w.MAX_RESISTANCE, c));
  var F = t.efficiencyMultiplier || e.efficiencyMultiplier,
    H = (t.extraMultiplier || 1) * F * 100;
  this.isCriticalEffect && (a = r, T += p, h += f);
  var z = new v();
  if (w.EFFECTS_IDS.HP_BASED_DAMAGE[P] || w.EFFECTS_IDS.TARGET_HP_BASED_DAMAGE[P]) {
    switch (P) {
      case m.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_MIDLIFE:
        z.normal = l(e.damage.max, N.stats, H);
        break;
      case m.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_MISSING_FROM_WATER:
      case m.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_MISSING_FROM_EARTH:
      case m.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_MISSING_FROM_AIR:
      case m.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_MISSING_FROM_FIRE:
      case m.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_MISSING_FROM_BEST_ELEMENT:
      case m.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_MISSING:
        z.min = s(e.damage.min, N.stats.maxLifePoints - L, H);
        z.max = s(e.damage.max, N.stats.maxLifePoints - O, H);
        break;
      case m.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_FROM_WATER:
      case m.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_FROM_EARTH:
      case m.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_FROM_AIR:
      case m.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_FROM_FIRE:
      case m.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE_FROM_BEST_ELEMENT:
      case m.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_CASTER_LIFE:
        if (!t.isBuffDamage) {
          z.min = s(e.damage.min, L, H);
          z.max = s(e.damage.max, O, H);
          break;
        }
      case m.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_LIFE_FROM_AIR:
      case m.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_LIFE_FROM_WATER:
      case m.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_LIFE_FROM_FIRE:
      case m.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_LIFE_FROM_EARTH:
      case m.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_LIFE_FROM_BEST_ELEMENT:
      case m.ACTION_CHARACTER_LIFE_POINTS_LOST_BASED_ON_TARGET_LIFE:
        z.min = s(e.damage.min, R, H);
        z.max = s(e.damage.max, D, H);
    }
  } else {
    var W = this.caster.comboBonus;
    z.min = d(e.damage.min, {
      ignoreStats: t.ignoreCasterStats,
      stat: o,
      statBonus: a,
      baseDamageBonus: b,
      damageBonus: T,
      dealtDamageMultiplierBonus: A,
      allDamagesBonus: _,
      efficiencyPercent: H,
      comboBonus: W
    });
    z.max = d(e.damage.max, {
      ignoreStats: t.ignoreCasterStats,
      stat: o,
      statBonus: a,
      baseDamageBonus: b,
      damageBonus: T,
      dealtDamageMultiplierBonus: A,
      allDamagesBonus: _,
      efficiencyPercent: H,
      comboBonus: W
    });
  }
  var G = z.clone();
  G.min -= h;
  G.max -= h;
  G.applyMultiplier(c / 100);
  G.unsignedNumber();
  w.EFFECTS_IDS.MP_BASED_DAMAGE[P] && G.applyMultiplier(x);
  var U,
    q = (10 + this.target.erosionPercentBonus) / 100,
    Y = (10 + this.caster.erosionPercentBonus) / 100;
  w.EFFECTS_IDS.TARGET_EROSION_DAMAGE[P] ? (U = this.target.lifeLost.clone(), U.applyMultiplier(q), U.addFrom(e.erosionLifePoints), U.addFromDamage(this.target.spellErosionLifePoints), G = n(U, e.erosionPercent, c, I)) : w.EFFECTS_IDS.CASTER_EROSION_DAMAGE[P] ? (U = this.caster.lifeLost.clone(), U.applyMultiplier(Y), U.addFrom(e.erosionLifePoints), this.target.id === this.caster.id && U.addFromDamage(this.target.spellErosionLifePoints), G = n(U, e.erosionPercent, c, I)) : (this.target.spellErosionLifePoints.min += G.min * q, this.target.spellErosionLifePoints.max += G.max * q);
  z.truncate();
  G.truncate();
  var j = new y(e.nameId, P, e.element, e.random);
  return j.damage.addFromDamage(G), j.damageWithoutResist.addFromDamage(z), j.erosionPercent = e.erosionPercent.clone(), j.erosionLifePoints = e.erosionLifePoints, j.type = e.type, j.origin = e.origin, j;
};
h.prototype.verifyBuffTrigger = function (e) {
  var t = e.effect.triggers;
  return e.castingSpell && (t = t || w.MISSING_TRIGGERS[e.castingSpell.spell.id]), !!t && !(!this.verifyExternalDamagesTrigger(t) && !this.verifyAllEffectsTrigger(this.effectInstances, t, this.effectMaskOptions));
};
h.prototype.verifyAllEffectsTrigger = function (e, t, i) {
  for (var n = 0; n < e.length; n++) {
    var o = e[n];
    if (this.verifyEffectTrigger(o, t, i)) {
      return !0;
    }
  }
  return !1;
};
h.prototype.verifyExternalDamagesTrigger = function (e, t) {
  t = t || {};
  t.isWeapon = t.isWeapon || this.isWeapon;
  var i, n;
  for (i = 0; i < this.damagesInput.length; i++) {
    if (n = this.damagesInput[i], this.verifyEffectDamageTrigger(n, e, t)) {
      return !0;
    }
  }
  for (i = 0; i < this.counteredDamagesReceived.length; i++) {
    if (n = this.counteredDamagesReceived[i], this.verifyEffectDamageTrigger(n, e, {
      isWeapon: t.isWeapon,
      isCountered: !0
    })) {
      return !0;
    }
  }
  for (i = 0; i < this.sharedDamages.length; i++) {
    for (var o = this.sharedDamages[i], a = 0; a < o.effectDamages.length; a++) {
      if (n = o.effectDamages[a], this.verifyEffectDamageTrigger(n, e, t)) {
        return !0;
      }
    }
  }
  return !1;
};
h.prototype.verifyEffectDamageTrigger = function (e, t, i) {
  if (i = i || {}, t = t || "", !e) {
    return !1;
  }
  var n = this.target;
  i.targetId && (n = new b(i.targetId, {}), n.retrieveStats());
  var o = window.gui.fightManager.getFighter(this.caster.id);
  if (!o) {
    return console.warn("Fighter " + this.caster.id + " does not exist"), !1;
  }
  var a = window.gui.fightManager.getFighter(n.id);
  if (!a) {
    return console.warn("Fighter " + n.id + " does not exist"), !1;
  }
  for (var s, r = o.data, l = a.data, c = l.teamId === r.teamId, d = g.getDistance(this.caster.cellId, n.cellId), u = e.element, h = e.doesDamage(), p = !1, f = t.split("|"), _ = 0; _ < f.length; _++) {
    var v = f[_];
    switch (v.substr(0, 3)) {
      case "D":
        p = h;
        break;
      case "DA":
        p = h && u === M.AIR;
        break;
      case "DBA":
        p = c && h;
        s = parseInt(v.substr(3, 1), 10);
        s && (p = p && u === s);
        break;
      case "DBE":
        p = !c && h;
        s = parseInt(v.substr(3, 1), 10);
        s && (p = p && u === s);
        break;
      case "DC":
        p = i.isWeapon && h;
        break;
      case "DE":
        p = h && u === M.EARTH;
        break;
      case "DF":
        p = h && u === M.FIRE;
        break;
      case "DG":
        p = h && e.origin === w.ORIGIN.GLYPH;
        break;
      case "DI":
        p = h && r.stats.summoned;
        break;
      case "DM":
        p = h && d <= 1;
        break;
      case "DN":
        p = h && u === M.NEUTRAL;
        break;
      case "DP":
        p = h && e.origin === w.ORIGIN.TRAP;
        break;
      case "DR":
        p = h && d > 1;
        break;
      case "Dr":
        p = i.isCountered;
        break;
      case "DS":
        p = h && !i.isWeapon;
        break;
      case "DW":
        p = h && u === M.WATER;
        break;
      case "H":
        p = e.doesHeal();
        break;
      case "HA":
        p = c && e.doesHeal();
        break;
      case "HE":
        p = !c && e.doesHeal();
        break;
      case "MD":
      case "MDM":
        p = h && e.effectId === m.ACTION_CHARACTER_PUSH;
        break;
      case "MDP":
        p = !h && e.effectId === m.ACTION_CHARACTER_PUSH || e.effectId === m.ACTION_FIGHT_PUSH_NO_DAMAGE;
        break;
      case "MP":
        p = e.effectId === m.ACTION_CHARACTER_PUSH || e.effectId === m.ACTION_FIGHT_PUSH_NO_DAMAGE;
    }
    if (p) {
      return !0;
    }
  }
  return !1;
};
h.prototype.verifyEffectTrigger = function (e, t, i) {
  if (i = i || {}, t = t || "", !e) {
    return !1;
  }
  var n = window.gui.fightManager.getFighter(this.caster.id);
  if (!n) {
    return console.warn("Fighter " + this.caster.id + " does not exist"), !1;
  }
  var a = window.gui.fightManager.getFighter(this.target.id);
  if (!a) {
    return console.warn("Fighter " + this.target.id + " does not exist"), !1;
  }
  var s = n.data,
    r = a.data,
    l = r.teamId === s.teamId,
    c = g.getDistance(this.caster.cellId, this.target.cellId),
    d = _.getElementEffect(this.caster, e.effect),
    u = 0 === this.spellId || _.verifySpellEffectMask(e, this.caster.id, this.target.id, i),
    h = _.isInZoneEffect(e, this.target.cellId),
    p = e.isDamageEffect() && h && u,
    f = _.isHealingEffect(e) && h && u,
    v = this.pushedEntities[0],
    y = 0;
  v && (y = o(this.caster, this.target, v.force, v.pushedIndexes[0]));
  for (var w, b = !1, T = t.split("|"), C = 0; C < T.length; C++) {
    var I = T[C];
    switch (I.substr(0, 3)) {
      case "I":
        b = !0;
        break;
      case "D":
        b = p;
        break;
      case "DA":
        b = p && d === M.AIR;
        break;
      case "DBA":
        b = l && p;
        w = parseInt(I.substr(3, 1), 10);
        w && (b = b && d === w);
        break;
      case "DBE":
        b = !l && p;
        w = parseInt(I.substr(3, 1), 10);
        w && (b = b && d === w);
        break;
      case "DC":
        b = this.isWeapon && p;
        break;
      case "DE":
        b = p && d === M.EARTH;
        break;
      case "DF":
        b = p && d === M.FIRE;
        break;
      case "DG":
        b = p && this.isGlyph;
        break;
      case "DI":
        b = p && s.stats.summoned;
        break;
      case "DM":
        b = p && c <= 1;
        break;
      case "DN":
        b = p && d === M.NEUTRAL;
        break;
      case "DP":
        b = p && this.isTrap;
        break;
      case "DR":
        b = p && c > 1;
        break;
      case "DS":
        b = p && !this.isWeapon;
        break;
      case "DW":
        b = p && d === M.WATER;
        break;
      case "H":
        b = f;
        break;
      case "HA":
        b = l && f;
        break;
      case "HE":
        b = !l && f;
        break;
      case "MD":
      case "MDM":
        b = e.effectId === m.ACTION_CHARACTER_PUSH && y;
        break;
      case "MDP":
        b = e.effectId === m.ACTION_CHARACTER_PUSH && !y || e.effectId === m.ACTION_FIGHT_PUSH_NO_DAMAGE;
        break;
      case "MP":
        b = e.effectId === m.ACTION_CHARACTER_PUSH || e.effectId === m.ACTION_FIGHT_PUSH_NO_DAMAGE;
        break;
      case "X":
        b = h && e.effectId === m.ACTION_CHARACTER_KILL;
        break;
      case "A":
        b = h && e.effectId === m.ACTION_CHARACTER_ACTION_POINTS_LOST;
        break;
      case "m":
        b = h && e.effectId === m.ACTION_CHARACTER_MOVEMENT_POINTS_LOST;
    }
    if (b) {
      return !0;
    }
  }
  return !1;
};
this.target.lifePointsAfterDamages.min = i - this.target.lifeLost.min;
this.target.lifePointsAfterDamages.max = i - this.target.lifeLost.max;
this.caster.lifePointsAfterDamages.min = o - this.caster.lifeLost.min;
this.caster.lifePointsAfterDamages.max = o - this.caster.lifeLost.max;
l.convertDamageToHeal();
r = "sharedsteal" + s.element + "-" + s.effectId;
t[r] ? t[r].lifePointsAdded.addFromDamage(l.lifePointsAdded) : t[r] = l;
c.type = w.TYPE.SHARED;
r = "shared" + s.element + "-" + s.effectId;
e[r] ? e[r].damage.addFromDamage(c.damage) : e[r] = c;
i = this.splashDamages[o];
i = this._computeDamage(i, {
  ignoreCasterStats: !0
});
e["splash" + i.element + "-" + i.effectId] = i;
i.type = w.TYPE.SPLASH;
i = this.splashDamages[o];
t.lifePointsAdded.addFromDamage(i.lifePointsAdded);
i.damage.max = Math.min(a, e.damage.max);
i.damage.min = Math.min(a, e.damage.min);
i.type = e.type;
i.origin = e.origin;
u.counteredDamagesGiven.push(i);
a.applyMultiplier(o);
a.addFrom(t.data.stats.baseMaxLifePoints - t.data.stats.maxLifePoints);
a.addFromDamage(u.target.spellErosionLifePoints);
i.damage = n(a, e.erosionPercent, 100, 1);
i.damageWithoutResist = i.damage.clone();
i = u.applyResistanceAndReduction(i);
this.damagesOutputTo = b.source;
this.damagesOutput = [];
R.damage.min = O - this.spellTargetEffectsDurationReduction > 0 ? L.min : 0;
R.damage.max = O - this.spellTargetEffectsDurationReduction > 0 ? L.max : 0;
R.type = w.TYPE.BUFF;
n = this.lifeStealingDamagesReceived[t];
n.convertDamageToHeal();
a.addEffectDamage(n);
u.damage.addFrom(~~d);
a.addEffectDamage(u);
n = this.counteredDamagesReceived[t];
n = n.type !== w.TYPE.SHARED ? this.applyResistanceAndReduction(n) : n.clone();
n.type = w.TYPE.COUNTERED;
s["countered-" + t + "-" + n.effectId] = n;
e.withTargetBuffs && !e.onlyShareableEffects && this._computeTargetBuffs(s, r, l, a, v);
l.doesHeal() && a.addEffectDamage(l);
n = a.effectDamages[t];
n.effectId !== m.ACTION_CHARACTER_PUSH && (n.damage.reset(), n.damageWithoutResist.reset(), n.erosionPercent.reset());
a.updateDamage();
this.caster.lifePointsAfterDamages.substractFromDamage(a.damage);
a.addEffectDamage(b);
this.caster.lifePointsAfterDamages.substractFromDamage(b.damage);
a.addEffectDamage(M);
this.target.lifePointsAfterDamages.substractFromDamage(M.damage);
a.effectDamages[t].damage.reset();
a.effectDamages[t].damageWithoutResist.reset();
o += this.getAverageBuffElementReduction(e, this.sharedFighters);
this.isCriticalEffect && (o += c("criticalDamageFixedResist", this.sharedFighters));
u = Math.max(0, this.caster.strength);
a = this.caster.strengthBonus + (this.caster.newStatsBonus.strengthBonus || 0);
r = this.caster.criticalStrengthBonus + (this.caster.newStatsBonus.criticalStrengthBonus || 0);
c = this.target.neutralElementResistPercent;
h = this.target.neutralElementReduction;
T = this.caster.neutralDamageBonus;
u = Math.max(0, this.caster.strength);
a = this.caster.strengthBonus + (this.caster.newStatsBonus.strengthBonus || 0);
r = this.caster.criticalStrengthBonus + (this.caster.newStatsBonus.criticalStrengthBonus || 0);
c = this.target.earthElementResistPercent;
h = this.target.earthElementReduction;
T = this.caster.earthDamageBonus;
u = Math.max(0, this.caster.intelligence);
a = this.caster.intelligenceBonus + (this.caster.newStatsBonus.intelligenceBonus || 0);
r = this.caster.criticalIntelligenceBonus + (this.caster.newStatsBonus.criticalIntelligenceBonus || 0);
c = this.target.fireElementResistPercent;
h = this.target.fireElementReduction;
T = this.caster.fireDamageBonus;
u = Math.max(0, this.caster.chance);
a = this.caster.chanceBonus + (this.caster.newStatsBonus.chanceBonus || 0);
r = this.caster.criticalChanceBonus + (this.caster.newStatsBonus.criticalChanceBonus || 0);
c = this.target.waterElementResistPercent;
h = this.target.waterElementReduction;
T = this.caster.waterDamageBonus;
u = Math.max(0, this.caster.agility);
a = this.caster.agilityBonus + (this.caster.newStatsBonus.agilityBonus || 0);
r = this.caster.criticalAgilityBonus + (this.caster.newStatsBonus.criticalAgilityBonus || 0);
c = this.target.airElementResistPercent;
h = this.target.airElementReduction;
T = this.caster.airDamageBonus;
o = u + .8 * k + C;
o += this.isWeapon || !this.spellId ? this.caster.weaponDamagesBonus : this.caster.spellDamagesBonus;
h += this.getBuffElementReduction(e, this.target.id);
c = 100 - (c + S);
this.target.type === w.FIGHT_CHARACTER_TYPE && (c = Math.max(w.MAX_RESISTANCE, c));
z.min = s(e.damage.min, N.stats.maxLifePoints - L, H);
z.max = s(e.damage.max, N.stats.maxLifePoints - O, H);
z.min = s(e.damage.min, L, H);
z.max = s(e.damage.max, O, H);
z.min = s(e.damage.min, R, H);
z.max = s(e.damage.max, D, H);
z.min = d(e.damage.min, {
  ignoreStats: t.ignoreCasterStats,
  stat: o,
  statBonus: a,
  baseDamageBonus: b,
  damageBonus: T,
  dealtDamageMultiplierBonus: A,
  allDamagesBonus: _,
  efficiencyPercent: H,
  comboBonus: W
});
z.max = d(e.damage.max, {
  ignoreStats: t.ignoreCasterStats,
  stat: o,
  statBonus: a,
  baseDamageBonus: b,
  damageBonus: T,
  dealtDamageMultiplierBonus: A,
  allDamagesBonus: _,
  efficiencyPercent: H,
  comboBonus: W
});
G.min -= h;
G.max -= h;
G.applyMultiplier(c / 100);
G.unsignedNumber();
w.EFFECTS_IDS.MP_BASED_DAMAGE[P] && G.applyMultiplier(x);
w.EFFECTS_IDS.TARGET_EROSION_DAMAGE[P] ? (U = this.target.lifeLost.clone(), U.applyMultiplier(q), U.addFrom(e.erosionLifePoints), U.addFromDamage(this.target.spellErosionLifePoints), G = n(U, e.erosionPercent, c, I)) : w.EFFECTS_IDS.CASTER_EROSION_DAMAGE[P] ? (U = this.caster.lifeLost.clone(), U.applyMultiplier(Y), U.addFrom(e.erosionLifePoints), this.target.id === this.caster.id && U.addFromDamage(this.target.spellErosionLifePoints), G = n(U, e.erosionPercent, c, I)) : (this.target.spellErosionLifePoints.min += G.min * q, this.target.spellErosionLifePoints.max += G.max * q);
z.truncate();
G.truncate();
t = t || {};
t.isWeapon = t.isWeapon || this.isWeapon;
p = c && h;
s = parseInt(v.substr(3, 1), 10);
s && (p = p && u === s);
p = !c && h;
s = parseInt(v.substr(3, 1), 10);
s && (p = p && u === s);
b = l && p;
w = parseInt(I.substr(3, 1), 10);
w && (b = b && d === w);
b = !l && p;
w = parseInt(I.substr(3, 1), 10);
w && (b = b && d === w);
n.prototype.addSharedDamages = function (e, t) {
  for (var i = this.getSpellDamage({
      onlyShareableEffects: !0
    }), n = 0; n < this.target.buffs.length; n++) {
    var o = this.target.buffs[n],
      a = o.source;
    o.actionId === r.ACTION_CHARACTER_SHARE_DAMAGES && (t[a] || (t[a] = [], e[a] = []), t.indexOf(this.target.id) === -1 && t[a].push(this.target.id), this.verifyBuffTrigger(o) && i && e[a].push(i), this.sharedDamages = e[a], this.sharedFighters = t[a]);
  }
};
n.prototype.addSplashDamages = function (e) {
  for (var t = 0; t < this.effectInstances.length; t++) {
    var i = this.effectInstances[t],
      n = o.EFFECTS_IDS.SPLASH[i.effectId],
      r = o.EFFECTS_IDS.SPLASH_HEAL[i.effectId],
      l = o.EFFECTS_IDS.SPLASH_FINAL[i.effectId];
    if (i.isDirectEffect() && (n || r || l) && a.isInZoneEffect(i, this.target.cellId) && a.verifySpellEffectMask(i, this.caster.id, this.target.id, this.effectMaskOptions)) {
      for (var c = a.getShapeEfficiency(i.rawZone, this.spellCenterCellId, this.target.cellId), d = 0; d < e.length; d++) {
        var u = e[d];
        if (!(!u.finalSpellDamageWithoutBuff || d > 0 && !u.isGlyph)) {
          for (var h = u.caster.damageBoostPercent > 0 ? (100 + u.caster.damageBoostPercent) / 100 : 1, p = u.caster.damageDeboostPercent > 0 ? Math.max(0, (100 - u.caster.damageDeboostPercent) / 100) : 1, m = 1 / (h * p), f = u.finalSpellDamageWithoutBuff, g = 0; g < f.effectDamages.length; g++) {
            var _ = f.effectDamages[g],
              v = n ? _.damageWithoutResist.clone() : _.damage.clone();
            if (v.applyMultiplier(m), (v.min || v.max) && 5 !== _.effectId) {
              v.applyMultiplier(i.diceNum / 100);
              var y = "splash-" + u.caster.id + "-" + u.spellId + "-" + i.targetMask + "-" + i.effectId;
              _ = new s(y, _.effectId, _.element, _.random);
              _.damage = v;
              _.efficiencyMultiplier = c;
              r && _.convertDamageToHeal();
              this.splashDamages.push(_);
            }
          }
        }
      }
      this.isAccurate = !0;
    }
  }
};
n.prototype.addLifeStealingDamagesReceived = function (e) {
  for (var t in e) {
    this.lifeStealingDamagesReceived.push(e[t]);
  }
};
n.prototype.addCounteredDamagesReceived = function (e) {
  for (var t = 0; t < e.length; t++) {
    this.counteredDamagesReceived.push(e[t]);
  }
};
n.prototype.addInterceptionDamages = function (e) {
  for (var t = 0; t < e.length; t++) {
    for (var i = e[t], n = !1, o = 0; o < this.damagesInput.length; o++) {
      var a = this.damagesInput[o];
      if (a.nameId === i.nameId) {
        a.damage.addFromDamage(i.damage);
        n = !0;
        break;
      }
    }
    n || this.damagesInput.push(i);
  }
};
_ = new s(y, _.effectId, _.element, _.random);
_.damage = v;
_.efficiencyMultiplier = c;
r && _.convertDamageToHeal();
this.splashDamages.push(_);
a.damage.addFromDamage(i.damage);
n = !0;
n.prototype.getTrapSpells = function (e) {
  for (var t = window.gui.damagePreview.damagePreviewManager, i = window.gui.playerData.characters, n = [], a = !1, r = 0; r < this.pushedEntities.length; r++) {
    var l = this.pushedEntities[r],
      c = window.actorManager.getActor(l.id);
    if (c) {
      for (var d = 0; d < l.marks.length; d++) {
        var u = l.marks[d],
          h = u.sourceId;
        if (u.type === o.MARK.TRAP) {
          n[u.spellId] = n[u.spellId] || [];
          var p = i.mainCharacter.spellData.spells[u.spellId],
            m = c.getFighter().spells[u.spellId],
            f = m ? m.level : 1;
          p && i.mainCharacterId === h && (f = p.level);
          n[u.spellId].push({
            caster: h,
            target: l.id,
            casterCellId: u.markCell,
            targetCellId: u.markCell,
            level: f
          });
          t.affectedByMark(c.actorId, u);
          a = !0;
        }
      }
    }
  }
  return a ? void t.createSpells(Object.keys(n), function (i, o) {
    if (i) {
      return e(i);
    }
    var a = [];
    for (var r in o) {
      if (o.hasOwnProperty(r)) {
        var l = o[r].spellLevel.effects[0];
        if (l && l.effectId === s.ACTION_FIGHT_ADD_TRAP_CASTING_SPELL) {
          var c = l.diceNum;
          a[c] = n[r];
        }
      }
    }
    t.createSpells(Object.keys(a), function (t, i) {
      if (t) {
        return e(t);
      }
      var n = [];
      for (var o in i) {
        if (i.hasOwnProperty(o)) {
          for (var s = 0; s < a[o].length; s++) {
            var r = a[o][s],
              l = i[o].clone();
            l.setLevel(r.level);
            l.ownerId = r.caster;
            n.push({
              spell: l,
              casterCellId: r.casterCellId,
              targetCellId: r.targetCellId,
              target: r.target
            });
          }
        }
      }
      return e(null, n);
    });
  }) : e();
};
n.prototype.getBombSpells = function (e) {
  var t = window.actorManager,
    i = window.gui.fightManager,
    n = window.gui.damagePreview.damagePreviewManager,
    r = window.gui.databases.SpellBombs,
    l = [],
    c = !1;
  if (this.caster.isBomb) {
    return e();
  }
  var d, u, h, p, m, f;
  for (d = 0; d < this.pushedEntities.length; d++) {
    var g = this.pushedEntities[d],
      _ = t.getActor(g.id);
    if (_) {
      for (u = 0; u < g.marks.length; u++) {
        var v = g.marks[u];
        if (v.type === o.MARK.BOMB) {
          var y = o.MARK_TO_BOMB[v.spellId],
            w = a.getBombFromWall(v.sourceId, v.markCell, y),
            b = i.getFighter(w);
          if (b && !a.isBombOf(_, y, v.sourceId)) {
            p = a.getChainReactionBomb(v.sourceId, w);
            m = a.getComboCoeffBomb(p, y);
            var M = n.getVirtualCellFromRealCell(_.cellId);
            l[v.spellId] = l[v.spellId] || [];
            l[v.spellId].push({
              caster: b.data.stats.summoner,
              target: g.id,
              casterCellId: M,
              targetCellId: M,
              level: b.level,
              comboBonus: m
            });
            n.affectedByMark(_.actorId, v);
            c = !0;
          }
        }
      }
    }
  }
  for (d = 0; d < this.effectInstances.length; d++) {
    var T = this.effectInstances[d];
    if (T.isDirectEffect() && this.spellCenterCellId === this.target.cellId && a.isInZoneEffect(T, this.target.cellId) && a.verifySpellEffectMask(T, this.caster.id, this.target.id, this.effectMaskOptions) && (this.verifyAllEffectsTrigger(this.effectInstances, T.triggers, this.effectMaskOptions) || this.verifyExternalDamagesTrigger(T.triggers, {
      isWeapon: !1
    }))) {
      if (T.effectId === s.ACTION_SUMMON_BOMB) {
        if (f = T.diceNum, h = r[f], !h) {
          continue;
        }
        l[h.instantSpellId] = l[h.instantSpellId] || [];
        l[h.instantSpellId].push({
          caster: this.caster.id,
          casterCellId: this.caster.cellId,
          targetCellId: this.target.cellId,
          level: this.spellLevel,
          comboBonus: 0
        });
        c = !0;
        break;
      }
      if (this.target.isBomb && T.effectId === s.ACTION_CHARACTER_ACTIVATE_BOMB) {
        var C = t.getActor(this.target.id),
          I = i.getFighter(this.caster.id);
        if (h = r[C ? C.data.creatureGenericId : 0], !h) {
          continue;
        }
        var A = I.isSummon() ? I.data.stats.summoner : this.caster.id;
        for (p = a.getChainReactionBomb(A, this.target.id), m = a.getComboCoeffBomb(p), u = 0; u < p.length; u++) {
          f = p[u];
          var S = t.getActor(f);
          if (S && r[S.data.creatureGenericId]) {
            var E = r[S.data.creatureGenericId];
            l[E.explodSpellId] = l[E.explodSpellId] || [];
            l[E.explodSpellId].push({
              caster: f,
              casterCellId: S.cellId,
              targetCellId: S.cellId,
              level: S.getFighter().level,
              comboBonus: m
            });
          }
        }
        c = !0;
        break;
      }
    }
  }
  return c ? void n.createSpells(Object.keys(l), function (t, i) {
    if (t) {
      return e(t);
    }
    var n = [];
    for (var o in i) {
      if (i.hasOwnProperty(o)) {
        for (d = 0; d < l[o].length; d++) {
          var a = l[o][d],
            s = i[o].clone();
          s.setLevel(a.level);
          s.ownerId = a.caster;
          n.push({
            spell: s,
            casterCellId: a.casterCellId,
            targetCellId: a.targetCellId,
            comboBonus: a.comboBonus,
            target: a.target
          });
        }
      }
    }
    return e(null, n);
  }) : e();
};
n.prototype.getGlyphSpellsFromMarks = function (e) {
  for (var t = window.gui.damagePreview.damagePreviewManager, i = [], n = !1, r = 0; r < this.effectInstances.length; r++) {
    var l = this.effectInstances[r];
    if (l.effectId === s.ACTION_FORCE_GLYPH_TRIGGER && l.isDirectEffect() && a.verifySpellEffectMask(l, this.caster.id, this.target.id, this.effectMaskOptions) && (this.verifyAllEffectsTrigger(this.effectInstances, l.triggers, this.effectMaskOptions) || this.verifyExternalDamagesTrigger(l.triggers, {
      isWeapon: !1
    }))) {
      for (var c = window.background.zones, d = 0; d < c.length; d++) {
        var u = c[d],
          h = u.data.sourceId,
          p = window.gui.fightManager.getFighter(h),
          m = u.data.spellId,
          f = u.data.markCell;
        if (a.isInGlyph(this.caster.id, m, this.caster.cellId) && u.data.type === o.MARK.GLYPH && h === this.caster.id && !i[m]) {
          var g = p && p.spells[m] ? p.spells[m].level : 1;
          i[m] = {
            casterId: h,
            level: g,
            targetCellId: f
          };
          n = !0;
        }
      }
    }
  }
  return n ? void t.createSpells(Object.keys(i), function (t, n) {
    if (t) {
      return e(t);
    }
    var o = [];
    for (var a in n) {
      if (n.hasOwnProperty(a)) {
        var s = n[a];
        s.setLevel(i[a].level);
        s.ownerId = i[a].casterId;
        o.push({
          spell: s,
          casterId: i[a].casterId,
          targetCellId: i[a].targetCellId
        });
      }
    }
    return e(null, o);
  }) : e();
};
n.prototype.getTriggeredSpellsByGlyphs = function (e) {
  for (var t = this, i = window.gui.damagePreview.damagePreviewManager, n = [], s = !1, r = 0; r < this.effectInstances.length; r++) {
    var l = this.effectInstances[r],
      c = l.getParams();
    l.isDirectEffect() && o.EFFECTS_IDS.GLYPH_TRIGGERING_SPELLS[l.effectId] && a.isInZoneEffect(l, this.spellCenterCellId) && (n[c[0]] = {
      level: c[1]
    }, s = !0);
  }
  return s ? void i.createSpells(Object.keys(n), function (i, o) {
    if (i) {
      return e(i);
    }
    var a = [];
    for (var s in o) {
      if (o.hasOwnProperty(s)) {
        var r = o[s];
        r.setLevel(n[s].level);
        r.ownerId = t.caster.id;
        a.push({
          spell: r,
          casterId: t.caster.id
        });
      }
    }
    return e(null, a);
  }) : e();
};
n.prototype.getTriggeredSpellsByCasterOnTarget = function (e) {
  for (var t = this, i = window.actorManager, n = window.gui.damagePreview.damagePreviewManager, s = [], r = i.getActor(this.target.id).cellId, l = !1, c = 0; c < this.effectInstances.length; c++) {
    var d = this.effectInstances[c],
      u = d.getParams(),
      h = o.EFFECTS_IDS.TRIGGERING_SPELL[d.effectId];
    void 0 !== h && d.isDirectEffect() && a.isInZoneEffect(d, r) && a.verifySpellEffectMask(d, this.caster.id, this.target.id, this.effectMaskOptions) && (this.verifyAllEffectsTrigger(this.effectInstances, d.triggers, this.effectMaskOptions) || this.verifyExternalDamagesTrigger(d.triggers, {
      isWeapon: !1
    })) && (s[u[0]] = {
      spellType: h,
      level: u[1]
    }, l = !0);
  }
  return l ? void n.createSpells(Object.keys(s), function (o, a) {
    if (o) {
      return e(o);
    }
    var r = [];
    for (var l in a) {
      var c = a[l],
        d = s[l].spellType,
        u = 2 & d ? t.target.id : t.caster.id,
        h = 1 & d ? t.target.id : t.caster.id,
        p = n.getVirtualCellFromRealCell(i.getActor(h).cellId),
        m = n.getVirtualCellFromRealCell(i.getActor(u).cellId);
      c.setLevel(s[l].level);
      c.ownerId = h;
      r.push({
        spell: c,
        casterId: h,
        targetId: u,
        casterCellId: p,
        targetCellId: m
      });
    }
    return e(null, r);
  }) : e();
};
n.prototype.getTargetTriggeredSpellsByBuffs = function (e, t) {
  for (var i = this, n = window.actorManager, a = window.gui.damagePreview.damagePreviewManager, s = [], r = !1, l = 0; l < this.target.buffs.length; l++) {
    var c = this.target.buffs[l],
      d = o.EFFECTS_IDS.TRIGGERING_SPELL[c.effect.effectId];
    if (!e[c.uid] && void 0 !== d && this.verifyBuffTrigger(c)) {
      var u = c.effect.getParams();
      s[u[0]] = {
        spellType: d,
        level: u[1]
      };
      r = !0;
      e[c.uid] = !0;
    }
  }
  return r ? void a.createSpells(Object.keys(s), function (e, o) {
    if (e) {
      return t(e);
    }
    var r = [];
    for (var l in o) {
      var c = o[l],
        d = s[l].spellType,
        u = 2 & d ? i.target.id : i.caster.id,
        h = 1 & d ? i.target.id : i.caster.id,
        p = a.getVirtualCellFromRealCell(n.getActor(h).cellId),
        m = a.getVirtualCellFromRealCell(n.getActor(u).cellId);
      c.setLevel(s[l].level);
      c.ownerId = h;
      r.push({
        spell: c,
        casterId: h,
        targetId: u,
        casterCellId: p,
        targetCellId: m
      });
    }
    return t(null, r);
  }) : t();
};
p && i.mainCharacterId === h && (f = p.level);
n[u.spellId].push({
  caster: h,
  target: l.id,
  casterCellId: u.markCell,
  targetCellId: u.markCell,
  level: f
});
t.affectedByMark(c.actorId, u);
a = !0;
l.setLevel(r.level);
l.ownerId = r.caster;
n.push({
  spell: l,
  casterCellId: r.casterCellId,
  targetCellId: r.targetCellId,
  target: r.target
});
p = a.getChainReactionBomb(v.sourceId, w);
m = a.getComboCoeffBomb(p, y);
l[v.spellId] = l[v.spellId] || [];
l[v.spellId].push({
  caster: b.data.stats.summoner,
  target: g.id,
  casterCellId: M,
  targetCellId: M,
  level: b.level,
  comboBonus: m
});
n.affectedByMark(_.actorId, v);
c = !0;
l[h.instantSpellId] = l[h.instantSpellId] || [];
l[h.instantSpellId].push({
  caster: this.caster.id,
  casterCellId: this.caster.cellId,
  targetCellId: this.target.cellId,
  level: this.spellLevel,
  comboBonus: 0
});
c = !0;
l[E.explodSpellId] = l[E.explodSpellId] || [];
l[E.explodSpellId].push({
  caster: f,
  casterCellId: S.cellId,
  targetCellId: S.cellId,
  level: S.getFighter().level,
  comboBonus: m
});
s.setLevel(a.level);
s.ownerId = a.caster;
n.push({
  spell: s,
  casterCellId: a.casterCellId,
  targetCellId: a.targetCellId,
  comboBonus: a.comboBonus,
  target: a.target
});
i[m] = {
  casterId: h,
  level: g,
  targetCellId: f
};
n = !0;
s.setLevel(i[a].level);
s.ownerId = i[a].casterId;
o.push({
  spell: s,
  casterId: i[a].casterId,
  targetCellId: i[a].targetCellId
});
r.setLevel(n[s].level);
r.ownerId = t.caster.id;
a.push({
  spell: r,
  casterId: t.caster.id
});
c.setLevel(s[l].level);
c.ownerId = h;
r.push({
  spell: c,
  casterId: h,
  targetId: u,
  casterCellId: p,
  targetCellId: m
});
s[u[0]] = {
  spellType: d,
  level: u[1]
};
r = !0;
e[c.uid] = !0;
c.setLevel(s[l].level);
c.ownerId = h;
r.push({
  spell: c,
  casterId: h,
  targetId: u,
  casterCellId: p,
  targetCellId: m
});
c = f.getNearestCellInDirection(r, p.DIRECTION_NORTH_WEST);
d = f.getNearestCellInDirection(r, p.DIRECTION_SOUTH_WEST);
c = f.getNearestCellInDirection(r, p.DIRECTION_NORTH_WEST);
d = f.getNearestCellInDirection(r, p.DIRECTION_NORTH_EAST);
c = f.getNearestCellInDirection(r, p.DIRECTION_NORTH_EAST);
d = f.getNearestCellInDirection(r, p.DIRECTION_SOUTH_EAST);
c = f.getNearestCellInDirection(r, p.DIRECTION_SOUTH_WEST);
d = f.getNearestCellInDirection(r, p.DIRECTION_SOUTH_EAST);
r && n.push(r);
a = f.getNearestCellInDirection(a, i);
s++;
d.prototype.getPushedEntities = function (e, t, i, n, o) {
  var a = this.transposition;
  this.transposition = this.transposition.slice(0);
  var s = [];
  return this._pushedEffects(e, t, i, n, o, s), this._pulledEffects(e, t, i, n, o, s), this.transposition = a, s;
};
d.prototype._pushedEffects = function (e, t, i, n, a, s) {
  for (var d, u, h, p, m, _ = window.isoEngine.mapRenderer.map.cells, w = window.actorManager, b = g.getActorOnCell(n), M = a.isCriticalEffect ? e.getEffectInstances().criticalEffects : e.getEffectInstances().effects, T = 0; T < M.length; T++) {
    var C = M[T];
    if (C.isDirectEffect()) {
      var I = C.effectId === y.ACTION_CHARACTER_PUSH,
        A = C.effectId === y.ACTION_FIGHT_PUSH_NO_DAMAGE,
        S = C.effectId === y.ACTION_CHARACTER_GET_PUSHED;
      if (I || A || S) {
        var E = C.diceNum,
          N = C.getZoneEffect(),
          x = N.zoneShape;
        if (0 === E) {
          continue;
        }
        var L = S ? i : n,
          O = o(_, i, L, N),
          R = c(x) || S ? n : i;
        u = f.fromCellId(R);
        for (var D = b && g.verifySpellEffectMask(C, t, b.actorId, a), P = 0; P < O.length; P++) {
          var B = O[P];
          if (B !== i || i !== n) {
            d = g.getActorOnCell(B);
            var k = d && g.verifySpellEffectMask(C, t, d.actorId, a);
            if (k && (!S || D)) {
              h = f.advancedOrientationTo(f.fromCellId(B), u, {
                fourDir: !1
              });
              var F = this._getPushForce(B, d.getFighter(), M, C),
                H = this._retrievePushedEntitiesInLine(d, F, h, O, !A);
              H.length && (this.changePosition(H[0].id, H[0].newCellId), s.push.apply(s, H));
            }
          }
        }
      }
      if (C.effectId === y.ACTION_CHARACTER_PUSH_UP_TO) {
        var z = f.fromCellId(n);
        u = f.fromCellId(i);
        h = f.advancedOrientationTo(z, u, {
          fourDir: !1
        });
        var W = r(i, 1, h);
        if (d = W[0], !l(d)) {
          continue;
        }
        var G = f.getNearestCellInDirection(f.fromCellId(d.cellId), h);
        if (p = new v(d.actorId, 0, 0, !1, G.cellId), s.push(p), m = this.hasPathAMark(d, d.cellId, n, h, [n]), !m) {
          continue;
        }
        p.newCellId = m.cellId;
        p.marks = m.marks;
      }
      if (C.effectId === y.ACTION_THROW_CARRIED_CHARACTER) {
        d = w.getActor(t);
        var U = d && d.carriedActor;
        if (!U) {
          continue;
        }
        p = new v(U.actorId, 0, 0, !1, n);
        s.push(p);
        m = this.getMarksCell(U.actorId, n);
        m.length && (p.marks = m);
      }
    }
  }
};
d.prototype._pulledEffects = function (e, t, i, a, s, r) {
  for (var d = window.isoEngine.mapRenderer.map.cells, u = g.getActorOnCell(a), h = s.isCriticalEffect ? e.getEffectInstances().criticalEffects : e.getEffectInstances().effects, p = 0; p < h.length; p++) {
    var m = h[p],
      _ = m.effectId === y.ACTION_CHARACTER_PULL,
      w = m.effectId === y.ACTION_CHARACTER_GET_PULLED;
    if (m.isDirectEffect() && (_ || w)) {
      var b = m.diceNum,
        M = m.getZoneEffect(),
        T = M.zoneShape;
      if (0 !== b) {
        for (var C = w ? i : a, I = o(d, i, C, M, {
            reverseSort: !0
          }), A = c(T) || w ? a : i, S = f.fromCellId(A), E = u && g.verifySpellEffectMask(m, t, u.actorId, s), N = 0; N < I.length; N++) {
          var x = I[N];
          if (x !== i || i !== a) {
            var L = g.getActorOnCell(x),
              O = L && g.verifySpellEffectMask(m, t, L.actorId, s);
            if (O && (!w || E) && l(L)) {
              var R = f.fromCellId(x),
                D = f.advancedOrientationTo(S, R, {
                  fourDir: !1
                }),
                P = new v(L.actorId, 0, 0, !1, x);
              r.push(P);
              this.changePosition(L.actorId, x);
              for (var B = 0; B < b; B++) {
                var k = R;
                if (R = f.getNearestCellInDirection(k, D), n(R.cellId, k.cellId)) {
                  break;
                }
                for (var F = !1, H = 0; H < r.length; H++) {
                  var z = r[H];
                  if (z.actorId !== L.actorId && z.newCellId === R.cellId) {
                    F = !0;
                    break;
                  }
                }
                if (!F) {
                  P.newCellId = R.cellId;
                  this.changePosition(L.actorId, R.cellId);
                  var W = this.getMarksCell(L.actorId, R.cellId);
                  if (W.length) {
                    P.marks = W;
                    break;
                  }
                }
              }
            }
          }
        }
      }
    }
  }
};
d.prototype.isEntityInSpellZone = function (e, t) {
  var i = window.actorManager.getActor(e);
  if (!i) {
    return !1;
  }
  var n = this.getVirtualCellFromRealCell(i.cellId);
  return t && t.indexOf(n) > -1;
};
d.prototype.getMarksCell = function (e, t) {
  for (var i = window.background.zones, n = [], o = 0; o < i.length; o++) {
    var a = i[o],
      s = a.data;
    if (s) {
      var r = s.markCell,
        l = s.markSize;
      (r === t && s.type === _.MARK.BOMB && !this.hasAlreadyBeenAffectedByMark(s, e) || l >= m.getDistance(t, r) && s.type === _.MARK.TRAP && !this.hasAlreadyBeenAffectedByMark(s)) && n.push(s);
    }
  }
  return n;
};
d.prototype._retrievePushedEntitiesInLine = function (e, t, i, o, r) {
  function c(e) {
    for (w = 0; w < u.length; w++) {
      if (y = u[w], y.id === e) {
        return y;
      }
    }
    return null;
  }
  var d = this.getVirtualCellFromRealCell(e.cellId),
    u = [],
    h = l(e);
  if (!h) {
    return u;
  }
  var p,
    m,
    _,
    y,
    w,
    b = f.fromCellId(d),
    M = f.getNearestCellInDirection(b, i),
    T = t;
  for (w = 0; w < t; w++) {
    if (M) {
      if (n(M.cellId, p ? p.cellId : d)) {
        break;
      }
      T--;
      p = M;
      M = f.getNearestCellInDirection(M, i);
    }
  }
  if (T <= 0 && p) {
    return y = new v(e.actorId, 0, 0, r, p.cellId), u.push(y), m = this.hasPathAMark(e, d, p.cellId, i, o), m && (y.marks = m.marks, y.newCellId = m.cellId), u;
  }
  var C,
    I = [];
  b = f.fromCellId(d);
  var A = new v(e.actorId, 0, t, r, b.cellId);
  u.push(A);
  var S = 1;
  if (_ = s(b.cellId, t, i), m = this.hasPathAMark(e, b.cellId, _, i, o)) {
    return A.marks = m.marks, A.newCellId = m.cellId, A.force = 0, u;
  }
  for (var E = 0; E < t && (0 === E ? (p = b, M = f.getNearestCellInDirection(b, i)) : M && (p = M, M = f.getNearestCellInDirection(M, i)), M); E++) {
    var N = s(b.cellId, t, i);
    if (n(M.cellId, p.cellId)) {
      C = g.getActorOnCell(M.cellId);
      var x = !1;
      if (C) {
        x = this.isEntityInSpellZone(C.actorId, o);
        var L = l(C);
        if (L) {
          _ = s(M.cellId, t, i);
          var O = a(M.cellId, _, i),
            R = this.hasPathAMark(C, M.cellId, _, i, o);
          if (x && !O && !R) {
            A.newCellId = _;
            A.force = 0;
            break;
          }
        }
        if (y = c(C.actorId), y ? (y.pushedIndexes.push(S), y.newCellId = M.cellId) : (y = new v(C.actorId, S, t, r, M.cellId), y.pushingEntity = u[0], u.push(y)), S++, !L) {
          break;
        }
      } else if (0 === E) {
        A.newCellId = p.cellId;
        break;
      }
      if (!x) {
        var D = f.getNearestCellInDirection(M, i);
        if (D && !n(D.cellId, M.cellId)) {
          break;
        }
      }
    } else {
      E === t - 1 || C && C.actorId !== e.actorId || !a(M.cellId, N, i) ? a(b.cellId, N, i) || (A.force = 0) : I && I.indexOf(M.cellId) === -1 && (A.newCellId = M.cellId, I.push(M.cellId));
    }
    if (0 === A.force || A.mark) {
      break;
    }
  }
  var P = I.length;
  if (P > 0) {
    for (w = 0; w < u.length; w++) {
      u[w].force -= P;
    }
  }
  return u;
};
d.prototype._getPushForce = function (e, t, i, o) {
  var a,
    s,
    r = i.indexOf(o),
    c = -1;
  for (s = 0; s < i.length; s++) {
    var d = i[s];
    if (d.isDirectEffect() && d.effectId === y.ACTION_CHARACTER_PULL) {
      c = s;
      a = d;
      break;
    }
  }
  var u = o.diceNum,
    h = t && window.actorManager.getActor(t.id);
  if (t && c !== -1 && c < r && l(h)) {
    var p = a.diceNum,
      m = this.getVirtualCellFromRealCell(t.data.disposition.cellId),
      g = f.fromCellId(m),
      _ = f.fromCellId(e),
      v = g,
      w = f.advancedOrientationTo(_, g, {
        fourDir: !1
      }),
      b = 0;
    for (s = 0; s < p; s++) {
      var M = f.getNearestCellInDirection(v, w);
      if (!M || n(M.cellId, v.cellId)) {
        break;
      }
      b++;
      v = M;
    }
    return u - b;
  }
  return u;
};
d.prototype.hasPathAMark = function (e, t, i, o, a) {
  for (var s, r = f.fromCellId(t); r.cellId !== i && (s = r, r = f.getNearestCellInDirection(r, o));) {
    var l = g.getActorOnCell(r.cellId),
      c = l && this.isEntityInSpellZone(l.actorId, a) && !this.hasPathAMark(l, r.cellId, i, o, a);
    if (n(r.cellId, s.cellId) && !c) {
      break;
    }
    var d = this.getMarksCell(e.actorId, r.cellId);
    if (d.length) {
      return {
        marks: d,
        cellId: r.cellId
      };
    }
  }
  return null;
};
u = f.fromCellId(i);
h = f.advancedOrientationTo(z, u, {
  fourDir: !1
});
p.newCellId = m.cellId;
p.marks = m.marks;
p = new v(U.actorId, 0, 0, !1, n);
s.push(p);
m = this.getMarksCell(U.actorId, n);
m.length && (p.marks = m);
r.push(P);
this.changePosition(L.actorId, x);
P.newCellId = R.cellId;
this.changePosition(L.actorId, R.cellId);
T--;
p = M;
M = f.getNearestCellInDirection(M, i);
A.newCellId = _;
A.force = 0;
c = s;
a = d;
b++;
v = M;
this.id = e;
this.pushedIndexes = [t];
this.force = i;
this.doesDamage = n;
this.newCellId = a;
this.pushingEntity = [];
this.marks = [];
this.damage = new o();
a.call(this, "div", {
  className: ["DamagePreviewTooltip", "TooltipBox"]
});
this.fighterId = e;
this.insideConfirmBox = !1;
this._initialized = !1;
this._initialization();
o(n, a);
e.exports = n;
n.prototype._initialization = function () {
  this._initialized || (this.content = this.createChild("div"), this._initialized = !0);
};
n.prototype.update = function (e, t, i, n) {
  this.insideConfirmBox = n.insideConfirmBox;
  var o = window.actorManager.getActor(this.fighterId),
    r = window.gui.fightManager.getFighter(this.fighterId);
  if (!r || !o || !i || i.length <= 0) {
    return void this.hide();
  }
  var l = r.data.stats.shieldPoints,
    c = new a("div"),
    d = c.createChild("div", {
      className: "inlineDisplay"
    });
  d.createChild("div", {
    className: "nickname",
    text: r.name + " | "
  });
  d.createChild("div", {
    className: "lifePoints",
    text: r.data.stats.lifePoints
  });
  d.createChild("div", {
    className: ["iconDamageTooltip", "iconLifePoints"]
  });
  var u = d.createChild("div", {
    className: "inlineDisplay"
  });
  if (u.createChild("div", {
    className: "shieldPoints",
    text: "+ " + l
  }), u.createChild("div", {
    className: ["iconDamageTooltip", "iconShieldPoints"]
  }), u.toggleDisplay(l > 0), c.appendChild(this._damageDataToDom(i)), this.insideConfirmBox) {
    return this.hide(), void window.foreground.confirmBox.changeDamage(c);
  }
  this.content.clearContent();
  this.content.appendChild(c);
  var h = s.getElementPositionCenteredAt(this.content, e, t);
  this.setStyles({
    webkitTransform: "translate3d(" + h.x + "px," + h.y + "px,0)"
  });
};
n.prototype._damageDataToDom = function (e) {
  for (var t = new a("div"), i = 0; i < e.length; i++) {
    var n = e[i],
      o = t.createChild("div");
    o.setStyles({
      color: n.color
    });
    o.setHtml(n.content);
  }
  return t;
};
d.createChild("div", {
  className: "nickname",
  text: r.name + " | "
});
d.createChild("div", {
  className: "lifePoints",
  text: r.data.stats.lifePoints
});
d.createChild("div", {
  className: ["iconDamageTooltip", "iconLifePoints"]
});
this.content.clearContent();
this.content.appendChild(c);
o.setStyles({
  color: n.color
});
o.setHtml(n.content);
c(t);
t.on("tap", function () {
  e.close();
});
this.entryContainer = this.createChild("div", {
  className: "entryContainer"
});
this.scroller = this.entryContainer.appendChild(new l({
  className: "entryList"
}, {
  showHintArrows: !0
}));
this.entryList = this.scroller.content;
this._isOpen = !1;
this.clearContent();
window.gui.on("disconnect", function () {
  e.clearContent();
  e.close();
});
e.clearContent();
e.close();
e.close();
e._selectionFn(t.value, t.index);
r(n, d);
e.exports = n;
n.prototype.setupDropDown = function (e, t, i, n) {
  var o = u(e.rootElement);
  return e === this._parentElt && o.left === this._parentRect.left && o.top === this._parentRect.top ? this.open(i) : (this._updateContent(t, n, e, o), void this._firstOpen(i));
};
n.prototype.clearContent = function () {
  this.entryList.clearContent();
  this._parentElt = null;
  this._parentRect = null;
  this._selectionFn = null;
  this._entries = [];
  this._selectedIndex = -1;
};
n.prototype._updateContent = function (e, t, i, n) {
  this.clearContent();
  for (var o = 0, a = e.length; o < a; o++) {
    var s = e[o];
    if (!s.hidden) {
      var r = {
        index: o,
        value: s.value
      };
      s.disabled && (r.disabled = !0);
      this._addEntry(s.text, r);
    }
  }
  this._entries = this.entryList.getChildren();
  this._parentElt = i;
  this._parentRect = n;
  this._selectionFn = t;
};
n.prototype.select = function (e) {
  e >= this._entries.length || (this._selectedIndex !== -1 && this._entries[this._selectedIndex].delClassNames("ticked"), this._selectedIndex = e, this._entries[e].addClassNames("ticked"));
};
n.prototype.close = function () {
  this._isOpen && (this.hide(), this._isOpen = !1);
};
n.prototype._firstOpen = function (e) {
  this.setStyle("opacity", 0);
  this.show();
  this._refreshPositionAndSize();
  this.open(e);
};
n.prototype.open = function (e) {
  this.show();
  void 0 !== e && (this.select(e), this._scrollToEntryIndex(e));
  this._isOpen = !0;
  this.setStyle("opacity", 1);
};
n.prototype._scrollToEntryIndex = function (e) {
  return e < 0 || e >= this._entries.length ? console.warn("Invalid dropdown index", e) : void this.scroller.scrollToElement(this._entries[e], 0);
};
n.prototype._refreshPositionAndSize = function () {
  var e = this._parentRect,
    t = e.left,
    i = e.width - h,
    n = e.bottom + 1,
    o = s.screenHeight - p - n,
    a = u(this.entryList.rootElement);
  if (o < a.height && e.top > .6 * s.screenHeight) {
    var r = e.top - 5;
    o = Math.min(a.height, r - p);
    n = r - o;
  }
  this.entryContainer.setStyles({
    left: t + "px",
    top: n + "px",
    minWidth: i + "px"
  });
  this.scroller.setStyle("max-height", o + "px");
  this.scroller.refresh();
};
n.prototype._addEntry = function (e, t) {
  var i = this.entryList.appendChild(new a({
    text: e,
    className: "dropDownEntry"
  }));
  return t.disabled ? void i.addClassNames("disabled") : (i.on("tap", o), i.dropDown = this, void (i.action = t));
};
this.entryList.clearContent();
this._parentElt = null;
this._parentRect = null;
this._selectionFn = null;
this._entries = [];
this._selectedIndex = -1;
s.disabled && (r.disabled = !0);
this._addEntry(s.text, r);
this._entries = this.entryList.getChildren();
this._parentElt = i;
this._parentRect = n;
this._selectionFn = t;
this.setStyle("opacity", 0);
this.show();
this._refreshPositionAndSize();
this.open(e);
this.show();
void 0 !== e && (this.select(e), this._scrollToEntryIndex(e));
this._isOpen = !0;
this.setStyle("opacity", 1);
o = Math.min(a.height, r - p);
n = r - o;
this.entryContainer.setStyles({
  left: t + "px",
  top: n + "px",
  minWidth: i + "px"
});
this.scroller.setStyle("max-height", o + "px");
this.scroller.refresh();
a.call(this, "div", {
  className: "Compass"
});
this.markers = {};
this._withFlashyAnim = !0;
o(n, a);
e.exports = n;
n.arrowType = {
  QUEST: 4,
  PARTY: 2
};
n.prototype.setFlashyAnimationEnabled = function (e) {
  this._withFlashyAnim = e;
};
n.prototype.addMarker = function (e) {
  var t = e.type,
    i = !window.gui.playerData.isFighting,
    n = new l(this, t, e.arrowType, i, e.x, e.y, e.tooltip);
  return this.markers[t] = n, this.getDistance(e.x, e.y);
};
n.prototype.updateMarker = function (e, t, i, n) {
  var o = this.markers[e];
  return o ? void o.update(t, i, n) : console.error("marker not found: " + e);
};
n.prototype.removeMarker = function (e) {
  var t = this.markers[e];
  return t ? (t.remove(), void delete this.markers[e]) : console.error("marker not found: " + e);
};
n.prototype.setAllMarkersVisibility = function (e) {
  for (var t in this.markers) {
    var i = this.markers[t];
    i.setVisibility(e);
  }
};
n.prototype.renderAllMarkers = function () {
  r.autoGpsPhoenixes && this._updatePhoenixMarkersVisibility();
  var e = [];
  for (var t in this.markers) {
    var i = this.markers[t];
    i.prepareRendering();
    i.isVisible() && e.push(i);
  }
  s(e, l.sortFunction);
  for (var n = 0; n < e.length; n++) {
    e[n].render(this._withFlashyAnim);
  }
};
n.prototype.showOrHidePhoenixMarkers = function () {
  if (!r.autoGpsPhoenixes) {
    for (var e in this.markers) {
      var t = this.markers[e];
      "phoenix" === t.getArrowType() && t.setVisibility(!1);
    }
  }
  this.renderAllMarkers();
};
n.prototype._updatePhoenixMarkersVisibility = function () {
  var e,
    t,
    i = [],
    n = 1 / 0;
  for (e in this.markers) {
    if (t = this.markers[e], "phoenix" === t.getArrowType()) {
      t.setVisibility(!1);
      var o = t.getDistance();
      o < n ? (n = o, i = [e]) : o === n && i.push(e);
    }
  }
  for (var a = 0; a < i.length; a++) {
    t = this.markers[i[a]];
    t.setVisibility(!0);
  }
};
n.prototype.getDistance = function (e, t) {
  var i = window.gui.playerData.position.coordinates,
    n = e - i.posX,
    o = t - i.posY,
    a = Math.abs(n) + Math.abs(o);
  return a;
};
i.prepareRendering();
i.isVisible() && e.push(i);
t = this.markers[i[a]];
t.setVisibility(!0);
this.value = e;
this.originalValue = e;
this.forceLeft = 0;
this.forceRight = 0;
this.left = t;
this.right = null;
t && (t.right = this);
n = n || o;
e.sort(t);
u = new i(e[r].getAngle(), u);
l.push(u);
c = c || u;
d = d && u.distance(c) < n;
l[r - 1].right = null;
l[r].left = null;
l[0].left = u;
u.right = l[0];
l[0].left = u;
u.right = l[0];
i.prototype.updateValue = function () {
  var e = this.forceLeft - this.forceRight;
  return this.value += e, Math.abs(e);
};
i.prototype.distance = function (e) {
  if (!e) {
    return 1 / 0;
  }
  var t = Math.abs(e.value - this.value);
  return Math.min(t, l - t);
};
i.prototype.updateForces = function (e) {
  var t = this.distance(this.left),
    i = this.distance(this.right);
  this.forceLeft = t < e + r ? (e - t) / 2 : 0;
  this.forceRight = i < e + r ? (e - i) / 2 : 0;
};
e.exports = n;
this.forceLeft = t < e + r ? (e - t) / 2 : 0;
this.forceRight = i < e + r ? (e - i) / 2 : 0;
this._compass = e;
this._id = t;
this._arrowType = i;
this._isVisible = n;
this._x = o;
this._y = a;
this._tooltip = s;
this._distance = 0;
this._angle = 0;
this._markerDom = null;
e.exports = n;
n.sortFunction = function (e, t) {
  var i = e._angle - t._angle;
  return 0 !== i ? i : e._id > t._id ? 1 : -1;
};
n.prototype.getAngle = function () {
  return this._angle;
};
n.prototype.setCorrectedAngle = function (e) {
  this._angle = e;
};
n.prototype.setVisibility = function (e) {
  e !== this._isVisible && (this._isVisible = e);
};
n.prototype.getDistance = function () {
  return this._compass.getDistance(this._x, this._y);
};
n.prototype.getArrowType = function () {
  return this._arrowType;
};
n.prototype.isVisible = function () {
  return this._isVisible;
};
n.prototype.update = function (e, t, i) {
  this._x = e;
  this._y = t;
  i && (this._tooltip = i);
};
n.prototype.remove = function () {
  this._markerDom && (this._markerDom.disappear(), this._markerDom = null);
};
n.prototype.prepareRendering = function () {
  if (!this._isVisible) {
    return void (this._markerDom && this.remove());
  }
  var e = window.gui.playerData.position.coordinates,
    t = this._x - e.posX,
    i = this._y - e.posY;
  this._distance = this._compass.getDistance(this._x, this._y);
  0 === this._distance ? this._angle = Math.atan2(-o.mapWidth, -o.mapHeight) : this._angle = Math.atan2(i, t);
};
n.prototype.render = function (e) {
  if (this._isVisible) {
    var t = null;
    this._markerDom ? t = s.MOVE : (this._markerDom = new a(this._compass, this._arrowType || this._id, this._tooltip), t = e ? s.APPEAR_CENTER : s.APPEAR);
    this._markerDom.updateDisplay(this._angle, this._distance, t);
  }
};
this._x = e;
this._y = t;
i && (this._tooltip = i);
this._distance = this._compass.getDistance(this._x, this._y);
0 === this._distance ? this._angle = Math.atan2(-o.mapWidth, -o.mapHeight) : this._angle = Math.atan2(i, t);
this._markerDom ? t = s.MOVE : (this._markerDom = new a(this._compass, this._arrowType || this._id, this._tooltip), t = e ? s.APPEAR_CENTER : s.APPEAR);
this._markerDom.updateDisplay(this._angle, this._distance, t);
c.call(this, "div", {
  className: "marker"
});
this._compass = e;
this._sameMapMarker = null;
this._type = t;
this._tooltipText = i;
this._x = 0;
this._y = 0;
this._arrowAngle = void 0;
this._distance = 0;
this._scalingDiv = null;
this._markerArrow = null;
this._markerNumber = null;
r(n, c);
e.exports = n;
n.prototype._createDom = function () {
  this._scalingDiv = this.createChild("div");
  this._markerArrow = this._scalingDiv.createChild("div", {
    className: ["markerArrow", "arrow_" + this._type]
  });
  this._markerNumber = this._scalingDiv.createChild("div", {
    className: "markerNumber"
  });
  window.foreground.handleTapAfter(this);
  o(this, this._tooltipText);
};
n.prototype._detachFromDom = function () {
  this._sameMapMarker ? (window.gui.mapCoordinateDisplay.removeMarker(this._sameMapMarker), this._sameMapMarker = null) : this._compass.removeChild(this);
};
n.prototype._attachToDom = function () {
  0 === this._distance ? this._sameMapMarker = window.gui.mapCoordinateDisplay.addMarker(this._type, this._tooltipText) : this._compass.appendChild(this);
};
n.prototype.disappear = function () {
  var e = this;
  l.tween(this._scalingDiv, {
    webkitTransform: "scale(0.1)"
  }, {
    time: p,
    easing: "ease-out"
  }, function () {
    e._detachFromDom();
  });
};
n.prototype._startCenterAppearTransition = function () {
  var e = a.mapLeft + a.mapWidth / 2 - d / 2,
    t = a.mapTop + a.mapHeight / 2 - d / 2,
    i = .6,
    n = (this._x - e) * i + e,
    o = (this._y - t) * i + t;
  this.setStyles({
    zIndex: 2e3,
    webkitTransform: this._getPositionTransform(n, o)
  });
  this._scalingDiv.setStyles({
    webkitTransform: "scale(" + u + ")",
    opacity: 0
  });
  this._markerArrow.setStyle("webkitTransform", this._getArrowTransform());
  this._updateDistanceLabel();
  s.forceReflow(this);
  var r = this;
  l.tween(this._scalingDiv, {
    webkitTransform: this._getScalingTransform(),
    opacity: 1
  }, {
    time: p,
    easing: "ease-out"
  }, function () {
    r._scalingDiv.setStyles({
      opacity: null
    });
    r.setStyles({
      zIndex: null
    });
  });
  this._doMoveTransition();
};
n.prototype._startAppearTransition = function () {
  this._appearByScalingUp();
};
n.prototype._startMoveTransition = function () {
  this._scalingDiv.setStyle("webkitTransform", this._getScalingTransform());
  this._doMoveTransition();
  l.tween(this._markerArrow, {
    webkitTransform: this._getArrowTransform()
  }, {
    time: p,
    easing: "ease-out"
  });
};
n.prototype._doMoveTransition = function () {
  l.tween(this, {
    webkitTransform: this._getPositionTransform(this._x, this._y)
  }, {
    time: p,
    easing: "ease-out"
  }, function () {
    this._updateDistanceLabel();
  });
};
n.prototype._startWideMoveTransition = function () {
  this._disappearByScalingDown(this._appearByScalingUp.bind(this));
};
n.prototype._startAppearSameMapTransition = function (e) {
  this._isOnSameMap = !0;
  e || this._disappearByScalingDown(this._continueAppearSameMapTransition.bind(this));
};
n.prototype._continueAppearSameMapTransition = function () {
  this._detachFromDom();
  this._attachToDom();
};
n.prototype._startLeaveSameMapTransition = function () {
  this._isOnSameMap = !1;
  this._detachFromDom();
  this._attachToDom();
  this._appearByScalingUp();
};
n.prototype._disappearByScalingDown = function (e) {
  l.tween(this._scalingDiv, {
    webkitTransform: "scale(0.1)"
  }, {
    time: p,
    easing: "ease-out"
  }, e);
};
n.prototype._appearByScalingUp = function () {
  this._updateDistanceLabel();
  this._markerArrow.setStyle("webkitTransform", this._getArrowTransform());
  this.setStyle("webkitTransform", this._getPositionTransform(this._x, this._y));
  this._scalingDiv.setStyle("webkitTransform", "scale(0.1)");
  s.forceReflow(this._scalingDiv);
  l.tween(this._scalingDiv, {
    webkitTransform: this._getScalingTransform()
  }, {
    time: p,
    easing: "ease-out"
  });
};
n.prototype._updateDistanceLabel = function () {
  this._markerNumber.setText(this._distance);
};
n.prototype._updatePositionAndAngle = function (e) {
  var t = 180 * e / Math.PI,
    i = this._arrowAngle;
  this._arrowAngle = t;
  var n,
    o,
    s = a.mapWidth - d,
    r = a.mapHeight - d;
  t <= -34 && t >= -146 ? (n = (s - Math.tan(Math.PI / 2 - e) * r) / 2, o = 0) : t >= 34 && t <= 146 ? (n = (s + Math.tan(Math.PI / 2 - e) * r) / 2, o = r) : t < 34 && t > -34 ? (n = s, o = (r + Math.tan(e) * s) / 2) : (n = 0, o = (r - Math.tan(e) * s) / 2);
  this._x = a.mapLeft + n;
  this._y = a.mapTop + o;
  var l = (t - i + 360) % 360;
  return l > 180 && (l -= 360), l;
};
n.prototype._getPositionTransform = function (e, t) {
  return "translate3d(" + e + "px," + t + "px,0)";
};
this._scalingDiv = this.createChild("div");
this._markerArrow = this._scalingDiv.createChild("div", {
  className: ["markerArrow", "arrow_" + this._type]
});
this._markerNumber = this._scalingDiv.createChild("div", {
  className: "markerNumber"
});
window.foreground.handleTapAfter(this);
o(this, this._tooltipText);
this.setStyles({
  zIndex: 2e3,
  webkitTransform: this._getPositionTransform(n, o)
});
this._scalingDiv.setStyles({
  webkitTransform: "scale(" + u + ")",
  opacity: 0
});
this._markerArrow.setStyle("webkitTransform", this._getArrowTransform());
this._updateDistanceLabel();
s.forceReflow(this);
l.tween(this._scalingDiv, {
  webkitTransform: this._getScalingTransform(),
  opacity: 1
}, {
  time: p,
  easing: "ease-out"
}, function () {
  r._scalingDiv.setStyles({
    opacity: null
  });
  r.setStyles({
    zIndex: null
  });
});
this._doMoveTransition();
r._scalingDiv.setStyles({
  opacity: null
});
r.setStyles({
  zIndex: null
});
this._scalingDiv.setStyle("webkitTransform", this._getScalingTransform());
this._doMoveTransition();
l.tween(this._markerArrow, {
  webkitTransform: this._getArrowTransform()
}, {
  time: p,
  easing: "ease-out"
});
this._isOnSameMap = !0;
e || this._disappearByScalingDown(this._continueAppearSameMapTransition.bind(this));
this._detachFromDom();
this._attachToDom();
this._isOnSameMap = !1;
this._detachFromDom();
this._attachToDom();
this._appearByScalingUp();
this._updateDistanceLabel();
this._markerArrow.setStyle("webkitTransform", this._getArrowTransform());
this.setStyle("webkitTransform", this._getPositionTransform(this._x, this._y));
this._scalingDiv.setStyle("webkitTransform", "scale(0.1)");
s.forceReflow(this._scalingDiv);
l.tween(this._scalingDiv, {
  webkitTransform: this._getScalingTransform()
}, {
  time: p,
  easing: "ease-out"
});
t <= -34 && t >= -146 ? (n = (s - Math.tan(Math.PI / 2 - e) * r) / 2, o = 0) : t >= 34 && t <= 146 ? (n = (s + Math.tan(Math.PI / 2 - e) * r) / 2, o = r) : t < 34 && t > -34 ? (n = s, o = (r + Math.tan(e) * s) / 2) : (n = 0, o = (r - Math.tan(e) * s) / 2);
this._x = a.mapLeft + n;
this._y = a.mapTop + o;
n.prototype._getScalingTransform = function () {
  var e = f - m,
    t = Math.min(1, Math.max(0, this._distance - m) / e),
    i = Math.round(10 * (1 - t * (1 - g))) / 10;
  return 1 !== i ? "scale(" + i + ")" : "";
};
n.prototype._getArrowTransform = function () {
  return this._isOnSameMap ? "" : "rotate(" + this._arrowAngle + "deg)";
};
a.call(this, "div", {
  className: "HintArrow",
  hidden: !0
});
this.arrow = this.createChild("div", {
  className: "arrow"
});
o(n, a);
e.exports = n;
n.prototype.showArrow = function (e, t, i) {
  i = i || "downRight";
  this.arrow.setClassNames(["arrow", i]);
  this.setStyles({
    left: e + "px",
    top: t + "px"
  });
  this.show();
};
n.prototype.hideArrow = function () {
  this.hide();
};
i = i || "downRight";
this.arrow.setClassNames(["arrow", i]);
this.setStyles({
  left: e + "px",
  top: t + "px"
});
this.show();
r.call(this);
this._shieldSelected = !1;
this._isQuestFilter = !1;
this._initialized = !1;
this._isContextMenuOpen = !1;
this._isRuneSelected = !1;
this._isShieldWindowOpened = !1;
this._isShieldSpellDisplayed = !1;
t.setHtml(e);
e = t;
l(n, r);
e.exports = n;
n.prototype.initialize = function (e) {
  var t = this;
  e.on("disconnect", function () {
    t._initialized && t.stop();
  });
  e.playerData.quests.on("listUpdated", function () {
    e.playerData.isOnShieldTutorial() && !e.playerData.isShieldTutorialFortified() && t.start();
  });
  e.playerData.quests.on("questStarted", function () {
    e.playerData.isOnShieldTutorial() && !e.playerData.isShieldTutorialFortified() && t.start();
  });
  g.on("QuestObjectiveValidatedMessage", function () {
    e.playerData.isShieldTutorialFortified() && t.stop();
  });
};
n.prototype.start = function () {
  this._initialized || (this._setupHandlerFunctions(), this._initialized = !0);
  this.updateHintArrowHandler();
};
n.prototype._registerInTutorialListeners = function () {
  c.on("opened", this.windowOpenedHandler);
  c.on("closed", this.windowClosedHandler);
  var e = c.getWindow("equipment");
  e.on("itemSelected", this.itemSelectedHandler);
  e.storageView.on("filter", this.questFilterHandler);
  var t = c.getWindow("shieldWindow");
  t.feedingBox.on("quantityUpdated", this.runeSelectedHandler);
  h.getContextMenu("item").on("open", this.itemContextMenuHandler);
  window.gui.menuBar.on("open", this.updateHintArrowHandler);
  window.gui.menuBar.on("close", this.updateHintArrowHandler);
};
n.prototype._removeInTutorialListeners = function () {
  c.removeListener("opened", this.windowOpenedHandler);
  c.removeListener("closed", this.windowClosedHandler);
  var e = c.getWindow("equipment");
  e.removeListener("itemSelected", this.itemSelectedHandler);
  e.storageView.removeListener("filter", this.questFilterHandler);
  var t = c.getWindow("shieldWindow");
  t.feedingBox.on("quantityUpdated", this.runeSelectedHandler);
  h.getContextMenu("item").removeListener("open", this.itemContextMenuHandler);
  this._isShieldWindowOpened && t.getShieldSpellSlot().removeListener("tapend", this.shieldSpellSlotHandler);
  window.gui.menuBar.removeListener("open", this.updateHintArrowHandler);
  window.gui.menuBar.removeListener("close", this.updateHintArrowHandler);
};
n.prototype.stop = function () {
  o();
  this._hideArrows();
  this._removeInTutorialListeners();
  this.reset();
};
n.prototype.reset = function () {
  this._shieldSelected = !1;
  this._isQuestFilter = !1;
  this._initialized = !1;
  this._isContextMenuOpen = !1;
  this._isRuneSelected = !1;
  this._isShieldWindowOpened = !1;
  this._isShieldSpellDisplayed = !1;
};
n.prototype._hideArrows = function () {
  window.gui.hintAnimationManager.stopHint();
};
n.prototype._setupHandlerFunctions = function () {
  var e = this;
  this.windowOpenedHandler = function (t) {
    var i = t.id;
    if ("equipment" === i) {
      e._shieldSelected = !1;
      e._isQuestFilter = !1;
      e._isContextMenuOpen = !1;
    } else if ("shieldWindow" === i) {
      e._isContextMenuOpen = !1;
      e._isShieldSpellDisplayed = !1;
      e._isRuneSelected = !1;
      var n = c.getWindow("shieldWindow");
      e._isShieldWindowOpened || (n.getShieldSpellSlot().on("tooltipOut", e.shieldSpellSlotHandler), e._isShieldWindowOpened = !0);
    }
    e._updateHintArrow();
  };
  this.windowClosedHandler = function () {
    e._updateHintArrow();
  };
  this.shieldSpellSlotHandler = function () {
    e._isShieldSpellDisplayed = !0;
    e._updateHintArrow();
  };
  this.questFilterHandler = function (t) {
    t !== f.questFilterId ? e._isQuestFilter = !1 : e._isQuestFilter = !0;
    e._updateHintArrow();
  };
  this.itemSelectedHandler = function (t) {
    e._shieldSelected = !1;
    t.id === f.fakeShieldId && (e._shieldSelected = !0);
    e._updateHintArrow();
  };
  this.runeSelectedHandler = function () {
    e._isRuneSelected = !0;
    e._updateHintArrow();
  };
  this.itemContextMenuHandler = function () {
    e._shieldSelected && (e._isContextMenuOpen = !0);
    e._updateHintArrow();
  };
  this.updateHintArrowHandler = this._updateHintArrow.bind(this);
  this._registerInTutorialListeners();
};
n.prototype.isSpellSlotStepPassed = function () {
  return this._isShieldSpellDisplayed;
};
n.prototype._handleHintArrowAndDialogue = function () {
  var e = window.gui.playerData;
  if (this._hideArrows(), e.isOnShieldTutorial() && !e.isShieldTutorialFortified()) {
    var t = this;
    switch (c.getLastFocusedWindowId()) {
      case "confirm":
        break;
      case "shieldWindow":
        if (this._isRuneSelected && this._isShieldSpellDisplayed) {
          a(m("ui.shield.tutorialStep6"));
          d.pointToShieldValidateButton();
          break;
        }
        if (this._isShieldSpellDisplayed) {
          a(m("ui.shield.tutorialStep5"));
          d.pointToShieldStorageFirstSlotBox();
          break;
        }
        a(m("ui.shield.tutorialStep4"));
        d.pointToShieldSpellSlot();
        break;
      case "equipment":
        if (this._isContextMenuOpen) {
          d.pointToEntryManageShield();
          break;
        }
        if (this._shieldSelected) {
          o();
          d.pointToActionButton();
          break;
        }
        if (this._isQuestFilter) {
          a(m("ui.shield.tutorialStep3"));
          d.pointToStorageFirstSlotBox();
          break;
        }
        a(m("ui.shield.tutorialStep2"));
        d.pointToQuestFilterIcon();
        break;
      default:
        a(m("ui.shield.tutorialStep1"));
        t._shieldSelected = !1;
        t._isQuestFilter = !1;
        d.pointToMenuIcon("Bag");
    }
  }
};
n.prototype._updateHintArrow = function () {
  var e = this;
  setTimeout(function () {
    e._handleHintArrowAndDialogue();
  }, 300);
};
e.on("disconnect", function () {
  t._initialized && t.stop();
});
e.playerData.quests.on("listUpdated", function () {
  e.playerData.isOnShieldTutorial() && !e.playerData.isShieldTutorialFortified() && t.start();
});
e.playerData.quests.on("questStarted", function () {
  e.playerData.isOnShieldTutorial() && !e.playerData.isShieldTutorialFortified() && t.start();
});
g.on("QuestObjectiveValidatedMessage", function () {
  e.playerData.isShieldTutorialFortified() && t.stop();
});
this._initialized || (this._setupHandlerFunctions(), this._initialized = !0);
this.updateHintArrowHandler();
c.on("opened", this.windowOpenedHandler);
c.on("closed", this.windowClosedHandler);
e.on("itemSelected", this.itemSelectedHandler);
e.storageView.on("filter", this.questFilterHandler);
t.feedingBox.on("quantityUpdated", this.runeSelectedHandler);
h.getContextMenu("item").on("open", this.itemContextMenuHandler);
window.gui.menuBar.on("open", this.updateHintArrowHandler);
window.gui.menuBar.on("close", this.updateHintArrowHandler);
c.removeListener("opened", this.windowOpenedHandler);
c.removeListener("closed", this.windowClosedHandler);
e.removeListener("itemSelected", this.itemSelectedHandler);
e.storageView.removeListener("filter", this.questFilterHandler);
t.feedingBox.on("quantityUpdated", this.runeSelectedHandler);
h.getContextMenu("item").removeListener("open", this.itemContextMenuHandler);
this._isShieldWindowOpened && t.getShieldSpellSlot().removeListener("tapend", this.shieldSpellSlotHandler);
window.gui.menuBar.removeListener("open", this.updateHintArrowHandler);
window.gui.menuBar.removeListener("close", this.updateHintArrowHandler);
o();
this._hideArrows();
this._removeInTutorialListeners();
this.reset();
this._shieldSelected = !1;
this._isQuestFilter = !1;
this._initialized = !1;
this._isContextMenuOpen = !1;
this._isRuneSelected = !1;
this._isShieldWindowOpened = !1;
this._isShieldSpellDisplayed = !1;
this.windowOpenedHandler = function (t) {
  var i = t.id;
  if ("equipment" === i) {
    e._shieldSelected = !1;
    e._isQuestFilter = !1;
    e._isContextMenuOpen = !1;
  } else if ("shieldWindow" === i) {
    e._isContextMenuOpen = !1;
    e._isShieldSpellDisplayed = !1;
    e._isRuneSelected = !1;
    var n = c.getWindow("shieldWindow");
    e._isShieldWindowOpened || (n.getShieldSpellSlot().on("tooltipOut", e.shieldSpellSlotHandler), e._isShieldWindowOpened = !0);
  }
  e._updateHintArrow();
};
this.windowClosedHandler = function () {
  e._updateHintArrow();
};
this.shieldSpellSlotHandler = function () {
  e._isShieldSpellDisplayed = !0;
  e._updateHintArrow();
};
this.questFilterHandler = function (t) {
  t !== f.questFilterId ? e._isQuestFilter = !1 : e._isQuestFilter = !0;
  e._updateHintArrow();
};
this.itemSelectedHandler = function (t) {
  e._shieldSelected = !1;
  t.id === f.fakeShieldId && (e._shieldSelected = !0);
  e._updateHintArrow();
};
this.runeSelectedHandler = function () {
  e._isRuneSelected = !0;
  e._updateHintArrow();
};
this.itemContextMenuHandler = function () {
  e._shieldSelected && (e._isContextMenuOpen = !0);
  e._updateHintArrow();
};
this.updateHintArrowHandler = this._updateHintArrow.bind(this);
this._registerInTutorialListeners();
e._shieldSelected = !1;
e._isQuestFilter = !1;
e._isContextMenuOpen = !1;
e._isContextMenuOpen = !1;
e._isShieldSpellDisplayed = !1;
e._isRuneSelected = !1;
e._isShieldSpellDisplayed = !0;
e._updateHintArrow();
t !== f.questFilterId ? e._isQuestFilter = !1 : e._isQuestFilter = !0;
e._updateHintArrow();
e._shieldSelected = !1;
t.id === f.fakeShieldId && (e._shieldSelected = !0);
e._updateHintArrow();
e._isRuneSelected = !0;
e._updateHintArrow();
e._shieldSelected && (e._isContextMenuOpen = !0);
e._updateHintArrow();
a(m("ui.shield.tutorialStep6"));
d.pointToShieldValidateButton();
a(m("ui.shield.tutorialStep5"));
d.pointToShieldStorageFirstSlotBox();
a(m("ui.shield.tutorialStep4"));
d.pointToShieldSpellSlot();
o();
d.pointToActionButton();
a(m("ui.shield.tutorialStep3"));
d.pointToStorageFirstSlotBox();
a(m("ui.shield.tutorialStep2"));
d.pointToQuestFilterIcon();
a(m("ui.shield.tutorialStep1"));
t._shieldSelected = !1;
t._isQuestFilter = !1;
d.pointToMenuIcon("Bag");
e = e || {};
r.call(this, "div", e);
this.addClassNames("tutorialPopup");
this._header = this.appendChild(new r("div", {
  className: "tutorialPopupHeader",
  name: "tutorialPopupHeader"
}));
this._header.appendChild(new r("div", {
  className: "tutorialPopupTitle",
  text: a(e.actor)
}));
this.content = this.appendChild(new r("div", {
  className: "tutorialPopupContent"
}));
this._hasAlreadyHaveCloseButton = !1;
i(910);
s(n, r);
e.exports = n;
n.prototype.setContent = function (e) {
  this.content.clearContent();
  e instanceof r ? this.content.appendChild(e) : this.content.setText(e);
  this.show();
};
n.prototype.setCloseButton = function () {
  if (!this._hasAlreadyHaveCloseButton) {
    var e = this._header.appendChild(new r("div", {
      className: "tutorialPopupCloseBtn"
    }));
    e.appendChild(new r("div", {
      className: "btnIcon"
    }));
    this._hasAlreadyHaveCloseButton = !0;
  }
};
n.prototype.open = function () {
  this.setStyle("bottom", o.screenHeight - o.mapHeight + 7 + "px");
  this.hide();
  window.gui.windowsContainer.appendChild(this);
};
n.prototype.close = function () {
  this.hide();
};
this.content.clearContent();
e instanceof r ? this.content.appendChild(e) : this.content.setText(e);
this.show();
e.appendChild(new r("div", {
  className: "btnIcon"
}));
this._hasAlreadyHaveCloseButton = !0;
this.setStyle("bottom", o.screenHeight - o.mapHeight + 7 + "px");
this.hide();
window.gui.windowsContainer.appendChild(this);
window.dofus.sendMessage("NotificationUpdateFlagMessage", {
  index: t
});
I[t] = !0;
r(i);
n.newNotification(i, a);
E.push(i);
o(t);
I[n + 32 * t] = !!(1 & i);
i >>= 1;
t.initialize = function (e) {
  e.once("initialized", function () {
    N = M.getValue("option-tutorialTips", !0);
    y.on("tutorialTips", function (e) {
      t.enableTips(e);
    });
    g(function (e) {
      if (e) {
        return console.error(e);
      }
    });
  });
  e.on("disconnect", function () {
    s();
    x = !1;
  });
  e.on("NotificationListMessage", function (e) {
    _(e.flags);
  });
};
t.enableTips = function (e) {
  N = e;
  x || (N ? d() : s());
};
t.resetTips = function () {
  window.dofus.sendMessage("NotificationResetMessage");
  _([0]);
  N && !x && (s(), d());
};
e.once("initialized", function () {
  N = M.getValue("option-tutorialTips", !0);
  y.on("tutorialTips", function (e) {
    t.enableTips(e);
  });
  g(function (e) {
    if (e) {
      return console.error(e);
    }
  });
});
e.on("disconnect", function () {
  s();
  x = !1;
});
e.on("NotificationListMessage", function (e) {
  _(e.flags);
});
N = M.getValue("option-tutorialTips", !0);
y.on("tutorialTips", function (e) {
  t.enableTips(e);
});
g(function (e) {
  if (e) {
    return console.error(e);
  }
});
s();
x = !1;
N = e;
x || (N ? d() : s());
window.dofus.sendMessage("NotificationResetMessage");
_([0]);
N && !x && (s(), d());
s.call(this, "div", {
  className: "RoleplayBuffs"
});
c(this, {
  isCollapsable: !0
});
this._itemSlotMap = {};
this._timedBuffMap = {};
this._createDom();
this._setupListeners(e);
this.hide();
t.on("disconnect", function () {
  i._unloadTimedBuffsContent();
});
a(n, s);
e.exports = n;
n.prototype._setupListeners = function (e) {
  var t = this;
  window.gui.on("connected", function () {
    t.setStyle("left", ~~(u.mapWidth / 2) + u.mapLeft + "px");
    t.setStyle("top", u.mapTop + "px");
  });
  e.on("listUpdate", function (e) {
    t._unloadItemsContent();
    for (var i in e) {
      t._addItem(e[i]);
    }
  });
  e.on("unloaded", function () {
    t._unloadItemsContent();
  });
  e.on("itemAdded", function (e) {
    t._addItem(e);
  });
  e.on("itemsAdded", function (e) {
    for (var i in e) {
      t._addItem(e[i]);
    }
  });
  e.on("itemDeleted", function (e) {
    t._removeItem(e);
  });
  e.on("itemsDeleted", function (e) {
    for (var i in e) {
      t._removeItem(e[i]);
    }
  });
  e.on("itemModified", function (e) {
    t._modifyItem(e);
  });
  p.on("UpdateTimedBuffTimeMessage", function (e) {
    t._addOrUpdateTimedBuff(e.buffType, e.updatedTime);
  });
};
n.prototype._createDom = function () {
  this.itemSlotBox = this.createChild("div", {
    className: "slotBox"
  });
  this.timedBuffSlotBox = this.createChild("div", {
    className: "slotBox"
  });
};
n.prototype._addItem = function (e) {
  if (o(e)) {
    var t = e.objectUID,
      i = this._itemSlotMap[t];
    i || (i = this._itemSlotMap[t] = new r({
      itemData: e,
      enableContextMenu: !1,
      descriptionOptions: {
        averagePrice: !1,
        showCategory: !1,
        showWeight: !1
      }
    }), this.itemSlotBox.appendChild(i), this.show(), this.emit("resized"));
  }
};
n.prototype._removeItem = function (e) {
  var t = this._itemSlotMap[e];
  t && (t.destroy(), delete this._itemSlotMap[e], this._refreshDisplay());
};
n.prototype._modifyItem = function (e) {
  this._removeItem(e.objectUID);
  this._addItem(e);
  this._refreshDisplay();
};
n.prototype._unloadItemsContent = function () {
  this._itemSlotMap = {};
  this.itemSlotBox.clearContent();
  this._refreshDisplay();
};
n.prototype._unloadTimedBuffsContent = function () {
  this._timedBuffMap = {};
  this.timedBuffSlotBox.clearContent();
  this._refreshDisplay();
};
n.prototype._refreshDisplay = function () {
  d(this._itemSlotMap) && d(this._timedBuffMap) && this.hide();
  this.emit("resized");
};
n.prototype._addOrUpdateTimedBuff = function (e, t) {
  var i = this._timedBuffMap[e];
  if (i) {
    return i.setEndTime(t), void this._refreshDisplay();
  }
  if (!(t - h.now() < 0)) {
    i = this._timedBuffMap[e] = new l(e, t);
    var n = this;
    i.on("onTimerFinished", function () {
      delete n._timedBuffMap[e];
      n.timedBuffSlotBox.removeChild(i);
      n._refreshDisplay();
    });
    this.timedBuffSlotBox.appendChild(i);
    this.show();
    this._refreshDisplay();
  }
};
window.gui.on("connected", function () {
  t.setStyle("left", ~~(u.mapWidth / 2) + u.mapLeft + "px");
  t.setStyle("top", u.mapTop + "px");
});
e.on("listUpdate", function (e) {
  t._unloadItemsContent();
  for (var i in e) {
    t._addItem(e[i]);
  }
});
e.on("unloaded", function () {
  t._unloadItemsContent();
});
e.on("itemAdded", function (e) {
  t._addItem(e);
});
e.on("itemsAdded", function (e) {
  for (var i in e) {
    t._addItem(e[i]);
  }
});
e.on("itemDeleted", function (e) {
  t._removeItem(e);
});
e.on("itemsDeleted", function (e) {
  for (var i in e) {
    t._removeItem(e[i]);
  }
});
e.on("itemModified", function (e) {
  t._modifyItem(e);
});
p.on("UpdateTimedBuffTimeMessage", function (e) {
  t._addOrUpdateTimedBuff(e.buffType, e.updatedTime);
});
t.setStyle("left", ~~(u.mapWidth / 2) + u.mapLeft + "px");
t.setStyle("top", u.mapTop + "px");
this.itemSlotBox = this.createChild("div", {
  className: "slotBox"
});
this.timedBuffSlotBox = this.createChild("div", {
  className: "slotBox"
});
this._removeItem(e.objectUID);
this._addItem(e);
this._refreshDisplay();
this._itemSlotMap = {};
this.itemSlotBox.clearContent();
this._refreshDisplay();
this._timedBuffMap = {};
this.timedBuffSlotBox.clearContent();
this._refreshDisplay();
d(this._itemSlotMap) && d(this._timedBuffMap) && this.hide();
this.emit("resized");
i.on("onTimerFinished", function () {
  delete n._timedBuffMap[e];
  n.timedBuffSlotBox.removeChild(i);
  n._refreshDisplay();
});
this.timedBuffSlotBox.appendChild(i);
this.show();
this._refreshDisplay();
delete n._timedBuffMap[e];
n.timedBuffSlotBox.removeChild(i);
n._refreshDisplay();
e === s.ANTI_AGGRO && (i.addClassNames("antiAggro"), l.addTooltip(this, c("tablet.buff.nonAggroDesc")));
this._endTime = t;
this._createDom();
this.emit("resized");
this.updateInterval = d.setInterval(function () {
  i._update();
}, 1e3);
this.on("tooltipOn", this._removeHoverStyle);
this.on("tooltipOut", this._applyHoverStyle);
a(n, o);
e.exports = n;
n.prototype._update = function () {
  var e = this._endTime - r.now();
  if (e < 0) {
    return void this._onFinished();
  }
  var t = Math.floor(e / 6e4),
    i = Math.floor(e / 1e3 - 60 * t);
  this.timedBuffSlotCounter.setText(r.leadWithZero(t) + ":" + r.leadWithZero(i));
};
n.prototype._onFinished = function () {
  this.emit("onTimerFinished");
  d.clearInterval(this.updateInterval);
};
n.prototype.setEndTime = function (e) {
  this._endTime = e;
};
n.prototype._createDom = function () {
  this.timedBuffSlotCounter = this.createChild("div", {
    className: "timedBuffSlotCounter"
  });
};
n.prototype._applyHoverStyle = function () {
  this.setStyle("webkitTransform", "scale(1)");
};
n.prototype._removeHoverStyle = function () {
  this.setStyle("webkitTransform", "scale(1.1)");
};
this.emit("onTimerFinished");
d.clearInterval(this.updateInterval);
this.handlerMap = {};
this.handlerMap[c] = this.kamaConvertHandler;
this.handlerMap[d] = this.kamaConvertHandler;
this.handlerMap[u] = this.kamaLostHandler;
this.handlerMap[l] = this.guestLimitHandler;
this.handlerMap[h] = this.overweightHandler;
this.previousConvertedKamaAmount = null;
n.prototype.initialize = function () {
  var e = this,
    t = window.dofus.connectionManager,
    i = {};
  i[r.TEXT_INFORMATION_MESSAGE] = o.PSEUDO_CHANNEL_INFO;
  i[r.TEXT_INFORMATION_PVP] = o.CHANNEL_ALLIANCE;
  i[r.TEXT_INFORMATION_FIGHT] = o.PSEUDO_CHANNEL_FIGHT_LOG;
  t.on("TextInformationMessage", function (t) {
    if (t.text = a.processText.apply(null, [t.text].concat(t.parameters)), "ADMIN_DEBUG" === t.parameters[0]) {
      return console.warn(t.text);
    }
    var n = 1e4 * t.msgType + t.msgId,
      o = e.handlerMap[n];
    o && !o.call(e, t) || (t.msgType === r.TEXT_INFORMATION_ERROR ? window.gui.chat.logError(t.text) : window.gui.chat.logMsg(t.text, i[t.msgType]));
  });
  t.on("TextInformationMessageWithPriority", function (e) {
    e.msgType === r.TEXT_INFORMATION_ERROR ? window.gui.chat.logError(e.text, e.msgPriority) : window.gui.chat.logMsg(e.text, i[e.msgType], e.msgPriority);
  });
};
n.prototype.kamaConvertHandler = function (e) {
  return this.previousConvertedKamaAmount = ~~e.parameters[0], !1;
};
n.prototype.kamaLostHandler = function (e) {
  var t = ~~e.parameters[0];
  if (t !== this.previousConvertedKamaAmount) {
    return this.previousConvertedKamaAmount = null, !0;
  }
  this.previousConvertedKamaAmount = null;
  var i = s.computeHardPrice(t);
  return i ? (e.text = a.getText("tablet.spent.hard", i), !0) : console.warn("Cannot convert currency");
};
n.prototype.guestLimitHandler = function () {
  return window.gui.loginScreen.proposeRegistrationAfterGuestLimit(), !1;
};
n.prototype.overweightHandler = function (e) {
  return window.gui.openPopup({
    title: a.getText("ui.popup.warning"),
    message: e.text
  }), !0;
};
e.exports = new n();
i[r.TEXT_INFORMATION_MESSAGE] = o.PSEUDO_CHANNEL_INFO;
i[r.TEXT_INFORMATION_PVP] = o.CHANNEL_ALLIANCE;
i[r.TEXT_INFORMATION_FIGHT] = o.PSEUDO_CHANNEL_FIGHT_LOG;
t.on("TextInformationMessage", function (t) {
  if (t.text = a.processText.apply(null, [t.text].concat(t.parameters)), "ADMIN_DEBUG" === t.parameters[0]) {
    return console.warn(t.text);
  }
  var n = 1e4 * t.msgType + t.msgId,
    o = e.handlerMap[n];
  o && !o.call(e, t) || (t.msgType === r.TEXT_INFORMATION_ERROR ? window.gui.chat.logError(t.text) : window.gui.chat.logMsg(t.text, i[t.msgType]));
});
t.on("TextInformationMessageWithPriority", function (e) {
  e.msgType === r.TEXT_INFORMATION_ERROR ? window.gui.chat.logError(e.text, e.msgPriority) : window.gui.chat.logMsg(e.text, i[e.msgType], e.msgPriority);
});
a = window.gui;
r.call(this);
this.lockStatus = {};
this._setupEvents();
this.updateAll();
s(o, r);
e.exports = o;
o.prototype._getCustomReasonIndex = function (e, t) {
  if (!this.lockStatus[e] || !this.lockStatus[e].customLockedReasons) {
    return -1;
  }
  for (var i = 0; i < this.lockStatus[e].customLockedReasons.length; i++) {
    if (this.lockStatus[e].customLockedReasons[i].id === t) {
      return i;
    }
  }
  return -1;
};
o.prototype.updateAll = function () {
  for (var e in p) {
    this.updateFeatureId(e);
  }
};
o.prototype.updateFeatureId = function (e) {
  var t = p[e],
    i = this.lockStatus[e].base,
    n = t.evaluateCurrent();
  n !== i && this._setStatus(e, n);
};
o.prototype.isFeatureLockedByWindow = function (e, t) {
  var i = this;
  for (var n in this.lockStatus) {
    if (i.lockStatus.hasOwnProperty(n)) {
      var o = i.lockStatus[n];
      if (o.windowId === e && (!t || t && o.tabId === t)) {
        return i.isFeatureLocked(n);
      }
    }
  }
  return !1;
};
o.prototype.isFeatureLocked = function (e) {
  return void 0 === this.lockStatus[e] ? (console.error(new Error("UiLocker.isFeatureLocked: featureId `" + e + "` unknown")), !0) : !(this.lockStatus[e].base !== u && !this.lockStatus[e].customLockedReasons);
};
o.prototype.isFeatureAvailable = function (e) {
  return !this.isFeatureLocked(e);
};
o.prototype._getFeatureIdfromMenuButtonId = function (e) {
  for (var t in p) {
    var i = p[t];
    if (i.menuButtonId === e) {
      return t;
    }
  }
  return console.error(new Error("UiLocker.isMenuButtonAvailable: no feature is matching the menuButtonId " + e)), null;
};
o.prototype.isMenuButtonAvailable = function (e) {
  var t = this._getFeatureIdfromMenuButtonId(e);
  return !!t && this.isFeatureAvailable(t);
};
o.prototype.getMenuButtonLockedReasons = function (e) {
  var t = [],
    i = this._getFeatureIdfromMenuButtonId(e);
  if (i) {
    if (this.lockStatus[i].base && p[i].lockedReasonDescription) {
      if ("Spouse" === e) {
        var n = window.gui.playerData.characterBaseInformations.sex;
        t.push(l(p[i].lockedReasonDescription, n));
      } else {
        t.push(l(p[i].lockedReasonDescription));
      }
    }
    if (this.lockStatus[i].customLockedReasons) {
      for (var o = this.lockStatus[i].customLockedReasons, a = 0; a < o.length; a++) {
        t.push(o[a].description);
      }
    }
  } else {
    console.error(new Error("UiLocker.getMenuButtonLockedReason: no feature is matching the menuButtonId" + e));
  }
  return 0 === t.length && t.push(l("tablet.uiLocker.default")), t;
};
o.prototype.isTabAvailable = function (e, t) {
  for (var i in p) {
    var n = p[i];
    if (n.windowId === e && n.tabId === t) {
      return this.isFeatureAvailable(i);
    }
  }
  return console.error(new Error("UiLocker.isTabAvailable: no feature matching window " + e + " w/ tabId " + t)), !1;
};
o.prototype._setStatus = function (e, t, i, n) {
  var o = p[e];
  if (!o) {
    return console.error(new Error("UiLocker._setStatus: featureId " + e + " unknown"));
  }
  var a = this.isFeatureLocked(e),
    s = this.lockStatus[e],
    r = s.base;
  if (i) {
    var l = -1;
    if (s.customLockedReasons && (l = this._getCustomReasonIndex(e, i)), t) {
      if (l === -1) {
        s.customLockedReasons || (s.customLockedReasons = []);
        var c = {
          id: i,
          description: n
        };
        s.customLockedReasons.push(c);
      }
    } else {
      l !== -1 && (s.customLockedReasons.splice(l, 1), 0 === s.customLockedReasons.length && (s.customLockedReasons = null));
      s.base = o.evaluateCurrent();
    }
  } else {
    s.base = t;
  }
  var d = this.isFeatureLocked(e),
    u = s.base;
  d === a && u === r || this.emit("updated", {
    featureId: e,
    locked: d,
    baseLocked: u,
    menuButtonId: o.menuButtonId,
    windowId: o.windowId,
    tabId: o.tabId
  });
};
o.prototype._setupEvents = function () {
  var e = this;
  a.playerData.jobs.on("jobListUpdated", function () {
    e.updateFeatureId("job");
  });
  a.playerData.alliance.on("allianceUpdated", function () {
    e.updateFeatureId("alliance");
  });
  a.playerData.alliance.on("allianceJoined", function () {
    e.updateFeatureId("alliance");
  });
  a.playerData.alliance.on("allianceLeft", function () {
    e.updateFeatureId("alliance");
  });
  a.playerData.guild.on("GuildGeneralInformationUpdate", function () {
    e.updateFeatureId("guild");
  });
  a.playerData.guild.on("guildLeft", function () {
    e.updateFeatureId("guild");
  });
  a.playerData.on("setMount", function () {
    e.updateFeatureId("mount");
  });
  a.playerData.on("unsetMount", function () {
    e.updateFeatureId("mount");
  });
  d.on("MapComplementaryInformationsDataMessage", function () {
    e.updateFeatureId("koliseum");
  });
  d.on("MapComplementaryInformationsDataInHouseMessage", function () {
    e.updateFeatureId("koliseum");
  });
  a.playerData.on("characterLevelUp", function () {
    e.updateFeatureId("koliseum");
  });
  a.playerData.socialData.on("spouseUpdate", function () {
    e.updateFeatureId("spouse");
  });
  a.playerData.socialData.on("spouseLeft", function () {
    e.updateFeatureId("spouse");
  });
  a.playerData.achievements.on("achievementListUpdated", function () {
    e.updateFeatureId("directory");
    e.updateFeatureId("alignment");
  });
  a.playerData.achievements.on("achievementFinished", function () {
    e.updateFeatureId("directory");
    e.updateFeatureId("alignment");
  });
};
o.prototype.lockFeature = function (e, t, i) {
  return t && i ? void this._setStatus(e, !0, t, i) : console.error(new Error("UiLocker.lockFeature: featureId: " + e + " reasonKey: " + t + " reasonDescription: " + i + " - a reasonKey and a reasonDescription are required to lock a feature"));
};
o.prototype.unlockFeature = function (e, t) {
  return t ? void this._setStatus(e, !1, t) : console.error(new Error("UiLocker.unlockFeature: a reasonKey is required to unlock a feature"));
};
o.prototype.lockAllFeatures = function (e, t) {
  for (var i in this.lockStatus) {
    this.lockStatus.hasOwnProperty(i) && this.lockFeature(i, e, t);
  }
};
o.prototype.lockAllFeaturesExcept = function (e, t, i) {
  for (var n in this.lockStatus) {
    this.lockStatus.hasOwnProperty(n) && (e.indexOf(n) < 0 ? this.lockFeature(n, t, i) : this.unlockFeature(n, t));
  }
};
o.prototype.unlockAllFeatures = function (e) {
  if (!e) {
    return console.error(new Error("UiLocker.unlockAllFeatures: a reasonKey is required to unlock features"));
  }
  for (var t in this.lockStatus) {
    this.lockStatus.hasOwnProperty(t) && this.unlockFeature(t, e);
  }
};
l !== -1 && (s.customLockedReasons.splice(l, 1), 0 === s.customLockedReasons.length && (s.customLockedReasons = null));
s.base = o.evaluateCurrent();
a.playerData.jobs.on("jobListUpdated", function () {
  e.updateFeatureId("job");
});
a.playerData.alliance.on("allianceUpdated", function () {
  e.updateFeatureId("alliance");
});
a.playerData.alliance.on("allianceJoined", function () {
  e.updateFeatureId("alliance");
});
a.playerData.alliance.on("allianceLeft", function () {
  e.updateFeatureId("alliance");
});
a.playerData.guild.on("GuildGeneralInformationUpdate", function () {
  e.updateFeatureId("guild");
});
a.playerData.guild.on("guildLeft", function () {
  e.updateFeatureId("guild");
});
a.playerData.on("setMount", function () {
  e.updateFeatureId("mount");
});
a.playerData.on("unsetMount", function () {
  e.updateFeatureId("mount");
});
d.on("MapComplementaryInformationsDataMessage", function () {
  e.updateFeatureId("koliseum");
});
d.on("MapComplementaryInformationsDataInHouseMessage", function () {
  e.updateFeatureId("koliseum");
});
a.playerData.on("characterLevelUp", function () {
  e.updateFeatureId("koliseum");
});
a.playerData.socialData.on("spouseUpdate", function () {
  e.updateFeatureId("spouse");
});
a.playerData.socialData.on("spouseLeft", function () {
  e.updateFeatureId("spouse");
});
a.playerData.achievements.on("achievementListUpdated", function () {
  e.updateFeatureId("directory");
  e.updateFeatureId("alignment");
});
a.playerData.achievements.on("achievementFinished", function () {
  e.updateFeatureId("directory");
  e.updateFeatureId("alignment");
});
e.updateFeatureId("directory");
e.updateFeatureId("alignment");
e.updateFeatureId("directory");
e.updateFeatureId("alignment");
n.addWindow("breedDetail", new r());
n.addWindow("breeding", new l(), {
  fixed: !0,
  group: "inventory"
});
n.addWindow("cancel", new Ce());
n.addWindow("characterCreation", new ue(), {
  fixed: !0
});
n.addWindow("firstCharacterForm", new Qe());
n.addWindow("breedHighlightWindow", new Ke());
n.addWindow("characterOrientation", new he());
n.addWindow("serverSimpleSelection", new j(), {
  fixed: !0
});
n.addWindow("serverListSelection", new q(), {
  fixed: !0
});
n.addWindow("serverDetails", new U());
n.addWindow("serverSelection", new Y(), {
  fixed: !0
});
n.addWindow("worldMap", new ie());
n.addWindow("characteristics", new c(), {
  group: "mainGroup"
});
n.addWindow("characUpdate", new m());
n.addWindow("fightEnd", new y());
n.addWindow("fightList", new w());
n.addWindow("itemAppearance", new L());
n.addWindow("itemBox", new O());
n.addWindow("itemManage", new R());
n.addWindow("itemRecipes", new D());
n.addWindow("itemSets", new P());
n.addWindow("levelUp", new B());
n.addWindow("rewardsPending", new G());
n.addWindow("characterSelection", new d(), {
  fixed: !0
});
n.addWindow("giftSelection", new h(), {
  fixed: !0
});
n.addWindow("deleteCharacterConfirm", new p(), {
  fixed: !0
});
n.addWindow("options", new Ie());
n.addWindow("adminConsole", new a());
n.addWindow("document", new f());
n.addWindow("houseBuySell", new x());
n.addWindow("teleporterList", new V());
n.addWindow("exchangeInventory", new X(i), {
  group: "inventory"
});
n.addWindow("exchangeStorage", new Q());
n.addWindow("wallet", new ee());
n.addWindow("tradeInventory", new Z(i), {
  group: "inventory"
});
n.addWindow("tradeStorage", new $());
n.addWindow("tradeItem", new K());
n.addWindow("tradeItemConfirm", new J());
n.addWindow("bidHouseShop", new te());
n.addWindow("mimicry", new k());
n.addWindow("itemPicking", new F(i), {
  group: "inventory"
});
n.addWindow("padlock", new H());
n.addWindow("global", new b());
n.addWindow("prismVulnerabilityDate", new T());
n.addWindow("socialGroupCreation", new C());
n.addWindow("allianceCard", new I());
n.addWindow("guildCard", new A());
n.addWindow("guildHouseInfo", new S());
n.addWindow("guildHouseSetting", new E());
n.addWindow("equipment", new g(i), {
  group: "inventory"
});
n.addWindow("estateForSale", new _());
n.addWindow("estateInformation", new v());
n.addWindow("partyInviteDetails", new z());
n.addWindow("presetChooseIcon", new W());
n.addWindow("arena", new s());
n.addWindow("grimoire", new M(), {
  group: "mainGroup"
});
n.addWindow("social", new ne(), {
  group: "mainGroup"
});
n.addWindow("paddockBuy", new oe());
n.addWindow("mount", new ae());
n.addWindow("feed", new se());
n.addWindow("mountRename", new re());
n.addWindow("familyTree", new le());
n.addWindow("jobOptions", new ce());
n.addWindow("spellForget", new de());
n.addWindow("crafting", new pe());
n.addWindow("craftingMulti", new me());
n.addWindow("craftersList", new fe());
n.addWindow("crafter", new ge());
n.addWindow("craftMagus", new _e());
n.addWindow("craftMagusMulti", new ve());
n.addWindow("craftPayment", new ye());
n.addWindow("craftInventory", new we(i), {
  group: "inventory"
});
n.addWindow("tradeWithNPC", new Me());
n.addWindow("tradeWithPlayer", new be());
n.addWindow("tradeWithPlayerAndNPCInventory", new Te(i), {
  group: "inventory"
});
n.addWindow("guildMemberRights", new N());
n.addWindow("fightEndRewards", new Ae());
n.addWindow("hardcoreDeath", new Se());
n.addWindow("purchasesPending", new Le(e, t));
n.addWindow("buyHardCurrencyConfirm", new xe());
n.addWindow("shopConfirm", new Ee());
n.addWindow("market", new Ne(e, t));
n.addWindow("toa", new Oe());
n.addWindow("shieldWindow", new Re(), {
  group: "inventory"
});
n.addWindow("ShieldSelectionWindow", new De());
n.addWindow("help", new Pe());
n.addWindow("toaRetryPopup", new Be());
n.addWindow("DailyQuestRerollWindow", new ke());
n.addWindow("PromotionPopupWindow", new Fe());
n.addWindow("BonusPackElitePopupWindow", new He());
n.addWindow("marketingWindow", new ze());
n.addWindow("ratingWindow", new We());
n.addWindow("dailyQuest", new Ue());
n.addWindow("calligraphyWindow", new u());
n.addWindow("panjidexWindow", new Ge());
n.addWindow("featureIntroWindow", new qe());
n.addWindow("legendaryWeaponAwakeningWindow", new Ye(Je), {
  fixed: !0
});
n.addWindow("legendaryWeaponUpgradingWindow", new je(Je), {
  fixed: !0
});
n.addWindow("legendaryWeaponShatterWindow", new Ve(Je), {
  fixed: !0
});
n.addWindow("legendaryWeaponConversionWindow", new Xe(Je));
h.call(this);
e = e || {};
this.itemList = {};
this._filteredItemList = {};
this._sortedItemList = [];
this.itemsQuantityList = {};
this.slotList = {};
this.weight = 0;
this.maxWeight = 1;
this._isTagBarHidden = !0;
this._disconneting = !1;
this._waitingForBankReply = !1;
this.enablePresets = e.enablePresets;
this.enableLookAllObjects = e.enableLookAllObjects;
this._defaultFilter = function (e, t, i, n, o, a) {
  if (!this.enableLookAllObjects && e.position !== D) {
    return !1;
  }
  if (0 === t) {
    return !1;
  }
  if (this.filteringOptions.usable && !e.item.usable) {
    return !1;
  }
  if (!this.filterCategories[i]) {
    return !1;
  }
  if (i !== this.filteringOptions.filterId && o) {
    return !1;
  }
  if (e.item.typeId !== this.filteringOptions.subFilterId && a) {
    return !1;
  }
  if (n && e.isFullSoulStone()) {
    for (var s = 0; s < e.effects.length; s++) {
      if (m.simplifyString(e.effects[s].description).indexOf(n) !== -1) {
        return !0;
      }
    }
  }
  return !n || e.item.getNameForSearch().indexOf(n) !== -1;
};
this._filters = [this._defaultFilter];
t && this.setDataHandler(t);
this.currentOpenedWindow = null;
this.selectedSlot = null;
this.slotToShow = null;
this.filterCategories = {};
this.filteringOptions = {};
this.storageUI = new I("div", {
  className: "StorageViewer"
});
this.domIsCreated = !1;
this.contentInitiated = !1;
this.listUpdateRequested = null;
this.dataHandlerItemList = null;
this._itemFilter = null;
this.sortingCriterias = null;
this.sortingOrder = "";
this.currentPage = -1;
this.pageCount = -1;
this.dragSourceData = {};
this._setupListeners();
f(n, h);
e.exports = n;
n.prototype._setupListeners = function () {
  var e = this;
  window.gui.playerData.characters.on("characteristicsUpdated", function (t) {
    e._waitingForBankReply && (e._waitingForBankReply = !1, window.gui.openConfirmPopup({
      title: p("ui.popup.warning"),
      message: p("ui.popup.bankWarning", t.remoteBankTaxKamas),
      cb: function (e) {
        E.log("HUD.Click_on_button", {
          interface_id: "mainUI",
          button_id: "BTN_BANK",
          clic_parameter_key: "using",
          clic_parameter_value: Boolean(e),
          clic_type: "Simple_court"
        });
        e && window.dofus.sendMessage("NpcGenericActionRequestMessage", {
          npcActionId: 11,
          npcId: 0,
          npcMapId: -1
        });
      }
    }));
  });
};
n.prototype.setDataHandler = function (e) {
  e && (this._setupEvents(e), this.enablePresets && this.on("StorageViewerOpen", function () {
    this.setWeight(e.weight, e.maxWeight);
    this.setKamas(e.kamas);
  }));
};
n.prototype._updatePageSystem = function (e) {
  var t = this.currentOpenedWindow;
  t && (t._storageViewer = t._storageViewer || {}, this.slotsMask.setStyles({
    width: t.availableSlotBoxWidth,
    height: t.availableSlotBoxHeight
  }), this._updatePageCount(t, e), this.slotsBox.setStyle("height", t._storageViewer.slotsPerColumn * this.pageCount * N + "px"), this.slotsBox.show());
};
n.prototype._updatePageCount = function (e, t) {
  var i = e._storageViewer;
  if (i.slotsPerPage) {
    var n = Math.ceil(this.displayedSlotCount / i.slotsPerPage) || 1;
    (n !== this.pageCount || t) && (this.pageCount = n, this._displayPage(0, t), this.pagination.setPageCount(n));
  }
};
n.prototype.setBankButtonAvailability = function () {
  this.bankButton.setEnable(!(window.gui.playerData.achievements.finishedAchievementsIds.indexOf(A.ASTRUB_ACHIEVEMENT) < 0));
};
n.prototype._getAvailableSpaceAndUpdatePageSystem = function () {
  var e = this.currentOpenedWindow;
  if (!e) {
    return !1;
  }
  e._storageViewer = e._storageViewer || {};
  var t = e._storageViewer,
    i = this.storageUI.rootElement.clientHeight,
    n = this.pagination.rootElement.clientHeight,
    o = this.podContainer.rootElement.clientHeight,
    a = this._itemFilter.rootElement.clientHeight,
    s = this.noExtraMargin ? 0 : R,
    r = i - (n + o + a + s);
  if (r <= 0) {
    return !1;
  }
  var l = this.slotsContainer.rootElement.clientWidth,
    c = Math.floor(l / N);
  return t.slotsPerColumn = Math.floor((r - (this._isTagBarHidden ? 0 : O)) / N), t.slotsPerPage = c * t.slotsPerColumn, e.availableSlotBoxWidth = c * N + "px", e.availableSlotBoxHeight = t.slotsPerColumn * N + "px", this._updatePageSystem(), !0;
};
n.prototype._initializeView = function () {
  this._isTagBarHidden = !0;
  this._getAvailableSpaceAndUpdatePageSystem() && this.slotToShow && this._displaySlotPage(this.slotToShow);
};
n.prototype.registerView = function (e, t) {
  var i = this;
  t = t || {};
  e.on("open", function () {
    var n = i.currentOpenedWindow = this;
    if (i.dragSourceData.source = this.id, n.tapSelectedEmitsDoubleTap = t.tapSelectedEmitsDoubleTap, n.prepareForDragFunction = t.prepareForDragFunction, i._disconneting = !1, i.contextParams = t.contextParams || {}, i.enableAveragePrice = !t.hasOwnProperty("enableAveragePrice") || t.enableAveragePrice, i.enableSlotContext = !t.hasOwnProperty("enableSlotContext") || t.enableSlotContext, i.noExtraMargin = Boolean(t.noExtraMargin), i.domIsCreated || (i._createDom(), i.domIsCreated = !0), i.contentInitiated || i._spinner.addSpinner("loading"), i.averagePrice.toggleDisplay(!!i.enableAveragePrice), t.manualOpening || e.windowBody.appendChild(i.storageUI), e.availableSlotBoxWidth ? i._updatePageSystem() : i.slotsBox.hide(), i.currentOpenedWindow !== i.lastOpenedWindow) {
      i.leftArrow.toggleDisplay(!!t.leftArrow);
      i.rightArrow.toggleDisplay(!!t.rightArrow);
      i.slotsMask.toggleClassName("hoverable", !!t.showHoverFrame);
      var o;
      if (!i.listUpdateRequested) {
        for (o in i.slotList) {
          var a = i.slotList[o];
          a.data && (i.contextParams.item = a.data, a.setContextMenu("item", i.contextParams), a.enableContextMenu(!!i.enableSlotContext));
        }
      }
      i._itemFilter.setAvailableCategories(t.filters);
    }
    i.displayBankButton(Boolean(t.showBankButton));
    i.contentInitiated = !0;
    i.emit("StorageViewerOpen");
  });
  e.on("opened", function () {
    i.domIsCreated ? i._initializeView() : i.once("domCreated", i._initializeView);
    i.listUpdateRequested ? (i.setItemList(i.listUpdateRequested), i.dataHandlerItemList = i.listUpdateRequested, i.listUpdateRequested = null) : t.manualReset || i.resetDisplay();
  });
  e.on("close", function () {
    i.lastOpenedWindow = i.currentOpenedWindow;
    i.currentOpenedWindow = null;
  });
};
n.prototype._createDom = function () {
  function e(e) {
    return e >= x && e < L ? p("tablet.inventory.yellowWarningTooltip") : e >= L ? p("tablet.inventory.redWarningTooltip") : "";
  }
  var t = this,
    i = this.storageUI = new I("div", {
      className: "StorageViewer"
    }),
    n = i.createChild("div", {
      className: "filterBox"
    }),
    o = this.leftArrow = n.appendChild(s("left"));
  d.addTooltip(o, p("ui.storage.advancedTransferts"));
  o.on("tap", function (e) {
    t.currentOpenedWindow && t.currentOpenedWindow.emit("leftArrow-tap", e);
  });
  this._itemFilter = n.appendChild(new v({
    withTagBar: !0
  }));
  var a = this._itemFilter.getCurrentSorting();
  this.sortingCriterias = [a.by];
  this.sortingOrder = a.order;
  this.defaultSorting = this.sortingCriterias.toString() + "/" + this.sortingOrder;
  this.enablePresets && (this.presetsBox = i.appendChild(new w()), this.presetsBox.on("setItemSlotTapped", function (e) {
    e.data && "placeholder" === e.data.mountLocation || t.currentOpenedWindow.emit("slot-tap", e);
  }));
  this._itemFilter.toggleCategoryDisplay(g.categories.preset, !!this.enablePresets);
  this._itemFilter.on("filter", function (e, i, n) {
    var o = t.filteringOptions.filterId !== e || t.filteringOptions.subFilterId !== i || t.filteringOptions.search !== n;
    o && (t.filteringOptions.filterId = e, t.filteringOptions.subFilterId = i, t.filteringOptions.search = n, t._showTagBar(), t.filterList(), t.presetsBox && t._enablePresetsView(e === g.categories.preset), t._updateFilter(), t._getAvailableSpaceAndUpdatePageSystem(), t._displayPage(0, !0), t.emit("filter", e));
  });
  this._itemFilter.on("sort", function (e, i) {
    t._spinner.addSpinner("sorting");
    m.forceReflow(t.slotsContainer, function () {
      t.sortBy(e, i);
    });
  });
  o = this.rightArrow = n.appendChild(s("right"));
  d.addTooltip(o, p("ui.storage.advancedTransferts"));
  o.on("tap", function (e) {
    t.currentOpenedWindow && t.currentOpenedWindow.emit("rightArrow-tap", e);
  });
  this.slotsContainer = i.createChild("div", {
    className: "slotBox"
  });
  this.slotsMask = this.slotsContainer.createChild("div", {
    className: "slotsMask"
  });
  this.slotsBox = this.slotsMask.createChild("div", {
    className: "slots"
  });
  this.slotsBox.hide();
  this.slotsBox.rootElement.addEventListener(T.end, function (e) {
    e.preventDefault();
  }, !1);
  this._spinner = new M(this.slotsContainer, !0);
  var r = i.createChild("div", {
    className: "bottomContainer"
  });
  this.pagination = r.appendChild(new y());
  this.pagination.on("previous", function () {
    t._displayPage(t.currentPage - 1);
  });
  this.pagination.on("next", function () {
    t._displayPage(t.currentPage + 1);
  });
  this.pagination.on("page", function (e) {
    t._displayPage(e);
  });
  this.pagination.setPageCount(this.pageCount);
  this.bankButton = r.appendChild(new S({
    className: ["greenButton", "bankButton"],
    text: p("tablet.bank"),
    scaleOnPress: !0
  }));
  this.bankButton.toggleDisplay(!1);
  this.bankButton.on("tap", function () {
    t._waitingForBankReply = !0;
    window.dofus.sendMessage("CharacterStatsRequestMessage");
  });
  var l = this.podContainer = i.createChild("div", {
      className: "podContainer"
    }),
    c = l.createChild("div", {
      className: "priceBox"
    });
  this.averagePrice = c.createChild("div", {
    className: "averagePrice",
    text: 0
  });
  d.addTooltip(this.averagePrice, function () {
    var e = m.kamasToString(t.averagePriceValue);
    return new I("div", {
      text: p("ui.storage.estimatedValue") + p("ui.common.colon") + e
    });
  });
  this.kamas = c.createChild("div", {
    className: "kamas",
    text: 0
  });
  d.addTooltip(this.kamas, function () {
    var e = m.kamasToString(t.kamasValue);
    return new I("div", {
      text: p("ui.storage.ownedKamas") + p("ui.common.colon") + e
    });
  });
  var u = l.createChild("div", {
    className: "progressBarContainer"
  });
  this.barLabel = u.createChild("div", {
    text: p("tablet.common.pods") + ":",
    className: "label"
  });
  this.progressBar = u.appendChild(new b({
    className: "green"
  }));
  d.addTooltip(this.progressBar, function () {
    return new I("div", {
      text: e(t.weight / t.maxWeight) + "\n(" + m.intToString(t.weight) + " / " + m.intToString(t.maxWeight) + ")"
    });
  }, {
    longTapExplanation: !0
  });
  this.emit("domCreated");
};
n.prototype._showTagBar = function () {
  var e = this.filteringOptions,
    t = e.filterId !== -1 || e.subFilterId !== -1 || !!e.search,
    i = this.sortingCriterias.toString() + "/" + this.sortingOrder,
    n = i !== this.defaultSorting;
  this.slotsMask.toggleClassName("withFilter", t || n);
};
n.prototype.setBarLabel = function (e) {
  this.barLabel.setText(e);
};
n.prototype.displayBankButton = function (e) {
  this.bankButton.toggleDisplay(e);
};
n.prototype._enablePresetsView = function (e) {
  this.pagination.toggleDisplay(!e);
  this.podContainer.toggleDisplay(!e);
  this.kamas.toggleDisplay(!e);
  this.presetsBox.toggleDisplay(e);
};
n.prototype._filter = function (e, t, i, n, o, a) {
  for (var s = 0, r = this._filters.length; s < r; s += 1) {
    var l = this._filters[s];
    if (!l.call(this, e, t, i, n, o, a)) {
      return !1;
    }
  }
  return !0;
};
n.prototype._displayPage = function (e, t) {
  if (!t) {
    if (this.currentPage === e || !this.currentOpenedWindow) {
      return;
    }
    if (e < 0 || e > this.pageCount - 1) {
      return;
    }
  }
  this.currentPage = e;
  this.pagination.setCurrent(e);
  this.sortBy(this.sortingCriterias, this.sortingOrder);
};
n.prototype.addFilters = function (e) {
  for (var t = 0, i = e.length; t < i; t += 1) {
    this._filters.push(e[t]);
  }
};
n.prototype.removeFilter = function (e) {
  var t = this._filters;
  t.indexOf(e) !== -1 ? t.splice(t.indexOf(e), 1) : console.error(new Error("StorageViewer: remove unknown filter"));
};
n.prototype.clearFilters = function () {
  this._filters = [this._defaultFilter];
  this._filteredItemList = {};
};
n.prototype._updateAveragePrice = function () {
  var e = 0;
  for (var t in this._filteredItemList) {
    var i = this.itemList[t];
    if (i) {
      var n = i.getItem();
      if (n) {
        var o = n.averagePrice === -1 ? 0 : n.averagePrice;
        e += o * this.itemsQuantityList[t];
      } else {
        console.error(new Error("no item ref for " + (i.id || i.objectGID) + ", is an instance? " + i.isItemInstance + ", is yet initialised? " + i.isInitialised));
      }
    }
  }
  this.averagePriceValue = e;
  this.averagePrice.setText(m.intToString(e));
};
n.prototype._updateFilter = function () {
  var e = {};
  for (var t in this._filteredItemList) {
    var i = this._filteredItemList[t];
    if (i.position === D && this.itemsQuantityList[t] > 0) {
      if (!i.item) {
        console.error(new Error('Missing the property "item" for itemInstance: ' + i.id));
        continue;
      }
      e[i.item.typeId] = !0;
    }
  }
  this._itemFilter.updateSubFilters(Object.keys(e));
};
n.prototype._filterItem = function (e) {
  var t = this.slotList[e.objectUID];
  if (t) {
    var i = this.filteringOptions.search ? m.simplifyString(this.filteringOptions.search) : null,
      n = this.filteringOptions.filterId !== v.filters.all,
      o = this.filteringOptions.subFilterId !== v.subFilters.all,
      a = g.getItemTypeMap(),
      s = a[e.item.typeId].category,
      r = this.itemsQuantityList[e.objectUID],
      l = r && this._filter(e, r, s, i, n, o);
    this._setDisplayedSlotCount(i, n, o);
    t.isVisible() && (this.displayedSlotCount -= 1);
    l ? this.displayedSlotCount += 1 : this.unSelectSlot(e.objectUID);
    this._updatePageSystem();
    this.enableAveragePrice && this._updateAveragePrice();
  }
};
n.prototype._setDisplayedSlotCount = function (e, t, i) {
  this.displayedSlotCount = 0;
  var n = g.getItemTypeMap();
  this._filteredItemList = {};
  for (var o in this.itemList) {
    var a = this.itemList[o];
    if (a.isInitialised) {
      var s = n[a.item.typeId].category,
        r = this._filter(a, this.itemsQuantityList[o], s, e, t, i);
      r ? (this.displayedSlotCount += 1, this._filteredItemList[o] = a) : this.unSelectSlot(a.objectUID);
    }
  }
};
n.prototype.filterList = function (e) {
  var t = this.filteringOptions.search ? m.simplifyString(this.filteringOptions.search) : null,
    i = this.filteringOptions.filterId !== v.filters.all,
    n = this.filteringOptions.subFilterId !== v.subFilters.all;
  t || i || n ? this._isTagBarHidden = !1 : this._isTagBarHidden = !0;
  this._setDisplayedSlotCount(t, i, n);
  this._updatePageSystem(e);
  this.enableAveragePrice && this._updateAveragePrice();
};
n.prototype.getDisplayedItemsUIDs = function () {
  for (var e = [], t = this._sortedItemList, i = 0; i < t.length; i += 1) {
    var n = parseInt(t[i], 10);
    e.push(n);
  }
  return e;
};
n.prototype._createSlot = function (e) {
  var t = new _({
    itemData: e,
    enableContextMenu: this.enableSlotContext
  });
  t.storageViewer = this;
  t.setQuantity(e.quantity);
  t.setContextMenu("item", this.contextParams);
  var i = this;
  return t.on("tap", function (e) {
    t.selected ? i.currentOpenedWindow.emit("slot-doubletap", t, e.x, e.y) : t !== i.selectedSlot ? (i.selectSlot(t), i.currentOpenedWindow.emit("slot-tap", t, e.x, e.y)) : i.currentOpenedWindow.tapSelectedEmitsDoubleTap && i.currentOpenedWindow.emit("slot-doubletap", t, e.x, e.y);
  }), t.on("doubletap", function (e) {
    i.currentOpenedWindow.emit("slot-doubletap", this, e.x, e.y);
  }), t.on("dragStart", function () {
    u.setElementSource(this, i.currentOpenedWindow.id);
    i.dragSourceData.slot = t;
    i.currentOpenedWindow.emit("slot-dragStart", t);
  }), u.setDraggable(t, {
    backgroundImage: t.getImage(),
    prepareForDrag: r
  }, "storageViewer", i.dragSourceData), this.emit("slotCreated", t), t;
};
E.log("HUD.Click_on_button", {
  interface_id: "mainUI",
  button_id: "BTN_BANK",
  clic_parameter_key: "using",
  clic_parameter_value: Boolean(e),
  clic_type: "Simple_court"
});
e && window.dofus.sendMessage("NpcGenericActionRequestMessage", {
  npcActionId: 11,
  npcId: 0,
  npcMapId: -1
});
this.setWeight(e.weight, e.maxWeight);
this.setKamas(e.kamas);
this._isTagBarHidden = !0;
this._getAvailableSpaceAndUpdatePageSystem() && this.slotToShow && this._displaySlotPage(this.slotToShow);
t = t || {};
e.on("open", function () {
  var n = i.currentOpenedWindow = this;
  if (i.dragSourceData.source = this.id, n.tapSelectedEmitsDoubleTap = t.tapSelectedEmitsDoubleTap, n.prepareForDragFunction = t.prepareForDragFunction, i._disconneting = !1, i.contextParams = t.contextParams || {}, i.enableAveragePrice = !t.hasOwnProperty("enableAveragePrice") || t.enableAveragePrice, i.enableSlotContext = !t.hasOwnProperty("enableSlotContext") || t.enableSlotContext, i.noExtraMargin = Boolean(t.noExtraMargin), i.domIsCreated || (i._createDom(), i.domIsCreated = !0), i.contentInitiated || i._spinner.addSpinner("loading"), i.averagePrice.toggleDisplay(!!i.enableAveragePrice), t.manualOpening || e.windowBody.appendChild(i.storageUI), e.availableSlotBoxWidth ? i._updatePageSystem() : i.slotsBox.hide(), i.currentOpenedWindow !== i.lastOpenedWindow) {
    i.leftArrow.toggleDisplay(!!t.leftArrow);
    i.rightArrow.toggleDisplay(!!t.rightArrow);
    i.slotsMask.toggleClassName("hoverable", !!t.showHoverFrame);
    var o;
    if (!i.listUpdateRequested) {
      for (o in i.slotList) {
        var a = i.slotList[o];
        a.data && (i.contextParams.item = a.data, a.setContextMenu("item", i.contextParams), a.enableContextMenu(!!i.enableSlotContext));
      }
    }
    i._itemFilter.setAvailableCategories(t.filters);
  }
  i.displayBankButton(Boolean(t.showBankButton));
  i.contentInitiated = !0;
  i.emit("StorageViewerOpen");
});
e.on("opened", function () {
  i.domIsCreated ? i._initializeView() : i.once("domCreated", i._initializeView);
  i.listUpdateRequested ? (i.setItemList(i.listUpdateRequested), i.dataHandlerItemList = i.listUpdateRequested, i.listUpdateRequested = null) : t.manualReset || i.resetDisplay();
});
e.on("close", function () {
  i.lastOpenedWindow = i.currentOpenedWindow;
  i.currentOpenedWindow = null;
});
i.leftArrow.toggleDisplay(!!t.leftArrow);
i.rightArrow.toggleDisplay(!!t.rightArrow);
i.slotsMask.toggleClassName("hoverable", !!t.showHoverFrame);
i.displayBankButton(Boolean(t.showBankButton));
i.contentInitiated = !0;
i.emit("StorageViewerOpen");
i.domIsCreated ? i._initializeView() : i.once("domCreated", i._initializeView);
i.listUpdateRequested ? (i.setItemList(i.listUpdateRequested), i.dataHandlerItemList = i.listUpdateRequested, i.listUpdateRequested = null) : t.manualReset || i.resetDisplay();
i.lastOpenedWindow = i.currentOpenedWindow;
i.currentOpenedWindow = null;
d.addTooltip(o, p("ui.storage.advancedTransferts"));
o.on("tap", function (e) {
  t.currentOpenedWindow && t.currentOpenedWindow.emit("leftArrow-tap", e);
});
this._itemFilter = n.appendChild(new v({
  withTagBar: !0
}));
this.sortingCriterias = [a.by];
this.sortingOrder = a.order;
this.defaultSorting = this.sortingCriterias.toString() + "/" + this.sortingOrder;
this.enablePresets && (this.presetsBox = i.appendChild(new w()), this.presetsBox.on("setItemSlotTapped", function (e) {
  e.data && "placeholder" === e.data.mountLocation || t.currentOpenedWindow.emit("slot-tap", e);
}));
this._itemFilter.toggleCategoryDisplay(g.categories.preset, !!this.enablePresets);
this._itemFilter.on("filter", function (e, i, n) {
  var o = t.filteringOptions.filterId !== e || t.filteringOptions.subFilterId !== i || t.filteringOptions.search !== n;
  o && (t.filteringOptions.filterId = e, t.filteringOptions.subFilterId = i, t.filteringOptions.search = n, t._showTagBar(), t.filterList(), t.presetsBox && t._enablePresetsView(e === g.categories.preset), t._updateFilter(), t._getAvailableSpaceAndUpdatePageSystem(), t._displayPage(0, !0), t.emit("filter", e));
});
this._itemFilter.on("sort", function (e, i) {
  t._spinner.addSpinner("sorting");
  m.forceReflow(t.slotsContainer, function () {
    t.sortBy(e, i);
  });
});
o = this.rightArrow = n.appendChild(s("right"));
d.addTooltip(o, p("ui.storage.advancedTransferts"));
o.on("tap", function (e) {
  t.currentOpenedWindow && t.currentOpenedWindow.emit("rightArrow-tap", e);
});
this.slotsContainer = i.createChild("div", {
  className: "slotBox"
});
this.slotsMask = this.slotsContainer.createChild("div", {
  className: "slotsMask"
});
this.slotsBox = this.slotsMask.createChild("div", {
  className: "slots"
});
this.slotsBox.hide();
this.slotsBox.rootElement.addEventListener(T.end, function (e) {
  e.preventDefault();
}, !1);
this._spinner = new M(this.slotsContainer, !0);
t._spinner.addSpinner("sorting");
m.forceReflow(t.slotsContainer, function () {
  t.sortBy(e, i);
});
this.pagination = r.appendChild(new y());
this.pagination.on("previous", function () {
  t._displayPage(t.currentPage - 1);
});
this.pagination.on("next", function () {
  t._displayPage(t.currentPage + 1);
});
this.pagination.on("page", function (e) {
  t._displayPage(e);
});
this.pagination.setPageCount(this.pageCount);
this.bankButton = r.appendChild(new S({
  className: ["greenButton", "bankButton"],
  text: p("tablet.bank"),
  scaleOnPress: !0
}));
this.bankButton.toggleDisplay(!1);
this.bankButton.on("tap", function () {
  t._waitingForBankReply = !0;
  window.dofus.sendMessage("CharacterStatsRequestMessage");
});
t._waitingForBankReply = !0;
window.dofus.sendMessage("CharacterStatsRequestMessage");
this.averagePrice = c.createChild("div", {
  className: "averagePrice",
  text: 0
});
d.addTooltip(this.averagePrice, function () {
  var e = m.kamasToString(t.averagePriceValue);
  return new I("div", {
    text: p("ui.storage.estimatedValue") + p("ui.common.colon") + e
  });
});
this.kamas = c.createChild("div", {
  className: "kamas",
  text: 0
});
d.addTooltip(this.kamas, function () {
  var e = m.kamasToString(t.kamasValue);
  return new I("div", {
    text: p("ui.storage.ownedKamas") + p("ui.common.colon") + e
  });
});
this.barLabel = u.createChild("div", {
  text: p("tablet.common.pods") + ":",
  className: "label"
});
this.progressBar = u.appendChild(new b({
  className: "green"
}));
d.addTooltip(this.progressBar, function () {
  return new I("div", {
    text: e(t.weight / t.maxWeight) + "\n(" + m.intToString(t.weight) + " / " + m.intToString(t.maxWeight) + ")"
  });
}, {
  longTapExplanation: !0
});
this.emit("domCreated");
this.pagination.toggleDisplay(!e);
this.podContainer.toggleDisplay(!e);
this.kamas.toggleDisplay(!e);
this.presetsBox.toggleDisplay(e);
this.currentPage = e;
this.pagination.setCurrent(e);
this.sortBy(this.sortingCriterias, this.sortingOrder);
this._filters = [this._defaultFilter];
this._filteredItemList = {};
this.averagePriceValue = e;
this.averagePrice.setText(m.intToString(e));
this._setDisplayedSlotCount(i, n, o);
t.isVisible() && (this.displayedSlotCount -= 1);
l ? this.displayedSlotCount += 1 : this.unSelectSlot(e.objectUID);
this._updatePageSystem();
this.enableAveragePrice && this._updateAveragePrice();
t || i || n ? this._isTagBarHidden = !1 : this._isTagBarHidden = !0;
this._setDisplayedSlotCount(t, i, n);
this._updatePageSystem(e);
this.enableAveragePrice && this._updateAveragePrice();
t.storageViewer = this;
t.setQuantity(e.quantity);
t.setContextMenu("item", this.contextParams);
u.setElementSource(this, i.currentOpenedWindow.id);
i.dragSourceData.slot = t;
i.currentOpenedWindow.emit("slot-dragStart", t);
n.prototype._displaySlotPage = function (e) {
  var t = this.currentOpenedWindow && this.currentOpenedWindow._storageViewer;
  if (!t || !t.slotsPerPage) {
    return void (this.slotToShow = e);
  }
  this.slotToShow = null;
  for (var i = this.slotsBox.getChildren(), n = 0, o = 0; o < i.length; o++) {
    var a = i[o];
    if (a.isVisible()) {
      if (a === e) {
        return void this._displayPage(~~(n / t.slotsPerPage));
      }
      n++;
    }
  }
};
n.prototype.sortBy = function (e, t) {
  var i = this.currentOpenedWindow;
  if (i) {
    var n = this._filteredItemList,
      o = this,
      a = this.slotsBox.getChildren();
    a.forEach(function (e) {
      o.slotsBox.rootElement && e && o.slotsBox.removeChild(e);
    });
    var s = i._storageViewer;
    if (e && n) {
      this.sortingCriterias = e;
      this.sortingOrder = t;
      var r = Object.keys(n).sort(function (i, o) {
        return c(e, t, n[i], n[o]);
      });
      this._sortedItemList = r;
      for (var l = this.currentPage ? this.currentPage * s.slotsPerPage : 0, d = this.pageCount > this.currentPage && r.length > s.slotsPerPage ? (this.currentPage + 1) * s.slotsPerPage : r.length, u = l; u < d; u += 1) {
        var h = this.slotList[r[u]];
        if (!h) {
          var p = parseInt(r[u], 10),
            m = this.itemList[p];
          if (!m) {
            continue;
          }
          this.slotList[p] = this._createSlot(m);
          this.itemsQuantityList[p] = m.quantity;
          h = this.slotList[r[u]];
        }
        this.slotsBox.appendChild(h);
      }
      this._spinner.removeSpinner("sorting");
      this._getAvailableSpaceAndUpdatePageSystem();
      this._showTagBar();
    }
  }
};
n.prototype.resetDisplay = function () {
  for (var e in this.itemList) {
    var t = this.itemsQuantityList[e] = this.itemList[e].quantity;
    this.slotList[e] && this.slotList[e].setQuantity(t);
  }
  this._itemFilter && this._itemFilter.reset();
  this.pageCount = -1;
  this.currentPage = -1;
  this._updatePageSystem();
  this.selectedSlot && this.unSelectSlot();
};
n.prototype.unloadContent = function () {
  this._disconneting || (this.slotList = {}, this.slotsBox && this.slotsBox.clearContent(), this._filteredItemList = {}, this.itemsQuantityList = {}, this.itemList = [], this.selectedSlot = null, this.contentInitiated = !1, this.currentPage = -1, this.pageCount = -1, this.listUpdateRequested = this.dataHandlerItemList);
};
n.prototype._disconnectionReset = function () {
  this.unloadContent();
  this._sortedItemList = [];
  this.listUpdateRequested = null;
};
n.prototype.setItemList = function (e) {
  this._spinner && !this._spinner.isActive() && console.warn("Missing spinner", this.dragSourceData);
  this.slotsBox && this.slotsBox.clearContent();
  this.slotList = {};
  this.itemsQuantityList = {};
  this.itemList = e;
  this.selectedSlot = null;
  for (var t in this.itemList) {
    var i = this.itemList[t];
    this.itemsQuantityList[t] = i.quantity;
  }
  this.filterList();
  this._updateFilter();
  this._itemFilter.reset();
  this.sortBy(this.sortingCriterias, this.sortingOrder);
  this._spinner.removeSpinner("loading");
};
n.prototype.modifyItem = function (e) {
  if (this.contentInitiated) {
    var t = e.objectUID,
      i = this.slotList[t];
    i && (this.unSelectSlot(t), i.destroy(), delete this.slotList[t]);
    this.slotList[t] = this._createSlot(e);
    this.itemList[t] = e;
    this.itemsQuantityList[t] = e.quantity;
    this._filterItem(e);
    this.filterList();
    this._displayPage(this.currentPage, !0);
    this.currentOpenedWindow && this.currentOpenedWindow.emit("itemModified", e);
  }
};
n.prototype.moveItem = function (e) {
  if (this.contentInitiated) {
    var t = e.objectUID,
      i = this.slotList[t];
    i || (this.slotList[t] = this._createSlot(e));
    this._filterItem(e);
    this._updateFilter();
    this.currentOpenedWindow && this.currentOpenedWindow.emit("itemMoved", e);
    this.filterList();
    this._displayPage(this.currentPage, !0);
  }
};
n.prototype.setItemQuantity = function (e, t) {
  var i = this.currentOpenedWindow;
  if (this.itemsQuantityList[e] = t, i && this.contentInitiated) {
    var n = this.slotList[e],
      o = this.itemList[e];
    return n || o ? void (n && (n.setQuantity(t), this._filterItem(this.itemList[e]), this._updateFilter(), this.filterList(), this._displayPage(this.currentPage, !0), this.currentOpenedWindow && this.currentOpenedWindow.emit("itemQuantity", this.itemList[e], t))) : void console.error(new Error("No slot with item UID " + e));
  }
};
n.prototype.setItemsQuantity = function (e) {
  if (this.contentInitiated) {
    for (var t in e) {
      var i = this.slotList[t],
        n = this.itemList[t],
        o = e[t];
      if (!i && !n) {
        return void console.error(new Error("No slot with item UID " + t));
      }
      i && (i.setQuantity(o), this.itemsQuantityList[t] = o, this._filterItem(this.itemList[t]));
    }
    this._updateFilter();
    this.filterList();
    this._displayPage(this.currentPage, !0);
    this.currentOpenedWindow && this.currentOpenedWindow.emit("itemsQuantity", e);
  }
};
n.prototype.resetItemQuantity = function (e) {
  var t = this.itemList[e];
  t && this.setItemQuantity(e, t.quantity);
};
n.prototype.resetItemsQuantity = function () {
  for (var e in this.itemList) {
    this.resetItemQuantity(e);
  }
  this.filterList();
  this._displayPage(this.currentPage, !0);
};
n.prototype._addItem = function (e) {
  var t = e.objectUID,
    i = this.slotList[t];
  i && this._removeItem(t);
  this.itemList[t] = e;
  this.itemsQuantityList[t] = e.quantity;
};
n.prototype.addItem = function (e) {
  this.contentInitiated && (this._addItem(e), this._filterItem(e), this._updateFilter(), this.filterList(), this._displayPage(this.currentPage, !0), this.currentOpenedWindow && this.currentOpenedWindow.emit("itemAdded", e));
};
n.prototype.addItems = function (e) {
  if (this.contentInitiated) {
    for (var t in e) {
      var i = e[t];
      this._addItem(i);
      this._filterItem(i);
    }
    this.filterList();
    this._displayPage(this.currentPage, !0);
    this._updateFilter();
    this.currentOpenedWindow && this.currentOpenedWindow.emit("itemsAdded", e);
  }
};
n.prototype._removeItem = function (e) {
  var t = this.slotList[e];
  t && (this.unSelectSlot(t.itemInstance.objectUID), t.destroy());
  delete this.slotList[e];
  delete this.itemList[e];
  delete this.itemsQuantityList[e];
  delete this._filteredItemList[e];
};
n.prototype.removeItems = function (e) {
  if (this.contentInitiated) {
    for (var t = 0, i = e.length; t < i; t += 1) {
      this._removeItem(e[t]);
    }
    this._updateFilter();
    this.currentOpenedWindow && this.currentOpenedWindow.emit("itemsRemoved", e);
    this.filterList();
    this._displayPage(this.currentPage, !0);
  }
};
n.prototype.removeItem = function (e) {
  this.contentInitiated && (this._removeItem(e), this._updateFilter(), this.currentOpenedWindow && this.currentOpenedWindow.emit("itemRemoved", e), this.filterList(), this._displayPage(this.currentPage, !0));
};
n.prototype.setPodProgressBarValue = function (e) {
  this.progressBar.setValue(e);
  this.progressBar.toggleClassName("green", e < .75);
  this.progressBar.toggleClassName("yellow", e >= .75 && e < .9);
  this.progressBar.toggleClassName("orange", e >= .9 && e < 1);
  this.progressBar.toggleClassName("red", e >= 1);
  this.progressBar.toggleClassName("warnYellowIconCircle", e >= x && e < L);
  this.progressBar.toggleClassName("warnRedIconCircle", e >= L);
};
n.prototype.setMaxWeight = function (e) {
  this.maxWeight = e || 1;
  this.contentInitiated && (this.setPodProgressBarValue(this.weight / this.maxWeight), this.currentOpenedWindow && this.currentOpenedWindow.emit("weightUpdated", this.weight, this.maxWeight));
};
n.prototype.refreshSlotGauge = function () {
  this.setWeight(Object.keys(this.itemList).length);
};
n.prototype.setWeight = function (e, t) {
  this.weight = e;
  this.maxWeight = t || this.maxWeight;
  this.contentInitiated && (this.setPodProgressBarValue(this.weight / this.maxWeight), this.currentOpenedWindow && this.currentOpenedWindow.emit("weightUpdated", e, this.maxWeight));
};
n.prototype.setKamas = function (e) {
  this.contentInitiated && (this.kamasValue = e, this.kamas.setText(m.intToString(e)), this.currentOpenedWindow && this.currentOpenedWindow.emit("kamasUpdated", e));
};
n.prototype.selectAndShowSlotByGID = function (e) {
  for (var t in this.slotList) {
    var i = this.itemList[t];
    if (i.getProperty("id") === e && this._selectSlotAndDisplayPage(this.slotList[t])) {
      return i;
    }
  }
  return null;
};
n.prototype.getSlotByUID = function (e) {
  return this.slotList[e];
};
n.prototype.selectAndShowSlotByUID = function (e) {
  var t = this.slotList[e];
  return t && this._selectSlotAndDisplayPage(t) ? t.itemInstance : null;
};
n.prototype._selectSlotAndDisplayPage = function (e) {
  return !!e.isVisible() && (this.selectSlot(e), this._displaySlotPage(e), !0);
};
n.prototype.selectSlot = function (e, t) {
  this.selectedSlot && e !== this.selectedSlot && this.selectedSlot.unselect();
  e && e.select(t);
  this.selectedSlot = e;
};
n.prototype.unSelectSlot = function (e) {
  if (void 0 === e) {
    return void (this.selectedSlot && (this.selectedSlot.unselect(), this.selectedSlot = null));
  }
  var t = this.slotList[e];
  this.selectedSlot === t && (t.unselect(), this.selectedSlot = null);
};
n.prototype.toggleSlotSelection = function (e) {
  var t = this.slotList[e];
  this.selectedSlot !== t ? (this.selectedSlot && this.selectedSlot.unselect(), t.select(), this.selectedSlot = t) : (t.unselect(), this.selectedSlot = null);
};
n.prototype.getSelectedSlot = function () {
  return this.selectedSlot;
};
n.prototype._setupEvents = function (e) {
  var t = this;
  e.on("listUpdate", function (e) {
    t.currentOpenedWindow ? t.setItemList(e) : t.listUpdateRequested = e;
  });
  e.on("unloaded", function () {
    t._disconnectionReset();
    t._disconneting = !0;
  });
  e.on("itemAdded", function (e) {
    t.addItem(e);
  });
  e.on("itemsAdded", function (e) {
    t.addItems(e);
  });
  e.on("itemDeleted", function (e) {
    t.removeItem(e);
  });
  e.on("itemsDeleted", function (e) {
    t.removeItems(e);
  });
  e.on("itemModified", function (e) {
    t.modifyItem(e);
  });
  e.on("itemMoved", function (e) {
    t.moveItem(e);
  });
  e.on("itemQuantity", function (e, i) {
    t.setItemQuantity(e, i);
  });
  e.on("itemsQuantity", function (e) {
    t.setItemsQuantity(e);
  });
  e.on("kamasUpdated", function (e) {
    t.setKamas(e);
  });
  e.on("weightUpdated", function (e, i) {
    t.setWeight(e, i);
  });
};
n.prototype.getDisplayedQuantity = function (e) {
  return this.itemsQuantityList[e];
};
n.prototype.getEquipmentFilterButtonForTuto = function () {
  return this._itemFilter.getEquipmentButton();
};
n.prototype.getQuestFilterButtonForTuto = function () {
  return this._itemFilter.getQuestButton();
};
n.prototype.getStorageFirstSlotForTuto = function () {
  var e = this.slotsBox.getChildren();
  return e[0];
};
n.prototype.showEquippableItems = function () {
  this._itemFilter.selectCategory(v.filters.equipment);
};
n.prototype.showTokens = function (e) {
  this._itemFilter.toggleCategoryDisplay(e, !0);
  this._itemFilter.selectCategory(e);
};
this.sortingCriterias = e;
this.sortingOrder = t;
this.slotList[p] = this._createSlot(m);
this.itemsQuantityList[p] = m.quantity;
h = this.slotList[r[u]];
this._spinner.removeSpinner("sorting");
this._getAvailableSpaceAndUpdatePageSystem();
this._showTagBar();
this._itemFilter && this._itemFilter.reset();
this.pageCount = -1;
this.currentPage = -1;
this._updatePageSystem();
this.selectedSlot && this.unSelectSlot();
this.unloadContent();
this._sortedItemList = [];
this.listUpdateRequested = null;
this._spinner && !this._spinner.isActive() && console.warn("Missing spinner", this.dragSourceData);
this.slotsBox && this.slotsBox.clearContent();
this.slotList = {};
this.itemsQuantityList = {};
this.itemList = e;
this.selectedSlot = null;
this.filterList();
this._updateFilter();
this._itemFilter.reset();
this.sortBy(this.sortingCriterias, this.sortingOrder);
this._spinner.removeSpinner("loading");
i && (this.unSelectSlot(t), i.destroy(), delete this.slotList[t]);
this.slotList[t] = this._createSlot(e);
this.itemList[t] = e;
this.itemsQuantityList[t] = e.quantity;
this._filterItem(e);
this.filterList();
this._displayPage(this.currentPage, !0);
this.currentOpenedWindow && this.currentOpenedWindow.emit("itemModified", e);
i || (this.slotList[t] = this._createSlot(e));
this._filterItem(e);
this._updateFilter();
this.currentOpenedWindow && this.currentOpenedWindow.emit("itemMoved", e);
this.filterList();
this._displayPage(this.currentPage, !0);
this._updateFilter();
this.filterList();
this._displayPage(this.currentPage, !0);
this.currentOpenedWindow && this.currentOpenedWindow.emit("itemsQuantity", e);
this.filterList();
this._displayPage(this.currentPage, !0);
i && this._removeItem(t);
this.itemList[t] = e;
this.itemsQuantityList[t] = e.quantity;
this._addItem(i);
this._filterItem(i);
this.filterList();
this._displayPage(this.currentPage, !0);
this._updateFilter();
this.currentOpenedWindow && this.currentOpenedWindow.emit("itemsAdded", e);
t && (this.unSelectSlot(t.itemInstance.objectUID), t.destroy());
delete this.slotList[e];
delete this.itemList[e];
delete this.itemsQuantityList[e];
delete this._filteredItemList[e];
this._updateFilter();
this.currentOpenedWindow && this.currentOpenedWindow.emit("itemsRemoved", e);
this.filterList();
this._displayPage(this.currentPage, !0);
this.progressBar.setValue(e);
this.progressBar.toggleClassName("green", e < .75);
this.progressBar.toggleClassName("yellow", e >= .75 && e < .9);
this.progressBar.toggleClassName("orange", e >= .9 && e < 1);
this.progressBar.toggleClassName("red", e >= 1);
this.progressBar.toggleClassName("warnYellowIconCircle", e >= x && e < L);
this.progressBar.toggleClassName("warnRedIconCircle", e >= L);
this.maxWeight = e || 1;
this.contentInitiated && (this.setPodProgressBarValue(this.weight / this.maxWeight), this.currentOpenedWindow && this.currentOpenedWindow.emit("weightUpdated", this.weight, this.maxWeight));
this.weight = e;
this.maxWeight = t || this.maxWeight;
this.contentInitiated && (this.setPodProgressBarValue(this.weight / this.maxWeight), this.currentOpenedWindow && this.currentOpenedWindow.emit("weightUpdated", e, this.maxWeight));
this.selectedSlot && e !== this.selectedSlot && this.selectedSlot.unselect();
e && e.select(t);
this.selectedSlot = e;
e.on("listUpdate", function (e) {
  t.currentOpenedWindow ? t.setItemList(e) : t.listUpdateRequested = e;
});
e.on("unloaded", function () {
  t._disconnectionReset();
  t._disconneting = !0;
});
e.on("itemAdded", function (e) {
  t.addItem(e);
});
e.on("itemsAdded", function (e) {
  t.addItems(e);
});
e.on("itemDeleted", function (e) {
  t.removeItem(e);
});
e.on("itemsDeleted", function (e) {
  t.removeItems(e);
});
e.on("itemModified", function (e) {
  t.modifyItem(e);
});
e.on("itemMoved", function (e) {
  t.moveItem(e);
});
e.on("itemQuantity", function (e, i) {
  t.setItemQuantity(e, i);
});
e.on("itemsQuantity", function (e) {
  t.setItemsQuantity(e);
});
e.on("kamasUpdated", function (e) {
  t.setKamas(e);
});
e.on("weightUpdated", function (e, i) {
  t.setWeight(e, i);
});
t._disconnectionReset();
t._disconneting = !0;
this._itemFilter.toggleCategoryDisplay(e, !0);
this._itemFilter.selectCategory(e);
e.setData(t);
s.preloadImage("gfx/mounts/" + t.model + ".png", function (t) {
  e.setImage(t);
});
t(!e.preset);
e.preset ? (L.deleteSetButton.enable(), L.saveSetButton.enable()) : (L.deleteSetButton.disable(), L.saveSetButton.disable());
L.explanationPanel.toggleDisplay(e);
L.setItemSlotsBox.toggleDisplay(!e);
L.buttonsBox.toggleDisplay(!e);
L.setSlotsBox.getChild(t.getWuiName()) ? (i = L.setSlotsBox, L._displaySet(t.preset)) : L.setItemSlotsBox.getChild(t.getWuiName()) ? (i = L.setItemSlotsBox, L.emit("setItemSlotTapped", t)) : i = L.setIconsBox;
i.selectedSlot && t !== i.selectedSlot && i.selectedSlot.unselect();
i.selectedSlot = t;
i === L.setSlotsBox && e();
d(t);
p(t);
t.dragUI = {
  width: M,
  height: M,
  onDragClassName: "slot"
};
l.setDraggable(t, t.dragUI, "presets", {
  type: v
});
t.addClassNames("pos" + T[e]);
d(t);
m(t);
L.addSetButton.on("tap", function () {
  this.disable();
  L._addSet();
});
L.importSetButton.on("tap", function () {
  L._importSet();
});
a(L.importSetButton, c("ui.preset.importCurrentStuff"));
L.deleteSetButton.on("tap", function () {
  var e = L.deleteSetButton;
  e.disable();
  var t = L.setSlotsBox.selectedSlot && L.setSlotsBox.selectedSlot.preset;
  return t ? void I(t.presetId, function (i) {
    i === _.YES ? (window.dofus.sendMessage("InventoryPresetDeleteMessage", {
      presetId: t.presetId
    }), L.addClassNames("spinner")) : e.enable();
  }) : e.enable();
});
a(L.deleteSetButton, c("ui.preset.delete"));
L.chooseIconButton.on("tap", function () {
  L._confirmIconPopup(function (e) {
    e === _.YES && L._saveSet();
  });
});
L.saveSetButton.on("tap", function () {
  this.disable();
  L._saveSet();
});
this.disable();
L._addSet();
this.disable();
L._saveSet();
this.displayedItems = {};
this.setSlotsBox = this.createChild("div", {
  className: "setSlotsBox"
});
this.addSetButton = this.appendChild(new r(c("ui.common.new"), {
  className: ["addSetButton"]
}));
this.setItemSlotsBox = this.createChild("div", {
  className: "setItemSlotsBox"
});
this.setIconsBox = this.createChild("div", {
  className: "setIconsBox"
});
this.importSetButton = O.appendChild(new r("", {
  className: ["importSetButton"]
}));
this.importSetButton.createChild("div", {
  className: "icon"
});
this.deleteSetButton = O.appendChild(new r("", {
  className: ["deleteSetButton"]
}));
this.deleteSetButton.createChild("div", {
  className: "icon"
});
this.chooseIconButton = O.appendChild(new r("!", {
  className: ["chooseIconButton"]
}));
this.chooseIconButton.createChild("div", {
  className: "icon"
});
this.saveSetButton = O.appendChild(new r(c("ui.common.save"), {
  className: ["saveSetButton"]
}));
this.buttonsBox = O;
this.createChild("div", {
  className: "overlay"
});
this.explanationPanel = this.createChild("div", {
  className: "explanationPanel"
});
this.explanationPanel.createChild("div", {
  className: "instruction",
  text: c("ui.preset.howToUse")
});
g();
w();
C();
S();
E();
D.on("listUpdate", function () {
  E();
});
D.on("presetSaved", function (t, i) {
  if (L.delClassNames("spinner"), i) {
    return e(), N(i);
  }
});
D.on("presetDeleted", function (t, i) {
  return L.delClassNames("spinner"), i ? (e(), N(i)) : (L._deleteSet(t), void e());
});
D.on("presetUpdated", function (t, i) {
  return i ? N(i) : (L._updateSetSlot(t), void e());
});
D.on("presetItemUpdated", function (e) {
  L._updateSetSlot(e);
});
D.on("presetItemUpdateError", N);
D.on("presetUsed", function (e, t) {
  if (L.delClassNames("spinner"), t) {
    return N(t);
  }
  var i = D.presets[e],
    n = R.equippedMount && i.mount && !R.isRiding;
  n && window.gui.textNotification.add(c("tablet.mount.cannotRide"));
});
R.on("setMount", x);
R.on("unsetMount", x);
p.inherits(o, f);
e.exports = o;
o.prototype._getItemPosMap = function (e) {
  if (e) {
    for (var t = e.objects || e, i = window.gui.playerData.inventory, n = {}, o = 0; o < t.length; o += 1) {
      var a,
        s = t[o].objUid || t[o].objectUID,
        r = t[o].position;
      if (s) {
        a = i.objects[s];
      } else {
        var l = t[o].objGid;
        a = d.items[l];
      }
      n[r] = a;
    }
    return n;
  }
};
o.prototype._updateSetSlot = function (e) {
  var t = window.gui.playerData.inventory.presets[e],
    i = this.setSlotsBox.getChild("setSlot" + t.presetId);
  i.preset = t;
  s.preloadImage("gfx/presets/icon_" + t.symbolId + ".png", function (e) {
    i.setImage(e);
    i.dragUI.backgroundImage = i.getImage();
    l.enableDrag(i);
  });
  var n = this.setIconsBox.getChild("setIconSlot" + t.symbolId);
  n.preset = t;
  var o = this.setSlotsBox.selectedSlot && this.setSlotsBox.selectedSlot.preset;
  o && o.presetId === t.presetId && this._displaySet(t);
};
o.prototype._getIsItemUnavailable = function (e) {
  if (!e) {
    return !1;
  }
  if (e.mountLocation) {
    var t = window.gui.playerData.equippedMount;
    return !t;
  }
  return !e.objectUID || e.conditions && !e.conditions.isRespected();
};
o.prototype._updateSetItemSlots = function (e) {
  if (!e) {
    return this._resetItemSlots(this.setItemSlotsBox.getChildren());
  }
  for (var t = 0; t < w; t += 1) {
    var i = e[t],
      o = this.setItemSlotsBox.getChild("setItemSlot" + t);
    o && (o.unset(), o.delClassNames("unavailable"), i && (i.model ? n(o, i) : o.setItem(i), o.toggleClassName("unavailable", !!this._getIsItemUnavailable(i))));
  }
  var a = this.setItemSlotsBox.selectedSlot;
  a && a.unselect();
};
o.prototype._resetItemSlots = function (e) {
  for (var t = 0; t < e.length; t += 1) {
    e[t].unset();
  }
};
o.prototype._displaySet = function (e) {
  var t = window.gui.playerData,
    i = this._getItemPosMap(e),
    n = e && e.symbolId;
  if (e) {
    n = e.symbolId;
    e.mount && (i[C] = t.equippedMount || {
      model: I,
      mountLocation: "placeholder"
    });
  } else {
    var o = this.setIconsBox.getChildren(),
      a = this._getNextAvailableSlot(o);
    n = o.indexOf(a);
  }
  this._updateSetItemSlots(i);
  this.shouldSaveEquipment = !1;
  this.saveCustom = !1;
  this.setIconsBox.getChild("setIconSlot" + n).emit("tap");
  this.displayedPreset = e;
};
o.prototype._deleteSet = function (e) {
  for (var t = this.setSlotsBox.getChildren(), i = 0; i < t.length; i += 1) {
    var n = t[i];
    if (n.preset && n.preset.presetId === e) {
      delete n.preset;
      n.unset();
      l.disableDrag(n);
      this._resetItemSlots(this.setItemSlotsBox.getChildren());
      break;
    }
  }
};
o.prototype._importSet = function () {
  var e = window.gui.playerData,
    t = e.inventory.equippedItems,
    i = {};
  for (var n in t) {
    t.hasOwnProperty(n) && (i[n] = t[n]);
  }
  e.isRiding && (i[g.positions.mount] = e.equippedMount);
  this._updateSetItemSlots(i);
  this.shouldSaveEquipment = !0;
};
o.prototype._saveSet = function () {
  var e = this,
    t = this.setSlotsBox.getChildren(),
    i = this.setItemSlotsBox.getChildren(),
    n = this.setIconsBox.getChildren(),
    o = this.setSlotsBox.selectedSlot,
    a = this.setIconsBox.selectedSlot;
  if (o.preset) {
    var s = n[o.preset.symbolId];
    delete s.preset;
  }
  var r, l;
  if (this.saveCustom) {
    for (var c = [], d = [], u = 0; u < i.length; u += 1) {
      var h = i[u].itemInstance;
      if (h) {
        c.push(h.position);
        d.push(h.objectUID || h.mountLocation && h.id);
      } else {
        var p = i[u].data;
        p && p.mountLocation && (c.push(C), d.push(p.id));
      }
    }
    r = {
      presetId: t.indexOf(o),
      symbolId: n.indexOf(a),
      itemsPositions: c,
      itemsUids: d
    };
    l = "InventoryPresetSaveCustomMessage";
  } else {
    r = {
      presetId: t.indexOf(o),
      symbolId: n.indexOf(a),
      saveEquipment: this.shouldSaveEquipment
    };
    l = "InventoryPresetSaveMessage";
  }
  window.dofus.sendMessage(l, r);
  e.addClassNames("spinner");
};
o.prototype._getNextAvailableSlot = function (e) {
  for (var t = 0; t < e.length; t += 1) {
    var i = e[t];
    if (!i.preset) {
      return i;
    }
  }
};
o.prototype._confirmIconPopup = function (e) {
  m.open("presetChooseIcon", this.setIconsBox);
  m.getWindow("presetChooseIcon").once("close", e);
};
o.prototype._addSet = function () {
  var e = this,
    t = this._getNextAvailableSlot(this.setSlotsBox.getChildren());
  if (t) {
    var i = this._getNextAvailableSlot(this.setIconsBox.getChildren());
    t.emit("tap");
    i.emit("tap");
    this._confirmIconPopup(function (t) {
      return t !== _.YES ? e.addSetButton.enable() : (e._importSet(), void e._saveSet());
    });
  }
};
i.preset = t;
s.preloadImage("gfx/presets/icon_" + t.symbolId + ".png", function (e) {
  i.setImage(e);
  i.dragUI.backgroundImage = i.getImage();
  l.enableDrag(i);
});
i.setImage(e);
i.dragUI.backgroundImage = i.getImage();
l.enableDrag(i);
n = e.symbolId;
e.mount && (i[C] = t.equippedMount || {
  model: I,
  mountLocation: "placeholder"
});
this._updateSetItemSlots(i);
this.shouldSaveEquipment = !1;
this.saveCustom = !1;
this.setIconsBox.getChild("setIconSlot" + n).emit("tap");
this.displayedPreset = e;
delete n.preset;
n.unset();
l.disableDrag(n);
this._resetItemSlots(this.setItemSlotsBox.getChildren());
e.isRiding && (i[g.positions.mount] = e.equippedMount);
this._updateSetItemSlots(i);
this.shouldSaveEquipment = !0;
c.push(h.position);
d.push(h.objectUID || h.mountLocation && h.id);
r = {
  presetId: t.indexOf(o),
  symbolId: n.indexOf(a),
  itemsPositions: c,
  itemsUids: d
};
l = "InventoryPresetSaveCustomMessage";
r = {
  presetId: t.indexOf(o),
  symbolId: n.indexOf(a),
  saveEquipment: this.shouldSaveEquipment
};
l = "InventoryPresetSaveMessage";
window.dofus.sendMessage(l, r);
e.addClassNames("spinner");
m.open("presetChooseIcon", this.setIconsBox);
m.getWindow("presetChooseIcon").once("close", e);
t.emit("tap");
i.emit("tap");
this._confirmIconPopup(function (t) {
  return t !== _.YES ? e.addSetButton.enable() : (e._importSet(), void e._saveSet());
});
e = e || {
  className: "confirmWindow",
  positionInfo: h,
  customClose: !0
};
a.call(this, e);
this._domCreated = !1;
this.actionsEnum = d;
this._box = this.windowBody.createChild("div", {
  className: "messageBox"
});
this.message = this._box.createChild("div", {
  className: "message"
});
o(n, a);
e.exports = n;
n.actionsEnum = d;
n.prototype.createDom = function () {
  var e = this,
    t = this.windowBody.createChild("div", {
      className: "buttonContainer"
    });
  this._buttonYesLabel = l("ui.common.yes");
  this._buttonYes = t.appendChild(new r(this._buttonYesLabel));
  this.yesAction = function () {
    e.cb(d.YES);
    s.close(e.id, {
      keepDialog: e.keepDialog
    });
  };
  this._buttonYes.on("tap", function () {
    e.yesAction();
  });
  this._buttonNo = t.appendChild(new r(l("ui.common.no")));
  this.noAction = function () {
    e.cb(d.NO);
    s.close(e.id);
  };
  this._buttonNo.on("tap", function () {
    e.noAction();
  });
  this.closeButton.on("tap", function () {
    e.noAction();
  });
  this._buttonIgnore = t.appendChild(new r(l("ui.common.ignore")));
  this.ignoreAction = function () {
    e.cb(d.IGNORE);
    s.close(e.id);
  };
  this._buttonIgnore.on("tap", function () {
    e.ignoreAction();
  });
  this._buttonIgnore.hide();
  this._domCreated = !0;
};
n.prototype.backButtonClose = function () {
  this._buttonNo.isVisible() || this.closeButton.isVisible() ? this.noAction() : this._buttonIgnore.isVisible() ? this.ignoreAction() : this.yesAction();
};
n.prototype.update = function (e, t) {
  var i = this;
  if (this._domCreated || this.createDom(), this.message.clearContent(), t = t || {}, this.windowTitle.setText(e.title || l("ui.common.confirm")), this.message.appendChild(c.process(e.message, {
    isNonChat: !0
  })), this._buttonYesLabel = e.buttonYesLabel || l("ui.common.yes"), this._buttonYes.setText(this._buttonYesLabel), this._buttonNo.setText(e.buttonNoLabel || l("ui.common.no")), h.height = e.heightPixel || u, s.positionWindow(this.id, h), this.cb = e.cb, this.cb && "function" == typeof this.cb || (console.error(new Error("missing cb")), this.cb = function () {}), this.keepDialog = t.keepDialog, this._buttonNo.toggleDisplay(!e.noDisable), this.closeButton.toggleDisplay(Boolean(e.enableCloseCross)), this._buttonIgnore.toggleDisplay(Boolean(t.ignoreEnable)), e.timer) {
    var n = e.timer;
    this._buttonYes.setText(this._buttonYesLabel + " (" + n + ")");
    this._buttonYes.disable();
    var o = setInterval(function () {
      n--;
      n <= 0 ? (i._buttonYes.setText(i._buttonYesLabel), i._buttonYes.enable(), clearInterval(o)) : i._buttonYes.setText(i._buttonYesLabel + " (" + n + ")");
    }, 1e3);
  } else {
    this._buttonYes.enable();
  }
};
this._buttonYesLabel = l("ui.common.yes");
this._buttonYes = t.appendChild(new r(this._buttonYesLabel));
this.yesAction = function () {
  e.cb(d.YES);
  s.close(e.id, {
    keepDialog: e.keepDialog
  });
};
this._buttonYes.on("tap", function () {
  e.yesAction();
});
this._buttonNo = t.appendChild(new r(l("ui.common.no")));
this.noAction = function () {
  e.cb(d.NO);
  s.close(e.id);
};
this._buttonNo.on("tap", function () {
  e.noAction();
});
this.closeButton.on("tap", function () {
  e.noAction();
});
this._buttonIgnore = t.appendChild(new r(l("ui.common.ignore")));
this.ignoreAction = function () {
  e.cb(d.IGNORE);
  s.close(e.id);
};
this._buttonIgnore.on("tap", function () {
  e.ignoreAction();
});
this._buttonIgnore.hide();
this._domCreated = !0;
e.cb(d.YES);
s.close(e.id, {
  keepDialog: e.keepDialog
});
e.cb(d.NO);
s.close(e.id);
e.cb(d.IGNORE);
s.close(e.id);
this._buttonYes.setText(this._buttonYesLabel + " (" + n + ")");
this._buttonYes.disable();
n--;
n <= 0 ? (i._buttonYes.setText(i._buttonYesLabel), i._buttonYes.enable(), clearInterval(o)) : i._buttonYes.setText(i._buttonYesLabel + " (" + n + ")");
t.logScroller.refresh();
t.logScroller.goToBottom();
s.call(this, {
  className: "adminConsoleWindow",
  title: A,
  positionInfo: {
    left: "c",
    top: "c",
    width: 800,
    height: 500
  }
});
m(this, {
  minWidth: 480,
  minHeight: 300
});
this._searchItem = new w(window.dofus.connectionManager);
this.history = [];
this.historyPointer = 0;
this.autoScroll = !0;
this.domCreated = !1;
this._adminCmdManager = new M();
this.once("open", function () {
  t._createDom();
  t._addClientCommands();
  var e = window.gui.playerData,
    i = e.hasRight(b.SHOW_ADMIN_CONSOLE_BUTTON);
  console.error(e.loginName + " (id: " + e.id + ") -> rightForAdminConsole = " + i + ", forcedAccount = " + e.forcedAccount + ", hasConsoleRight = " + e.identification.hasConsoleRight);
});
this.on("open", function () {
  t.setTitle(t.getAdminTitle());
});
this.on("focus", function () {
  window.setTimeout(function () {
    t.cmdInput.focus();
  }, 100);
});
this.on("close", function () {
  u.hide();
});
this.on("opened", function () {
  t.cmdInput.focus();
});
this.on("resize", e);
this.on("repositioned", e);
window.gui.on("ConsoleCommandsListMessage", function (e) {
  t.helpInfo = e;
});
window.gui.on("ConsoleMessage", function (e) {
  return t.log ? void t.logMessage(e.content, L[e.type]) : console.warn(e.content);
});
window.gui.on("DebugInClientMessage", function (e) {
  t.log && t.logMessage(e.message, O[e.level]);
  e.level >= R ? console.warn(e.message) : console.log(e.message);
});
E.on("step", function (e) {
  e = e || {};
  var i = e.percent;
  t._preloadPB.setValue(i);
  t._preloadCount.setText(e.count + "/" + e.nbTotalMaps);
  t._preloadPercent.setText(~~(100 * i) + "%");
  t._preloadEstimate.setText(e.secondLeft < 0 ? 0 : e.secondLeft + "s");
});
E.on("error", function (e) {
  t.cmdInput.enable();
  t._buttonSend.enable();
  t._preloadBox.hide();
  console.error(e);
});
E.on("end", function (e) {
  t.cmdInput.enable();
  t._buttonSend.enable();
  t._preloadBox.hide();
  t.logMessage("Finished preloading of in " + e.elapsedSecond + "s");
});
this.optionButton = new r({
  className: "optionButton",
  scaleOnPress: !0
}, function () {
  var e = [];
  e.push({
    caption: "25%",
    cb: function () {
      t.setOpacity(.25);
    }
  });
  e.push({
    caption: "50%",
    cb: function () {
      t.setOpacity(.5);
    }
  });
  e.push({
    caption: "75%",
    cb: function () {
      t.setOpacity(.75);
    }
  });
  e.push({
    caption: "100%",
    cb: function () {
      t.setOpacity(1);
    }
  });
  window.gui.openContextualMenu("generic", {
    title: "Opacity",
    actions: e
  });
});
this.optionButton.insertBefore(this.closeButton);
t._createDom();
t._addClientCommands();
t.log && t.logMessage(e.message, O[e.level]);
e.level >= R ? console.warn(e.message) : console.log(e.message);
t._preloadPB.setValue(i);
t._preloadCount.setText(e.count + "/" + e.nbTotalMaps);
t._preloadPercent.setText(~~(100 * i) + "%");
t._preloadEstimate.setText(e.secondLeft < 0 ? 0 : e.secondLeft + "s");
t.cmdInput.enable();
t._buttonSend.enable();
t._preloadBox.hide();
console.error(e);
t.cmdInput.enable();
t._buttonSend.enable();
t._preloadBox.hide();
t.logMessage("Finished preloading of in " + e.elapsedSecond + "s");
e.push({
  caption: "25%",
  cb: function () {
    t.setOpacity(.25);
  }
});
e.push({
  caption: "50%",
  cb: function () {
    t.setOpacity(.5);
  }
});
e.push({
  caption: "75%",
  cb: function () {
    t.setOpacity(.75);
  }
});
e.push({
  caption: "100%",
  cb: function () {
    t.setOpacity(1);
  }
});
window.gui.openContextualMenu("generic", {
  title: "Opacity",
  actions: e
});
i && t.setOpacity(i);
this._createDom();
a(n, s);
e.exports = n;
n.prototype._addClientCommands = function () {
  var e = this;
  window.gui.playerData.isAdmin() && this._adminCmdManager.addCommand("searchitem", function () {
    var t = 2,
      i = Array.prototype.slice.call(arguments),
      n = i.join(" ").trim();
    return n.length < t ? void e.logMessage("Need to be at least " + t + " letters length.", "Error") : e._searchItem.search(n, function (t, i) {
      return t ? console.error("AdminConsole items search", t) : void e.logMessage(i, "Info");
    });
  }, "Search items by their names and give the id.");
  this._adminCmdManager.addCommand("showeverycellid", function () {
    window.background && window.background.toggleDebugMode();
  }, "Show every cell id of the grid");
  this._adminCmdManager.addCommand("showdebuginfo", function () {
    window.gui.performanceOverlay.display(!window.gui.performanceOverlay.isVisible());
  }, "Show debug infos");
  this._adminCmdManager.addCommand("pushtoken", function () {
    var t = window.gui.playerData.getPushToken();
    t ? e.logMessage("Push token: " + t) : e.logMessage("No push token.");
    e.logMessage("Done!", "Debug");
  }, "Show the push token for push notification.");
};
n.prototype._createDom = function () {
  if (!this.domCreated) {
    var e = this,
      t = this.windowBody,
      i = t.createChild("div", {
        className: "topDom"
      }),
      n = i.createChild("div", {
        className: "upDownContainer"
      }),
      o = n.appendChild(new r({
        text: "Next cmd",
        className: ["greenButton", "upAndDown"]
      }));
    o.on("tap", function () {
      e.nextCmd();
    });
    var a = n.appendChild(new r({
      text: "Reset",
      className: ["greenButton", "upAndDown"]
    }));
    a.on("tap", function () {
      e._reset();
    });
    var s = n.appendChild(new r({
      text: "Previous cmd",
      className: ["greenButton", "upAndDown"]
    }));
    s.on("tap", function () {
      e.previousCmd();
    });
    this.autoScrollCheckbox = n.appendChild(new p("autoscroll", {
      defaultValue: !0
    }));
    this.autoScrollCheckbox.addClassNames("upAndDown");
    this.autoScrollCheckbox.on("change", function (t) {
      e.autoScroll = t;
    });
    var u = i.createChild("form", {
        attr: {
          action: "#_",
          method: "post"
        }
      }),
      m = u.createChild("table", {
        className: "cmdInputBar"
      }),
      f = m.createChild("td"),
      g = this.cmdInput = new l({
        className: "cmdInput",
        attr: {
          id: "cmdInput"
        }
      });
    f.appendChild(g);
    f = m.createChild("td", {
      className: "buttonSend"
    });
    var _ = this._buttonSend = f.appendChild(new r({
        text: d("ui.social.reportSend"),
        className: ["greenButton"]
      })),
      v = this._preloadBox = t.createChild("div", {
        className: "preloadBox",
        hidden: !0
      });
    this._preloadPB = v.appendChild(new c({
      className: ["preloadPB", "green"]
    }));
    this._preloadCount = v.createChild("div", {
      className: "preloadCount"
    });
    this._preloadPercent = v.createChild("div", {
      className: "preloadPercent"
    });
    this._preloadEstimate = v.createChild("div", {
      className: "preloadEstimate"
    });
    this.logScroller = t.appendChild(new h({
      className: "logBox"
    }));
    this.log = this.logScroller.content;
    _.on("tap", function () {
      var t = g.getValue();
      g.setValue("");
      e.runMultipleCommands(t);
    });
    g.rootElement.addEventListener("keydown", function (t) {
      if (t) {
        var i = t.keyCode;
        40 === i ? (t.preventDefault(), e.nextCmd()) : 38 === i && (t.preventDefault(), e.previousCmd());
      }
    });
    u.rootElement.addEventListener("submit", function (e) {
      e.preventDefault();
      _.emit("tap");
    });
    this.domCreated = !0;
  }
};
n.prototype.addToHistory = function (e) {
  return this.history[this.history.length - 1] !== e && e ? (this.history.push(e), void (this.historyPointer = this.history.length)) : void (this.historyPointer = this.history.length);
};
n.prototype.previousCmd = function () {
  if (!(this.historyPointer < 1)) {
    this.historyPointer -= 1;
    var e = this.history[this.historyPointer];
    this.cmdInput.setValue(e);
  }
};
n.prototype.nextCmd = function () {
  if (!(this.historyPointer > this.history.length - 1)) {
    this.historyPointer += 1;
    var e = this.history[this.historyPointer] || "";
    this.cmdInput.setValue(e);
  }
};
n.prototype.setOpacity = function (e) {
  this.windowBorder.setStyle("opacity", e);
  v.setValue(S, e);
};
n.prototype._handleEvent = function (e) {
  e = e.replace("event:", "");
  var t = e.split(","),
    i = t[0],
    n = "";
  switch (i) {
    case "player":
      var o = {
        playerName: t[1],
        playerId: t[2]
      };
      window.gui.openContextualMenu(i, o);
      break;
    case "admin":
      var a = "true" === t[1];
      n = window.atob(t[2]);
      a ? this.runCommand(n) : this.cmdInput.setValue(n);
      break;
    case "adminQuiet":
      n = window.atob(t[1]);
      this.runQuietCommand(n);
      break;
    case "guild":
      window.dofus.sendMessage("GuildFactsRequestMessage", {
        guildId: t[1]
      });
  }
};
n.prototype._formatLinks = function (e) {
  function t(e, t) {
    var n = t.match(/^event:/);
    e.addEventListener("click", function (e) {
      e.preventDefault();
    });
    e.addEventListener(_.end, function (e) {
      n ? i._handleEvent(t) : f.openUrlInAppBrowser(t);
      e.preventDefault();
    });
  }
  var i = this,
    n = new g("div");
  n.setHtml(e);
  for (var o, a, s = n.rootElement.getElementsByTagName("a"), r = 0; r < s.length; r++) {
    o = s[r];
    a = o.href;
    t(o, a);
  }
  return n;
};
n.prototype.logMessage = function (e, t) {
  if (this._createDom(), this.log.getChildCount() > I) {
    var i = this.log.getChildren();
    Array.isArray(i) && i[0] && i[0].destroy();
  }
  var n = "message" + (t || "Info"),
    o = this.log.createChild("div", {
      className: ["message", n]
    });
  e = e.replace(/\n/g, "<br/>");
  e = this._formatLinks(e);
  o.appendChild(e);
  this.logScroller.refresh();
  this.autoScroll && this.logScroller.goToBottom();
};
n.prototype.runMultipleCommands = function (e) {
  e = e.trim();
  for (var t = e.split(";"), i = 0; i < t.length; i += 1) {
    var n = t[i];
    this.runCommand(n);
  }
};
n.prototype.runCommand = function (e) {
  var t = this;
  e = e.trim();
  var i = !1;
  if (this.logMessage(e, "Command"), "help" === e || "/help" === e || "" === e) {
    return this.logMessage("\n" + this.helpInfo.descriptions.join(""), "Debug"), this.logMessage("<hr/>Client admin commands:", "Debug"), void this.logMessage("\n" + this._adminCmdManager.helpList().join("\n"), "Debug");
  }
  this.addToHistory(e);
  var n = e.split(" ");
  if (i = this._adminCmdManager.runCommand.apply(this._adminCmdManager, n), !i && window.gui.playerData.isAdmin()) {
    if ("preload" === n[0]) {
      n.shift();
      this.cmdInput.disable();
      this._buttonSend.disable();
      this._preloadBox.show();
      this._preloadPB.setValue(0);
      var a = n[0];
      return a = a === N ? x : parseInt(a, 10), E.preloadAreas([a]);
    }
    if ("autotest" === n[0] && o.run) {
      return n.shift(), o.run(n.join(" "));
    }
    if ("gridcolor" === n[0]) {
      return n.shift(), 4 !== n.length ? this.logMessage("4 arguments required: gridcolor [red] [green] [blue] [alpha]", "Debug") : n[0] > 1 ? this.logMessage("Red   component has to be in range [0, 1]", "Debug") : n[1] > 1 ? this.logMessage("Green component has to be in range [0, 1]", "Debug") : n[2] > 1 ? this.logMessage("Blue  component has to be in range [0, 1]", "Debug") : n[3] > 1 ? this.logMessage("Alpha has to be in range [0, 1]", "Debug") : (window.isoEngine.background.setGridColor(n), this.logMessage("Grid color changed!", "Debug"));
    }
    if ("haapi" === n[0]) {
      var s = T.getHaapiConfig();
      return s ? this.logMessage(s.getHostname(), "Debug") : (C.error(new Error("Config is missing.")), this.logMessage("Error: config error", "Error"));
    }
    if ("setanimation" === n[0]) {
      n.shift();
      var r = {
        animationString: n[0],
        direction: n[1]
      };
      return void window.actorManager.userActor.testAnimation(r, function (e) {
        t.logMessage(e, "Debug");
      });
    }
    if ("tutorial" === n[0]) {
      n.shift();
      var l = "Done";
      return 1 !== n.length || "start" !== n[0] ? l = "Wrong parameter, allowed parameters: start" : window.dofus.sendMessage("GuidedModeReturnRequestMessage"), this.logMessage(l, "Debug");
    }
  }
  if (!i && window.gui.playerData.isModeratorOrMore() && "setadminmenu" === n[0]) {
    var c = !1,
      d = n[1];
    return c = !d || "help" === d || !window.gui.playerData.adminMenu.setAdminMenuId(d), void (c && (this.logMessage("setadminmenu &lt;menuId&gt;: menuId must be one of the following:", "Debug"), this.logMessage(window.gui.playerData.adminMenu.helpToString(), "Debug")));
  }
  i || window.dofus.sendMessage("AdminCommandMessage", {
    content: e
  });
};
n.prototype.runQuietCommand = function (e) {
  window.dofus.sendMessage("AdminQuietCommandMessage", {
    content: e
  });
};
n.prototype._reset = function () {
  this.log.clearContent();
  this.logScroller.refresh();
};
n.prototype.getAdminTitle = function () {
  var e = [],
    t = window.gui.serversData,
    i = window.gui.playerData.characterBaseInformations,
    n = t.getMyServerName();
  return n && e.push(n + " (" + t.connectedServerId + ")"), i.id && i.name && e.push(i.name + " (" + i.id + ")"), 0 === e.length && e.push(A), e.join(", ");
};
window.gui.playerData.isAdmin() && this._adminCmdManager.addCommand("searchitem", function () {
  var t = 2,
    i = Array.prototype.slice.call(arguments),
    n = i.join(" ").trim();
  return n.length < t ? void e.logMessage("Need to be at least " + t + " letters length.", "Error") : e._searchItem.search(n, function (t, i) {
    return t ? console.error("AdminConsole items search", t) : void e.logMessage(i, "Info");
  });
}, "Search items by their names and give the id.");
this._adminCmdManager.addCommand("showeverycellid", function () {
  window.background && window.background.toggleDebugMode();
}, "Show every cell id of the grid");
this._adminCmdManager.addCommand("showdebuginfo", function () {
  window.gui.performanceOverlay.display(!window.gui.performanceOverlay.isVisible());
}, "Show debug infos");
this._adminCmdManager.addCommand("pushtoken", function () {
  var t = window.gui.playerData.getPushToken();
  t ? e.logMessage("Push token: " + t) : e.logMessage("No push token.");
  e.logMessage("Done!", "Debug");
}, "Show the push token for push notification.");
t ? e.logMessage("Push token: " + t) : e.logMessage("No push token.");
e.logMessage("Done!", "Debug");
s.on("tap", function () {
  e.previousCmd();
});
this.autoScrollCheckbox = n.appendChild(new p("autoscroll", {
  defaultValue: !0
}));
this.autoScrollCheckbox.addClassNames("upAndDown");
this.autoScrollCheckbox.on("change", function (t) {
  e.autoScroll = t;
});
f.appendChild(g);
f = m.createChild("td", {
  className: "buttonSend"
});
this._preloadPB = v.appendChild(new c({
  className: ["preloadPB", "green"]
}));
this._preloadCount = v.createChild("div", {
  className: "preloadCount"
});
this._preloadPercent = v.createChild("div", {
  className: "preloadPercent"
});
this._preloadEstimate = v.createChild("div", {
  className: "preloadEstimate"
});
this.logScroller = t.appendChild(new h({
  className: "logBox"
}));
this.log = this.logScroller.content;
_.on("tap", function () {
  var t = g.getValue();
  g.setValue("");
  e.runMultipleCommands(t);
});
g.rootElement.addEventListener("keydown", function (t) {
  if (t) {
    var i = t.keyCode;
    40 === i ? (t.preventDefault(), e.nextCmd()) : 38 === i && (t.preventDefault(), e.previousCmd());
  }
});
u.rootElement.addEventListener("submit", function (e) {
  e.preventDefault();
  _.emit("tap");
});
this.domCreated = !0;
g.setValue("");
e.runMultipleCommands(t);
e.preventDefault();
_.emit("tap");
this.windowBorder.setStyle("opacity", e);
v.setValue(S, e);
n = window.atob(t[2]);
a ? this.runCommand(n) : this.cmdInput.setValue(n);
n = window.atob(t[1]);
this.runQuietCommand(n);
e.addEventListener("click", function (e) {
  e.preventDefault();
});
e.addEventListener(_.end, function (e) {
  n ? i._handleEvent(t) : f.openUrlInAppBrowser(t);
  e.preventDefault();
});
n ? i._handleEvent(t) : f.openUrlInAppBrowser(t);
e.preventDefault();
o = s[r];
a = o.href;
t(o, a);
e = e.replace(/\n/g, "<br/>");
e = this._formatLinks(e);
o.appendChild(e);
this.logScroller.refresh();
this.autoScroll && this.logScroller.goToBottom();
n.shift();
this.cmdInput.disable();
this._buttonSend.disable();
this._preloadBox.show();
this._preloadPB.setValue(0);
this.log.clearContent();
this.logScroller.refresh();
u.call(this);
this._reset();
d(n, u);
e.exports = n;
n.prototype._reset = function () {
  this._isStopped = !1;
  this._shouldStop = !1;
  this._remainingMaps = {};
  this._lastCount = 0;
};
n.prototype._onError = function (e) {
  this._isStopped = !0;
  this.emit("error", e);
};
n.prototype._onEnd = function (e) {
  this._isStopped = !0;
  this.emit("end", e);
};
n.prototype._onStop = function () {
  this._isStopped = !0;
  this.emit("stop");
};
n.prototype._onStep = function (e) {
  this.emit("step", e);
};
n.prototype._preload = function (e, t) {
  var i = this,
    n = Object.keys(e),
    a = n.length;
  if (!a) {
    return i._onEnd({
      elapsedSecond: 0
    });
  }
  var r = 0,
    l = Date.now();
  return c.forEachSeries(n, function (n, d) {
    return i._shouldStop ? c.setImmediate(function () {
      return d(y);
    }) : s(n, function (s) {
      if (s) {
        return d(s);
      }
      delete e[n];
      r++;
      var c = r / a,
        u = o(c, l),
        h = r + t,
        p = a + t,
        m = h / p,
        f = Math.round(100 * m) / 100;
      return i._onStep({
        count: h,
        nbTotalMaps: p,
        percent: f,
        secondLeft: u
      }), d();
    });
  }, function (t) {
    return i._remainingMaps = e, i._lastCount += r, t ? t === y ? i._shouldStop ? i._onStop() : i._restart() : i._onError(t) : i._onEnd({
      elapsedSecond: ~~((Date.now() - l) / 1e3)
    });
  });
};
n.prototype.preloadAreas = function (e) {
  var t = this;
  this._reset();
  this._isStopped = !1;
  l(e, function (e, i) {
    return e ? t._onError(e) : void t._preload(i, 0);
  });
};
n.prototype.stop = function () {
  this._shouldStop = !0;
  this._isStopped && this._onStop();
};
n.prototype.restart = function () {
  this._shouldStop = !1;
  this._isStopped && this._restart();
};
n.prototype._restart = function () {
  this._isStopped = !1;
  this._preload(this._remainingMaps, this._lastCount);
};
this._isStopped = !1;
this._shouldStop = !1;
this._remainingMaps = {};
this._lastCount = 0;
this._isStopped = !0;
this.emit("error", e);
this._isStopped = !0;
this.emit("end", e);
this._isStopped = !0;
this.emit("stop");
delete e[n];
r++;
this._reset();
this._isStopped = !1;
l(e, function (e, i) {
  return e ? t._onError(e) : void t._preload(i, 0);
});
this._shouldStop = !0;
this._isStopped && this._onStop();
this._shouldStop = !1;
this._isStopped && this._restart();
this._isStopped = !1;
this._preload(this._remainingMaps, this._lastCount);
this._cb = null;
e.on("_searchItemMessage", function (e) {
  var i = "",
    n = e.itemMap;
  for (var o in n) {
    if (n.hasOwnProperty(o)) {
      var a = n[o];
      i += a.nameId + " ( id: " + a.id + " )\n";
    }
  }
  i += "Done!";
  t._cb(null, i);
  t._cb = null;
});
e.on("_searchItemErrorMessage", function () {
  t._cb(null, "AN_ERROR_OCCURRED");
  t._cb = null;
});
i += "Done!";
t._cb(null, i);
t._cb = null;
t._cb(null, "AN_ERROR_OCCURRED");
t._cb = null;
e.exports = i;
i.prototype.search = function (e, t) {
  return this._cb ? t(new Error("SEARCH_ON_GOING")) : e ? (e.replace(/[^0-9a-z ]/gi, ""), this._cb = t, void window.dofus.send("searchItemRequest", {
    search: e
  })) : t(null, "USAGE: /searchitem item_name");
};
e.exports = i;
i.prototype.addCommand = function (e, t, i) {
  this._cmdMap["/" + e] = {
    fn: t,
    description: i
  };
};
i.prototype.runCommand = function () {
  var e = Array.prototype.slice.call(arguments),
    t = e[0];
  e.shift();
  var i = this._cmdMap[t];
  if (!i) {
    return !1;
  }
  var n = i.fn;
  return n.apply(null, e), !0;
};
i.prototype.helpList = function () {
  var e = [];
  for (var t in this._cmdMap) {
    if (this._cmdMap.hasOwnProperty(t)) {
      var i = this._cmdMap[t];
      e.push("<b>" + t + "</b>: " + i.description);
    }
  }
  return e;
};
a.call(this, {
  className: "ArenaWindow",
  title: l("ui.common.koliseum"),
  positionInfo: {
    left: "c",
    top: "c",
    width: 500,
    height: 500
  }
});
this.mustReload = !0;
this.on("open", function () {
  this.statusTitle || (this.createContent(), this.setupListeners());
  this.mustReload && this.reloadPartyData();
});
this.statusTitle || (this.createContent(), this.setupListeners());
this.mustReload && this.reloadPartyData();
o(n, a);
e.exports = n;
n.prototype.createContent = function () {
  this.messageContainerSetup();
  this.tableSetup();
  this.informationSetup();
  this.buttonsSetup();
};
n.prototype.messageContainerSetup = function () {
  var e = this.windowBody.createChild("div", {
    className: "wrapper",
    name: "status"
  });
  this.statusTitle = e.createChild("div", {
    className: "title"
  });
  this.statusText = e.createChild("div", {
    className: "text"
  });
};
n.prototype.tableSetup = function () {
  this.table = this.windowBody.appendChild(new r({
    colIds: ["icon", "name", "status"],
    headerContent: ["", l("ui.common.team")],
    minRows: 3,
    defaultRowContent: ["", l("ui.common.randomCharacter")]
  }));
};
n.prototype.informationSetup = function () {
  var e = this.windowBody.createChild("div", {
    className: "wrapper",
    name: "informations"
  });
  e.createChild("div", {
    className: "title",
    text: l("ui.common.myInformations")
  });
  e.createChild("div", {
    className: "text",
    name: "currentRating"
  });
  e.createChild("div", {
    className: "text",
    name: "dailyRating"
  });
  e.createChild("div", {
    className: "text",
    name: "maxRating"
  });
  e.createChild("div", {
    className: "text",
    name: "fightsWon"
  });
};
n.prototype.registerInArena = function () {
  window.dofus.sendMessage("GameRolePlayArenaRegisterMessage", {
    battleMode: d.ARENA_TYPE_3VS3
  });
};
n.prototype.buttonsSetup = function () {
  var e = this,
    t = this.windowBody.createChild("div", {
      className: "buttons"
    });
  this.unregisterBtn = t.appendChild(new s(l("ui.teamSearch.unregistration")));
  this.registerBtn = t.appendChild(new s(l("ui.teamSearch.registration")));
  this.leaveArenaBtn = t.appendChild(new s(l("ui.party.arenaQuit")));
  this.registerBtn.on("tap", function () {
    e.registerInArena();
  });
  this.unregisterBtn.on("tap", function () {
    window.dofus.sendMessage("GameRolePlayArenaUnregisterMessage");
  });
  this.leaveArenaBtn.on("tap", function () {
    window.dofus.sendMessage("PartyLeaveRequestMessage", {
      partyId: e.partyId
    });
  });
};
n.prototype.setLeaderRow = function (e, t) {
  e.getChild("icon").toggleClassName("leaderIcon", t);
};
n.prototype.addMemberRow = function (e, t) {
  var i = this.table.addRow({
    name: e
  }, {
    id: t
  });
  return t === this.leaderId && this.setLeaderRow(i, !0), this.memberCount++, i;
};
n.prototype.addThisPlayerRow = function () {
  var e = window.gui.playerData,
    t = e.characterBaseInformations.name;
  return this.addMemberRow(t, e.id);
};
n.prototype.findMemberRow = function (e) {
  if (!e) {
    return -1;
  }
  for (var t = this.table.getRows(), i = 0; i < t.length; i++) {
    if (t[i].id === e) {
      return i;
    }
  }
  return -1;
};
n.prototype.removeMemberRow = function (e) {
  var t = this.findMemberRow(e);
  return t === -1 ? console.warn("Cannot remove unknown arena member #" + e) : (this.table.delRow(t), void this.memberCount--);
};
n.prototype.enableOrDisableLeaveArenaButton = function () {
  this.partyId ? this.leaveArenaBtn.enable() : this.leaveArenaBtn.disable();
};
n.prototype.enableOrDisableRegisterButton = function () {
  this.isLeader || !this.leaderId ? (this.registerBtn.enable(), this.unregisterBtn.enable()) : (this.registerBtn.disable(), this.unregisterBtn.disable());
};
n.prototype.showOrHideRegisterButton = function (e) {
  e.arenaRegistered ? (this.registerBtn.hide(), this.unregisterBtn.show()) : (this.registerBtn.show(), this.unregisterBtn.hide());
};
n.prototype.setNewLeader = function (e) {
  var t = this.findMemberRow(this.leaderId);
  t >= 0 && this.setLeaderRow(this.table.getRow(t), !1);
  t = this.findMemberRow(e);
  t >= 0 && this.setLeaderRow(this.table.getRow(t), !0);
  this.leaderId = e;
  this.isLeader = e === window.gui.playerData.id;
  this.enableOrDisableRegisterButton();
};
n.prototype.updateArenaStats = function (e) {
  var t = e.arenaStats,
    i = this.windowBody.getChild("informations");
  i.getChild("currentRating").setText(l("ui.party.arenaRank", t.rank));
  i.getChild("dailyRating").setText(l("ui.party.arenaRankMaxToday", t.bestDailyRank));
  i.getChild("maxRating").setText(l("ui.party.arenaRankMax", t.bestRank));
  i.getChild("fightsWon").setText(l("ui.party.arenaFightsOfTheDay", t.victoryCount, t.arenaFightCount));
};
n.prototype.reloadPartyData = function () {
  this.mustReload = !1;
  var e = window.gui.playerData.partyData;
  this.updateArenaStats(e);
  this._updatePartyData(e);
  this.updateRegistrationStatus(e);
};
n.prototype._updatePartyData = function (e) {
  this.memberCount = 0;
  this.table.clearContent();
  var t = e.getArenaParty();
  if (!t) {
    return this.setNewLeader(null), this.partyId = null, void this.addThisPlayerRow();
  }
  this.setNewLeader(t.getLeaderId());
  this.partyId = t.getPartyId();
  this.isLeader && this.addThisPlayerRow();
  var i = t.getMembers();
  for (var n in i) {
    this.addMemberRow(i[n].name, ~~n);
  }
  this.isLeader || this.addThisPlayerRow();
};
this.messageContainerSetup();
this.tableSetup();
this.informationSetup();
this.buttonsSetup();
this.statusTitle = e.createChild("div", {
  className: "title"
});
this.statusText = e.createChild("div", {
  className: "text"
});
e.createChild("div", {
  className: "title",
  text: l("ui.common.myInformations")
});
e.createChild("div", {
  className: "text",
  name: "currentRating"
});
e.createChild("div", {
  className: "text",
  name: "dailyRating"
});
e.createChild("div", {
  className: "text",
  name: "maxRating"
});
e.createChild("div", {
  className: "text",
  name: "fightsWon"
});
this.unregisterBtn = t.appendChild(new s(l("ui.teamSearch.unregistration")));
this.registerBtn = t.appendChild(new s(l("ui.teamSearch.registration")));
this.leaveArenaBtn = t.appendChild(new s(l("ui.party.arenaQuit")));
this.registerBtn.on("tap", function () {
  e.registerInArena();
});
this.unregisterBtn.on("tap", function () {
  window.dofus.sendMessage("GameRolePlayArenaUnregisterMessage");
});
this.leaveArenaBtn.on("tap", function () {
  window.dofus.sendMessage("PartyLeaveRequestMessage", {
    partyId: e.partyId
  });
});
t >= 0 && this.setLeaderRow(this.table.getRow(t), !1);
t = this.findMemberRow(e);
t >= 0 && this.setLeaderRow(this.table.getRow(t), !0);
this.leaderId = e;
this.isLeader = e === window.gui.playerData.id;
this.enableOrDisableRegisterButton();
i.getChild("currentRating").setText(l("ui.party.arenaRank", t.rank));
i.getChild("dailyRating").setText(l("ui.party.arenaRankMaxToday", t.bestDailyRank));
i.getChild("maxRating").setText(l("ui.party.arenaRankMax", t.bestRank));
i.getChild("fightsWon").setText(l("ui.party.arenaFightsOfTheDay", t.victoryCount, t.arenaFightCount));
this.updateArenaStats(e);
this._updatePartyData(e);
this.updateRegistrationStatus(e);
this.memberCount = 0;
this.table.clearContent();
this.setNewLeader(t.getLeaderId());
this.partyId = t.getPartyId();
this.isLeader && this.addThisPlayerRow();
n.prototype.getStepText = function (e, t) {
  return h(u[e], t);
};
n.prototype.updateRegistrationStatus = function (e) {
  var t = e.arenaStep;
  switch (this.statusTitle.setText(l("ui.common.step", (t + 1) % 4 + 1, 4)), this.statusText.setText(this.getStepText(t, 0)), this.showOrHideRegisterButton(e), t) {
    case c.ARENA_STEP_REGISTRED:
      this.enableOrDisableLeaveArenaButton();
      break;
    case c.ARENA_STEP_WAITING_FIGHT:
    case c.ARENA_STEP_STARTING_FIGHT:
      this.leaveArenaBtn.disable();
      this.registerBtn.disable();
      break;
    case c.ARENA_STEP_UNREGISTER:
      this.enableOrDisableLeaveArenaButton();
      this.enableOrDisableRegisterButton();
      break;
    default:
      console.error("Unknown arena step #" + t);
  }
};
n.prototype.onFightEnd = function () {
  if (this.enableOrDisableLeaveArenaButton(), this.isLeader) {
    this.registerBtn.enable();
    var e = this;
    window.gui.openConfirmPopup({
      title: l("ui.common.confirm"),
      message: l("ui.party.arenaPopupReinscription"),
      cb: function (t) {
        t && e.registerInArena();
      }
    });
  }
};
n.prototype.setupListeners = function () {
  var e = this,
    t = window.gui.playerData.partyData;
  window.gui.on("disconnect", function () {
    e.mustReload = !0;
  });
  t.on("arenaRegistrationStatus", function () {
    e.updateRegistrationStatus(t);
  });
  t.on("arenaFightEnd", function () {
    e.onFightEnd();
  });
  t.on("arenaStatsUpdated", function () {
    e.updateArenaStats(t);
  });
  t.on("arenaJoined", function () {
    e._updatePartyData(t);
  });
  t.on("arenaNewMember", function (t) {
    return e.findMemberRow(t.id) >= 0 ? console.error("Dupe arena member #" + t.name) : void e.addMemberRow(t.name, t.id);
  });
  t.on("arenaMemberLeaving", function (t) {
    e.removeMemberRow(t);
  });
  t.on("playerLeftParty", function (t) {
    t === e.partyId && e.reloadPartyData();
  });
  t.on("arenaLeaderUpdate", function (t) {
    e.setNewLeader(t);
  });
  t.on("arenaFighterReady", function (t) {
    e.statusText.setText(e.getStepText(1, t));
  });
};
this.leaveArenaBtn.disable();
this.registerBtn.disable();
this.enableOrDisableLeaveArenaButton();
this.enableOrDisableRegisterButton();
window.gui.on("disconnect", function () {
  e.mustReload = !0;
});
t.on("arenaRegistrationStatus", function () {
  e.updateRegistrationStatus(t);
});
t.on("arenaFightEnd", function () {
  e.onFightEnd();
});
t.on("arenaStatsUpdated", function () {
  e.updateArenaStats(t);
});
t.on("arenaJoined", function () {
  e._updatePartyData(t);
});
t.on("arenaNewMember", function (t) {
  return e.findMemberRow(t.id) >= 0 ? console.error("Dupe arena member #" + t.name) : void e.addMemberRow(t.name, t.id);
});
t.on("arenaMemberLeaving", function (t) {
  e.removeMemberRow(t);
});
t.on("playerLeftParty", function (t) {
  t === e.partyId && e.reloadPartyData();
});
t.on("arenaLeaderUpdate", function (t) {
  e.setNewLeader(t);
});
t.on("arenaFighterReady", function (t) {
  e.statusText.setText(e.getStepText(1, t));
});
h.call(this, {
  title: a("ui.charcrea.more"),
  className: "BreedDetailWindow",
  positionInfo: {
    left: "c",
    top: "c",
    width: 912,
    height: "95%",
    maxHeight: 570,
    isModal: !0,
    isFullScreen: !0
  }
});
this.loadedSpells = {};
this.favSpells = [];
this.on("open", this._initialize);
s(o, h);
e.exports = o;
o.prototype.freeContent = function () {
  this.windowBody.clearContent();
  this.loadedSpells = {};
  this.favSpells = [];
};
o.prototype._initialize = function (e) {
  this.breedData = e.breedData;
  this.windowBody.setClassNames(["windowBody", n(e.breedData.id).bgClass]);
  this._createContent(this.windowBody);
  this._updateBreedDescription();
  this._updateSpells();
};
o.prototype._createContent = function (e) {
  var t = this.scroller = e.appendChild(new r({}, {
      showHintArrows: !0
    })),
    i = t.content,
    o = i.createChild("div", {
      className: "leftSide"
    });
  this.breedDescription = o.createChild("div", {
    className: "breedDescription",
    hidden: !0
  });
  var s = this.breedDescription.createChild("div", {
      className: "descriptionZone"
    }),
    l = s.createChild("div", {
      className: "descriptionText"
    });
  this.breedName = l.createChild("div", {
    className: "breedName",
    text: "."
  });
  this.breedName.setText("");
  this.breedStory = l.createChild("div", {
    className: "breedStory"
  });
  var c = this.favoriteSpells = o.createChild("div", {
    className: "favSpells",
    hidden: !0
  });
  c.createChild("div", {
    className: "title",
    text: a("tablet.charCrea.popularSpells")
  });
  for (var d = this.breedData.id, u = n(d).favSpells || [], h = 0; h < u.length; h++) {
    var p = this.favSpells[h] = c.createChild("div", {
      className: "spell",
      hidden: !0
    });
    p.spellId = u[h];
  }
  var m = i.createChild("div", {
      className: "rightSide"
    }),
    f = this.allSpells = m.createChild("div", {
      className: "spells",
      hidden: !0
    });
  f.createChild("div", {
    className: "title",
    text: a("tablet.charCrea.allSpells")
  });
  this.spellsContainer = f.createChild("div", {
    className: "spellsContainer"
  });
};
o.prototype._appearWhenReady = function () {
  l(this.breedDescription);
  l(this.favoriteSpells);
  l(this.allSpells);
  this.scroller.refresh();
  this.scroller.notify();
};
o.prototype._updateBreedDescription = function () {
  var e = this.breedData;
  this.breedName.setText(e.longNameId);
  this.breedStory.setText(e.descriptionId);
};
o.prototype._updateSpells = function () {
  this.windowBody.addClassNames("spinner");
  var e = this.breedId,
    t = this.breedData.breedSpellsId,
    i = this;
  this._loadSpellsData(t, function (n) {
    return n ? console.error(n) : void (i.openState && i.breedId === e && i._updateSpellSlots(t));
  });
};
o.prototype._loadSpellsData = function (e, t) {
  for (var i = [], n = this.loadedSpells, o = 0; o < e.length; o += 1) {
    n[e[o]] || i.push(e[o]);
  }
  return i.length ? void d.createSpells(i, function (e, i) {
    if (e) {
      return t(e);
    }
    i = d.sortSpells(i, "minPlayerLevel");
    for (var o = 0; o < i.length; o += 1) {
      var a = i[o];
      n[a.id] = a;
    }
    t();
  }) : t();
};
o.prototype._updateSpellSlots = function (e) {
  var t,
    i = this.breedData.id,
    o = [],
    a = n(i);
  e.forEach(function (e) {
    a.favSpells.indexOf(e) < 0 && o.push(e);
  });
  for (var s = 0; s < o.length; s += 1) {
    var r = this.spellsContainer.appendChild(new u({
      tooltipOptions: {
        longTapExplanation: !0
      }
    }));
    t = this.loadedSpells[o[s]];
    r.setSpell(t, m);
    r.toggleDisplay(Boolean(t));
  }
  this.windowBody.delClassNames("spinner");
  for (var l = 0; l < this.favSpells.length; l += 1) {
    var d = this.favSpells[l];
    t = this.loadedSpells[d.spellId];
    t ? (d.slot = d.appendChild(new u({
      tooltipOptions: {
        longTapExplanation: !0
      }
    })), d.slot.setSpell(t, m), d.appendChild(new c({
      spell: t
    }, f)), d.show()) : p.error(new Error("Cannot find spell id " + d.spellId + " for breed id " + this.breedData.id));
  }
  this._appearWhenReady();
};
this.windowBody.clearContent();
this.loadedSpells = {};
this.favSpells = [];
this.breedData = e.breedData;
this.windowBody.setClassNames(["windowBody", n(e.breedData.id).bgClass]);
this._createContent(this.windowBody);
this._updateBreedDescription();
this._updateSpells();
this.breedName = l.createChild("div", {
  className: "breedName",
  text: "."
});
this.breedName.setText("");
this.breedStory = l.createChild("div", {
  className: "breedStory"
});
f.createChild("div", {
  className: "title",
  text: a("tablet.charCrea.allSpells")
});
this.spellsContainer = f.createChild("div", {
  className: "spellsContainer"
});
l(this.breedDescription);
l(this.favoriteSpells);
l(this.allSpells);
this.scroller.refresh();
this.scroller.notify();
this.breedName.setText(e.longNameId);
this.breedStory.setText(e.descriptionId);
t = this.loadedSpells[o[s]];
r.setSpell(t, m);
r.toggleDisplay(Boolean(t));
t = this.loadedSpells[d.spellId];
t ? (d.slot = d.appendChild(new u({
  tooltipOptions: {
    longTapExplanation: !0
  }
})), d.slot.setSpell(t, m), d.appendChild(new c({
  spell: t
}, f)), d.show()) : p.error(new Error("Cannot find spell id " + d.spellId + " for breed id " + this.breedData.id));
T.call(this, {
  className: "BreedingWindow",
  positionInfo: {
    left: "0",
    bottom: "0",
    width: "100%",
    height: "100%"
  },
  noTitle: !0
});
this.mountDataFromCertifId = {};
this.babyMap = {};
this._reset();
this._setupEvents();
e._setFilterBoxVisible(!1);
e._selectTile(this.room, this);
p(n, T);
e.exports = n;
n.prototype._reset = function () {
  this.isWindowSizeFull = !1;
  this.isMultiselect = !1;
  this.selectionRoom = null;
  this.focusedTile = null;
  this.openedRoom = null;
  this.dropZones = {};
  this.certificateQueue = [];
  this.certificateTilePendingSelection = null;
  this.nonLoadedCertifCount = 0;
  this.waitingGaugeGoal = 0;
  this.certifAreRequested = !1;
  this.numMassRemove = 0;
  this.numMassAdd = 0;
  this.filters = new _();
  this.isFilterEmpty = !0;
  this.isWaitingForInventory = !1;
  this.isAscending = !0;
  this._purgeNewbornList();
};
n.prototype.freeContent = function () {
  this.windowBody.clearContent();
  this.equipBox = null;
  this.focusedMountDetails = null;
  this.rooms = null;
  this.roomBoxes = null;
  this.roomTabs = null;
  this.displayedRooms = null;
  this.roomDropZones = null;
  this.mountFilterBox = null;
  this.filterButtonBar = null;
  this.allNoneCheckbox = null;
  this.waitingGauge = null;
};
n.prototype._resetDom = function () {
  for (var e in this.rooms) {
    this.rooms[e].reset();
  }
  this._hideMountDetails();
  this.equipBox.updateMount(null);
  this._setFilterBoxVisible(!1);
  this.mountFilterBox ? this.mountFilterBox.resetFilters() : console.error("_resetDom: mountFilterBox was " + this.mountFilterBox);
  window.clearTimeout(this.debugCheckTimeout);
  this.allNoneCheckbox.toggleActivation(!1, !0);
  this.waitingGauge.hideGauge();
  f.freeContent();
};
n.prototype._createDom = function () {
  this._createRooms();
  var e = this.windowBody.createChild("div", {
    className: "leftCol"
  });
  this._setupMountDetails(e);
  this._setupEquipBox(e);
  this._hideMountDetails();
  var t = this.windowBody.createChild("div", {
    className: "rightCol"
  });
  this._setupFilterMenuBox(t);
  this.rooms.paddock.capacity = this.paddockCapacity;
  this._setupRoomBoxes(t);
  this.waitingGauge = this.windowBody.appendChild(new M());
  this._setupMountFilterBox(t);
  this._setupDropZones();
};
n.prototype._setupEvents = function () {
  function e(e) {
    if (t.waitingGauge.hideGauge(), e === d.MOUNT_PADDOCK_ERROR) {
      var i = h("ui.exchange.cantExchangeMountPaddockError");
      window.gui.openSimplePopup(i);
    }
  }
  var t = this,
    i = window.gui,
    n = window.dofus.connectionManager,
    o = i.playerData,
    a = o.inventory;
  i.on("disconnect", function () {
    t.mountDataFromCertifId = {};
  });
  this.on("close", function () {
    this._resetDom();
    this._reset();
    i.uiLocker.unlockFeature("mount", "breedingOpened");
  });
  this.on("opened", function () {
    this.isWindowSizeFull = !0;
  });
  n.on("ExchangeStartOkMountMessage", function (e) {
    t._initDisplay(e);
  });
  o.on("setMount", this.localizeEvent(function () {
    t._updateEquipBox();
    t.waitingGauge.hideGauge();
  }));
  o.on("unsetMount", this.localizeEvent(function () {
    t.numMassRemove && t.numMassRemove--;
    t._updateEquipBox();
  }));
  i.on("ExchangeMountStableBornAddMessage", function (e) {
    var i = e.mountDescription;
    t.babyMap[i.id] = Date.now();
    t.equipBox && t._addMountsToRoom(t.rooms.shed, i);
  });
  i.on("ExchangeMountStableAddMessage", this.localizeEvent(function (e) {
    t._addMountsToRoom(t.rooms.shed, e.mountDescription);
  }));
  i.on("ExchangeMountStableRemoveMessage", this.localizeEvent(function (e) {
    t._removeMountsFromRoom(t.rooms.shed, e.mountId);
  }));
  i.on("ExchangeMountPaddockAddMessage", this.localizeEvent(function (e) {
    t._addMountsToRoom(t.rooms.paddock, e.mountDescription);
  }));
  i.on("ExchangeMountPaddockRemoveMessage", this.localizeEvent(function (e) {
    t._removeMountsFromRoom(t.rooms.paddock, e.mountId);
  }));
  i.on("PaddockPropertiesMessage", this._updatePaddockProperties.bind(this));
  a.on("listUpdate", function (e) {
    t.isWaitingForInventory && t._loadCertificatesAfterInventoryLoads(e);
  });
  a.on("itemAdded", this.localizeEvent(function (e) {
    t._addCertificates([e]);
  }));
  a.on("itemsAdded", this.localizeEvent(function (e) {
    t._addCertificates(e);
  }));
  a.on("itemDeleted", this.localizeEvent(function (e, i) {
    t._removeCertificates([i]);
  }));
  a.on("itemsDeleted", this.localizeEvent(function (e, i) {
    t._removeCertificates(i);
  }));
  n.on("MountDataMessage", this.localizeEvent(function (e) {
    t._receiveMountData(e.mountData);
  }));
  n.on("MountRenamedMessage", this.localizeEvent(function (e) {
    var i = t._findTileInRooms(e.mountId);
    i.mountData.name = e.name;
    t._refreshTile(i);
  }));
  n.on("MountSterilizedMessage", this.localizeEvent(function (e) {
    var i = t._findTileInRooms(e.mountId);
    i.mountData.reproductionCount = -1;
    t._refreshTile(i);
  }));
  i.on("ExchangeMountStableErrorMessage", function () {
    e(d.MOUNT_PADDOCK_ERROR);
  });
  n.on("ExchangeErrorMessage", this.localizeEvent(function (t) {
    e(t.errorType);
  }));
  l.on("dragStart", this.localizeEvent(function (e, i, n) {
    i === A && t._startDragging(e, n);
  }));
  l.on("dragEnd", this.localizeEvent(function (e, i) {
    i === A && t._endDragging(e);
  }));
};
n.prototype._initDisplay = function (e) {
  window.gui.uiLocker.lockFeature("mount", "breedingOpened", h("tablet.mount.uiLocker.breeding"));
  C.openDialog(this.id);
  this.equipBox ? this._resetDom() : this._createDom();
  this._updateEquipBox(!0);
  this.roomBoxes.hide();
  this._addMountsToRoom(this.rooms.shed, e.stabledMountsDescription);
  this._addMountsToRoom(this.rooms.paddock, e.paddockedMountsDescription);
  this._loadCertificatesFromInventory();
  this.roomBoxes.show();
  this.roomTabs.openTab(L, null, {
    forceOpen: !0
  });
};
n.prototype._loadCertificatesFromInventory = function () {
  var e = window.gui.playerData.inventory;
  return e.isLoaded ? this._addCertificates(Object.keys(e.objects)) : (this.waitingGauge.showGauge(1), void (this.isWaitingForInventory = !0));
};
n.prototype._loadCertificatesAfterInventoryLoads = function (e) {
  this.isWaitingForInventory = !1;
  this._addCertificates(Object.keys(e));
  this.waitingGauge.hideGauge();
};
n.prototype._createRooms = function () {
  var e = [{
    id: "paddock",
    name: h("ui.common.mountPark")
  }, {
    id: "shed",
    name: h("ui.mount.barn"),
    capacity: E
  }, {
    id: "certificate",
    name: h("ui.mount.certificates")
  }, {
    id: "equip",
    name: h("ui.common.equip"),
    capacity: N,
    hidden: !0
  }];
  this.rooms = {};
  this.displayedRooms = {};
  for (var t = 0; t < e.length; t += 1) {
    var i = e[t],
      n = i.id,
      o = this.rooms[n] = new y(this, n, i.name, i.capacity);
    i.hidden || (this.displayedRooms[n] = o);
  }
  this.numTabs = Object.keys(this.displayedRooms).length;
};
n.prototype._updatePaddockProperties = function (e) {
  this.paddockCapacity = e.properties.maxOutdoorMount;
  this.openState && this._updateRoomTab(this.rooms.paddock);
};
n.prototype._setupMountDetails = function (e) {
  var t = e.createChild("div", {
      className: "mountDetailsBox"
    }),
    i = this.focusedMountDetails = t.appendChild(new m()),
    n = i.getIllustrationElement();
  i.placeholder = new v(t);
  i.dragInfo = new r(this, n);
};
n.prototype._setupEquipBox = function (e) {
  this.equipBox = new c(e, this.rooms.equip, o);
};
n.prototype._selectTab = function (e) {
  this.openedRoom = this.rooms[e];
  this._updateDisplayedRoom();
  var t = this.isMultiselect && this.openedRoom === this.selectionRoom;
  this.allNoneCheckbox.toggleActivation(t, !0);
};
n.prototype._setupRoomBoxes = function (e) {
  var t = this.roomBoxes = e.createChild("div", {
      className: "roomBoxes"
    }),
    i = t.createChild("div", {
      className: "roomBoxWrapper"
    }),
    n = i.createChild("div", {
      className: "tileSpace"
    });
  this.roomPlaceholder = new v(n);
  var o = this.roomTabs = t.appendChild(new b({
      className: "roomTabs"
    })),
    a = i.rootElement.clientHeight / this.numTabs,
    s = 0;
  o.on("openTab", this._selectTab.bind(this));
  for (var r in this.rooms) {
    if (this.displayedRooms[r]) {
      var l = this.rooms[r],
        c = l.createBox(n);
      o.addTab(l.name, c, r);
      var d = o.getTabsMap()[r].tab;
      d.setStyles({
        width: a + "px",
        top: s + "px"
      });
      s += a;
      d.title = d.createChild("div", {
        className: "title",
        text: l.name
      });
      d.statusLabel = d.createChild("div", {
        className: "statusLabel"
      });
      this._updateRoomTab(l);
    }
  }
};
n.prototype._setupFilterMenuBox = function (e) {
  var t = e.createChild("div", {
      className: "filterMenuBox"
    }),
    i = t.createChild("div", {
      className: "filterMenu"
    });
  this._createFilterButton(i);
  this._createSortSelector(i);
  this._createSelectAndFilterInfo(i);
  this._createSelectAllOrNone(i);
  this.filterButtonBar = t.createChild("div", {
    className: "filterButtonBar"
  });
};
n.prototype._createFilterButton = function (e) {
  var t = this;
  this.filterBtn = e.appendChild(new a({
    text: h("tablet.mount.filter"),
    className: ["button", "filterButton"],
    addIcon: "before"
  }, function () {
    t._setFilterBoxVisible(!t.isFilterBoxVisible);
  }));
};
n.prototype._createSortSelector = function (e) {
  var t = e.appendChild(new w({
    className: "sortSelector"
  }));
  this.sorters = [{
    name: h("ui.common.sort") + h("ui.common.colon"),
    property: "id"
  }, {
    name: h("tablet.mount.type"),
    property: "model"
  }, {
    name: h("ui.common.sex"),
    property: "sex"
  }, {
    name: h("ui.common.name"),
    property: "name"
  }, {
    name: h("ui.common.level"),
    property: "level"
  }, {
    name: h("tablet.mount.expiration"),
    property: "expiration"
  }];
  for (var i = 0; i < this.sorters.length; i += 1) {
    var n = this.sorters[i];
    t.addOption(n.name, n.property);
    t.toggleOption(i, !0);
  }
  t.on("change", this._changeSorter.bind(this));
  this.selectedSorter = t.selectFirst(!0);
};
n.prototype._createSelectAndFilterInfo = function (e) {
  this.selectAndFilterInfo = e.createChild("div", {
    className: "selectAndFilterInfo"
  });
};
n.prototype._createSelectAllOrNone = function (e) {
  var t = this,
    i = h("ui.common.all") + " / " + h("ui.common.none"),
    n = this.allNoneCheckbox = e.appendChild(new s(i));
  n.addClassNames("allNoneCheckbox");
  n.on("change", function (e) {
    t._setMultiselect(e, !0);
  });
};
n.prototype._setupDropZones = function () {
  function e(e, t, i) {
    n._droppedMount(this, e, i);
  }
  function t() {
    n._handleDragEnter(this.id, !0);
  }
  function i() {
    n._handleDragEnter(this.id, !1);
  }
  var n = this,
    o = [];
  for (var a in this.rooms) {
    o.push(a);
    var s = this.roomTabs.getTabsMap()[a];
    if (s) {
      var r = this.roomTabs.getTabsMap()[a].tab;
      l.setDroppable(r, [A]);
      r.id = a;
      r.on("drop", e);
      r.on("dragEnter", t);
      r.on("dragLeave", i);
    }
  }
  this.roomDropZones = this.roomBoxes.createChild("div", {
    className: "roomDropZones"
  });
  for (var c = 0; c < o.length; c += 1) {
    a = o[c];
    var d = this.dropZones[a] = new I("div", {
      className: ["dropZone", a, "transition"]
    });
    d.id = a;
    var u = this.rooms[a];
    "equip" === a ? (this.equipBox.box.appendChild(d), d.addClassNames("equip")) : (this.roomDropZones.appendChild(d), d.addClassNames("room"));
    d.createChild("div", {
      className: "amount",
      name: "amount"
    });
    d.createChild("div", {
      className: "label",
      text: u.name,
      name: "label"
    });
    l.setDroppable(d, [A]);
    d.on("drop", e);
    d.on("dragEnter", t);
    d.on("dragLeave", i);
  }
};
n.prototype._setupMountFilterBox = function (e) {
  if (!this.isWindowSizeFull) {
    return this.debugCheckTimeout = window.setTimeout(function (e) {
      e.mountFilterBox || console.error("Absence of MountFilterBox after 2 seconds");
    }, 2e3, this), this.once("opened", this._setupMountFilterBox.bind(this, e));
  }
  this.mountFilterBox = e.appendChild(new g(this.filters));
  this.mountFilterBox.setButtonBar(this.filterButtonBar);
  var t = this;
  this.mountFilterBox.on("activeFiltersUpdated", function () {
    t.isFilterEmpty = t.filters.isEmpty();
    t._setMultiselect(!1);
    t._updateDisplayedRoom();
    t.filterBtn.toggleClassName("hasFilter", !t.isFilterEmpty);
  });
};
n.prototype._receiveMountData = function (e) {
  var t,
    i = e.id;
  if (!this.certificateQueue.length) {
    return (t = this._findTileInRooms(i)) ? (t.mountData = this._prepareMountForRoom(e, t.room), this._refreshTile(t), void (t === this.focusedTile && this._displayMountDetails(e))) : console.error("Received data about unknown mount ", e);
  }
  var n = this.certificateQueue.shift(),
    o = S + n.objectUID;
  if (this.mountDataFromCertifId[o] = this._prepareMountForRoom(e, this.rooms.certificate), e.isNewborn && (this.babyMap[o] = this.babyMap[i]), t = this.rooms.certificate.getTile(o), t.mountData.receivedData = e, this._refreshTile(t), t.setSpinnerVisible(!1), this.certificateTilePendingSelection === t && (this.certificateTilePendingSelection = null, this._selectTile(this.rooms.certificate, t)), this.nonLoadedCertifCount--, this.certifAreRequested && this.waitingGauge.refreshGauge(this.nonLoadedCertifCount), !F) {
    var a = this.certificateQueue[0];
    if (a) {
      return this._requestMountData(a);
    }
  }
  0 === this.nonLoadedCertifCount && this.certifAreRequested && (this.certifAreRequested = !1, "certificate" === this.openedRoom.id && this._updateDisplayedRoom());
};
n.prototype._requestOneCertificate = function (e) {
  this.certificateQueue.indexOf(e) >= 0 || (this.certificateQueue.push(e), !F && this.certificateQueue.length > 1 || this._requestMountData(e));
};
n.prototype._requestAllCertificates = function () {
  this.certifAreRequested = !0;
  this.waitingGauge.showGauge(this.nonLoadedCertifCount, h("tablet.mount.loadingCertif", this.nonLoadedCertifCount));
  var e = this.rooms.certificate.mountMap;
  for (var t in e) {
    this.mountDataFromCertifId[t] || this._requestOneCertificate(e[t].certificate);
  }
};
n.prototype.tileTapHandler = function (e) {
  return this._setFilterBoxVisible(!1), e.mountData.certificate && !e.mountData.receivedData ? (e.setSpinnerVisible(!0), this.certificateTilePendingSelection = e, this._requestOneCertificate(e.mountData.certificate)) : (e.selected && !this.isMultiselect && this._setMultiselect(!0), void this._selectTile(e.room, e));
};
n.prototype._purgeNewbornList = function () {
  var e = Date.now();
  for (var t in this.babyMap) {
    e - this.babyMap[t] > H && delete this.babyMap[t];
  }
};
n.prototype._prepareMountForRoom = function (e, t) {
  return e.mountLocation = t.id, e.isNewborn = !!(this.babyMap[e.id] || e.receivedData && this.babyMap[e.receivedData.id]), e.expiration = e.certificate && e.certificate.mountInfo && e.certificate.mountInfo.date, e.receivedData && e.expiration && (e.receivedData.expiration = e.expiration), e;
};
n.prototype._addMountsToRoom = function (e, t) {
  t = Array.isArray(t) ? t : [t];
  for (var i = t.length, n = 0; n < i; n++) {
    e.addMount(this._prepareMountForRoom(t[n], e));
  }
  this.numMassAdd && (this.numMassAdd -= i, this.waitingGauge.refreshGauge(this.numMassAdd + this.numMassRemove));
  0 === this.numMassAdd && (this._updateRoomTab(e), e === this.openedRoom && this._updateDisplayedRoom());
};
n.prototype._removeMountsFromRoom = function (e, t) {
  t = Array.isArray(t) ? t : [t];
  var i = t.length,
    n = this.focusedTile && this.focusedTile.id;
  t.indexOf(n) !== -1 && (this._hideMountDetails(), this.focusedTile = null);
  for (var o = 0; o < t.length; o += 1) {
    e.removeMount(t[o]);
  }
  this.numMassRemove && (this.numMassRemove -= i, this.waitingGauge.refreshGauge(this.numMassAdd + this.numMassRemove));
  0 === this.numMassRemove && (e === this.selectionRoom && 0 === e.getNumSelected() && this._setMultiselect(!1), this._updateRoomTab(e), e === this.openedRoom && this._updateDisplayedRoom());
};
n.prototype._addCertificates = function (e) {
  for (var t = this._extractCertificates(e), i = [], n = 0; n < t.length; n++) {
    var o = t[n],
      a = o.mountInfo,
      s = S + o.objectUID,
      r = this.mountDataFromCertifId[s];
    r || this.nonLoadedCertifCount++;
    i.push({
      id: s,
      certificate: o,
      model: a.modelId,
      name: a.name,
      receivedData: r
    });
  }
  this._addMountsToRoom(this.rooms.certificate, i);
};
n.prototype._removeCertificates = function (e) {
  for (var t = [], i = 0; i < e.length; i += 1) {
    var n = S + e[i].objectUID,
      o = this.mountDataFromCertifId[n];
    o ? delete this.mountDataFromCertifId[n] : this.nonLoadedCertifCount--;
    t.push(n);
  }
  this._removeMountsFromRoom(this.rooms.certificate, t);
};
n.prototype._extractCertificates = function (e) {
  for (var t = window.gui.playerData.inventory, i = [], n = 0; n < e.length; n += 1) {
    var o = e[n],
      a = o.objectUID ? o : t.objects[o],
      s = m.getMountInfoFromCertificate(a);
    s && (a.effectsMap[O] || (this._enrichCertificateData(a, s), i.push(a)));
  }
  return i;
};
n.prototype._enrichCertificateData = function (e, t) {
  var i = {
      mountId: t.mountId,
      date: t.date,
      modelId: t.modelId
    },
    n = e.effectsMap,
    o = n[D];
  o && (i.name = o.text);
  var a = n[P];
  a && (i.validityDays = a.days, i.validityHours = a.hours, i.validityMinutes = a.minutes, i.validityDesc = a.description);
  var s = n[R];
  s && (i.ownerDesc = s.description);
  e.mountInfo = i;
};
n.prototype._requestMountData = function (e) {
  var t = e.mountInfo;
  window.dofus.sendMessage("MountInformationRequestMessage", {
    id: t.mountId,
    time: t.date
  });
};
n.prototype._updateRoomTab = function (e) {
  var t = this.roomTabs.getTabsMap()[e.id];
  if (t) {
    var i = t.tab.statusLabel,
      n = '(<span class="highlight">' + e.numMounts;
    n += void 0 !== e.capacity && e.capacity !== Number.POSITIVE_INFINITY ? "</span> / " + e.capacity + ")" : "</span>)";
    i.setHtml(n);
  }
};
n.prototype._showRoomPlaceholderIfNeeded = function () {
  var e = this.openedRoom,
    t = e.getNumHiddenMounts(),
    i = e.numMounts,
    n = null;
  0 === i ? n = h("tablet.mount.emptyRoom") : i === t && (n = h("tablet.mount.filteredMounts", i));
  e.toggleDisplay(!n);
  this.roomPlaceholder.setText(n);
};
n.prototype._updateRoomStats = function () {
  var e = this.openedRoom,
    t = e.getNumHiddenMounts(),
    i = e.numMounts,
    n = "";
  this.isFilterEmpty || (n = h("tablet.mount.filter") + h("ui.common.colon") + (i - t) + " / " + i + "\n");
  var o = "";
  if (this.selectionRoom) {
    var a = this.selectionRoom.getNumSelected();
    a > 0 && (o = h("tablet.common.selection") + h("ui.common.colon") + a);
  }
  this.selectAndFilterInfo.setText(n + o);
};
n.prototype._updateDisplayedRoom = function () {
  var e = this.openedRoom;
  e && ("certificate" === e.id && !this.isFilterEmpty && this._initLoadAllCertificates() || (e.refreshDisplay(this.filters, this.selectedSorter, this.isAscending), this._showRoomPlaceholderIfNeeded(), this._updateRoomStats()));
};
n.prototype._refreshTile = function (e) {
  e.refreshDisplay();
  e.room === this.openedRoom && this._updateDisplayedRoom();
};
n.prototype._clearSelection = function () {
  var e = this.focusedTile;
  e && (e.room.setMountSelected(e.id, !1), this.focusedTile = null);
  this.selectionRoom && (this.selectionRoom.unselectAll(), this.selectionRoom = null);
  this._updateRoomStats();
};
n.prototype._setMultiselect = function (e, t) {
  this.allNoneCheckbox.toggleActivation(e, !0);
  this.isMultiselect = e;
  this._clearSelection();
  this._hideMountDetails();
  e && (this.selectionRoom = this.openedRoom, t && (this.openedRoom.selectAll(), this._updateRoomStats()));
};
n.prototype._selectTile = function (e, t) {
  var i = this.focusedTile;
  if (this.isMultiselect && t.room !== this.selectionRoom && this._setMultiselect(!1), this.isMultiselect) {
    if (e.setMountSelected(t.id, !t.selected), 0 === e.getNumSelected()) {
      return this._setMultiselect(!1);
    }
  } else {
    if (t === i) {
      return;
    }
    i && i.room.setMountSelected(i.id, !1);
    e.setHightlightedMount(t.id);
  }
  this.focusedTile = t;
  this._displayMountDetails(t.mountData);
  this._updateRoomStats();
};
n.prototype._updateEquipBox = function (e) {
  var t = window.gui.playerData.equippedMount;
  if (t && this._prepareMountForRoom(t, this.rooms.equip), this.equipBox.updateMount(t), !e) {
    var i = this.focusedTile === this.equipBox.tile;
    t ? i ? this._displayMountDetails(t) : this._selectTile(this.rooms.equip, this.equipBox.tile) : i && this._hideMountDetails();
  }
};
n.prototype._hideMountDetails = function () {
  var e = this.focusedMountDetails;
  e.hide();
  e.placeholder.toggleDisplay(!0);
  var t = h(this.isMultiselect ? "tablet.mount.pendingMultiselect" : "tablet.mount.selectMount");
  e.placeholder.setText(t);
};
n.prototype._displayMountDetails = function (e) {
  if (e.certificate && (e = e.receivedData, !e)) {
    return this._hideMountDetails();
  }
  var t = this.focusedMountDetails;
  t.show();
  t.placeholder.toggleDisplay(!1);
  t.dragInfo.setMount(e);
  t.setMount(e, {
    context: "breeding"
  });
};
n.prototype._requestExchangeBetweenRooms = function (e, t, i) {
  var n = u[e][t];
  n && window.dofus.sendMessage("ExchangeHandleMountStableMessage", {
    actionType: n,
    rideId: i
  });
};
n.prototype._getIdForExchange = function (e, t) {
  return "certificate" !== e ? t : ~~t.substr(1);
};
n.prototype._moveMounts = function (e, t, i, n) {
  void 0 === n && (n = i.length);
  var o = k * n;
  for (this.waitingGauge.showGauge(o, h("tablet.mount.moving", n), k), this.numMassRemove = this.numMassAdd = n; n > 0; n--) {
    var a = this._getIdForExchange(e, i.pop());
    this._requestExchangeBetweenRooms(e, t, a);
  }
};
n.prototype.prepareDraggedTiles = function (e) {
  var t = this.rooms[e.mountLocation],
    i = t.getTile(e.id);
  return i.selected || this._selectTile(t, i), t.getNumSelected();
};
n.prototype._startDragging = function (e, t) {
  var i = this;
  this.roomDropZones.addClassNames("enable");
  e.addClassNames("dragging");
  var n = t.mount,
    o = this.rooms[n.mountLocation],
    a = o.getNumSelected();
  this.dragTimeout = setTimeout(function () {
    for (var e in i.dropZones) {
      var t = i.dropZones[e];
      if (t.isEnabled = e !== o.id && ("equip" !== t.id || a <= 1), t.toggleClassName("enable", t.isEnabled), t.isEnabled) {
        var n = i.rooms[e],
          s = n.capacity - n.numMounts,
          r = "";
        a > s && (r = s > 0 ? h("tablet.mount.roomLeft", s) : h("tablet.mount.roomFullShort"));
        t.toggleClassName("warning", !!r && s > 0);
        t.toggleClassName("full", !!r && s <= 0);
        t.getChild("amount").setText(r);
      }
    }
  }, x);
};
n.prototype._endDragging = function (e) {
  clearTimeout(this.dragTimeout);
  e.delClassNames("dragging");
  for (var t in this.dropZones) {
    var i = this.dropZones[t];
    i.delClassNames("enable", "dragEnter");
    var n = this.roomTabs.getTabsMap()[t];
    if (n) {
      var o = n.tab;
      o.delClassNames("dragEnter");
    }
  }
  if (this.roomDropZones.delClassNames("enable"), l.isLostDrop && this.focusedTile) {
    var a = this.focusedTile.mountData;
    a.certificate && !a.receivedData && this._clearSelection();
  }
};
n.prototype._handleDragEnter = function (e, t) {
  var i = this.dropZones[e];
  i.toggleClassName("dragEnter", t);
  var n = this.roomTabs.getTabsMap()[e];
  if (n) {
    var o = n.tab;
    o.toggleClassName("dragEnter", t && i.isEnabled);
  }
};
n.prototype._droppedMount = function (e, t, i) {
  var n = i.mount,
    o = n.mountLocation,
    a = e.id;
  if (o !== a) {
    var s = this.rooms[o],
      r = this.rooms[a],
      l = "equip" !== a ? r.capacity - r.numMounts : r.capacity,
      c = "equip" !== a ? s.getSelection() : [n.id],
      d = c.length;
    if (l <= 0) {
      window.gui.openSimplePopup(h("tablet.mount.roomFull"));
    } else if (l < d) {
      var u = this;
      window.gui.openConfirmPopup({
        title: h("ui.popup.warning"),
        message: h("tablet.mount.partialMoveMounts", l),
        cb: function (e) {
          e && u._moveMounts(o, a, c, l);
        }
      });
    } else {
      this._moveMounts(o, a, c);
    }
  }
};
n.prototype._findTileInRooms = function (e) {
  for (var t in this.rooms) {
    var i = this.rooms[t].getTile(e);
    if (i) {
      return i;
    }
  }
  return null;
};
n.prototype._initLoadAllCertificates = function () {
  return 0 !== this.nonLoadedCertifCount && (this.rooms.certificate.lockRoom(), this.roomPlaceholder.setText(" "), this._requestAllCertificates(), !0);
};
n.prototype._changeSorter = function (e) {
  this.isAscending = this.selectedSorter !== e || !this.isAscending;
  this.selectedSorter = e;
  "certificate" === this.openedRoom.id && !B[e] && this._initLoadAllCertificates() || this._updateDisplayedRoom();
};
n.prototype._setFilterBoxVisible = function (e) {
  this.isFilterBoxVisible = e;
  this.filterBtn.toggleClassName("enabled", e);
  this.mountFilterBox && this.mountFilterBox.toggleClassName("enable", e);
};
this.isWindowSizeFull = !1;
this.isMultiselect = !1;
this.selectionRoom = null;
this.focusedTile = null;
this.openedRoom = null;
this.dropZones = {};
this.certificateQueue = [];
this.certificateTilePendingSelection = null;
this.nonLoadedCertifCount = 0;
this.waitingGaugeGoal = 0;
this.certifAreRequested = !1;
this.numMassRemove = 0;
this.numMassAdd = 0;
this.filters = new _();
this.isFilterEmpty = !0;
this.isWaitingForInventory = !1;
this.isAscending = !0;
this._purgeNewbornList();
this.windowBody.clearContent();
this.equipBox = null;
this.focusedMountDetails = null;
this.rooms = null;
this.roomBoxes = null;
this.roomTabs = null;
this.displayedRooms = null;
this.roomDropZones = null;
this.mountFilterBox = null;
this.filterButtonBar = null;
this.allNoneCheckbox = null;
this.waitingGauge = null;
this._hideMountDetails();
this.equipBox.updateMount(null);
this._setFilterBoxVisible(!1);
this.mountFilterBox ? this.mountFilterBox.resetFilters() : console.error("_resetDom: mountFilterBox was " + this.mountFilterBox);
window.clearTimeout(this.debugCheckTimeout);
this.allNoneCheckbox.toggleActivation(!1, !0);
this.waitingGauge.hideGauge();
f.freeContent();
this._setupMountDetails(e);
this._setupEquipBox(e);
this._hideMountDetails();
this._setupFilterMenuBox(t);
this.rooms.paddock.capacity = this.paddockCapacity;
this._setupRoomBoxes(t);
this.waitingGauge = this.windowBody.appendChild(new M());
this._setupMountFilterBox(t);
this._setupDropZones();
i.on("disconnect", function () {
  t.mountDataFromCertifId = {};
});
this.on("close", function () {
  this._resetDom();
  this._reset();
  i.uiLocker.unlockFeature("mount", "breedingOpened");
});
this.on("opened", function () {
  this.isWindowSizeFull = !0;
});
n.on("ExchangeStartOkMountMessage", function (e) {
  t._initDisplay(e);
});
o.on("setMount", this.localizeEvent(function () {
  t._updateEquipBox();
  t.waitingGauge.hideGauge();
}));
o.on("unsetMount", this.localizeEvent(function () {
  t.numMassRemove && t.numMassRemove--;
  t._updateEquipBox();
}));
i.on("ExchangeMountStableBornAddMessage", function (e) {
  var i = e.mountDescription;
  t.babyMap[i.id] = Date.now();
  t.equipBox && t._addMountsToRoom(t.rooms.shed, i);
});
i.on("ExchangeMountStableAddMessage", this.localizeEvent(function (e) {
  t._addMountsToRoom(t.rooms.shed, e.mountDescription);
}));
i.on("ExchangeMountStableRemoveMessage", this.localizeEvent(function (e) {
  t._removeMountsFromRoom(t.rooms.shed, e.mountId);
}));
i.on("ExchangeMountPaddockAddMessage", this.localizeEvent(function (e) {
  t._addMountsToRoom(t.rooms.paddock, e.mountDescription);
}));
i.on("ExchangeMountPaddockRemoveMessage", this.localizeEvent(function (e) {
  t._removeMountsFromRoom(t.rooms.paddock, e.mountId);
}));
i.on("PaddockPropertiesMessage", this._updatePaddockProperties.bind(this));
a.on("listUpdate", function (e) {
  t.isWaitingForInventory && t._loadCertificatesAfterInventoryLoads(e);
});
a.on("itemAdded", this.localizeEvent(function (e) {
  t._addCertificates([e]);
}));
a.on("itemsAdded", this.localizeEvent(function (e) {
  t._addCertificates(e);
}));
a.on("itemDeleted", this.localizeEvent(function (e, i) {
  t._removeCertificates([i]);
}));
a.on("itemsDeleted", this.localizeEvent(function (e, i) {
  t._removeCertificates(i);
}));
n.on("MountDataMessage", this.localizeEvent(function (e) {
  t._receiveMountData(e.mountData);
}));
n.on("MountRenamedMessage", this.localizeEvent(function (e) {
  var i = t._findTileInRooms(e.mountId);
  i.mountData.name = e.name;
  t._refreshTile(i);
}));
n.on("MountSterilizedMessage", this.localizeEvent(function (e) {
  var i = t._findTileInRooms(e.mountId);
  i.mountData.reproductionCount = -1;
  t._refreshTile(i);
}));
i.on("ExchangeMountStableErrorMessage", function () {
  e(d.MOUNT_PADDOCK_ERROR);
});
n.on("ExchangeErrorMessage", this.localizeEvent(function (t) {
  e(t.errorType);
}));
l.on("dragStart", this.localizeEvent(function (e, i, n) {
  i === A && t._startDragging(e, n);
}));
l.on("dragEnd", this.localizeEvent(function (e, i) {
  i === A && t._endDragging(e);
}));
this._resetDom();
this._reset();
i.uiLocker.unlockFeature("mount", "breedingOpened");
t._updateEquipBox();
t.waitingGauge.hideGauge();
t.numMassRemove && t.numMassRemove--;
t._updateEquipBox();
t.babyMap[i.id] = Date.now();
t.equipBox && t._addMountsToRoom(t.rooms.shed, i);
i.mountData.name = e.name;
t._refreshTile(i);
i.mountData.reproductionCount = -1;
t._refreshTile(i);
window.gui.uiLocker.lockFeature("mount", "breedingOpened", h("tablet.mount.uiLocker.breeding"));
C.openDialog(this.id);
this.equipBox ? this._resetDom() : this._createDom();
this._updateEquipBox(!0);
this.roomBoxes.hide();
this._addMountsToRoom(this.rooms.shed, e.stabledMountsDescription);
this._addMountsToRoom(this.rooms.paddock, e.paddockedMountsDescription);
this._loadCertificatesFromInventory();
this.roomBoxes.show();
this.roomTabs.openTab(L, null, {
  forceOpen: !0
});
this.isWaitingForInventory = !1;
this._addCertificates(Object.keys(e));
this.waitingGauge.hideGauge();
this.rooms = {};
this.displayedRooms = {};
this.paddockCapacity = e.properties.maxOutdoorMount;
this.openState && this._updateRoomTab(this.rooms.paddock);
i.placeholder = new v(t);
i.dragInfo = new r(this, n);
this.openedRoom = this.rooms[e];
this._updateDisplayedRoom();
d.setStyles({
  width: a + "px",
  top: s + "px"
});
s += a;
d.title = d.createChild("div", {
  className: "title",
  text: l.name
});
d.statusLabel = d.createChild("div", {
  className: "statusLabel"
});
this._updateRoomTab(l);
this._createFilterButton(i);
this._createSortSelector(i);
this._createSelectAndFilterInfo(i);
this._createSelectAllOrNone(i);
this.filterButtonBar = t.createChild("div", {
  className: "filterButtonBar"
});
t.addOption(n.name, n.property);
t.toggleOption(i, !0);
t.on("change", this._changeSorter.bind(this));
this.selectedSorter = t.selectFirst(!0);
n.addClassNames("allNoneCheckbox");
n.on("change", function (e) {
  t._setMultiselect(e, !0);
});
l.setDroppable(r, [A]);
r.id = a;
r.on("drop", e);
r.on("dragEnter", t);
r.on("dragLeave", i);
"equip" === a ? (this.equipBox.box.appendChild(d), d.addClassNames("equip")) : (this.roomDropZones.appendChild(d), d.addClassNames("room"));
d.createChild("div", {
  className: "amount",
  name: "amount"
});
d.createChild("div", {
  className: "label",
  text: u.name,
  name: "label"
});
l.setDroppable(d, [A]);
d.on("drop", e);
d.on("dragEnter", t);
d.on("dragLeave", i);
this.mountFilterBox = e.appendChild(new g(this.filters));
this.mountFilterBox.setButtonBar(this.filterButtonBar);
t.isFilterEmpty = t.filters.isEmpty();
t._setMultiselect(!1);
t._updateDisplayedRoom();
t.filterBtn.toggleClassName("hasFilter", !t.isFilterEmpty);
this.certifAreRequested = !0;
this.waitingGauge.showGauge(this.nonLoadedCertifCount, h("tablet.mount.loadingCertif", this.nonLoadedCertifCount));
this.numMassAdd && (this.numMassAdd -= i, this.waitingGauge.refreshGauge(this.numMassAdd + this.numMassRemove));
0 === this.numMassAdd && (this._updateRoomTab(e), e === this.openedRoom && this._updateDisplayedRoom());
this.numMassRemove && (this.numMassRemove -= i, this.waitingGauge.refreshGauge(this.numMassAdd + this.numMassRemove));
0 === this.numMassRemove && (e === this.selectionRoom && 0 === e.getNumSelected() && this._setMultiselect(!1), this._updateRoomTab(e), e === this.openedRoom && this._updateDisplayedRoom());
r || this.nonLoadedCertifCount++;
i.push({
  id: s,
  certificate: o,
  model: a.modelId,
  name: a.name,
  receivedData: r
});
o ? delete this.mountDataFromCertifId[n] : this.nonLoadedCertifCount--;
t.push(n);
s && (i.ownerDesc = s.description);
e.mountInfo = i;
n += void 0 !== e.capacity && e.capacity !== Number.POSITIVE_INFINITY ? "</span> / " + e.capacity + ")" : "</span>)";
i.setHtml(n);
0 === i ? n = h("tablet.mount.emptyRoom") : i === t && (n = h("tablet.mount.filteredMounts", i));
e.toggleDisplay(!n);
this.roomPlaceholder.setText(n);
e.refreshDisplay();
e.room === this.openedRoom && this._updateDisplayedRoom();
e && (e.room.setMountSelected(e.id, !1), this.focusedTile = null);
this.selectionRoom && (this.selectionRoom.unselectAll(), this.selectionRoom = null);
this._updateRoomStats();
this.allNoneCheckbox.toggleActivation(e, !0);
this.isMultiselect = e;
this._clearSelection();
this._hideMountDetails();
e && (this.selectionRoom = this.openedRoom, t && (this.openedRoom.selectAll(), this._updateRoomStats()));
i && i.room.setMountSelected(i.id, !1);
e.setHightlightedMount(t.id);
this.focusedTile = t;
this._displayMountDetails(t.mountData);
this._updateRoomStats();
e.hide();
e.placeholder.toggleDisplay(!0);
t.show();
t.placeholder.toggleDisplay(!1);
t.dragInfo.setMount(e);
t.setMount(e, {
  context: "breeding"
});
this.roomDropZones.addClassNames("enable");
e.addClassNames("dragging");
a > s && (r = s > 0 ? h("tablet.mount.roomLeft", s) : h("tablet.mount.roomFullShort"));
t.toggleClassName("warning", !!r && s > 0);
t.toggleClassName("full", !!r && s <= 0);
t.getChild("amount").setText(r);
clearTimeout(this.dragTimeout);
e.delClassNames("dragging");
this.isAscending = this.selectedSorter !== e || !this.isAscending;
this.selectedSorter = e;
"certificate" === this.openedRoom.id && !B[e] && this._initLoadAllCertificates() || this._updateDisplayedRoom();
this.isFilterBoxVisible = e;
this.filterBtn.toggleClassName("enabled", e);
this.mountFilterBox && this.mountFilterBox.toggleClassName("enable", e);
this.sourceData = {
  mount: null
};
this.styles = {};
this.onDragClassName = "draggedMount";
this.wElement = t;
this.imgElement = t;
this.breedingWindow = e;
e.exports = o;
o.DRAG_ID = r;
o.prototype.setMount = function (e, t) {
  this.sourceData.mount = e;
  this.imgElement = t || this.imgElement;
};
o.prototype.setStyle = function (e, t) {
  this.styles[e] = t;
};
o.prototype.prepareForDrag = function (e, t) {
  this.setStyle("backgroundImage", this.imgElement.getStyle("backgroundImage"));
  var i = this.breedingWindow.prepareDraggedTiles(this.sourceData.mount);
  if (i > 1) {
    t.addClassNames("multiselect");
    var o = n(i);
    t.insertAsFirstChild(o);
    this.wElement.once("dragEnd", function () {
      t.removeChild(o);
      t.delClassNames("multiselect");
    });
  }
  return !0;
};
this.sourceData.mount = e;
this.imgElement = t || this.imgElement;
t.insertAsFirstChild(o);
this.wElement.once("dragEnd", function () {
  t.removeChild(o);
  t.delClassNames("multiselect");
});
t.removeChild(o);
t.delClassNames("multiselect");
this.mountData = null;
this.box = e.createChild("div", {
  className: "equipBox"
});
this._createTile(t, i);
this.placeholder = new r(this.box);
this.placeholder.setText(s("tablet.mount.noEquipped"));
e.exports = n;
n.prototype._createTile = function (e, t) {
  var i = this.tile = this.box.createChild("div", {
    className: ["mount", "neutralTile"]
  });
  e.getTile = function (e) {
    return i.id === e ? i : null;
  };
  i.createChild("div", {
    className: "title",
    text: s("tablet.mount.equipped")
  });
  this.mountImg = i.createChild("div", {
    className: "mountImg"
  });
  var n = i.createChild("div", {
    className: "nameAndLevel"
  });
  this.mountName = n.createChild("div", {
    className: "mountName"
  });
  this.mountLevel = n.createChild("div", {
    className: "level"
  });
  l(i);
  i.on("tap", t);
  i.setTileSelected = this._setTileSelected.bind(this);
  i.refreshDisplay = this._refreshTile.bind(this);
  i.highlightTile = function () {};
  i.id = null;
  i.mountData = null;
  i.selected = !1;
  i.room = e;
  i.equipBox = this;
  this.dragInfo = new a(e.breedingWindow, i);
};
n.prototype.updateMount = function (e) {
  var t = this.mountData,
    i = !!e;
  return this.tile.toggleDisplay(i), this.placeholder.toggleDisplay(!i), e ? (this.mountData = e, this._refreshTile(), this.dragInfo.setMount(e, this.mountImg)) : (this.mountData = null, this.tile.addClassNames("neutralTile"), this.tile.delClassNames("focusedTile")), t;
};
n.prototype._setTileSelected = function (e) {
  e = void 0 === e || e;
  this.tile.toggleClassName("focusedTile", e);
  this.tile.toggleClassName("neutralTile", !e);
  this.tile.selected = e;
};
n.prototype._refreshTile = function () {
  var e = this.mountData;
  this.tile.mountData = e;
  this.tile.id = e.id;
  this.mountName.setText(e.name || s("ui.common.noName"));
  this.mountLevel.setText(s("ui.common.short.level") + " " + e.level);
  var t = this;
  o.preloadImage("gfx/mounts/" + e.model + ".png", function (e) {
    t.mountImg && t.mountImg.rootElement && t.mountImg.setStyle("backgroundImage", e);
  });
};
e.getTile = function (e) {
  return i.id === e ? i : null;
};
i.createChild("div", {
  className: "title",
  text: s("tablet.mount.equipped")
});
this.mountImg = i.createChild("div", {
  className: "mountImg"
});
this.mountName = n.createChild("div", {
  className: "mountName"
});
this.mountLevel = n.createChild("div", {
  className: "level"
});
l(i);
i.on("tap", t);
i.setTileSelected = this._setTileSelected.bind(this);
i.refreshDisplay = this._refreshTile.bind(this);
i.highlightTile = function () {};
i.id = null;
i.mountData = null;
i.selected = !1;
i.room = e;
i.equipBox = this;
this.dragInfo = new a(e.breedingWindow, i);
e = void 0 === e || e;
this.tile.toggleClassName("focusedTile", e);
this.tile.toggleClassName("neutralTile", !e);
this.tile.selected = e;
this.tile.mountData = e;
this.tile.id = e.id;
this.mountName.setText(e.name || s("ui.common.noName"));
this.mountLevel.setText(s("ui.common.short.level") + " " + e.level);
v.call(this, "div", {
  className: "mountBox",
  name: i,
  hidden: !0
});
"certificate" === t.id && this.addClassNames("certificate");
this._hasBeenDestroyed = !1;
this.on("destroy", function () {
  n._hasBeenDestroyed = !0;
});
this.id = i;
this.room = t;
this.mountData = e;
this.selected = !1;
this.renderingForeground = null;
this.detailLevel = M;
g(r, {
  doubletapTimeout: 1
});
r.foreground = n;
r.on("tap", a);
r.on("longtap", s);
n._level = n.createChild("div", {
  className: "level"
});
n._fertileIcon = n.appendChild(new f("fertile"));
n._staminaGauge = u.appendChild(new d("stamina", null, {
  size: y,
  withoutLabel: !0
}));
n._maturityGauge = u.appendChild(new d("maturity", null, {
  size: y,
  withoutLabel: !0
}));
n._loveGauge = u.appendChild(new d("love", null, {
  size: y,
  withoutLabel: !0
}));
n._serenityGauge = l.appendChild(new m({
  isMini: !0
}));
n._serenityGauge.resize();
I.shed = [];
I.paddock = [];
I.certificate = [];
h(n, v);
e.exports = n;
n.freeContent = function () {
  I.shed = [];
  I.paddock = [];
  I.certificate = [];
};
n.prototype.setSpinnerVisible = function (e) {
  this.renderingForeground && this.renderingForeground.toggleClassName("spinner", !!e);
};
n.prepareTilePool = function (e, t) {
  for (var i = I[e.id], n = t - i.length, o = 0; o < n; o++) {
    var a = e.box.appendChild(r(e));
    i.push(a);
  }
};
n.prototype._createTile = function () {
  var e = this.room,
    t = I[e.id],
    i = t.pop();
  i || (i = e.box.appendChild(r(e)));
  i.mountBox = this;
  this.renderingForeground = i;
};
n.prototype._moveTile = function (e) {
  var t = this.renderingForeground;
  if (t.index !== e) {
    var i = this.room,
      n = i.numColumns,
      o = Math.floor(e / n) * i.rowHeight,
      a = e % n * i.columnWidth;
    t.index = e;
    t.setStyle("webkitTransform", "translate3d(" + a + "px, " + o + "px, 0)");
  }
};
n.prototype._releaseTileContent = function () {
  var e = I[this.room.id];
  e.push(this.renderingForeground);
  this.renderingForeground = null;
  this.detailLevel = M;
};
n.prototype._updateTileContent = function (e) {
  var t = this.renderingForeground;
  if (t) {
    this.detailLevel = e;
    var i = this.mountData;
    if (t._mountName.setText(i.name || u("ui.common.noName")), t._mountName.toggleClassName("noName", !i.name), i.certificate) {
      var n = i.receivedData;
      t._mountName.toggleClassName("sexUnknown", !n);
      t._mountName.toggleClassName("female", !!n && n.sex);
      var o = i.certificate.mountInfo;
      this._setValidity(t._certifValidity, o.validityDays, o.validityHours, o.validityMinutes);
    } else {
      t._mountName.toggleClassName("female", !!i.sex);
      t._level.setText(u("ui.common.short.level") + " " + i.level);
      var a = p.getFertilityState(i);
      t._fertileIcon.setFertileIcon(a);
      e === C ? (t._staminaGauge.setValue(i.stamina, i.staminaMax), t._maturityGauge.setValue(i.maturity, i.maturityForAdult), t._loveGauge.setValue(i.love, i.loveMax), t._serenityGauge.setValue(i.serenity), t.gaugeDiv.delClassNames("partial")) : t.gaugeDiv.addClassNames("partial");
    }
    t.dragInfo.setMount(i, t._mountImg);
    this._retrieveMountImgUrl(t._mountImg, i.model);
    t.show();
  }
};
n.prototype._retrieveMountImgUrl = function (e, t) {
  if (t !== e.currentModel) {
    e.currentModel = t;
    var i = this,
      n = A[t];
    return n ? e.setStyle("backgroundImage", n) : void l.preloadImage("gfx/mounts/" + t + ".png", function (n) {
      A[t] = n;
      e.currentModel === t && (i._hasBeenDestroyed || e.setStyle("backgroundImage", n));
    });
  }
};
n.prototype._setValidity = function (e, t, i, n) {
  var o = u("tablet.common.validity") + u("ui.common.colon");
  o += t > 0 ? t + " " + u("ui.time.days", t) : i > 0 ? i + " " + u("ui.time.hours", i) : n + " " + u("ui.time.minutes", n);
  e.toggleClassName("expiringSoon", t < w && t >= b);
  e.toggleClassName("expiringVerySoon", t < b);
  e.setText(o);
};
n.prototype.refreshDisplay = function () {
  this._updateTileContent(C);
};
n.prototype.setTileSelected = function (e) {
  this.selected = e;
  this.toggleClassName("selected", e);
  this.delClassNames("focusedTile");
};
n.prototype.highlightTile = function () {
  this.selected = !0;
  this.addClassNames("focusedTile");
};
n.prototype.prepareToShow = function (e, t) {
  if (this.renderingForeground && this.renderingForeground.index < 0 && this._moveTile(e), 1 === t) {
    if (this.detailLevel >= T) {
      return !1;
    }
    this._createTile();
    this._moveTile(e);
    this._updateTileContent(T);
  } else if (2 === t) {
    if (this.detailLevel === C) {
      return !1;
    }
    this._updateTileContent(C);
  }
  return !0;
};
n.prototype.prepareToGoOffScreen = function () {
  this.renderingForeground && this._releaseTileContent();
};
n.prototype.showTile = function () {
  this.show();
};
n.prototype.hideTile = function () {
  this.hide();
  this.renderingForeground && (this.renderingForeground.hide(), this._releaseTileContent());
};
n.hidePoolTiles = function (e) {
  for (var t = I[e.id], i = t.length - 1; i >= 0; i--) {
    t[i].hide();
  }
};
n.prototype.markForReorder = function () {
  this.renderingForeground && (this.renderingForeground.index = -1);
};
I.shed = [];
I.paddock = [];
I.certificate = [];
i || (i = e.box.appendChild(r(e)));
i.mountBox = this;
this.renderingForeground = i;
t.index = e;
t.setStyle("webkitTransform", "translate3d(" + a + "px, " + o + "px, 0)");
e.push(this.renderingForeground);
this.renderingForeground = null;
this.detailLevel = M;
t._mountName.toggleClassName("sexUnknown", !n);
t._mountName.toggleClassName("female", !!n && n.sex);
t._mountName.toggleClassName("female", !!i.sex);
t._level.setText(u("ui.common.short.level") + " " + i.level);
t._fertileIcon.setFertileIcon(a);
e === C ? (t._staminaGauge.setValue(i.stamina, i.staminaMax), t._maturityGauge.setValue(i.maturity, i.maturityForAdult), t._loveGauge.setValue(i.love, i.loveMax), t._serenityGauge.setValue(i.serenity), t.gaugeDiv.delClassNames("partial")) : t.gaugeDiv.addClassNames("partial");
t.dragInfo.setMount(i, t._mountImg);
this._retrieveMountImgUrl(t._mountImg, i.model);
t.show();
A[t] = n;
e.currentModel === t && (i._hasBeenDestroyed || e.setStyle("backgroundImage", n));
o += t > 0 ? t + " " + u("ui.time.days", t) : i > 0 ? i + " " + u("ui.time.hours", i) : n + " " + u("ui.time.minutes", n);
e.toggleClassName("expiringSoon", t < w && t >= b);
e.toggleClassName("expiringVerySoon", t < b);
e.setText(o);
this.selected = e;
this.toggleClassName("selected", e);
this.delClassNames("focusedTile");
this.selected = !0;
this.addClassNames("focusedTile");
this._createTile();
this._moveTile(e);
this._updateTileContent(T);
this.hide();
this.renderingForeground && (this.renderingForeground.hide(), this._releaseTileContent());
M.call(this, "div", {
  className: "MountFilterBox"
});
this.isReady = !1;
this.buttonBar = null;
this.filterButtons = [];
this.batchUpdateLevel = 0;
this.mountFilters = e;
e.isReady ? this._createDom() : e.once("mountFiltersReady", this._createDom.bind(this));
e.serenityFlagMap[this.zoneName] = t;
e.numSerenityZonesOn += t ? 1 : -1;
e._updateSerenityFilter();
this.mountFilterBox._setColorButtonValue(this, t, i);
this.mountFilterBox._updateFilter();
this.abilityId && (o._delFilterButton(n), o.mountFilters.removeFilter(n));
this.abilityId = t;
t ? (o.mountFilters.addBehaviorFilter(n, t, !0), o._addFilterButton(n, i), this.setLabel(i), this.selectState(N)) : (this.setLabel(this.emptyLabel), this.selectState(E));
o._updateFilter();
g(n, M);
e.exports = n;
n.prototype.getFilters = function () {
  return this.mountFilters;
};
n.prototype.setButtonBar = function (e) {
  this.buttonBar = e;
};
n.prototype.resetFilters = function () {
  this.isReady && this._resetFilters(!0);
};
n.prototype._resetFilters = function (e) {
  this._enterBatchUpdate();
  this._clearSearchBox();
  for (var t in C) {
    this[t].reset();
  }
  for (t in A) {
    this[t].reset();
  }
  this._resetSerenityFilter();
  this.colorA.reset();
  this.colorB.reset();
  this.abilityA.reset();
  this.abilityB.reset();
  this.minFatigue = 0;
  this.maxFatigue = 100;
  this._leaveBatchUpdate(e);
};
n.prototype._enterBatchUpdate = function () {
  this.batchUpdateLevel++;
};
n.prototype._leaveBatchUpdate = function (e) {
  this.batchUpdateLevel--;
  0 !== this.batchUpdateLevel || e || this._updateFilter();
};
n.prototype._updateFilter = function () {
  this.batchUpdateLevel > 0 || (this._updateButtonBar(), this.emit("activeFiltersUpdated", this.mountFilters));
};
n.prototype._createDom = function () {
  u = f("tablet.mount.pureColor");
  this._setupNameBar();
  this._setupToggles();
  this._setupSerenityBar();
  this._setupFatigueBar();
  this._setupColorBar();
  this._setupAbilityBar();
  this.appendChild(new h({
    text: f("ui.common.reset"),
    className: ["button", "resetButton"]
  }, this._resetFilters.bind(this, !1)));
  this._resetFilters(!0);
  this.isReady = !0;
};
n.prototype._setupNameBar = function () {
  var e = this.createChild("div", {
      className: "nameBar"
    }),
    t = this.searchBox = e.appendChild(new v({
      isLiveSearch: !0,
      maxLength: _.MAX_RIDE_NAME_LEN
    }));
  t.setPlaceholder(f("ui.common.name"));
  t.on("search", this._searchBoxChanged.bind(this));
  t.reset = this._clearSearchBox.bind(this);
};
n.prototype._searchBoxChanged = function (e) {
  this._delFilterButton("searchBox");
  e ? (this.mountFilters.setFilter("name", e.toLowerCase()), this._addFilterButton("searchBox", '"' + e + '"')) : this.mountFilters.removeFilter("name");
  this._updateFilter();
};
n.prototype._clearSearchBox = function () {
  this.searchBox.setValue("");
  this._searchBoxChanged("");
};
n.prototype._deactivateOppositeToggles = function (e, t) {
  for (var i = 0; i < t.length; i++) {
    var n = t[i];
    if (!(n.indexOf(e) < 0)) {
      for (var o = 0; o < n.length; o++) {
        n[o] !== e && this[n[o]].reset();
      }
    }
  }
};
n.prototype._toggleBtnHandler = function (e, t, i) {
  this._enterBatchUpdate();
  var n = C[e],
    o = n.filterId;
  switch (i) {
    case E:
      this._delFilterButton(e);
      this.mountFilters.removeFilter(o);
      break;
    case N:
      this._deactivateOppositeToggles(e, T);
      this._addFilterButton(e, f(n.label));
      this.mountFilters.setFilter(o, t);
      break;
    case x:
      this._delFilterButton(e);
      this._addFilterButton(e, f(n.label), "reversed");
      this.mountFilters.setFilter(o, t);
      break;
    default:
      console.error("invalid valueIndex: " + i);
  }
  this._leaveBatchUpdate();
};
n.prototype._newToggleButton = function (e, t, i) {
  var n,
    o = C[t],
    a = f(o.label),
    s = o.addIcon;
  o.isReversible ? n = L : o.isReversed && (n = O);
  this[t] = e.appendChild(new b(t, i, {
    text: a,
    addIcon: s,
    states: n
  }));
};
n.prototype._setupToggles = function () {
  var e = this._toggleBtnHandler.bind(this),
    t = this.createChild("div", {
      className: "sexBar"
    });
  this._newToggleButton(t, "maleBtn", e);
  this._newToggleButton(t, "femaleBtn", e);
  t = this.createChild("div", {
    className: "sexBar"
  });
  this._newToggleButton(t, "newbornBtn", e);
  this._newToggleButton(t, "rideableBtn", e);
  t = this.createChild("div", {
    className: "fertileBar"
  });
  this._newToggleButton(t, "pregnantBtn", e);
  this._newToggleButton(t, "fertileBtn", e);
  this._newToggleButton(t, "sterilizedBtn", e);
  var i = this.createChild("div", {
    className: "hasOrNeedsBar"
  });
  t = i.createChild("div", {
    className: "hasOrNeedsDiv"
  });
  this._newToggleButton(t, "staminaBtn", e);
  this._newToggleButton(t, "loveBtn", e);
  t = i.createChild("div", {
    className: "hasOrNeedsDiv"
  });
  this._newToggleButton(t, "maturityBtn", e);
  this._newToggleButton(t, "energyBtn", e);
};
n.prototype._updateSerenityFilter = function () {
  for (var e in this.serenityFlagMap) {
    this.serenity[e].toggleClassName("active", this.serenityFlagMap[e]);
  }
  this.serenity.toggleClassName("allOff", 0 === this.numSerenityZonesOn);
  var t = y.SERENITY_MIN,
    i = y.SERENITY_MAX,
    n = this.numSerenityZonesOn,
    o = this.serenityFlagMap.stamina,
    a = this.serenityFlagMap.love,
    s = this.serenityFlagMap.maturity;
  0 === n || 3 === n || 2 === n && !s ? this.mountFilters.removeFilter("serenity") : (1 === n && o ? i = 0 : (1 === n && s || 2 === n && !a) && (i = y.GOOD_SERENITY_MAX), 1 === n && a ? t = 0 : (1 === n && s || 2 === n && !o) && (t = y.GOOD_SERENITY_MIN), this.mountFilters.setFilter("serenity", [t, i]));
  this._delFilterButton("serenity");
  n && this._addFilterButton("serenity", f("ui.common.serenity"));
  this._updateFilter();
};
n.prototype._resetSerenityFilter = function () {
  this.serenityFlagMap = {
    stamina: !1,
    maturity: !1,
    love: !1
  };
  this.numSerenityZonesOn = 0;
  this._updateSerenityFilter();
};
n.prototype._addSerenityButton = function (e) {
  var t = new M("div", {
    className: e
  });
  return w(t), t.on("tap", a), t.mountFilterBox = this, t.zoneName = e, this.serenity[e] = t, t;
};
n.prototype._setupSerenityBar = function () {
  var e = this.createChild("div", {
    className: "serenityBar"
  });
  this.serenity = e;
  e.reset = this._resetSerenityFilter.bind(this);
  e.createChild("div", {
    className: ["bigIcon", "bigIcon_mad"]
  });
  var t = e.createChild("div", {
    className: "bigButton"
  });
  e.createChild("div", {
    className: ["bigIcon", "bigIcon_happy"]
  });
  t.appendChild(this._addSerenityButton("stamina"));
  t.appendChild(this._addSerenityButton("maturity"));
  t.appendChild(this._addSerenityButton("love"));
  t.createChild("div", {
    className: "bigButtonShape"
  });
};
n.prototype._setColorButtonValue = function (e, t, i) {
  var n = e.filterName,
    o = this.mountFilters;
  if (e.colorId && (this._delFilterButton(n), o.removeFilter(n)), e.colorId = t, t) {
    var a = null;
    t !== S ? (a = o.getSingleColorMap()[t].colors[0], o.addColorFilter(n, t)) : (i = u, o.addPureColorFilter(n));
    this._addFilterButton(n, i);
    e.colorTile.setStyle("backgroundColor", a);
    e.setLabel(i);
    e.setIcon(t !== S ? e.colorTile : null);
    e.selectState(N);
    var s = e === this.colorB ? this.colorA : this.colorB;
    t === s.colorId && o.isRealColor(t) && this._setColorButtonValue(s, S, u);
  } else {
    e.setLabel(e.emptyLabel);
    e.setIcon(null);
    e.selectState(E);
  }
};
n.prototype._newColorList = function (e, t, i) {
  var n = f("tablet.common.color") + " " + i,
    o = e.appendChild(new b(t, r, {
      text: n
    }));
  o.addClassNames(t);
  o.colorTile = new M("div", {
    className: "colorTile"
  });
  o.emptyLabel = n;
  o.mountFilterBox = this;
  o.filterName = t;
  var a = this.mountFilters.getSingleColorMap(),
    l = s.bind(o),
    c = o.menuActions = [];
  for (var d in a) {
    c.push({
      id: ~~d,
      caption: a[d].singleColorName,
      cb: l
    });
  }
  return p.sortMenuActions(c), c.unshift({
    id: S,
    caption: "(" + u + ")",
    cb: l
  }), o;
};
n.prototype._setupColorBar = function () {
  var e = this.createChild("div", {
      className: "colorBar"
    }),
    t = e.createChild("div", {
      className: "colorDiv"
    });
  this.colorA = this._newColorList(t, "colorA", 1);
  this.colorB = this._newColorList(t, "colorB", 2);
};
n.prototype._newAbilityList = function (e, t, i) {
  var n = f("ui.common.capacity", 1) + " " + i,
    o = e.appendChild(new b(t, c, {
      text: n
    }));
  o.addClassNames(t);
  o.emptyLabel = n;
  o.mountFilterBox = this;
  o.filterName = t;
  var a = window.gui.databases.MountBehaviors,
    s = l.bind(o),
    r = o.menuActions = [];
  for (var d in a) {
    r.push({
      id: ~~d,
      caption: a[d].nameId,
      cb: s
    });
  }
  return p.sortMenuActions(r), o;
};
n.prototype._setupAbilityBar = function () {
  var e = this.createChild("div", {
      className: "abilityBar"
    }),
    t = e.createChild("div", {
      className: "abilityDiv"
    });
  this.abilityA = this._newAbilityList(t, "abilityA", 1);
  this.abilityB = this._newAbilityList(t, "abilityB", 2);
};
n.prototype._fatigueBtnHandler = function (e, t) {
  this._enterBatchUpdate();
  t && this._deactivateOppositeToggles(e, I);
  var i = A[e];
  t ? (this._addFilterButton(e, i.label), void 0 !== i.equal && (this.minFatigue = this.maxFatigue = i.equal), void 0 !== i.min && (this.minFatigue = i.min), void 0 !== i.max && (this.maxFatigue = i.max)) : (this._delFilterButton(e), void 0 === i.min && void 0 === i.equal || (this.minFatigue = 0), void 0 === i.max && void 0 === i.equal || (this.maxFatigue = 100));
  0 !== this.minFatigue || 100 !== this.maxFatigue ? this.mountFilters.setFilter("fatigue", [this.minFatigue, this.maxFatigue]) : this.mountFilters.removeFilter("fatigue");
  this._leaveBatchUpdate();
};
n.prototype._setupFatigueBar = function () {
  var e = this._fatigueBtnHandler.bind(this),
    t = this.createChild("div", {
      className: "fatigueBar"
    });
  o(t, f("ui.common.tire"));
  var i = t.createChild("div", {
    className: "fatigueDiv"
  });
  this.tired0Btn = i.appendChild(new b("tired0Btn", e, {
    text: "0%"
  }));
  this.tiredInf50Btn = i.appendChild(new b("tiredInf50Btn", e, {
    text: "< 50%"
  }));
  this.tiredSup50Btn = i.appendChild(new b("tiredSup50Btn", e, {
    text: ">= 50%"
  }));
  this.tiredInf100Btn = i.appendChild(new b("tiredInf100Btn", e, {
    text: "< 100%"
  }));
  this.tired100Btn = i.appendChild(new b("tired100Btn", e, {
    text: "100%"
  }));
};
n.prototype._addFilterButton = function (e, t, i) {
  var n = new m(t, d, e);
  i && n.addClassNames(i);
  n.mountFilterBox = this;
  this.filterButtons.push(n);
};
n.prototype._delFilterButton = function (e) {
  for (var t = 0; t < this.filterButtons.length; t++) {
    var i = this.filterButtons[t];
    if (i.filterName === e) {
      return void this.filterButtons.splice(t, 1);
    }
  }
};
n.prototype._updateButtonBar = function () {
  if (this.buttonBar) {
    for (var e = new M("div"), t = 0; t < this.filterButtons.length; t++) {
      var i = this.filterButtons[t];
      e.appendChild(i);
    }
    this.buttonBar.clearContent();
    this.buttonBar.appendChild(e);
  }
};
this._enterBatchUpdate();
this._clearSearchBox();
this._resetSerenityFilter();
this.colorA.reset();
this.colorB.reset();
this.abilityA.reset();
this.abilityB.reset();
this.minFatigue = 0;
this.maxFatigue = 100;
this._leaveBatchUpdate(e);
this.batchUpdateLevel--;
0 !== this.batchUpdateLevel || e || this._updateFilter();
u = f("tablet.mount.pureColor");
this._setupNameBar();
this._setupToggles();
this._setupSerenityBar();
this._setupFatigueBar();
this._setupColorBar();
this._setupAbilityBar();
this.appendChild(new h({
  text: f("ui.common.reset"),
  className: ["button", "resetButton"]
}, this._resetFilters.bind(this, !1)));
this._resetFilters(!0);
this.isReady = !0;
t.setPlaceholder(f("ui.common.name"));
t.on("search", this._searchBoxChanged.bind(this));
t.reset = this._clearSearchBox.bind(this);
this._delFilterButton("searchBox");
e ? (this.mountFilters.setFilter("name", e.toLowerCase()), this._addFilterButton("searchBox", '"' + e + '"')) : this.mountFilters.removeFilter("name");
this._updateFilter();
this.searchBox.setValue("");
this._searchBoxChanged("");
this._delFilterButton(e);
this.mountFilters.removeFilter(o);
this._deactivateOppositeToggles(e, T);
this._addFilterButton(e, f(n.label));
this.mountFilters.setFilter(o, t);
this._delFilterButton(e);
this._addFilterButton(e, f(n.label), "reversed");
this.mountFilters.setFilter(o, t);
o.isReversible ? n = L : o.isReversed && (n = O);
this[t] = e.appendChild(new b(t, i, {
  text: a,
  addIcon: s,
  states: n
}));
this._newToggleButton(t, "maleBtn", e);
this._newToggleButton(t, "femaleBtn", e);
t = this.createChild("div", {
  className: "sexBar"
});
this._newToggleButton(t, "newbornBtn", e);
this._newToggleButton(t, "rideableBtn", e);
t = this.createChild("div", {
  className: "fertileBar"
});
this._newToggleButton(t, "pregnantBtn", e);
this._newToggleButton(t, "fertileBtn", e);
this._newToggleButton(t, "sterilizedBtn", e);
t = i.createChild("div", {
  className: "hasOrNeedsDiv"
});
this._newToggleButton(t, "staminaBtn", e);
this._newToggleButton(t, "loveBtn", e);
t = i.createChild("div", {
  className: "hasOrNeedsDiv"
});
this._newToggleButton(t, "maturityBtn", e);
this._newToggleButton(t, "energyBtn", e);
0 === n || 3 === n || 2 === n && !s ? this.mountFilters.removeFilter("serenity") : (1 === n && o ? i = 0 : (1 === n && s || 2 === n && !a) && (i = y.GOOD_SERENITY_MAX), 1 === n && a ? t = 0 : (1 === n && s || 2 === n && !o) && (t = y.GOOD_SERENITY_MIN), this.mountFilters.setFilter("serenity", [t, i]));
this._delFilterButton("serenity");
n && this._addFilterButton("serenity", f("ui.common.serenity"));
this._updateFilter();
this.serenityFlagMap = {
  stamina: !1,
  maturity: !1,
  love: !1
};
this.numSerenityZonesOn = 0;
this._updateSerenityFilter();
this.serenity = e;
e.reset = this._resetSerenityFilter.bind(this);
e.createChild("div", {
  className: ["bigIcon", "bigIcon_mad"]
});
e.createChild("div", {
  className: ["bigIcon", "bigIcon_happy"]
});
t.appendChild(this._addSerenityButton("stamina"));
t.appendChild(this._addSerenityButton("maturity"));
t.appendChild(this._addSerenityButton("love"));
t.createChild("div", {
  className: "bigButtonShape"
});
t !== S ? (a = o.getSingleColorMap()[t].colors[0], o.addColorFilter(n, t)) : (i = u, o.addPureColorFilter(n));
this._addFilterButton(n, i);
e.colorTile.setStyle("backgroundColor", a);
e.setLabel(i);
e.setIcon(t !== S ? e.colorTile : null);
e.selectState(N);
e.setLabel(e.emptyLabel);
e.setIcon(null);
e.selectState(E);
o.addClassNames(t);
o.colorTile = new M("div", {
  className: "colorTile"
});
o.emptyLabel = n;
o.mountFilterBox = this;
o.filterName = t;
this.colorA = this._newColorList(t, "colorA", 1);
this.colorB = this._newColorList(t, "colorB", 2);
o.addClassNames(t);
o.emptyLabel = n;
o.mountFilterBox = this;
o.filterName = t;
this.abilityA = this._newAbilityList(t, "abilityA", 1);
this.abilityB = this._newAbilityList(t, "abilityB", 2);
this._enterBatchUpdate();
t && this._deactivateOppositeToggles(e, I);
t ? (this._addFilterButton(e, i.label), void 0 !== i.equal && (this.minFatigue = this.maxFatigue = i.equal), void 0 !== i.min && (this.minFatigue = i.min), void 0 !== i.max && (this.maxFatigue = i.max)) : (this._delFilterButton(e), void 0 === i.min && void 0 === i.equal || (this.minFatigue = 0), void 0 === i.max && void 0 === i.equal || (this.maxFatigue = 100));
0 !== this.minFatigue || 100 !== this.maxFatigue ? this.mountFilters.setFilter("fatigue", [this.minFatigue, this.maxFatigue]) : this.mountFilters.removeFilter("fatigue");
this._leaveBatchUpdate();
this.tired0Btn = i.appendChild(new b("tired0Btn", e, {
  text: "0%"
}));
this.tiredInf50Btn = i.appendChild(new b("tiredInf50Btn", e, {
  text: "< 50%"
}));
this.tiredSup50Btn = i.appendChild(new b("tiredSup50Btn", e, {
  text: ">= 50%"
}));
this.tiredInf100Btn = i.appendChild(new b("tiredInf100Btn", e, {
  text: "< 100%"
}));
this.tired100Btn = i.appendChild(new b("tired100Btn", e, {
  text: "100%"
}));
i && n.addClassNames(i);
n.mountFilterBox = this;
this.filterButtons.push(n);
this.buttonBar.clearContent();
this.buttonBar.appendChild(e);
s.call(this, "div");
this.name = e;
this.tapHandler = t;
this.states = i.states || r;
this._createDom(i);
this._setValueByIndex(0);
a(this);
this.on("tap", this._changeToNextValue);
o(n, s);
e.exports = n;
n.prototype._createDom = function (e) {
  e.addIcon && (this.icon = this.createChild("div", {
    className: "btnIcon"
  }));
  e.text && (this.labelElement = this.createChild("div", {
    className: "label",
    text: e.text
  }));
};
n.prototype._changeToNextValue = function () {
  var e = (this.valueIndex + 1) % this.states.length;
  this._setValueByIndex(e);
  this._notifyOfUpdate();
};
n.prototype._notifyOfUpdate = function () {
  this.tapHandler(this.name, this.states[this.valueIndex].value, this.valueIndex);
};
n.prototype._setValueByIndex = function (e) {
  this.valueIndex = e;
  var t = this.icon ? "withIcon" : "";
  this.setClassNames(["toggleButton", this.name, t, this.states[e].className]);
};
n.prototype.setIcon = function (e) {
  e !== this.icon && (this.icon && this.removeChild(this.icon), this.icon = e, this.toggleClassName("withIcon", !!e), e && this.insertAsFirstChild(e));
};
n.prototype.setLabel = function (e) {
  this.labelElement.setText(e);
};
n.prototype.reset = function () {
  0 !== this.valueIndex && (this._setValueByIndex(0), this._notifyOfUpdate());
};
n.prototype.selectState = function (e) {
  return e < 0 || e >= this.states.length ? console.error("Bad state index for toggle: " + e) : void this._setValueByIndex(e);
};
e.addIcon && (this.icon = this.createChild("div", {
  className: "btnIcon"
}));
e.text && (this.labelElement = this.createChild("div", {
  className: "label",
  text: e.text
}));
this._setValueByIndex(e);
this._notifyOfUpdate();
this.id = e;
this.name = t;
this["do"] = i;
this.args = n;
c.call(this);
this.activeFilters = {};
this.singleColorMap = {};
this.filterMap = {};
n.isReady = !0;
n.emit("mountFiltersReady");
u(o, c);
e.exports = o;
o.MountFilter = n;
o.prototype._getFilterDefinitions = function () {
  return [{
    id: "name",
    "do": function (e) {
      return this.name.toLowerCase().indexOf(e) > -1;
    }
  }, {
    id: "sex",
    name: d("ui.common.animalFemale"),
    antiName: d("ui.common.animalMale"),
    "do": function (e) {
      return this.sex === e;
    }
  }, {
    id: "baby",
    name: d("tablet.mount.filterNewborn"),
    "do": function (e) {
      var t = !!this.isNewborn;
      return t === e;
    }
  }, {
    id: "fruitful",
    name: d("tablet.mount.filterFertile"),
    "do": function (e) {
      var t = !!this.isFecondationReady,
        i = this.reproductionCount < 0 || this.reproductionCount >= this.reproductionCountMax;
      return t && e || !t && !i && !e;
    }
  }, {
    id: "pregnant",
    name: d("tablet.mount.filterPregnant"),
    "do": function (e) {
      return this.fecondationTime > 0 === e && void 0 !== this.fecondationTime;
    }
  }, {
    id: "mountable",
    name: d("tablet.mount.filterMountable"),
    "do": function (e) {
      return this.isRideable === e;
    }
  }, {
    id: "sterilized",
    name: d("tablet.mount.filterSterilized"),
    "do": function (e) {
      var t = this.reproductionCount < 0 || this.reproductionCount >= this.reproductionCountMax;
      return t === e;
    }
  }, {
    id: "love",
    name: d("tablet.mount.filterNeedLove"),
    "do": function (e) {
      return this.love >= f === e;
    }
  }, {
    id: "stamina",
    name: d("tablet.mount.filterNeedStamina"),
    "do": function (e) {
      return this.stamina >= f === e;
    }
  }, {
    id: "maturity",
    name: d("tablet.mount.filterNeedMaturity"),
    "do": function (e) {
      return this.maturity >= this.maturityForAdult === e;
    }
  }, {
    id: "energy",
    name: d("tablet.mount.filterNeedEnergy"),
    "do": function (e) {
      return this.energy >= this.energyMax === e;
    }
  }, {
    id: "serenity",
    name: d("ui.common.serenity"),
    "do": function (e, t) {
      return this.serenity >= e && this.serenity <= t;
    }
  }, {
    id: "fatigue",
    name: d("ui.common.tire"),
    "do": function (e, t) {
      var i = this.boostLimiter / this.boostMax * 100;
      return i >= e && i <= t;
    }
  }];
};
o.prototype.isEmpty = function () {
  return h(this.activeFilters);
};
o.prototype.isMatch = function (e) {
  var t = this.activeFilters;
  for (var i in t) {
    var n = t[i];
    if (!n["do"].apply(e, n.args)) {
      return !1;
    }
  }
  return !0;
};
o.prototype.setFilter = function (e, t) {
  var i = this.filterMap[e];
  return i.args = Array.isArray(t) ? t : [t], this.activeFilters[e] = i, i;
};
o.prototype.removeFilter = function (e) {
  delete this.activeFilters[e];
};
o.prototype.addBehaviorFilter = function (e, t, i) {
  var o = window.gui.databases.MountBehaviors[t];
  this.activeFilters[e] = new n("behavior" + t, o.nameId, a, [t, i]);
};
o.prototype.addColorFilter = function (e, t) {
  var i = this.singleColorMap[t];
  this.activeFilters[e] = new n("color" + t, i.singleColorName, s, [t]);
};
o.prototype.addPureColorFilter = function (e) {
  this.activeFilters[e] = new n("colorPure", "", r);
};
o.prototype.getSingleColorMap = function () {
  return this.singleColorMap;
};
o.prototype.isRealColor = function (e) {
  return e !== g && e !== _;
};
o.prototype._setupTypes = function (e) {
  var t = this.singleColorMap;
  m.getAllDataTable("Mounts", function (i, n) {
    if (i) {
      return console.error(i);
    }
    for (var o = 0; o < n.length; o++) {
      var a = n[o];
      w[a.id] = a;
      a.colors = p.parseColorsFromLook(a.id, a.look);
      b.indexOf(a.id) !== -1 && (a.singleColorName = l(a.nameId), t[a.id] = a);
    }
    return e && e();
  });
};
w[a.id] = a;
a.colors = p.parseColorsFromLook(a.id, a.look);
b.indexOf(a.id) !== -1 && (a.singleColorName = l(a.nameId), t[a.id] = a);
this.breedingWindow = e;
this.id = t;
this.name = i || "";
this.capacity = n || Number.POSITIVE_INFINITY;
this.box = null;
this.reset();
e.scrollStartTime = Date.now();
e.isScrolling = !0;
e.refreshInterval || (e.refreshInterval = window.setInterval(r, f, e));
e.isScrolling = !1;
e._stopTicker();
e.exports = n;
n.prototype.reset = function () {
  this.delayedSetup = 0;
  this._stopTicker();
  this.refreshInterval = null;
  this.lastRenderedScrollY = -1;
  this.scrollStartTime = 0;
  this.isScrolling = !1;
  this.isRefreshComplete = !0;
  this.numMounts = 0;
  this.mountMap = {};
  this.selectedTiles = {};
  this.numSelected = 0;
  this.isLocked = !1;
  this.needsScrollerRefresh = !1;
  this.needRefilter = !1;
  this.hasNoFilter = !0;
  this.hasNoSorter = !0;
  this.tilesPerPage = 0;
  this.allTiles = [];
  this.allVisibleTiles = [];
  this.box && (this.box.clearContent(), this.scroller.goToTop());
};
n.prototype.createBox = function (e) {
  var t = this.scroller = e.appendChild(new d(null, {
    maxSpeed: m,
    bounce: !0
  }));
  t.room = this;
  t.setStyle("maxHeight", e.rootElement.clientHeight + "px");
  t.on("scrollStart", o);
  t.on("scrollEnd", a);
  t.on("scrollCancel", s);
  var i = t.content.createChild("div", {
    className: ["roomBox", this.id]
  });
  return this.box = i.createChild("div", {
    className: "tileRoom"
  }), this.scrollGrip = i.createChild("div", {
    className: "scrollGrip"
  }), t;
};
n.prototype.getTile = function (e) {
  return this.box.getChild(e);
};
n.prototype.setMountSelected = function (e, t) {
  var i = this.getTile(e);
  return i ? (t ? i.selected || (this.selectedTiles[e] = i, this.numSelected++) : i.selected && (delete this.selectedTiles[e], this.numSelected--), i.setTileSelected(t), i) : console.error("Invalid tileId:", e);
};
n.prototype.setHightlightedMount = function (e) {
  var t = this.setMountSelected(e, !0);
  t.highlightTile();
};
n.prototype.selectAll = function () {
  for (var e = this.allVisibleTiles, t = 0; t < e.length; t++) {
    var i = e[t];
    i.selected || (this.selectedTiles[i.id] = i, i.setTileSelected(!0));
  }
  this.numSelected = e.length;
};
n.prototype.unselectAll = function () {
  for (var e in this.selectedTiles) {
    var t = this.selectedTiles[e];
    t.setTileSelected(!1);
  }
  this.selectedTiles = {};
  this.numSelected = 0;
};
n.prototype.getSelection = function () {
  return Object.keys(this.selectedTiles);
};
n.prototype.getNumSelected = function () {
  return this.numSelected;
};
n.prototype.getNumHiddenMounts = function () {
  return this.allTiles.length - this.allVisibleTiles.length;
};
n.prototype.addMount = function (e) {
  this.mountMap[e.id] = e;
  this.numMounts++;
  var t = new c(e, this);
  this.box.appendChild(t);
  this.allTiles.push(t);
  this.hasNoSorter && this.allVisibleTiles.push(t);
  this.needsScrollerRefresh = !0;
};
n.prototype.removeMount = function (e) {
  var t = this.mountMap[e];
  if (!t) {
    return console.warn("removeMount: invalid ID:", e);
  }
  var i = this.box.getChild(e);
  delete this.mountMap[e];
  this.numMounts--;
  i.selected && (delete this.selectedTiles[e], this.numSelected--);
  var n = this.allTiles.indexOf(i);
  this.allTiles.splice(n, 1);
  var o = this.allVisibleTiles;
  n = o.indexOf(i);
  o.splice(n, 1);
  for (var a = o.length - 1; a >= n; a--) {
    o[a].markForReorder();
  }
  i.hideTile();
  this.box.removeChild(e);
  this.needsScrollerRefresh = !0;
};
n.prototype._sortByProperty = function (e, t) {
  function i(t, i) {
    var o = t.mountData,
      a = i.mountData,
      s = o[e],
      r = a[e];
    return o.receivedData && void 0 !== o.receivedData[e] && null !== o.receivedData[e] && (s = o.receivedData[e]), a.receivedData && void 0 !== a.receivedData[e] && null !== a.receivedData[e] && (r = a.receivedData[e]), s > r ? n : s < r ? -n : o.id > a.id ? n : o.id < a.id ? -n : 0;
  }
  this.hasNoSorter = !1;
  var n = t ? -1 : 1;
  this._hideAllTiles();
  this.needRefilter = !0;
  this.allTiles.sort(i);
  for (var o = this.allTiles, a = 0; a < o.length; a++) {
    this.box.appendChild(o[a]);
  }
};
n.prototype._filter = function (e) {
  var t = e.isEmpty();
  if (!t || !this.hasNoFilter || this.needRefilter) {
    this.needsScrollerRefresh = !0;
    this.hasNoFilter = t;
    this.needRefilter = !1;
    this._hideAllTiles();
    this.allVisibleTiles = [];
    for (var i = this.allTiles, n = 0; n < i.length; n++) {
      var o = i[n],
        a = o.mountData;
      a.receivedData && (a = a.receivedData);
      e.isMatch(a) && (this.allVisibleTiles.push(o), o.showTile());
    }
  }
};
n.prototype.toggleDisplay = function (e) {
  this.scroller.toggleDisplay(e);
};
n.prototype.lockRoom = function () {
  this.isLocked = !0;
  this.scroller.hide();
  this._hideAllTiles();
};
n.prototype.refreshDisplay = function (e, t, i) {
  return this.isLocked && (this.isLocked = !1, this._showAllTiles()), this.scroller.show(), t && this._sortByProperty(t, i), this._filter(e), this.tilesPerPage ? (this.needsScrollerRefresh && (this.scroller.refresh(), this.needsScrollerRefresh = !1), void this._refreshView(!0)) : this._setupLayout();
};
n.prototype._setupLayout = function () {
  if (this.allVisibleTiles.length) {
    var e = this.scroller.getParent().rootElement,
      t = e.clientWidth,
      i = e.clientHeight,
      n = this.allVisibleTiles[0];
    n.setStyle("opacity", 0);
    var o = n.rootElement.clientWidth,
      a = this.columnWidth = o + 2 * u;
    this.rowHeight = n.rootElement.clientHeight + 2 * u;
    n.setStyle("opacity", null);
    var s = Math.floor(t / a),
      r = t - s * a - p;
    r < h && s > 1 && (s--, r += a);
    this.numColumns = s;
    var l = Math.ceil(i / this.rowHeight) + 1;
    this.tilesPerPage = l * this.numColumns;
    this.extraTilesTopOrBottom = this.tilesPerPage;
    c.prepareTilePool(this, Math.min(this.numMounts, this.tilesPerPage + 2 * this.extraTilesTopOrBottom));
    this.scrollGrip.setStyle("width", r + "px");
    this.scroller.refresh();
    this._refreshView(!0);
  }
};
n.prototype._stopTicker = function () {
  window.clearInterval(this.refreshInterval);
  this.refreshInterval = null;
};
n.prototype._refreshView = function (e) {
  var t = Math.min(0, this.scroller.iScroll.y);
  if (!(this.isRefreshComplete && !e && Math.abs(t - this.lastRenderedScrollY) < this.rowHeight)) {
    var i = t - this.lastRenderedScrollY > 0;
    this.isRefreshComplete = !1;
    for (var n = this.allVisibleTiles, o = n.length, a = Math.floor(-t / this.rowHeight) * this.numColumns, s = a, r = Math.min(a + this.tilesPerPage, o), c = this.extraTilesTopOrBottom, d = Math.max(0, a - c), u = Math.min(a + this.tilesPerPage + c, o), h = 0; h < o; h++) {
      h >= d && h < u || n[h].prepareToGoOffScreen();
    }
    var p = e ? 1 / 0 : this.numColumns * _,
      m = l(1, n, s, r, i, p);
    p -= m;
    m && !e || (m = l(2, n, s, r, i, p));
    e && (m += l(1, n, d, u));
    0 === m && (this.isRefreshComplete = !0, this.lastRenderedScrollY = t);
  }
};
n.prototype._hideAllTiles = function () {
  for (var e = this.allVisibleTiles, t = 0; t < e.length; t++) {
    e[t].hideTile();
  }
  c.hidePoolTiles(this);
};
n.prototype._showAllTiles = function () {
  for (var e = this.allVisibleTiles, t = 0; t < e.length; t++) {
    e[t].showTile();
  }
};
this.delayedSetup = 0;
this._stopTicker();
this.refreshInterval = null;
this.lastRenderedScrollY = -1;
this.scrollStartTime = 0;
this.isScrolling = !1;
this.isRefreshComplete = !0;
this.numMounts = 0;
this.mountMap = {};
this.selectedTiles = {};
this.numSelected = 0;
this.isLocked = !1;
this.needsScrollerRefresh = !1;
this.needRefilter = !1;
this.hasNoFilter = !0;
this.hasNoSorter = !0;
this.tilesPerPage = 0;
this.allTiles = [];
this.allVisibleTiles = [];
this.box && (this.box.clearContent(), this.scroller.goToTop());
t.room = this;
t.setStyle("maxHeight", e.rootElement.clientHeight + "px");
t.on("scrollStart", o);
t.on("scrollEnd", a);
t.on("scrollCancel", s);
this.selectedTiles = {};
this.numSelected = 0;
this.mountMap[e.id] = e;
this.numMounts++;
this.box.appendChild(t);
this.allTiles.push(t);
this.hasNoSorter && this.allVisibleTiles.push(t);
this.needsScrollerRefresh = !0;
delete this.mountMap[e];
this.numMounts--;
i.selected && (delete this.selectedTiles[e], this.numSelected--);
n = o.indexOf(i);
o.splice(n, 1);
i.hideTile();
this.box.removeChild(e);
this.needsScrollerRefresh = !0;
this._hideAllTiles();
this.needRefilter = !0;
this.allTiles.sort(i);
this.needsScrollerRefresh = !0;
this.hasNoFilter = t;
this.needRefilter = !1;
this._hideAllTiles();
this.allVisibleTiles = [];
a.receivedData && (a = a.receivedData);
e.isMatch(a) && (this.allVisibleTiles.push(o), o.showTile());
this.isLocked = !0;
this.scroller.hide();
this._hideAllTiles();
this.rowHeight = n.rootElement.clientHeight + 2 * u;
n.setStyle("opacity", null);
r < h && s > 1 && (s--, r += a);
this.numColumns = s;
this.tilesPerPage = l * this.numColumns;
this.extraTilesTopOrBottom = this.tilesPerPage;
c.prepareTilePool(this, Math.min(this.numMounts, this.tilesPerPage + 2 * this.extraTilesTopOrBottom));
this.scrollGrip.setStyle("width", r + "px");
this.scroller.refresh();
this._refreshView(!0);
window.clearInterval(this.refreshInterval);
this.refreshInterval = null;
p -= m;
m && !e || (m = l(2, n, s, r, i, p));
e && (m += l(1, n, d, u));
0 === m && (this.isRefreshComplete = !0, this.lastRenderedScrollY = t);
a.call(this, "div", {
  className: "tabs"
});
e = e || {};
this.addClassNames(e.className);
this.options = e;
this.tabsMap = {};
this.tabsOrderIds = [];
this.curentTabId = null;
this.nextId = 0;
o(n, a);
e.exports = n;
n.prototype.addTab = function (e, t, i) {
  var n = this,
    o = i,
    a = !1;
  o || (o = this.nextId, this.nextId += 1, a = !0);
  var l = a ? "tab" + o : o,
    c = this.createChild("div", {
      className: ["tab", l],
      text: e
    });
  return s(c), c.on("tap", function () {
    n.options.closable && o === n.curentTabId ? n.close() : (n.openTab(o), r("TAB"));
  }), c.on("enable", function (e) {
    this._isDisable = !e;
    this.toggleClassName("disabled", !e);
    e || n.curentTabId !== o || n.openFirstTab();
  }), this.tabsMap[o] = {
    tab: c,
    target: t
  }, this.tabsOrderIds.push(o), t && t.hide(), o;
};
n.prototype.toggleTabDisplay = function (e, t) {
  var i = this.tabsMap[e];
  if (i && i.tab.toggleDisplay(t), this.curentTabId === e && !i.tab.isVisible()) {
    var n = this.tabsOrderIds[0];
    e === n ? this.close() : this.openTab(n);
  }
};
n.prototype.openTab = function (e, t, i) {
  i = i || {};
  t = t || {};
  var n = this.curentTabId === e;
  if (i.forceOpen || !n) {
    "number" == typeof e && (e = this.tabsOrderIds[e]);
    var o = this.tabsMap[e];
    if (!o) {
      return console.error("openTab - invalid tab ID given: " + e);
    }
    n || this.close();
    o.tab.addClassNames("on");
    this.toggleTabNotification(e, !1);
    var a = o.target;
    a && (a.emit("open", t), a.show(), i.delayOpenedEvent || a.emit("opened", t));
    this.curentTabId = e;
    this.emit("openTab", e);
  }
};
n.prototype.openFirstTab = function () {
  this.openTab(this.tabsOrderIds[0]);
};
n.prototype.getTabsMap = function () {
  return this.tabsMap;
};
n.prototype.getFirstTab = function () {
  return this.tabsMap[this.tabsOrderIds[0]];
};
n.prototype.getCurrentTabId = function () {
  return this.curentTabId;
};
n.prototype.getCurrentTab = function () {
  return this.tabsMap[this.curentTabId];
};
n.prototype.getTabTarget = function (e) {
  var t = this.tabsMap[e] || {};
  return t.target;
};
n.prototype.close = function () {
  if (this.curentTabId || "number" == typeof this.curentTabId) {
    var e = this.tabsMap[this.curentTabId];
    e.tab.delClassNames("on");
    var t = e.target;
    t && (t.hide(), t.emit("close"));
  }
  this.curentTabId = null;
};
n.prototype.setClosable = function (e) {
  this.options.closable = e;
};
n.prototype.toggleTabNotification = function (e, t) {
  var i = this.tabsMap[e];
  i && i.tab.toggleClassName("notification", t);
};
n.prototype.toggleTabAvailability = function (e, t) {
  var i = this.tabsMap[e];
  if (i) {
    var n = i.tab;
    void 0 === t && (t = !n._isDisable);
    n.setEnable(t);
  }
};
n.prototype.emitOnCurrentTab = function (e, t) {
  t = t || {};
  var i = this.getCurrentTab();
  i && i.target.emit(e, t);
};
this._isDisable = !e;
this.toggleClassName("disabled", !e);
e || n.curentTabId !== o || n.openFirstTab();
i = i || {};
t = t || {};
n || this.close();
o.tab.addClassNames("on");
this.toggleTabNotification(e, !1);
a && (a.emit("open", t), a.show(), i.delayOpenedEvent || a.emit("opened", t));
this.curentTabId = e;
this.emit("openTab", e);
void 0 === t && (t = !n._isDisable);
n.setEnable(t);
s.call(this, "div", {
  className: ["waitingGauge", "spinner"],
  hidden: !0
});
e = e || {};
this.progressCircle = i.appendChild(new a({
  size: e.size || r,
  thickness: e.thickness || l,
  color: e.color || c,
  bgColor: e.bgColor || d
}));
this.valueElement = i.createChild("div", {
  className: "value",
  text: ""
});
this.labelElt = t.createChild("div", {
  className: "label",
  text: ""
});
o(n, s);
e.exports = n;
n.prototype.setLabel = function (e) {
  this.labelElt.setText(e);
};
n.prototype.showGauge = function (e, t, i) {
  this.goal = e;
  i = i || 1;
  e > i ? (this.progressCircle.setValue(0, 1), this.valueElement.setText("0%"), this.labelElt.setText(t ? t : ""), this.delClassNames("spinner"), this.gauge.show(), this.labelElt.show()) : this.labelElt.hide();
  this.show();
};
n.prototype.refreshGauge = function (e) {
  if (this.gauge.isVisible()) {
    var t = (this.goal - e) / this.goal;
    this.progressCircle.setValue(t, 1);
    this.valueElement.setText(Math.round(100 * t) + "%");
  }
  0 === e && this.hideGauge();
};
n.prototype.hideGauge = function () {
  this.goal = 0;
  this.addClassNames("spinner");
  this.gauge.hide();
  this.hide();
};
this.goal = e;
i = i || 1;
e > i ? (this.progressCircle.setValue(0, 1), this.valueElement.setText("0%"), this.labelElt.setText(t ? t : ""), this.delClassNames("spinner"), this.gauge.show(), this.labelElt.show()) : this.labelElt.hide();
this.show();
this.progressCircle.setValue(t, 1);
this.valueElement.setText(Math.round(100 * t) + "%");
this.goal = 0;
this.addClassNames("spinner");
this.gauge.hide();
this.hide();
h.call(this, {
  title: f("ui.common.caracteristics"),
  className: "characteristics",
  positionInfo: {
    left: 40,
    top: "c",
    width: 320,
    height: 634
  }
});
d = {
  maxLifePoints: f("ui.help.life"),
  actionPoints: f("ui.help.AP"),
  movementPoints: f("ui.help.MP"),
  initiative: f("ui.help.initiative"),
  prospecting: f("ui.help.prospecting"),
  range: f("ui.help.range"),
  summonableCreaturesBoost: f("ui.help.summonableCreatures"),
  vitality: f("ui.help.vitality"),
  wisdom: f("ui.help.wisdom"),
  strength: f("ui.help.strength"),
  intelligence: f("ui.help.intelligence"),
  chance: f("ui.help.chance"),
  agility: f("ui.help.agility"),
  level: f("ui.help.level"),
  red: f("ui.help.energy"),
  blue: f("ui.help.xp"),
  characteristics: f("ui.help.boostPoints")
};
this._initialized = !1;
this._createDom();
this._setupListeners();
this.current = 0;
this.max = 0;
this.progressBar = o.appendChild(new m({
  className: i
}));
v.addTooltip(a, d[i], {
  longTapExplanation: !0
});
v.addTooltip(this.progressBar, function () {
  return new y("div", {
    text: n.current + " / " + n.max
  });
}, {
  longTapExplanation: !0
});
this.statLine = o.createChild("td", {
  className: "value"
});
v.addTooltip(a, d[i], {
  longTapExplanation: !0
});
o.createChild("td", {
  className: ["label", n],
  text: t
});
this.baseLine = o.createChild("td", {
  className: "base"
});
this.bonusLine = o.createChild("td", {
  className: "bonus"
});
this.totalLine = o.createChild("td", {
  className: "total"
});
this.labelDom = a.createChild("td", {
  className: ["label", n],
  text: t
});
this.valueDom = a.createChild("td", {
  className: "value"
});
this.refundedValueDom = a.createChild("td", {
  className: ["value", "arrowRight"]
});
this.refundedValueText = this.refundedValueDom.createChild("div", {
  className: "refundedValue"
});
this.upgradeButton = s.createChild("div", {
  className: "upgradeButton"
});
this.resetCheckbox = s.appendChild(new M());
v.addTooltip(this.labelDom, d[i], {
  longTapExplanation: !0
});
v.addTooltip(this.valueDom, function () {
  var e = new y("div", {
    className: "toolTipLabelBlock"
  });
  if (o.stats) {
    var t = o.stats[o.key],
      i = f("ui.common.base") + "+" + f("tablet.common.additional");
    i += f("ui.common.colon");
    i += t.getBaseWithoutAdditionalPts() + "+" + t.getAdditionalPts();
    var n = f("ui.common.equipement") + f("ui.common.colon");
    n += l(t.getEquipmentPts());
    var a = f("ui.common.gifts") + "+" + f("ui.common.boost") + f("ui.common.colon");
    a += l(t.getBonusPts());
    e.createChild("div", {
      className: "toolTipLabel",
      text: i
    });
    e.createChild("div", {
      className: "toolTipLabel",
      text: n
    });
    e.createChild("div", {
      className: "toolTipLabel",
      text: a
    });
  }
  return e;
}, {
  longTapExplanation: !0
});
g(this.upgradeButton);
this.upgradeButton.on("tap", function () {
  if (w("PLUS_BUTTON"), o.stats) {
    var e = "statsPointsFor" + i[0].toUpperCase() + i.substring(1),
      n = window.gui.playerData.characterBreed[e];
    _.open("characUpdate", {
      additionalPtsRemaining: o.stats.getRemainingAdditionalPts(),
      characteristicName: i,
      costSteps: n,
      initialLevel: o.stats[i].getBaseWithoutAdditionalPts(),
      initialAdditionalPts: o.stats[i].getAdditionalPts(),
      label: t,
      pointsRemaining: o.stats.statsPoints
    });
  }
});
this.resetCheckbox.on("change", function (e) {
  o.refundedValueText.toggleClassName("uncheckedStat", !e);
});
this.displayRefundedPts(!1);
i += f("ui.common.colon");
i += t.getBaseWithoutAdditionalPts() + "+" + t.getAdditionalPts();
a += l(t.getBonusPts());
e.createChild("div", {
  className: "toolTipLabel",
  text: i
});
e.createChild("div", {
  className: "toolTipLabel",
  text: n
});
e.createChild("div", {
  className: "toolTipLabel",
  text: a
});
u(n, h);
e.exports = n;
n.prototype._setupListeners = function () {
  var e = this,
    t = window.gui.playerData,
    i = t.characters,
    n = window.gui.scenarioManager;
  this.on("open", this.alignWithEquipment);
  i.on("characteristicsUpdated", function (i) {
    t.characterBreed && e.updateStats(i);
  });
  t.alignment.on("alignmentChanged", function () {
    var i = t.characterBaseInformations,
      n = t.alignment;
    n.getAlignmentImageUrl(function (t) {
      e.logo.setStyle("backgroundImage", t);
    });
    e.playerName.setText(i.name);
    t.characterBreed && e.infosSup.setText(t.characterBreed.shortNameId + ", " + f("ui.common.level") + " " + i.level);
    v.addTooltip(e.infosSup, d.level, {
      longTapExplanation: !0
    });
  });
  window.gui.scenarioManager.on("stepChanged", function () {
    var t = n.isBehaviourEnabled(C.CHARACT_MENU),
      i = n.isBehaviourEnabled(C.ADD_CHARACT),
      o = n.isBehaviourEnabled(C.DISABLE_UPGRADE_CHARACT_HIGHLIGHT);
    e.toggleClassName("disabledBehaviour", !t);
    e.toggleClassName("disabledAddStats", !i);
    e.toggleClassName("highlightedButtons", !o);
  });
};
n.prototype._createSummaryPanel = function () {
  function e() {
    g.show();
    p.show();
    M.hide();
    w.hide();
    n.capitalValueDom.show();
    n.refundedCapitalValueDom.hide();
    m.delClassNames("arrowDown");
    n.summary.forEach(function (e) {
      e.displayRefundedPts(!1);
    });
  }
  function t() {
    g.hide();
    p.hide();
    M.show();
    w.show();
    n.capitalValueDom.hide();
    n.refundedCapitalValueDom.show();
    m.setClassNames("arrowDown");
    n.summary.forEach(function (e) {
      e.displayRefundedPts(!0);
    });
  }
  function i() {
    if (window.gui.playerData.isFighting) {
      return window.gui.openSimplePopup(f("ui.error.cantDoInFight")), !1;
    }
    var e = window.gui.playerData.inventory.getGenericItem(I),
      t = window.gui.playerData.isSubscriberAtMinLevel(T.ELITE);
    return !!t || (e ? (window.gui.openSimplePopup(f("ui.stats.availableMagicalOrb"), f("ui.popup.information")), !1) : (_.open("BonusPackElitePopupWindow"), !1));
  }
  var n = this,
    s = this.panels.createChild("div", {
      className: "panel"
    });
  this.energy = new o(s, f("ui.common.energy"), "red");
  this.experience = new o(s, f("ui.common.experiment"), "blue");
  var l = s.createChild("table", {
    className: "summaryTable"
  });
  this.lifePoints = new a(l, f("ui.stats.lifePoints"), "maxLifePoints", "iconLifePoints");
  this.actionPoints = new a(l, f("ui.stats.shortAP"), "actionPoints", "iconActionPoints");
  this.movementPoints = new a(l, f("ui.stats.shortMP"), "movementPoints", "iconMovementPoints");
  this.initiative = new a(l, f("ui.stats.initiative"), "initiative", "iconInitiative");
  this.prospecting = new a(l, f("ui.stats.prospecting"), "prospecting", "iconProspecting");
  this.range = new a(l, f("ui.stats.range"), "range", "iconRange");
  this.summonableCreatures = new a(l, f("ui.stats.summonableCreatures"), "summonableCreaturesBoost", "iconSummon");
  var c = s.createChild("table", {
      className: "characTable"
    }),
    u = c.createChild("tr");
  u.createChild("td", {
    className: "tableTitle",
    text: f("ui.common.caracteristics"),
    attr: {
      colspan: 4
    }
  });
  this.summary = [];
  this.summary.push(new r(c, f("ui.stats.vitality"), "vitality", "iconVitality"));
  this.summary.push(new r(c, f("ui.stats.wisdom"), "wisdom", "iconWisdom"));
  this.summary.push(new r(c, f("ui.stats.strength"), "strength", "iconStrength"));
  this.summary.push(new r(c, f("ui.stats.intelligence"), "intelligence", "iconIntelligence"));
  this.summary.push(new r(c, f("ui.stats.chance"), "chance", "iconChance"));
  this.summary.push(new r(c, f("ui.stats.agility"), "agility", "iconAgility"));
  this.pointCapital = s.createChild("div", {
    className: "pointCapital"
  });
  var h = this.pointCapital.createChild("div", {
      className: "buttonsList"
    }),
    p = this.pointCapital.createChild("div", {
      className: "pointCapitalLabel",
      text: f("ui.common.pointsWithCap")
    }),
    m = this.pointCapital.createChild("div");
  this.capitalValueDom = m.createChild("div", {
    className: "pointCapitalValue"
  });
  this.refundedCapitalValueDom = m.createChild("div", {
    className: "pointCapitalValue"
  });
  var g = h.appendChild(new b({
    className: ["greenButton", "resetButton"],
    scaleOnPress: !0
  }));
  g.createChild("div", {
    className: "icon",
    text: f("ui.common.reset")
  });
  var w = h.appendChild(new b({
      className: ["secondaryButton", "cancelButton"],
      scaleOnPress: !0,
      text: f("ui.common.cancel")
    })),
    M = h.appendChild(new b({
      className: ["greenButton", "confirmButton"],
      scaleOnPress: !0,
      text: f("ui.common.validation")
    }));
  e();
  g.on("tap", function () {
    i() && t();
  });
  w.on("tap", function () {
    e();
  });
  M.on("tap", function () {
    return i() ? void window.gui.openConfirmPopup({
      title: f("ui.common.confirm"),
      message: f("ui.stats.resetAllStats"),
      cb: function (t) {
        if (t) {
          e();
          var i = [];
          n.summary.forEach(function (e) {
            e.resetCheckbox.isActivate() && i.push(A[e.key]);
          });
          window.dofus.sendMessage("StatsResetRequestMessage", {
            statIds: i
          });
        }
      }
    }) : void e();
  });
  n.summary.forEach(function (e) {
    e.resetCheckbox.on("change", function () {
      n.refreshRefundedPts();
    });
  });
  v.addTooltip(m, function () {
    var e = "";
    if (n.stats) {
      e = f("ui.stats.statPoints") + " " + String(n.stats.statsPoints);
      var t = n.stats.getRemainingAdditionalPts();
      t > 0 && (e += " + " + String(t));
      e += "\n\n" + d.characteristics;
    }
    return new y("div", {
      text: e
    });
  }, {
    longTapExplanation: !0
  });
  this.additionalPtsLineHelp = s.createChild("div");
  var C = this.additionalPtsLineHelp.createChild("div", {
    className: ["haveAdditionalPts", "additionalPtsLineHelp"]
  });
  C.setHtml(f("tablet.characteristics.help"));
  this.tabs.addTab(f("ui.stats.summary"), s);
};
n.prototype._createAdvancedPanel = function () {
  var e = this.panels.createChild("div", {
      className: "panel"
    }),
    t = e.createChild("table", {
      className: "advancedTable"
    }),
    i = t.createChild("tr");
  i.createChild("td", {
    className: "label",
    text: f("ui.common.caracteristics")
  });
  i.createChild("td", {
    className: "base",
    text: f("ui.common.base")
  });
  i.createChild("td", {
    className: "bonus",
    text: f("ui.fightend.bonus")
  });
  i.createChild("td", {
    className: "total",
    text: f("ui.common.total")
  });
  this.advanced = [];
  var n = t.createChild("tr");
  n.createChild("td", {
    className: "tableTitle",
    text: f("ui.charaSheet.primaryStats"),
    attr: {
      colspan: 4
    }
  });
  this.advanced.push(new s(t, f("ui.stats.vitality"), "vitality", "iconVitality"));
  this.advanced.push(new s(t, f("ui.stats.wisdom"), "wisdom", "iconWisdom"));
  this.advanced.push(new s(t, f("ui.stats.strength"), "strength", "iconStrength"));
  this.advanced.push(new s(t, f("ui.stats.intelligence"), "intelligence", "iconIntelligence"));
  this.advanced.push(new s(t, f("ui.stats.chance"), "chance", "iconChance"));
  this.advanced.push(new s(t, f("ui.stats.agility"), "agility", "iconAgility"));
  this.advanced.push(new s(t, f("ui.stats.shortAP"), "actionPoints", "iconActionPoints"));
  this.advanced.push(new s(t, f("ui.stats.shortMP"), "movementPoints", "iconMovementPoints"));
  this.advanced.push(new s(t, f("ui.stats.initiative"), "initiative", "iconInitiative"));
  this.advanced.push(new s(t, f("ui.stats.prospecting"), "prospecting", "iconProspecting"));
  this.advanced.push(new s(t, f("ui.stats.range"), "range", "iconRange"));
  this.advanced.push(new s(t, f("ui.stats.summonableCreatures"), "summonableCreaturesBoost", "iconSummon"));
  var o = t.createChild("tr");
  o.createChild("td", {
    className: "tableTitle",
    text: f("ui.charaSheet.secondaryStats"),
    attr: {
      colspan: 4
    }
  });
  this.advanced.push(new s(t, f("ui.stats.PAAttack"), "PAAttack", "iconAttackAP"));
  this.advanced.push(new s(t, f("ui.stats.dodgeAP"), "dodgePALostProbability", "iconDodgeAP"));
  this.advanced.push(new s(t, f("ui.stats.PMAttack"), "PMAttack", "iconAttackMP"));
  this.advanced.push(new s(t, f("ui.stats.dodgeMP"), "dodgePMLostProbability", "iconDodgeMP"));
  this.advanced.push(new s(t, f("ui.stats.criticalHit"), "criticalHit", "iconCriticalHit"));
  this.advanced.push(new s(t, f("ui.stats.healBonus"), "healBonus", "iconHeal"));
  this.advanced.push(new s(t, f("ui.stats.takleBlock"), "tackleBlock", "iconTackle"));
  this.advanced.push(new s(t, f("ui.stats.takleEvade"), "tackleEvade", "iconEvade"));
  var a = t.createChild("tr");
  a.createChild("td", {
    className: "tableTitle",
    text: f("ui.stats.damagesBonus"),
    attr: {
      colspan: 4
    }
  });
  this.advanced.push(new s(t, f("ui.stats.damagesBonus"), "allDamagesBonus", "iconDamage"));
  this.advanced.push(new s(t, f("ui.stats.damagesBonusPercent"), "damagesBonusPercent", "iconDamagePercent"));
  this.advanced.push(new s(t, f("ui.stats.criticalDamageBonus"), "criticalDamageBonus", "iconCriticalDamage"));
  this.advanced.push(new s(t, f("ui.stats.neutralDamageBonus"), "neutralDamageBonus", "iconYinyang"));
  this.advanced.push(new s(t, f("ui.stats.earthDamageBonus"), "earthDamageBonus", "iconStrength"));
  this.advanced.push(new s(t, f("ui.stats.fireDamageBonus"), "fireDamageBonus", "iconIntelligence"));
  this.advanced.push(new s(t, f("ui.stats.waterDamageBonus"), "waterDamageBonus", "iconChance"));
  this.advanced.push(new s(t, f("ui.stats.airDamageBonus"), "airDamageBonus", "iconAgility"));
  this.advanced.push(new s(t, f("ui.stats.weaponDamagesPercent"), "weaponDamagesBonusPercent", "iconWeaponDamage"));
  this.advanced.push(new s(t, f("ui.stats.pushDamageBonus"), "pushDamageBonus", "iconPushDamage"));
  var r = t.createChild("tr");
  r.createChild("td", {
    className: "tableTitle",
    text: f("ui.common.resistances"),
    attr: {
      colspan: 4
    }
  });
  this.advanced.push(new s(t, f("ui.stats.neutralReduction"), "neutralElementReduction", "iconYinyang"));
  this.advanced.push(new s(t, f("ui.stats.neutralReductionPercent"), "neutralElementResistPercent", "iconYinyang"));
  this.advanced.push(new s(t, f("ui.stats.earthReduction"), "earthElementReduction", "iconStrength"));
  this.advanced.push(new s(t, f("ui.stats.earthReductionPercent"), "earthElementResistPercent", "iconStrength"));
  this.advanced.push(new s(t, f("ui.stats.fireReduction"), "fireElementReduction", "iconIntelligence"));
  this.advanced.push(new s(t, f("ui.stats.fireReductionPercent"), "fireElementResistPercent", "iconIntelligence"));
  this.advanced.push(new s(t, f("ui.stats.waterReduction"), "waterElementReduction", "iconChance"));
  this.advanced.push(new s(t, f("ui.stats.waterReductionPercent"), "waterElementResistPercent", "iconChance"));
  this.advanced.push(new s(t, f("ui.stats.airReduction"), "airElementReduction", "iconAgility"));
  this.advanced.push(new s(t, f("ui.stats.airReductionPercent"), "airElementResistPercent", "iconAgility"));
  this.advanced.push(new s(t, f("ui.stats.criticalDamageReduction"), "criticalDamageReduction", "iconCriticalReduction"));
  this.advanced.push(new s(t, f("ui.stats.pushDamageReduction"), "pushDamageReduction", "iconPushDamageReduction"));
  this.tabs.addTab(f("ui.stats.advanced"), e);
};
n.prototype._createDom = function () {
  this._initialized || (this.infos = this.windowBody.createChild("div", {
    className: "infos"
  }), this.logoWrapper = this.infos.createChild("div", {
    className: "logoWrapper"
  }), this.logo = this.logoWrapper.appendChild(new b({
    className: "logo"
  }, function () {
    _.open("grimoire", {
      tabId: "alignment"
    });
  })), this.playerName = this.infos.createChild("div", {
    className: "playerName"
  }), this.infosSup = this.infos.createChild("div", {
    className: "infosSup"
  }), this.statsDom = this.windowBody.createChild("div", {
    className: "stats"
  }), this.tabs = new p(), this.statsDom.appendChild(this.tabs), this.panels = this.statsDom.createChild("div", {
    className: "panels"
  }), this._createSummaryPanel(), this._createAdvancedPanel(), this.tabs.openTab(0), this._initialized = !0);
};
n.prototype.updateStats = function (e) {
  if (this._initialized) {
    this.stats = e;
    this.energy.update(e.energyPoints, e.maxEnergyPoints);
    this.experience.update(e.experience - e.experienceLevelFloor, e.experienceNextLevelFloor - e.experienceLevelFloor);
    this.lifePoints.update(e.lifePoints + " / " + e.maxLifePoints);
    this.actionPoints.update(e.actionPoints.getTotalStat());
    this.movementPoints.update(e.movementPoints.getTotalStat());
    this.summary.forEach(function (t) {
      t.update(e);
    });
    var t = e.initiative.getTotalStat(),
      i = Math.floor(t * e.lifePoints / e.maxLifePoints);
    this.initiative.update(i + " / " + t);
    this.prospecting.update(e.prospecting.getTotalStat());
    this.range.update(e.range.getTotalStat());
    this.summonableCreatures.update(e.summonableCreaturesBoost.getTotalStat());
    var n = e.getRemainingAdditionalPts();
    this.capitalValueDom.setText(e.statsPoints + n);
    this.pointCapital.toggleClassName("haveAdditionalPts", n > 0);
    this.additionalPtsLineHelp.toggleDisplay(n > 0);
    this.refreshRefundedPts();
    this.advanced.forEach(function (t) {
      t.update(e);
    });
  }
};
n.prototype.refreshRefundedPts = function () {
  if (this._initialized) {
    var e = 0;
    this.summary.forEach(function (t) {
      t.resetCheckbox.isActivate() && (e += t.getRefundedPts());
    });
    this.refundedCapitalValueDom.setText(e);
  }
};
n.prototype.alignWithEquipment = function () {
  var e = _.getWindow("equipment");
  e.openState && (this.setStyles({
    top: e.getStyle("top"),
    height: e.getStyle("height")
  }), _.arrangeOpeningWindow(this.id, {
    leftOf: e.id
  }));
};
o.prototype.update = function (e, t) {
  this.current = e;
  this.max = t;
  this.progressBar.setValue(e / t);
};
a.prototype.update = function (e) {
  this.statLine.setText(l(e));
};
s.prototype.update = function (e) {
  var t = e[this.key];
  this.baseLine.setText(l(t.getBasePts()));
  this.bonusLine.setText(l(t.getBonusPts() + t.getEquipmentPts()));
  this.totalLine.setText(l(t.getTotalStat()));
};
r.prototype.update = function (e) {
  this.stats = e;
  var t = e[this.key],
    i = this.getRefundedPts();
  this.valueDom.setText(l(t.getTotalStat()));
  this.refundedValueText.setText(l(i));
};
r.prototype.getRefundedPts = function () {
  return this.stats && this.stats[this.key] ? c(this.key, this.stats[this.key].getBaseWithoutAdditionalPts()) : 0;
};
r.prototype.displayRefundedPts = function (e) {
  e ? (this.refundedValueDom.show(), this.upgradeButton.hide(), this.resetCheckbox.toggleDisplay(this.getRefundedPts() > 0), this.labelDom.rootElement.setAttribute("colspan", 1)) : (this.refundedValueDom.hide(), this.upgradeButton.show(), this.resetCheckbox.hide(), this.labelDom.rootElement.setAttribute("colspan", 2));
  this.resetCheckbox.isVisible() && this.resetCheckbox.activate();
};
this.on("open", this.alignWithEquipment);
i.on("characteristicsUpdated", function (i) {
  t.characterBreed && e.updateStats(i);
});
t.alignment.on("alignmentChanged", function () {
  var i = t.characterBaseInformations,
    n = t.alignment;
  n.getAlignmentImageUrl(function (t) {
    e.logo.setStyle("backgroundImage", t);
  });
  e.playerName.setText(i.name);
  t.characterBreed && e.infosSup.setText(t.characterBreed.shortNameId + ", " + f("ui.common.level") + " " + i.level);
  v.addTooltip(e.infosSup, d.level, {
    longTapExplanation: !0
  });
});
window.gui.scenarioManager.on("stepChanged", function () {
  var t = n.isBehaviourEnabled(C.CHARACT_MENU),
    i = n.isBehaviourEnabled(C.ADD_CHARACT),
    o = n.isBehaviourEnabled(C.DISABLE_UPGRADE_CHARACT_HIGHLIGHT);
  e.toggleClassName("disabledBehaviour", !t);
  e.toggleClassName("disabledAddStats", !i);
  e.toggleClassName("highlightedButtons", !o);
});
n.getAlignmentImageUrl(function (t) {
  e.logo.setStyle("backgroundImage", t);
});
e.playerName.setText(i.name);
t.characterBreed && e.infosSup.setText(t.characterBreed.shortNameId + ", " + f("ui.common.level") + " " + i.level);
v.addTooltip(e.infosSup, d.level, {
  longTapExplanation: !0
});
e.toggleClassName("disabledBehaviour", !t);
e.toggleClassName("disabledAddStats", !i);
e.toggleClassName("highlightedButtons", !o);
g.show();
p.show();
M.hide();
w.hide();
n.capitalValueDom.show();
n.refundedCapitalValueDom.hide();
m.delClassNames("arrowDown");
n.summary.forEach(function (e) {
  e.displayRefundedPts(!1);
});
g.hide();
p.hide();
M.show();
w.show();
n.capitalValueDom.hide();
n.refundedCapitalValueDom.show();
m.setClassNames("arrowDown");
n.summary.forEach(function (e) {
  e.displayRefundedPts(!0);
});
this.energy = new o(s, f("ui.common.energy"), "red");
this.experience = new o(s, f("ui.common.experiment"), "blue");
this.lifePoints = new a(l, f("ui.stats.lifePoints"), "maxLifePoints", "iconLifePoints");
this.actionPoints = new a(l, f("ui.stats.shortAP"), "actionPoints", "iconActionPoints");
this.movementPoints = new a(l, f("ui.stats.shortMP"), "movementPoints", "iconMovementPoints");
this.initiative = new a(l, f("ui.stats.initiative"), "initiative", "iconInitiative");
this.prospecting = new a(l, f("ui.stats.prospecting"), "prospecting", "iconProspecting");
this.range = new a(l, f("ui.stats.range"), "range", "iconRange");
this.summonableCreatures = new a(l, f("ui.stats.summonableCreatures"), "summonableCreaturesBoost", "iconSummon");
u.createChild("td", {
  className: "tableTitle",
  text: f("ui.common.caracteristics"),
  attr: {
    colspan: 4
  }
});
this.summary = [];
this.summary.push(new r(c, f("ui.stats.vitality"), "vitality", "iconVitality"));
this.summary.push(new r(c, f("ui.stats.wisdom"), "wisdom", "iconWisdom"));
this.summary.push(new r(c, f("ui.stats.strength"), "strength", "iconStrength"));
this.summary.push(new r(c, f("ui.stats.intelligence"), "intelligence", "iconIntelligence"));
this.summary.push(new r(c, f("ui.stats.chance"), "chance", "iconChance"));
this.summary.push(new r(c, f("ui.stats.agility"), "agility", "iconAgility"));
this.pointCapital = s.createChild("div", {
  className: "pointCapital"
});
this.capitalValueDom = m.createChild("div", {
  className: "pointCapitalValue"
});
this.refundedCapitalValueDom = m.createChild("div", {
  className: "pointCapitalValue"
});
e();
g.on("tap", function () {
  i() && t();
});
w.on("tap", function () {
  e();
});
M.on("tap", function () {
  return i() ? void window.gui.openConfirmPopup({
    title: f("ui.common.confirm"),
    message: f("ui.stats.resetAllStats"),
    cb: function (t) {
      if (t) {
        e();
        var i = [];
        n.summary.forEach(function (e) {
          e.resetCheckbox.isActivate() && i.push(A[e.key]);
        });
        window.dofus.sendMessage("StatsResetRequestMessage", {
          statIds: i
        });
      }
    }
  }) : void e();
});
n.summary.forEach(function (e) {
  e.resetCheckbox.on("change", function () {
    n.refreshRefundedPts();
  });
});
v.addTooltip(m, function () {
  var e = "";
  if (n.stats) {
    e = f("ui.stats.statPoints") + " " + String(n.stats.statsPoints);
    var t = n.stats.getRemainingAdditionalPts();
    t > 0 && (e += " + " + String(t));
    e += "\n\n" + d.characteristics;
  }
  return new y("div", {
    text: e
  });
}, {
  longTapExplanation: !0
});
this.additionalPtsLineHelp = s.createChild("div");
n.summary.forEach(function (e) {
  e.resetCheckbox.isActivate() && i.push(A[e.key]);
});
window.dofus.sendMessage("StatsResetRequestMessage", {
  statIds: i
});
t > 0 && (e += " + " + String(t));
e += "\n\n" + d.characteristics;
C.setHtml(f("tablet.characteristics.help"));
this.tabs.addTab(f("ui.stats.summary"), s);
i.createChild("td", {
  className: "label",
  text: f("ui.common.caracteristics")
});
i.createChild("td", {
  className: "base",
  text: f("ui.common.base")
});
i.createChild("td", {
  className: "bonus",
  text: f("ui.fightend.bonus")
});
i.createChild("td", {
  className: "total",
  text: f("ui.common.total")
});
this.advanced = [];
n.createChild("td", {
  className: "tableTitle",
  text: f("ui.charaSheet.primaryStats"),
  attr: {
    colspan: 4
  }
});
this.advanced.push(new s(t, f("ui.stats.vitality"), "vitality", "iconVitality"));
this.advanced.push(new s(t, f("ui.stats.wisdom"), "wisdom", "iconWisdom"));
this.advanced.push(new s(t, f("ui.stats.strength"), "strength", "iconStrength"));
this.advanced.push(new s(t, f("ui.stats.intelligence"), "intelligence", "iconIntelligence"));
this.advanced.push(new s(t, f("ui.stats.chance"), "chance", "iconChance"));
this.advanced.push(new s(t, f("ui.stats.agility"), "agility", "iconAgility"));
this.advanced.push(new s(t, f("ui.stats.shortAP"), "actionPoints", "iconActionPoints"));
this.advanced.push(new s(t, f("ui.stats.shortMP"), "movementPoints", "iconMovementPoints"));
this.advanced.push(new s(t, f("ui.stats.initiative"), "initiative", "iconInitiative"));
this.advanced.push(new s(t, f("ui.stats.prospecting"), "prospecting", "iconProspecting"));
this.advanced.push(new s(t, f("ui.stats.range"), "range", "iconRange"));
this.advanced.push(new s(t, f("ui.stats.summonableCreatures"), "summonableCreaturesBoost", "iconSummon"));
o.createChild("td", {
  className: "tableTitle",
  text: f("ui.charaSheet.secondaryStats"),
  attr: {
    colspan: 4
  }
});
this.advanced.push(new s(t, f("ui.stats.PAAttack"), "PAAttack", "iconAttackAP"));
this.advanced.push(new s(t, f("ui.stats.dodgeAP"), "dodgePALostProbability", "iconDodgeAP"));
this.advanced.push(new s(t, f("ui.stats.PMAttack"), "PMAttack", "iconAttackMP"));
this.advanced.push(new s(t, f("ui.stats.dodgeMP"), "dodgePMLostProbability", "iconDodgeMP"));
this.advanced.push(new s(t, f("ui.stats.criticalHit"), "criticalHit", "iconCriticalHit"));
this.advanced.push(new s(t, f("ui.stats.healBonus"), "healBonus", "iconHeal"));
this.advanced.push(new s(t, f("ui.stats.takleBlock"), "tackleBlock", "iconTackle"));
this.advanced.push(new s(t, f("ui.stats.takleEvade"), "tackleEvade", "iconEvade"));
a.createChild("td", {
  className: "tableTitle",
  text: f("ui.stats.damagesBonus"),
  attr: {
    colspan: 4
  }
});
this.advanced.push(new s(t, f("ui.stats.damagesBonus"), "allDamagesBonus", "iconDamage"));
this.advanced.push(new s(t, f("ui.stats.damagesBonusPercent"), "damagesBonusPercent", "iconDamagePercent"));
this.advanced.push(new s(t, f("ui.stats.criticalDamageBonus"), "criticalDamageBonus", "iconCriticalDamage"));
this.advanced.push(new s(t, f("ui.stats.neutralDamageBonus"), "neutralDamageBonus", "iconYinyang"));
this.advanced.push(new s(t, f("ui.stats.earthDamageBonus"), "earthDamageBonus", "iconStrength"));
this.advanced.push(new s(t, f("ui.stats.fireDamageBonus"), "fireDamageBonus", "iconIntelligence"));
this.advanced.push(new s(t, f("ui.stats.waterDamageBonus"), "waterDamageBonus", "iconChance"));
this.advanced.push(new s(t, f("ui.stats.airDamageBonus"), "airDamageBonus", "iconAgility"));
this.advanced.push(new s(t, f("ui.stats.weaponDamagesPercent"), "weaponDamagesBonusPercent", "iconWeaponDamage"));
this.advanced.push(new s(t, f("ui.stats.pushDamageBonus"), "pushDamageBonus", "iconPushDamage"));
r.createChild("td", {
  className: "tableTitle",
  text: f("ui.common.resistances"),
  attr: {
    colspan: 4
  }
});
this.advanced.push(new s(t, f("ui.stats.neutralReduction"), "neutralElementReduction", "iconYinyang"));
this.advanced.push(new s(t, f("ui.stats.neutralReductionPercent"), "neutralElementResistPercent", "iconYinyang"));
this.advanced.push(new s(t, f("ui.stats.earthReduction"), "earthElementReduction", "iconStrength"));
this.advanced.push(new s(t, f("ui.stats.earthReductionPercent"), "earthElementResistPercent", "iconStrength"));
this.advanced.push(new s(t, f("ui.stats.fireReduction"), "fireElementReduction", "iconIntelligence"));
this.advanced.push(new s(t, f("ui.stats.fireReductionPercent"), "fireElementResistPercent", "iconIntelligence"));
this.advanced.push(new s(t, f("ui.stats.waterReduction"), "waterElementReduction", "iconChance"));
this.advanced.push(new s(t, f("ui.stats.waterReductionPercent"), "waterElementResistPercent", "iconChance"));
this.advanced.push(new s(t, f("ui.stats.airReduction"), "airElementReduction", "iconAgility"));
this.advanced.push(new s(t, f("ui.stats.airReductionPercent"), "airElementResistPercent", "iconAgility"));
this.advanced.push(new s(t, f("ui.stats.criticalDamageReduction"), "criticalDamageReduction", "iconCriticalReduction"));
this.advanced.push(new s(t, f("ui.stats.pushDamageReduction"), "pushDamageReduction", "iconPushDamageReduction"));
this.tabs.addTab(f("ui.stats.advanced"), e);
this.stats = e;
this.energy.update(e.energyPoints, e.maxEnergyPoints);
this.experience.update(e.experience - e.experienceLevelFloor, e.experienceNextLevelFloor - e.experienceLevelFloor);
this.lifePoints.update(e.lifePoints + " / " + e.maxLifePoints);
this.actionPoints.update(e.actionPoints.getTotalStat());
this.movementPoints.update(e.movementPoints.getTotalStat());
this.summary.forEach(function (t) {
  t.update(e);
});
this.initiative.update(i + " / " + t);
this.prospecting.update(e.prospecting.getTotalStat());
this.range.update(e.range.getTotalStat());
this.summonableCreatures.update(e.summonableCreaturesBoost.getTotalStat());
this.capitalValueDom.setText(e.statsPoints + n);
this.pointCapital.toggleClassName("haveAdditionalPts", n > 0);
this.additionalPtsLineHelp.toggleDisplay(n > 0);
this.refreshRefundedPts();
this.advanced.forEach(function (t) {
  t.update(e);
});
this.summary.forEach(function (t) {
  t.resetCheckbox.isActivate() && (e += t.getRefundedPts());
});
this.refundedCapitalValueDom.setText(e);
this.current = e;
this.max = t;
this.progressBar.setValue(e / t);
this.baseLine.setText(l(t.getBasePts()));
this.bonusLine.setText(l(t.getBonusPts() + t.getEquipmentPts()));
this.totalLine.setText(l(t.getTotalStat()));
this.valueDom.setText(l(t.getTotalStat()));
this.refundedValueText.setText(l(i));
e ? (this.refundedValueDom.show(), this.upgradeButton.hide(), this.resetCheckbox.toggleDisplay(this.getRefundedPts() > 0), this.labelDom.rootElement.setAttribute("colspan", 1)) : (this.refundedValueDom.hide(), this.upgradeButton.show(), this.resetCheckbox.hide(), this.labelDom.rootElement.setAttribute("colspan", 2));
this.resetCheckbox.isVisible() && this.resetCheckbox.activate();
o.setText(t.name);
r.setText(d("ui.common.level") + " " + t.level);
y.selectedCharacter = t;
y.characterDisplay.setLook(t.entityLook, {
  boneType: "characters/",
  skinType: "characters/"
});
y.xpSticker.setClassNames(["xpSticker", "x" + t.bonusXp]);
e.reason === _.DEL_ERR_TOO_MANY_CHAR_DELETION ? t = "TooManyDeletion" : e.reason === _.DEL_ERR_BAD_SECRET_ANSWER ? t = "WrongAnswer" : e.reason === _.DEL_ERR_RESTRICED_ZONE && (t = "UnsecureMode");
T.openSimplePopup(i[t]);
c.close(y.id);
f.goBackToSelectionOf("server");
this.btnCreate = I.appendChild(new h({
  text: d("ui.charsel.createCharacter"),
  className: ["newCharacterBtn", "button"],
  sound: "OK_BUTTON"
}, function () {
  c.close("deleteCharacterConfirm");
  c.close(y.id);
  c.open("characterCreation");
}));
I.createChild("div", {
  className: "xpBubble"
});
c.close("deleteCharacterConfirm");
c.close(y.id);
c.open("characterCreation");
o = N.createChild("div", {
  className: "name"
});
this.btnDelete = N.appendChild(new h({
  className: "delCharacterBtn",
  text: "X"
}, t));
p(O, {
  repeatDelay: 100
});
O.on("tap", function () {
  L.rotateCharacter(!1);
});
p(R, {
  repeatDelay: 100
});
R.on("tap", function () {
  L.rotateCharacter(!0);
});
this.xpSticker = L.createChild("div", {
  className: "xpSticker"
});
a(this.xpSticker, d("ui.information.xpFamilyBonus"));
this.disable();
y.btnCreate.disable();
A.disable();
s.selectCharacter(y.selectedCharacter.id);
this.closeButton.on("tap", function () {
  n();
});
this._consoleButton = M.appendChild(new h({
  className: ["consoleButton"],
  hidden: !0
}, function () {
  c["switch"]("adminConsole");
}));
this.on("open", function (e) {
  return e = e.length ? e : null, y._consoleButton.toggleDisplay(window.gui.playerData.hasRight(v.SHOW_ADMIN_CONSOLE_BUTTON)), this.charactersList = e || this.charactersList, this.charactersList ? (y.updateCharacterList(this.charactersList), D.enable(), y.btnCreate.enable(), void A.enable()) : console.error("CharacterSelectionWindow opened without character list info");
});
this.on("close", function () {
  c.close("deleteCharacterConfirm");
  L.release();
});
T.on("CharacterDeletionErrorMessage", this.localizeEvent(i));
c.close("deleteCharacterConfirm");
L.release();
e[i].bonusXp = o;
e[i].level > 1 && t++;
r(n, l);
e.exports = n;
n.prototype.backButtonClose = function () {
  this.close();
  f.goBackToSelectionOf("server");
};
n.prototype.updateCharacterList = function (e) {
  var t = o(e);
  this.leftColumn.setClassNames(["leftColumn", "x" + t + "Bubble"]);
  this.charactersTable.clearContent();
  var i = this.charactersTable.header.getChildren()[0].getChild("name");
  i.setHtml(d("ui.connection.listCharacterLabel", e.length));
  for (var n = window.gui.databases.Breeds, a = 0; a < e.length; a++) {
    var s = e[a],
      r = s.breed || 0,
      l = s.name + " (" + n[r].shortNameId + " " + s.level + ")",
      c = this.charactersTable.addRow({
        name: l
      }, {
        data: s
      }),
      u = s.bonusXp;
    u > 1 && c.getChildren()[1].addClassNames(["x" + u]);
  }
};
this.close();
f.goBackToSelectionOf("server");
this.leftColumn.setClassNames(["leftColumn", "x" + t + "Bubble"]);
this.charactersTable.clearContent();
r[l >>> 5] |= 128 << l % 32;
r[(l + 64 >>> 9 << 4) + 14] = l;
c = m(c, d, u, h, r[p + 0], 7, -680876936);
h = m(h, c, d, u, r[p + 1], 12, -389564586);
u = m(u, h, c, d, r[p + 2], 17, 606105819);
d = m(d, u, h, c, r[p + 3], 22, -1044525330);
c = m(c, d, u, h, r[p + 4], 7, -176418897);
h = m(h, c, d, u, r[p + 5], 12, 1200080426);
u = m(u, h, c, d, r[p + 6], 17, -1473231341);
d = m(d, u, h, c, r[p + 7], 22, -45705983);
c = m(c, d, u, h, r[p + 8], 7, 1770035416);
h = m(h, c, d, u, r[p + 9], 12, -1958414417);
u = m(u, h, c, d, r[p + 10], 17, -42063);
d = m(d, u, h, c, r[p + 11], 22, -1990404162);
c = m(c, d, u, h, r[p + 12], 7, 1804603682);
h = m(h, c, d, u, r[p + 13], 12, -40341101);
u = m(u, h, c, d, r[p + 14], 17, -1502002290);
d = m(d, u, h, c, r[p + 15], 22, 1236535329);
c = f(c, d, u, h, r[p + 1], 5, -165796510);
h = f(h, c, d, u, r[p + 6], 9, -1069501632);
u = f(u, h, c, d, r[p + 11], 14, 643717713);
d = f(d, u, h, c, r[p + 0], 20, -373897302);
c = f(c, d, u, h, r[p + 5], 5, -701558691);
h = f(h, c, d, u, r[p + 10], 9, 38016083);
u = f(u, h, c, d, r[p + 15], 14, -660478335);
d = f(d, u, h, c, r[p + 4], 20, -405537848);
c = f(c, d, u, h, r[p + 9], 5, 568446438);
h = f(h, c, d, u, r[p + 14], 9, -1019803690);
u = f(u, h, c, d, r[p + 3], 14, -187363961);
d = f(d, u, h, c, r[p + 8], 20, 1163531501);
c = f(c, d, u, h, r[p + 13], 5, -1444681467);
h = f(h, c, d, u, r[p + 2], 9, -51403784);
u = f(u, h, c, d, r[p + 7], 14, 1735328473);
d = f(d, u, h, c, r[p + 12], 20, -1926607734);
c = g(c, d, u, h, r[p + 5], 4, -378558);
h = g(h, c, d, u, r[p + 8], 11, -2022574463);
u = g(u, h, c, d, r[p + 11], 16, 1839030562);
d = g(d, u, h, c, r[p + 14], 23, -35309556);
c = g(c, d, u, h, r[p + 1], 4, -1530992060);
h = g(h, c, d, u, r[p + 4], 11, 1272893353);
u = g(u, h, c, d, r[p + 7], 16, -155497632);
d = g(d, u, h, c, r[p + 10], 23, -1094730640);
c = g(c, d, u, h, r[p + 13], 4, 681279174);
h = g(h, c, d, u, r[p + 0], 11, -358537222);
u = g(u, h, c, d, r[p + 3], 16, -722521979);
d = g(d, u, h, c, r[p + 6], 23, 76029189);
c = g(c, d, u, h, r[p + 9], 4, -640364487);
h = g(h, c, d, u, r[p + 12], 11, -421815835);
u = g(u, h, c, d, r[p + 15], 16, 530742520);
d = g(d, u, h, c, r[p + 2], 23, -995338651);
c = _(c, d, u, h, r[p + 0], 6, -198630844);
h = _(h, c, d, u, r[p + 7], 10, 1126891415);
u = _(u, h, c, d, r[p + 14], 15, -1416354905);
d = _(d, u, h, c, r[p + 5], 21, -57434055);
c = _(c, d, u, h, r[p + 12], 6, 1700485571);
h = _(h, c, d, u, r[p + 3], 10, -1894986606);
u = _(u, h, c, d, r[p + 10], 15, -1051523);
d = _(d, u, h, c, r[p + 1], 21, -2054922799);
c = _(c, d, u, h, r[p + 8], 6, 1873313359);
h = _(h, c, d, u, r[p + 15], 10, -30611744);
u = _(u, h, c, d, r[p + 6], 15, -1560198380);
d = _(d, u, h, c, r[p + 13], 21, 1309151649);
c = _(c, d, u, h, r[p + 4], 6, -145523070);
h = _(h, c, d, u, r[p + 11], 10, -1120210379);
u = _(u, h, c, d, r[p + 2], 15, 718787259);
d = _(d, u, h, c, r[p + 9], 21, -343485551);
c = c + v >>> 0;
d = d + y >>> 0;
u = u + w >>> 0;
h = h + b >>> 0;
s._ff = function (e, t, i, n, o, a, s) {
  var r = e + (t & i | ~t & n) + (o >>> 0) + s;
  return (r << a | r >>> 32 - a) + t;
};
s._gg = function (e, t, i, n, o, a, s) {
  var r = e + (t & n | i & ~n) + (o >>> 0) + s;
  return (r << a | r >>> 32 - a) + t;
};
s._hh = function (e, t, i, n, o, a, s) {
  var r = e + (t ^ i ^ n) + (o >>> 0) + s;
  return (r << a | r >>> 32 - a) + t;
};
s._ii = function (e, t, i, n, o, a, s) {
  var r = e + (i ^ (t | ~n)) + (o >>> 0) + s;
  return (r << a | r >>> 32 - a) + t;
};
s._blocksize = 16;
s._digestsize = 16;
e.exports = function (e, i) {
  if ("undefined" != typeof e) {
    var n = t.wordsToBytes(s(e, i));
    return i && i.asBytes ? n : i && i.asString ? a.bytesToString(n) : t.bytesToHex(n);
  }
};
t.push((e[i] >>> 4).toString(16));
t.push((15 & e[i]).toString(16));
P = {};
P.schema = [];
B = 0;
z = [];
e.latestPos = {
  x: e.x,
  y: e.y
};
e.x += t;
e.y += i;
a > 1 ? a = 1 : a < 0 && (a = 0);
D.save();
D.strokeStyle = o ? o : "black";
D.globalAlpha = 1;
D.lineWidth = 2;
D.beginPath();
D.moveTo(e.latestPos.x, e.latestPos.y);
D.lineTo(e.x, e.y);
D.stroke();
D.restore();
a = e - n.x;
s = i - n.y;
U = e.x - O.boundings.left - 10;
q = e.y - O.boundings.top - 10;
D.clearRect(0, 0, x.width, x.height);
D.drawImage(e, 0, 0);
r = 2 * Math.PI * Math.random();
d = h * h * Math.PI / w | 0;
d < 1 && (d = 1);
i = h * Math.random();
n = .5 * i;
o = 2 * Math.PI * Math.random();
a = i * Math.sin(o);
s = n * Math.cos(o);
l = Math.cos(r);
c = Math.sin(r);
z.push({
  x: e + a * l - s * c,
  y: t + a * c + s * l
});
i = i || !1;
e();
D.clearRect(0, 0, x.width, x.height);
H = !0;
n.schema.forEach(function (e) {
  var t = i ? "rgb(" + a[l] + "," + s[l] + "," + r[l] + ")" : "black";
  setTimeout(function () {
    M(e.points[0].x, e.points[0].y);
    for (var i = 1; i < e.points.length; i++) {
      b(e.points[i].x, e.points[i].y, e.points[i - 1], 60 * i, t);
    }
  }, o);
  o += 100 + 60 * e.points.length;
  l = (l + 1) % a.length;
});
setTimeout(function () {
  H = !1;
}, o);
setTimeout(function () {
  M(e.points[0].x, e.points[0].y);
  for (var i = 1; i < e.points.length; i++) {
    b(e.points[i].x, e.points[i].y, e.points[i - 1], 60 * i, t);
  }
}, o);
o += 100 + 60 * e.points.length;
l = (l + 1) % a.length;
x.delClassNames(["success", "fail"]);
e && setTimeout(function () {
  s.close(O.id);
}, 500);
setTimeout(function () {
  D.globalAlpha -= .01;
  o(e);
}, t);
t += 20;
D.globalAlpha -= .01;
o(e);
setTimeout(function () {
  D.globalAlpha -= .01;
  o(e);
}, t);
t += 10;
D.globalAlpha -= .01;
o(e);
setTimeout(function () {
  D.globalAlpha -= .01;
  o(e);
}, t);
t += 5;
D.globalAlpha -= .01;
o(e);
D.clearRect(0, 0, x.width, x.height);
D.globalAlpha = 1;
H = !1;
C(F);
o.src = n;
H = !0;
o.onload = function () {
  I(o);
};
k = !1;
C(F);
F ? window.dofus.sendMessage("InteractiveUseRequestMessage", v) : m(c) || window.gui.chat.logMsg(y("ui.chat.calligraphyWronglyDrawn"));
_.log("User_Life_Cycle.calligraphy_try", {
  start_time_tentative: t.startTimestamp,
  end_time_tentative: new g.DofusDate(g.now()).getServerDate().timestamp,
  step_cond_1_panji_context_ok: !m(c),
  step_cond_2_panji_nb_line_ok: p,
  step_cond_3_panji_model_ok: F,
  time_spent_in_interface: g.now() - R,
  panji_id: a
});
e();
n.min.x = e < n.min.x ? e : n.min.x;
n.min.y = t < n.min.y ? t : n.min.y;
n.max.x = e > n.max.x ? e : n.max.x;
n.max.y = t > n.max.y ? t : n.max.y;
i.min.x = e < i.min.x ? e : i.min.x;
i.min.y = t < i.min.y ? t : i.min.y;
i.max.x = e > i.max.x ? e : i.max.x;
i.max.y = t > i.max.y ? t : i.max.y;
this.btnEncyclo = N.appendChild(new l({
  className: "btnEncyclo"
}));
this.btnClose = N.appendChild(new l({
  className: "btnClose"
}));
this.btnClear = L.appendChild(new l({
  className: "btnClear"
}));
this.btnValidate = L.appendChild(new l({
  className: "btnValidate"
}));
D.strokeStyle = "black";
D.lineJoin = "round";
W.on("ClientUIOpenedByObjectMessage", function (e) {
  e.type === f.CLIENT_UI_CALLIGRAPHY && s.open(O.id);
});
this.once("open", function () {
  var e = v(E.rootElement),
    t = Math.min(.8 * e.width, .6 * this.position.width),
    i = Math.min(.67 * e.height, .5 * this.position.height);
  x.width = t;
  x.height = i;
  x.setStyles({
    width: t + "px",
    height: i + "px"
  });
  c(x);
});
this.on("open", function () {
  s.getOpenWindows().forEach(function (e) {
    if (e !== O.id) {
      var t = e.split(" > ", 1);
      s.close(t[0]);
    }
  });
  R = g.now();
  D.clearRect(0, 0, x.width, x.height);
  x.delClassNames(["success", "fail"]);
  e();
  k = !1;
  F = !1;
  H = !1;
});
x.width = t;
x.height = i;
x.setStyles({
  width: t + "px",
  height: i + "px"
});
c(x);
s.getOpenWindows().forEach(function (e) {
  if (e !== O.id) {
    var t = e.split(" > ", 1);
    s.close(t[0]);
  }
});
R = g.now();
D.clearRect(0, 0, x.width, x.height);
x.delClassNames(["success", "fail"]);
e();
k = !1;
F = !1;
H = !1;
x.on("tapstart", function (e) {
  H || (D.lineWidth = 12, O.boundings = v(x.rootElement), n(e), G = !0, M(U, q), P.startTimestamp = new g.DofusDate(g.now()).getServerDate().timestamp, P.schema[B] = {}, P.schema[B].points = [], P.schema[B].points.push({
    x: U,
    y: q
  }), P.schema[B].min = {
    x: U,
    y: q
  }, P.schema[B].max = {
    x: U,
    y: q
  }, 0 === B ? (x.delClassNames(["success", "fail"]), D.clearRect(0, 0, x.width, x.height), P.min = {
    x: U,
    y: q
  }, P.max = {
    x: U,
    y: q
  }) : (P.min.x = U < P.min.x ? U : P.min.x, P.min.y = q < P.min.y ? q : P.min.y, P.max.x = U > P.max.x ? U : P.max.x, P.max.y = q > P.max.y ? q : P.max.y));
});
x.on("tapmove", function (e) {
  if (G) {
    Y.x = U;
    Y.y = q;
    n(e);
    i(U, q, Y);
    var t = P.schema[B],
      o = t.points.length,
      a = {
        x: o > 1 ? t.points[o - 2].x : 0,
        y: o > 1 ? t.points[o - 2].y : 0
      },
      s = {
        x: t.points[o - 1].x,
        y: t.points[o - 1].y
      },
      r = 20,
      l = (a.x - U) * (s.y - a.y) / (s.x - a.x) + a.y - q === 0,
      c = Math.sqrt(Math.pow(U - s.x, 2) + Math.pow(q - s.y, 2));
    1 === t.points.length ? (t.points.push({
      x: U,
      y: q
    }), S(U, q, P, t)) : !l && c > r && (t.points.push({
      x: U,
      y: q
    }), S(U, q, P, t));
  }
});
x.on("tapend", function (e) {
  if (G) {
    n(e);
    var t = P.schema[B];
    t.points.push({
      x: U,
      y: q
    });
    S(U, q, P, t);
    G = !1;
    B++;
  }
});
this.btnClear.on("tap", function () {
  H || (x.delClassNames(["success", "fail"]), e(), D.clearRect(0, 0, x.width, x.height));
});
this.btnValidate.on("tap", function () {
  var e = window.isoEngine.mapRenderer;
  if (!H && 0 !== B) {
    if (m(e.calligraphyElements) || !p[e.mapId]) {
      return window.gui.chat.logMsg(y("ui.chat.calligraphyNothingToDo")), A(P);
    }
    for (var t = p[e.mapId], i = !1, n = 0; n < t.length; n++) {
      if (e.calligraphyElements[t[n].element].enabledSkills.length > 0) {
        i = !0;
        break;
      }
    }
    return i ? void A(P, t) : (window.gui.chat.logMsg(y("ui.chat.calligraphyBadContext")), A(P));
  }
});
this.btnEncyclo.on("tap", function () {
  H || s.open("panjidexWindow", {
    drawModeleFunction: T
  });
});
this.btnClose.on("tap", function () {
  function e(e) {
    return "panjidexWindow" === e;
  }
  H || (s.getOpenWindows().some(e) && s.close("panjidexWindow"), D.clearRect(0, 0, x.width, x.height), s.close(O.id), r("CLOSE_DOCUMENT"));
});
Y.x = U;
Y.y = q;
n(e);
i(U, q, Y);
t.points.push({
  x: U,
  y: q
});
S(U, q, P, t);
G = !1;
B++;
o(n, a);
e.exports = n;
n < i.min.x ? n = i.min.x : n > i.max.x && (n = i.max.x);
o < i.min.y ? o = i.min.y : o > i.max.y && (o = i.max.y);
(d >= n && n >= h || d <= n && n <= h) && 0 !== f && (r = (m * n + g) / -f, a.push({
  x: n,
  y: r
}));
(u >= o && o >= p || u <= o && o <= p) && 0 !== m && (s = (f * o + g) / -m, a.push({
  x: s,
  y: o
}));
e.min.x *= n;
e.min.y *= o;
e.max.x *= n;
e.max.y *= o;
e.points.forEach(function (e) {
  e.x *= n;
  e.y *= o;
});
e.x *= n;
e.y *= o;
i.max.x *= n;
i.max.y *= n;
i.schema.forEach(function (e) {
  e.min.x *= n;
  e.min.y *= n;
  e.max.x *= n;
  e.max.y *= n;
  e.points.forEach(function (e) {
    e.x *= n;
    e.y *= n;
  });
});
e.min.x *= n;
e.min.y *= n;
e.max.x *= n;
e.max.y *= n;
e.points.forEach(function (e) {
  e.x *= n;
  e.y *= n;
});
e.x *= n;
e.y *= n;
e.min.x += o;
e.max.x += o;
e.min.y += a;
e.max.y += a;
e.points.forEach(function (e) {
  e.x += o;
  e.y += a;
});
e.x += o;
e.y += a;
e.min.x -= i;
e.min.y -= n;
e.max.x -= i;
e.max.y -= n;
e.points.forEach(function (e) {
  e.x -= i;
  e.y -= n;
});
e.x -= i;
e.y -= n;
n = Math.sqrt(Math.pow(r.points[0].x - l.points[0].x, 2) + Math.pow(r.points[0].y - l.points[0].y, 2));
o = Math.sqrt(Math.pow(r.points[r.points.length - 1].x - l.points[l.points.length - 1].x, 2) + Math.pow(r.points[r.points.length - 1].y - l.points[l.points.length - 1].y, 2));
_ = m.points[0];
v = !0;
p = JSON.parse(JSON.stringify(m));
p.points.reverse();
t.rescale = s;
t.adaptToCanvasSize = r;
t.sensorModification = c;
t.compareStrokes = u;
this._giftList = [];
this._giftListIndex = 0;
this._hasDom = !1;
this._itemSpace = null;
this._charactersSpace = null;
this._selectedCharaId = null;
this.on("open", function (t) {
  e._characterList = window.gui.gifts.getCharaListMinusDeadPeople();
  e._giftList = t || [];
  e._createDom();
  e._setupEvents();
  e._updateCharactersSpace();
  e._updateGift();
});
this.on("open", function () {
  window.foreground.lock("giftAttribution");
});
this.on("close", function () {
  window.foreground.unlock("giftAttribution");
  e._reset();
});
e._characterList = window.gui.gifts.getCharaListMinusDeadPeople();
e._giftList = t || [];
e._createDom();
e._setupEvents();
e._updateCharactersSpace();
e._updateGift();
window.foreground.unlock("giftAttribution");
e._reset();
o(n, a);
e.exports = n;
n.prototype._reset = function () {
  this._charactersSpace && this._charactersSpace.reset();
  this.windowBody.clearContent();
  this._hasDom = !1;
  this._giftListIndex = 0;
  this._giftList = [];
  this._itemSpace = null;
  this._charactersSpace = null;
  this._selectedCharaId = null;
};
n.prototype._setupEvents = function () {
  var e = this;
  window.gui.gifts.on("giftAssignRequestResult", function (t) {
    if (e.openState) {
      var i = e._giftList[e._giftListIndex];
      i && t.actionId === i.uid && (e._charactersSpace.setAssignLoading(!1), e._nextGift());
    }
  });
};
n.prototype._createDom = function () {
  var e = this;
  if (!this._hasDom) {
    var t = this.windowBody,
      i = t.createChild("div", {
        className: "left"
      });
    this._itemSpace = i.appendChild(new r());
    var n = t.createChild("div", {
      className: "right"
    });
    this._charactersSpace = n.appendChild(new l());
    this._charactersSpace.on("selectTile", function (t) {
      e._selectedCharaId = t;
    });
    var o = t.createChild("div", {
      className: "buttonSpace"
    });
    o.appendChild(new c(s("ui.connection.notNow"), {
      scaleOnPress: !0,
      className: "buttonSpaceButton"
    }, function () {
      e._nextGift();
    }));
    this._assignBtn = o.appendChild(new c(s("ui.connection.assignGift"), {
      scaleOnPress: !0,
      className: "buttonSpaceButton"
    }, function () {
      e._charactersSpace.setAssignLoading(!0);
      e._assignGift();
    }));
    this._hasDom = !0;
  }
};
n.prototype._nextGift = function () {
  var e = this,
    t = this._giftListIndex + 1 >= this._giftList.length;
  if (t) {
    return this.close();
  }
  this._giftListIndex += 1;
  var i = this.position.x,
    n = this.position.y;
  d.tween(this, {
    opacity: 0,
    webkitTransform: "translate3d(" + i + "px," + n + "px,0) scale(0.8)"
  }, {
    time: 150,
    delay: 0,
    easing: "ease-out"
  }, function () {
    d.tween(e, {
      opacity: 1,
      webkitTransform: "translate3d(" + i + "px," + n + "px,0)  scale(1)"
    }, {
      time: 150,
      delay: 0,
      easing: "ease-out"
    }, function () {
      e._updateGift();
    });
  });
};
n.prototype._assignGift = function () {
  if (this._selectedCharaId) {
    var e = this._giftList[this._giftListIndex];
    e && window.gui.gifts.assignGift(e.uid, this._selectedCharaId);
  }
};
n.prototype._updateGift = function () {
  var e = this._giftList[this._giftListIndex] || {};
  this._itemSpace.update(e);
};
n.prototype._updateCharactersSpace = function () {
  this._charactersSpace.update(this._characterList);
};
this._charactersSpace && this._charactersSpace.reset();
this.windowBody.clearContent();
this._hasDom = !1;
this._giftListIndex = 0;
this._giftList = [];
this._itemSpace = null;
this._charactersSpace = null;
this._selectedCharaId = null;
this._charactersSpace = n.appendChild(new l());
this._charactersSpace.on("selectTile", function (t) {
  e._selectedCharaId = t;
});
o.appendChild(new c(s("ui.connection.notNow"), {
  scaleOnPress: !0,
  className: "buttonSpaceButton"
}, function () {
  e._nextGift();
}));
this._assignBtn = o.appendChild(new c(s("ui.connection.assignGift"), {
  scaleOnPress: !0,
  className: "buttonSpaceButton"
}, function () {
  e._charactersSpace.setAssignLoading(!0);
  e._assignGift();
}));
this._hasDom = !0;
e._charactersSpace.setAssignLoading(!0);
e._assignGift();
this._title = i.createChild("div", {
  className: "title"
});
this._description = i.createChild("div", {
  className: "description"
});
i.createChild("div", {
  className: "contentText",
  text: l("ui.connection.contents")
});
this._rewardBoxes = i.appendChild(new r({
  nbRewards: 8
}));
this._itemBox = this.appendChild(new s({
  showTitle: !0
}));
this._rewardBoxes.on("tapSlot", function (t) {
  e._updateItemBox(t);
});
o(n, a);
e.exports = n;
n.prototype.update = function (e) {
  e = e || {};
  this._title.setText(e.title);
  var t = e.text;
  "null" === t.trim().toLowerCase() && (t = "");
  this._description.setText(t);
  var i = e.items || [],
    n = i[0];
  n ? this._updateItemBox(n) : this._itemBox.hide();
  this._rewardBoxes.reset();
  for (var o = 0, a = i.length; o < a; o += 1) {
    var s = i[o];
    this._rewardBoxes.addItemInstance(s);
  }
};
n.prototype._updateItemBox = function (e) {
  this._itemBox.displayItem(e);
  this._itemBox.show();
};
e = e || {};
this._title.setText(e.title);
"null" === t.trim().toLowerCase() && (t = "");
this._description.setText(t);
n ? this._updateItemBox(n) : this._itemBox.hide();
this._rewardBoxes.reset();
this._itemBox.displayItem(e);
this._itemBox.show();
P.call(this, "div", {
  className: "ItemBox"
});
this.itemInstance = null;
this.item = null;
this._mountData = null;
e = e || {};
this._parentWindow = e.parent;
this.showTitle = !!e.showTitle;
this.showItemActions = !!e.hasOwnProperty("showItemActions") && e.showItemActions;
this.showDescription = !!e.hasOwnProperty("showDescription") && e.showDescription;
this._name = i.createChild("div", {
  className: "itemBox-name"
});
this._level = i.createChild("div", {
  className: "itemBox-level"
});
this.weight = u.createChild("div", {
  className: "weight"
});
this.weight.toggleDisplay(!e.noWeight);
this.twoHandedIcon = u.createChild("div", {
  className: "twoHandedIcon"
});
f(this.twoHandedIcon, M("ui.common.twoHandsWeapon"));
this.image = h.createChild("div", {
  className: "itemImage"
});
this.durabilityBar = h.appendChild(new E({
  className: ["durabilityBar", "red"],
  tooltip: !0
}));
this.durabilityBarDescription = new P("div");
f(this.durabilityBar, this.durabilityBarDescription);
this.tooltipItemDescription = new T();
f(this.image, this.tooltipItemDescription);
F(this.image);
this.image.on("tap", function () {
  return t._mountData ? B.open("mount") : void (t.item && window.gui.openContextualMenuAround("item", this, {
    item: t.item.getItemInstance() || t.item.getItem(),
    location: t._parentWindow ? t._parentWindow.constructor.name : "",
    enableCertificate: !0
  }));
});
this.panelCollection = {};
this.topRightInfoContainer = d.createChild("div", {
  className: "topRightInfoContainer"
});
this.itemInfoTabs = new L();
this.itemInfoTabs.toggleDisplay(!e.noTabs);
this.topRightInfoContainer.appendChild(this.itemInfoTabs);
this.itemInfoPanels = this.topRightInfoContainer.createChild("div", {
  className: "itemInfoPanels"
});
this.panelCollection[v.name] = this.itemInfoPanels.appendChild(new x(m));
this.itemInfoTabs.addTab(v.title, this.panelCollection[v.name]);
w.myWindow = this;
w = this.bidHouseBtn = y.appendChild(new O({
  className: ["bidHouseActionButton", "greenButton"],
  addIcon: !0,
  tooltip: a
}, o));
w.myWindow = this;
w = this.bestiaryBtn = y.appendChild(new O({
  className: ["bestiaryButton", "greenButton"],
  addIcon: !0,
  tooltip: M("ui.common.bestiary")
}, s));
w.myWindow = this;
w = this.setButton = y.appendChild(new O({
  className: "setButton",
  tooltip: M("ui.common.set")
}, c));
w.myWindow = this;
w = this.recipeButton = C.appendChild(new O({
  className: "recipeButton",
  tooltip: M("ui.craft.associateReceipts")
}, r));
w.myWindow = this;
e.withBidHouseBtn && (w = this.image.appendChild(new O({
  className: ["bidHouseButton", "greenButton"],
  addIcon: !0,
  tooltip: a
}, o)), w.myWindow = this);
I.on("confirm", function (e) {
  window.gui.playerData.inventory.confirmDestroyItem(t.itemInstance, e);
});
w = this.destroyButton = y.appendChild(new O({
  className: "destroyButton",
  tooltip: M("ui.common.destroyThisItem")
}, l));
w.myWindow = this;
this.itemDescriptionContainer = this.appendChild(new D({
  className: "itemDescriptionContainer"
}));
this.categoryText = this.itemDescriptionContainer.content.createChild("div", {
  className: "category"
});
this.descriptionText = this.itemDescriptionContainer.content.createChild("div", {
  className: "description"
});
this.itemInfoTabs.openTab(0);
e.noListener || (this._listener = new b(), this._listener.listenTo(window.gui.playerData.inventory, "itemModified", function (e) {
  t.itemInstance && t.itemInstance.objectUID === e.objectUID && t.displayItem(e);
}));
this.on("destroy", function () {
  this._listener && this._listener.stopListening();
});
R.inherits(d, P);
d.prototype._toggleItemActions = function (e) {
  if (this.showItemActions && e) {
    this.itemActionContainer.show();
    this.bestiaryBtn.toggleDisplay(!!e.getProperty("dropMonsterIds").length);
    this.setButton.toggleDisplay(e.getProperty("itemSetId") !== -1);
    var t = !e.isItemInstance || !(e.isLinked() || e.isLinkedCharacter());
    this.bidHouseBtn.toggleDisplay(t);
    this.destroyButton.toggleDisplay(!!e.isItemInstance);
  } else {
    this.itemActionContainer.hide();
  }
};
d.prototype._canDisplayDescription = function () {
  return this.showDescription && ("auto" !== this.showDescription || this.itemDescriptionContainer.rootElement.clientHeight > 30);
};
d.prototype.displayMount = function (e, t) {
  if (e !== this._mountData) {
    t = t || {};
    this._mountData = e;
    this.item = null;
    this.itemInstance = null;
    this.showTitle = t.hasOwnProperty("showTitle") ? t.showTitle : this.showTitle;
    this.showDescription = t.hasOwnProperty("showDescription") ? t.showDescription : this.showDescription;
    this.weight.setText(M("ui.common.short.weight", 0));
    this.twoHandedIcon.hide();
    this.durabilityBar.hide();
    var i = this;
    if (g.preloadImage("gfx/mounts/" + e.model + ".png", function (t) {
      e === i._mountData && i.image.setStyle("backgroundImage", t);
    }), w(this.image, !1), this._toggleItemActions(null), this._canDisplayDescription()) {
      this.categoryText.setText(M("ui.common.category") + M("ui.common.colon") + M("ui.common.ride"));
      var n = M("ui.mount.description", e.name, e.level, e.xpRatio);
      this.descriptionText.setText(n);
      this.itemDescriptionContainer.show();
      this.itemDescriptionContainer.refresh();
    } else {
      this.itemDescriptionContainer.hide();
    }
    this._itemTitle.toggleDisplay(!!this.showTitle);
    this.showTitle && (N.getData("Mounts", e.model, function (t, n) {
      return t ? console.error(t) : void (e === i._mountData && i._name.setText(n.nameId));
    }), this._level.setText(M("ui.common.short.level") + " " + e.level));
    for (var o in this.panelCollection) {
      this.panelCollection[o].clearContent();
    }
    this.itemInfoTabs.toggleTabDisplay(2, !1);
    v.createEffectInstances(e.effectList, function (t, n) {
      if (t) {
        return console.error(t);
      }
      if (e === i._mountData) {
        var o = y.sortEffects(n);
        u(i.panelCollection.effects, o);
      }
    });
  }
};
d.prototype.displayItem = function (e, t) {
  var i = this;
  if (!(e instanceof I || e instanceof A)) {
    return console.error(new Error("ItemBox: item is not Item nor ItemInstance"));
  }
  if (t = t || {}, this.showTitle = t.hasOwnProperty("showTitle") ? t.showTitle : this.showTitle, this.showDescription = t.hasOwnProperty("showDescription") ? t.showDescription : this.showDescription, this.itemInstance = e.getItemInstance(), this.item = e, this._mountData = null, e.isItemInstance && !e.isInitialised) {
    return e.once("initialised", function () {
      i.item === e && i.displayItem(e, t);
    });
  }
  if (this.itemId = e.getProperty("id"), this.weight.setText(M("ui.common.short.weight", e.getProperty("weight"))), this.twoHandedIcon.toggleDisplay(!!e.getProperty("twoHanded")), this.image.setStyle("backgroundImage", e.getProperty("image")), w(this.image, !0), this.tooltipItemDescription.updateUI(e), this._toggleItemActions(e), this._canDisplayDescription()) {
    var n = C.getItemTypeMap()[e.getProperty("typeId")].nameId;
    this.categoryText.setText(M("ui.common.category") + M("ui.common.colon") + n);
    this.descriptionText.setText(e.getProperty("descriptionId"));
    this.itemDescriptionContainer.show();
    window.setTimeout(function () {
      i.itemDescriptionContainer.refresh();
    }, 0);
  } else {
    this.itemDescriptionContainer.hide();
  }
  this._itemTitle.toggleDisplay(!!this.showTitle);
  this.showTitle && (this._name.setText(e.getProperty("nameId")), this._level.setText(M("ui.common.short.level") + " " + e.getProperty("level")));
  for (var o in this.panelCollection) {
    this.panelCollection[o].clearContent();
  }
  var a = null !== window.gui.playerData.inventory.getGenericItem(this.itemId),
    s = e.getProperty("hideEffects") && !a;
  if (s) {
    this.panelCollection.effects.addRow([M("ui.set.secretBonus")]);
  } else {
    var r = y.getSortedEffectInstances(e);
    u(this.panelCollection.effects, r);
  }
  p(e.getProperty("conditionsFormatted"), this.panelCollection.conditions);
  p(e.getProperty("targetConditionsFormatted"), this.panelCollection.conditions);
  e.getProperty("isWeapon") ? (m(e.getProperty("statsFormatted"), this.panelCollection.characteristics), this.itemInfoTabs.toggleTabDisplay(2, !0)) : this.itemInfoTabs.toggleTabDisplay(2, !1);
  var l = this.itemInstance && this.itemInstance.effectsMap[W];
  this.durabilityBar.toggleDisplay(!!l);
  l && (this.durabilityBar.setValue(l.diceNum, l.value), this.durabilityBarDescription.setText(l.description));
};
e.exports = d;
this.itemActionContainer.show();
this.bestiaryBtn.toggleDisplay(!!e.getProperty("dropMonsterIds").length);
this.setButton.toggleDisplay(e.getProperty("itemSetId") !== -1);
this.bidHouseBtn.toggleDisplay(t);
this.destroyButton.toggleDisplay(!!e.isItemInstance);
t = t || {};
this._mountData = e;
this.item = null;
this.itemInstance = null;
this.showTitle = t.hasOwnProperty("showTitle") ? t.showTitle : this.showTitle;
this.showDescription = t.hasOwnProperty("showDescription") ? t.showDescription : this.showDescription;
this.weight.setText(M("ui.common.short.weight", 0));
this.twoHandedIcon.hide();
this.durabilityBar.hide();
this.descriptionText.setText(n);
this.itemDescriptionContainer.show();
this.itemDescriptionContainer.refresh();
this._itemTitle.toggleDisplay(!!this.showTitle);
this.showTitle && (N.getData("Mounts", e.model, function (t, n) {
  return t ? console.error(t) : void (e === i._mountData && i._name.setText(n.nameId));
}), this._level.setText(M("ui.common.short.level") + " " + e.level));
this.itemInfoTabs.toggleTabDisplay(2, !1);
v.createEffectInstances(e.effectList, function (t, n) {
  if (t) {
    return console.error(t);
  }
  if (e === i._mountData) {
    var o = y.sortEffects(n);
    u(i.panelCollection.effects, o);
  }
});
this.categoryText.setText(M("ui.common.category") + M("ui.common.colon") + n);
this.descriptionText.setText(e.getProperty("descriptionId"));
this.itemDescriptionContainer.show();
window.setTimeout(function () {
  i.itemDescriptionContainer.refresh();
}, 0);
this._itemTitle.toggleDisplay(!!this.showTitle);
this.showTitle && (this._name.setText(e.getProperty("nameId")), this._level.setText(M("ui.common.short.level") + " " + e.getProperty("level")));
p(e.getProperty("conditionsFormatted"), this.panelCollection.conditions);
p(e.getProperty("targetConditionsFormatted"), this.panelCollection.conditions);
e.getProperty("isWeapon") ? (m(e.getProperty("statsFormatted"), this.panelCollection.characteristics), this.itemInfoTabs.toggleTabDisplay(2, !0)) : this.itemInfoTabs.toggleTabDisplay(2, !1);
this.durabilityBar.toggleDisplay(!!l);
l && (this.durabilityBar.setValue(l.diceNum, l.value), this.durabilityBarDescription.setText(l.description));
s.call(this, "div", {
  className: "RewardBoxes"
});
e = e || {};
this._NB_REWARDS = e.nbRewards || 6;
this._slotList = [];
this._rewardNextSlot = 0;
this._content = this.createChild("div", {
  className: "rewardContent"
});
this.reset();
r(n, a);
e.exports = n;
n.prototype.reset = function () {
  this._slotList = [];
  this._rewardNextSlot = 0;
  this._content.clearContent();
  for (var e = 0; e < this._NB_REWARDS; e += 1) {
    this._slotList.push(this._content.appendChild(new o()));
  }
};
n.prototype.addItemInstance = function (e) {
  var t = this;
  if (!(this._rewardNextSlot >= this._NB_REWARDS)) {
    var i = this._slotList[this._rewardNextSlot];
    i.addClassNames("spinner");
    this._rewardNextSlot += 1;
    var n = new l({
      itemData: e,
      quantity: e.quantity
    });
    n.on("tap", function () {
      t.emit("tapSlot", e);
    });
    n.insertBefore(i);
    i.destroy();
  }
};
this._slotList = [];
this._rewardNextSlot = 0;
this._content.clearContent();
i.addClassNames("spinner");
this._rewardNextSlot += 1;
n.on("tap", function () {
  t.emit("tapSlot", e);
});
n.insertBefore(i);
i.destroy();
a.call(this, "div", {
  className: "CharactersSpace"
});
this._tiles = [];
this.createChild("div", {
  className: "title",
  text: l("ui.connection.whosGift")
});
this._scroll = e.appendChild(new r({
  className: "scroll"
}));
this._scrollContent = this._scroll.content.createChild("div", {
  className: "scrollContent"
});
this._characterDisplayWebGL = t.appendChild(new c({
  scale: "fitin",
  horizontalAlign: "center"
}));
this._loadingOverlay = t.createChild("div", {
  className: "loadingOverlay",
  hidden: !0,
  text: l("ui.connection.assignGift")
});
o(n, a);
e.exports = n;
n.prototype.update = function (e) {
  function t() {
    i._deselecteAll();
    this.addClassNames("selected");
    i.emit("selectTile", this.id);
    i._characterDisplayWebGL.release();
    i._characterDisplayWebGL.setLook(this.entityLook, {
      boneType: "characters/",
      skinType: "characters/"
    });
  }
  var i = this;
  this._scrollContent.clearContent();
  this._tiles = [];
  for (var n = 0, o = e.length; n < o; n += 1) {
    var a = e[n],
      r = this._scrollContent.appendChild(new s(a.id, a.name, a.level, a.entityLook));
    i._tiles.push(r);
    r.on("select", t);
  }
  this._scroll.refresh();
  this._tiles[0] && t.call(this._tiles[0]);
};
n.prototype._deselecteAll = function () {
  for (var e = 0, t = this._tiles.length; e < t; e += 1) {
    var i = this._tiles[e];
    i.delClassNames("selected");
  }
};
n.prototype.setAssignLoading = function (e) {
  this._loadingOverlay.toggleDisplay(e);
  this._loadingOverlay.addClassNames("spinner");
};
n.prototype.reset = function () {
  this._deselecteAll();
  this._characterDisplayWebGL.release();
};
i._deselecteAll();
this.addClassNames("selected");
i.emit("selectTile", this.id);
i._characterDisplayWebGL.release();
i._characterDisplayWebGL.setLook(this.entityLook, {
  boneType: "characters/",
  skinType: "characters/"
});
this._scrollContent.clearContent();
this._tiles = [];
i._tiles.push(r);
r.on("select", t);
this._scroll.refresh();
this._tiles[0] && t.call(this._tiles[0]);
this._loadingOverlay.toggleDisplay(e);
this._loadingOverlay.addClassNames("spinner");
this._deselecteAll();
this._characterDisplayWebGL.release();
this.id = e;
this.entityLook = n;
o(n, a);
e.exports = n;
this.once("open", function () {
  f.createChild("div", {
    text: l("ui.charSel.secretQuestion"),
    className: "explications"
  });
  var a = function () {
    window.gui.openConfirmPopup({
      title: l("ui.popup.warning"),
      message: l("ui.popup.warnBeforeDelete", n),
      cb: function (e) {
        e && window.dofus.sendMessage("CharacterDeletionRequestMessage", {
          characterId: i,
          secretAnswerHash: d(i + "~" + g)
        });
        s.close(m.id);
      }
    });
  };
  t = f.createChild("div", {
    className: "secretQuestionDiv"
  });
  e = f.appendChild(new c({
    attr: {
      maxlength: o,
      value: ""
    },
    onEnter: function () {
      e.blur();
      a();
    }
  }));
  e.addClassNames("inputSecretAnswer");
  e.on("change", function (e) {
    g = e;
  });
  var h = f.createChild("div", {
      className: "buttonContainer"
    }),
    p = h.appendChild(new r(l("ui.common.ok")));
  p.on("tap", a);
  var _ = h.appendChild(new r(l("ui.common.cancel")));
  _.on("tap", function () {
    s.close(m.id);
  });
  this.keyboardHeight = .6 * u.screenHeight;
});
this.on("open", function (e) {
  h.disableScroll(!0);
  e = e || {};
  i = e.id;
  n = e.name;
  e.secretQuestion || console.error("DeleteCharacterConfirmWindow: missing secretQuestion for characterId", i);
  t.setText(e.secretQuestion);
});
this.on("opened", function () {
  e.focus();
});
this.on("close", function () {
  e.setValue("");
  g = "";
  e.blur();
  h.disableScroll(!1);
});
h.on("show", function (e) {
  m.setPosition(e);
});
e && window.dofus.sendMessage("CharacterDeletionRequestMessage", {
  characterId: i,
  secretAnswerHash: d(i + "~" + g)
});
s.close(m.id);
t = f.createChild("div", {
  className: "secretQuestionDiv"
});
e = f.appendChild(new c({
  attr: {
    maxlength: o,
    value: ""
  },
  onEnter: function () {
    e.blur();
    a();
  }
}));
e.addClassNames("inputSecretAnswer");
e.on("change", function (e) {
  g = e;
});
e.blur();
a();
_.on("tap", function () {
  s.close(m.id);
});
this.keyboardHeight = .6 * u.screenHeight;
h.disableScroll(!0);
e = e || {};
i = e.id;
n = e.name;
e.secretQuestion || console.error("DeleteCharacterConfirmWindow: missing secretQuestion for characterId", i);
t.setText(e.secretQuestion);
e.setValue("");
g = "";
e.blur();
h.disableScroll(!1);
o(n, a);
e.exports = n;
n.prototype.setPosition = function (e) {
  var t = u.screenHeight - e,
    i = {
      left: "c",
      top: (t - p.h) / 2,
      width: p.w,
      height: p.h
    };
  s.positionWindow(this.id, i);
};
h.call(this, {
  className: "characUpdateWindow",
  title: "Characteristic Update",
  positionInfo: {
    top: "c",
    left: "c",
    width: 410,
    height: 300
  }
});
this.on("open", function (e) {
  var t = p.getWindow("characteristics");
  t.openState && (p.arrangeOpeningWindow(this.id, {
    rightOf: t.id
  }), this.updateContent(e));
});
this.on("close", function () {
  l.hide();
});
this.closeButton.on("tap", function () {
  d("CANCEL_BUTTON");
});
r(n, h);
e.exports = n;
n.prototype.updateContent = function (e) {
  var t = this,
    i = {
      basePtsToAssign: e.pointsRemaining,
      additionalPtsToAssign: e.additionalPtsRemaining,
      initialLevel: e.initialLevel,
      initialAdditionalPts: e.initialAdditionalPts,
      isAdditionalPtsAssignMode: e.isAdditionalPtsAssign,
      costSteps: e.costSteps
    };
  this._charaUpdateModule = new a(i);
  this._previousCostStep = void 0;
  this.windowTitle.setText(e.label);
  this.windowBody.clearContent();
  var n = s("ui.charaSheet.boostPoints") + s("ui.common.colon"),
    r = null,
    l = null,
    u = this._charaUpdateModule.getPtsToAssign();
  if (t._charaUpdateModule.canAssignAdditionalPts()) {
    var h = s("tablet.charaSheet.boostAdditionnalPoints") + s("ui.common.colon"),
      f = this.windowBody.appendChild(new o({
        scaleOnPress: !1
      }, function () {
        t.updateContent({
          label: e.label,
          characteristicName: e.characteristicName,
          additionalPtsRemaining: e.additionalPtsRemaining,
          pointsRemaining: e.pointsRemaining,
          initialLevel: e.initialLevel,
          initialAdditionalPts: e.initialAdditionalPts,
          isAdditionalPtsAssign: !t._charaUpdateModule.isAdditionalPtsAssignMode(),
          costSteps: e.costSteps
        });
      }));
    r = f.createChild("div", {
      className: ["points", "pointsRemainingLine"]
    });
    r.createChild("span", {
      text: n
    });
    l = f.createChild("div", {
      className: ["points", "additionalPtsRemainingLine"]
    });
    l.createChild("span", {
      text: h
    });
    var g = this._charaUpdateModule.isAdditionalPtsAssignMode();
    r.toggleClassName("on", !g);
    l.toggleClassName("on", g);
  } else {
    r = this.windowBody.createChild("div", {
      className: "points"
    });
    r.createChild("span", {
      text: n
    });
  }
  r && (this._pointsRemainingElt = r.createChild("span", {
    className: "pointsRemaining",
    text: u.base
  }));
  l && (this._additionalPtsRemainingElt = l.createChild("span", {
    className: "pointsRemaining",
    text: u.additional
  }));
  this._container = this.windowBody.createChild("div", {
    className: "containerBlock"
  });
  var _ = this._container.createChild("div", {
    className: "additionBlock"
  });
  _.appendChild(new o({
    className: "minusButton",
    repeatDelay: 50,
    scaleOnPress: !0
  }, function () {
    t._charaUpdateModule.decrementPts() && t.displayValues();
  }));
  this._pointsLineAdded = new c({
    className: "pointsInput",
    minValue: 0,
    maxValue: this._charaUpdateModule.getMaxRemainingPts()
  });
  this._pointsLineAdded.on("change", function (e) {
    t._charaUpdateModule.spendPointsUntil(e);
    t.displayValues();
  });
  _.appendChild(this._pointsLineAdded);
  _.appendChild(new o({
    className: "plusButton",
    repeatDelay: 50,
    scaleOnPress: !0
  }, function () {
    t._charaUpdateModule.incrementPts() && t.displayValues();
  }));
  var v = _.createChild("div", {
    className: "additionLine"
  });
  v.createChild("span", {
    text: "+ "
  });
  this._levelAddedElt = v.createChild("span", {
    text: 0
  });
  v.createChild("span", {
    text: " " + e.label
  });
  var y = _.createChild("div", {
    className: "totalLine"
  });
  this._finalLevelElt = y.createChild("span", {
    text: this._charaUpdateModule.getInitialLevel()
  });
  y.createChild("span", {
    text: " " + e.label
  });
  this.createCostLevelTable();
  this._container.appendChild(new o({
    text: s("ui.common.validation"),
    className: "button"
  }, function () {
    if (t._charaUpdateModule.getSpentPts() <= 0) {
      return d("GEN_BUTTON");
    }
    d("OK_BUTTON");
    var i = m[e.characteristicName];
    window.gui.scenarioManager.checkCondition(window.gui.scenarioManager.conditionTypeEnum.CHARAC_UPDATE);
    window.dofus.sendMessage("StatsUpgradeRequestMessage", {
      statId: i,
      boostPoint: t._charaUpdateModule.getSpentPts(),
      useAdditionnal: t._charaUpdateModule.isAdditionalPtsAssignMode()
    });
    p.close(t.id);
  }));
  this.displayValues();
};
n.prototype.createCostLevelTable = function () {
  for (var e = ["title"], t = [s("ui.common.level")], i = [s("ui.common.cost")], n = this._charaUpdateModule.getCostSteps(), o = 0; o < n.length; o++) {
    e.push("l" + o);
    t.push("> " + n[o][f]);
    i.push(n[o][g]);
  }
  this._table = this._container.appendChild(new u({
    colIds: e,
    colCount: n.length,
    headerContent: t
  }));
  this._table.addRow(i);
};
n.prototype.displayValues = function () {
  var e = this._charaUpdateModule,
    t = e.getPtsToAssign(),
    i = e.getSpentPts(),
    n = e.getCurrentCostStep();
  if (this._charaUpdateModule.isAdditionalPtsAssignMode() ? this._additionalPtsRemainingElt.setText(String(t.additional - i)) : this._pointsRemainingElt.setText(String(t.base - i)), this._pointsLineAdded.setValue(i), this._levelAddedElt.setText(String(e.getCharacIncreasePts())), this._finalLevelElt.setText(String(e.getInitialLevel() + e.getCharacIncreasePts())), n !== this._previousCostStep) {
    if (void 0 !== this._previousCostStep) {
      var o = this._table.getHeaderCol("l" + this._previousCostStep),
        a = this._table.getCol(0, "l" + this._previousCostStep);
      o.delClassNames("selected");
      a.delClassNames("selected");
    }
    this._previousCostStep = n;
    var s = this._table.getHeaderCol("l" + n),
      r = this._table.getCol(0, "l" + n);
    s.addClassNames("selected");
    r.addClassNames("selected");
  }
};
this._charaUpdateModule = new a(i);
this._previousCostStep = void 0;
this.windowTitle.setText(e.label);
this.windowBody.clearContent();
r = f.createChild("div", {
  className: ["points", "pointsRemainingLine"]
});
r.createChild("span", {
  text: n
});
l = f.createChild("div", {
  className: ["points", "additionalPtsRemainingLine"]
});
l.createChild("span", {
  text: h
});
r.toggleClassName("on", !g);
l.toggleClassName("on", g);
r = this.windowBody.createChild("div", {
  className: "points"
});
r.createChild("span", {
  text: n
});
r && (this._pointsRemainingElt = r.createChild("span", {
  className: "pointsRemaining",
  text: u.base
}));
l && (this._additionalPtsRemainingElt = l.createChild("span", {
  className: "pointsRemaining",
  text: u.additional
}));
this._container = this.windowBody.createChild("div", {
  className: "containerBlock"
});
_.appendChild(new o({
  className: "minusButton",
  repeatDelay: 50,
  scaleOnPress: !0
}, function () {
  t._charaUpdateModule.decrementPts() && t.displayValues();
}));
this._pointsLineAdded = new c({
  className: "pointsInput",
  minValue: 0,
  maxValue: this._charaUpdateModule.getMaxRemainingPts()
});
this._pointsLineAdded.on("change", function (e) {
  t._charaUpdateModule.spendPointsUntil(e);
  t.displayValues();
});
_.appendChild(this._pointsLineAdded);
_.appendChild(new o({
  className: "plusButton",
  repeatDelay: 50,
  scaleOnPress: !0
}, function () {
  t._charaUpdateModule.incrementPts() && t.displayValues();
}));
t._charaUpdateModule.spendPointsUntil(e);
t.displayValues();
v.createChild("span", {
  text: "+ "
});
this._levelAddedElt = v.createChild("span", {
  text: 0
});
v.createChild("span", {
  text: " " + e.label
});
this._finalLevelElt = y.createChild("span", {
  text: this._charaUpdateModule.getInitialLevel()
});
y.createChild("span", {
  text: " " + e.label
});
this.createCostLevelTable();
this._container.appendChild(new o({
  text: s("ui.common.validation"),
  className: "button"
}, function () {
  if (t._charaUpdateModule.getSpentPts() <= 0) {
    return d("GEN_BUTTON");
  }
  d("OK_BUTTON");
  var i = m[e.characteristicName];
  window.gui.scenarioManager.checkCondition(window.gui.scenarioManager.conditionTypeEnum.CHARAC_UPDATE);
  window.dofus.sendMessage("StatsUpgradeRequestMessage", {
    statId: i,
    boostPoint: t._charaUpdateModule.getSpentPts(),
    useAdditionnal: t._charaUpdateModule.isAdditionalPtsAssignMode()
  });
  p.close(t.id);
}));
this.displayValues();
window.gui.scenarioManager.checkCondition(window.gui.scenarioManager.conditionTypeEnum.CHARAC_UPDATE);
window.dofus.sendMessage("StatsUpgradeRequestMessage", {
  statId: i,
  boostPoint: t._charaUpdateModule.getSpentPts(),
  useAdditionnal: t._charaUpdateModule.isAdditionalPtsAssignMode()
});
p.close(t.id);
e.push("l" + o);
t.push("> " + n[o][f]);
i.push(n[o][g]);
this._table = this._container.appendChild(new u({
  colIds: e,
  colCount: n.length,
  headerContent: t
}));
this._table.addRow(i);
o.delClassNames("selected");
a.delClassNames("selected");
s.addClassNames("selected");
r.addClassNames("selected");
e = e || {};
this._basePtsToAssign = e.basePtsToAssign || 0;
this._initialLevel = e.initialLevel || 0;
this._additionalPtsToAssign = e.additionalPtsToAssign || 0;
this._initialAdditionalPts = e.initialAdditionalPts || 0;
this._isAdditionalPtsAssignMode = e.isAdditionalPtsAssignMode || !1;
this._costSteps = e.costSteps;
this._isAdditionalPtsAssignMode = e.isAdditionalPtsAssignMode || !1;
this._canAssignAdditionalPts = !0;
(this._additionalPtsToAssign <= 0 || this._initialAdditionalPts >= a.MAX_ADDITIONNAL_PER_CARAC) && (this._canAssignAdditionalPts = !1);
this._costSteps || (this._costSteps = [], o.error(new Error("CharaUpdateModule: params costSteps is missing")));
this._currentCostStep = 0;
this._pointsSpent = 0;
this._addedLevel = 0;
this._initializeSteps();
e.exports = n;
n.prototype._initializeSteps = function () {
  var e = this.getCostSteps();
  this._currentCostStep = 0;
  for (var t = 0; t < e.length; t++) {
    this.getInitialLevel() >= e[t][s] && (this._currentCostStep = t);
  }
};
n.prototype.getPtsToAssign = function () {
  return {
    base: this._basePtsToAssign,
    additional: this._additionalPtsToAssign
  };
};
n.prototype.getMaxRemainingPts = function () {
  return this._isAdditionalPtsAssignMode ? this._additionalPtsToAssign : this._basePtsToAssign;
};
n.prototype.canAssignAdditionalPts = function () {
  return this._canAssignAdditionalPts;
};
n.prototype.isAdditionalPtsAssignMode = function () {
  return this._isAdditionalPtsAssignMode;
};
n.prototype.getCostSteps = function () {
  return this._costSteps;
};
n.prototype.getInitialLevel = function () {
  return this._isAdditionalPtsAssignMode ? this._initialAdditionalPts : this._initialLevel;
};
n.prototype.getCurrentCostStep = function () {
  return this._currentCostStep;
};
n.prototype.getSpentPts = function () {
  return this._pointsSpent;
};
n.prototype.getCharacIncreasePts = function () {
  return this._addedLevel;
};
n.prototype.incrementPts = function () {
  return this._updatePoints(1);
};
n.prototype.decrementPts = function () {
  return this._updatePoints(-1);
};
n.prototype.spendPointsUntil = function (e) {
  var t = this.getCostSteps();
  if (e - this._pointsSpent > 0) {
    for (; this._pointsSpent < e;) {
      var i = t[this._currentCostStep][r];
      if (this._pointsSpent + i > e) {
        break;
      }
      if (!this.incrementPts()) {
        break;
      }
    }
  } else {
    for (; this._pointsSpent > e && this.decrementPts();) {
      ;
    }
  }
};
n.prototype._updatePoints = function (e) {
  var t = this.getCostSteps(),
    i = t[this._currentCostStep],
    n = i[r];
  if (e > 0) {
    if (this._pointsSpent + n > this.getMaxRemainingPts()) {
      return !1;
    }
    if (this._isAdditionalPtsAssignMode && this.getInitialLevel() + this._addedLevel >= a.MAX_ADDITIONNAL_PER_CARAC) {
      return !1;
    }
    this._pointsSpent += n;
    i.length > 2 ? this._addedLevel += i[2] : this._addedLevel++;
    var o = t[this._currentCostStep + 1];
    o && this.getInitialLevel() + this._addedLevel >= o[s] && this._currentCostStep++;
  } else {
    if (!this._pointsSpent) {
      return !1;
    }
    this.getInitialLevel() + this._addedLevel <= i[s] && (this._currentCostStep--, i = t[this._currentCostStep], n = i[r]);
    this._pointsSpent -= n;
    i.length > 2 ? this._addedLevel -= i[2] : this._addedLevel--;
  }
  return !0;
};
this._pointsSpent += n;
i.length > 2 ? this._addedLevel += i[2] : this._addedLevel++;
this.getInitialLevel() + this._addedLevel <= i[s] && (this._currentCostStep--, i = t[this._currentCostStep], n = i[r]);
this._pointsSpent -= n;
i.length > 2 ? this._addedLevel -= i[2] : this._addedLevel--;
r.close(o.id);
l("CLOSE_DOCUMENT");
r.openDialog(o.id);
s.getData("Documents", e.documentId, function (e, t) {
  return e ? (r.close(o.id), console.warn("Documents error", e)) : (t.typeId === d && n.open(t), t.typeId === u && c.open(t), void l("OPEN_DOCUMENT"));
});
n = i(994);
o.windowBody.appendChild(c);
o.windowBody.appendChild(n);
c.on("close", e);
n.on("close", e);
window.gui.on("DocumentReadingBeginMessage", t);
t(a);
o(n, a);
e.exports = n;
s.call(this, {
  className: "Scroll"
});
this.setClassNames("Scroll");
this.btnClose = this.appendChild(new r({
  className: "btnClose"
}));
this.lblTitle = this.createChild("div", {
  className: "lblTitle"
});
this.createChild("div", {
  className: "scrollOrnament"
});
this._lblContentScroller = this.appendChild(new l({
  className: "lblContent"
}));
this.lblContent = this._lblContentScroller.content;
this.txIllu = this.createChild("div", {
  className: "scrollImage"
});
this._image = null;
this._illuUri = null;
this._styleSheet = new c();
this._hasText = !0;
a(n, s);
e.exports = new n();
n.prototype.open = function (e) {
  if (this._title = e.titleId, this._page = e.contentId, this._image = this._getImageData(this._page), this.toggleClassName("zombieIsland", e.id === h), !this._page) {
    return console.error("Scroll content is empty for document id", e.id), this.close();
  }
  e.contentCSS && this._styleSheet.create(this._formatText(e.contentCSS), ".Scroll");
  var t = this;
  this._preInitData(function () {
    t.show();
  });
};
n.prototype._preInitData = function (e) {
  if (this._hasText = o(this._page), !this._image) {
    return this._initScroll(), e();
  }
  var t = this;
  d.preloadImage(this._image.imageId, function (i) {
    return t._image && (t._image.src = i, t._initScroll()), e();
  });
};
n.prototype.close = function () {
  this.hide();
  this.lblTitle.clearContent();
  this.lblContent.clearContent();
  this._image = null;
  this.txIllu.setStyle("backgroundImage", "");
  this._styleSheet.destroy();
  s.prototype.close.call(this);
};
n.prototype._initScroll = function () {
  var e = this;
  this.lblTitle.setHtml(this._title);
  var t = "";
  t = this._styleSheet ? this._formatText(this._page) : this._page;
  this.lblContent.clearContent();
  var i = Boolean(this._image);
  !this._hasText && i ? (this.lblContent.hide(), this.txIllu.setStyles({
    backgroundImage: this._image.src,
    backgroundPosition: "center center",
    width: "100%"
  })) : (this.lblContent.show(), this._lblContentScroller.toggleClassName("small", i), this.txIllu.toggleDisplay(i), i && (t = t.replace(this._image.regExpResult, ""), this.txIllu.setStyles({
    backgroundImage: this._image.src,
    backgroundPosition: "center top",
    width: ""
  })), this.lblContent.appendChild(this._formatLinks(t)), window.setTimeout(function () {
    e._lblContentScroller.refresh();
  }, 0));
};
this.hide();
this.lblTitle.clearContent();
this.lblContent.clearContent();
this._image = null;
this.txIllu.setStyle("backgroundImage", "");
this._styleSheet.destroy();
s.prototype.close.call(this);
t = this._styleSheet ? this._formatText(this._page) : this._page;
this.lblContent.clearContent();
o.call(this, "div", {
  hidden: !0
});
this._styleSheet = null;
this._title = null;
this._author = null;
this._subTitle = null;
this._pages = null;
s(n, o);
e.exports = n;
n.prototype._linkHandler = function (e) {
  var t = e.split(",");
  t[0] === p ? (window.dofus.sendMessage("QuestStartRequestMessage", {
    questId: t[1]
  }), this.close()) : t[0] === m ? (window.dofus.sendMessage("QuestObjectiveValidationMessage", {
    questId: t[1],
    objectiveId: t[2]
  }), this.close()) : t[0] === f && window.gui.emit("CompassUpdateMessage", {
    type: a.COMPASS_TYPE_SIMPLE,
    worldX: ~~t[1],
    worldY: ~~t[2]
  });
};
n.prototype.close = function () {
  this.emit("close");
};
n.prototype._getImageData = function (e) {
  var t = new RegExp(c),
    i = t.exec(e);
  if (!i) {
    return null;
  }
  for (var n, o = i[2], a = new RegExp(h), s = {}; null !== (n = a.exec(o));) {
    n.index === a.lastIndex && a.lastIndex++;
    s[n[1]] = n[2] || n[3];
  }
  var r = {};
  r.regExpResult = i[0];
  r.before = i[1];
  var l = s.src.replace(d, ""),
    u = l.split(",");
  return l = "swf" === u[0] ? "gfx/documents/swf/" + u[1] + ".png" : "gfx/documents/" + u[1] + "." + u[0], r.imageId = l, r.width = parseInt(s.width, 10), r.height = parseInt(s.height, 10), r.hspace = parseInt(s.hspace, 10), r.align = s.align || "", r;
};
n.prototype._getAllImagesData = function (e) {
  for (var t, i = [], n = new RegExp(c); null !== (t = n.exec(e));) {
    i.push(this._getImageData(t[0]));
  }
  return i;
};
n.prototype._getAllLinks = function (e) {
  for (var t, i = [], n = new RegExp(u); null !== (t = n.exec(e));) {
    i.push({
      text: t[2],
      href: t[1].replace("event:", ""),
      original: t[0]
    });
  }
  return i;
};
n.prototype._formatText = function (e) {
  var t = e;
  return t = t.replace(/\n/g, " "), t = t.replace(/\r/g, " "), t = t.replace(/\t/g, ""), t = t.replace(/<p><\/p>/g, "<br/>");
};
n.prototype._formatLinks = function (e) {
  function t(e, t, n) {
    n ? e.addEventListener(r.end, function (e) {
      l.openUrlInAppBrowser(t);
      e.preventDefault();
    }) : e.addEventListener(r.end, function (e) {
      i._linkHandler(t);
      e.preventDefault();
    });
  }
  var i = this,
    n = new o("div");
  n.setHtml(e);
  for (var a = n.rootElement.getElementsByTagName("a"), s = 0, c = a.length; s < c; s++) {
    var d = a[s],
      u = d.href.replace("event:", "");
    u.indexOf(g) !== -1 ? t(d, u.split(",")[1], !0) : (t(d, u), d.href = "#");
  }
  return n;
};
n.index === a.lastIndex && a.lastIndex++;
s[n[1]] = n[2] || n[3];
r.regExpResult = i[0];
r.before = i[1];
l.openUrlInAppBrowser(t);
e.preventDefault();
i._linkHandler(t);
e.preventDefault();
e.exports = o;
o.prototype.destroy = function () {
  this.styleTag && (document.head.removeChild(this.styleTag), this.styleTag = null);
};
o.prototype.create = function (e, t) {
  this.styleTag || (this.styleTag = i());
  for (var o, s = this.styleTag.sheet, r = new RegExp(a); null !== (o = r.exec(e));) {
    o.index === r.lastIndex && r.lastIndex++;
    t && ("body" === o[1] ? o[1] = t : o[1] = t + " " + o[1]);
    n(s, o[1], o[2], 0);
  }
};
o.index === r.lastIndex && r.lastIndex++;
t && ("body" === o[1] ? o[1] = t : o[1] = t + " " + o[1]);
n(s, o[1], o[2], 0);
o.call(this);
this.setClassNames("ReadingBook");
this.btnClose = this.appendChild(new r({
  className: "btnClose"
}));
this.btnHome = this.appendChild(new r({
  className: "btnHome"
}));
this.pageLeft = this.createChild("div", {
  className: ["page", "pageLeft"]
});
this.pageRight = this.createChild("div", {
  className: ["page", "pageRight"]
});
this.pageTitle = this.createChild("div", {
  className: ["pageTitle", "page", "pageRight"]
});
this.lblTitle = this.pageTitle.createChild("div", {
  className: "lblTitle"
});
this.lblSubtitle = this.pageTitle.createChild("div", {
  className: "lblSubtitle"
});
this.pageTitle.createChild("div", {
  className: "bookOrnament"
});
this.lblAuthor = this.pageTitle.createChild("div", {
  className: "lblAuthor"
});
this.txDeco = {};
this.lblPageNumberLeft = this.appendChild(new r({
  className: ["pageNumber", "left"]
}));
this.lblPageNumberRight = this.appendChild(new r({
  className: ["pageNumber", "right"]
}));
this.btnPrevious = this.appendChild(new r({
  className: ["btnNav", "previous"]
}));
this.btnNext = this.appendChild(new r({
  className: ["btnNav", "next"]
}));
this._lastIndex = null;
this._currentIndex = null;
this._nbPages = null;
this._styleSheet = new a();
this.btnClose.on("tap", function () {
  e.close();
});
this.btnHome.on("tap", function () {
  e._currentIndex = -1;
  e._updateButtons();
  e._updateBook();
  d("BACK_TO_BEGINNING_DOCUMENT");
});
this.btnPrevious.on("tap", function () {
  e._currentIndex -= 2;
  e._updateButtons();
  e._updateBook();
  d("TURN_PAGE_DOCUMENT_1");
});
this.btnNext.on("tap", function () {
  e._currentIndex += 2;
  e._updateButtons();
  e._updateBook();
  d("TURN_PAGE_DOCUMENT_2");
});
this.lblPageNumberLeft.on("tap", function () {
  t.setStyles({
    left: "15%",
    right: "initial"
  });
  t.open({
    min: 1,
    max: e._nbPages + 1,
    placeholder: e._currentIndex + 1
  });
});
this.lblPageNumberRight.on("tap", function () {
  t.setStyles({
    right: "15%",
    left: "initial"
  });
  t.open({
    min: 1,
    max: e._nbPages + 1,
    placeholder: e._currentIndex + 2
  });
});
t.on("confirm", function (t) {
  e._selectPage(parseInt(t, 10) - 2);
  d("TURN_PAGE_DOCUMENT_3");
});
e._currentIndex = -1;
e._updateButtons();
e._updateBook();
d("BACK_TO_BEGINNING_DOCUMENT");
e._currentIndex -= 2;
e._updateButtons();
e._updateBook();
d("TURN_PAGE_DOCUMENT_1");
e._currentIndex += 2;
e._updateButtons();
e._updateBook();
d("TURN_PAGE_DOCUMENT_2");
t.setStyles({
  left: "15%",
  right: "initial"
});
t.open({
  min: 1,
  max: e._nbPages + 1,
  placeholder: e._currentIndex + 1
});
t.setStyles({
  right: "15%",
  left: "initial"
});
t.open({
  min: 1,
  max: e._nbPages + 1,
  placeholder: e._currentIndex + 2
});
e._selectPage(parseInt(t, 10) - 2);
d("TURN_PAGE_DOCUMENT_3");
s(n, o);
e.exports = new n();
n.prototype.open = function (e) {
  this._title = e.titleId || "";
  this._author = e.authorId || "";
  this._subTitle = e.subTitleId || "";
  e.contentCSS && this._styleSheet.create(this._formatText(e.contentCSS), ".ReadingBook");
  var t = e.contentId || "";
  this._pages = t.split("<pagefeed/>");
  this._lastIndex = -1;
  this._currentIndex = -1;
  this._nbPages = this._pages.length;
  this._initBook();
  var i = this._getAllImagesData(e.contentId);
  this.imageMap = {};
  var n = i.map(function (e) {
    return e.imageId;
  });
  this.show();
  var o = this;
  c.preloadImages(n, function (e) {
    for (var t = 0; t < i.length; t++) {
      o.imageMap[i[t].imageId] = e[t];
    }
    o._selectPage(o._currentIndex);
  });
};
n.prototype.close = function () {
  this._clearPages();
  this.hide();
  this._styleSheet.destroy();
  o.prototype.close.call(this);
};
n.prototype._clearPages = function (e) {
  e && "left" !== e || this.pageLeft.clearContent();
  e && "right" !== e || this.pageRight.clearContent();
};
n.prototype._initBook = function () {
  this.lblTitle.setHtml(this._title);
  this.lblSubtitle.setHtml(this._subTitle);
  this.lblAuthor.setHtml(this._author || "");
};
n.prototype._updateBook = function () {
  var e = this._currentIndex === -1;
  this.pageTitle.toggleDisplay(e);
  this.pageRight.toggleDisplay(!e);
  this.lblPageNumberLeft.toggleDisplay(!e);
  this.lblPageNumberRight.show();
  this._clearPages();
  e ? (this._updatePageLeft(), this.lblPageNumberRight.setText(this._currentIndex + 2)) : (this._updatePageLeft(), this._updatePageRight());
  this._lastIndex = this._currentIndex;
};
n.prototype._updatePageLeft = function () {
  var e = "";
  e = this._styleSheet && this._currentIndex !== -1 ? this._formatText(this._pages[this._currentIndex - 1]) : this._pages[this._currentIndex - 1] || "";
  this._insertContent(this.pageLeft, e);
  this.lblPageNumberLeft.setText(this._currentIndex + 1);
};
n.prototype._updatePageRight = function () {
  if (this._currentIndex < this._nbPages) {
    this.pageRight.isVisible() || this.pageRight.show();
    var e = "";
    e = this._styleSheet && this._currentIndex !== -1 ? this._formatText(this._pages[this._currentIndex]) : this._pages[this._currentIndex];
    this._insertContent(this.pageRight, e);
    this.lblPageNumberRight.setText(this._currentIndex + 2);
  } else {
    this.pageRight.hide();
    this.lblPageNumberRight.setText("");
  }
};
n.prototype._updateButtons = function () {
  var e = this._currentIndex === -1,
    t = this._currentIndex + 1 >= this._nbPages;
  this.btnHome.toggleDisplay(!e);
  this.btnPrevious.toggleDisplay(!e);
  this.btnNext.toggleDisplay(!t);
};
n.prototype._selectPage = function (e) {
  this._currentIndex = e % 2 ? e : e + 1;
  this._updateButtons();
  this._updateBook();
};
n.prototype._linkHandler = function (e) {
  if (e.indexOf(u) !== -1) {
    var t = parseInt(e.substr(u.length), 10);
    return this._selectPage(t);
  }
  o.prototype._linkHandler.call(this, e);
};
n.prototype._insertContent = function (e, t) {
  var i = this._getAllImagesData(t);
  if (i.length) {
    for (var n = 0; n < i.length; n++) {
      var o = i[n];
      o.before && e.appendChild(this._formatLinks(o.before));
      this._addTextureOnPage(e, o);
      t = t.replace(o.regExpResult, "");
    }
    t && e.appendChild(this._formatLinks(t));
  } else {
    e.appendChild(this._formatLinks(t));
  }
};
n.prototype._addTextureOnPage = function (e, t) {
  var i = e.createChild("div", {
      className: "image"
    }),
    n = parseInt(this.getComputedStyle("height"), 10),
    o = t.height / h * n,
    a = {
      height: o + "px",
      width: "100%",
      backgroundImage: this.imageMap[t.imageId]
    };
  "center" === t.align && (a.backgroundPosition = t.align);
  i.setStyles(a);
};
this._title = e.titleId || "";
this._author = e.authorId || "";
this._subTitle = e.subTitleId || "";
e.contentCSS && this._styleSheet.create(this._formatText(e.contentCSS), ".ReadingBook");
this._pages = t.split("<pagefeed/>");
this._lastIndex = -1;
this._currentIndex = -1;
this._nbPages = this._pages.length;
this._initBook();
this._clearPages();
this.hide();
this._styleSheet.destroy();
o.prototype.close.call(this);
e && "left" !== e || this.pageLeft.clearContent();
e && "right" !== e || this.pageRight.clearContent();
this.lblTitle.setHtml(this._title);
this.lblSubtitle.setHtml(this._subTitle);
this.lblAuthor.setHtml(this._author || "");
this.pageTitle.toggleDisplay(e);
this.pageRight.toggleDisplay(!e);
this.lblPageNumberLeft.toggleDisplay(!e);
this.lblPageNumberRight.show();
this._clearPages();
e ? (this._updatePageLeft(), this.lblPageNumberRight.setText(this._currentIndex + 2)) : (this._updatePageLeft(), this._updatePageRight());
this._lastIndex = this._currentIndex;
e = this._styleSheet && this._currentIndex !== -1 ? this._formatText(this._pages[this._currentIndex - 1]) : this._pages[this._currentIndex - 1] || "";
this._insertContent(this.pageLeft, e);
this.lblPageNumberLeft.setText(this._currentIndex + 1);
e = this._styleSheet && this._currentIndex !== -1 ? this._formatText(this._pages[this._currentIndex]) : this._pages[this._currentIndex];
this._insertContent(this.pageRight, e);
this.lblPageNumberRight.setText(this._currentIndex + 2);
this.pageRight.hide();
this.lblPageNumberRight.setText("");
this.btnHome.toggleDisplay(!e);
this.btnPrevious.toggleDisplay(!e);
this.btnNext.toggleDisplay(!t);
this._currentIndex = e % 2 ? e : e + 1;
this._updateButtons();
this._updateBook();
o.before && e.appendChild(this._formatLinks(o.before));
this._addTextureOnPage(e, o);
t = t.replace(o.regExpResult, "");
"center" === t.align && (a.backgroundPosition = t.align);
i.setStyles(a);
d.call(this, {
  title: s("ui.common.inventory"),
  className: "EquipmentWindow",
  freeContentDelay: 5e3,
  plusButton: !1,
  positionInfo: {
    left: "10%",
    top: "c",
    width: 636,
    height: "90%",
    minHeight: 550
  },
  openingSound: "OPEN_INVENTORY",
  closingSound: "CLOSE_INVENTORY"
});
this.hasDom = !1;
this.isListening = !1;
this.drawerNeedsUpdate = !0;
this.storageView = e;
this.storageView.registerView(this, {
  manualOpening: !0,
  enableAveragePrice: !1,
  enableSlotContext: !1,
  showBankButton: !0,
  filters: {
    quest: !0,
    preset: !0
  }
});
this.on("open", this._onOpen);
r(n, d);
e.exports = n;
n.prototype.freeContent = function () {
  this.storageView.storageUI.getParent() === this.storageBox && (this.storageView.unloadContent(), this.storageBox.removeChild(this.storageView.storageUI));
  this.storageBox = null;
  this.drawer.clearCharacter();
  this.windowBody.removeChild(this.drawer);
  this.drawerNeedsUpdate = !0;
  this.windowBody.clearContent();
  this.hasDom = !1;
};
n.prototype._onOpen = function () {
  this.hasDom || this._createDom();
  this.isListening || this._setupEvents();
  this.alignWithCharacteristics();
  this.storageBox.appendChild(this.storageView.storageUI);
  this.storageView.setBankButtonAvailability();
  this.drawer.resetItem();
};
n.prototype.alignWithCharacteristics = function () {
  var e = u.getWindow("characteristics");
  e.openState && (this.setStyle("top", e.getStyle("top")), u.arrangeOpeningWindow(this.id, {
    rightOf: e.id,
    sameHeight: !0
  }));
};
n.prototype.getEquipmentSlotsForTuto = function () {
  if (this.drawer) {
    return this.drawer.getSlots();
  }
};
n.prototype._setupEvents = function () {
  function e() {
    t.drawer.removePossiblePositionsHighlight();
  }
  this.isListening = !0;
  var t = this,
    i = window.gui;
  this.on("opened", function () {
    this.drawerNeedsUpdate && (this.drawerNeedsUpdate = !1, this.drawer.updateCharacter(), this.drawer.setEquipment());
  });
  this.on("slot-tap", function (e) {
    var t = e.itemInstance;
    t && (this.drawer.displayItem(t), this.emit("itemSelected", t));
  });
  this.on("slot-doubletap", function (e) {
    e.itemInstance.doDefaultAction();
  });
  this.on("slot-dragStart", function (t) {
    var i = t.dbItem.type.possiblePositions;
    i.length && this.drawer.highlightPossiblePositions(i);
    o.once("dragEnd", e);
  });
  this.on("focus", function () {
    i.shortcutBar.openPanel("item");
  });
  this.drawer.on("equippableHighlighted", function (e) {
    t.emit("equippableHighlighted", e);
  });
  this.drawer.on("itemDropped", function (e, i) {
    t.emit("itemDropped", e, i);
  });
  this.drawer.on("itemSelect", function () {
    t.storageView.unSelectSlot();
  });
  window.gui.scenarioManager.on("stepChanged", function () {
    var e = window.gui.scenarioManager.isBehaviourEnabled(h.INVENTORY_CLOSE_BTN);
    t.toggleClassName("disableCloseBtn", !e);
  });
};
n.prototype._createDom = function () {
  this.hasDom = !0;
  this.storageBox = this.windowBody.createChild("div", {
    className: "storageBox"
  });
  c(this.storageBox, ["characterBox"]);
  this.storageBox.on("drop", function (e) {
    window.dofus.sendMessage("ObjectSetPositionMessage", {
      objectUID: e.itemInstance.objectUID,
      position: l.positions.notEquipped,
      quantity: 1
    });
  });
  this.drawer = this.windowBody.appendChild(this.drawer || new a());
};
this.storageView.storageUI.getParent() === this.storageBox && (this.storageView.unloadContent(), this.storageBox.removeChild(this.storageView.storageUI));
this.storageBox = null;
this.drawer.clearCharacter();
this.windowBody.removeChild(this.drawer);
this.drawerNeedsUpdate = !0;
this.windowBody.clearContent();
this.hasDom = !1;
this.hasDom || this._createDom();
this.isListening || this._setupEvents();
this.alignWithCharacteristics();
this.storageBox.appendChild(this.storageView.storageUI);
this.storageView.setBankButtonAvailability();
this.drawer.resetItem();
this.on("opened", function () {
  this.drawerNeedsUpdate && (this.drawerNeedsUpdate = !1, this.drawer.updateCharacter(), this.drawer.setEquipment());
});
this.on("slot-tap", function (e) {
  var t = e.itemInstance;
  t && (this.drawer.displayItem(t), this.emit("itemSelected", t));
});
this.on("slot-doubletap", function (e) {
  e.itemInstance.doDefaultAction();
});
this.on("slot-dragStart", function (t) {
  var i = t.dbItem.type.possiblePositions;
  i.length && this.drawer.highlightPossiblePositions(i);
  o.once("dragEnd", e);
});
this.on("focus", function () {
  i.shortcutBar.openPanel("item");
});
this.drawer.on("equippableHighlighted", function (e) {
  t.emit("equippableHighlighted", e);
});
this.drawer.on("itemDropped", function (e, i) {
  t.emit("itemDropped", e, i);
});
this.drawer.on("itemSelect", function () {
  t.storageView.unSelectSlot();
});
window.gui.scenarioManager.on("stepChanged", function () {
  var e = window.gui.scenarioManager.isBehaviourEnabled(h.INVENTORY_CLOSE_BTN);
  t.toggleClassName("disableCloseBtn", !e);
});
i.length && this.drawer.highlightPossiblePositions(i);
o.once("dragEnd", e);
this.hasDom = !0;
this.storageBox = this.windowBody.createChild("div", {
  className: "storageBox"
});
c(this.storageBox, ["characterBox"]);
this.storageBox.on("drop", function (e) {
  window.dofus.sendMessage("ObjectSetPositionMessage", {
    objectUID: e.itemInstance.objectUID,
    position: l.positions.notEquipped,
    quantity: 1
  });
});
this.drawer = this.windowBody.appendChild(this.drawer || new a());
g.call(this, "div", {
  className: "EquipmentDrawer"
});
this.content = this.createChild("div", {
  className: "drawerContent"
});
this._slots = {};
this._createDom();
this._setupEvents();
u(n, g);
e.exports = n;
n.prototype._createSlot = function (e, t) {
  function i(e) {
    var t = this.data || {},
      i = this.position === y,
      o = t.model;
    !o && i && a(t, e.data) ? s(t, e.data) : window.gui.playerData.inventory.equipItem(e.data.objectUID, this.position);
    n.emit("itemDropped", e.data, this.position);
  }
  var n = this,
    r = this._slots[t] = e.appendChild(new m({
      scaleOnPress: !0
    }));
  r.addClassNames("pos" + t);
  r.position = t;
  c.setDroppable(r, ["characterBox", "equipment"], {
    matchPositionOnDrop: !0
  });
  r.on("drop", i);
  r.itemUI = {};
  c.setDraggable(r, r.itemUI, "characterBox");
  r.on("tap", function () {
    this.data && (this.data.mountLocation || this.data.isInitialised) && (n.displayItem(this.data), n.emit("itemSelect", this.data));
  });
  r.on("doubletap", o);
};
n.prototype._createDom = function () {
  function e(e) {
    window.gui.playerData.inventory.equipItem(e.itemInstance.objectUID);
  }
  var t = this.content.createChild("div", {
      className: "characterBox"
    }),
    i = {};
  i.left = t.createChild("div", {
    className: "leftSlotBox"
  });
  var n = t.createChild("div", {
      className: "rightContainer"
    }),
    o = n.createChild("div", {
      className: "topBox"
    }),
    a = this._character = o.appendChild(new r({
      scale: "fitin",
      horizontalAlign: "center"
    })),
    s = o.createChild("div", {
      className: "rightBoxes"
    });
  c.setDroppable(a, ["equipment"]);
  a.on("drop", e);
  var u = a.createChild("div", {
    className: "leftButton"
  });
  l(u, {
    repeatDelay: 100
  });
  u.on("tap", function () {
    a.rotateCharacter(!1);
  });
  var p = a.createChild("div", {
    className: "rightButton"
  });
  l(p, {
    repeatDelay: 100
  });
  p.on("tap", function () {
    a.rotateCharacter(!0);
  });
  i.right1 = s.createChild("div", {
    className: "rightSlotBox1"
  });
  i.right2 = s.createChild("div", {
    className: "rightSlotBox2"
  });
  i.bottom = n.createChild("div", {
    className: "bottomSlotBox"
  });
  for (var m in b) {
    for (var f = b[m], g = i[m], _ = 0, v = f.length; _ < v; _ += 1) {
      this._createSlot(g, f[_]);
    }
  }
  this._placeHolder = this.content.createChild("div", {
    className: "itemBoxPlaceHolder",
    text: d("ui.common.selectItem")
  });
  this._itemBox = this.content.appendChild(new h({
    showTitle: !0,
    showItemActions: !0,
    minRows: 7
  }));
};
n.prototype._setSlot = function (e, t) {
  var i = this._slots[e];
  if (i) {
    if (t.mountLocation) {
      i.setData(t);
      f.preloadImage("gfx/mounts/" + t.model + ".png", function (e) {
        i.setImage(e);
      });
    } else {
      i.setItem(t);
      i.itemUI.backgroundImage = i.getImage();
      c.enableDrag(i);
      var n = this._slots[w.weapon],
        o = this._slots[w.shield],
        a = n.itemInstance && n.itemInstance.item;
      a && a.twoHanded ? o.lock() : o.itemInstance || o.unset();
    }
  }
};
n.prototype._unsetSlot = function (e) {
  var t = this._slots[e];
  t && (t.unset(), c.disableDrag(t));
};
n.prototype.updateCharacterLook = function (e) {
  var t = this;
  M.push(function (i) {
    t._character.setLook(e, {
      riderOnly: !1,
      boneType: "characters/",
      skinType: "characters/",
      keepDirection: !0,
      keepModels: !0
    }, i);
  });
};
n.prototype.updateCharacter = function () {
  var e = window.gui.playerData.characterBaseInformations;
  this.updateCharacterLook(e.entityLook);
  var t = this._character;
  f.preloadImage("gfx/illusUi/symboles_classe/FichePerso_tx_symboleClasse_frame" + (e.breed - 1) + ".png", function (e) {
    t.setStyle("backgroundImage", e);
  });
};
n.prototype.clearCharacter = function () {
  this._character.release();
};
n.prototype._getItemBoxActionButton = function () {
  return this._itemBox.actionBtn;
};
n.prototype.setEquipment = function () {
  var e,
    t = window.gui.playerData,
    i = t.inventory.equippedItems;
  for (e in this._slots) {
    var n = i[e];
    n ? this._setSlot(e, n) : this._unsetSlot(e);
  }
  t.isRiding && this._setSlot(w.mount, t.equippedMount);
};
n.prototype._setupEvents = function () {
  var e = this,
    t = window.gui,
    i = t.playerData,
    n = i.inventory;
  n.on("itemMoved", function (t, i, n) {
    n === w.notEquipped ? e._unsetSlot(i) : e._setSlot(n, t);
  });
  n.on("itemAdded", function (t) {
    t.position !== w.notEquipped && e._setSlot(t.position, t);
  });
  n.on("itemDeleted", function (t, i) {
    var n = e._itemBox.item;
    n && n === i && e.resetItem();
    i.position !== w.notEquipped && e._unsetSlot(i.position);
  });
  n.on("itemModified", function (t) {
    t.position !== w.notEquipped && e._setSlot(t.position, t);
  });
  n.on("listUpdate", function () {
    e.setEquipment();
  });
  i.on("lookUpdate", function (t) {
    e.updateCharacterLook(t);
  });
  i.on("mountRiding", function () {
    i.isRiding ? e._setSlot(w.mount, i.equippedMount) : e._unsetSlot(w.mount);
    e.updateCharacter();
  });
  i.on("setMount", function () {
    i.isRiding && e._setSlot(w.mount, i.equippedMount);
  });
};
n.prototype.displayItem = function (e) {
  this._placeHolder.hide();
  this._itemBox.show();
  e.mountLocation ? this._itemBox.displayMount(e) : this._itemBox.displayItem(e);
};
n.prototype.resetItem = function () {
  this._placeHolder.show();
  this._itemBox.hide();
};
n.prototype.getSlots = function () {
  return this._slots;
};
n.prototype.highlightPossiblePositions = function (e) {
  e = e || [];
  for (var t = 0; t < e.length; t += 1) {
    var i = e[t];
    this._slots[i].addClassNames("selected");
  }
  this.emit("equippableHighlighted", e);
};
n.prototype.removePossiblePositionsHighlight = function () {
  for (var e in this._slots) {
    this._slots[e].delClassNames("selected");
  }
};
!o && i && a(t, e.data) ? s(t, e.data) : window.gui.playerData.inventory.equipItem(e.data.objectUID, this.position);
n.emit("itemDropped", e.data, this.position);
r.addClassNames("pos" + t);
r.position = t;
c.setDroppable(r, ["characterBox", "equipment"], {
  matchPositionOnDrop: !0
});
r.on("drop", i);
r.itemUI = {};
c.setDraggable(r, r.itemUI, "characterBox");
r.on("tap", function () {
  this.data && (this.data.mountLocation || this.data.isInitialised) && (n.displayItem(this.data), n.emit("itemSelect", this.data));
});
r.on("doubletap", o);
c.setDroppable(a, ["equipment"]);
a.on("drop", e);
l(u, {
  repeatDelay: 100
});
u.on("tap", function () {
  a.rotateCharacter(!1);
});
l(p, {
  repeatDelay: 100
});
p.on("tap", function () {
  a.rotateCharacter(!0);
});
i.right1 = s.createChild("div", {
  className: "rightSlotBox1"
});
i.right2 = s.createChild("div", {
  className: "rightSlotBox2"
});
i.bottom = n.createChild("div", {
  className: "bottomSlotBox"
});
this._placeHolder = this.content.createChild("div", {
  className: "itemBoxPlaceHolder",
  text: d("ui.common.selectItem")
});
this._itemBox = this.content.appendChild(new h({
  showTitle: !0,
  showItemActions: !0,
  minRows: 7
}));
i.setData(t);
f.preloadImage("gfx/mounts/" + t.model + ".png", function (e) {
  i.setImage(e);
});
i.setItem(t);
i.itemUI.backgroundImage = i.getImage();
c.enableDrag(i);
n.on("itemMoved", function (t, i, n) {
  n === w.notEquipped ? e._unsetSlot(i) : e._setSlot(n, t);
});
n.on("itemAdded", function (t) {
  t.position !== w.notEquipped && e._setSlot(t.position, t);
});
n.on("itemDeleted", function (t, i) {
  var n = e._itemBox.item;
  n && n === i && e.resetItem();
  i.position !== w.notEquipped && e._unsetSlot(i.position);
});
n.on("itemModified", function (t) {
  t.position !== w.notEquipped && e._setSlot(t.position, t);
});
n.on("listUpdate", function () {
  e.setEquipment();
});
i.on("lookUpdate", function (t) {
  e.updateCharacterLook(t);
});
i.on("mountRiding", function () {
  i.isRiding ? e._setSlot(w.mount, i.equippedMount) : e._unsetSlot(w.mount);
  e.updateCharacter();
});
i.on("setMount", function () {
  i.isRiding && e._setSlot(w.mount, i.equippedMount);
});
n && n === i && e.resetItem();
i.position !== w.notEquipped && e._unsetSlot(i.position);
i.isRiding ? e._setSlot(w.mount, i.equippedMount) : e._unsetSlot(w.mount);
e.updateCharacter();
this._placeHolder.hide();
this._itemBox.show();
e.mountLocation ? this._itemBox.displayMount(e) : this._itemBox.displayItem(e);
this._placeHolder.show();
this._itemBox.hide();
this.once("open", function () {
  e.setupContainer1();
  e.setupContainer2();
  e.setupContainer3();
});
this.on("open", function () {
  e.resetFilterData();
});
this.on("close", function () {
  e.table.clearContent();
  h.close("estateInformation");
});
this.setupSocketEvents();
e.setupContainer1();
e.setupContainer2();
e.setupContainer3();
e.table.clearContent();
h.close("estateInformation");
i[e[o].modelId] = !0;
n[e[o].subAreaId] = !0;
r(n, l);
e.exports = n;
n.prototype.setupRoomSelector = function () {
  var e = this,
    t = 4;
  this.roomSelector.addOption(g("ui.estate.filter.atLeastNbRoom"), 0);
  for (var i = 1; i <= t; i++) {
    this.roomSelector.addOption(g("ui.estate.filter.nbRoom", i), i);
  }
  this.roomSelector.on("change", function (t) {
    e.houseToSellFilter.atLeastNbRoom = parseInt(t, 10);
  });
};
n.prototype.setupChestSelector = function () {
  var e = this,
    t = 4;
  this.chestSelector.addOption(g("ui.estate.filter.atLeastNbChest"), 0);
  for (var i = 1; i <= t; i++) {
    this.chestSelector.addOption(g("ui.estate.filter.nbChest", i), i);
  }
  this.chestSelector.on("change", function (t) {
    e.houseToSellFilter.atLeastNbChest = parseInt(t, 10);
  });
};
n.prototype.setupMountSelector = function () {
  var e = this,
    t = 20,
    i = 5;
  this.mountSelector.addOption(g("ui.estate.filter.atLeastNbMount"), 0);
  for (var n = i; n <= t; n += i) {
    this.mountSelector.addOption(g("ui.estate.filter.nbMount", n), n);
  }
  this.mountSelector.on("change", function (t) {
    e.paddockToSellFilter.atLeastNbMount = parseInt(t, 10);
  });
};
n.prototype.setupBreedingSelector = function () {
  var e = this,
    t = 20,
    i = 5;
  this.breedingSelector.addOption(g("ui.estate.filter.atLeastNbMachine"), 0);
  for (var n = i; n <= t; n += i) {
    this.breedingSelector.addOption(g("ui.estate.filter.nbMachine", n), n);
  }
  this.breedingSelector.on("change", function (t) {
    e.paddockToSellFilter.atLeastNbMachine = parseInt(t, 10);
  });
};
n.prototype.setupHousingAreaSelector = function () {
  var e = this;
  this.housingAreaSelector.addOption(g("ui.estate.filter.areaRequested"), -1);
  for (var t = f.getAreasWithHouseOrPaddock("house"), i = 0; i < t.length; i++) {
    e.housingAreaSelector.addOption(t[i].nameId, t[i].id);
  }
  this.housingAreaSelector.on("change", function (t) {
    e.houseToSellFilter.areaId = parseInt(t, 10);
  });
};
n.prototype.setupPaddockAreaSelector = function () {
  var e = this;
  this.paddocksAreaSelector.addOption(g("ui.estate.filter.areaRequested"), -1);
  for (var t = f.getAreasWithHouseOrPaddock("paddock"), i = 0; i < t.length; i++) {
    e.paddocksAreaSelector.addOption(t[i].nameId, t[i].id);
  }
  this.paddocksAreaSelector.on("change", function (t) {
    e.paddockToSellFilter.areaId = parseInt(t, 10);
  });
};
n.prototype.setupSkillSelector = function () {
  var e = this;
  this.skillSelector.addOption(g("ui.estate.filter.skillRequested"), 0);
  f.getSkillsAvailableInHouse(function (t, i) {
    if (t) {
      return console.error("Failed to retrieve skill list", t);
    }
    for (var n = 0; n < i.length; n++) {
      e.skillSelector.addOption(i[n].nameId, i[n].id);
    }
  });
  this.skillSelector.on("change", function (t) {
    e.houseToSellFilter.skillRequested = parseInt(t, 10);
  });
};
n.prototype.changeDialogType = function (e) {
  this.dialogType = e;
  "house" === e ? (this.roomSelector.show(), this.chestSelector.show(), this.housingAreaSelector.show(), this.skillSelector.show(), this.mountSelector.hide(), this.breedingSelector.hide(), this.paddocksAreaSelector.hide()) : (this.roomSelector.hide(), this.chestSelector.hide(), this.housingAreaSelector.hide(), this.skillSelector.hide(), this.mountSelector.show(), this.breedingSelector.show(), this.paddocksAreaSelector.show());
};
n.prototype.setupContainer1 = function () {
  var e = this,
    t = this.windowBody.createChild("div", {
      className: "container1"
    });
  t.createChild("div", {
    className: ["text", "inline"],
    text: g("ui.estate.typeChoice")
  });
  this.propertySelector = t.appendChild(new m({
    className: "propertySelector"
  }));
  this.propertySelector.addOption(g("ui.common.housesWord"), "house");
  this.propertySelector.addOption(g("ui.common.mountPark"), "paddock");
  this.propertySelector.on("change", function (t) {
    e.changeDialogType(t);
    e.searchButton.emit("tap");
  });
};
n.prototype.setupContainer2 = function () {
  var e = this,
    t = this.windowBody.createChild("div", {
      className: ["wrapper", "container2"]
    });
  t.createChild("div", {
    className: "text",
    text: g("ui.search.criteria")
  });
  var i = t.createChild("div", {
    className: "priceContainer"
  });
  i.createChild("div", {
    className: ["text", "inline"],
    text: g("ui.estate.filter.maxPrice")
  });
  var n = i.createChild("div", {
    className: "inputContainer"
  });
  this.priceInput = n.appendChild(new d({
    minValue: 0,
    title: g("ui.estate.filter.maxPrice")
  }));
  n.createChild("div", {
    className: "kamaUnit",
    text: g("ui.common.short.kama")
  });
  var o = t.createChild("div", {
    className: "col1"
  });
  this.roomSelector = o.appendChild(new m({
    className: "roomSelector"
  }));
  this.setupRoomSelector();
  this.chestSelector = o.appendChild(new m({
    className: "chestsSelector"
  }));
  this.setupChestSelector();
  this.mountSelector = o.appendChild(new m({
    className: "mountsSelector"
  }));
  this.setupMountSelector();
  this.breedingSelector = o.appendChild(new m({
    className: "breedingSelector"
  }));
  this.setupBreedingSelector();
  this.housingAreaSelector = o.appendChild(new m({
    className: "areaSelector"
  }));
  this.setupHousingAreaSelector();
  this.paddocksAreaSelector = o.appendChild(new m({
    className: "areaSelector"
  }));
  this.setupPaddockAreaSelector();
  this.skillSelector = o.appendChild(new m({
    className: "skillSelector"
  }));
  this.setupSkillSelector();
  this.searchButton = t.appendChild(new c(g("ui.search.search"), {
    className: ["searchButton", "inline"]
  }));
  this.searchButton.on("tap", function () {
    var t = e.priceInput.getValue();
    return "house" === e.dialogType ? (e.houseToSellFilter.maxPrice = t, window.dofus.sendMessage("HouseToSellFilterMessage", e.houseToSellFilter), void window.dofus.sendMessage("HouseToSellListRequestMessage", {
      pageIndex: 1
    })) : (e.paddockToSellFilter.maxPrice = t, window.dofus.sendMessage("PaddockToSellFilterMessage", e.paddockToSellFilter), void window.dofus.sendMessage("PaddockToSellListRequestMessage", {
      pageIndex: 1
    }));
  });
};
n.prototype.setupContainer3 = function () {
  function e(e) {
    var t = new c("", {
      className: "info"
    });
    return t.data = e.button, t.on("tap", s), t;
  }
  var t = this,
    i = this.windowBody.createChild("div", {
      className: ["wrapper", "container3"]
    }),
    n = [{
      id: "name",
      header: g("ui.common.name"),
      sort: !0
    }, {
      id: "subarea",
      header: g("ui.map.subarea"),
      sort: !0
    }, {
      id: "price",
      header: g("ui.common.price"),
      sort: !0
    }, {
      id: "button",
      format: e
    }],
    o = {
      clickable: !1
    };
  this.table = i.appendChild(new _(n, null, o));
  var a = i.createChild("div", {
    className: "navigator"
  });
  this.leftButton = a.appendChild(new c("", {
    className: ["leftButton", "inline"]
  }));
  this.pages = a.createChild("div", {
    className: ["pages", "inline"]
  });
  this.rightButton = a.appendChild(new c("", {
    className: ["rightButton", "inline"]
  }));
  this.leftButton.on("tap", function () {
    var e = {
      pageIndex: t.currentPageIndex - 1
    };
    return "house" === t.dialogType ? void window.dofus.sendMessage("HouseToSellListRequestMessage", e) : void window.dofus.sendMessage("PaddockToSellListRequestMessage", e);
  });
  this.rightButton.on("tap", function () {
    var e = {
      pageIndex: t.currentPageIndex + 1
    };
    return "house" === t.dialogType ? void window.dofus.sendMessage("HouseToSellListRequestMessage", e) : void window.dofus.sendMessage("PaddockToSellListRequestMessage", e);
  });
};
n.prototype.updateList = function (e) {
  var t = this;
  this.table.clearContent();
  var i = "house" === t.dialogType ? o : a;
  i(e, function (e, i) {
    if (e) {
      return console.error("Failed to retrieve data", e);
    }
    for (var n = [], o = 0; o < i.length; o++) {
      var a = i[o];
      n.push({
        name: a.name,
        subarea: a.areaName,
        price: a.price,
        button: a
      });
    }
    t.table.addList(n);
  });
};
n.prototype.resetFilterData = function () {
  this.houseToSellFilter = {
    areaId: -1,
    atLeastNbRoom: 0,
    atLeastNbChest: 0,
    skillRequested: 0,
    maxPrice: 0
  };
  this.paddockToSellFilter = {
    areaId: -1,
    atLeastNbMount: 0,
    atLeastNbMachine: 0,
    maxPrice: 0
  };
  this.roomSelector.setValue(0);
  this.chestSelector.setValue(0);
  this.mountSelector.setValue(0);
  this.breedingSelector.setValue(0);
  this.housingAreaSelector.setValue(-1);
  this.paddocksAreaSelector.setValue(-1);
  this.skillSelector.setValue(0);
  this.priceInput.setValue(0);
  window.dofus.sendMessage("HouseToSellFilterMessage", this.houseToSellFilter);
  window.dofus.sendMessage("PaddockToSellFilterMessage", this.paddockToSellFilter);
};
n.prototype.updateDisplay = function (e, t) {
  this.currentPageIndex = t.pageIndex;
  this.currentPageIndex <= 1 ? this.leftButton.disable() : this.leftButton.enable();
  this.currentPageIndex >= t.totalPage ? this.rightButton.disable() : this.rightButton.enable();
  this.pages.setText(t.pageIndex + "/" + t.totalPage);
  this.propertySelector.setValue(e);
  this.changeDialogType(e);
};
n.prototype.setupSocketEvents = function () {
  var e = this;
  window.gui.on("HouseToSellListMessage", function (t) {
    h.openDialog(e.id);
    e.updateDisplay("house", t);
    e.updateList(t.houseList);
  });
  window.gui.on("PaddockToSellListMessage", function (t) {
    h.openDialog(e.id);
    e.updateDisplay("paddock", t);
    e.updateList(t.paddockList);
  });
};
this.skillSelector.addOption(g("ui.estate.filter.skillRequested"), 0);
f.getSkillsAvailableInHouse(function (t, i) {
  if (t) {
    return console.error("Failed to retrieve skill list", t);
  }
  for (var n = 0; n < i.length; n++) {
    e.skillSelector.addOption(i[n].nameId, i[n].id);
  }
});
this.skillSelector.on("change", function (t) {
  e.houseToSellFilter.skillRequested = parseInt(t, 10);
});
this.dialogType = e;
"house" === e ? (this.roomSelector.show(), this.chestSelector.show(), this.housingAreaSelector.show(), this.skillSelector.show(), this.mountSelector.hide(), this.breedingSelector.hide(), this.paddocksAreaSelector.hide()) : (this.roomSelector.hide(), this.chestSelector.hide(), this.housingAreaSelector.hide(), this.skillSelector.hide(), this.mountSelector.show(), this.breedingSelector.show(), this.paddocksAreaSelector.show());
t.createChild("div", {
  className: ["text", "inline"],
  text: g("ui.estate.typeChoice")
});
this.propertySelector = t.appendChild(new m({
  className: "propertySelector"
}));
this.propertySelector.addOption(g("ui.common.housesWord"), "house");
this.propertySelector.addOption(g("ui.common.mountPark"), "paddock");
this.propertySelector.on("change", function (t) {
  e.changeDialogType(t);
  e.searchButton.emit("tap");
});
e.changeDialogType(t);
e.searchButton.emit("tap");
this.priceInput = n.appendChild(new d({
  minValue: 0,
  title: g("ui.estate.filter.maxPrice")
}));
n.createChild("div", {
  className: "kamaUnit",
  text: g("ui.common.short.kama")
});
this.roomSelector = o.appendChild(new m({
  className: "roomSelector"
}));
this.setupRoomSelector();
this.chestSelector = o.appendChild(new m({
  className: "chestsSelector"
}));
this.setupChestSelector();
this.mountSelector = o.appendChild(new m({
  className: "mountsSelector"
}));
this.setupMountSelector();
this.breedingSelector = o.appendChild(new m({
  className: "breedingSelector"
}));
this.setupBreedingSelector();
this.housingAreaSelector = o.appendChild(new m({
  className: "areaSelector"
}));
this.setupHousingAreaSelector();
this.paddocksAreaSelector = o.appendChild(new m({
  className: "areaSelector"
}));
this.setupPaddockAreaSelector();
this.skillSelector = o.appendChild(new m({
  className: "skillSelector"
}));
this.setupSkillSelector();
this.searchButton = t.appendChild(new c(g("ui.search.search"), {
  className: ["searchButton", "inline"]
}));
this.searchButton.on("tap", function () {
  var t = e.priceInput.getValue();
  return "house" === e.dialogType ? (e.houseToSellFilter.maxPrice = t, window.dofus.sendMessage("HouseToSellFilterMessage", e.houseToSellFilter), void window.dofus.sendMessage("HouseToSellListRequestMessage", {
    pageIndex: 1
  })) : (e.paddockToSellFilter.maxPrice = t, window.dofus.sendMessage("PaddockToSellFilterMessage", e.paddockToSellFilter), void window.dofus.sendMessage("PaddockToSellListRequestMessage", {
    pageIndex: 1
  }));
});
this.leftButton = a.appendChild(new c("", {
  className: ["leftButton", "inline"]
}));
this.pages = a.createChild("div", {
  className: ["pages", "inline"]
});
this.rightButton = a.appendChild(new c("", {
  className: ["rightButton", "inline"]
}));
this.leftButton.on("tap", function () {
  var e = {
    pageIndex: t.currentPageIndex - 1
  };
  return "house" === t.dialogType ? void window.dofus.sendMessage("HouseToSellListRequestMessage", e) : void window.dofus.sendMessage("PaddockToSellListRequestMessage", e);
});
this.rightButton.on("tap", function () {
  var e = {
    pageIndex: t.currentPageIndex + 1
  };
  return "house" === t.dialogType ? void window.dofus.sendMessage("HouseToSellListRequestMessage", e) : void window.dofus.sendMessage("PaddockToSellListRequestMessage", e);
});
this.houseToSellFilter = {
  areaId: -1,
  atLeastNbRoom: 0,
  atLeastNbChest: 0,
  skillRequested: 0,
  maxPrice: 0
};
this.paddockToSellFilter = {
  areaId: -1,
  atLeastNbMount: 0,
  atLeastNbMachine: 0,
  maxPrice: 0
};
this.roomSelector.setValue(0);
this.chestSelector.setValue(0);
this.mountSelector.setValue(0);
this.breedingSelector.setValue(0);
this.housingAreaSelector.setValue(-1);
this.paddocksAreaSelector.setValue(-1);
this.skillSelector.setValue(0);
this.priceInput.setValue(0);
window.dofus.sendMessage("HouseToSellFilterMessage", this.houseToSellFilter);
window.dofus.sendMessage("PaddockToSellFilterMessage", this.paddockToSellFilter);
this.currentPageIndex = t.pageIndex;
this.currentPageIndex <= 1 ? this.leftButton.disable() : this.leftButton.enable();
this.currentPageIndex >= t.totalPage ? this.rightButton.disable() : this.rightButton.enable();
this.pages.setText(t.pageIndex + "/" + t.totalPage);
this.propertySelector.setValue(e);
this.changeDialogType(e);
window.gui.on("HouseToSellListMessage", function (t) {
  h.openDialog(e.id);
  e.updateDisplay("house", t);
  e.updateList(t.houseList);
});
window.gui.on("PaddockToSellListMessage", function (t) {
  h.openDialog(e.id);
  e.updateDisplay("paddock", t);
  e.updateList(t.paddockList);
});
h.openDialog(e.id);
e.updateDisplay("house", t);
e.updateList(t.houseList);
h.openDialog(e.id);
e.updateDisplay("paddock", t);
e.updateList(t.paddockList);
e.exports.getAreasWithHouseOrPaddock = function (e) {
  var t = "paddock" === e;
  if (a) {
    return t ? s : a;
  }
  var i = window.gui.databases.Areas;
  s = [];
  a = [];
  for (var o in i) {
    var r = i[o];
    if (r.containPaddocks || r.containHouses) {
      var l = {
        id: o,
        nameId: r.nameId
      };
      r.containPaddocks && s.push(l);
      r.containHouses && a.push(l);
    }
  }
  return n.sortObjectInArray(s, "nameId"), n.sortObjectInArray(a, "nameId"), t ? s : a;
};
e.exports.getSkillsAvailableInHouse = function (e) {
  return r ? e(null, r) : void o.getAllDataMap("Skills", function (t, i) {
    if (t) {
      return e(t);
    }
    r = [];
    for (var o in i) {
      var a = i[o];
      a.availableInHouse && r.push({
        id: a.id,
        nameId: a.nameId
      });
    }
    return n.sortObjectInArray(r, "nameId"), e(null, r);
  });
};
s = [];
a = [];
r.containPaddocks && s.push(l);
r.containHouses && a.push(l);
this.worldX = 0;
this.worldY = 0;
this.once("open", function () {
  e.setupDom();
});
this.on("open", function (t) {
  return t ? (e.windowBody.show(), void e.updateData(t)) : void e.windowBody.hide();
});
o(n, r);
e.exports = n;
n.prototype.setupDom = function () {
  var e = this,
    t = this.windowBody.createChild("div", {
      className: ["container", "container1"]
    }),
    i = t.createChild("div", {
      className: "imageContainer"
    });
  this.image = i.createChild("div", {
    className: "image"
  });
  var n = t.createChild("div", {
    className: "houseDetails"
  });
  this.name = n.createChild("div", {
    className: "name"
  });
  var o = n.createChild("div", {
    className: ["textContainer", "price"]
  });
  o.createChild("div", {
    className: "left",
    text: s("ui.common.price")
  });
  this.price = o.createChild("div", {
    className: "right"
  });
  n.createChild("div", {
    className: "message",
    text: s("ui.estate.visit")
  });
  this.roomsContainer = n.createChild("div", {
    className: ["textContainer", "clear"]
  });
  this.roomsContainer.createChild("div", {
    className: "left",
    text: s("ui.estate.nbRoom")
  });
  this.roomCount = this.roomsContainer.createChild("div", {
    className: "right"
  });
  this.chestContainer = n.createChild("div", {
    className: "textContainer"
  });
  this.chestContainer.createChild("div", {
    className: "left",
    text: s("ui.estate.nbChest")
  });
  this.chestCount = this.chestContainer.createChild("div", {
    className: "right"
  });
  this.mountsContainer = n.createChild("div", {
    className: ["textContainer", "clear"]
  });
  this.mountsContainer.createChild("div", {
    className: "left",
    text: s("ui.estate.nbMount")
  });
  this.mountCount = this.mountsContainer.createChild("div", {
    className: "right"
  });
  this.breedingContainer = n.createChild("div", {
    className: "textContainer"
  });
  this.breedingContainer.createChild("div", {
    className: "left",
    text: s("ui.estate.nbMachine")
  });
  this.breedingCount = this.breedingContainer.createChild("div", {
    className: "right"
  });
  this.skills = n.createChild("div", {
    className: "message"
  });
  var r = this.windowBody.createChild("div", {
      className: ["container", "container2"]
    }),
    c = r.createChild("div", {
      className: "textContainer"
    });
  c.createChild("div", {
    className: ["titleText", "text"],
    text: s("ui.common.localisation")
  });
  this.coordinate = c.createChild("div", {
    className: "text"
  });
  var d = c.appendChild(new a("", {
    className: "positionBtn"
  }));
  this.locationName = r.createChild("div", {
    className: "locationName"
  });
  var u = this.windowBody.createChild("div", {
      className: ["container", "container3"]
    }),
    h = u.createChild("div", {
      className: "textContainer"
    });
  h.createChild("div", {
    className: ["titleText", "text"],
    text: s("ui.common.ownerWord")
  });
  this.ownerName = h.createChild("div", {
    className: "text"
  });
  this.ownerStatus = h.createChild("div", {
    className: "text"
  });
  this.chatButton = h.appendChild(new a("", {
    className: "chatBtn"
  }));
  d.on("tap", function () {
    isNaN(e.worldX) || isNaN(e.worldY) || (window.gui.emit("CompassUpdateMessage", {
      type: "estate",
      worldX: e.worldX,
      worldY: e.worldY,
      name: e.nameTxt
    }), l.open("worldMap", {
      x: e.worldX,
      y: e.worldY
    }));
  });
  this.chatButton.on("tap", function () {
    window.gui.chat.startPrivateMessage(e.ownerName.getText(), !0);
  });
};
n.prototype.updateData = function (e) {
  var t = this;
  if (this.worldX = e.worldX, this.worldY = e.worldY, this.price.setText(e.price), this.coordinate.setText(e.worldX + "," + e.worldY), this.ownerName.setText("?" === e.ownerName ? s("ui.common.none") : e.ownerName), "?" !== e.ownerName && e.hasOwnProperty("ownerConnected")) {
    var i = s(e.ownerConnected ? "ui.server.state.online" : "ui.server.state.offline");
    this.ownerStatus.setText(" (" + i + ")");
  } else {
    this.ownerStatus.setText("");
  }
  this.locationName.setText(e.areaName + " ( " + e.subAreaName + " )");
  this.chatButton.toggleDisplay("?" !== e.ownerName && e.ownerConnected);
  var n = "gfx/illusUi/enclos_tx_illuEnclos.png",
    o = "house" === e.type ? "gfx/houses/" + e.gfxId + ".png" : n;
  if (this.image.setStyle("backgroundImage", "none"), c.preloadImage(o, function (e) {
    t.image.setStyle("backgroundImage", e);
  }), "house" === e.type) {
    this.mountsContainer.hide();
    this.breedingContainer.hide();
    this.roomsContainer.show();
    this.chestContainer.show();
    this.nameTxt = e.name;
    this.name.setText(e.name);
    this.roomCount.setText(e.rooms);
    this.chestCount.setText(e.chests);
    var a;
    return a = e.skillsCount > 0 ? s("ui.estate.houseSkills", e.skillsCount) : s("ui.estate.noSkill"), this.skills.setText(a), void this.skills.show();
  }
  this.nameTxt = s("ui.common.mountPark");
  this.name.setText(s("ui.common.mountPark"));
  this.skills.hide();
  this.roomsContainer.hide();
  this.chestContainer.hide();
  this.mountsContainer.show();
  this.breedingContainer.show();
  this.mountCount.setText(e.mounts);
  this.breedingCount.setText(e.objects);
};
o.createChild("div", {
  className: "left",
  text: s("ui.common.price")
});
this.price = o.createChild("div", {
  className: "right"
});
n.createChild("div", {
  className: "message",
  text: s("ui.estate.visit")
});
this.roomsContainer = n.createChild("div", {
  className: ["textContainer", "clear"]
});
this.roomsContainer.createChild("div", {
  className: "left",
  text: s("ui.estate.nbRoom")
});
this.roomCount = this.roomsContainer.createChild("div", {
  className: "right"
});
this.chestContainer = n.createChild("div", {
  className: "textContainer"
});
this.chestContainer.createChild("div", {
  className: "left",
  text: s("ui.estate.nbChest")
});
this.chestCount = this.chestContainer.createChild("div", {
  className: "right"
});
this.mountsContainer = n.createChild("div", {
  className: ["textContainer", "clear"]
});
this.mountsContainer.createChild("div", {
  className: "left",
  text: s("ui.estate.nbMount")
});
this.mountCount = this.mountsContainer.createChild("div", {
  className: "right"
});
this.breedingContainer = n.createChild("div", {
  className: "textContainer"
});
this.breedingContainer.createChild("div", {
  className: "left",
  text: s("ui.estate.nbMachine")
});
this.breedingCount = this.breedingContainer.createChild("div", {
  className: "right"
});
this.skills = n.createChild("div", {
  className: "message"
});
c.createChild("div", {
  className: ["titleText", "text"],
  text: s("ui.common.localisation")
});
this.coordinate = c.createChild("div", {
  className: "text"
});
h.createChild("div", {
  className: ["titleText", "text"],
  text: s("ui.common.ownerWord")
});
this.ownerName = h.createChild("div", {
  className: "text"
});
this.ownerStatus = h.createChild("div", {
  className: "text"
});
this.chatButton = h.appendChild(new a("", {
  className: "chatBtn"
}));
d.on("tap", function () {
  isNaN(e.worldX) || isNaN(e.worldY) || (window.gui.emit("CompassUpdateMessage", {
    type: "estate",
    worldX: e.worldX,
    worldY: e.worldY,
    name: e.nameTxt
  }), l.open("worldMap", {
    x: e.worldX,
    y: e.worldY
  }));
});
this.chatButton.on("tap", function () {
  window.gui.chat.startPrivateMessage(e.ownerName.getText(), !0);
});
this.locationName.setText(e.areaName + " ( " + e.subAreaName + " )");
this.chatButton.toggleDisplay("?" !== e.ownerName && e.ownerConnected);
this.mountsContainer.hide();
this.breedingContainer.hide();
this.roomsContainer.show();
this.chestContainer.show();
this.nameTxt = e.name;
this.name.setText(e.name);
this.roomCount.setText(e.rooms);
this.chestCount.setText(e.chests);
this.nameTxt = s("ui.common.mountPark");
this.name.setText(s("ui.common.mountPark"));
this.skills.hide();
this.roomsContainer.hide();
this.chestContainer.hide();
this.mountsContainer.show();
this.breedingContainer.show();
this.mountCount.setText(e.mounts);
this.breedingCount.setText(e.objects);
this.once("open", function () {
  function t(e, t) {
    var i = e.outcome,
      n = [];
    if (i === v.RESULT_LOST || i === v.RESULT_VICTORY ? (n.push("outcome", "outcome" + i), t.addClassNames("title")) : "dead" === i && n.push(i), n.length) {
      return new f("div", {
        className: n
      });
    }
  }
  function i(e) {
    var t = e.name,
      i = new f("div", {
        className: "nameBox"
      });
    if (i.createChild("div", {
      className: "nameText",
      text: t
    }), o(e)) {
      i.createChild("div", {
        className: "isMeArrow"
      });
    } else if (e.beFriend) {
      var n = i.appendChild(new I({
        className: ["addFriend", "Button", "scaleOnPress"]
      }));
      n.on("tap", function () {
        window.gui.openConfirmPopup({
          title: w("ui.popup.warning"),
          message: w("ui.social.confirmAddFriend", t),
          cb: function (e) {
            e && (window.dofus.sendMessage("FriendAddRequestMessage", {
              name: t
            }), n.hide());
          }
        });
      });
    }
    return i;
  }
  function n(e) {
    var t = "";
    return e.showExperienceFightDelta && (t += w("ui.fightend.xp") + w("ui.common.colon") + M.intToString(e.experienceFightDelta), e.isIncarnationExperience && (t += " (" + w("ui.common.incarnation") + ")")), e.showExperienceForGuild && (t += "\n" + w("ui.common.guild") + w("ui.common.colon") + M.intToString(e.experienceForGuild)), e.showExperienceForMount && (t += "\n" + w("ui.common.ride") + w("ui.common.colon") + M.intToString(e.experienceForMount)), t;
  }
  function c(e) {
    var t = o(e),
      i = e.additional || [];
    if (i.length && i[0]) {
      var s = i[0],
        r = s.experienceFightDelta,
        c = s.experienceLevelFloor,
        u = s.experience - c,
        h = s.experienceNextLevelFloor - c,
        p = Math.floor(r * (d.BONUS_PACK_XP / 100)),
        m = t && p > 1 && !window.gui.playerData.isSubscriberAtMinLevel(A.NORMAL),
        _ = Math.max(0, (u - r) / h),
        v = u / h,
        y = m ? (u + p) / h : 0,
        b = new f("div", {
          className: "xpBox"
        }),
        T = b.appendChild(new g({
          valueClassNames: ["oldXp", "gainedXp", "extraXp"]
        }));
      t ? (T.setValues([_, v, y]), y >= 1 && T.createChild("div", {
        className: "reached100"
      })) : T.setValues([_, v]);
      var C = Math.floor(100 * v) + "% (" + M.intToString(u) + " / " + M.intToString(h) + ")";
      l.addTooltip(T, C, {
        longTapExplanation: !0
      });
      var I = b.createChild("div", {
          className: "underGauge"
        }),
        S = I.createChild("div", {
          className: "xpTextDiv"
        });
      if (S.createChild("div", {
        className: "gainedXpText",
        text: M.intToString(r)
      }), m) {
        var E = S.createChild("div", {
            className: "extraXpDiv"
          }),
          N = M.intToString(p),
          x = w("tablet.shop.xpBonusPoints", N);
        E.createChild("div", {
          className: "ifBonusPack",
          text: " + " + N
        });
        E.createChild("div", {
          className: "unlockIcon"
        });
        l.addTooltip(b, x);
        b.on("tap", a);
        b.getMorePointsMsg = x;
      } else {
        l.addTooltip(S, n(s));
      }
      var L = s.rerollExperienceMul;
      if (L > 1) {
        I.addClassNames("withXpBonusIcon");
        var O = I.createChild("div", {
          className: ["xpBonusIcon", "bonus" + L]
        });
        l.addTooltip(O, w("ui.common.experiencePoint") + " x " + L + "\n\n" + w("ui.information.xpFamilyBonus"));
      }
      return b;
    }
  }
  function u(e) {
    var t = e.drops || [];
    if (t.length) {
      for (var i, n, o = [], a = {}, s = 0; s < t.length; s += 1) {
        s % 2 === 0 && (i = t[s], n = t[s + 1] || 0, o.push(i), a[i] = n);
      }
      if (o.length) {
        var r = new f("div", {
          className: ["dropRow", "spinner"]
        });
        return y(o, function (t, i) {
          if (t) {
            return console.warn("Error while getting items", t);
          }
          if (r.rootElement) {
            i.sort(function (e, t) {
              var i = e.averagePrice * a[e.id],
                n = t.averagePrice * a[t.id];
              return n - i;
            });
            var n, o;
            for (n = 0; n < i.length && (o = i[n], n !== E); n += 1) {
              r.appendChild(new T({
                itemData: o,
                quantity: a[o.id],
                tooltipOptions: {
                  openOnTap: !0
                }
              }));
            }
            if (i.length > E) {
              var s = r.appendChild(new I({
                  className: "moreButton"
                }, function () {
                  _.getWindow("fightEndRewards").updateContent(e.name, i, a);
                  _.open("fightEndRewards");
                })),
                c = "";
              for (n = 0; n < i.length; n += 1) {
                o = i[n];
                c += a[o.id] + " x " + o.nameId + "\n";
              }
              l.addTooltip(s, c);
            }
            r.delClassNames("spinner");
          }
        }), r;
      }
    }
  }
  s = {
    0: w("ui.fightend.losers"),
    2: w("ui.fightend.winners"),
    5: w("ui.common.taxCollector")
  };
  r = {
    0: w("ui.fightend.loss"),
    2: w("ui.fightend.victory")
  };
  e.summary = e.windowBody.createChild("div", {
    className: "summary"
  });
  var h = e.summary.createChild("div", {
      className: ["summaryBlock", "block1"]
    }),
    p = e.summary.createChild("div", {
      className: ["summaryBlock", "block2"]
    });
  e.block3 = e.summary.createChild("div", {
    className: ["summaryBlock", "block3"]
  });
  e.outcomeSummary = h.createChild("div", {
    className: "outcomeSummary"
  });
  var m = p.createChild("div", {
    className: "labels"
  });
  m.createChild("div", {
    text: w("ui.fightend.duration") + w("ui.common.colon")
  });
  m.createChild("div", {
    text: w("ui.fightend.bonus") + w("ui.common.colon")
  });
  var S = p.createChild("div", {
    className: "values"
  });
  e.duration = S.createChild("div", {
    className: "duration"
  });
  e.starCounter = S.appendChild(new b());
  l.addTooltip(e.starCounter, function () {
    var t = e.ageBonus || 0;
    return t ? w("ui.fightend.bonus") + w("ui.common.colon") + t + "%" : w("ui.fightend.noBonus");
  }, {
    longTapExplanation: !0
  });
  e.table = e.windowBody.appendChild(new C([{
    id: "icon",
    format: t
  }, {
    id: "name",
    header: w("ui.common.name"),
    format: i
  }, {
    id: "level",
    header: w("ui.common.short.level")
  }, {
    id: "xp",
    header: w("ui.fightend.xp"),
    format: c
  }, {
    id: "kamas",
    header: w("ui.common.kamas")
  }, {
    id: "drops",
    header: w("ui.fightend.objects"),
    format: u
  }], null, {
    clickable: !1
  }));
});
this.on("open", function (t) {
  e._updateResultList(t.msg, t.fighters);
  e._resize();
});
this.on("close", function () {
  p.closeNotifications();
  e._reset();
});
E.createChild("div", {
  className: "ifBonusPack",
  text: " + " + N
});
E.createChild("div", {
  className: "unlockIcon"
});
l.addTooltip(b, x);
b.on("tap", a);
b.getMorePointsMsg = x;
_.getWindow("fightEndRewards").updateContent(e.name, i, a);
_.open("fightEndRewards");
o = i[n];
c += a[o.id] + " x " + o.nameId + "\n";
s = {
  0: w("ui.fightend.losers"),
  2: w("ui.fightend.winners"),
  5: w("ui.common.taxCollector")
};
r = {
  0: w("ui.fightend.loss"),
  2: w("ui.fightend.victory")
};
e.summary = e.windowBody.createChild("div", {
  className: "summary"
});
e.block3 = e.summary.createChild("div", {
  className: ["summaryBlock", "block3"]
});
e.outcomeSummary = h.createChild("div", {
  className: "outcomeSummary"
});
m.createChild("div", {
  text: w("ui.fightend.duration") + w("ui.common.colon")
});
m.createChild("div", {
  text: w("ui.fightend.bonus") + w("ui.common.colon")
});
e.duration = S.createChild("div", {
  className: "duration"
});
e.starCounter = S.appendChild(new b());
l.addTooltip(e.starCounter, function () {
  var t = e.ageBonus || 0;
  return t ? w("ui.fightend.bonus") + w("ui.common.colon") + t + "%" : w("ui.fightend.noBonus");
}, {
  longTapExplanation: !0
});
e.table = e.windowBody.appendChild(new C([{
  id: "icon",
  format: t
}, {
  id: "name",
  header: w("ui.common.name"),
  format: i
}, {
  id: "level",
  header: w("ui.common.short.level")
}, {
  id: "xp",
  header: w("ui.fightend.xp"),
  format: c
}, {
  id: "kamas",
  header: w("ui.common.kamas")
}, {
  id: "drops",
  header: w("ui.fightend.objects"),
  format: u
}], null, {
  clickable: !1
}));
e._updateResultList(t.msg, t.fighters);
e._resize();
p.closeNotifications();
e._reset();
i.createChild("div", {
  className: "text",
  text: w("tablet.shop.getBonusPack")
});
i.createChild("div", {
  className: "icon"
});
i.on("tap", function () {
  _.open("market", {
    tabId: "shop",
    tabParams: {
      category: "bonuspack"
    }
  });
});
p.showClosableNotification(t, this);
h(n, m);
e.exports = n;
n.prototype.addChallenge = function (e, t, i, n, o, a, s) {
  function r() {
    var e = [805, 815],
      t = window.gui.playerData.position.subArea,
      i = t && t.id,
      n = e.indexOf(i) !== -1;
    return s && n;
  }
  function c() {
    h.clearContent();
    h.createChild("div", {
      className: "challengeName",
      text: i
    });
    h.createChild("div", {
      className: "challengeDesc",
      text: n
    });
    h.createChild("div", {
      className: "challengeLoot",
      text: w("ui.common.loot") + " +" + o + "%"
    });
    h.createChild("div", {
      className: "challengeXp",
      text: w("ui.common.xp") + " +" + a + "%"
    });
    r() && h.createChild("div", {
      className: "challengePoints",
      text: s + " " + w("ui.common.point", s)
    });
    var e = h.createChild("div", {
      className: "challengeStatus"
    });
    return t ? (e.addClassNames("success"), e.setText(w("ui.fight.challenge.complete"))) : (e.addClassNames("fail"), e.setText(w("ui.fight.challenge.failed"))), h;
  }
  var d = this.block3.createChild("div", {
      className: ["challenge", t ? "success" : "fail"]
    }),
    u = d.createChild("div", {
      className: "challengeIcon"
    });
  u.setStyle("backgroundImage", e);
  var h = new f("div", {
    className: "challengeDetails",
    name: "challengeDetails"
  });
  l.addTooltip(d, c, {
    longTapExplanation: !0
  });
};
n.prototype._updateResultList = function (e, t) {
  var i = M.durationToString(e.duration / 1e3),
    n = " (" + w("ui.fight.turnCount", window.gui.fightManager.getTurnCount() + 1) + ")";
  this.duration.setText(i + n);
  this.ageBonus = e.ageBonus || 0;
  this.starCounter.setValue(e.ageBonus);
  var o = window.gui.challengeIndicator.iconDetailsListByChallengeId;
  for (var a in o) {
    this.addChallenge(o[a].iconUrl, o[a].success, o[a].name, o[a].description, o[a].dropBonus, o[a].xpBonus, o[a].points);
  }
  M.sortObjectInArray(e.results, "outcome", !0);
  for (var l, d, u, h = [], p = [], m = 0; m < e.results.length; m += 1) {
    if (l = e.results[m], d = l.id, u = l.outcome, u !== v.RESULT_DEFENDER_GROUP) {
      if (d === window.gui.playerData.id) {
        this.outcomeSummary.setText(r[u] || "");
        var f = S[u];
        if (f && c.playSound("ui", f), u === v.RESULT_VICTORY) {
          var g = void 0 !== e.score && null !== e.score ? e.score : -1;
          g > -1 && window.gui.openPopup({
            title: w("ui.common.score"),
            message: w("tablet.toa.scoreInChat", g)
          });
        }
      }
      h[u] || (p.push({
        outcome: u,
        name: s[u]
      }), h[u] = !0);
      var _ = t[d];
      if (_) {
        var y = _.name,
          b = window.gui.playerData.socialData.friendsList,
          T = d > 0;
        for (var C in b) {
          var I = b[C].playerId;
          if (I === d) {
            T = !1;
            break;
          }
        }
        p.push({
          id: l.id,
          outcome: l.alive ? "" : "dead",
          name: y,
          beFriend: T,
          level: l.level || t[l.id].level,
          additional: l.additional,
          kamas: M.intToString(l.rewards.kamas),
          drops: l.rewards.objects
        });
      }
    } else {
      console.warn("Hardcode loots not handled (skipped)", l.rewards);
    }
  }
  this.table.addList(p);
};
n.prototype._resize = function () {
  var e = this.table,
    t = e.rows.rootElement.offsetHeight,
    i = e.header.rootElement.offsetHeight,
    n = 123,
    o = Math.round(u.windowFullScreenHeight * N / 100),
    a = t + i + n;
  a = a < o ? a : o;
  _.positionWindow(this.id, {
    left: "c",
    top: "c",
    width: this.position.width,
    height: a,
    minHeight: 361
  });
  e.scroller.refresh();
  var s = window.device;
  s && "iOS" === s.platform && 0 === s.version.indexOf("10.") && (this.hide(), M.forceReflow(this), this.show());
};
n.prototype._reset = function () {
  this.block3.clearContent();
  this.table.clearContent();
};
h.clearContent();
h.createChild("div", {
  className: "challengeName",
  text: i
});
h.createChild("div", {
  className: "challengeDesc",
  text: n
});
h.createChild("div", {
  className: "challengeLoot",
  text: w("ui.common.loot") + " +" + o + "%"
});
h.createChild("div", {
  className: "challengeXp",
  text: w("ui.common.xp") + " +" + a + "%"
});
r() && h.createChild("div", {
  className: "challengePoints",
  text: s + " " + w("ui.common.point", s)
});
this.duration.setText(i + n);
this.ageBonus = e.ageBonus || 0;
this.starCounter.setValue(e.ageBonus);
a = a < o ? a : o;
_.positionWindow(this.id, {
  left: "c",
  top: "c",
  width: this.position.width,
  height: a,
  minHeight: 361
});
e.scroller.refresh();
this.block3.clearContent();
this.table.clearContent();
e = e || {};
this.isVertical = e.vertical || !1;
this.pixelValue = 1 / p;
this.hasTriedToGetPixelValue = !1;
this.shouldGetPixelValue = !1;
this.mustRecompute = !1;
c.call(this, "div", {
  className: "ProgressBarMultiple",
  name: e.name
});
this.barBg = this.createChild("div", {
  className: "barBg"
});
this.currentValues = [];
this.previousValues = [];
this.colorBars = [];
this.maskSizes = [];
this.currentValues[i] = this.previousValues[i] = 0;
this.colorBars[i] = this._newColorBar(t[i]);
e.tooltip && (this.tooltipText = e.tooltip, r.addTooltip(this, this._tooltipHandler.bind(this)));
this.on("destroy", function () {
  this.tweener && this.tweener.cancel();
  this.colorBars = null;
});
this.tweener && this.tweener.cancel();
this.colorBars = null;
s(n, c);
e.exports = n;
n.prototype._newColorBar = function (e) {
  var t = this.createChild("div", {
    className: "barFill"
  });
  return this.isVertical && t.addClassNames("vertical"), t.createChild("div", {
    className: ["barColor", e]
  }), t;
};
n.prototype.setValue = function (e, t, i) {
  this.maxValue = t;
  this._setGaugeLogicalValue(d, e, i);
  this._computeGaugePhysicalValue(d);
  this.shouldGetPixelValue ? this._tryAndGetPixelValue(this._refresh) : this._refresh();
};
n.prototype._setGaugeLogicalValue = function (e, t, i) {
  this.maxValue ? (e === d && (this.humanValue = t), void 0 !== i ? t = i : t /= this.maxValue) : e === d && (this.humanValue = Math.round(100 * t));
  this.currentValues[e] = t;
};
n.prototype._computeGaugePhysicalValue = function (e) {
  var t = this.currentValues[e],
    i = e ? this.currentValues[e - 1] : 0,
    n = u * this.pixelValue,
    o = t > i && t - i < n,
    a = t < 1 && 1 - t < n;
  !o && !a || this.hasTriedToGetPixelValue || (this.shouldGetPixelValue = !0);
  var s;
  if (o) {
    var r = u + (0 === i ? h : 0);
    s = "calc(" + Math.round(100 * i) + "% + " + r + "px)";
  } else {
    s = a ? "calc(100% - " + (u + h) + "px)" : Math.round(100 * t) + "%";
  }
  this.maskSizes[e] = s;
};
n.prototype._tryAndGetPixelValue = function (e) {
  this.shouldGetPixelValue = !1;
  window.setTimeout(function (t) {
    if (t.colorBars) {
      var i = t.colorBars[0].rootElement,
        n = t.isVertical ? i.offsetHeight : i.offsetWidth;
      0 !== n && (t.pixelValue = 1 / n, t.mustRecompute = !0);
      t.hasTriedToGetPixelValue = !0;
      e.call(t);
    }
  }, 50, this);
};
n.prototype._getMaskSizeStyle = function (e) {
  return "0%" === e && (e = "1px"), this.isVertical ? "100% " + e : e + " 100%";
};
n.prototype._setColorBarPos = function (e, t) {
  e.setStyle(m, this._getMaskSizeStyle(t));
};
n.prototype._tooltipHandler = function () {
  var e = this.tooltipText + o("ui.common.colon");
  return this.maxValue ? e + this.humanValue + " / " + this.maxValue : e + this.humanValue + "%";
};
n.prototype.setValues = function (e) {
  for (var t = 0; t < this.colorBars.length; t++) {
    this._setGaugeLogicalValue(t, Math.max(Math.min(e[t] || 0, 1), 0));
    this._computeGaugePhysicalValue(t);
  }
  this.shouldGetPixelValue ? this._tryAndGetPixelValue(this._refresh) : this._refresh();
};
n.prototype._recompute = function () {
  for (var e = 0; e < this.colorBars.length; e++) {
    this._computeGaugePhysicalValue(e);
  }
  this.mustRecompute = !1;
};
n.prototype._refresh = function () {
  this.mustRecompute && this._recompute();
  for (var e = 0; e < this.colorBars.length; e++) {
    this._setColorBarPos(this.colorBars[e], this.maskSizes[e]);
    this.previousValues[e] = this.currentValues[e];
  }
};
n.prototype.setValuesWithAnimation = function (e, t, i) {
  this.animTimeInMs = t;
  for (var n = 0; n < this.colorBars.length; n++) {
    this._setGaugeLogicalValue(n, Math.max(Math.min(e[n] || 0, 1), 0));
    this._computeGaugePhysicalValue(n);
  }
  if (this.shouldGetPixelValue) {
    var o = this;
    return this._tryAndGetPixelValue(function () {
      o._recompute();
      o._startAnim(i);
    });
  }
  this._startAnim(i);
};
n.prototype._startAnim = function (e) {
  this.currentAnimBarIndex = 0;
  this.nextAnimFunc = this.nextAnimFunc || this._startNextAnim.bind(this);
  this.endAnimCb = e;
  this._startNextAnim();
};
n.prototype._startNextAnim = function () {
  if (this.colorBars) {
    var e = this.currentAnimBarIndex;
    this.currentAnimBarIndex++;
    var t = this.colorBars[e],
      i = this.maskSizes[e],
      n = e === this.currentValues.length - 1 ? this.endAnimCb : this.nextAnimFunc,
      o = e >= 1 ? this.currentValues[e - 1] : 0,
      s = Math.max(this.previousValues[e], o),
      r = this.currentValues[e],
      c = this.previousValues[e];
    this.previousValues[e] = r;
    var d = ~~(Math.abs(r - s) * this.animTimeInMs);
    if (d < 15) {
      return this._setColorBarPos(t, i), n && n();
    }
    s !== c && (this._setColorBarPos(t, Math.round(100 * s) + "%"), a.forceReflow(t));
    var u = {};
    u[m] = this._getMaskSizeStyle(i);
    this.tweener = l.tween(t, u, {
      time: d,
      easing: "linear"
    }, n);
  }
};
this.maxValue = t;
this._setGaugeLogicalValue(d, e, i);
this._computeGaugePhysicalValue(d);
this.shouldGetPixelValue ? this._tryAndGetPixelValue(this._refresh) : this._refresh();
this.maxValue ? (e === d && (this.humanValue = t), void 0 !== i ? t = i : t /= this.maxValue) : e === d && (this.humanValue = Math.round(100 * t));
this.currentValues[e] = t;
this.shouldGetPixelValue = !1;
window.setTimeout(function (t) {
  if (t.colorBars) {
    var i = t.colorBars[0].rootElement,
      n = t.isVertical ? i.offsetHeight : i.offsetWidth;
    0 !== n && (t.pixelValue = 1 / n, t.mustRecompute = !0);
    t.hasTriedToGetPixelValue = !0;
    e.call(t);
  }
}, 50, this);
0 !== n && (t.pixelValue = 1 / n, t.mustRecompute = !0);
t.hasTriedToGetPixelValue = !0;
e.call(t);
this._setGaugeLogicalValue(t, Math.max(Math.min(e[t] || 0, 1), 0));
this._computeGaugePhysicalValue(t);
this._setColorBarPos(this.colorBars[e], this.maskSizes[e]);
this.previousValues[e] = this.currentValues[e];
this._setGaugeLogicalValue(n, Math.max(Math.min(e[n] || 0, 1), 0));
this._computeGaugePhysicalValue(n);
o._recompute();
o._startAnim(i);
this.currentAnimBarIndex = 0;
this.nextAnimFunc = this.nextAnimFunc || this._startNextAnim.bind(this);
this.endAnimCb = e;
this._startNextAnim();
u[m] = this._getMaskSizeStyle(i);
this.tweener = l.tween(t, u, {
  time: d,
  easing: "linear"
}, n);
t.setStyle("backgroundImage", "none");
v.preloadImage(i, function (e) {
  t.rootElement && t.setStyle("backgroundImage", e);
});
i += 0 === t.teamId ? "G" : "D";
i = "gfx/illusUi/fightersType/spectator_tx_Picto" + i + ".png";
v.preloadImage(i, function (t) {
  e.rootElement && e.setStyle("backgroundImage", t);
});
0 === i.teamId ? n.insertAsFirstChild(o) : n.appendChild(o);
t(o, i);
w(c, t);
w(c, i);
r && s.addTooltip(c, r, {
  longTapExplanation: !1
});
c.appendChild(p);
o.gameFightOptions[u] = p;
window.dofus.sendMessage("GameFightJoinRequestMessage", {
  fightId: q.fightId,
  fighterId: e
});
_.close(U.id);
i();
U.fightListTable.clearContent();
U.col1.table.clearContent();
U.col1.averageLevelContainer.hide();
U.col2.table.clearContent();
U.col2.averageLevelContainer.hide();
A(U.col1);
A(U.col2);
U.col1.joinBtn.disable();
U.col2.joinBtn.disable();
U.buttonSpectate.disable();
q = null;
S();
E();
N();
L(U.col1);
L(U.col2);
O();
0 === e.option && B(e);
q && q.fightId === e.fightId && (P(e.teamId, e.option, e.state), D(e.teamId, e.option, e.state), R());
T(e, d);
r += d.level;
e = e || {};
F(U.col1, e.attackers);
F(U.col2, e.defenders);
r = o(h.fightId);
s = r >= 0 ? U.fightListTable.updateRow(r, p, {
  fight: h
}) : U.fightListTable.addRow(p, {
  fight: h
});
n(s, h.fightStart);
this.once("open", function () {
  this.fightListTable = this.windowBody.appendChild(new m({
    colIds: ["spectatorLocked", "nbPlayers", "level", "duration", "friend"],
    colCount: 4,
    highlightable: !0,
    disableAutoSelect: !0,
    headerContent: ["", h("ui.common.numberOfPlayers"), h("ui.common.level"), h("ui.fightend.duration"), h("ui.common.friends")],
    onRowTap: function (e) {
      q = e.fight;
      W();
    }
  }));
  this.fightListTable.addClassNames("fightListTable");
  var e = this.windowBody.createChild("div", {
    className: "colsWrapper"
  });
  this.col1 = I(0, ["colTeam", "col1"], h("ui.common.attackers"));
  this.col2 = I(1, ["colTeam", "col2"], h("ui.common.defenders"));
  e.appendChild(this.col1);
  e.appendChild(this.col2);
  this.buttonSpectate = new l(h("ui.common.tospectate"), {
    className: "buttonSpectate"
  });
  this.buttonSpectate.on("tap", function () {
    q && q.fightId && (window.dofus.sendMessage("GameFightJoinRequestMessage", {
      fightId: q.fightId,
      fighterId: 0
    }), _.close(U.id));
  });
  this.windowBody.appendChild(this.buttonSpectate);
});
this.on("open", function () {
  x();
  G();
});
this.on("close", function () {
  window.dofus.sendMessage("StopToListenRunningFightRequestMessage");
});
this.fightListTable = this.windowBody.appendChild(new m({
  colIds: ["spectatorLocked", "nbPlayers", "level", "duration", "friend"],
  colCount: 4,
  highlightable: !0,
  disableAutoSelect: !0,
  headerContent: ["", h("ui.common.numberOfPlayers"), h("ui.common.level"), h("ui.fightend.duration"), h("ui.common.friends")],
  onRowTap: function (e) {
    q = e.fight;
    W();
  }
}));
this.fightListTable.addClassNames("fightListTable");
q = e.fight;
W();
this.col1 = I(0, ["colTeam", "col1"], h("ui.common.attackers"));
this.col2 = I(1, ["colTeam", "col2"], h("ui.common.defenders"));
e.appendChild(this.col1);
e.appendChild(this.col2);
this.buttonSpectate = new l(h("ui.common.tospectate"), {
  className: "buttonSpectate"
});
this.buttonSpectate.on("tap", function () {
  q && q.fightId && (window.dofus.sendMessage("GameFightJoinRequestMessage", {
    fightId: q.fightId,
    fighterId: 0
  }), _.close(U.id));
});
this.windowBody.appendChild(this.buttonSpectate);
x();
G();
V.on("MapFightCountMessage", function () {
  U.isVisible() && G();
});
V.on("MapRunningFightListMessage", z);
V.on("MapRunningFightDetailsMessage", function (e) {
  H(e);
  R();
});
V.on("GameRolePlayRemoveChallengeMessage", function () {
  U.isVisible() && G();
});
V.on("GameFightOptionStateUpdateMessage", function (e) {
  U.isVisible() && k(e);
});
V.playerData.position.on("mapChanged", function () {
  _.close(U.id);
});
H(e);
R();
o(n, g);
e.exports = n;
s.call(this, {
  className: "globalWindow",
  title: c("ui.common.mainMenu"),
  positionInfo: {
    left: "c",
    top: "c",
    width: 300,
    height: 235
  }
});
this.once("open", function () {
  this._createContent();
});
this.on("open", function () {
  this._buildVersion.setText(window.gui.getBuildVersion());
  this._setupCharacterChange();
});
this._buildVersion.setText(window.gui.getBuildVersion());
this._setupCharacterChange();
o(n, s);
e.exports = n;
n.prototype._createContent = function () {
  this.buttonOptions = this.windowBody.appendChild(new l(c("ui.common.options")));
  this.buttonOptions.on("tap", function () {
    r.close("global");
    r.open("options");
  });
  this.container = this.windowBody.createChild("div", {
    className: "container"
  });
  this.multiCharacterSelector = new d({
    className: "multiCharacterSelector"
  });
  this.container.appendChild(this.multiCharacterSelector);
  this.multiCharacterSelector.on("change", function (e) {
    a.reconnectByCharId(e);
    r.close("global");
  });
  this.buttonChangeCharacter = this.container.appendChild(new l(c("ui.common.changeCharacter"), {
    className: "changeCharacterButton"
  }));
  this.buttonChangeCharacter.on("tap", function () {
    window.gui.openConfirmPopup({
      title: c("ui.common.confirm"),
      message: c("ui.common.confirmChangeCharacter"),
      cb: function (e) {
        e && (r.close("global"), a.goBackToSelectionOf("character"));
      }
    });
  });
  this.buttonDisconnect = this.windowBody.appendChild(new l(c("ui.common.disconnect")));
  this.buttonDisconnect.on("tap", function () {
    window.gui.openConfirmPopup({
      title: c("ui.common.confirm"),
      message: c("ui.common.confirmDisconnect"),
      cb: function (e) {
        if (e) {
          r.close("global");
          var t = !window.gui.playerData.isModeratorOrMore();
          window.dofus.disconnect();
          !window.developmentMode && t && window.location.reload();
        }
      }
    });
  });
  this.buttonReturnToGame = this.windowBody.appendChild(new l(c("ui.common.returnToGame")));
  this.buttonReturnToGame.on("tap", function () {
    r.close("global");
  });
  this._buildVersion = this.windowBody.createChild("div", {
    className: "buildVersion"
  });
};
n.prototype._setupCharacterChange = function () {
  var e = u.getCharacterList(),
    t = window.gui.playerData.isFighting;
  this.buttonChangeCharacter.setEnable(!t);
  var i = !t && e.length >= 2;
  if (this.multiCharacterSelector.setEnable(i), i) {
    var n = window.gui.databases.Breeds;
    this.multiCharacterSelector.clearContent();
    for (var o = 0; o < e.length; o++) {
      var a = e[o],
        s = a.name + " (" + n[a.breed].shortNameId + " " + a.level + ")";
      this.multiCharacterSelector.addOption(s, a.id);
    }
    var r = !0;
    this.multiCharacterSelector.select(window.gui.playerData.id, r);
  }
};
this.buttonOptions = this.windowBody.appendChild(new l(c("ui.common.options")));
this.buttonOptions.on("tap", function () {
  r.close("global");
  r.open("options");
});
this.container = this.windowBody.createChild("div", {
  className: "container"
});
this.multiCharacterSelector = new d({
  className: "multiCharacterSelector"
});
this.container.appendChild(this.multiCharacterSelector);
this.multiCharacterSelector.on("change", function (e) {
  a.reconnectByCharId(e);
  r.close("global");
});
this.buttonChangeCharacter = this.container.appendChild(new l(c("ui.common.changeCharacter"), {
  className: "changeCharacterButton"
}));
this.buttonChangeCharacter.on("tap", function () {
  window.gui.openConfirmPopup({
    title: c("ui.common.confirm"),
    message: c("ui.common.confirmChangeCharacter"),
    cb: function (e) {
      e && (r.close("global"), a.goBackToSelectionOf("character"));
    }
  });
});
this.buttonDisconnect = this.windowBody.appendChild(new l(c("ui.common.disconnect")));
this.buttonDisconnect.on("tap", function () {
  window.gui.openConfirmPopup({
    title: c("ui.common.confirm"),
    message: c("ui.common.confirmDisconnect"),
    cb: function (e) {
      if (e) {
        r.close("global");
        var t = !window.gui.playerData.isModeratorOrMore();
        window.dofus.disconnect();
        !window.developmentMode && t && window.location.reload();
      }
    }
  });
});
this.buttonReturnToGame = this.windowBody.appendChild(new l(c("ui.common.returnToGame")));
this.buttonReturnToGame.on("tap", function () {
  r.close("global");
});
this._buildVersion = this.windowBody.createChild("div", {
  className: "buildVersion"
});
r.close("global");
r.open("options");
a.reconnectByCharId(e);
r.close("global");
window.dofus.disconnect();
!window.developmentMode && t && window.location.reload();
a.call(this, {
  window: {
    className: "GrimoireWindow",
    positionInfo: {
      top: "c",
      left: "c+20px",
      width: "90%",
      height: "97%",
      maxWidth: 905,
      maxHeight: 620,
      mustAvoidToolbar: !0
    }
  }
});
this.addTab("spells", new p(), s("ui.grimoire.mySpell"));
this.addTab("quests", new h(), s("ui.common.quests"));
this.addTab("alignment", new l(), s("ui.common.alignment"));
this.addTab("jobs", new m(), s("ui.common.myJobs"));
this.addTab("achievements", new c(), s("ui.achievement.achievement"));
this.addTab("ornaments", new u(), s("ui.common.titles"));
this.addTab("bestiary", new d(), s("ui.common.bestiary"));
this.on("open", function (e) {
  this.openTab(e.tabId, e.tabParams, {
    delayOpenedEvent: !0,
    forceOpen: !0
  });
});
window.gui.scenarioManager.on("stepChanged", function () {
  var t = window.gui.scenarioManager.isBehaviourEnabled(r.GRIMOIRE_CLOSE_BTN);
  e.toggleClassName("disableCloseBtn", !t);
});
o(n, a);
e.exports = n;
this.tabs = this.windowBody.appendChild(new c());
this.once("open", this._initTabsListeners);
this.on("open", o);
this.on("opened", function (e) {
  t(e);
});
this.on("close", a);
this.on("focus", function () {
  this.tabs.emitOnCurrentTab("focus");
});
window.gui.on("disconnect", function () {
  i._resetTabs();
  i._initTabs();
});
i._resetTabs();
i._initTabs();
this._initTabs();
window.gui.uiLocker.on("updated", function (t) {
  if (t.windowId === e.id && t.tabId) {
    return e.tabs.getTabsMap()[t.tabId] ? void e.tabs.toggleTabAvailability(t.tabId, !t.locked) : console.error(new Error("Unknown tab id `" + t.tabId + "` in `" + e.id + "` window."));
  }
});
s(n, r);
e.exports = n;
n.prototype.addTab = function (e, t, i) {
  function n() {
    o.setTitle(i);
  }
  if (i = i || "", !e || !t) {
    return console.error("Missing informations to add a tab");
  }
  var o = this,
    a = this.windowBody.appendChild(t);
  a.tabId = e;
  this.tabs.addTab("", a, e);
  a.on("open", n);
};
n.prototype.openTab = function (e, t, i) {
  this.tabs.openTab(e, t, i);
};
n.prototype._initTabs = function () {
  if (this.tabs) {
    for (var e in this.tabs.getTabsMap()) {
      var t = window.gui.uiLocker.isTabAvailable(this.id, e);
      this.tabs.toggleTabAvailability(e, t);
    }
  }
};
n.prototype._resetTabs = function () {
  this.tabs.close();
};
n.prototype.getOpenedTabId = function () {
  return this.tabs.getCurrentTabId();
};
n.prototype._initWindowKPI = function () {};
n.prototype._sendWindowKPI = function () {};
n.prototype._resetWindowKPI = function (e) {
  return e ? void (this._openedTimestampTabs[e] = this._scBalanceWhenOpenTabs[e] = this._hcBalanceWhenOpenTabs[e] = 0) : this._openedTimestamp = this._scBalanceWhenOpen = this._hcBalanceWhenOpen = 0;
};
n.prototype._initTabsListeners = function () {
  if (this.tabs) {
    var e = this,
      t = window.gui.playerData;
    this._openedTimestampTabs = {};
    this._scBalanceWhenOpenTabs = {};
    this._hcBalanceWhenOpenTabs = {};
    this.tabs.tabsOrderIds.forEach(function (i) {
      e.tabs.tabsMap[i].target.on("open", function () {
        e._openedTimestampTabs[i] = l.now();
        e._scBalanceWhenOpenTabs[i] = t.inventory.kamas;
        e._hcBalanceWhenOpenTabs[i] = t.inventory.goultines;
      });
      e.tabs.tabsMap[i].target.on("close", function () {
        e.prepareKPI(i, e._openedTimestampTabs[i], e._scBalanceWhenOpenTabs[i], e._hcBalanceWhenOpenTabs[i]);
        e._resetWindowKPI(i);
      });
    });
  }
};
a.tabId = e;
this.tabs.addTab("", a, e);
a.on("open", n);
this._openedTimestampTabs = {};
this._scBalanceWhenOpenTabs = {};
this._hcBalanceWhenOpenTabs = {};
this.tabs.tabsOrderIds.forEach(function (i) {
  e.tabs.tabsMap[i].target.on("open", function () {
    e._openedTimestampTabs[i] = l.now();
    e._scBalanceWhenOpenTabs[i] = t.inventory.kamas;
    e._hcBalanceWhenOpenTabs[i] = t.inventory.goultines;
  });
  e.tabs.tabsMap[i].target.on("close", function () {
    e.prepareKPI(i, e._openedTimestampTabs[i], e._scBalanceWhenOpenTabs[i], e._hcBalanceWhenOpenTabs[i]);
    e._resetWindowKPI(i);
  });
});
e.tabs.tabsMap[i].target.on("open", function () {
  e._openedTimestampTabs[i] = l.now();
  e._scBalanceWhenOpenTabs[i] = t.inventory.kamas;
  e._hcBalanceWhenOpenTabs[i] = t.inventory.goultines;
});
e.tabs.tabsMap[i].target.on("close", function () {
  e.prepareKPI(i, e._openedTimestampTabs[i], e._scBalanceWhenOpenTabs[i], e._hcBalanceWhenOpenTabs[i]);
  e._resetWindowKPI(i);
});
e._openedTimestampTabs[i] = l.now();
e._scBalanceWhenOpenTabs[i] = t.inventory.kamas;
e._hcBalanceWhenOpenTabs[i] = t.inventory.goultines;
e.prepareKPI(i, e._openedTimestampTabs[i], e._scBalanceWhenOpenTabs[i], e._hcBalanceWhenOpenTabs[i]);
e._resetWindowKPI(i);
a.call(this, {
  className: "WindowSideTabs"
});
this.delClassNames("tabs");
o(n, a);
e.exports = n;
this._setupEvents();
this.once("opened", function () {
  e._createDom();
  e._updateDisplay();
  e.on("open", function () {
    e._updateDisplay();
  });
  e.on("opened", function () {
    e.updateCharacter();
  });
});
this.on("closed", function () {
  this.characterDisplay.release();
});
e._createDom();
e._updateDisplay();
e.on("open", function () {
  e._updateDisplay();
});
e.on("opened", function () {
  e.updateCharacter();
});
o(n, a);
e.exports = n;
n.prototype.updateCharacter = function () {
  var e = m.getLookWithoutPet(window.gui.playerData.characterBaseInformations.entityLook);
  this.characterDisplay.setLook(e, {
    riderOnly: !0,
    direction: u.DIRECTION_SOUTH,
    animation: "AnimStatique",
    boneType: "characters/",
    skinType: "characters/"
  });
};
n.prototype._createDom = function () {
  function e() {
    return window.gui.playerData.isPvpAggressable() ? window.gui.playerData.alignment.alignmentInfos.honor + " / " + window.gui.playerData.alignment.alignmentInfos.honorNextGradeFloor : "0";
  }
  var t = this.createChild("div", {
      className: "leftColumn"
    }),
    i = this.rightColumn = this.createChild("div", {
      className: "rightColumn"
    }),
    n = t.createChild("div", {
      className: "topRow"
    }),
    o = n.createChild("div", {
      className: "thumbnail"
    });
  this.alignmentImage = o.createChild("div", {
    className: "alignmentImage"
  });
  this.characterDisplay = n.appendChild(new d({
    scale: 2,
    verticalAlign: "top",
    horizontalAlign: "center"
  }));
  this.updateCharacter();
  var u = new a("div", {
    className: "alignmentWingsWrapper"
  });
  this.characterDisplay.insertAsFirstChild(u);
  this.alignmentWingsContainer = u.createChild("div", {
    className: "alignmentWingsContainer"
  });
  var p = t.createChild("div", {
    className: "alignmentInfo"
  });
  this.alignmentName = p.createChild("div", {
    className: "title"
  });
  this.alignmentLevel = p.createChild("div", {
    className: "level"
  });
  var m = t.createChild("div", {
    className: "pvpBox"
  });
  m.createChild("div", {
    className: "title",
    text: c("ui.pvp.pvpMode")
  });
  var f = this.pvpContainer = m.createChild("div", {
      className: "pvpContainer"
    }),
    g = f.createChild("div", {
      className: "rankContainer"
    });
  g.createChild("div", {
    className: "rank",
    text: c("ui.pvp.rank")
  });
  this.alignmentGrade = g.createChild("div", {
    className: "value"
  });
  var _ = f.createChild("div", {
    className: "progress"
  });
  _.createChild("div", {
    className: "text",
    text: c("ui.pvp.honourPoints")
  });
  this.honorPoints = _.appendChild(new r({
    className: "yellow"
  }));
  h.addTooltip(this.honorPoints, e, {
    longTapExplanation: !0
  });
  f.createChild("div", {
    className: "text"
  });
  f.appendChild(new s({
    className: "balance",
    headerContent: [c("ui.pvp.alignedAreaModificators")],
    colIds: ["modifier"]
  }));
  this.pvpButton = m.appendChild(new l(c("ui.pvp.enabled", {
    className: "pvpButton"
  })));
  this.pvpButton.on("tap", function () {
    window.dofus.sendMessage("SetEnablePVPRequestMessage", {
      enable: !window.gui.playerData.isPvpAggressable()
    });
  });
  var v = i.createChild("div", {
    className: "headerRow"
  });
  this.icon = v.createChild("div", {
    className: ["icon", "image"]
  });
  this.title = v.createChild("div", {
    className: "title"
  });
  this.specialisations = i.appendChild(new s({
    className: "specialisations",
    headerContent: [c("ui.pvp.allSpecializations")],
    colIds: ["spec", "minimumAlignment"]
  }));
  i.createChild("div", {
    className: "arrow"
  });
  i.appendChild(new s({
    className: "abilities",
    headerContent: [c("ui.common.feats")],
    colIds: ["ability"]
  }));
};
n.prototype._displayPvpInformations = function () {
  var e = this,
    t = window.gui.playerData.alignment,
    i = window.gui.playerData.isPvpAggressable();
  i ? (this.pvpButton.setText(c("ui.pvp.disabled")), this.pvpContainer.delClassNames("disabled"), t.getTopWings(t.alignmentInfos, function (t) {
    p.loadImage(t.imagePath, function (i) {
      e.alignmentWingsContainer.setStyles({
        left: t.left + f + "px",
        top: t.top + g + "px",
        width: t.width + "px",
        height: t.height + "px",
        backgroundImage: 'url("' + i.src + '")'
      });
    });
  }), this.alignmentGrade.setText(t.getAlignmentGradeString()), this.honorPoints.setValue(t.getHonor())) : (this.pvpButton.setText(c("ui.pvp.enabled")), this.pvpContainer.addClassNames("disabled"), this.alignmentWingsContainer.setStyle("backgroundImage", "none"), this.alignmentGrade.setText("-"), this.honorPoints.setValue(0));
};
n.prototype._displaySpecialisations = function (e) {
  var t = window.gui.playerData.alignment,
    i = t.alignmentInfos;
  if (this.specialisations.clearContent(), 0 !== i.alignmentSide) {
    for (var n = 0; n < t.alignmentRanks.length; n++) {
      var o = t.alignmentRanks[n];
      o.orderId === e && this.specialisations.addRow([o.nameId, o.minimumAlignment]);
    }
  }
};
n.prototype._updateDisplay = function () {
  var e = window.gui.playerData.alignment,
    t = e.alignmentInfos;
  if (this.characterDisplay) {
    var i = this;
    0 === t.alignmentSide ? (this.rightColumn.addClassNames("disabled"), this.pvpButton.hide()) : (this.rightColumn.delClassNames("disabled"), this.pvpButton.show());
    this._displayPvpInformations();
    var n = e.getNameId();
    i.alignmentName.setText(c("ui.common.alignment") + " " + n);
    e.getRank(function (n, o) {
      return n ? console.error("Failed to get alignment rank", n) : (i.alignmentLevel.setText(o.nameId + " - " + c("ui.common.level") + " " + t.alignmentValue), i._displaySpecialisations(o.orderId), void e.getOrder(o, function (t, n) {
        return t ? console.error("Failed to get AlignmentOrder", t) : (i.title.setText(n.nameId), e.getAlignmentImageUrl(function (e) {
          i.alignmentImage.setStyle("backgroundImage", e);
        }), void e.getOrderImageUrl(n.id, function (e) {
          i.icon.setStyle("backgroundImage", e);
        }));
      }));
    });
  }
};
n.prototype._setupEvents = function () {
  var e = this,
    t = window.gui,
    i = window.gui.playerData.alignment;
  i.on("alignmentChanged", function () {
    e._updateDisplay();
  });
  t.playerData.on("lookUpdate", function () {
    e.characterDisplay && e.updateCharacter();
  });
};
this.alignmentImage = o.createChild("div", {
  className: "alignmentImage"
});
this.characterDisplay = n.appendChild(new d({
  scale: 2,
  verticalAlign: "top",
  horizontalAlign: "center"
}));
this.updateCharacter();
this.characterDisplay.insertAsFirstChild(u);
this.alignmentWingsContainer = u.createChild("div", {
  className: "alignmentWingsContainer"
});
this.alignmentName = p.createChild("div", {
  className: "title"
});
this.alignmentLevel = p.createChild("div", {
  className: "level"
});
g.createChild("div", {
  className: "rank",
  text: c("ui.pvp.rank")
});
this.alignmentGrade = g.createChild("div", {
  className: "value"
});
_.createChild("div", {
  className: "text",
  text: c("ui.pvp.honourPoints")
});
this.honorPoints = _.appendChild(new r({
  className: "yellow"
}));
h.addTooltip(this.honorPoints, e, {
  longTapExplanation: !0
});
f.createChild("div", {
  className: "text"
});
f.appendChild(new s({
  className: "balance",
  headerContent: [c("ui.pvp.alignedAreaModificators")],
  colIds: ["modifier"]
}));
this.pvpButton = m.appendChild(new l(c("ui.pvp.enabled", {
  className: "pvpButton"
})));
this.pvpButton.on("tap", function () {
  window.dofus.sendMessage("SetEnablePVPRequestMessage", {
    enable: !window.gui.playerData.isPvpAggressable()
  });
});
this.icon = v.createChild("div", {
  className: ["icon", "image"]
});
this.title = v.createChild("div", {
  className: "title"
});
this.specialisations = i.appendChild(new s({
  className: "specialisations",
  headerContent: [c("ui.pvp.allSpecializations")],
  colIds: ["spec", "minimumAlignment"]
}));
i.createChild("div", {
  className: "arrow"
});
i.appendChild(new s({
  className: "abilities",
  headerContent: [c("ui.common.feats")],
  colIds: ["ability"]
}));
0 === t.alignmentSide ? (this.rightColumn.addClassNames("disabled"), this.pvpButton.hide()) : (this.rightColumn.delClassNames("disabled"), this.pvpButton.show());
this._displayPvpInformations();
i.alignmentName.setText(c("ui.common.alignment") + " " + n);
e.getRank(function (n, o) {
  return n ? console.error("Failed to get alignment rank", n) : (i.alignmentLevel.setText(o.nameId + " - " + c("ui.common.level") + " " + t.alignmentValue), i._displaySpecialisations(o.orderId), void e.getOrder(o, function (t, n) {
    return t ? console.error("Failed to get AlignmentOrder", t) : (i.title.setText(n.nameId), e.getAlignmentImageUrl(function (e) {
      i.alignmentImage.setStyle("backgroundImage", e);
    }), void e.getOrderImageUrl(n.id, function (e) {
      i.icon.setStyle("backgroundImage", e);
    }));
  }));
});
i.on("alignmentChanged", function () {
  e._updateDisplay();
});
t.playerData.on("lookUpdate", function () {
  e.characterDisplay && e.updateCharacter();
});
this.once("open", function () {
  this._createDOM();
  window.gui.on("AchievementDetailsMessage", function (e) {
    var i = t.achievementsList.getItem(e.achievement.id);
    i && i.data && (i.data.displayDetails(e.achievement.startedObjectives, e.achievement.finishedObjective), t.achievementsList.refresh(), t.achievementsList.scrollToElement(i, 0));
  });
  var e = window.gui.playerData.achievements;
  e.on("achievementFinished", function (e) {
    t._updateBarsAndPercentages(e.enrichData.categoryID, e.parentCategoryID, e.id);
  });
  e.on("achievementListUpdated", function () {
    var i = t._getOrderedCategories(),
      n = [];
    i.forEach(function (i) {
      0 === i.parentId ? (e.getCategoryPercentage(i.id), t._updateBarsAndPercentages(i.id, null)) : n.push(i);
    });
    n.forEach(function (e) {
      t._updateBarsAndPercentages(e.id, e.parentId);
    });
    var o = t.summary.getChild("mainProgressBar").getChild("progressBar");
    o.setValue(window.gui.playerData.achievements.getAchievementPercent() / 100);
    t.progressBarTooltip.mainProgressBar.setText(window.gui.playerData.achievements.finishedAchievementsIds.length + " / " + window.gui.playerData.achievements.maximumNumberOfAchievements);
    t.categoriesList.selectItem("mainProgressBar");
  });
});
this.once("opened", function () {
  this.categoriesList.selectItem("mainProgressBar");
});
this.on("opened", function () {
  e && this._activateAchievement(e);
  this.total.setText(window.gui.playerData.achievements.points.toString());
  this._resize();
});
this._createDOM();
window.gui.on("AchievementDetailsMessage", function (e) {
  var i = t.achievementsList.getItem(e.achievement.id);
  i && i.data && (i.data.displayDetails(e.achievement.startedObjectives, e.achievement.finishedObjective), t.achievementsList.refresh(), t.achievementsList.scrollToElement(i, 0));
});
e.on("achievementFinished", function (e) {
  t._updateBarsAndPercentages(e.enrichData.categoryID, e.parentCategoryID, e.id);
});
e.on("achievementListUpdated", function () {
  var i = t._getOrderedCategories(),
    n = [];
  i.forEach(function (i) {
    0 === i.parentId ? (e.getCategoryPercentage(i.id), t._updateBarsAndPercentages(i.id, null)) : n.push(i);
  });
  n.forEach(function (e) {
    t._updateBarsAndPercentages(e.id, e.parentId);
  });
  var o = t.summary.getChild("mainProgressBar").getChild("progressBar");
  o.setValue(window.gui.playerData.achievements.getAchievementPercent() / 100);
  t.progressBarTooltip.mainProgressBar.setText(window.gui.playerData.achievements.finishedAchievementsIds.length + " / " + window.gui.playerData.achievements.maximumNumberOfAchievements);
  t.categoriesList.selectItem("mainProgressBar");
});
i.forEach(function (i) {
  0 === i.parentId ? (e.getCategoryPercentage(i.id), t._updateBarsAndPercentages(i.id, null)) : n.push(i);
});
n.forEach(function (e) {
  t._updateBarsAndPercentages(e.id, e.parentId);
});
o.setValue(window.gui.playerData.achievements.getAchievementPercent() / 100);
t.progressBarTooltip.mainProgressBar.setText(window.gui.playerData.achievements.finishedAchievementsIds.length + " / " + window.gui.playerData.achievements.maximumNumberOfAchievements);
t.categoriesList.selectItem("mainProgressBar");
e && this._activateAchievement(e);
this.total.setText(window.gui.playerData.achievements.points.toString());
this._resize();
o(n, a);
e.exports = n;
n.prototype._updateBarsAndPercentages = function (e, t, i) {
  var n = window.gui.playerData.achievements,
    o = null;
  t ? (o = this.categoriesList.getItem(t), o.sublist && o.sublist.getItem(e).getChild("label").getChild("percentage").setText((100 * n.subCategoriesPercentage[e]).toFixed() + "%")) : (o = this.categoriesList.getItem(e), t = e);
  o && n.categoriesAchievementCount[t] && o.getChild("label").getChild("percentage").setText((100 * n.categoriesPercentage[t]).toFixed() + "%");
  var a = this.summary.getChild(t).getChild("progressBar");
  if (a.setValue(n.categoriesTotalPercentage[t]), this.progressBarTooltip[t].setText(n.categoriesTotalCurrentAchievementCount[t] + " / " + n.categoriesTotalAchievementCount[t]), i) {
    var s = this.achievementsList.getItem(i);
    s && s.getChild(i).addClassNames("completed");
  }
};
n.prototype._resize = function () {
  var e = this.col2.rootElement.clientWidth,
    t = Math.round(e / 8),
    i = Math.round(e / 12);
  this.total.setStyles({
    height: i + "px",
    fontSize: Math.round(e / 26) + "px",
    lineHeight: i + "px"
  });
  for (var n = 0; n < this.banners.length; n += 1) {
    this.banners[n].setStyles({
      height: t + "px"
    });
  }
};
n.prototype._displayRightSideContent = function (e) {
  this._cleanRightSideContent();
  "mainProgressBar" === e && (this.achievementsScroll.hide(), this.summary.show());
};
n.prototype._cleanRightSideContent = function () {
  this.achievementsScroll.show();
  this.noResult.hide();
  this.summary.hide();
  this.hideUnlockedCheckbox.hide();
  this.achievementsList.clearContent();
};
n.prototype._getOrderedCategories = function () {
  return window.gui.playerData.achievements.achievementCategories.sort(function (e, t) {
    return e.order - t.order;
  });
};
n.prototype._createDOM = function () {
  var e = this;
  this.col1 = this.createChild("div", {
    className: "col1"
  });
  this.col2 = this.createChild("div", {
    className: "col2"
  });
  this._createCategoryList();
  this._createSearchBlock();
  this.noResult = this.col2.createChild("div", {
    className: "noResult",
    text: p("ui.search.noResult")
  });
  this.noResult.hide();
  this._createSummaryContent();
  this.achievementsScroll = this.col2.createChild("div", {
    className: "achievementsScroll"
  });
  this.achievementsList = this.achievementsScroll.appendChild(new r());
  this.achievementsList.addClassNames("achievementsList");
  this.achievementsList.on("selected", function (t) {
    window.dofus.sendMessage("AchievementDetailsRequestMessage", {
      achievementId: t.id
    });
    t.data.moreContent.show();
    e.achievementsList.refresh();
    e.achievementsList.scrollToElement(t, 0);
  });
  this.achievementsList.on("deselected", function (t) {
    t.data.moreContent.hide();
    e.achievementsList.refresh();
  });
  this.hideUnlockedChecked = !1;
  this.hideUnlockedCheckbox = this.col2.appendChild(new u(p("ui.achievement.hideAchieved")));
  this.hideUnlockedCheckbox.on("activate", function () {
    e.addClassNames("hideUnlocked");
    e.achievementsList.refresh();
    e.hideUnlockedChecked = !0;
    var t = !0,
      i = e.achievementsList.getItems();
    i.forEach(function (e) {
      t && !e.data.completedData.isCompleted && (t = !1);
    });
    t && (e.noResult.show(), e.noResult.show());
  });
  this.hideUnlockedCheckbox.on("deactivate", function () {
    e.delClassNames("hideUnlocked");
    e.achievementsList.refresh();
    e.hideUnlockedChecked = !1;
    e.noResult.hide();
  });
};
n.prototype._createSearchBlock = function () {
  var e = this;
  this.searchBlock = this.col2.createChild("div", {
    className: "searchBlock"
  });
  this.searchBox = this.searchBlock.appendChild(new g());
  this.searchBox.on("search", function () {
    e._search();
  });
  this.searchName = !0;
  this.searchDescription = !0;
  this.searchObjective = !0;
  this.optionButton = this.searchBox.appendChild(new l({
    className: "optionButton",
    addIcon: !0
  }, function () {
    window.gui.openContextualMenu("generic", {
      title: p("ui.search.criteria"),
      actions: [{
        caption: p("ui.common.name"),
        cb: function () {
          e.searchName = !e.searchName;
          e._search();
        },
        ticked: e.searchName
      }, {
        caption: p("ui.common.description"),
        cb: function () {
          e.searchDescription = !e.searchDescription;
          e._search();
        },
        ticked: e.searchDescription
      }, {
        caption: p("ui.grimoire.quest.objectives"),
        cb: function () {
          e.searchObjective = !e.searchObjective;
          e._search();
        },
        ticked: e.searchObjective
      }]
    });
  }));
};
n.prototype._createCategoryList = function () {
  var e = this,
    t = this.col1.createChild("div", {
      className: "scroll"
    });
  this.categoriesList = t.appendChild(new r());
  this.categoriesList.addClassNames("tree");
  this.categoriesList.on("selected", function (t) {
    e._displayRightSideContent(t.id);
    t.sublist && t.sublist.show();
    t.data && t.data.achievementIds.length > 0 && e._addAchievements(t.data.achievementIds);
    e.achievementsList.refresh();
    e.categoriesList.refresh();
    e.categoriesList.scrollToElement(t, 0);
    e.searchBox.clear();
  });
  this.categoriesList.on("deselected", function (t) {
    t.sublist && (t.sublist.deselectAll(), t.sublist.hide());
    e.categoriesList.refresh();
    t.tappedOnMe ? e.categoriesList.selectItem("mainProgressBar") : e._cleanRightSideContent();
  });
  var i = new a("div", {
    className: ["label", "noPadding"]
  });
  i.createChild("div", {
    className: "icon"
  });
  i.createChild("div", {
    className: "text",
    text: p("ui.achievement.synthesis")
  });
  var n = this.categoriesList.addItem({
    id: "mainProgressBar",
    element: i
  }, {
    noRefresh: !0
  });
  n.addClassNames("mainProgressBar");
  var o = [],
    s = this._getOrderedCategories(),
    l = {};
  s.forEach(function (t) {
    if (0 === t.parentId) {
      window.gui.playerData.achievements.getCategoryPercentage(t.id);
      var i = new a("div", {
        className: ["label", "noPadding"],
        name: "label"
      });
      i.createChild("div", {
        className: ["icon", t.icon]
      });
      i.createChild("div", {
        className: "text",
        text: t.nameId
      });
      window.gui.playerData.achievements.categoriesAchievementCount[t.id] && i.createChild("div", {
        className: "percentage",
        name: "percentage",
        text: (100 * window.gui.playerData.achievements.categoriesPercentage[t.id]).toFixed() + "%"
      });
      l[t.id] = e.categoriesList.addItem({
        id: t.id,
        element: i,
        data: t
      });
    } else {
      o.push(t);
    }
  });
  o.forEach(function (t) {
    var i = new a("div", {
      className: "label",
      name: "label"
    });
    i.createChild("div", {
      className: "text",
      text: t.nameId
    });
    i.createChild("div", {
      className: "percentage",
      name: "percentage",
      text: (100 * window.gui.playerData.achievements.subCategoriesPercentage[t.id]).toFixed() + "%"
    });
    var n = l[t.parentId] || {},
      o = n.sublist;
    o || (n.sublist = n.appendChild(new r({
      className: ["tree", "subCategoryList"]
    })), n.sublist.hide(), n.sublist.on("selected", function (t) {
      e.searchBox.clear();
      t.data && t.data.achievementIds.length > 0 && e._addAchievements(t.data.achievementIds);
    }), n.sublist.on("deselected", function (i) {
      i.tappedOnMe ? e.categoriesList.selectItem(t.parentId) : e._cleanRightSideContent();
    }), o = n.sublist);
    o.addItem({
      id: t.id,
      element: i,
      data: t
    });
  });
};
n.prototype._createSummaryContent = function () {
  var e = this._getOrderedCategories();
  this.summary = this.col2.createChild("div", {
    className: "summary"
  });
  this.total = this.summary.createChild("div", {
    className: "total"
  });
  this.banners = [];
  this.progressBarTooltip = {};
  this._addSummaryBar({
    id: "mainProgressBar",
    nameId: p("ui.tutorial.progress")
  });
  var t = "gfx/illusUi/illu_",
    i = [t + "cat_0.png"],
    n = this;
  e.forEach(function (e) {
    0 === e.parentId && (i.push(t + e.icon + ".png"), n._addSummaryBar(e));
  });
  m.preloadImages(i, function (e) {
    for (var t = 0; t < n.banners.length; t += 1) {
      n.banners[t].setStyle("backgroundImage", e[t]);
    }
  });
};
n.prototype._addSummaryBar = function (e) {
  var t = this.summary.createChild("div", {
      className: "summaryBar",
      name: e.id
    }),
    i = t.createChild("div", {
      className: "banner"
    });
  this.banners.push(i);
  i.createChild("div", {
    className: "text",
    text: e.nameId
  });
  var n = "yellow";
  switch (e.id) {
    case 15:
      n = "light-orange";
      break;
    case 6:
      n = "green";
      break;
    case 3:
      n = "blue";
      break;
    case 25:
      n = "red";
      break;
    case 8:
      n = "aqua";
      break;
    case 7:
      n = "pink";
      break;
    case 5:
      n = "orange";
      break;
    case 9:
      n = "purple";
  }
  var o = t.appendChild(new h({
    className: n,
    name: "progressBar"
  }));
  if ("mainProgressBar" === e.id) {
    var s = this.progressBarTooltip[e.id] = new a("div", {
      text: window.gui.playerData.achievements.finishedAchievementsIds.length + " / " + window.gui.playerData.achievements.maximumNumberOfAchievements
    });
    return o.setValue(window.gui.playerData.achievements.getAchievementPercent() / 100), _.addTooltip(o, s), t.addClassNames("mainProgressBar");
  }
  s = this.progressBarTooltip[e.id] = new a("div", {
    text: window.gui.playerData.achievements.categoriesTotalCurrentAchievementCount[e.id] + " / " + window.gui.playerData.achievements.categoriesTotalAchievementCount[e.id]
  });
  o.setValue(window.gui.playerData.achievements.categoriesTotalPercentage[e.id]);
  _.addTooltip(o, s);
  d(i);
  var r = this;
  i.on("tap", function () {
    r.categoriesList.selectItem(e.id);
  });
};
n.prototype._addAchievements = function (e, t) {
  if (e.length > 100 && t) {
    return window.gui.openSimplePopup(p("tablet.ui.search.tooManyResults"));
  }
  var i = this,
    n = [];
  s.getDataArray("Achievements", e, function (e, t) {
    if (e) {
      return console.error("Achievements with achievementIds error", e);
    }
    t.sort(function (e, t) {
      return e.order - t.order;
    });
    i._cleanRightSideContent();
    i.hideUnlockedCheckbox.show();
    for (var o = [], a = 0; a < t.length; a++) {
      for (var r = t[a].objectiveIds, l = 0; l < r.length; l++) {
        o.push(r[l]);
      }
    }
    n = t;
    s.getDataMap("AchievementObjectives", o, function (e, t) {
      if (e) {
        return console.error("unable to retrieve data from AchievementObjectives", e);
      }
      for (var o = [], a = [], s = i.hideUnlockedChecked, r = 0, l = n.length; r < l; r++) {
        o.push("gfx/achievements/" + n[r].iconId + ".png");
        var c = i._addAchievement(n[r], t);
        a.push(c);
        s && !c.hasClassName("completed") && (s = !1);
      }
      s && i.noResult.show();
      m.preloadImages(o, function (e) {
        for (var t = 0, i = e.length; t < i; t += 1) {
          var n = a[t].icon;
          n ? n.setImage(e[t]) : console.warn("Missing icon for achievement #" + t, a[t]);
        }
      });
    });
  });
};
n.prototype._addAchievement = function (e, t) {
  var i = new c(e, t);
  return this.achievementsList.addItem({
    id: e.id,
    element: i,
    data: i
  }), this.openAchievementWithID === e.id && (this.achievementsList.selectItem(this.openAchievementWithID), this.openAchievementWithID = null), i;
};
n.prototype._activateAchievement = function (e) {
  var t = this;
  e = parseInt(e, 10);
  s.getObject("Achievements", e, function (i, n) {
    if (i || !n) {
      return console.error("Failed getting Achievements #" + e + " error: " + i + " res: " + n);
    }
    var o = !1,
      a = t.categoriesList,
      s = a.getItem(n.categoryId);
    if (s) {
      s.isSelected ? t.achievementsList.selectItem(e) : (t.openAchievementWithID = e, a.selectItem(n.categoryId));
    } else {
      var r = a.getItems();
      for (var l in r) {
        if (r.hasOwnProperty(l)) {
          var c = r[l],
            d = c.sublist;
          if (d && (o = d.getItem(n.categoryId))) {
            o.isSelected ? t.achievementsList.selectItem(e) : (c.isSelected || a.selectItem(c.id), c.sublist.show(), t.openAchievementWithID = e, d.selectItem(n.categoryId));
            break;
          }
        }
      }
    }
  });
};
n.prototype._search = function () {
  var e = this.searchBox.searchInput.getValue();
  if (null !== e && "" !== e) {
    if (e.length < 3) {
      return _.showNotification(p("ui.common.searchFilterTooltip"), this.searchBox);
    }
    e = f.simplifyString(e);
    var t = this;
    this.searchAchievementIds = [];
    var i = function (e, i) {
      for (var n in e) {
        if (e.hasOwnProperty(n)) {
          var o = e[n],
            a = i ? o.achievementId : o.id;
          t.searchAchievementIds.indexOf(a) === -1 && t.searchAchievementIds.push(a);
        }
      }
    };
    this.searchName ? s.searchDataMap("Achievements", {
      match: e
    }, function (e, n) {
      return t.hasSearchedName = !0, e ? console.error("AchievementsWindow achievements search", e) : (i(n), void t._searchResult());
    }) : this.hasSearchedName = !0;
    this.searchDescription ? s.searchDataMap("Achievements", {
      match: e,
      matchProp: "descriptionId"
    }, function (e, n) {
      return t.hasSearchedDescription = !0, e ? console.error("AchievementsWindow description search", e) : (i(n), void t._searchResult());
    }) : this.hasSearchedDescription = !0;
    this.searchObjective ? s.searchDataMap("AchievementObjectives", {
      match: e
    }, function (e, n) {
      return t.hasSearchedObjectives = !0, e ? console.error("AchievementsWindow objectives search", e) : (i(n, !0), void t._searchResult());
    }) : this.hasSearchedObjectives = !0;
    t._searchResult();
  }
};
n.prototype._searchResult = function () {
  this.hasSearchedName && this.hasSearchedDescription && this.hasSearchedObjectives && (this.hasSearchedName = this.hasSearchedDescription = this.hasSearchedObjectives = !1, this.categoriesList.deselectAll(), this.searchAchievementIds.length > 0 ? this._addAchievements(this.searchAchievementIds, !0) : (this._cleanRightSideContent(), this.noResult.show()));
};
t ? (o = this.categoriesList.getItem(t), o.sublist && o.sublist.getItem(e).getChild("label").getChild("percentage").setText((100 * n.subCategoriesPercentage[e]).toFixed() + "%")) : (o = this.categoriesList.getItem(e), t = e);
o && n.categoriesAchievementCount[t] && o.getChild("label").getChild("percentage").setText((100 * n.categoriesPercentage[t]).toFixed() + "%");
this._cleanRightSideContent();
"mainProgressBar" === e && (this.achievementsScroll.hide(), this.summary.show());
this.achievementsScroll.show();
this.noResult.hide();
this.summary.hide();
this.hideUnlockedCheckbox.hide();
this.achievementsList.clearContent();
this.col1 = this.createChild("div", {
  className: "col1"
});
this.col2 = this.createChild("div", {
  className: "col2"
});
this._createCategoryList();
this._createSearchBlock();
this.noResult = this.col2.createChild("div", {
  className: "noResult",
  text: p("ui.search.noResult")
});
this.noResult.hide();
this._createSummaryContent();
this.achievementsScroll = this.col2.createChild("div", {
  className: "achievementsScroll"
});
this.achievementsList = this.achievementsScroll.appendChild(new r());
this.achievementsList.addClassNames("achievementsList");
this.achievementsList.on("selected", function (t) {
  window.dofus.sendMessage("AchievementDetailsRequestMessage", {
    achievementId: t.id
  });
  t.data.moreContent.show();
  e.achievementsList.refresh();
  e.achievementsList.scrollToElement(t, 0);
});
this.achievementsList.on("deselected", function (t) {
  t.data.moreContent.hide();
  e.achievementsList.refresh();
});
this.hideUnlockedChecked = !1;
this.hideUnlockedCheckbox = this.col2.appendChild(new u(p("ui.achievement.hideAchieved")));
this.hideUnlockedCheckbox.on("activate", function () {
  e.addClassNames("hideUnlocked");
  e.achievementsList.refresh();
  e.hideUnlockedChecked = !0;
  var t = !0,
    i = e.achievementsList.getItems();
  i.forEach(function (e) {
    t && !e.data.completedData.isCompleted && (t = !1);
  });
  t && (e.noResult.show(), e.noResult.show());
});
this.hideUnlockedCheckbox.on("deactivate", function () {
  e.delClassNames("hideUnlocked");
  e.achievementsList.refresh();
  e.hideUnlockedChecked = !1;
  e.noResult.hide();
});
window.dofus.sendMessage("AchievementDetailsRequestMessage", {
  achievementId: t.id
});
t.data.moreContent.show();
e.achievementsList.refresh();
e.achievementsList.scrollToElement(t, 0);
t.data.moreContent.hide();
e.achievementsList.refresh();
e.addClassNames("hideUnlocked");
e.achievementsList.refresh();
e.hideUnlockedChecked = !0;
i.forEach(function (e) {
  t && !e.data.completedData.isCompleted && (t = !1);
});
t && (e.noResult.show(), e.noResult.show());
e.delClassNames("hideUnlocked");
e.achievementsList.refresh();
e.hideUnlockedChecked = !1;
e.noResult.hide();
this.searchBlock = this.col2.createChild("div", {
  className: "searchBlock"
});
this.searchBox = this.searchBlock.appendChild(new g());
this.searchBox.on("search", function () {
  e._search();
});
this.searchName = !0;
this.searchDescription = !0;
this.searchObjective = !0;
this.optionButton = this.searchBox.appendChild(new l({
  className: "optionButton",
  addIcon: !0
}, function () {
  window.gui.openContextualMenu("generic", {
    title: p("ui.search.criteria"),
    actions: [{
      caption: p("ui.common.name"),
      cb: function () {
        e.searchName = !e.searchName;
        e._search();
      },
      ticked: e.searchName
    }, {
      caption: p("ui.common.description"),
      cb: function () {
        e.searchDescription = !e.searchDescription;
        e._search();
      },
      ticked: e.searchDescription
    }, {
      caption: p("ui.grimoire.quest.objectives"),
      cb: function () {
        e.searchObjective = !e.searchObjective;
        e._search();
      },
      ticked: e.searchObjective
    }]
  });
}));
e.searchName = !e.searchName;
e._search();
e.searchDescription = !e.searchDescription;
e._search();
e.searchObjective = !e.searchObjective;
e._search();
this.categoriesList = t.appendChild(new r());
this.categoriesList.addClassNames("tree");
this.categoriesList.on("selected", function (t) {
  e._displayRightSideContent(t.id);
  t.sublist && t.sublist.show();
  t.data && t.data.achievementIds.length > 0 && e._addAchievements(t.data.achievementIds);
  e.achievementsList.refresh();
  e.categoriesList.refresh();
  e.categoriesList.scrollToElement(t, 0);
  e.searchBox.clear();
});
this.categoriesList.on("deselected", function (t) {
  t.sublist && (t.sublist.deselectAll(), t.sublist.hide());
  e.categoriesList.refresh();
  t.tappedOnMe ? e.categoriesList.selectItem("mainProgressBar") : e._cleanRightSideContent();
});
e._displayRightSideContent(t.id);
t.sublist && t.sublist.show();
t.data && t.data.achievementIds.length > 0 && e._addAchievements(t.data.achievementIds);
e.achievementsList.refresh();
e.categoriesList.refresh();
e.categoriesList.scrollToElement(t, 0);
e.searchBox.clear();
t.sublist && (t.sublist.deselectAll(), t.sublist.hide());
e.categoriesList.refresh();
t.tappedOnMe ? e.categoriesList.selectItem("mainProgressBar") : e._cleanRightSideContent();
i.createChild("div", {
  className: "icon"
});
i.createChild("div", {
  className: "text",
  text: p("ui.achievement.synthesis")
});
s.forEach(function (t) {
  if (0 === t.parentId) {
    window.gui.playerData.achievements.getCategoryPercentage(t.id);
    var i = new a("div", {
      className: ["label", "noPadding"],
      name: "label"
    });
    i.createChild("div", {
      className: ["icon", t.icon]
    });
    i.createChild("div", {
      className: "text",
      text: t.nameId
    });
    window.gui.playerData.achievements.categoriesAchievementCount[t.id] && i.createChild("div", {
      className: "percentage",
      name: "percentage",
      text: (100 * window.gui.playerData.achievements.categoriesPercentage[t.id]).toFixed() + "%"
    });
    l[t.id] = e.categoriesList.addItem({
      id: t.id,
      element: i,
      data: t
    });
  } else {
    o.push(t);
  }
});
o.forEach(function (t) {
  var i = new a("div", {
    className: "label",
    name: "label"
  });
  i.createChild("div", {
    className: "text",
    text: t.nameId
  });
  i.createChild("div", {
    className: "percentage",
    name: "percentage",
    text: (100 * window.gui.playerData.achievements.subCategoriesPercentage[t.id]).toFixed() + "%"
  });
  var n = l[t.parentId] || {},
    o = n.sublist;
  o || (n.sublist = n.appendChild(new r({
    className: ["tree", "subCategoryList"]
  })), n.sublist.hide(), n.sublist.on("selected", function (t) {
    e.searchBox.clear();
    t.data && t.data.achievementIds.length > 0 && e._addAchievements(t.data.achievementIds);
  }), n.sublist.on("deselected", function (i) {
    i.tappedOnMe ? e.categoriesList.selectItem(t.parentId) : e._cleanRightSideContent();
  }), o = n.sublist);
  o.addItem({
    id: t.id,
    element: i,
    data: t
  });
});
i.createChild("div", {
  className: ["icon", t.icon]
});
i.createChild("div", {
  className: "text",
  text: t.nameId
});
window.gui.playerData.achievements.categoriesAchievementCount[t.id] && i.createChild("div", {
  className: "percentage",
  name: "percentage",
  text: (100 * window.gui.playerData.achievements.categoriesPercentage[t.id]).toFixed() + "%"
});
l[t.id] = e.categoriesList.addItem({
  id: t.id,
  element: i,
  data: t
});
i.createChild("div", {
  className: "text",
  text: t.nameId
});
i.createChild("div", {
  className: "percentage",
  name: "percentage",
  text: (100 * window.gui.playerData.achievements.subCategoriesPercentage[t.id]).toFixed() + "%"
});
o || (n.sublist = n.appendChild(new r({
  className: ["tree", "subCategoryList"]
})), n.sublist.hide(), n.sublist.on("selected", function (t) {
  e.searchBox.clear();
  t.data && t.data.achievementIds.length > 0 && e._addAchievements(t.data.achievementIds);
}), n.sublist.on("deselected", function (i) {
  i.tappedOnMe ? e.categoriesList.selectItem(t.parentId) : e._cleanRightSideContent();
}), o = n.sublist);
o.addItem({
  id: t.id,
  element: i,
  data: t
});
e.searchBox.clear();
t.data && t.data.achievementIds.length > 0 && e._addAchievements(t.data.achievementIds);
this.summary = this.col2.createChild("div", {
  className: "summary"
});
this.total = this.summary.createChild("div", {
  className: "total"
});
this.banners = [];
this.progressBarTooltip = {};
this._addSummaryBar({
  id: "mainProgressBar",
  nameId: p("ui.tutorial.progress")
});
e.forEach(function (e) {
  0 === e.parentId && (i.push(t + e.icon + ".png"), n._addSummaryBar(e));
});
m.preloadImages(i, function (e) {
  for (var t = 0; t < n.banners.length; t += 1) {
    n.banners[t].setStyle("backgroundImage", e[t]);
  }
});
this.banners.push(i);
i.createChild("div", {
  className: "text",
  text: e.nameId
});
s = this.progressBarTooltip[e.id] = new a("div", {
  text: window.gui.playerData.achievements.categoriesTotalCurrentAchievementCount[e.id] + " / " + window.gui.playerData.achievements.categoriesTotalAchievementCount[e.id]
});
o.setValue(window.gui.playerData.achievements.categoriesTotalPercentage[e.id]);
_.addTooltip(o, s);
d(i);
t.sort(function (e, t) {
  return e.order - t.order;
});
i._cleanRightSideContent();
i.hideUnlockedCheckbox.show();
n = t;
s.getDataMap("AchievementObjectives", o, function (e, t) {
  if (e) {
    return console.error("unable to retrieve data from AchievementObjectives", e);
  }
  for (var o = [], a = [], s = i.hideUnlockedChecked, r = 0, l = n.length; r < l; r++) {
    o.push("gfx/achievements/" + n[r].iconId + ".png");
    var c = i._addAchievement(n[r], t);
    a.push(c);
    s && !c.hasClassName("completed") && (s = !1);
  }
  s && i.noResult.show();
  m.preloadImages(o, function (e) {
    for (var t = 0, i = e.length; t < i; t += 1) {
      var n = a[t].icon;
      n ? n.setImage(e[t]) : console.warn("Missing icon for achievement #" + t, a[t]);
    }
  });
});
a.push(c);
s && !c.hasClassName("completed") && (s = !1);
s && i.noResult.show();
m.preloadImages(o, function (e) {
  for (var t = 0, i = e.length; t < i; t += 1) {
    var n = a[t].icon;
    n ? n.setImage(e[t]) : console.warn("Missing icon for achievement #" + t, a[t]);
  }
});
e = parseInt(e, 10);
s.getObject("Achievements", e, function (i, n) {
  if (i || !n) {
    return console.error("Failed getting Achievements #" + e + " error: " + i + " res: " + n);
  }
  var o = !1,
    a = t.categoriesList,
    s = a.getItem(n.categoryId);
  if (s) {
    s.isSelected ? t.achievementsList.selectItem(e) : (t.openAchievementWithID = e, a.selectItem(n.categoryId));
  } else {
    var r = a.getItems();
    for (var l in r) {
      if (r.hasOwnProperty(l)) {
        var c = r[l],
          d = c.sublist;
        if (d && (o = d.getItem(n.categoryId))) {
          o.isSelected ? t.achievementsList.selectItem(e) : (c.isSelected || a.selectItem(c.id), c.sublist.show(), t.openAchievementWithID = e, d.selectItem(n.categoryId));
          break;
        }
      }
    }
  }
});
this.searchName ? s.searchDataMap("Achievements", {
  match: e
}, function (e, n) {
  return t.hasSearchedName = !0, e ? console.error("AchievementsWindow achievements search", e) : (i(n), void t._searchResult());
}) : this.hasSearchedName = !0;
this.searchDescription ? s.searchDataMap("Achievements", {
  match: e,
  matchProp: "descriptionId"
}, function (e, n) {
  return t.hasSearchedDescription = !0, e ? console.error("AchievementsWindow description search", e) : (i(n), void t._searchResult());
}) : this.hasSearchedDescription = !0;
this.searchObjective ? s.searchDataMap("AchievementObjectives", {
  match: e
}, function (e, n) {
  return t.hasSearchedObjectives = !0, e ? console.error("AchievementsWindow objectives search", e) : (i(n, !0), void t._searchResult());
}) : this.hasSearchedObjectives = !0;
t._searchResult();
c[h] = {
  data: u,
  quantity: o[d] || null
};
l.push(h);
l.call(this, "div", {
  name: e.id,
  className: "achievement"
});
this.achievement = e;
this.completedData = window.gui.playerData.achievements.completedData(e.id);
this._hasBeenDestroyed = !1;
this.on("destroy", function () {
  i._hasBeenDestroyed = !0;
});
window.gui.playerData.achievements.completedData(e.id).isCompleted && this.addClassNames("completed");
this.completedData.isAccountCompleted && this.addClassNames("accountCompleted");
this.icon = new c({
  name: "icon"
});
s.createChild("div", {
  className: "description",
  text: e.descriptionId
});
r.createChild("div", {
  className: "title",
  text: n(e)
});
r.createChild("div", {
  className: "points",
  text: e.points
});
this.moreContent = this.createChild("div", {
  className: "more",
  name: "more"
});
this.moreContent.hide();
this.progression = this.moreContent.createChild("div", {
  className: "progression",
  name: "progression"
});
this.progression.hide();
this.objectivesBox = this.moreContent.createChild("div", {
  className: "objectives",
  name: "objectives"
});
this.objectivesBox.hide();
this.spinner = this.moreContent.createChild("div", {
  className: "spinner",
  name: "spinner"
});
this.progressionBar = this.progression.appendChild(new d({
  className: "green",
  name: "progressBar",
  tooltip: !0
}));
this.progressionText = this.progression.createChild("div", {
  className: "text",
  name: "text"
});
e.objectiveIds.sort(function (e, i) {
  var n = t[e] && t[e].order ? t[e].order : 0,
    o = t[i] && t[i].order ? t[i].order : 0;
  return n - o;
});
this._xpValue = I.createChild("div", {
  className: "text",
  text: "0"
});
I.createChild("div", {
  className: ["icon", "xp"]
});
this._kamaValue = A.createChild("div", {
  className: "text",
  text: "0"
});
A.createChild("div", {
  className: ["icon", "kamas"]
});
g(r, l);
e.exports = r;
r.prototype.displayDetails = function (e, t) {
  for (var i = 0; i < e.length; i += 1) {
    var n = e[i];
    1 === n.maxValue ? (this.progression.hide(), this.objectivesBox.show()) : (this.progression.show(), this.objectivesBox.hide(), this.progressionText.setText(n.value + "/" + n.maxValue), this.progressionBar.setValue(n.value, n.maxValue));
  }
  for (i = 0; i < t.length; i += 1) {
    n = t[i];
    var a = this.objectivesBox.getChild(n.id);
    a && a.addClassNames("completed");
    1 === n.maxValue ? (this.progression.hide(), this.objectivesBox.show()) : (this.progression.show(), this.objectivesBox.hide(), this.progressionText.setText(n.maxValue + "/" + n.maxValue), this.progressionBar.setValue(n.maxValue, n.maxValue));
  }
  var s = this;
  this._loadRewards(this.achievement, function (e, t) {
    if (e) {
      if (console.error("Loaded static achievement data error", e), s._hasBeenDestroyed) {
        return;
      }
      return void s.spinner.hide();
    }
    for (var i = [], n = [], a = 0, r = t.length; a < r; a += 1) {
      t[a] && t[a].data && t[a].data._type && (n.push(t[a].data.id), i.push(t[a]));
    }
    for (a = 0, r = t.length; a < r; a += 1) {
      t[a] && t[a].data && !t[a].data._type && (n.push(t[a].data.id), i.push(t[a]));
    }
    v.getItems(n, function (e) {
      if (e) {
        if (console.error("Failed to get items", e), s._hasBeenDestroyed) {
          return;
        }
        return void s.spinner.hide();
      }
      if (!s._hasBeenDestroyed) {
        for (var t = 0, a = n.length; t < a; t += 1) {
          var r = n[t],
            c = v.items[r],
            d = s.rewardList.getChild("icon" + t),
            p = i[t];
          if (!d) {
            return s.spinner.hide(), console.warn("Achievement: Missing icon" + t);
          }
          if (c && "Item" === p.data._type) {
            var m = u("ui.item.averageprice") + " : ",
              f = c.getProperty("averagePrice");
            m += f === -1 ? u("ui.item.averageprice.unavailable") : h.kamasToString(f);
            d.setContextMenu("item", {
              item: c
            });
          }
          var g = p.url,
            _ = p.quantity,
            y = p.data;
          d.setImage(g);
          _ && d.setQuantity(_);
          var w = new l("div");
          w.createChild("div", {
            text: y.nameId || o(y)
          });
          m && "Item" === p.data._type && w.createChild("div", {
            text: m
          });
          y.descriptionId && w.createChild("div", {
            text: y.descriptionId,
            className: "details"
          });
          d.setTooltip(w);
        }
        s.spinner.hide();
      }
    });
  });
};
r.prototype._loadRewards = function (e, t) {
  if (!e.rewardIds.length) {
    return t(null, []);
  }
  var i = this,
    n = e.rewardIds;
  p.getDataMap("AchievementRewards", n, function (o, a) {
    function r(e, i) {
      if (!p) {
        return e ? (p = !0, t(e)) : (m = m.concat(i), d += i.length, u += 1, d === c || u === l.length ? t(null, m) : void 0);
      }
    }
    if (o) {
      return t(o);
    }
    for (var l = ["Ornaments", "Items", "Spells", "Titles", "Emoticons"], c = 0, d = 0, u = 0, p = !1, m = [], f = window.gui.playerData.achievements.completedData(e.id), g = f.finishedlevel || window.gui.playerData.characterBaseInformations.level, _ = e.level, v = 0; v < n.length; v += 1) {
      var y = n[v],
        w = a[y];
      if (w) {
        var b = w.isLinkedToAccount && f.isAccountCompleted;
        if (w.experienceRatio) {
          var M = "0";
          if (!b) {
            var T = window.gui.playerData.achievements.getAchievementExperienceReward(w, _, g);
            M = h.intToString(T);
          }
          i._xpValue.setText(M);
        } else if (w.kamasRatio) {
          var C = "0";
          if (!b) {
            var I = window.gui.playerData.achievements.getAchievementKamasReward(w, _, g);
            C = h.intToString(I);
          }
          i._kamaValue.setText(C);
        }
        if (!(b || g && (w.levelMin !== -1 && g < w.levelMin || w.levelMax !== -1 && g > w.levelMax))) {
          var A = w.itemsReward,
            S = w.ornamentsReward,
            E = w.spellsReward,
            N = w.titlesReward,
            x = w.emotesReward;
          c += A.length + S.length + E.length + N.length + x.length;
          s(l[0], S, "gfx/ornaments", "iconId", [], r);
          s(l[1], A, "gfx/items", "iconId", w.itemsQuantityReward, r);
          s(l[2], E, "gfx/spells", "iconId", [], r);
          s(l[3], N, "gfx/illusUi/genericTitleIcon.png", null, [], r);
          s(l[4], x, "gfx/emotes", "id", [], r);
        }
      } else {
        console.error("Unable to find reward id " + y + " in AchievementRewards DB");
      }
    }
    return 0 === c ? t(null, []) : void 0;
  });
};
a && a.addClassNames("completed");
1 === n.maxValue ? (this.progression.hide(), this.objectivesBox.show()) : (this.progression.show(), this.objectivesBox.hide(), this.progressionText.setText(n.maxValue + "/" + n.maxValue), this.progressionBar.setValue(n.maxValue, n.maxValue));
m += f === -1 ? u("ui.item.averageprice.unavailable") : h.kamasToString(f);
d.setContextMenu("item", {
  item: c
});
d.setImage(g);
_ && d.setQuantity(_);
w.createChild("div", {
  text: y.nameId || o(y)
});
m && "Item" === p.data._type && w.createChild("div", {
  text: m
});
y.descriptionId && w.createChild("div", {
  text: y.descriptionId,
  className: "details"
});
d.setTooltip(w);
c += A.length + S.length + E.length + N.length + x.length;
s(l[0], S, "gfx/ornaments", "iconId", [], r);
s(l[1], A, "gfx/items", "iconId", w.itemsQuantityReward, r);
s(l[2], E, "gfx/spells", "iconId", [], r);
s(l[3], N, "gfx/illusUi/genericTitleIcon.png", null, [], r);
s(l[4], x, "gfx/emotes", "id", [], r);
(void 0 === i.min[e] || i.min[e] > t[e]) && (i.min[e] = t[e]);
(void 0 === i.max[e] || i.max[e] < t[e]) && (i.max[e] = t[e]);
(void 0 === t.min || t.min > a) && (t.min = a);
(void 0 === t.max || t.max < a) && (t.max = a);
t.emit("initialized");
t.subAreaList.delClassNames("spinner");
t.raceList.delClassNames("spinner");
this.subAreas = {};
this.races = {};
this.monsters = {};
this.selectedSubAreaElement = null;
this.updateRequired = !0;
this.params = {};
this._sortByName = I.createStringCompareFunc();
this.once("open", function () {
  this._createDom();
  this._setupEvents();
  this._getAreaStaticData(function () {
    t._createAreaCategories();
    i = !0;
    n && e();
  });
  this._getMonsterFamilyStaticData(function () {
    t._createMonsterFamilyCategories();
    n = !0;
    i && e();
  });
});
this.on("open", function (e) {
  var t = i && n;
  return this.subAreaList.toggleClassName("spinner", !t), this.raceList.toggleClassName("spinner", !t), t ? void this._onOpen(e) : this.once("initialized", this._onOpen.bind(this, e));
});
this._createDom();
this._setupEvents();
this._getAreaStaticData(function () {
  t._createAreaCategories();
  i = !0;
  n && e();
});
this._getMonsterFamilyStaticData(function () {
  t._createMonsterFamilyCategories();
  n = !0;
  i && e();
});
t._createAreaCategories();
i = !0;
n && e();
t._createMonsterFamilyCategories();
n = !0;
i && e();
t += i === -1 ? M("ui.item.averageprice.unavailable") : I.kamasToString(i);
e += "\n" + t;
u(s, f);
e.exports = s;
s.prototype._search = function (e) {
  var t = this;
  if ("" === e) {
    return void (this.searching = !1);
  }
  var i = I.simplifyString(e);
  this.searching = !0;
  this.monsterList.clearContent();
  this.monsterList.addClassNames("spinner");
  t.errorText.hide();
  t.noResultText.hide();
  g.searchDataMap("Items", {
    match: i
  }, function (n, o) {
    if (t.searching) {
      if (n) {
        return t.monsterList.delClassNames("spinner"), t.errorText.show(), console.error("BestiaryWindow items search", n);
      }
      var a = [];
      for (var s in o) {
        if (o.hasOwnProperty(s)) {
          var r = o[s];
          if (r.dropMonsterIds.length) {
            for (var l = 0; l < r.dropMonsterIds.length; l++) {
              var c = r.dropMonsterIds[l];
              a.indexOf(c) === -1 && a.push(c);
            }
          }
        }
      }
      g.searchDataMap("Monsters", {
        match: i
      }, function (i, n) {
        if (t.searching) {
          if (i) {
            return t.monsterList.delClassNames("spinner"), t.errorText.show(), console.error("BestiaryWindow monsters search", i);
          }
          for (var o in n) {
            if (n.hasOwnProperty(o)) {
              var s = n[o];
              a.indexOf(s.id) === -1 && a.push(s.id);
            }
          }
          t._showMonsters(a, e);
        }
      });
    }
  });
};
s.prototype._showMonsters = function (e, t) {
  var i = this;
  this.searchBox.setValue(t || "");
  this.searching = !1;
  this.errorText.hide();
  this.noResultText.hide();
  this.monsterList.addClassNames("spinner");
  g.getDataArray("Monsters", e, {}, function (e, t) {
    if (e) {
      return i._clearAndRemoveSpinner(), i.errorText.show(), i.monsterList.refresh(), console.error("BestiaryWindow showMonsters error", e);
    }
    t.sort(i._sortByName);
    var n = t.length;
    if (0 === n) {
      return i._clearAndRemoveSpinner(), i.noResultText.show(), void i.monsterList.refresh();
    }
    for (var o = [], a = 0; a < n; a += 1) {
      var s = t[a];
      o.push("gfx/monsters/" + s.id + ".png");
    }
    T.preloadImages(o, function (e) {
      i._clearAndRemoveSpinner();
      for (var o = 0; o < n; o += 1) {
        i.addMonster(t[o], e[o]);
      }
      i.monsterList.refresh();
    });
  });
};
this.searching = !0;
this.monsterList.clearContent();
this.monsterList.addClassNames("spinner");
t.errorText.hide();
t.noResultText.hide();
g.searchDataMap("Items", {
  match: i
}, function (n, o) {
  if (t.searching) {
    if (n) {
      return t.monsterList.delClassNames("spinner"), t.errorText.show(), console.error("BestiaryWindow items search", n);
    }
    var a = [];
    for (var s in o) {
      if (o.hasOwnProperty(s)) {
        var r = o[s];
        if (r.dropMonsterIds.length) {
          for (var l = 0; l < r.dropMonsterIds.length; l++) {
            var c = r.dropMonsterIds[l];
            a.indexOf(c) === -1 && a.push(c);
          }
        }
      }
    }
    g.searchDataMap("Monsters", {
      match: i
    }, function (i, n) {
      if (t.searching) {
        if (i) {
          return t.monsterList.delClassNames("spinner"), t.errorText.show(), console.error("BestiaryWindow monsters search", i);
        }
        for (var o in n) {
          if (n.hasOwnProperty(o)) {
            var s = n[o];
            a.indexOf(s.id) === -1 && a.push(s.id);
          }
        }
        t._showMonsters(a, e);
      }
    });
  }
});
this.searchBox.setValue(t || "");
this.searching = !1;
this.errorText.hide();
this.noResultText.hide();
this.monsterList.addClassNames("spinner");
g.getDataArray("Monsters", e, {}, function (e, t) {
  if (e) {
    return i._clearAndRemoveSpinner(), i.errorText.show(), i.monsterList.refresh(), console.error("BestiaryWindow showMonsters error", e);
  }
  t.sort(i._sortByName);
  var n = t.length;
  if (0 === n) {
    return i._clearAndRemoveSpinner(), i.noResultText.show(), void i.monsterList.refresh();
  }
  for (var o = [], a = 0; a < n; a += 1) {
    var s = t[a];
    o.push("gfx/monsters/" + s.id + ".png");
  }
  T.preloadImages(o, function (e) {
    i._clearAndRemoveSpinner();
    for (var o = 0; o < n; o += 1) {
      i.addMonster(t[o], e[o]);
    }
    i.monsterList.refresh();
  });
});
s.prototype.monstersImageIntegrity = function (e) {
  B = [];
  g.getAllDataTable("Monsters", function (t, i) {
    if (t) {
      var n = new Error("integrity error: " + t);
      return N.error(n), e(n);
    }
    var o = {},
      a = {},
      s = {},
      l = {};
    for (var c in i) {
      if (i.hasOwnProperty(c)) {
        var d = i[c],
          u = I.parseLook(N, d.look, "Monster " + d.id).bone;
        o["gfx/monsters/" + d.id + ".png"] = !0;
        a[d.id] = u;
        l[d.id] = d.look;
        s[u] ? s[u].push(d.id) : s[u] = [d.id];
      }
    }
    var m = Object.keys(o);
    T.preloadImageUrls(m, function (t) {
      var i = [];
      h.forEachLimit(t, 10, function (e, t) {
        p.open({
          uri: e
        }, function (n) {
          n && i.push({
            error: n,
            url: e
          });
          t();
        });
      }, function (n) {
        n && N.error(n);
        var o = [];
        if (i.length > 0) {
          for (var c, d = [], u = {}, h = 0; h < i.length; h += 1) {
            var p = i[h];
            N.error(p.error);
            var m = p.url || "",
              f = m.split("/").pop(),
              g = f.split(".")[0];
            c = a[g] || -1;
            c <= 1 ? d.push([g, l[g]]) : u[c] ? u[c].push(g) : u[c] = [g];
          }
          var _ = Object.keys(u).length,
            v = "[Bestiary integrity] Missing bones count: " + _;
          N.error(v);
          o.push(v);
          for (c in u) {
            if (u.hasOwnProperty(c)) {
              var y = u[c];
              v = 'Missing bones: "' + c + '" for monster id "' + y.join(",") + '"';
              var w = r(y, s[c]);
              w && (v += ' can steal from: "' + w + '"');
              N.error(v);
              o.push(v);
            }
          }
          if (d.length > 0) {
            var b = d.length;
            o.push("");
            v = "[Bestiary integrity] Missing bones 1 or null count: " + b;
            N.error(v);
            o.push(v);
            for (var M = 0, T = d.length; M < T; M += 1) {
              var C = d[M];
              v = 'Do something for monster "' + C[0] + '" with bones 1 or null and look: "';
              v += C[1] + '"';
              N.error(v);
              o.push(v);
            }
          }
          o.length && N.log(o.join("[LF]"));
          B.length && N.log("Command to do inside compiled gfx/monsters folder: mkdir copyToSources ; " + B.join(" ; "));
        }
        return N.log("done! (urls: " + t.length + ", errors: " + i.length + ")"), e(n, o.join("\n"));
      });
    });
  });
};
s.prototype._clearAndRemoveSpinner = function () {
  this.monsterList.clearContent();
  this.monsterList.delClassNames("spinner");
};
s.prototype.addMonster = function (e, t) {
  var i = new f("div", {
      className: "infos"
    }),
    n = i.createChild("div", {
      className: "gfx"
    });
  n.setStyle("backgroundImage", t);
  var a = i.createChild("div", {
      className: "infosGroupRight"
    }),
    s = a.createChild("div", {
      className: "cf"
    }),
    r = ["name"];
  e.isBoss && r.push("boss");
  e.isMiniBoss && r.push("miniBoss");
  e.isQuestMonster && r.push("questMonster");
  var l = window.gui.playerData.isAbleToSeeId(),
    c = e.nameId;
  l && (c += " (" + e.id + ")");
  s.createChild("div", {
    className: r,
    text: c
  });
  var d = o(e.grades),
    u = d.min.level,
    h = d.max.level,
    p = M("ui.common.short.level") + " " + u;
  u !== h && (p += " " + M("ui.chat.to") + " " + h);
  s.createChild("div", {
    className: "level",
    text: p
  });
  var m = a.createChild("div");
  m.appendChild(b.createMapLocation(e.subareas, this.subAreas, e.favoriteSubareaId));
  var g = this.monsterList.addItem({
    id: e.id,
    element: i,
    data: e
  }, {
    noRefresh: !0
  });
  g.addClassNames("monster");
  g.monsterData = e;
  g.gradeMinMaxInfo = d;
  g.mapLocationDom = m;
};
s.prototype._onOpen = function (e) {
  var t = this;
  if (this.params = e || {}, this.updateRequired && this._updateSubAreaList(), e.search) {
    this._search(e.search);
  } else if (e.monsterIds) {
    this._showMonsters(e.monsterIds, e.label);
  } else if (!e.monsterIds) {
    var i = window.gui.playerData.position.area.id,
      n = window.gui.playerData.position.subAreaId;
    t.subAreas[n].monsters.length > 0 && setTimeout(function () {
      t._selectSubArea(i, n);
      t._showMonsters(t.subAreas[n].monsters, "");
    }, 0);
  }
};
s.prototype._createDom = function () {
  var e = this,
    t = this.col1 = this.createChild("div", {
      className: "col1"
    });
  this.col2 = this.createChild("div", {
    className: "col2"
  });
  var i = this.tabs = t.appendChild(new m());
  this.searchBlock = this.col2.createChild("div", {
    className: "searchBlock"
  });
  this.searchBox = this.searchBlock.appendChild(new A());
  this.searchBox.on("search", function (t) {
    e._search(t);
  });
  window.subAreaList = this.subAreaList = t.appendChild(new _({
    className: "tree"
  }));
  this.subAreaList.on("selected", function (t) {
    t.sublist.show();
    C("TAB");
    e.subAreaList.refresh();
    e.subAreaList.scrollToElement(t);
  });
  this.subAreaList.on("deselected", function (t) {
    t.sublist.hide();
    e.subAreaList.refresh();
  });
  window.raceList = this.raceList = t.appendChild(new _({
    className: "tree"
  }));
  this.raceList.on("selected", function (t) {
    t.sublist.show();
    C("TAB");
    e.raceList.refresh();
    e.raceList.scrollToElement(t);
  });
  this.raceList.on("deselected", function (t) {
    t.sublist.hide();
    e.raceList.refresh();
  });
  var n = i.addTab(M("ui.monster.areas"), this.subAreaList, "areas"),
    o = i.getTabTarget(n);
  o.on("opened", function () {
    e.subAreaList.refresh();
  });
  n = i.addTab(M("ui.monster.families"), this.raceList, "families");
  var a = i.getTabTarget(n);
  a.on("opened", function () {
    e.raceList.refresh();
  });
  i.openFirstTab();
  this.monsterList = new _();
  this.monsterList = this.col2.appendChild(this.monsterList);
  this.monsterList.on("selected", function (t) {
    t.more ? (t.more.show(), this.refresh()) : e._createMonsterMoreInfo(t);
  });
  this.monsterList.on("deselected", function (e) {
    e.more.hide();
    this.refresh();
  });
  this.noResultText = this.monsterList.createChild("div", {
    className: "noResultText",
    text: M("ui.search.noResult")
  });
  this.errorText = this.monsterList.createChild("div", {
    className: "errorText",
    text: M("ui.secureMode.error.default")
  });
  e.errorText.hide();
  var s = this.col2.appendChild(new S(M("ui.monster.showCriteriaDrop")));
  s.on("change", function (t) {
    e.toggleClassName("showCriteriaDrop", t);
    e.monsterList.refresh();
  });
};
s.prototype._setupEvents = function () {
  var e = this,
    t = window.gui;
  t.on("disconnect", function () {
    e.selectedSubAreaElement = null;
    e.selectedRaceElement = null;
    e.updateRequired = !0;
    e.params = {};
  });
  t.playerData.position.on("worldMapUpdate", function () {
    e._refreshMapLocation();
  });
};
s.prototype._getAreaStaticData = function (e) {
  var t = this;
  g.getAllDataTable(["Areas", "SubAreas"], function (i, n) {
    return i ? console.error(i) : (O = n.Areas || [], R = n.SubAreas || [], O.sort(t._sortByName), R.sort(t._sortByName), void e());
  });
};
s.prototype._getMonsterFamilyStaticData = function (e) {
  var t = this;
  g.getAllDataTable(["MonsterSuperRaces", "MonsterRaces"], function (i, n) {
    return i ? console.error(i) : (D = n.MonsterSuperRaces || [], P = n.MonsterRaces || [], D.sort(t._sortByName), P.sort(t._sortByName), void e());
  });
};
s.prototype._createAreaCategories = function () {
  for (var e = this, t = 0, i = O.length; t < i; t += 1) {
    var n = O[t],
      o = new f("div", {
        className: "label"
      });
    o.createChild("div", {
      className: "arrow"
    });
    o.createChild("div", {
      className: "text",
      text: n.nameId
    });
    var a = e.subAreaList.addItem({
      id: n.id,
      element: o
    }, {
      noRefresh: !0
    });
    a.hide();
    a.sublist = a.appendChild(new f("div", {
      className: "sublist"
    }));
    a.sublist.hide();
  }
};
s.prototype._createMonsterFamilyCategories = function () {
  for (var e = this, t = 0, i = D.length; t < i; t += 1) {
    var n = D[t],
      o = new f("div", {
        className: "label"
      });
    o.createChild("div", {
      className: "arrow"
    });
    o.createChild("div", {
      className: "text",
      text: n.nameId
    });
    var a = e.raceList.addItem({
      id: n.id,
      element: o
    }, {
      noRefresh: !0
    });
    a.hide();
    a.sublist = a.appendChild(new f("div", {
      className: "sublist"
    }));
    a.sublist.hide();
  }
};
s.prototype._updateSubAreaList = function () {
  this.updateRequired = !1;
  this._reset();
  this._generateSubAreaList();
  this._generateRaceList();
};
s.prototype._reset = function () {
  this._resetSelectedSubAreaElement();
  this._resetSelectedRaceElement();
};
s.prototype._resetSelectedSubAreaElement = function () {
  this.selectedSubAreaElement && (this.selectedSubAreaElement.delClassNames("selected"), this.selectedSubAreaElement = null);
};
s.prototype._resetSelectedRaceElement = function () {
  this.selectedRaceElement && (this.selectedRaceElement.delClassNames("selected"), this.selectedRaceElement = null);
};
s.prototype._refreshMapLocation = function () {
  var e = this.monsterList.getItems();
  for (var t in e) {
    var i = e[t],
      n = i.monsterData,
      o = i.mapLocationDom;
    o.clearContent();
    o.appendChild(b.createMapLocation(n.subareas, this.subAreas, n.favoriteSubareaId));
  }
};
s.prototype._generateSubAreaList = function () {
  var e = this;
  R.forEach(function (t) {
    if (e.subAreas[t.id] = t, 0 !== e.subAreas[t.id].monsters.length && e.subAreaList.getItem(t.areaId)) {
      var i = new f("div", {
        className: "label",
        name: t.id
      });
      i.createChild("div", {
        className: "text",
        text: t.nameId
      });
      e.subAreaList.getItem(t.areaId).sublist.appendChild(i);
      E(i);
      i.on("tap", function () {
        e._resetSelectedSubAreaElement();
        i.addClassNames("selected");
        e.selectedSubAreaElement = i;
        e._showMonsters(e.subAreas[t.id].monsters, "");
      });
    }
  });
  R = [];
  this._showAllListItems(this.subAreaList);
};
s.prototype._generateRaceList = function () {
  var e = this;
  P.forEach(function (t) {
    if (t.monsters.length > 0) {
      var i = new f("div", {
        className: "label",
        name: t.id
      });
      i.createChild("div", {
        className: "text",
        text: t.nameId
      });
      e.raceList.getItem(t.superRaceId).sublist.appendChild(i);
      E(i);
      i.on("tap", function () {
        e._resetSelectedRaceElement();
        i.addClassNames("selected");
        e.selectedRaceElement = i;
        e._showMonsters(e.races[t.id].monsters, "");
      });
      e.races[t.id] = t;
    }
  });
  P = [];
  this._showAllListItems(e.raceList);
};
s.prototype._selectSubArea = function (e, t) {
  if (0 === e || e) {
    var i = this.subAreaList.getItem(e);
    if (i) {
      this.subAreaList.selectItem(e);
      var n = i.sublist.getChild(t);
      n.tap();
      this.subAreaList.showElement(n);
    }
  }
};
s.prototype._showAllListItems = function (e) {
  for (var t, i, n, o = e.getItems(), a = !0, s = 0; s < o.length; s += 1) {
    t = o[s];
    i = t.sublist.getChildren();
    a = !0;
    for (var r = 0; r < i.length; r += 1) {
      n = i[r];
      a = !1;
      n.show();
    }
    a ? t.hide() : t.show();
  }
  e.refresh();
};
s.prototype._createMonsterMoreInfo = function (e) {
  function t(e, t) {
    var i = a.min[t],
      n = a.max[t],
      o = e + ": " + i;
    i !== n && (o += " " + M("ui.chat.to") + " " + n);
    s.createChild("div", {
      className: "stat",
      text: o
    });
  }
  function i(e) {
    var t = a.min[e],
      i = a.max[e],
      n = t;
    t !== i && (n += " " + M("ui.chat.to") + " " + i);
    r.createChild("div", {
      className: ["stat", "resistance", e],
      text: n
    });
  }
  e.more = e.createChild("div", {
    className: "more"
  });
  var n = e.more.createChild("div", {
      className: "cf"
    }),
    o = e.monsterData,
    a = e.gradeMinMaxInfo,
    s = n.createChild("div", {
      className: ["col", "colLeft"]
    });
  s.createChild("div", {
    className: "subtitle",
    text: M("ui.common.caracteristics")
  });
  t(M("ui.short.lifePoints"), "lifePoints");
  t(M("ui.short.actionPoints"), "actionPoints");
  t(M("ui.short.movementPoints"), "movementPoints");
  var r = n.createChild("div", {
    className: ["col", "colRight"]
  });
  r.createChild("div", {
    className: "subtitle",
    text: M("ui.common.resistances")
  });
  i("neutralResistance");
  i("earthResistance");
  i("fireResistance");
  i("waterResistance");
  i("airResistance");
  this._createMonsterDrops(e, o.drops);
};
s.prototype._createMonsterDrops = function (e, t) {
  if (0 !== t.length) {
    e.more.createChild("div", {
      className: "subtitle",
      text: M("ui.common.loot")
    });
    this.monsterList.refresh();
    var i = t.map(function (e) {
        return e.objectId;
      }),
      n = this;
    v.getItems(i, function (o) {
      if (o) {
        return console.error("Failed to get items", o);
      }
      for (var s = 0; s < i.length; s += 1) {
        var r = i[s],
          l = v.items[r];
        if (l) {
          if (window.gui.playerData.isAdmin() || l.typeId !== y.types.marker) {
            var c = new w();
            e.more.appendChild(c);
            c.itemDataElement = l;
            var u = a(t[s]);
            c.dropInfo = {
              findCeil: t[s].findCeil,
              dropMinPercent: u.min,
              dropMaxPercent: u.max,
              hasProspectionBonus: t[s].hasProspectionBonus,
              hasPackBonus: t[s].hasPackBonus
            };
            c.setTooltip(d);
            c.toggleClassName("special", t[s].hasCriteria);
            c.setItem(l);
            c.setContextMenu("item", {
              item: l
            });
            c.dropInfo.dropMinPercent < 2 ? c.addClassNames("rareDrop") : c.dropInfo.dropMinPercent < 10 && c.addClassNames("okDrop");
          }
        } else {
          console.warn("monster", e.monsterData.id, "contains invalid drop item in pos ", s);
        }
      }
      n.monsterList.refresh();
    });
  }
};
B = [];
g.getAllDataTable("Monsters", function (t, i) {
  if (t) {
    var n = new Error("integrity error: " + t);
    return N.error(n), e(n);
  }
  var o = {},
    a = {},
    s = {},
    l = {};
  for (var c in i) {
    if (i.hasOwnProperty(c)) {
      var d = i[c],
        u = I.parseLook(N, d.look, "Monster " + d.id).bone;
      o["gfx/monsters/" + d.id + ".png"] = !0;
      a[d.id] = u;
      l[d.id] = d.look;
      s[u] ? s[u].push(d.id) : s[u] = [d.id];
    }
  }
  var m = Object.keys(o);
  T.preloadImageUrls(m, function (t) {
    var i = [];
    h.forEachLimit(t, 10, function (e, t) {
      p.open({
        uri: e
      }, function (n) {
        n && i.push({
          error: n,
          url: e
        });
        t();
      });
    }, function (n) {
      n && N.error(n);
      var o = [];
      if (i.length > 0) {
        for (var c, d = [], u = {}, h = 0; h < i.length; h += 1) {
          var p = i[h];
          N.error(p.error);
          var m = p.url || "",
            f = m.split("/").pop(),
            g = f.split(".")[0];
          c = a[g] || -1;
          c <= 1 ? d.push([g, l[g]]) : u[c] ? u[c].push(g) : u[c] = [g];
        }
        var _ = Object.keys(u).length,
          v = "[Bestiary integrity] Missing bones count: " + _;
        N.error(v);
        o.push(v);
        for (c in u) {
          if (u.hasOwnProperty(c)) {
            var y = u[c];
            v = 'Missing bones: "' + c + '" for monster id "' + y.join(",") + '"';
            var w = r(y, s[c]);
            w && (v += ' can steal from: "' + w + '"');
            N.error(v);
            o.push(v);
          }
        }
        if (d.length > 0) {
          var b = d.length;
          o.push("");
          v = "[Bestiary integrity] Missing bones 1 or null count: " + b;
          N.error(v);
          o.push(v);
          for (var M = 0, T = d.length; M < T; M += 1) {
            var C = d[M];
            v = 'Do something for monster "' + C[0] + '" with bones 1 or null and look: "';
            v += C[1] + '"';
            N.error(v);
            o.push(v);
          }
        }
        o.length && N.log(o.join("[LF]"));
        B.length && N.log("Command to do inside compiled gfx/monsters folder: mkdir copyToSources ; " + B.join(" ; "));
      }
      return N.log("done! (urls: " + t.length + ", errors: " + i.length + ")"), e(n, o.join("\n"));
    });
  });
});
o["gfx/monsters/" + d.id + ".png"] = !0;
a[d.id] = u;
l[d.id] = d.look;
s[u] ? s[u].push(d.id) : s[u] = [d.id];
n && i.push({
  error: n,
  url: e
});
t();
c = a[g] || -1;
c <= 1 ? d.push([g, l[g]]) : u[c] ? u[c].push(g) : u[c] = [g];
N.error(v);
o.push(v);
w && (v += ' can steal from: "' + w + '"');
N.error(v);
o.push(v);
o.push("");
v = "[Bestiary integrity] Missing bones 1 or null count: " + b;
N.error(v);
o.push(v);
v = 'Do something for monster "' + C[0] + '" with bones 1 or null and look: "';
v += C[1] + '"';
N.error(v);
o.push(v);
o.length && N.log(o.join("[LF]"));
B.length && N.log("Command to do inside compiled gfx/monsters folder: mkdir copyToSources ; " + B.join(" ; "));
this.monsterList.clearContent();
this.monsterList.delClassNames("spinner");
e.isBoss && r.push("boss");
e.isMiniBoss && r.push("miniBoss");
e.isQuestMonster && r.push("questMonster");
l && (c += " (" + e.id + ")");
s.createChild("div", {
  className: r,
  text: c
});
u !== h && (p += " " + M("ui.chat.to") + " " + h);
s.createChild("div", {
  className: "level",
  text: p
});
g.addClassNames("monster");
g.monsterData = e;
g.gradeMinMaxInfo = d;
g.mapLocationDom = m;
t._selectSubArea(i, n);
t._showMonsters(t.subAreas[n].monsters, "");
this.searchBlock = this.col2.createChild("div", {
  className: "searchBlock"
});
this.searchBox = this.searchBlock.appendChild(new A());
this.searchBox.on("search", function (t) {
  e._search(t);
});
window.subAreaList = this.subAreaList = t.appendChild(new _({
  className: "tree"
}));
this.subAreaList.on("selected", function (t) {
  t.sublist.show();
  C("TAB");
  e.subAreaList.refresh();
  e.subAreaList.scrollToElement(t);
});
this.subAreaList.on("deselected", function (t) {
  t.sublist.hide();
  e.subAreaList.refresh();
});
window.raceList = this.raceList = t.appendChild(new _({
  className: "tree"
}));
this.raceList.on("selected", function (t) {
  t.sublist.show();
  C("TAB");
  e.raceList.refresh();
  e.raceList.scrollToElement(t);
});
this.raceList.on("deselected", function (t) {
  t.sublist.hide();
  e.raceList.refresh();
});
t.sublist.show();
C("TAB");
e.subAreaList.refresh();
e.subAreaList.scrollToElement(t);
t.sublist.hide();
e.subAreaList.refresh();
t.sublist.show();
C("TAB");
e.raceList.refresh();
e.raceList.scrollToElement(t);
t.sublist.hide();
e.raceList.refresh();
o.on("opened", function () {
  e.subAreaList.refresh();
});
n = i.addTab(M("ui.monster.families"), this.raceList, "families");
a.on("opened", function () {
  e.raceList.refresh();
});
i.openFirstTab();
this.monsterList = new _();
this.monsterList = this.col2.appendChild(this.monsterList);
this.monsterList.on("selected", function (t) {
  t.more ? (t.more.show(), this.refresh()) : e._createMonsterMoreInfo(t);
});
this.monsterList.on("deselected", function (e) {
  e.more.hide();
  this.refresh();
});
this.noResultText = this.monsterList.createChild("div", {
  className: "noResultText",
  text: M("ui.search.noResult")
});
this.errorText = this.monsterList.createChild("div", {
  className: "errorText",
  text: M("ui.secureMode.error.default")
});
e.errorText.hide();
e.more.hide();
this.refresh();
e.toggleClassName("showCriteriaDrop", t);
e.monsterList.refresh();
t.on("disconnect", function () {
  e.selectedSubAreaElement = null;
  e.selectedRaceElement = null;
  e.updateRequired = !0;
  e.params = {};
});
t.playerData.position.on("worldMapUpdate", function () {
  e._refreshMapLocation();
});
e.selectedSubAreaElement = null;
e.selectedRaceElement = null;
e.updateRequired = !0;
e.params = {};
o.createChild("div", {
  className: "arrow"
});
o.createChild("div", {
  className: "text",
  text: n.nameId
});
a.hide();
a.sublist = a.appendChild(new f("div", {
  className: "sublist"
}));
a.sublist.hide();
o.createChild("div", {
  className: "arrow"
});
o.createChild("div", {
  className: "text",
  text: n.nameId
});
a.hide();
a.sublist = a.appendChild(new f("div", {
  className: "sublist"
}));
a.sublist.hide();
this.updateRequired = !1;
this._reset();
this._generateSubAreaList();
this._generateRaceList();
this._resetSelectedSubAreaElement();
this._resetSelectedRaceElement();
o.clearContent();
o.appendChild(b.createMapLocation(n.subareas, this.subAreas, n.favoriteSubareaId));
R.forEach(function (t) {
  if (e.subAreas[t.id] = t, 0 !== e.subAreas[t.id].monsters.length && e.subAreaList.getItem(t.areaId)) {
    var i = new f("div", {
      className: "label",
      name: t.id
    });
    i.createChild("div", {
      className: "text",
      text: t.nameId
    });
    e.subAreaList.getItem(t.areaId).sublist.appendChild(i);
    E(i);
    i.on("tap", function () {
      e._resetSelectedSubAreaElement();
      i.addClassNames("selected");
      e.selectedSubAreaElement = i;
      e._showMonsters(e.subAreas[t.id].monsters, "");
    });
  }
});
R = [];
this._showAllListItems(this.subAreaList);
i.createChild("div", {
  className: "text",
  text: t.nameId
});
e.subAreaList.getItem(t.areaId).sublist.appendChild(i);
E(i);
i.on("tap", function () {
  e._resetSelectedSubAreaElement();
  i.addClassNames("selected");
  e.selectedSubAreaElement = i;
  e._showMonsters(e.subAreas[t.id].monsters, "");
});
e._resetSelectedSubAreaElement();
i.addClassNames("selected");
e.selectedSubAreaElement = i;
e._showMonsters(e.subAreas[t.id].monsters, "");
P.forEach(function (t) {
  if (t.monsters.length > 0) {
    var i = new f("div", {
      className: "label",
      name: t.id
    });
    i.createChild("div", {
      className: "text",
      text: t.nameId
    });
    e.raceList.getItem(t.superRaceId).sublist.appendChild(i);
    E(i);
    i.on("tap", function () {
      e._resetSelectedRaceElement();
      i.addClassNames("selected");
      e.selectedRaceElement = i;
      e._showMonsters(e.races[t.id].monsters, "");
    });
    e.races[t.id] = t;
  }
});
P = [];
this._showAllListItems(e.raceList);
i.createChild("div", {
  className: "text",
  text: t.nameId
});
e.raceList.getItem(t.superRaceId).sublist.appendChild(i);
E(i);
i.on("tap", function () {
  e._resetSelectedRaceElement();
  i.addClassNames("selected");
  e.selectedRaceElement = i;
  e._showMonsters(e.races[t.id].monsters, "");
});
e.races[t.id] = t;
e._resetSelectedRaceElement();
i.addClassNames("selected");
e.selectedRaceElement = i;
e._showMonsters(e.races[t.id].monsters, "");
n.tap();
this.subAreaList.showElement(n);
t = o[s];
i = t.sublist.getChildren();
a = !0;
n = i[r];
a = !1;
n.show();
i !== n && (o += " " + M("ui.chat.to") + " " + n);
s.createChild("div", {
  className: "stat",
  text: o
});
t !== i && (n += " " + M("ui.chat.to") + " " + i);
r.createChild("div", {
  className: ["stat", "resistance", e],
  text: n
});
s.createChild("div", {
  className: "subtitle",
  text: M("ui.common.caracteristics")
});
t(M("ui.short.lifePoints"), "lifePoints");
t(M("ui.short.actionPoints"), "actionPoints");
t(M("ui.short.movementPoints"), "movementPoints");
r.createChild("div", {
  className: "subtitle",
  text: M("ui.common.resistances")
});
i("neutralResistance");
i("earthResistance");
i("fireResistance");
i("waterResistance");
i("airResistance");
this._createMonsterDrops(e, o.drops);
e.more.createChild("div", {
  className: "subtitle",
  text: M("ui.common.loot")
});
this.monsterList.refresh();
e.more.appendChild(c);
c.itemDataElement = l;
c.dropInfo = {
  findCeil: t[s].findCeil,
  dropMinPercent: u.min,
  dropMaxPercent: u.max,
  hasProspectionBonus: t[s].hasProspectionBonus,
  hasPackBonus: t[s].hasPackBonus
};
c.setTooltip(d);
c.toggleClassName("special", t[s].hasCriteria);
c.setItem(l);
c.setContextMenu("item", {
  item: l
});
c.dropInfo.dropMinPercent < 2 ? c.addClassNames("rareDrop") : c.dropInfo.dropMinPercent < 10 && c.addClassNames("okDrop");
l.nameId.indexOf(T) === -1 && T !== M && (A += " (" + T + ")");
b += e.length >= 2 ? " - " + s("tablet.area.favorite") + s("ui.common.colon") + A : s("ui.common.colon") + A;
a.call(this, {
  className: "mapLocationBtn"
});
this.type = e.type;
this.subareaId = e.subareaId;
this.subareaIds = e.subareaIds;
this.favorite = e.favorite;
this.centerOn = e.centerOn;
this.x = e.x;
this.y = e.y;
this.on("tap", this._tapHandler);
t.createMapLocation = function (e, t, i) {
  var a = new c("div", {
      className: "mapLocation"
    }),
    s = n(e, t, i);
  return s.subareasInMyWorld && s.subareasInMyWorld.length ? (a.createChild("div", {
    text: s.text,
    className: "mapLocationText"
  }), a.appendChild(new o({
    subareaIds: s.subareasInMyWorld,
    favorite: s.favorite,
    centerOn: s.centerOn
  })), a) : (a.setText(s.text), a);
};
r(o, a);
t.MapLocationButton = o;
o.prototype._tapHandler = function () {
  "zaap" === this.type && window.gui.emit("CompassUpdateMessage", {
    type: "zaap",
    worldX: this.x,
    worldY: this.y
  });
  "quest" === this.type && window.gui.emit("CompassUpdateMessage", {
    type: d.COMPASS_TYPE_QUEST,
    worldX: this.x,
    worldY: this.y
  });
  void 0 !== this.x ? l.open("worldMap", {
    x: this.x,
    y: this.y
  }) : this.subareaId ? l.open("worldMap", {
    subarea: this.subareaId
  }) : this.subareaIds && l.open("worldMap", {
    subareas: this.subareaIds,
    favorite: this.favorite,
    centerOn: this.centerOn
  });
};
"zaap" === this.type && window.gui.emit("CompassUpdateMessage", {
  type: "zaap",
  worldX: this.x,
  worldY: this.y
});
"quest" === this.type && window.gui.emit("CompassUpdateMessage", {
  type: d.COMPASS_TYPE_QUEST,
  worldX: this.x,
  worldY: this.y
});
void 0 !== this.x ? l.open("worldMap", {
  x: this.x,
  y: this.y
}) : this.subareaId ? l.open("worldMap", {
  subarea: this.subareaId
}) : this.subareaIds && l.open("worldMap", {
  subareas: this.subareaIds,
  favorite: this.favorite,
  centerOn: this.centerOn
});
this._titlesAndOrnaments = null;
this._currentTitleId = null;
this._currentOrnamentId = null;
this._titlesAndOrnamentsListRequested = !1;
this.once("open", function (i) {
  t._createDom();
  t._displayLoading(!0);
  t._loadContent(function () {
    t._setupEvents();
    t.on("opened", e);
    e(i);
  });
  var n = window.gui.playerData.characterBaseInformations.entityLook;
  t._updateCharacter(n);
});
t._createDom();
t._displayLoading(!0);
t._loadContent(function () {
  t._setupEvents();
  t.on("opened", e);
  e(i);
});
t._setupEvents();
t.on("opened", e);
e(i);
c(n, f);
e.exports = n;
n.prototype._selectOnceReady = function () {
  this._ornamentIdToSelect ? (this.tabs.openTab("ornaments"), this.ornamentList.selectItem(this._ornamentIdToSelect)) : this._titleIdToSelect ? (this.tabs.openTab("titles"), this.titleList.selectItem(this._titleIdToSelect)) : this._selectActiveTitleAndOrnament();
};
n.prototype._setupEvents = function () {
  var e = this;
  window.gui.on("disconnect", function () {
    e._titlesAndOrnamentsListRequested = !1;
    e.tabs && e.tabs.openFirstTab();
  });
  window.gui.on("TitlesAndOrnamentsListMessage", function (t) {
    e._titlesAndOrnaments = t;
    e._titlesAndOrnaments.titles.push(0);
    e._titlesAndOrnaments.ornaments.push(0);
    e._updateOrnamentList();
    e._updateTitleList();
    e._displayLoading(!1);
    var i = m.getValue("dofus_titleOrnaments_display_all", !1);
    e.showAllCheckbox.toggleActivation(i);
    e._selectOnceReady();
  });
  window.gui.on("OrnamentSelectedMessage", function (t) {
    e._titlesAndOrnaments && (e._titlesAndOrnaments.activeOrnament = t.ornamentId);
  });
  window.gui.on("TitleSelectedMessage", function (t) {
    e._titlesAndOrnaments && (e._titlesAndOrnaments.activeTitle = t.titleId);
  });
  window.gui.on("OrnamentSelectErrorMessage", function () {});
  window.gui.on("TitleSelectErrorMessage", function () {});
  window.gui.on("TitleGainedMessage", function (t) {
    var i = t.titleId;
    e._titlesAndOrnaments.titles.push(i);
    e._updateTitleList();
    e._displayObtainedTitles();
  });
  window.gui.on("TitleLostMessage", function (t) {
    var i = t.titleId,
      n = e._titlesAndOrnaments.titles.indexOf(i);
    n !== -1 && e._titlesAndOrnaments.titles.splice(n, 1);
    e._updateTitleList();
    e._displayObtainedTitles();
  });
  window.gui.on("OrnamentGainedMessage", function (t) {
    var i = t.ornamentId;
    e._titlesAndOrnaments.ornaments.push(i);
    e._updateOrnamentList();
    e._displayObtainedOrnaments();
  });
  window.gui.playerData.on("lookUpdate", function (t) {
    e.character && e._updateCharacter(t);
  });
};
n.prototype._createDom = function () {
  var e = this,
    t = this.createChild("div", {
      className: "col1"
    });
  this.col2 = this.createChild("div", {
    className: "col2"
  });
  var i = this.tabs = t.appendChild(new p());
  this.titleList = t.appendChild(new u({
    className: "titleList"
  }, {
    disableSelectionToggle: !0
  }));
  this.titleList.on("selected", function (t) {
    e._setCharacterTitle(t.data.id);
    this.showElement(t);
  });
  this.ornamentList = t.appendChild(new u({
    className: "ornamentList"
  }, {
    disableSelectionToggle: !0
  }));
  this.ornamentList.on("selected", function (t) {
    e._setCharacterOrnament(t.data.id);
    this.showElement(t);
  });
  var n = i.addTab(l("ui.ornament.titles"), this.titleList, "titles"),
    o = i.getTabTarget(n);
  o.on("opened", function () {
    e.titleList.refresh();
  });
  n = i.addTab(l("ui.ornament.ornaments"), this.ornamentList, "ornaments");
  var c = i.getTabTarget(n);
  c.on("opened", function () {
    e.ornamentList.refresh();
  });
  i.openFirstTab();
  this.showAllCheckbox = t.appendChild(new r(l("ui.ornament.displayAll")));
  this.showAllCheckbox.on("change", function (t) {
    m.setValue("dofus_titleOrnaments_display_all", t);
    e._displayObtainedTitlesOrnaments();
  });
  this.container = this.col2.createChild("div", {
    className: "container"
  });
  this.character = this.container.appendChild(new s({
    scale: "cover",
    verticalAlign: "bottom"
  }));
  this.ornamentContainer = this.container.createChild("div", {
    className: "ornamentContainer"
  });
  this.ornament = this.ornamentContainer.appendChild(new d());
  this.ornament.on("sizeChanged", function () {
    e.ornament.setStyle("marginTop", "0px");
    var t = e.ornamentContainer.rootElement.offsetHeight - this.getHeight();
    t < 0 && (t = 0);
    e.ornament.setStyle("marginTop", t + "px");
    e.ornament.setStyle("marginLeft", "0px");
    var i = 0,
      n = "50%";
    e.ornament.getCanvasOffsetWidth() > e.ornamentContainer.rootElement.offsetWidth && (i = .5 * -(e.ornament.getCanvasOffsetWidth() - e.ornamentContainer.rootElement.offsetWidth), n = Math.round(e.ornament.getCanvasOffsetWidth() / 2) + "px");
    e.ornament.alignmentWingsWrapper.setStyle("left", n);
    e.ornament.alignmentTailWrapper.setStyle("left", n);
    e.ornament.setStyle("marginLeft", i + "px");
  });
  this.warningWings = this.col2.createChild("div", {
    className: "warningWings",
    text: l("ui.ornament.warningWings"),
    hidden: !0
  });
  var h = this.col2.createChild("div", {
      className: "buttons"
    }),
    f = h.appendChild(new a(l("ui.common.reset")));
  this.saveButton = h.appendChild(new a(l("ui.common.save")));
  this.saveButton.disable();
  f.on("tap", function () {
    e._selectActiveTitleAndOrnament();
    e.saveButton.disable();
  });
  this.saveButton.on("tap", function () {
    var t = e._getActiveTitleId(),
      i = e._getActiveOrnamentId();
    t !== e._currentTitleId && window.dofus.sendMessage("TitleSelectRequestMessage", {
      titleId: e._currentTitleId
    });
    i !== e._currentOrnamentId && window.dofus.sendMessage("OrnamentSelectRequestMessage", {
      ornamentId: e._currentOrnamentId
    });
    this.disable();
  });
};
n.prototype._addTitleElement = function (e) {
  var t = this._getTitleText(e),
    i = new f("div", {
      className: "row",
      text: t || l("ui.common.none")
    });
  this.titleList.addItem({
    id: e.id,
    element: i,
    data: e
  }, {
    noRefresh: !0
  });
};
n.prototype._getTitleText = function (e) {
  var t = window.gui.playerData.characterBaseInformations.sex;
  return t ? e.femaleText : e.maleText;
};
n.prototype._addOrnamentElement = function (e, t) {
  var i = new f("div", {
      className: "row"
    }),
    n = i.createChild("div", {
      className: "icon"
    });
  n.setStyle("backgroundImage", t);
  i.createChild("div", {
    text: e.nameId || l("ui.common.none"),
    className: "name"
  });
  this.ornamentList.addItem({
    id: e.id,
    element: i,
    data: {
      id: e.id,
      assetId: e.assetId,
      visible: e.visible
    }
  }, {
    noRefresh: !0
  });
};
n.prototype._loadContent = function (e) {
  var t = this;
  h.getAllDataTable(["Titles", "Ornaments"], function (i, n) {
    if (i) {
      return console.error("Titles and Ornaments: failed getting data", i), e(i);
    }
    for (var a = n.Titles, s = n.Ornaments, r = ["ui/slot.png", "gfx/illusUi/tx_bgTitleOrnament.png"], l = {}, c = 0; c < s.length; c++) {
      var d = s[c].iconId;
      void 0 === l[d] && (r.push("gfx/ornaments/" + d + ".png"), l[d] = r.length - 1);
    }
    o.preloadImages(r, function (i) {
      t.container.setStyle("backgroundImage", i[1]);
      t._addTitleElement({
        id: 0
      });
      t._addOrnamentElement({
        id: 0
      }, i[0]);
      var n, o;
      for (n = 0; n < a.length; n += 1) {
        o = a[n];
        t._addTitleElement({
          id: o.id,
          maleText: o.nameMaleId,
          femaleText: o.nameFemaleId,
          visible: o.visible
        });
      }
      for (n = 0; n < s.length; n++) {
        o = s[n];
        t._addOrnamentElement(o, i[l[o.iconId]]);
      }
      e();
    });
  });
};
n.prototype._displayLoading = function (e) {
  this.titleList.toggleClassName("spinner", e);
  this.ornamentList.toggleClassName("spinner", e);
  this.titleList.getContentElement().toggleDisplay(!e);
  this.ornamentList.getContentElement().toggleDisplay(!e);
};
n.prototype._getActiveOrnamentId = function () {
  return this._titlesAndOrnaments && this._titlesAndOrnaments.activeOrnament;
};
n.prototype._getActiveTitleId = function () {
  return this._titlesAndOrnaments && this._titlesAndOrnaments.activeTitle;
};
n.prototype._getOwnedOrnaments = function () {
  return this._titlesAndOrnaments && this._titlesAndOrnaments.ornaments;
};
n.prototype._getOwnedTitles = function () {
  return this._titlesAndOrnaments && this._titlesAndOrnaments.titles;
};
n.prototype._updateCharacter = function (e) {
  console.log("Setting character's look", e);
  this.character.setLook(e, {
    riderOnly: !0,
    direction: 2,
    boneType: "characters/",
    skinType: "characters/"
  });
};
n.prototype._selectActiveTitleAndOrnament = function () {
  if (this._titlesAndOrnaments) {
    var e = this._getActiveTitleId(),
      t = this._getActiveOrnamentId();
    this._currentTitleId = e;
    this._currentOrnamentId = t;
    this.titleList.deselectAll();
    this.ornamentList.deselectAll();
    this.titleList.selectItem(e, {
      noEvent: !0,
      noSound: !0
    });
    this.ornamentList.selectItem(t, {
      noEvent: !0,
      noSound: !0
    });
    this._setCharacterTitleAndOrnament(e, t);
  }
};
n.prototype._displayObtainedTitles = function () {
  for (var e = m.getValue("dofus_titleOrnaments_display_all", !1), t = this.titleList.getItems(), i = 0, n = 0; n < t.length; n += 1) {
    var o = t[n],
      a = e && o.data.visible;
    o.toggleDisplay(a || o.data.isAvailable);
    o.isVisible() && (o.toggleClassName("odd", i % 2 === 0), i += 1);
  }
  if (this.titleList.refresh(), null !== this._currentTitleId) {
    var s = this.titleList.getItem(this._currentTitleId);
    s.data.isAvailable || this.titleList.selectItem(this._getActiveTitleId(), {
      noSound: !0
    });
  }
};
n.prototype._displayObtainedOrnaments = function () {
  for (var e = m.getValue("dofus_titleOrnaments_display_all", !1), t = this.ornamentList.getItems(), i = 0, n = 0; n < t.length; n += 1) {
    var o = t[n],
      a = e && o.data.visible;
    o.toggleDisplay(a || o.data.isAvailable);
    o.isVisible() && (o.toggleClassName("odd", i % 2 === 0), i += 1);
  }
  if (this.ornamentList.refresh(), null !== this._currentOrnamentId) {
    var s = this.ornamentList.getItem(this._currentOrnamentId);
    s.data.isAvailable || this.ornamentList.selectItem(this._getActiveOrnamentId(), {
      noSound: !0
    });
  }
};
n.prototype._displayObtainedTitlesOrnaments = function () {
  this._displayObtainedTitles();
  this._displayObtainedOrnaments();
};
n.prototype._updateTitleList = function () {
  for (var e = this._getOwnedTitles(), t = this.titleList.getItems(), i = 0; i < t.length; i += 1) {
    var n = t[i],
      o = n.data.id,
      a = this._getTitleText(n.data);
    if (a) {
      var s = n.getChildren();
      s[0].setText(a);
    }
    var r = e.indexOf(o) >= 0;
    n.data.isAvailable = r;
    n.toggleClassName("unavailable", !r);
  }
};
n.prototype._updateOrnamentList = function () {
  for (var e = this._getOwnedOrnaments(), t = this.ornamentList.getItems(), i = 0; i < t.length; i += 1) {
    var n = t[i],
      o = n.data.id,
      a = e.indexOf(o) >= 0;
    n.data.isAvailable = a;
    n.toggleClassName("unavailable", !a);
  }
};
n.prototype._isSavable = function (e, t) {
  var i = this._getOwnedTitles(),
    n = this._getOwnedOrnaments(),
    o = this._getActiveTitleId(),
    a = this._getActiveOrnamentId();
  return (o !== e || a !== t) && i.indexOf(e) >= 0 && n.indexOf(t) >= 0;
};
n.prototype._setCharacterTitle = function (e) {
  var t = this.titleList.getItem(e);
  this._currentTitleId = e;
  var i = this._isSavable(this._currentTitleId, this._currentOrnamentId);
  this.saveButton.setEnable(i);
  this.ornament.changeAttributes({
    title: this._getTitleText(t.data) || ""
  });
  this.ornament.display();
};
n.prototype._setCharacterOrnament = function (e) {
  var t = this.ornamentList.getItem(e);
  this._currentOrnamentId = e;
  var i = this._isSavable(this._currentTitleId, this._currentOrnamentId);
  this.saveButton.setEnable(i);
  this.ornament.changeAttributes({
    ornamentAssetId: t.data.assetId
  });
  this.ornament.display();
};
n.prototype._setCharacterTitleAndOrnament = function (e, t) {
  var i,
    n = window.gui.playerData,
    o = this.titleList.getItem(e),
    a = this.ornamentList.getItem(t);
  o && (i = this._getTitleText(o.data));
  this.ornament.setAttributes({
    charName: window.gui.playerData.characterBaseInformations.name,
    title: i,
    ornamentAssetId: a && a.data && a.data.assetId,
    guild: n.guild && n.guild.current,
    alliance: n.alliance && n.alliance.current,
    alignmentInfos: window.gui.playerData.alignment.alignmentInfos
  });
  this.ornament.display();
  0 !== window.gui.playerData.alignment.alignmentInfos.alignmentGrade ? this.warningWings.show() : this.warningWings.hide();
};
window.gui.on("disconnect", function () {
  e._titlesAndOrnamentsListRequested = !1;
  e.tabs && e.tabs.openFirstTab();
});
window.gui.on("TitlesAndOrnamentsListMessage", function (t) {
  e._titlesAndOrnaments = t;
  e._titlesAndOrnaments.titles.push(0);
  e._titlesAndOrnaments.ornaments.push(0);
  e._updateOrnamentList();
  e._updateTitleList();
  e._displayLoading(!1);
  var i = m.getValue("dofus_titleOrnaments_display_all", !1);
  e.showAllCheckbox.toggleActivation(i);
  e._selectOnceReady();
});
window.gui.on("OrnamentSelectedMessage", function (t) {
  e._titlesAndOrnaments && (e._titlesAndOrnaments.activeOrnament = t.ornamentId);
});
window.gui.on("TitleSelectedMessage", function (t) {
  e._titlesAndOrnaments && (e._titlesAndOrnaments.activeTitle = t.titleId);
});
window.gui.on("OrnamentSelectErrorMessage", function () {});
window.gui.on("TitleSelectErrorMessage", function () {});
window.gui.on("TitleGainedMessage", function (t) {
  var i = t.titleId;
  e._titlesAndOrnaments.titles.push(i);
  e._updateTitleList();
  e._displayObtainedTitles();
});
window.gui.on("TitleLostMessage", function (t) {
  var i = t.titleId,
    n = e._titlesAndOrnaments.titles.indexOf(i);
  n !== -1 && e._titlesAndOrnaments.titles.splice(n, 1);
  e._updateTitleList();
  e._displayObtainedTitles();
});
window.gui.on("OrnamentGainedMessage", function (t) {
  var i = t.ornamentId;
  e._titlesAndOrnaments.ornaments.push(i);
  e._updateOrnamentList();
  e._displayObtainedOrnaments();
});
window.gui.playerData.on("lookUpdate", function (t) {
  e.character && e._updateCharacter(t);
});
e._titlesAndOrnamentsListRequested = !1;
e.tabs && e.tabs.openFirstTab();
e._titlesAndOrnaments = t;
e._titlesAndOrnaments.titles.push(0);
e._titlesAndOrnaments.ornaments.push(0);
e._updateOrnamentList();
e._updateTitleList();
e._displayLoading(!1);
e.showAllCheckbox.toggleActivation(i);
e._selectOnceReady();
e._titlesAndOrnaments.titles.push(i);
e._updateTitleList();
e._displayObtainedTitles();
n !== -1 && e._titlesAndOrnaments.titles.splice(n, 1);
e._updateTitleList();
e._displayObtainedTitles();
e._titlesAndOrnaments.ornaments.push(i);
e._updateOrnamentList();
e._displayObtainedOrnaments();
this.titleList = t.appendChild(new u({
  className: "titleList"
}, {
  disableSelectionToggle: !0
}));
this.titleList.on("selected", function (t) {
  e._setCharacterTitle(t.data.id);
  this.showElement(t);
});
this.ornamentList = t.appendChild(new u({
  className: "ornamentList"
}, {
  disableSelectionToggle: !0
}));
this.ornamentList.on("selected", function (t) {
  e._setCharacterOrnament(t.data.id);
  this.showElement(t);
});
e._setCharacterTitle(t.data.id);
this.showElement(t);
e._setCharacterOrnament(t.data.id);
this.showElement(t);
o.on("opened", function () {
  e.titleList.refresh();
});
n = i.addTab(l("ui.ornament.ornaments"), this.ornamentList, "ornaments");
c.on("opened", function () {
  e.ornamentList.refresh();
});
i.openFirstTab();
this.showAllCheckbox = t.appendChild(new r(l("ui.ornament.displayAll")));
this.showAllCheckbox.on("change", function (t) {
  m.setValue("dofus_titleOrnaments_display_all", t);
  e._displayObtainedTitlesOrnaments();
});
this.container = this.col2.createChild("div", {
  className: "container"
});
this.character = this.container.appendChild(new s({
  scale: "cover",
  verticalAlign: "bottom"
}));
this.ornamentContainer = this.container.createChild("div", {
  className: "ornamentContainer"
});
this.ornament = this.ornamentContainer.appendChild(new d());
this.ornament.on("sizeChanged", function () {
  e.ornament.setStyle("marginTop", "0px");
  var t = e.ornamentContainer.rootElement.offsetHeight - this.getHeight();
  t < 0 && (t = 0);
  e.ornament.setStyle("marginTop", t + "px");
  e.ornament.setStyle("marginLeft", "0px");
  var i = 0,
    n = "50%";
  e.ornament.getCanvasOffsetWidth() > e.ornamentContainer.rootElement.offsetWidth && (i = .5 * -(e.ornament.getCanvasOffsetWidth() - e.ornamentContainer.rootElement.offsetWidth), n = Math.round(e.ornament.getCanvasOffsetWidth() / 2) + "px");
  e.ornament.alignmentWingsWrapper.setStyle("left", n);
  e.ornament.alignmentTailWrapper.setStyle("left", n);
  e.ornament.setStyle("marginLeft", i + "px");
});
this.warningWings = this.col2.createChild("div", {
  className: "warningWings",
  text: l("ui.ornament.warningWings"),
  hidden: !0
});
m.setValue("dofus_titleOrnaments_display_all", t);
e._displayObtainedTitlesOrnaments();
t < 0 && (t = 0);
e.ornament.setStyle("marginTop", t + "px");
e.ornament.setStyle("marginLeft", "0px");
e.ornament.getCanvasOffsetWidth() > e.ornamentContainer.rootElement.offsetWidth && (i = .5 * -(e.ornament.getCanvasOffsetWidth() - e.ornamentContainer.rootElement.offsetWidth), n = Math.round(e.ornament.getCanvasOffsetWidth() / 2) + "px");
e.ornament.alignmentWingsWrapper.setStyle("left", n);
e.ornament.alignmentTailWrapper.setStyle("left", n);
e.ornament.setStyle("marginLeft", i + "px");
this.saveButton = h.appendChild(new a(l("ui.common.save")));
this.saveButton.disable();
f.on("tap", function () {
  e._selectActiveTitleAndOrnament();
  e.saveButton.disable();
});
this.saveButton.on("tap", function () {
  var t = e._getActiveTitleId(),
    i = e._getActiveOrnamentId();
  t !== e._currentTitleId && window.dofus.sendMessage("TitleSelectRequestMessage", {
    titleId: e._currentTitleId
  });
  i !== e._currentOrnamentId && window.dofus.sendMessage("OrnamentSelectRequestMessage", {
    ornamentId: e._currentOrnamentId
  });
  this.disable();
});
e._selectActiveTitleAndOrnament();
e.saveButton.disable();
t !== e._currentTitleId && window.dofus.sendMessage("TitleSelectRequestMessage", {
  titleId: e._currentTitleId
});
i !== e._currentOrnamentId && window.dofus.sendMessage("OrnamentSelectRequestMessage", {
  ornamentId: e._currentOrnamentId
});
this.disable();
n.setStyle("backgroundImage", t);
i.createChild("div", {
  text: e.nameId || l("ui.common.none"),
  className: "name"
});
this.ornamentList.addItem({
  id: e.id,
  element: i,
  data: {
    id: e.id,
    assetId: e.assetId,
    visible: e.visible
  }
}, {
  noRefresh: !0
});
t.container.setStyle("backgroundImage", i[1]);
t._addTitleElement({
  id: 0
});
t._addOrnamentElement({
  id: 0
}, i[0]);
o = a[n];
t._addTitleElement({
  id: o.id,
  maleText: o.nameMaleId,
  femaleText: o.nameFemaleId,
  visible: o.visible
});
o = s[n];
t._addOrnamentElement(o, i[l[o.iconId]]);
this.titleList.toggleClassName("spinner", e);
this.ornamentList.toggleClassName("spinner", e);
this.titleList.getContentElement().toggleDisplay(!e);
this.ornamentList.getContentElement().toggleDisplay(!e);
console.log("Setting character's look", e);
this.character.setLook(e, {
  riderOnly: !0,
  direction: 2,
  boneType: "characters/",
  skinType: "characters/"
});
this._currentTitleId = e;
this._currentOrnamentId = t;
this.titleList.deselectAll();
this.ornamentList.deselectAll();
this.titleList.selectItem(e, {
  noEvent: !0,
  noSound: !0
});
this.ornamentList.selectItem(t, {
  noEvent: !0,
  noSound: !0
});
this._setCharacterTitleAndOrnament(e, t);
o.toggleDisplay(a || o.data.isAvailable);
o.isVisible() && (o.toggleClassName("odd", i % 2 === 0), i += 1);
o.toggleDisplay(a || o.data.isAvailable);
o.isVisible() && (o.toggleClassName("odd", i % 2 === 0), i += 1);
this._displayObtainedTitles();
this._displayObtainedOrnaments();
n.data.isAvailable = r;
n.toggleClassName("unavailable", !r);
n.data.isAvailable = a;
n.toggleClassName("unavailable", !a);
this.saveButton.setEnable(i);
this.ornament.changeAttributes({
  title: this._getTitleText(t.data) || ""
});
this.ornament.display();
this.saveButton.setEnable(i);
this.ornament.changeAttributes({
  ornamentAssetId: t.data.assetId
});
this.ornament.display();
o && (i = this._getTitleText(o.data));
this.ornament.setAttributes({
  charName: window.gui.playerData.characterBaseInformations.name,
  title: i,
  ornamentAssetId: a && a.data && a.data.assetId,
  guild: n.guild && n.guild.current,
  alliance: n.alliance && n.alliance.current,
  alignmentInfos: window.gui.playerData.alignment.alignmentInfos
});
this.ornament.display();
0 !== window.gui.playerData.alignment.alignmentInfos.alignmentGrade ? this.warningWings.show() : this.warningWings.hide();
R = window.gui.playerData.quests;
this.currentQuest = null;
this.selectedQuestElement = null;
this.updateRequired = !0;
this.questsListUpdated = !1;
this.params = {};
this.locateButtonMap = {};
this._previousSearch = "";
R.on("listUpdated", function () {
  e.updateRequired = !0;
  e.questsListUpdated = !0;
  e.isVisible() && (e.emit("open", e.params), e.questsList.delClassNames("spinner"));
});
this.once("open", function () {
  this._createDom();
  this._getQuestCategoryStaticData(function (i) {
    return i ? console.error(i) : (e._createQuestCategories(), e._setupEvents(), t = !0, void e.emit("initialized"));
  });
});
this.on("open", function (e) {
  return this.questsList.toggleClassName("spinner", !this.questsListUpdated), t ? void this._onOpen(e) : this.once("initialized", this._onOpen.bind(this, e));
});
e.updateRequired = !0;
e.questsListUpdated = !0;
e.isVisible() && (e.emit("open", e.params), e.questsList.delClassNames("spinner"));
this._createDom();
this._getQuestCategoryStaticData(function (i) {
  return i ? console.error(i) : (e._createQuestCategories(), e._setupEvents(), t = !0, void e.emit("initialized"));
});
n.addClassNames("rewardSlot");
n.setItem(t);
n.setQuantity(i[t.id]);
n.on("tap", function () {
  S.open("itemBox", {
    itemData: t
  });
});
i.forEach(function (t) {
  if (t) {
    var i = e.appendChild(new T());
    i.addClassNames("rewardSlot");
    o.push(i);
    i.icon.addClassNames("spinner");
    n.push("gfx/emotes/" + t.id + ".png");
    i.setTooltip(t.nameId);
  }
});
c.preloadImages(n, function (e) {
  for (var t = 0, i = e.length; t < i; t += 1) {
    var n = o[t];
    n.rootElement && (n.icon.delClassNames("spinner"), n.setImage(e[t]));
  }
});
i.addClassNames("rewardSlot");
o.push(i);
i.icon.addClassNames("spinner");
n.push("gfx/emotes/" + t.id + ".png");
i.setTooltip(t.nameId);
m(n, E);
e.exports = n;
n.prototype._onOpen = function (e) {
  var t = this;
  this.params = e || {};
  var i = !0,
    n = A.getValue("showCompletedQuest", !1);
  this.showCompletedCheckbox.toggleActivation(n, i);
  this.updateRequired && this._updateQuestList();
  var o = this.params.categoryId || this.currentQuest && this.currentQuest.dbQuest.categoryId,
    a = this.params.questId || this.currentQuest && this.currentQuest.questId;
  setTimeout(function () {
    t._selectQuest(o, a);
  }, 0);
  this._refreshBonus();
};
n.prototype._refreshBonus = function () {
  if (window.gui.playerData.isSubscriberAtMinLevel(O.NORMAL)) {
    var e = L.BONUS_PACK_XP;
    this._bonusPackText.setHtml(h("ui.shop.xpBonusPackJobActive", e, L.BONUS_PACK_XP));
    this._linkToShop.hide();
  } else {
    this._bonusPackText.setHtml(h("tablet.shop.xpBonusInactive", L.BONUS_PACK_XP));
    this._linkToShop.show();
  }
};
n.prototype._search = function (e) {
  if (this._previousSearch = e, "" === e) {
    return void this._updateQuestList();
  }
  var t = {},
    i = x.simplifyString(e),
    n = A.getValue("showCompletedQuest", !1),
    o = n ? R.all : R.active;
  for (var a in o) {
    if (o.hasOwnProperty(a)) {
      var s = o[a];
      if (s.dbQuest && s.dbQuest.nameId && x.simplifyString(s.dbQuest.nameId).indexOf(i) > -1) {
        t[s.questId] = !0;
      } else {
        var r = s.stepId,
          l = s.dbSteps[r];
        if (l.descriptionId && x.simplifyString(l.descriptionId).indexOf(i) > -1 || l.nameId && x.simplifyString(l.nameId).indexOf(i) > -1) {
          t[s.questId] = !0;
        } else {
          for (var c in s.objectives) {
            if (s.objectives.hasOwnProperty(c)) {
              var d = s.objectives[c];
              if (d.text && x.simplifyString(d.text).indexOf(i) > -1) {
                t[s.questId] = !0;
                break;
              }
            }
          }
        }
      }
    }
  }
  this.showSpecificQuests(t);
};
n.prototype.showSpecificQuests = function (e) {
  for (var t = this.questsList.getItems(), i = 0; i < t.length; i += 1) {
    for (var n = t[i], o = n.sublist.getChildren(), a = !0, s = 0; s < o.length; s += 1) {
      var r = o[s],
        l = r.getWuiName();
      e[l] ? (a = !1, r.show()) : r.hide();
    }
    a ? n.hide() : n.show();
  }
  this._updateQuestItemsStyle();
  this.questsList.refresh();
  this._reset();
};
n.prototype._createDom = function () {
  var e = this,
    t = this.createChild("div", {
      className: "col1"
    }),
    i = this.createChild("div", {
      className: "col2"
    }),
    n = i.createChild("div", {
      className: "content"
    }),
    o = i.createChild("div", {
      className: "bonusPackMessage"
    });
  this._bonusPackText = o.createChild("span");
  this._linkToShop = o.appendChild(new d({
    className: "linkToShop",
    scaleOnPress: !1
  }));
  this._linkToShop.on("tap", function () {
    S.open("market", {
      tabId: "shop",
      tabParams: {
        category: "bonuspack"
      }
    });
  });
  var a = t.createChild("div", {
    className: "searchBlock"
  });
  this.searchBox = a.appendChild(new b());
  this.searchBox.on("search", function (t) {
    e._search(t);
  });
  this.counter = t.createChild("div", {
    className: ["header", "counter"]
  });
  this.questsList = t.appendChild(new _({
    className: "tree"
  }));
  this.showCompletedCheckbox = t.appendChild(new u(h("ui.grimoire.displayFinishedQuests")));
  var s = n.createChild("div", {
      className: ["header", "steps"]
    }),
    r = s.createChild("div", {
      className: "followedQuest"
    });
  N(r, h("tablet.ui.grimoire.followQuest"));
  I(r);
  this.questFollowed = r.appendChild(new d({
    className: "followedQuestButton"
  }));
  var l = this._questFollowedToggle.bind(this);
  r.on("tap", l);
  this.questFollowed.on("tap", l);
  this.questFollowed.toggleClassName("selected", !0);
  this.questFollowed.hide();
  this.stepTitle = s.createChild("div", {
    className: "stepTitle"
  });
  this.stepSelector = s.appendChild(new M({
    className: "stepSelector"
  }));
  var c = n.createChild("div", {
    className: "descWrapper"
  });
  c.createChild("div", {
    className: "image"
  });
  this.description = c.createChild("div", {
    className: "description"
  });
  n.createChild("div", {
    className: "header",
    text: h("ui.grimoire.quest.objectives")
  });
  this.objectivePlaceHolder = new E("div", {
    text: h("ui.grimoire.quest.objectivesNonAvailable"),
    name: "objectivePlaceHolder",
    className: "objectiveRow"
  });
  this.objectivesScroller = n.appendChild(new w({
    className: "objectiveList"
  }));
  this.objectives = this.objectivesScroller.content;
  var p = this.rewardHeader = n.createChild("div", {
    className: "header"
  });
  p.createChild("div", {
    className: "rewardTitle",
    text: h("ui.grimoire.quest.rewards")
  });
  var m = this.xpPoint = p.createChild("div", {
    className: "point"
  });
  this.xp = m.createChild("div", {
    className: "text"
  });
  m.createChild("div", {
    className: ["xp", "icon"]
  });
  m.hide();
  var f = this.kamasPoint = p.createChild("div", {
    className: "point"
  });
  this.kamas = f.createChild("div", {
    className: "text"
  });
  f.createChild("div", {
    className: ["kamas", "icon"]
  });
  f.hide();
  this.rewardList = n.createChild("div", {
    className: "rewardList"
  });
  this.stepSelector.on("change", function (t) {
    var i = e.currentQuest.dbSteps[t],
      n = e.currentQuest.dbQuest.stepIds.indexOf(parseInt(t, 10));
    n <= this.index ? e._displayStepData(i) : e._displayUnknownStep(i);
  });
  this.questsList.on("selected", function (t) {
    t.sublist.show();
    e._updateQuestItemsStyle();
    e.questsList.refresh();
    e.questsList.scrollToElement(t);
  });
  this.questsList.on("deselected", function (t) {
    t.sublist.hide();
    e._updateQuestItemsStyle();
    e.questsList.refresh();
  });
  this.showCompletedCheckbox.on("change", function (t) {
    A.setValue("showCompletedQuest", t);
    e._showCompletedQuest();
  });
};
n.prototype._setupEvents = function () {
  var e = this,
    t = window.gui,
    i = t.GPS;
  R.on("questUpdate", function (t) {
    e.isVisible() && e.currentQuest && t === e.currentQuest.questId && e._selectQuest(e.currentQuest.dbQuest.categoryId, e.currentQuest.questId);
  });
  R.on("questFinished", function (t) {
    e._endQuest(t.questId);
    e._sortSublist(t.questId);
    e._showCompletedQuest();
    e._updateQuestCounter();
    e.currentQuest && t.questId === e.currentQuest.questId && e._reset();
  });
  R.on("questStarted", function (t) {
    e._addQuest(t);
    e._sortSublist(t);
    e._showCompletedQuest();
    e._updateQuestCounter();
    e.currentQuest || (e.currentQuest = R.all[t], e.isVisible() && e._selectQuest(e.currentQuest.dbQuest.categoryId, e.currentQuest.questId));
  });
  t.on("disconnect", function () {
    e.currentQuest = null;
    e.selectedQuestElement = null;
    e.updateRequired = !0;
    e.questsListUpdated = !1;
    e.params = {};
    e.locateButtonMap = {};
    e._previousSearch = "";
    e.searchBox.clear();
  });
  i.on("addDestination", function (t) {
    var i = e.locateButtonMap[t.id];
    i && i.rootElement && i.addClassNames("selected");
  });
  i.on("removeDestination", function (t) {
    var i = e.locateButtonMap[t.id];
    i && i.rootElement && i.delClassNames("selected");
  });
};
n.prototype._getQuestCategoryStaticData = function (e) {
  C.getAllDataTable("QuestCategory", function (t, i) {
    return t ? e(t) : (D = i || [], D.sort(function (e, t) {
      return e.order - t.order;
    }), void e());
  });
};
n.prototype._createQuestCategories = function () {
  for (var e = this, t = 0, i = D.length; t < i; t += 1) {
    var n = D[t],
      o = new E("div", {
        className: "label"
      });
    o.createChild("div", {
      className: "arrow"
    });
    o.createChild("div", {
      className: "text",
      text: n.nameId
    });
    var a = o.createChild("div", {
      className: "followedCategoryButton"
    });
    I(a);
    a.on("tap", this._questCategoryFollowToggle.bind(this, [n.id]));
    var s = e.questsList.addItem({
      id: n.id,
      element: o
    }, {
      noRefresh: !0
    });
    s.followButton = a;
    s.hide();
    s.sublist = s.appendChild(new E("div", {
      className: "sublist"
    }));
    s.sublist.hide();
  }
};
n.prototype._updateQuestList = function () {
  this.updateRequired = !1;
  this._reset();
  this._generateQuestList();
  this._updateQuestCounter();
};
n.prototype._reset = function () {
  this.currentQuest = null;
  this._resetSelectedQuestElement();
  this.stepTitle.setText("");
  this.description.setText("");
  this._resetObjectives();
  this.rewardList.clearContent();
  this.kamas.setText("");
  this.kamasPoint.hide();
  this.xp.setText("");
  this.xpPoint.hide();
  this.questsList.deselectAll();
  this.stepSelector.clearContent();
  this.stepSelector.hide();
  this.questFollowed.hide();
};
n.prototype._resetSelectedQuestElement = function () {
  this.selectedQuestElement && (this.selectedQuestElement.delClassNames("selected"), this.selectedQuestElement = null);
};
n.prototype._generateQuestList = function () {
  for (var e = this.questsList.getItems(), t = 0; t < e.length; t += 1) {
    var i = e[t].sublist;
    i.clearContent();
  }
  var n = Object.keys(R.active).sort(),
    o = Object.keys(R.finished).sort();
  for (t = 0; t < n.length; t += 1) {
    this._addQuest(n[t]);
  }
  for (t = 0; t < o.length; t += 1) {
    this._addQuest(o[t]);
  }
  this._showCompletedQuest();
};
n.prototype._updateQuestCounter = function () {
  var e = h("ui.grimoire.pendingQuests", Object.keys(R.active).length),
    t = h("ui.grimoire.completedQuests", Object.keys(R.finished).length);
  this.counter.setText(e + " - " + t);
};
n.prototype._selectQuest = function (e, t) {
  if (e) {
    var i = this.questsList.getItem(e);
    if (i) {
      this.questsList.selectItem(e);
      var n = i.sublist.getChild(t);
      n && (n.hasClassName("completed") || (n.tap(), this.questsList.scrollToElement(n)));
    }
  }
};
n.prototype._updateQuestItemsStyle = function () {
  for (var e, t, i, n = this.questsList.getItems(), o = 0, a = 0; a < n.length; a += 1) {
    if (e = n[a], e.isVisible() && (e.toggleClassName("odd", o % 2 === 0), o += 1, e.sublist.isVisible())) {
      t = e.sublist.getChildren();
      for (var s = 0; s < t.length; s += 1) {
        i = t[s];
        i.isVisible() && (i.toggleClassName("odd", o % 2 === 0), o += 1);
      }
    }
  }
};
n.prototype._showCompletedQuest = function () {
  if ("" !== this._previousSearch) {
    return this._search(this._previousSearch);
  }
  for (var e, t, i, n, o = A.getValue("showCompletedQuest", !1), a = this.questsList.getItems(), s = !0, r = 0; r < a.length; r += 1) {
    t = a[r];
    i = t.sublist.getChildren();
    s = !0;
    for (var l = 0; l < i.length; l += 1) {
      n = i[l];
      e = n.getWuiName();
      o || !R.finished[e] ? (s = !1, n.show()) : n.hide();
    }
    s ? t.hide() : t.show();
  }
  this._updateQuestItemsStyle();
  this.questsList.refresh();
};
n.prototype._resetObjectives = function () {
  this.locateButtonMap = {};
  this._removeObjectivePlaceHolder();
  this.objectives.clearContent();
  this.objectives.appendChild(this.objectivePlaceHolder);
  this.objectivesScroller.refresh();
};
n.prototype._removeObjectivePlaceHolder = function () {
  var e = this.objectives.getChild("objectivePlaceHolder");
  e && this.objectives.removeChild(e);
};
n.prototype._createObjectiveElement = function (e, t, i) {
  var n = new E("div", {
      className: "objectiveRow"
    }),
    o = n.createChild("div", {
      className: "description"
    }),
    s = t.hypertext || t.text;
  o.appendChild(p.process(a(s, i, t.objectiveId, !t.objectiveStatus)));
  var r = t.objectiveStatus;
  n.toggleClassName("complete", !r);
  n.toggleClassName("disabled", !r);
  var l = e.coords;
  return r && (e.mapId || l && void 0 !== l.x) && this._createLocateButton(n, o, e, t, i), n;
};
n.prototype._createLocateButton = function (e, t, i, n, o) {
  var a = window.gui.GPS,
    r = a.getQuestObjectivePoiId(n.objectiveId),
    l = e.appendChild(new d({
      className: "locateButton"
    }, s));
  this.locateButtonMap[r] = l;
  l.toggleClassName("selected", a.isActivePOI(r));
  l.questsWindow = this;
  l.id = r;
  l.objectiveDb = i;
  l.objective = n;
  l.questId = o;
  I(t);
  t.on("tap", s.bind(l));
};
n.prototype._questFollowedToggle = function () {
  var e = window.gui.GPS,
    t = this.currentQuest.questId,
    i = !e.questFollower.isQuestFollowed(t);
  this._updateQuestFollow(t, i, !0);
  this._questCategoryFollowCheck(this.currentQuest.dbQuest.categoryId);
};
n.prototype._questCategoryFollowCheck = function (e) {
  var t = window.gui.GPS,
    i = !1;
  for (var n in R.active) {
    var o = R.active[n].dbQuest;
    if (o.categoryId === e && (i = !0, !t.questFollower.isQuestFollowed(n))) {
      i = !1;
      break;
    }
  }
  var a = this.questsList.getItem(e);
  return a && a.followButton.toggleClassName("selected", i), i;
};
n.prototype._questCategoryFollowToggle = function (e) {
  e = parseInt(e, 10);
  var t = this._questCategoryFollowCheck(e);
  for (var i in R.active) {
    var n = R.active[i].dbQuest;
    n.categoryId === e && this._updateQuestFollow(i, !t, !0);
  }
  this._questCategoryFollowCheck(e);
};
n.prototype._displayStepObjectives = function (e) {
  var t = this;
  this._resetObjectives();
  var i = this.currentQuest.objectives;
  if ((!this.currentQuest || this.currentQuest.questId !== e.questId || this.currentQuest.stepId === e.id) && i.length) {
    this._removeObjectivePlaceHolder();
    for (var n, o = 0, a = i.length; o < a; o += 1) {
      n = i[o];
      this.objectives.appendChild(this._createObjectiveElement(this.currentQuest.dbObjectives[n.objectiveId], n, e.questId));
    }
    window.setTimeout(function () {
      t.objectivesScroller.refresh();
    }, 200);
  }
};
n.prototype._displayStepRewards = function (e) {
  this.rewardList.clearContent();
  for (var t = window.gui.playerData.characterBaseInformations.level, i = 0, n = e.length; i < n; i += 1) {
    var o = this.currentQuest.dbRewards[e[i]];
    !o || o.levelMin !== -1 && t < o.levelMin || o.levelMax !== -1 && t > o.levelMax || (r(this.rewardList, o.itemsReward), l(this.rewardList, o.emotesReward));
  }
};
n.prototype._setKamas = function (e) {
  var t = y.calculateStepKamasRatio(e);
  return t ? (this.kamasPoint.show(), void this.kamas.setText(x.intToString(t))) : void this.kamasPoint.hide();
};
n.prototype._setXp = function (e) {
  var t = window.gui.playerData,
    i = t.characterBaseInformations.level,
    n = t.experienceFactor,
    o = y.calculateStepXpRatio(e, i, n);
  return o ? (this.xpPoint.show(), void this.xp.setText(x.intToString(o))) : void this.xpPoint.hide();
};
n.prototype._displayStepData = function (e) {
  var t = window.gui.GPS;
  this.stepTitle.setText(o(e.nameId, e.id, e.optimalLevel));
  this.description.clearContent();
  this.description.appendChild(p.process(e.descriptionId));
  this.questFollowed.show();
  this.questFollowed.toggleClassName("selected", t.questFollower.isQuestFollowed(this.currentQuest.questId));
  this._displayStepObjectives(e);
  this._displayStepRewards(e.rewardsIds);
  this._setKamas(e);
  this._setXp(e);
};
n.prototype._displayUnknownStep = function (e) {
  this.stepTitle.setText(o(e.nameId, e.id, e.optimalLevel));
  this.description.setText(h("ui.grimoire.quest.descriptionNonAvailable"));
  this._resetObjectives();
  this._displayStepRewards(e.rewardsIds);
  this._setKamas(e);
  this._setXp(e);
};
n.prototype._updateStepList = function () {
  var e = this.currentQuest;
  this.stepSelector.clearContent();
  this.stepSelector.index = 0;
  for (var t = e.dbQuest.stepIds, i = 0, n = t.length; i < n; i += 1) {
    var o = t[i];
    this.stepSelector.addOption(h("ui.grimoire.quest.step") + " " + (i + 1), o);
    e.stepId === o && (this.stepSelector.index = i);
  }
  this.stepSelector.select(e.stepId);
  this.stepSelector.show();
};
n.prototype._getQuestCategoryElement = function (e) {
  var t = R.all[e];
  return t ? this.questsList.getItem(t.dbQuest.categoryId) : null;
};
n.prototype._sortSublist = function (e) {
  var t = this._getQuestCategoryElement(e);
  if (t) {
    var i = t.sublist.getChildren();
    i.sort(function (e, t) {
      return parseInt(e.getWuiName(), 10) - parseInt(t.getWuiName(), 10);
    });
    i.sort(function (e, t) {
      return e.hasClassName("completed") ? 1 : t.hasClassName("completed") ? -1 : 0;
    });
    for (var n = 0; n < i.length; n += 1) {
      t.sublist.appendChild(i[n]);
    }
  }
};
n.prototype._addQuest = function (e) {
  var t = this,
    i = window.gui.GPS,
    n = R.all[e],
    a = this._getQuestCategoryElement(e);
  if (!a) {
    return void console.error(new Error("CategoryElement cannot be found to add questId " + e));
  }
  a.show();
  var s = a.sublist.getChild(e);
  if (!s) {
    var r = new E("div", {
      className: "label",
      name: e
    });
    r.hourglass = r.createChild("div", {
      className: "icon"
    });
    i.questFollower.isQuestFollowed(e) || r.hourglass.addClassNames("notFollowed");
    r.createChild("div", {
      className: "text",
      text: o(n.dbQuest.nameId, e)
    });
    I(r);
    r.on("tap", function () {
      var e = r.getWuiName();
      return R.active[e] ? (v("GEN_BUTTON"), t.currentQuest = R.all[e], t._updateStepList(), t._resetSelectedQuestElement(), r.addClassNames("selected"), void (t.selectedQuestElement = r)) : v("NO_ACTION");
    });
    s = a.sublist.appendChild(r);
  }
  R.active[e] ? s.delClassNames("completed") : s.addClassNames("completed");
  n.dbQuest && this._questCategoryFollowCheck(n.dbQuest.categoryId);
};
n.prototype._endQuest = function (e) {
  var t = window.gui.GPS,
    i = this._getQuestCategoryElement(e);
  if (i) {
    var n = i.sublist.getChild(e);
    if (n) {
      n.addClassNames("completed");
      t.questFollower.unfollowQuest(e, !1);
      this._updateHourglass(e, !1);
      var o = R.all[e];
      o.dbQuest && this._questCategoryFollowCheck(o.dbQuest.categoryId);
    }
  }
};
n.prototype._updateQuestFollow = function (e, t, i) {
  var n = window.gui.GPS,
    o = n.questFollower.isQuestFollowed(e);
  t && !o ? n.questFollower.followQuest(e, i) : !t && o && n.questFollower.unfollowQuest(e, i);
  this.questFollowed.toggleClassName("selected", t);
  this._updateHourglass(e, t);
};
n.prototype._updateHourglass = function (e, t) {
  var i = this._getQuestCategoryElement(e);
  if (i) {
    var n = i.sublist.getChild(e);
    n && n.hourglass.toggleClassName("notFollowed", !t);
  }
};
this.showCompletedCheckbox.toggleActivation(n, i);
this.updateRequired && this._updateQuestList();
setTimeout(function () {
  t._selectQuest(o, a);
}, 0);
this._refreshBonus();
this._bonusPackText.setHtml(h("ui.shop.xpBonusPackJobActive", e, L.BONUS_PACK_XP));
this._linkToShop.hide();
this._bonusPackText.setHtml(h("tablet.shop.xpBonusInactive", L.BONUS_PACK_XP));
this._linkToShop.show();
this._updateQuestItemsStyle();
this.questsList.refresh();
this._reset();
this._bonusPackText = o.createChild("span");
this._linkToShop = o.appendChild(new d({
  className: "linkToShop",
  scaleOnPress: !1
}));
this._linkToShop.on("tap", function () {
  S.open("market", {
    tabId: "shop",
    tabParams: {
      category: "bonuspack"
    }
  });
});
this.searchBox = a.appendChild(new b());
this.searchBox.on("search", function (t) {
  e._search(t);
});
this.counter = t.createChild("div", {
  className: ["header", "counter"]
});
this.questsList = t.appendChild(new _({
  className: "tree"
}));
this.showCompletedCheckbox = t.appendChild(new u(h("ui.grimoire.displayFinishedQuests")));
N(r, h("tablet.ui.grimoire.followQuest"));
I(r);
this.questFollowed = r.appendChild(new d({
  className: "followedQuestButton"
}));
r.on("tap", l);
this.questFollowed.on("tap", l);
this.questFollowed.toggleClassName("selected", !0);
this.questFollowed.hide();
this.stepTitle = s.createChild("div", {
  className: "stepTitle"
});
this.stepSelector = s.appendChild(new M({
  className: "stepSelector"
}));
c.createChild("div", {
  className: "image"
});
this.description = c.createChild("div", {
  className: "description"
});
n.createChild("div", {
  className: "header",
  text: h("ui.grimoire.quest.objectives")
});
this.objectivePlaceHolder = new E("div", {
  text: h("ui.grimoire.quest.objectivesNonAvailable"),
  name: "objectivePlaceHolder",
  className: "objectiveRow"
});
this.objectivesScroller = n.appendChild(new w({
  className: "objectiveList"
}));
this.objectives = this.objectivesScroller.content;
this.xp = m.createChild("div", {
  className: "text"
});
m.createChild("div", {
  className: ["xp", "icon"]
});
m.hide();
this.kamas = f.createChild("div", {
  className: "text"
});
f.createChild("div", {
  className: ["kamas", "icon"]
});
f.hide();
this.rewardList = n.createChild("div", {
  className: "rewardList"
});
this.stepSelector.on("change", function (t) {
  var i = e.currentQuest.dbSteps[t],
    n = e.currentQuest.dbQuest.stepIds.indexOf(parseInt(t, 10));
  n <= this.index ? e._displayStepData(i) : e._displayUnknownStep(i);
});
this.questsList.on("selected", function (t) {
  t.sublist.show();
  e._updateQuestItemsStyle();
  e.questsList.refresh();
  e.questsList.scrollToElement(t);
});
this.questsList.on("deselected", function (t) {
  t.sublist.hide();
  e._updateQuestItemsStyle();
  e.questsList.refresh();
});
this.showCompletedCheckbox.on("change", function (t) {
  A.setValue("showCompletedQuest", t);
  e._showCompletedQuest();
});
t.sublist.show();
e._updateQuestItemsStyle();
e.questsList.refresh();
e.questsList.scrollToElement(t);
t.sublist.hide();
e._updateQuestItemsStyle();
e.questsList.refresh();
A.setValue("showCompletedQuest", t);
e._showCompletedQuest();
R.on("questUpdate", function (t) {
  e.isVisible() && e.currentQuest && t === e.currentQuest.questId && e._selectQuest(e.currentQuest.dbQuest.categoryId, e.currentQuest.questId);
});
R.on("questFinished", function (t) {
  e._endQuest(t.questId);
  e._sortSublist(t.questId);
  e._showCompletedQuest();
  e._updateQuestCounter();
  e.currentQuest && t.questId === e.currentQuest.questId && e._reset();
});
R.on("questStarted", function (t) {
  e._addQuest(t);
  e._sortSublist(t);
  e._showCompletedQuest();
  e._updateQuestCounter();
  e.currentQuest || (e.currentQuest = R.all[t], e.isVisible() && e._selectQuest(e.currentQuest.dbQuest.categoryId, e.currentQuest.questId));
});
t.on("disconnect", function () {
  e.currentQuest = null;
  e.selectedQuestElement = null;
  e.updateRequired = !0;
  e.questsListUpdated = !1;
  e.params = {};
  e.locateButtonMap = {};
  e._previousSearch = "";
  e.searchBox.clear();
});
i.on("addDestination", function (t) {
  var i = e.locateButtonMap[t.id];
  i && i.rootElement && i.addClassNames("selected");
});
i.on("removeDestination", function (t) {
  var i = e.locateButtonMap[t.id];
  i && i.rootElement && i.delClassNames("selected");
});
e._endQuest(t.questId);
e._sortSublist(t.questId);
e._showCompletedQuest();
e._updateQuestCounter();
e.currentQuest && t.questId === e.currentQuest.questId && e._reset();
e._addQuest(t);
e._sortSublist(t);
e._showCompletedQuest();
e._updateQuestCounter();
e.currentQuest || (e.currentQuest = R.all[t], e.isVisible() && e._selectQuest(e.currentQuest.dbQuest.categoryId, e.currentQuest.questId));
e.currentQuest = null;
e.selectedQuestElement = null;
e.updateRequired = !0;
e.questsListUpdated = !1;
e.params = {};
e.locateButtonMap = {};
e._previousSearch = "";
e.searchBox.clear();
o.createChild("div", {
  className: "arrow"
});
o.createChild("div", {
  className: "text",
  text: n.nameId
});
I(a);
a.on("tap", this._questCategoryFollowToggle.bind(this, [n.id]));
s.followButton = a;
s.hide();
s.sublist = s.appendChild(new E("div", {
  className: "sublist"
}));
s.sublist.hide();
this.updateRequired = !1;
this._reset();
this._generateQuestList();
this._updateQuestCounter();
this.currentQuest = null;
this._resetSelectedQuestElement();
this.stepTitle.setText("");
this.description.setText("");
this._resetObjectives();
this.rewardList.clearContent();
this.kamas.setText("");
this.kamasPoint.hide();
this.xp.setText("");
this.xpPoint.hide();
this.questsList.deselectAll();
this.stepSelector.clearContent();
this.stepSelector.hide();
this.questFollowed.hide();
i = t[s];
i.isVisible() && (i.toggleClassName("odd", o % 2 === 0), o += 1);
t = a[r];
i = t.sublist.getChildren();
s = !0;
n = i[l];
e = n.getWuiName();
o || !R.finished[e] ? (s = !1, n.show()) : n.hide();
this._updateQuestItemsStyle();
this.questsList.refresh();
this.locateButtonMap = {};
this._removeObjectivePlaceHolder();
this.objectives.clearContent();
this.objectives.appendChild(this.objectivePlaceHolder);
this.objectivesScroller.refresh();
n.toggleClassName("complete", !r);
n.toggleClassName("disabled", !r);
this.locateButtonMap[r] = l;
l.toggleClassName("selected", a.isActivePOI(r));
l.questsWindow = this;
l.id = r;
l.objectiveDb = i;
l.objective = n;
l.questId = o;
I(t);
t.on("tap", s.bind(l));
this._updateQuestFollow(t, i, !0);
this._questCategoryFollowCheck(this.currentQuest.dbQuest.categoryId);
n = i[o];
this.objectives.appendChild(this._createObjectiveElement(this.currentQuest.dbObjectives[n.objectiveId], n, e.questId));
this.stepTitle.setText(o(e.nameId, e.id, e.optimalLevel));
this.description.clearContent();
this.description.appendChild(p.process(e.descriptionId));
this.questFollowed.show();
this.questFollowed.toggleClassName("selected", t.questFollower.isQuestFollowed(this.currentQuest.questId));
this._displayStepObjectives(e);
this._displayStepRewards(e.rewardsIds);
this._setKamas(e);
this._setXp(e);
this.stepTitle.setText(o(e.nameId, e.id, e.optimalLevel));
this.description.setText(h("ui.grimoire.quest.descriptionNonAvailable"));
this._resetObjectives();
this._displayStepRewards(e.rewardsIds);
this._setKamas(e);
this._setXp(e);
this.stepSelector.clearContent();
this.stepSelector.index = 0;
this.stepSelector.addOption(h("ui.grimoire.quest.step") + " " + (i + 1), o);
e.stepId === o && (this.stepSelector.index = i);
this.stepSelector.select(e.stepId);
this.stepSelector.show();
i.sort(function (e, t) {
  return parseInt(e.getWuiName(), 10) - parseInt(t.getWuiName(), 10);
});
i.sort(function (e, t) {
  return e.hasClassName("completed") ? 1 : t.hasClassName("completed") ? -1 : 0;
});
r.hourglass = r.createChild("div", {
  className: "icon"
});
i.questFollower.isQuestFollowed(e) || r.hourglass.addClassNames("notFollowed");
r.createChild("div", {
  className: "text",
  text: o(n.dbQuest.nameId, e)
});
I(r);
r.on("tap", function () {
  var e = r.getWuiName();
  return R.active[e] ? (v("GEN_BUTTON"), t.currentQuest = R.all[e], t._updateStepList(), t._resetSelectedQuestElement(), r.addClassNames("selected"), void (t.selectedQuestElement = r)) : v("NO_ACTION");
});
s = a.sublist.appendChild(r);
R.active[e] ? s.delClassNames("completed") : s.addClassNames("completed");
n.dbQuest && this._questCategoryFollowCheck(n.dbQuest.categoryId);
n.addClassNames("completed");
t.questFollower.unfollowQuest(e, !1);
this._updateHourglass(e, !1);
t && !o ? n.questFollower.followQuest(e, i) : !t && o && n.questFollower.unfollowQuest(e, i);
this.questFollowed.toggleClassName("selected", t);
this._updateHourglass(e, t);
m.call(this, "div", {
  className: "SpellsWindow",
  name: "spells"
});
this.mustRefreshAll = !0;
this.once("open", function () {
  this._createDom();
  this._setupEvents();
});
this._createDom();
this._setupEvents();
this.on("open", function (i) {
  e = i && i.spellId ? i.spellId : null;
  this._refreshAllContent();
  this.updateRemainingPoints();
  t.shortcutBar.openPanel("spell");
});
this.on("focus", function () {
  t.shortcutBar.openPanel("spell");
});
e = i && i.spellId ? i.spellId : null;
this._refreshAllContent();
this.updateRemainingPoints();
t.shortcutBar.openPanel("spell");
this.table.selectRow(t.id);
this.table.scrollToSelectedRow();
i.displaySpell({
  spell: t,
  imageUri: t.getIconUrl()
});
l(s, m);
e.exports = s;
s.prototype._createDom = function () {
  function e(e) {
    var t = new m("div", {
        className: "icon"
      }),
      i = e.getIconUrl();
    return i && t.setStyle("backgroundImage", i), t;
  }
  function t(e) {
    var t = new m("div", {
      className: "levelCell"
    });
    t.minusBtn = t.appendChild(new u({
      className: "minusSignButton",
      scaleOnPress: !0
    }));
    var i = e.isItem || e.id === C ? "-" : e.level;
    return t.levelTextDom = t.createChild("div", {
      className: "level",
      text: i
    }), t.plusBtn = t.appendChild(new u({
      className: "addSignButton",
      scaleOnPress: !0
    })), t.spell = e, t.levelWanted = e.level, window.gui.playerData.isIncarnation() ? (r(t, d("ui.spell.incarnationSpellWarning")), t.minusBtn.disable(), t.plusBtn.disable()) : (c(t.minusBtn), t.minusBtn.on("tapstart", function () {
      a.table.delClassNames("scaleOnPress");
    }), t.minusBtn.on("tapend", function () {
      a.table.addClassNames("scaleOnPress");
    }), t.minusBtn.on("tap", function () {
      y("PLUS_BUTTON");
      var i = window.gui.playerData.isSubscriberAtMinLevel(T.ELITE);
      return !i && t.levelWanted <= t.spell.level ? void M.open("BonusPackElitePopupWindow") : (t.levelWanted = Math.max(t.levelWanted - 1, 1), void a._refreshSpellRow(e.id));
    }), c(t.plusBtn), t.plusBtn.on("tapstart", function () {
      a.table.delClassNames("scaleOnPress");
    }), t.plusBtn.on("tapend", function () {
      a.table.addClassNames("scaleOnPress");
    }), t.plusBtn.on("tap", function () {
      y("PLUS_BUTTON");
      t.levelWanted = Math.min(t.levelWanted + 1, e.getMaxLevel());
      a._refreshSpellRow(e.id);
    })), t;
  }
  function i() {
    var e = new m("div", {
      className: "pointsCell"
    });
    return e.valueDom = e.createChild("div", {
      className: "points",
      text: "-"
    }), e.cost = 0, e;
  }
  var a = this,
    s = this.createChild("div", {
      className: "col1"
    });
  this.col2 = this.createChild("div", {
    className: "col2"
  });
  this.selector = s.appendChild(new p());
  this.table = s.appendChild(new h([{
    id: "icon",
    format: e,
    sort: n
  }, {
    id: "name",
    header: d("ui.common.spellName"),
    getContent: function (e) {
      return e.getName();
    },
    sort: !0
  }, {
    id: "rank",
    header: d("ui.common.level"),
    format: t,
    sort: o
  }, {
    id: "pts",
    header: d("ui.common.pointsWithCap"),
    format: i
  }], "id", {
    scaleOnPress: !0
  }));
  this.table.on("rowTap", function (e, t) {
    a.displaySpell({
      spell: t,
      imageUri: e.icon.content.getStyle("backgroundImage")
    });
    y("GEN_BUTTON");
  });
  this.noFilter = !0;
  this.filter = null;
  this.table.addFilter(function (e) {
    return a.noFilter || e.getProperty("typeId") === a.filter;
  });
  this.selector.on("change", function (e) {
    a.noFilter = !1;
    "-" === e ? a.noFilter = !0 : a.filter = parseInt(e, 10);
    a.table.filter();
  });
  var l = s.createChild("div", {
      className: "pointsBox"
    }),
    f = l.createChild("div", {
      className: "buttonsList"
    });
  this.cancelButton = f.appendChild(new u({
    className: ["secondaryButton", "cancelButton"],
    scaleOnPress: !0,
    text: d("ui.common.cancel")
  }));
  this.confirmButton = f.appendChild(new u({
    className: ["greenButton", "confirmButton"],
    scaleOnPress: !0,
    text: d("ui.common.validation")
  }));
  l.createChild("div", {
    text: d("ui.grimoire.spellCapital"),
    className: "label"
  });
  var g = l.createChild("div", {
    className: "remainingPointsContainer"
  });
  this.remainingPointsBox = g.createChild("div", {
    className: "remainingPoints"
  });
  this.cancelButton.on("tap", function () {
    a._cancelAllUpgrades();
  });
  this.confirmButton.on("tap", function () {
    return window.gui.playerData.isFighting ? void window.gui.openSimplePopup(d("ui.error.cantDoInFight")) : void window.gui.openConfirmPopup({
      title: d("ui.common.confirm"),
      message: d("ui.common.confirmModification"),
      cb: function (e) {
        e && a.upgradeSpells();
      }
    });
  });
};
s.prototype._setupEvents = function () {
  var e = this,
    t = window.gui;
  t.on("SpellChangeFailureMessage", function () {
    window.gui.openPopup({
      title: d("ui.common.error"),
      message: d("ui.grimoire.popup.upgradeSpellFailMessage")
    });
  });
  t.on("CharacterLevelUpMessage", function () {
    e.enableSpellsOnLevelUp();
  });
  t.on("disconnect", function () {
    e.mustRefreshAll = !0;
  });
  t.playerData.characters.on("weaponChanged", function () {
    e.updateWeaponSpell();
  });
  var i = t.playerData.characters;
  i.on("spellUpgrade", function (t, i) {
    return e.table.getRow(t) ? void e._updateDisplayedSpellLevel(t, i) : console.error(new Error("spell " + t + " does not exist in spell window"));
  });
  i.on("newSpellLearned", function (t) {
    if (!e.table.getRow(t)) {
      var i = window.gui.playerData.characters.mainCharacter.spellData.spells[t];
      if (!i) {
        return console.error(new Error("spell " + t + " is not loaded"));
      }
      var n = {};
      n[i.id] = i;
      e.table.addMap(n);
      i.getIconUrl() || v.preloadImage(i.getIconUri(), function (t) {
        i.spell.image = t;
        var n = e.table.getCell(i.id, "icon");
        n.setStyle("backgroundImage", t);
        e.currentSpellId === i.id && e.displaySpell({
          spell: i,
          imageUri: t
        });
        e.refreshAllSpellState();
        e._refreshAllSpellRows();
      });
    }
  });
  t.playerData.characters.on("specificCharacteristicsUpdated", function (t) {
    "spellsPoints" === t && (e._refreshAllSpellRows(), e.updateRemainingPoints());
  });
  i.on("spellList", function () {
    e._askForRefresh();
  });
  i.on("switchControlledCharacter", function () {
    g.cancelDragFromSource("spellsWindow");
  });
  t.playerData.on("subscriptionChanged", function () {
    e._refreshAllSpellRows();
  });
};
s.prototype._refreshAllContent = function () {
  this.mustRefreshAll = !1;
  var e = window.gui.playerData.characters,
    t = e.getControlledCharacter();
  this._onMainCharacter = e.isMainCharacterControlled();
  this.table.setSorter(n);
  this._loadAllSpells(t.spellData.getSpells(w.VISIBLE));
  this.setupSelectorOptions();
  this.table.selectFirstRow();
};
s.prototype._askForRefresh = function () {
  this.isVisible() ? this._refreshAllContent() : this.mustRefreshAll = !0;
};
s.prototype.updateRemainingPoints = function () {
  var e = this,
    t = window.gui.playerData.characters.getControlledCharacter(),
    i = t.characteristics,
    n = i && i.spellsPoints || 0,
    o = 0,
    a = !1;
  for (var s in this.spellMap) {
    if (this.table.hasRow(s)) {
      var r = this.table.getCell(s, "pts");
      o += r.cost;
      0 !== r.cost && (a = !0);
    }
  }
  var l = n + o;
  this.remainingPointsBox.setText(l);
  this.remainingPointsBox.toggleClassName("notEnoughPoints", l < 0);
  this.cancelButton.toggleDisplay(a);
  this.confirmButton.toggleDisplay(a);
  this.confirmButton.enable();
  l < 0 && this.confirmButton.disable();
  window.gui.scenarioManager.checkCondition(window.gui.scenarioManager.conditionTypeEnum.SHOW_CONFIRM_BUTTON, {
    canConfirm: e.confirmButton.isVisible()
  });
};
s.prototype.setupSelectorOptions = function () {
  var e = this;
  this.selector.clearContent();
  this.selector.addOption(d("ui.common.allTypes"), "-");
  this.selector.setValue("-");
  var t = {},
    i = window.gui.playerData.characters.getControlledCharacter(),
    n = i.spellData.getSpells(w.VISIBLE);
  for (var o in n) {
    var a = n[o],
      s = a.getProperty("typeId");
    t[s] || (e.selector.addOption(a.getHumanReadableSpellType(), s), t[s] = !0);
  }
  e.noFilter = !0;
  e.table.filter();
};
s.prototype.updateWeaponSpell = function () {
  var e = this,
    t = window.gui.playerData.characters.mainCharacter.spellData.spells[C];
  v.preloadImage(t.getIconUri(), function (i) {
    e.table.updateRow(t);
    var n = e.table.getCell(t.id, "icon");
    n.setStyle("backgroundImage", i);
    e.refreshSpellState(t.id);
    e.currentSpellId === t.id && e.displaySpell({
      spell: t,
      imageUri: i
    });
  });
};
s.prototype._loadAllSpells = function (e) {
  this.spellMap = e;
  this.table.clearContent();
  this.table.addMap(e);
  var t = [],
    i = [];
  for (var n in e) {
    var o = e[n];
    o.getIconUrl() || (i.push(o), t.push(o.getIconUri()));
  }
  var a = this;
  v.preloadImages(t, function (e) {
    for (var t = 0; t < e.length; t++) {
      var n = i[t],
        o = n.spell.image = e[t],
        s = a.table.getCell(n.id, "icon");
      s.setStyle("backgroundImage", o);
      a.currentSpellId === n.id && a.displaySpell({
        spell: n,
        imageUri: o
      });
    }
    a.refreshAllSpellState();
    a._refreshAllSpellRows();
  });
};
s.prototype.setSpellDraggable = function (e, t) {
  var i = this.table.getCell(e, "icon");
  if (g.isDraggable(i)) {
    return void (t ? g.enableDrag(i) : g.disableDrag(i));
  }
  if (t) {
    var n = this.spellMap[e].getIconUrl();
    n && g.setDraggable(i, {
      backgroundImage: n
    }, "spellsWindow", {
      spellId: e
    }, {
      dragOnTouchstart: !0
    });
  }
};
s.prototype.setSpellEnabled = function (e, t) {
  this.table.getRow(e).toggleClassName("grayed", !t);
};
s.prototype.refreshSpellState = function (e) {
  var t = this.spellMap[e],
    i = t && (t.isItem || a(t)),
    n = i && this._onMainCharacter;
  this.setSpellEnabled(e, i);
  this.setSpellDraggable(e, n);
};
s.prototype.refreshAllSpellState = function () {
  for (var e in this.spellMap) {
    this.refreshSpellState(e);
  }
};
s.prototype._updateDisplayedSpellLevel = function (e, t) {
  if (this.table.hasRow(e)) {
    var i = this.table.getCell(e, "rank");
    i.levelWanted = t;
    this._refreshSpellRow(e);
  }
};
s.prototype.upgradeSpells = function () {
  var e = [];
  for (var t in this.spellMap) {
    if (this.table.hasRow(t)) {
      var i = this.table.getCell(t, "rank");
      i.spell.level !== i.levelWanted && e.push({
        spellId: parseInt(t, 10),
        spellLevel: i.levelWanted
      });
    }
  }
  window.dofus.sendMessage("SpellChangeRequestMessage", {
    spells: e
  });
  window.gui.scenarioManager.checkCondition(window.gui.scenarioManager.conditionTypeEnum.CONFIRM_UPGRADE_SPELL);
};
s.prototype.enableSpellsOnLevelUp = function () {
  this.table.getRowCount() && (this.refreshAllSpellState(), this._refreshAllSpellRows());
};
s.prototype._cancelAllUpgrades = function () {
  var e = this;
  for (var t in this.spellMap) {
    if (this.table.hasRow(t)) {
      var i = this.table.getCell(t, "rank");
      i.levelWanted = i.spell.level;
      e._refreshSpellRow(t);
    }
  }
};
s.prototype._refreshAllSpellRows = function () {
  for (var e in this.spellMap) {
    this._refreshSpellRow(e);
  }
};
s.prototype.displayHighlightPlusBtn = function (e) {
  this.toggleClassName("highlighted", e);
};
s.prototype._refreshSpellRow = function (e) {
  if (this.table.hasRow(e)) {
    var t = this.table.getCell(e, "pts"),
      i = this.table.getCell(e, "rank"),
      n = window.gui.playerData.isSubscriberAtMinLevel(T.ELITE),
      o = i.minusBtn,
      s = i.plusBtn,
      r = i.spell,
      l = r.level,
      c = i.levelWanted,
      d = -r.getUpgradeCost(c);
    c < l && (d = r.getUpgradeCost(c, l));
    var u = c < l ? "+" + d : d;
    if (0 === d && (u = "-"), t.cost = d, t.valueDom.setText(u), t.show(), this.updateRemainingPoints(), i.levelTextDom.setText(c), this.displaySpell({
      spell: r,
      imageUri: r.getIconUrl(),
      spellLevel: c
    }), window.gui.playerData.isIncarnation()) {
      return o.disable(), void s.disable();
    }
    o.enable();
    s.enable();
    o.show();
    s.show();
    0 === l || 1 === r.getMaxLevel() ? (o.hide(), s.hide(), t.hide()) : (1 === c ? o.disable() : o.toggleClassName("locked", !n && c <= l), a(r, Math.min(c + 1, r.getMaxLevel())) && c !== r.getMaxLevel() || s.disable());
  }
};
s.prototype.displaySpell = function (e) {
  function t(t, o) {
    var a = Number(o) + 1,
      r = t.createChild("div", {
        className: "tab",
        text: a
      });
    r.rankNum = o;
    i.getSpellLevelId(a) === s && r.addClassNames("on");
    c(r);
    r.on("tapstart", function () {
      n.addClassNames("pressed");
    });
    r.on("tapend", function () {
      n.delClassNames("pressed");
    });
    r.on("tap", function () {
      n.displaySpell({
        spell: e.spell,
        imageUri: e.imageUri,
        spellLevel: a
      });
      y("TAB");
    });
  }
  var i,
    n = this,
    o = this.table.getCell(e.spell.id, "rank"),
    a = e.spellLevel || o.levelWanted;
  i = e.spell.clone();
  i.setLevel(a);
  var s = i.getSpellLevelId(a),
    r = e.imageUri;
  if (this.currentSpellLevelId === s) {
    return void this.tabIcon.setStyle("backgroundImage", r);
  }
  this.col2.clearContent();
  this.currentSpellLevelId = s;
  this.currentSpellId = i.id;
  for (var l = n.col2.createChild("div", {
      className: "tabs"
    }), u = i.getMaxLevel(), h = 0; h < u; h++) {
    t(l, h.toString());
  }
  var p = n.col2.createChild("div", {
      className: "panel"
    }),
    m = p.createChild("div", {
      className: "header"
    }),
    g = this.tabIcon = m.createChild("div", {
      className: "icon"
    });
  g.setStyle("backgroundImage", r);
  var _ = m.createChild("div", {
    className: "panelTop"
  });
  _.createChild("div", {
    className: "spellName",
    text: i.getName()
  });
  _.createChild("div", {
    className: "minPlayerLevel",
    text: d("ui.spell.requiredLevel") + " " + (i.getProperty("minPlayerLevel", a) || 1)
  });
  var v = p.appendChild(new b({
    className: "spellDescScroller"
  }));
  v.content.appendChild(new f({
    spell: i,
    level: a
  }, {
    spellTooltipAll: !0
  }));
  v.refresh();
};
y("PLUS_BUTTON");
t.levelWanted = Math.min(t.levelWanted + 1, e.getMaxLevel());
a._refreshSpellRow(e.id);
this.col2 = this.createChild("div", {
  className: "col2"
});
this.selector = s.appendChild(new p());
this.table = s.appendChild(new h([{
  id: "icon",
  format: e,
  sort: n
}, {
  id: "name",
  header: d("ui.common.spellName"),
  getContent: function (e) {
    return e.getName();
  },
  sort: !0
}, {
  id: "rank",
  header: d("ui.common.level"),
  format: t,
  sort: o
}, {
  id: "pts",
  header: d("ui.common.pointsWithCap"),
  format: i
}], "id", {
  scaleOnPress: !0
}));
this.table.on("rowTap", function (e, t) {
  a.displaySpell({
    spell: t,
    imageUri: e.icon.content.getStyle("backgroundImage")
  });
  y("GEN_BUTTON");
});
this.noFilter = !0;
this.filter = null;
this.table.addFilter(function (e) {
  return a.noFilter || e.getProperty("typeId") === a.filter;
});
this.selector.on("change", function (e) {
  a.noFilter = !1;
  "-" === e ? a.noFilter = !0 : a.filter = parseInt(e, 10);
  a.table.filter();
});
a.displaySpell({
  spell: t,
  imageUri: e.icon.content.getStyle("backgroundImage")
});
y("GEN_BUTTON");
a.noFilter = !1;
"-" === e ? a.noFilter = !0 : a.filter = parseInt(e, 10);
a.table.filter();
this.cancelButton = f.appendChild(new u({
  className: ["secondaryButton", "cancelButton"],
  scaleOnPress: !0,
  text: d("ui.common.cancel")
}));
this.confirmButton = f.appendChild(new u({
  className: ["greenButton", "confirmButton"],
  scaleOnPress: !0,
  text: d("ui.common.validation")
}));
l.createChild("div", {
  text: d("ui.grimoire.spellCapital"),
  className: "label"
});
this.remainingPointsBox = g.createChild("div", {
  className: "remainingPoints"
});
this.cancelButton.on("tap", function () {
  a._cancelAllUpgrades();
});
this.confirmButton.on("tap", function () {
  return window.gui.playerData.isFighting ? void window.gui.openSimplePopup(d("ui.error.cantDoInFight")) : void window.gui.openConfirmPopup({
    title: d("ui.common.confirm"),
    message: d("ui.common.confirmModification"),
    cb: function (e) {
      e && a.upgradeSpells();
    }
  });
});
t.on("SpellChangeFailureMessage", function () {
  window.gui.openPopup({
    title: d("ui.common.error"),
    message: d("ui.grimoire.popup.upgradeSpellFailMessage")
  });
});
t.on("CharacterLevelUpMessage", function () {
  e.enableSpellsOnLevelUp();
});
t.on("disconnect", function () {
  e.mustRefreshAll = !0;
});
t.playerData.characters.on("weaponChanged", function () {
  e.updateWeaponSpell();
});
i.on("spellUpgrade", function (t, i) {
  return e.table.getRow(t) ? void e._updateDisplayedSpellLevel(t, i) : console.error(new Error("spell " + t + " does not exist in spell window"));
});
i.on("newSpellLearned", function (t) {
  if (!e.table.getRow(t)) {
    var i = window.gui.playerData.characters.mainCharacter.spellData.spells[t];
    if (!i) {
      return console.error(new Error("spell " + t + " is not loaded"));
    }
    var n = {};
    n[i.id] = i;
    e.table.addMap(n);
    i.getIconUrl() || v.preloadImage(i.getIconUri(), function (t) {
      i.spell.image = t;
      var n = e.table.getCell(i.id, "icon");
      n.setStyle("backgroundImage", t);
      e.currentSpellId === i.id && e.displaySpell({
        spell: i,
        imageUri: t
      });
      e.refreshAllSpellState();
      e._refreshAllSpellRows();
    });
  }
});
t.playerData.characters.on("specificCharacteristicsUpdated", function (t) {
  "spellsPoints" === t && (e._refreshAllSpellRows(), e.updateRemainingPoints());
});
i.on("spellList", function () {
  e._askForRefresh();
});
i.on("switchControlledCharacter", function () {
  g.cancelDragFromSource("spellsWindow");
});
t.playerData.on("subscriptionChanged", function () {
  e._refreshAllSpellRows();
});
n[i.id] = i;
e.table.addMap(n);
i.getIconUrl() || v.preloadImage(i.getIconUri(), function (t) {
  i.spell.image = t;
  var n = e.table.getCell(i.id, "icon");
  n.setStyle("backgroundImage", t);
  e.currentSpellId === i.id && e.displaySpell({
    spell: i,
    imageUri: t
  });
  e.refreshAllSpellState();
  e._refreshAllSpellRows();
});
n.setStyle("backgroundImage", t);
e.currentSpellId === i.id && e.displaySpell({
  spell: i,
  imageUri: t
});
e.refreshAllSpellState();
e._refreshAllSpellRows();
this._onMainCharacter = e.isMainCharacterControlled();
this.table.setSorter(n);
this._loadAllSpells(t.spellData.getSpells(w.VISIBLE));
this.setupSelectorOptions();
this.table.selectFirstRow();
o += r.cost;
0 !== r.cost && (a = !0);
this.remainingPointsBox.setText(l);
this.remainingPointsBox.toggleClassName("notEnoughPoints", l < 0);
this.cancelButton.toggleDisplay(a);
this.confirmButton.toggleDisplay(a);
this.confirmButton.enable();
l < 0 && this.confirmButton.disable();
window.gui.scenarioManager.checkCondition(window.gui.scenarioManager.conditionTypeEnum.SHOW_CONFIRM_BUTTON, {
  canConfirm: e.confirmButton.isVisible()
});
this.selector.clearContent();
this.selector.addOption(d("ui.common.allTypes"), "-");
this.selector.setValue("-");
e.noFilter = !0;
e.table.filter();
n.setStyle("backgroundImage", i);
e.refreshSpellState(t.id);
e.currentSpellId === t.id && e.displaySpell({
  spell: t,
  imageUri: i
});
this.spellMap = e;
this.table.clearContent();
this.table.addMap(e);
s.setStyle("backgroundImage", o);
a.currentSpellId === n.id && a.displaySpell({
  spell: n,
  imageUri: o
});
a.refreshAllSpellState();
a._refreshAllSpellRows();
this.setSpellEnabled(e, i);
this.setSpellDraggable(e, n);
i.levelWanted = t;
this._refreshSpellRow(e);
window.dofus.sendMessage("SpellChangeRequestMessage", {
  spells: e
});
window.gui.scenarioManager.checkCondition(window.gui.scenarioManager.conditionTypeEnum.CONFIRM_UPGRADE_SPELL);
i.levelWanted = i.spell.level;
e._refreshSpellRow(t);
o.enable();
s.enable();
o.show();
s.show();
0 === l || 1 === r.getMaxLevel() ? (o.hide(), s.hide(), t.hide()) : (1 === c ? o.disable() : o.toggleClassName("locked", !n && c <= l), a(r, Math.min(c + 1, r.getMaxLevel())) && c !== r.getMaxLevel() || s.disable());
r.rankNum = o;
i.getSpellLevelId(a) === s && r.addClassNames("on");
c(r);
r.on("tapstart", function () {
  n.addClassNames("pressed");
});
r.on("tapend", function () {
  n.delClassNames("pressed");
});
r.on("tap", function () {
  n.displaySpell({
    spell: e.spell,
    imageUri: e.imageUri,
    spellLevel: a
  });
  y("TAB");
});
n.displaySpell({
  spell: e.spell,
  imageUri: e.imageUri,
  spellLevel: a
});
y("TAB");
i = e.spell.clone();
i.setLevel(a);
this.col2.clearContent();
this.currentSpellLevelId = s;
this.currentSpellId = i.id;
_.createChild("div", {
  className: "spellName",
  text: i.getName()
});
_.createChild("div", {
  className: "minPlayerLevel",
  text: d("ui.spell.requiredLevel") + " " + (i.getProperty("minPlayerLevel", a) || 1)
});
v.content.appendChild(new f({
  spell: i,
  level: a
}, {
  spellTooltipAll: !0
}));
v.refresh();
this.jobButtons = [];
this.jobSelectButtons = [];
this.jobSelectSpecialButtons = [];
this._expBarTooltip = new l("div");
this.mustRefreshJobs = !0;
this.numRefreshTasks = 0;
this._setupEvents();
this.on("open", function (t) {
  e.jobListElement || e._createDom();
  var i = t ? t.jobId : null;
  return e.mustRefreshJobs ? e._refreshJobs(i) : void (i && e.selectJob(i));
});
this.on("close", function () {
  e.mustRefreshJobs = !0;
  _.getWindow("jobOptions").openState && _.close("jobOptions");
  e.recipeList.reset();
});
e.mustRefreshJobs = !0;
_.getWindow("jobOptions").openState && _.close("jobOptions");
e.recipeList.reset();
null === t ? (i = null, n = null) : (i = t.id, n = t.experience ? t.experience.jobLevel : 1);
e.jobId = i;
a(e);
o(e, n);
r(n, l);
e.exports = n;
n.prototype._reset = function () {
  this.mustRefreshJobs = !0;
  this.numRefreshTasks = 0;
};
n.prototype._refreshJobs = function (e) {
  this.mustRefreshJobs = !1;
  var t = Math.max(0, window.gui.playerData.jobs.jobXpBonus - 100);
  if (window.gui.playerData.isSubscriberAtMinLevel(M.NORMAL)) {
    var i = t + b.BONUS_PACK_XPJOB;
    this._bonusPackText.setHtml(p("ui.shop.xpBonusPackJobActive", i, b.BONUS_PACK_XPJOB));
    this._linkToShop.hide();
  } else {
    t > 0 ? this._bonusPackText.setHtml(p("ui.shop.xpBonusJobOnly", t, b.BONUS_PACK_XPJOB)) : this._bonusPackText.setHtml(p("tablet.shop.xpBonusInactive", b.BONUS_PACK_XPJOB));
    this._linkToShop.show();
  }
  var n = window.gui.playerData.jobs;
  this.jobMap = n.list;
  var o = Object.keys(this.jobMap);
  if (o.length) {
    this._updateJobButtons(n.jobOriginalOrder);
    var a = this;
    this._getJobImages(function () {
      a._updateJobIcons();
    });
    e = e || n.jobOriginalOrder[0];
    this.selectJob(e, !0);
  }
};
n.prototype._getJobImages = function (e) {
  var t = [],
    i = [],
    n = this.jobMap;
  for (var o in n) {
    var a = n[o];
    a.info.iconId === -1 || I[o] || (t.push("gfx/jobs/" + a.info.iconId + ".png"), i.push(o));
  }
  return t.length ? void y.preloadImages(t, function (t) {
    for (var n = 0; n < t.length; n++) {
      I[i[n]] = t[n];
    }
    return e();
  }) : e();
};
n.prototype._createDom = function () {
  var e = this,
    t = this.createChild("div", {
      className: "col1"
    }),
    i = this.createChild("div", {
      className: "col2"
    });
  this.jobListElement = t.createChild("div", {
    className: "jobsList"
  });
  for (var n = 0; n < T; n++) {
    this._createJobIcon(n);
  }
  var o = this.jobListElement.createChild("div", {
    className: "specialisation"
  });
  for (o.createChild("div", {
    className: "text",
    text: p("ui.common.specializations")
  }); n < T + C; n++) {
    this._createJobIcon(n, o);
  }
  this.jobExpBlock = t.createChild("div", {
    className: "jobExpBlock"
  });
  this.jobWrapper = this.jobExpBlock.createChild("div", {
    className: "jobWrapper"
  });
  this.jobName = this.jobWrapper.createChild("div", {
    className: "jobName"
  });
  this.jobLevel = this.jobWrapper.createChild("div", {
    className: "jobLevel"
  });
  this._jobExpBar = this.jobExpBlock.appendChild(new d({
    className: "jobExpBar"
  }));
  w.addTooltip(this._jobExpBar, this._expBarTooltip, {
    longTapExplanation: !0
  });
  this.skillsBlock = t.createChild("div", {
    className: "skillsBlock"
  });
  this.skillsTitle = this.skillsBlock.createChild("div", {
    className: "skillsTitle",
    text: p("ui.common.abilities")
  });
  var a = t.appendChild(new u({
    text: p("ui.craft.jobOptions"),
    className: ["greenButton"]
  }));
  a.on("tap", function () {
    _.open("jobOptions", {
      jobId: e.selectedJobId
    });
  });
  this.skillsList = this.skillsBlock.appendChild(new h({
    className: "skillsList",
    cannotActivate: !0
  }));
  this.recipeList = i.appendChild(new v({
    shouldNotSelect: !0
  }));
  var s = i.createChild("div", {
    className: "bonusPackMessage"
  });
  this._bonusPackText = s.createChild("span");
  this._linkToShop = s.appendChild(new u({
    className: "linkToShop",
    scaleOnPress: !1
  }));
  this._linkToShop.on("tap", function () {
    _.open("market", {
      tabId: "shop",
      tabParams: {
        category: "bonuspack"
      }
    });
  });
};
n.prototype._createJobIcon = function (e, t) {
  var i = this,
    n = t || this.jobListElement,
    o = n.createChild("div", {
      className: "job"
    });
  o.itemSlot = o.appendChild(new f({
    name: "jobIcon"
  }));
  this.jobButtons.push(o);
  t ? this.jobSelectSpecialButtons.push(o) : (this.jobSelectButtons.push(o), o.createChild("div", {
    className: "level",
    name: "level"
  }));
  o.itemSlot.on("tap", function () {
    o.jobId && i.selectJob(o.jobId);
  });
};
n.prototype._updateJobButtons = function (e) {
  for (var t = 0; t < this.jobButtons.length; t++) {
    s(this.jobButtons[t], null);
  }
  var i = 0,
    n = 0;
  for (t = 0; t < e.length; t++) {
    var o = this.jobMap[e[t]],
      a = o.info.specializationOfId ? this.jobSelectSpecialButtons[n++] : this.jobSelectButtons[i++];
    s(a, o);
  }
};
n.prototype._updateJobIcons = function () {
  for (var e = 0; e < this.jobButtons.length; e++) {
    a(this.jobButtons[e]);
  }
};
n.prototype._getJobButton = function (e) {
  for (var t = this.jobButtons, i = 0; i < t.length; i++) {
    if (t[i].jobId === e) {
      return t[i];
    }
  }
  return console.error("_getJobButton: invalid Job ID: " + e), null;
};
n.prototype._setupEvents = function () {
  var e = this,
    t = window.gui.playerData.jobs;
  window.gui.on("disconnect", function () {
    e._reset();
  });
  t.on("jobListUpdated", function () {
    var i = 0 !== Object.keys(t.list).length;
    i && (e.mustRefreshJobs = !0, e.isVisible() && e._refreshJobs());
  });
  t.on("jobLevelUp", function (t, i) {
    if (!e.mustRefreshJobs) {
      var n = e._getJobButton(t.id);
      if (n) {
        return o(n, i), e.isVisible() && t.id === e.selectedJobId ? e._refreshJobs(t.id) : void 0;
      }
    }
  });
  t.on("jobExperienceUpdate", function (t) {
    e.isVisible() && t.jobId === e.selectedJobId && e._updateJobInfo(t);
  });
};
n.prototype._updateJobInfo = function (e) {
  var t = "";
  t = 100 !== e.currentLevel ? e.percentage + "% (" + e.currentExperience + " / " + e.levelExperienceCeil + ")" : e.percentage + "% (" + e.currentExperience + ")";
  this._expBarTooltip.setText(t);
  this._jobExpBar.setValue(e.percentage / 100);
  this.jobName.setText(this.jobMap[e.jobId].info.nameId);
  this.jobLevel.setText(p("ui.common.level") + " " + e.currentLevel);
};
n.prototype._selectJobButton = function (e) {
  var t = this._getJobButton(e);
  if (!t) {
    return !1;
  }
  if (this.currentJobBtn) {
    if (this.currentJobBtn.jobId === e) {
      return !1;
    }
    this.currentJobBtn.itemSlot.unselect();
  }
  return t.itemSlot.select(), this.currentJobBtn = t, !0;
};
n.prototype.selectJob = function (e, t) {
  if (this._selectJobButton(e) || t) {
    var i = this;
    window.setTimeout(function () {
      i._refreshCurrentJob(e);
    }, 50);
  }
};
n.prototype._afterRefreshTask = function () {
  if (this.numRefreshTasks--, this.numRefreshTasks > 0) {
    return !this.lastJobIdRequested;
  }
  if (!this.lastJobIdRequested) {
    return !0;
  }
  var e = this.lastJobIdRequested;
  return this.lastJobIdRequested = null, this._refreshCurrentJob(e), !1;
};
n.prototype._refreshCurrentJob = function (e) {
  if (this.numRefreshTasks) {
    return void (this.lastJobIdRequested = e);
  }
  this.selectedJobId = e;
  var t = window.gui.playerData.jobs,
    i = 2,
    n = [],
    o = this.jobMap[e],
    a = o.description.skills;
  this._updateJobInfo(t.getJobExperience(e));
  this.skillsList.empty();
  for (var s = [], r = [], d = [], u = [], h = 0; h < a.length; h++) {
    var f = a[h],
      _ = f.skillId,
      v = f.info;
    if (v) {
      var y = new l("div", {
        className: "label"
      });
      this.skillsList.addItem(_, y);
      var w = y.createChild("div", {
        className: "skillLeft"
      });
      w.createChild("div", {
        className: "skillName",
        text: v.nameId
      });
      d.push(w.createChild("div", {
        className: "skillDetail"
      }));
      u.push(v.interactiveId);
      var b = y.createChild("div", {
          className: "skillRight"
        }),
        M = b.createChild("div", {
          className: "skillStats"
        });
      if ("SkillActionDescriptionCollect" === f._type) {
        M.setText(p("ui.jobs.collectSkillInfos", f.time / 10, f.min, f.max));
        r.push(v.gatheredRessourceItem);
        var T = b.appendChild(new g({
          descriptionOptions: {
            effects: !1
          }
        }));
        s.push(T);
      }
      if ("SkillActionDescriptionCraft" === f._type) {
        var C = p("ui.jobs.slotPercents", f.maxSlots, f.probability);
        M.setText(C);
        n = n.concat(v.recipes);
        M.addClassNames("bottom");
      }
    }
  }
  this.numRefreshTasks += 3;
  var I = this;
  m.getItems(r, function (e, t) {
    if (e) {
      return I._afterRefreshTask(), console.error("JobsWindow: Failed to get ingredients", e);
    }
    if (I._afterRefreshTask()) {
      for (var i = 0; i < t.length; i++) {
        var n = t[i];
        s[i].setItem(n);
      }
    }
  });
  c.getDataMap("Interactives", u, function (e, t) {
    if (e) {
      return I._afterRefreshTask(), console.error("JobsWindow: Failed to get interactive data", e);
    }
    if (I._afterRefreshTask()) {
      for (var i = 0; i < u.length; i++) {
        var n = u[i],
          o = t[n];
        o ? d[i].setText(o.nameId) : console.error(new Error("JobsWindow: no interactive for id " + n));
      }
    }
  });
  this.recipeList.reset();
  var A = window.gui.playerData.jobs.getMaxSlotsByJobId(e) || i;
  this.recipeList.addRecipes(n, {
    nbCase: A
  }, function () {
    I._afterRefreshTask();
  });
};
this.mustRefreshJobs = !0;
this.numRefreshTasks = 0;
this._bonusPackText.setHtml(p("ui.shop.xpBonusPackJobActive", i, b.BONUS_PACK_XPJOB));
this._linkToShop.hide();
t > 0 ? this._bonusPackText.setHtml(p("ui.shop.xpBonusJobOnly", t, b.BONUS_PACK_XPJOB)) : this._bonusPackText.setHtml(p("tablet.shop.xpBonusInactive", b.BONUS_PACK_XPJOB));
this._linkToShop.show();
this._getJobImages(function () {
  a._updateJobIcons();
});
e = e || n.jobOriginalOrder[0];
this.selectJob(e, !0);
this.jobExpBlock = t.createChild("div", {
  className: "jobExpBlock"
});
this.jobWrapper = this.jobExpBlock.createChild("div", {
  className: "jobWrapper"
});
this.jobName = this.jobWrapper.createChild("div", {
  className: "jobName"
});
this.jobLevel = this.jobWrapper.createChild("div", {
  className: "jobLevel"
});
this._jobExpBar = this.jobExpBlock.appendChild(new d({
  className: "jobExpBar"
}));
w.addTooltip(this._jobExpBar, this._expBarTooltip, {
  longTapExplanation: !0
});
this.skillsBlock = t.createChild("div", {
  className: "skillsBlock"
});
this.skillsTitle = this.skillsBlock.createChild("div", {
  className: "skillsTitle",
  text: p("ui.common.abilities")
});
a.on("tap", function () {
  _.open("jobOptions", {
    jobId: e.selectedJobId
  });
});
this.skillsList = this.skillsBlock.appendChild(new h({
  className: "skillsList",
  cannotActivate: !0
}));
this.recipeList = i.appendChild(new v({
  shouldNotSelect: !0
}));
this._bonusPackText = s.createChild("span");
this._linkToShop = s.appendChild(new u({
  className: "linkToShop",
  scaleOnPress: !1
}));
this._linkToShop.on("tap", function () {
  _.open("market", {
    tabId: "shop",
    tabParams: {
      category: "bonuspack"
    }
  });
});
o.itemSlot = o.appendChild(new f({
  name: "jobIcon"
}));
this.jobButtons.push(o);
t ? this.jobSelectSpecialButtons.push(o) : (this.jobSelectButtons.push(o), o.createChild("div", {
  className: "level",
  name: "level"
}));
o.itemSlot.on("tap", function () {
  o.jobId && i.selectJob(o.jobId);
});
window.gui.on("disconnect", function () {
  e._reset();
});
t.on("jobListUpdated", function () {
  var i = 0 !== Object.keys(t.list).length;
  i && (e.mustRefreshJobs = !0, e.isVisible() && e._refreshJobs());
});
t.on("jobLevelUp", function (t, i) {
  if (!e.mustRefreshJobs) {
    var n = e._getJobButton(t.id);
    if (n) {
      return o(n, i), e.isVisible() && t.id === e.selectedJobId ? e._refreshJobs(t.id) : void 0;
    }
  }
});
t.on("jobExperienceUpdate", function (t) {
  e.isVisible() && t.jobId === e.selectedJobId && e._updateJobInfo(t);
});
t = 100 !== e.currentLevel ? e.percentage + "% (" + e.currentExperience + " / " + e.levelExperienceCeil + ")" : e.percentage + "% (" + e.currentExperience + ")";
this._expBarTooltip.setText(t);
this._jobExpBar.setValue(e.percentage / 100);
this.jobName.setText(this.jobMap[e.jobId].info.nameId);
this.jobLevel.setText(p("ui.common.level") + " " + e.currentLevel);
this._updateJobInfo(t.getJobExperience(e));
this.skillsList.empty();
w.createChild("div", {
  className: "skillName",
  text: v.nameId
});
d.push(w.createChild("div", {
  className: "skillDetail"
}));
u.push(v.interactiveId);
M.setText(p("ui.jobs.collectSkillInfos", f.time / 10, f.min, f.max));
r.push(v.gatheredRessourceItem);
M.setText(C);
n = n.concat(v.recipes);
M.addClassNames("bottom");
m.getItems(r, function (e, t) {
  if (e) {
    return I._afterRefreshTask(), console.error("JobsWindow: Failed to get ingredients", e);
  }
  if (I._afterRefreshTask()) {
    for (var i = 0; i < t.length; i++) {
      var n = t[i];
      s[i].setItem(n);
    }
  }
});
c.getDataMap("Interactives", u, function (e, t) {
  if (e) {
    return I._afterRefreshTask(), console.error("JobsWindow: Failed to get interactive data", e);
  }
  if (I._afterRefreshTask()) {
    for (var i = 0; i < u.length; i++) {
      var n = u[i],
        o = t[n];
      o ? d[i].setText(o.nameId) : console.error(new Error("JobsWindow: no interactive for id " + n));
    }
  }
});
this.recipeList.reset();
e = e || {};
a.call(this, "ul", e);
this.addClassNames("List");
e.cannotActivate && (this._cannotActivate = e.cannotActivate);
this.activeItem = null;
this.items = {};
o(n, a);
e.exports = n;
n.prototype.addItem = function (e, t, i) {
  var n = this,
    o = this.createChild("li", {
      name: e,
      className: e
    });
  return o.appendChild(t), o.element = t, i && (o.data = i), r(t), t.on("tap", function () {
    o === n.activeItem ? n.deactivate() : n.activate(o);
  }), this.items[e] = o, o;
};
n.prototype.removeItem = function (e) {
  var t = this.items[e];
  t && (t.destroy(), delete this.items[e]);
};
n.prototype.selectItem = function (e) {
  var t = this.items[e];
  if (t) {
    return this.activate(t), t;
  }
};
n.prototype.activate = function (e) {
  this._cannotActivate || (this.deactivate(!0), e.addClassNames("on"), this.emit("activate", e), this.activeItem = e, l("GEN_BUTTON"));
};
n.prototype.deactivate = function (e) {
  this.activeItem && (this.activeItem.delClassNames("on"), this.emit("deactivate", this.activeItem), this.activeItem = null, e || l("GEN_BUTTON"));
};
n.prototype.empty = function () {
  this.clearContent();
  this.activeItem = null;
  this.items = {};
};
n.prototype.sort = function (e, t) {
  s.sortObjectInArray(this.items, e, t);
};
this.clearContent();
this.activeItem = null;
this.items = {};
i.filterNbSlots[o.slotNumber] = e;
A && (i._currentPage = 0, i.pagination.setCurrent(0), i._search());
c.call(this, "div", {
  className: "RecipeList"
});
A = !1;
this._filterCraftableOnly = !1;
this.isInCraft = !!e.isInCraft;
this.shouldNotSelect = !!e.shouldNotSelect;
this.isMenuOnItemDisabled = !!e.isMenuOnItemDisabled;
this.selectedRecipe = null;
this.tappedRecipe = null;
this.usingItemId = null;
this._currentPage = -1;
this._isItemDataPending = !1;
this._recipesData = [];
this._currentFilteredRecipesList = [];
o.createChild("div", {
  className: "label",
  text: u("ui.common.recipes", 2)
});
this._searchInput = o.appendChild(new w());
this._searchInput.on("search", function () {
  i._currentPage = 0;
  i.pagination.setCurrent(0);
  i._search();
});
i._currentPage = 0;
i.pagination.setCurrent(0);
i._search();
a.createChild("div", {
  className: "label",
  text: u("ui.common.ingredients")
});
this.filterNbSlots = {};
this.filterText = "";
this.filterCheckboxes = {};
this.filterCheckboxes = a.createChild("div", {
  className: "filterCheckboxes"
});
this.filterCheckboxes[s] = t(s, !0);
i.filterNbSlots[s] = !0;
this.recipesWrapper = this.appendChild(new d({
  className: ["recipesWrapper", "spinner"]
}));
this._recipesPlaceholder = this.recipesWrapper.createChild("div", {
  className: "recipesPlaceholder",
  hidden: !0
});
this._recipesPlaceholder.createChild("div", {
  className: "recipesPlaceholderText",
  text: u("ui.craft.noCraftAvailable")
});
this.recipesList = this.recipesWrapper.content;
this.isInCraft && (this._checkboxWrapper = this.createChild("div", {
  className: "checkboxWrapper"
}), this._showCraftableCheckbox = this._checkboxWrapper.appendChild(new h(u("ui.craft.possibleRecipes"))), this._showCraftableCheckbox.addClassNames("possibleRecipeCheckbox"), this._showCraftableCheckbox.on("change", function (e) {
  i.filterCraftable(e);
}));
this.pagination = this.appendChild(new v());
this.pagination.on("previous", function () {
  i._displayPage(i._currentPage - 1);
});
this.pagination.on("next", function () {
  i._displayPage(i._currentPage + 1);
});
this.pagination.on("page", function (e) {
  i._displayPage(e);
});
l(n, c);
e.exports = n;
n.prototype._setPageCount = function (e) {
  var t = Math.ceil(e.length / I) || 1;
  t !== this._pageCount && (this._pageCount = t, this._currentPage = 0, this.pagination.setCurrent(0), this.pagination.setPageCount(this._pageCount));
};
n.prototype._updatePageCount = function (e) {
  var t = Math.ceil(e.length / I) || 1;
  t !== this._pageCount && (this._pageCount = t, this._displayPage(0), this.pagination.setPageCount(this._pageCount));
};
n.prototype._displayPage = function (e) {
  this._currentPage !== e && (e < 0 || e > this._pageCount - 1 || (this._currentPage = e, this.pagination.setCurrent(e), this._search()));
};
n.prototype.addRecipes = function (e, t, i) {
  this.recipesList.clearContent();
  this.recipesWrapper.addClassNames("spinner");
  t = t || {};
  this.usingItemId = t.usingItemId;
  this.tappedRecipe = null;
  var n = this;
  if (i = i || function () {}, 0 === e.length) {
    return this._recipesPlaceholder.show(), this.recipesWrapper.delClassNames("spinner"), this._setPageCount(e), this.recipesWrapper.refresh(), i();
  }
  this._recipesPlaceholder.hide();
  this._nbCase = t.nbCase || this._nbCase;
  this._isItemDataPending || (this._ingredientsLine.hide(), this._searchLine.hide(), this._searchBar.addClassNames("spinner"), this.isInCraft && (this._showCraftableCheckbox.hide(), this._checkboxWrapper.addClassNames("spinner")));
  var o = new Date().getTime();
  this._timestamp = o;
  var a = [];
  t.nbCase && t.nbCase < T ? e.forEach(function (e) {
    e.ingredientIds.length <= t.nbCase && a.push(e);
  }) : e.forEach(function (e) {
    a.push(e);
  });
  for (var s = {}, r = [], l = this._currentPage === -1 ? 0 : this._currentPage, c = (l + 1) * I < a.length, d = c ? (l + 1) * I : a.length, u = l * I; u < d; u += 1) {
    var h = a[u];
    if (h) {
      r.push(h);
      var f = h.ingredientIds;
      s[h.resultId] = !0;
      for (var g = 0, _ = f.length; g < _; g += 1) {
        var v = f[g];
        s[v] = !0;
      }
    }
  }
  s = Object.keys(s);
  p.getItems(s, function (s) {
    return s ? (console.error("Failed to get ingredients", s), i(s)) : n._timestamp !== o ? i() : m.eachSeries(r, function (e, t) {
      n._addRecipe(e, t);
    }, function (o) {
      if (o) {
        return console.error(o), i(o);
      }
      if (n._hasBeenReset()) {
        return i();
      }
      if (t.nbCase) {
        A = !1;
        for (var s = 1; s <= T; s += 1) {
          var r = s <= n._nbCase;
          n.filterNbSlots[s] = r;
          n.filterCheckboxes[s].toggleActivation(r);
        }
        A = !0;
      }
      0 === n._recipesData.length && (n._recipesData = e);
      n.recipesWrapper.delClassNames("spinner");
      n.recipesList.show();
      n.recipesWrapper.refresh();
      n.recipesWrapper.goToTop();
      n._setPageCount(a);
      n._isItemDataPending || (n._isItemDataPending = !0, m.eachLimit(e, 50, function (e, t) {
        var i = [e.resultId].concat(e.ingredientIds);
        p.getItems(i, t);
      }, function (e) {
        return e ? (console.error(e), i(e)) : n._hasBeenReset() ? i() : (A = !0, n._searchLine.show(), n._ingredientsLine.show(), n._searchBar.delClassNames("spinner"), n.isInCraft && (n._showCraftableCheckbox.show(), n._checkboxWrapper.delClassNames("spinner")), i());
      }));
    });
  });
};
n.prototype._addRecipe = function (e, t) {
  var i = this;
  if (!p.items[e.resultId]) {
    return console.error(new Error("Recipe " + e.resultId + " is missing")), t();
  }
  if (this._hasBeenReset()) {
    return t();
  }
  var n = new g(e, {
    isInCraft: this.isInCraft,
    nbCases: this._nbCase,
    isMenuOnItemDisabled: this.isMenuOnItemDisabled
  });
  n.recipeList = this;
  i.recipesList.appendChild(n);
  f(n, {
    doubletapTimeout: 1
  });
  n.on("tap", a);
  n.on("itemTapped", s);
  n.on("craftButtonTapped", r);
  n.setupRecipe(function (e, a) {
    if (e) {
      return console.error(new Error("Cannot setup recipe for recipeId " + n.recipeId)), t(e);
    }
    if (i.isInCraft && n.craftableCount) {
      var s = n.getItemSlot();
      _.setDraggable(s, {
        backgroundImage: s.image
      }, "recipeList", {
        source: "recipeList",
        selectRecipe: o,
        recipeBox: n
      });
    }
    t(null, a);
  });
};
n.prototype._tapOnRecipeBoxItemHandler = function (e, t, i) {
  this.shouldNotSelect || this.isInCraft || this.tappedRecipe || t.id !== this.usingItemId && (this.tappedRecipe = e, i.select(), setTimeout(function (e) {
    e.emit("itemTapped", t);
  }, 0, this));
};
n.prototype._tapOnRecipeBoxHandler = function (e) {
  if (!this.shouldNotSelect) {
    if (this.isInCraft) {
      this.tappedRecipe && this.tappedRecipe === e ? this._selectRecipe(e) : this._setTappedRecipe(e);
    } else {
      if (this.tappedRecipe) {
        return;
      }
      this.tappedRecipe = e;
      e.addClassNames("tapped");
      setTimeout(function (t) {
        t.emit("itemTapped", p.items[e.recipeId]);
      }, 0, this);
    }
  }
};
n.prototype._setTappedRecipe = function (e) {
  if (this.tappedRecipe && this.tappedRecipe.rootElement) {
    if (this.tappedRecipe === e) {
      return;
    }
    this.tappedRecipe.delClassNames("tapped");
  }
  e.addClassNames("tapped");
  this.tappedRecipe = e;
};
n.prototype._selectRecipe = function (e) {
  this._setTappedRecipe(e);
  this.emit("recipeSelected", e.recipeId);
};
n.prototype.isRecipeCraftableFromInventory = function (e) {
  var t = this.recipesList.getChild(e);
  return t.isCraftableFromBelongings(0);
};
n.prototype.filterCraftable = function (e) {
  this._filterCraftableOnly = e;
  this._search();
};
n.prototype._search = function () {
  var e = this,
    t = this._searchInput.getValue();
  if (this._currentFilteredRecipesList = [], null === t || "" === t) {
    return this._recipesData.forEach(function (t) {
      var i = e._filterCraftableOnly && e._canUseThisRecipe(t.resultId),
        n = i || !e._filterCraftableOnly;
      e.filterNbSlots[t.ingredientIds.length] && n && e._currentFilteredRecipesList.push(t);
    }), this.addRecipes(this._currentFilteredRecipesList, {
      usingItemId: this.usingItemId
    });
  }
  if (t.length < C) {
    return y.showNotification(u("ui.common.searchFilterTooltip"), this._searchInput);
  }
  t = M(t);
  var i = new RegExp(t, "i");
  this._recipesData.forEach(function (t) {
    var n = e._filterCraftableOnly && e._canUseThisRecipe(t.resultId),
      o = n || !e._filterCraftableOnly,
      a = p.items[t.resultId];
    if (!a) {
      return console.error("item", t.resultId, "is missing");
    }
    var s = M(a.nameId).search(i) !== -1;
    s && e.filterNbSlots[t.ingredientIds.length] && o && e._currentFilteredRecipesList.push(t);
  });
  this.addRecipes(this._currentFilteredRecipesList, {
    usingItemId: this.usingItemId
  });
};
n.prototype.highlightRecipe = function (e) {
  if (this.selectedRecipe && this.selectedRecipe.rootElement && this.selectedRecipe.delClassNames("selected"), null !== e) {
    var t = this.recipesList.getChild(e);
    t && (t.addClassNames("selected"), this.selectedRecipe = t);
  }
};
n.prototype.reset = function () {
  this._isItemDataPending = !1;
  this._pageCount = null;
  this._currentPage = -1;
  this._recipesData = [];
  this.selectedRecipe = null;
  this.tappedRecipe = null;
  this.usingItemId = null;
  this._recipesPlaceholder.hide();
  this.recipesList.hide();
  this.recipesList.clearContent();
  this.filterText = "";
  this._searchInput.clear();
  this._currentFilteredRecipesList = [];
  this._showCraftableCheckbox && this._showCraftableCheckbox.deactivate();
};
n.prototype.refreshDisplayedRecipes = function () {
  this._search();
  for (var e = this.recipesList.getChildren(), t = 0; t < e.length; t++) {
    var i = e[t];
    i.refreshQuantities();
  }
};
n.prototype._canUseThisRecipe = function (e) {
  for (var t = null, i = 0; i < this._recipesData.length; i++) {
    if (this._recipesData[i].resultId === e) {
      t = this._recipesData[i];
      break;
    }
  }
  if (!t) {
    return !1;
  }
  for (i = 0; i < t.ingredientIds.length; i++) {
    var n = window.gui.playerData.belongings.getItemCounts(t.ingredientIds[i]),
      o = n[b.INVENTORY_QTY];
    if (t.quantities && t.quantities[i] > o) {
      return !1;
    }
  }
  return !0;
};
n.prototype._hasBeenReset = function () {
  return !this.recipesList || !this.recipesList.rootElement;
};
this.recipesList.clearContent();
this.recipesWrapper.addClassNames("spinner");
t = t || {};
this.usingItemId = t.usingItemId;
this.tappedRecipe = null;
this._recipesPlaceholder.hide();
this._nbCase = t.nbCase || this._nbCase;
this._isItemDataPending || (this._ingredientsLine.hide(), this._searchLine.hide(), this._searchBar.addClassNames("spinner"), this.isInCraft && (this._showCraftableCheckbox.hide(), this._checkboxWrapper.addClassNames("spinner")));
s = Object.keys(s);
p.getItems(s, function (s) {
  return s ? (console.error("Failed to get ingredients", s), i(s)) : n._timestamp !== o ? i() : m.eachSeries(r, function (e, t) {
    n._addRecipe(e, t);
  }, function (o) {
    if (o) {
      return console.error(o), i(o);
    }
    if (n._hasBeenReset()) {
      return i();
    }
    if (t.nbCase) {
      A = !1;
      for (var s = 1; s <= T; s += 1) {
        var r = s <= n._nbCase;
        n.filterNbSlots[s] = r;
        n.filterCheckboxes[s].toggleActivation(r);
      }
      A = !0;
    }
    0 === n._recipesData.length && (n._recipesData = e);
    n.recipesWrapper.delClassNames("spinner");
    n.recipesList.show();
    n.recipesWrapper.refresh();
    n.recipesWrapper.goToTop();
    n._setPageCount(a);
    n._isItemDataPending || (n._isItemDataPending = !0, m.eachLimit(e, 50, function (e, t) {
      var i = [e.resultId].concat(e.ingredientIds);
      p.getItems(i, t);
    }, function (e) {
      return e ? (console.error(e), i(e)) : n._hasBeenReset() ? i() : (A = !0, n._searchLine.show(), n._ingredientsLine.show(), n._searchBar.delClassNames("spinner"), n.isInCraft && (n._showCraftableCheckbox.show(), n._checkboxWrapper.delClassNames("spinner")), i());
    }));
  });
});
n.filterNbSlots[s] = r;
n.filterCheckboxes[s].toggleActivation(r);
0 === n._recipesData.length && (n._recipesData = e);
n.recipesWrapper.delClassNames("spinner");
n.recipesList.show();
n.recipesWrapper.refresh();
n.recipesWrapper.goToTop();
n._setPageCount(a);
n._isItemDataPending || (n._isItemDataPending = !0, m.eachLimit(e, 50, function (e, t) {
  var i = [e.resultId].concat(e.ingredientIds);
  p.getItems(i, t);
}, function (e) {
  return e ? (console.error(e), i(e)) : n._hasBeenReset() ? i() : (A = !0, n._searchLine.show(), n._ingredientsLine.show(), n._searchBar.delClassNames("spinner"), n.isInCraft && (n._showCraftableCheckbox.show(), n._checkboxWrapper.delClassNames("spinner")), i());
}));
n.recipeList = this;
i.recipesList.appendChild(n);
f(n, {
  doubletapTimeout: 1
});
n.on("tap", a);
n.on("itemTapped", s);
n.on("craftButtonTapped", r);
n.setupRecipe(function (e, a) {
  if (e) {
    return console.error(new Error("Cannot setup recipe for recipeId " + n.recipeId)), t(e);
  }
  if (i.isInCraft && n.craftableCount) {
    var s = n.getItemSlot();
    _.setDraggable(s, {
      backgroundImage: s.image
    }, "recipeList", {
      source: "recipeList",
      selectRecipe: o,
      recipeBox: n
    });
  }
  t(null, a);
});
this.tappedRecipe = e;
e.addClassNames("tapped");
setTimeout(function (t) {
  t.emit("itemTapped", p.items[e.recipeId]);
}, 0, this);
e.addClassNames("tapped");
this.tappedRecipe = e;
this._setTappedRecipe(e);
this.emit("recipeSelected", e.recipeId);
this._filterCraftableOnly = e;
this._search();
this._recipesData.forEach(function (t) {
  var n = e._filterCraftableOnly && e._canUseThisRecipe(t.resultId),
    o = n || !e._filterCraftableOnly,
    a = p.items[t.resultId];
  if (!a) {
    return console.error("item", t.resultId, "is missing");
  }
  var s = M(a.nameId).search(i) !== -1;
  s && e.filterNbSlots[t.ingredientIds.length] && o && e._currentFilteredRecipesList.push(t);
});
this.addRecipes(this._currentFilteredRecipesList, {
  usingItemId: this.usingItemId
});
this._isItemDataPending = !1;
this._pageCount = null;
this._currentPage = -1;
this._recipesData = [];
this.selectedRecipe = null;
this.tappedRecipe = null;
this.usingItemId = null;
this._recipesPlaceholder.hide();
this.recipesList.hide();
this.recipesList.clearContent();
this.filterText = "";
this._searchInput.clear();
this._currentFilteredRecipesList = [];
this._showCraftableCheckbox && this._showCraftableCheckbox.deactivate();
d.call(this, "div", {
  className: "RecipeBox",
  name: e.resultId
});
t = t || {};
this.rawRecipe = e;
this.recipeId = e.resultId;
this.nbCases = t.nbCases || 0;
this.isMenuOnItemDisabled = !!t.isMenuOnItemDisabled;
this._hasBeenDestroy = !1;
this._item = o.appendChild(new l({
  noDoubleTap: !0,
  forceQuantity: !0
}));
this.isMenuOnItemDisabled || this._item.setContextMenu("item", {});
this._recipeLeft = o.createChild("div", {
  className: "recipeLeft"
});
b.setHtml(s("ui.tooltip.monsterXpAlone", f));
c && b.addClassNames("warningText");
this._ingredientsList = i.createChild("div", {
  className: "ingredientsList"
});
t.isInCraft && (this.craftButton = this._ingredientsList.appendChild(new u({
  addIcon: !0,
  className: ["greenButton", "recipeButton"],
  scaleOnPress: !0
})), this.craftButton.on("tap", function () {
  i.emit("craftButtonTapped");
}));
this.on("destroy", function () {
  i._hasBeenDestroy = !0;
});
c(n, d);
e.exports = n;
n.prototype.setupRecipe = function (e) {
  var t = this,
    i = this.rawRecipe,
    n = [this.recipeId].concat(i.ingredientIds),
    s = i.ingredientIds.length;
  r.getItems(n, function (n) {
    if (n) {
      return e(n);
    }
    if (t._hasBeenDestroy) {
      return e();
    }
    var l = r.items[t.recipeId];
    if (!l) {
      return e();
    }
    t._item.setItem(l);
    t._item.recipeBox = t;
    t._item.on("tap", a);
    t.craftDetails = o(i, l);
    t._recipeLeft.createChild("div", {
      className: "recipeName",
      text: l.nameId
    });
    t._recipeLeft.createChild("div", {
      className: "recipeSkillName",
      text: t.craftDetails
    });
    for (var c = l.nameId, d = 0, u = 0; u < s; u += 1) {
      var h = i.ingredientIds[u],
        p = r.items[h];
      p ? (c += " " + p.nameId, t._createIngredientSlot(p, i.quantities[u]), d += 1) : console.error("RecipeBox#setupRecipe: ingredientId", h, "from recipeId", t.recipeId, "is missing, just continue");
    }
    return t.nbIngredients = d, t.searchString = f(c), t.refreshQuantities(), e(null, t);
  });
};
n.prototype._createIngredientSlot = function (e, t) {
  var i = this._ingredientsList.appendChild(new l({
    itemData: e,
    forceQuantity: !0,
    noDoubleTap: !0
  }));
  i.recipeBox = this;
  i.qtyNeeded = t;
  i.on("tap", a);
  this.isMenuOnItemDisabled || i.setContextMenu("item", {});
  this.ingredients.push(i);
  this._refreshIngredientSlot(i);
};
n.prototype.refreshQuantities = function () {
  this.craftableCount = 1 / 0;
  this.craftableRemoteCount = 1 / 0;
  this.missingIngredientCount = 0;
  for (var e = 0; e < this.nbIngredients; e++) {
    this._refreshIngredientSlot(this.ingredients[e]);
  }
  this._item.setQuantity(this.craftableCount > 0 ? "(x" + this.craftableCount + ")" : "");
  this.craftButton && this.craftButton.toggleDisplay(this.craftableCount > 0);
};
n.prototype._refreshIngredientSlot = function (e) {
  var t = e.data.id,
    i = e.qtyNeeded,
    n = window.gui.playerData.belongings.getItemCounts(t),
    o = n[m.INVENTORY_QTY],
    a = n[m.BANK_QTY],
    s = n[m.MOUNT_QTY],
    r = !!window.gui.playerData.equippedMount,
    l = o + (a || 0) + (s || 0);
  i > l && this.missingIngredientCount++;
  this.craftableCount = Math.min(this.craftableCount, Math.floor(o / i));
  this.craftableRemoteCount = Math.min(this.craftableRemoteCount, Math.floor(l / i));
  var c = o >= i ? o : l,
    d = "";
  d = o >= i ? "quantityGood" : l >= i ? "quantityRemote" : null === a || null === s && r ? "quantityUnknown" : "quantityNoGood";
  e.setClassNames(["Slot", "ItemSlot", d]);
  c = (c > 99 ? "99+" : c) + "/" + i;
  e.setQuantity(c);
};
n.prototype.getItemSlot = function () {
  return this._item;
};
n.prototype.isCraftableFromBelongings = function (e) {
  return this.craftableRemoteCount > 0 || this.missingIngredientCount <= e;
};
t._item.setItem(l);
t._item.recipeBox = t;
t._item.on("tap", a);
t.craftDetails = o(i, l);
t._recipeLeft.createChild("div", {
  className: "recipeName",
  text: l.nameId
});
t._recipeLeft.createChild("div", {
  className: "recipeSkillName",
  text: t.craftDetails
});
i.recipeBox = this;
i.qtyNeeded = t;
i.on("tap", a);
this.isMenuOnItemDisabled || i.setContextMenu("item", {});
this.ingredients.push(i);
this._refreshIngredientSlot(i);
this.craftableCount = 1 / 0;
this.craftableRemoteCount = 1 / 0;
this.missingIngredientCount = 0;
this._item.setQuantity(this.craftableCount > 0 ? "(x" + this.craftableCount + ")" : "");
this.craftButton && this.craftButton.toggleDisplay(this.craftableCount > 0);
i > l && this.missingIngredientCount++;
this.craftableCount = Math.min(this.craftableCount, Math.floor(o / i));
this.craftableRemoteCount = Math.min(this.craftableRemoteCount, Math.floor(l / i));
d = o >= i ? "quantityGood" : l >= i ? "quantityRemote" : null === a || null === s && r ? "quantityUnknown" : "quantityNoGood";
e.setClassNames(["Slot", "ItemSlot", d]);
c = (c > 99 ? "99+" : c) + "/" + i;
e.setQuantity(c);
this.once("open", function () {
  e = this.windowBody.createChild("div", {
    className: "subAreaName"
  });
  t = this.windowBody.createChild("div", {
    className: "explanation"
  });
  var r = this.windowBody.createChild("div", {
    className: "selectorBox"
  });
  i = r.appendChild(new s({
    className: "hours"
  }));
  i.on("change", function (e) {
    f = e;
  });
  for (var c = 0; c < 10; c += 1) {
    i.addOption("0" + c, c);
  }
  for (c = 10; c < 24; c += 1) {
    i.addOption(c, c);
  }
  n = r.appendChild(new s({
    className: "minutes"
  }));
  n.on("change", function (e) {
    g = e;
  });
  n.addOption("00", h[0]);
  n.addOption("30", h[30]);
  var _ = this,
    v = this.windowBody.createChild("div", {
      className: "buttonBox"
    });
  o = v.appendChild(new l(a("ui.common.save")));
  o.on("tap", function () {
    var e = d.time.timezoneOffset,
      t = e / 1e3 * 60 % 60,
      i = e / 36e5 % 24,
      n = 4 * (f - i) + (g - t);
    n < 0 && (n += 96);
    window.dofus.sendMessage("PrismSettingsRequestMessage", {
      subAreaId: m.subAreaId,
      startDefenseTime: n
    });
    u.close(_.id);
  });
  p = v.appendChild(new l(a("ui.common.cancel")));
  p.on("tap", function () {
    u.close(_.id);
  });
});
this.on("open", function (o) {
  m = o.prism;
  var s = o.vulnerableTime.getServerDate(),
    l = s.toString(),
    c = m.enrichData;
  e.setText(c.subAreaName + " (" + c.areaName + ")");
  var d = window.gui.serversData.sessionConstants[r.SERVER_CONST_KOH_DURATION];
  t.setText(a("ui.prism.vulnerabilityHourInfos", Math.round(d / 1e3 / 360) / 10, l.hour, l.minute));
  i.select(s.hour);
  n.select(h[s.minute] || h[0]);
});
e = this.windowBody.createChild("div", {
  className: "subAreaName"
});
t = this.windowBody.createChild("div", {
  className: "explanation"
});
i = r.appendChild(new s({
  className: "hours"
}));
i.on("change", function (e) {
  f = e;
});
n = r.appendChild(new s({
  className: "minutes"
}));
n.on("change", function (e) {
  g = e;
});
n.addOption("00", h[0]);
n.addOption("30", h[30]);
o = v.appendChild(new l(a("ui.common.save")));
o.on("tap", function () {
  var e = d.time.timezoneOffset,
    t = e / 1e3 * 60 % 60,
    i = e / 36e5 % 24,
    n = 4 * (f - i) + (g - t);
  n < 0 && (n += 96);
  window.dofus.sendMessage("PrismSettingsRequestMessage", {
    subAreaId: m.subAreaId,
    startDefenseTime: n
  });
  u.close(_.id);
});
p = v.appendChild(new l(a("ui.common.cancel")));
p.on("tap", function () {
  u.close(_.id);
});
n < 0 && (n += 96);
window.dofus.sendMessage("PrismSettingsRequestMessage", {
  subAreaId: m.subAreaId,
  startDefenseTime: n
});
u.close(_.id);
t.setText(a("ui.prism.vulnerabilityHourInfos", Math.round(d / 1e3 / 360) / 10, l.hour, l.minute));
i.select(s.hour);
n.select(h[s.minute] || h[0]);
o(n, c);
e.exports = n;
this._isModeratorOrMore = !1;
this.once("open", function () {
  e.addClassNames("spinner");
  e.windowBody.hide();
  e._createDom();
  b.preloadImage("ui/slot.png", function (t) {
    e.slotIconImage = t;
  });
  f.getAllDataTable(["EmblemSymbolCategories", "EmblemSymbols", "EmblemBackgrounds"], function (t, i) {
    return t ? console.error("SocialGroupCreationWindow: Failed to retrieve emblem data", t) : (e.emblemBackgrounds = i.EmblemBackgrounds, e.emblemSymbols = i.EmblemSymbols, e.emblemSymbolCategories = i.EmblemSymbolCategories, e._generateSelectorOptions(), e._displayEmblemBackgrounds(i.EmblemBackgrounds), e._displayEmblemSymbols(i.EmblemSymbols), e._setupUI(), e.delClassNames("spinner"), e.windowBody.show(), e._updateUISize(), e.on("open", function () {
      e.addClassNames("spinner");
      e._generateSelectorOptions();
      e.windowBody.hide();
      e.tabs.openTab("background");
      e._setupUI();
      e.delClassNames("spinner");
      e.windowBody.show();
    }), void e.on("opened", function () {
      e._updateUISize();
    }));
  });
});
e.addClassNames("spinner");
e.windowBody.hide();
e._createDom();
b.preloadImage("ui/slot.png", function (t) {
  e.slotIconImage = t;
});
f.getAllDataTable(["EmblemSymbolCategories", "EmblemSymbols", "EmblemBackgrounds"], function (t, i) {
  return t ? console.error("SocialGroupCreationWindow: Failed to retrieve emblem data", t) : (e.emblemBackgrounds = i.EmblemBackgrounds, e.emblemSymbols = i.EmblemSymbols, e.emblemSymbolCategories = i.EmblemSymbolCategories, e._generateSelectorOptions(), e._displayEmblemBackgrounds(i.EmblemBackgrounds), e._displayEmblemSymbols(i.EmblemSymbols), e._setupUI(), e.delClassNames("spinner"), e.windowBody.show(), e._updateUISize(), e.on("open", function () {
    e.addClassNames("spinner");
    e._generateSelectorOptions();
    e.windowBody.hide();
    e.tabs.openTab("background");
    e._setupUI();
    e.delClassNames("spinner");
    e.windowBody.show();
  }), void e.on("opened", function () {
    e._updateUISize();
  }));
});
e.addClassNames("spinner");
e._generateSelectorOptions();
e.windowBody.hide();
e.tabs.openTab("background");
e._setupUI();
e.delClassNames("spinner");
e.windowBody.show();
t.on("GuildCreationStartedMessage", function () {
  e.mode = "guild";
  e.modification = !1;
  d.openDialog(e.id);
});
t.on("GuildModificationStartedMessage", function (t) {
  e.mode = "guild";
  t.canChangeName && t.canChangeEmblem ? e.modification = "all" : t.canChangeName ? e.modification = "name" : e.modification = "emblem";
  d.openDialog(e.id);
});
t.on("AllianceCreationStartedMessage", function () {
  e.mode = "alliance";
  e.modification = !1;
  d.openDialog(e.id);
});
t.on("AllianceModificationStartedMessage", function (t) {
  e.mode = "alliance";
  t.canChangeName && t.canChangeEmblem && t.canChangeTag ? e.modification = "all" : t.canChangeName ? e.modification = "name" : e.modification = "emblem";
  d.openDialog(e.id);
});
e.mode = "guild";
e.modification = !1;
d.openDialog(e.id);
e.mode = "guild";
t.canChangeName && t.canChangeEmblem ? e.modification = "all" : t.canChangeName ? e.modification = "name" : e.modification = "emblem";
d.openDialog(e.id);
e.mode = "alliance";
e.modification = !1;
d.openDialog(e.id);
e.mode = "alliance";
t.canChangeName && t.canChangeEmblem && t.canChangeTag ? e.modification = "all" : t.canChangeName ? e.modification = "name" : e.modification = "emblem";
d.openDialog(e.id);
s(n, r);
e.exports = n;
n.prototype._setupUI = function () {
  if ("alliance" === this.mode ? (this.tagNameBox.show(), this.tagInput.show(), this.nameLabel.setText(l("ui.alliance.name") + l("ui.common.colon")), this.setTitle(l("ui.alliance.creation"))) : (this.tagNameBox.hide(), this.tagInput.hide(), this.nameLabel.setText(l("ui.social.guildName") + l("ui.common.colon")), this.setTitle(l("ui.social.guildCreation"))), !this.modification) {
    return this._generateRandomEmblem(), this.nameInput.enable(), this.nameInput.setValue(""), this.tagInput.enable(), this.tagInput.setValue(""), void this.cover.hide();
  }
  var e = window.gui.playerData[this.mode].current;
  switch ("alliance" === this.mode ? (this.nameInput.setValue(e.allianceName), this.tagInput.setValue(e.allianceTag), this._setEmblem(e.allianceEmblem)) : (this.nameInput.setValue(e.guildName), this._setEmblem(e.guildEmblem)), this.modification) {
    case "all":
      this.nameInput.enable();
      this.tagInput.enable();
      this.cover.hide();
      break;
    case "name":
      this.nameInput.enable();
      this.tagInput.enable();
      this.cover.show();
      break;
    case "emblem":
      this.nameInput.disable();
      this.tagInput.disable();
      this.cover.hide();
  }
};
n.prototype._setEmblem = function (e) {
  this.emblem.setValue(e, !0);
  this.bgColor = e.backgroundColor;
  this.bgId = e.backgroundShape;
  this.symbolColor = e.symbolColor;
  this.symbolId = e.symbolShape;
  for (var t = null, i = 0; i < this.emblemSymbols.length; i += 1) {
    var n = this.emblemSymbols[i];
    if (n.id === this.symbolId) {
      t = n;
      break;
    }
  }
  t ? this.selector.select(t.categoryId) : console.error("SocialGroupCreationWindow._setEmblem: emblemSymbol is null for symbolId", this.symbolId);
};
n.prototype._generateSelectorOptions = function () {
  if (this.emblemSymbolCategories) {
    this.selector.clearContent();
    this._isModeratorOrMore = window.gui.playerData.isModeratorOrMore();
    for (var e = 0; e < this.emblemSymbolCategories.length; e++) {
      var t = this.emblemSymbolCategories[e];
      (this._isModeratorOrMore || 13 !== t.id) && this.selector.addOption(t.nameId, t.id);
    }
    this.selector.select(1);
  }
};
n.prototype._generateRandomEmblem = function () {
  this.bgColorPicker.generateRandomColor();
  this.motifColorPicker.generateRandomColor();
  var e = Math.round(Math.random() * (this.emblemBackgrounds.length - 1)),
    t = Math.round(Math.random() * (this.emblemSymbols.length - (this._isModeratorOrMore ? 2 : 1)));
  this._setBackgroundShape(this.emblemBackgrounds[e].id);
  this._setSymbolShape(this.emblemSymbols[t].iconId);
};
n.prototype._setBackgroundShape = function (e) {
  this.emblem.setValue({
    backgroundShape: e
  });
  this.bgId = e;
};
n.prototype._setSymbolShape = function (e) {
  this.emblem.setValue({
    symbolShape: e
  });
  this.symbolId = e;
};
n.prototype._displayEmblemBackgrounds = function (e) {
  function t() {
    i._setBackgroundShape(this.id);
  }
  for (var i = this, n = [], o = 0; o < e.length; o++) {
    n.push("gfx/emblems/icons/back/" + e[o].id + ".png");
  }
  b.preloadImages(n, function (n) {
    for (var o = 0; o < n.length; o++) {
      var a = i.backgroundScroller.content.appendChild(new g({
        className: "icon"
      }, t));
      a.setStyle("backgroundImage", n[o] + ", " + i.slotIconImage);
      a.id = e[o].id;
    }
    i.backgroundScroller.refresh();
  });
};
n.prototype._displayEmblemSymbols = function (e) {
  function t() {
    i._setSymbolShape(this.id);
  }
  var i = this,
    n = [];
  i.notColorizable = [];
  for (var o = 0; o < e.length; o++) {
    n.push("gfx/emblems/icons/up/" + e[o].iconId + ".png");
    e[o].colorizable || i.notColorizable.push(e[o].id);
  }
  b.preloadImages(n, function (n) {
    for (var o = 0; o < n.length; o++) {
      var a = i.symbolScroller.content.appendChild(new g({
        className: ["icon", "white"]
      }, t));
      a.setStyle("backgroundImage", n[o] + ", " + i.slotIconImage);
      a.categoryId = e[o].categoryId;
      a.id = e[o].id;
    }
    i.selector.select(1);
  });
};
n.prototype._createDom = function () {
  function e(e) {
    i.bgColor !== e.hex.substr(1) && (i.bgColor = parseInt(e.hex.substr(1), 16), i.emblem.setValue({
      backgroundColor: e.rgb
    }));
  }
  function t(e) {
    i.symbolColor !== e.hex.substr(1) && (i.symbolColor = parseInt(e.hex.substr(1), 16), i.notColorizable.indexOf(i.symbolId) === -1 && i.emblem.setValue({
      symbolColor: e.rgb
    }));
  }
  var i = this,
    n = this.windowBody.createChild("div", {
      className: "guildNameBox"
    });
  this.nameLabel = n.createChild("div", {
    className: "label"
  });
  var s = n.createChild("div", {
    className: "info"
  });
  a(s, l("ui.social.nameRules"), {
    openOnTap: !0
  });
  var r = this.nameInput = this.windowBody.appendChild(new m({
      className: "socialInputBox",
      attr: {
        type: "text",
        maxlength: 30
      }
    })),
    c = this.tagNameBox = this.windowBody.createChild("div", {
      className: "tagNameBox"
    });
  c.createChild("div", {
    className: "label",
    text: l("ui.alliance.tagInfo") + l("ui.common.colon")
  });
  s = c.createChild("div", {
    className: "info"
  });
  a(s, l("ui.alliance.tagRules"), {
    openOnTap: !0
  });
  var d = this.tagInput = this.windowBody.appendChild(new m({
    className: "socialInputBox",
    attr: {
      type: "text",
      maxlength: 30
    }
  }));
  this.emblem = this.windowBody.appendChild(new y());
  this.windowBody.createChild("div", {
    className: "text",
    text: l("ui.social.createEmblem") + l("ui.common.colon")
  });
  var f = this.tabs = this.windowBody.appendChild(new v());
  this.cover = f.content.createChild("div", {
    className: "cover"
  });
  var g = new M("div", {
      className: "backgroundTab"
    }),
    b = new M("div", {
      className: "motifTab"
    });
  f.addTab(l("ui.social.emblemBack"), g, "background");
  f.addTab(l("ui.social.emblemUp"), b, "motif");
  f.openTab("background");
  this.backgroundScroller = g.appendChild(new _({
    className: "iconScroller"
  }));
  this.bgColorPicker = g.appendChild(new p({
    tintWidth: T,
    tintHeight: C,
    lumWidth: I,
    showHexButton: !0
  }));
  this.bgColorPicker.on("colorChanged", e);
  this.bgColorPicker.on("newColor", e);
  var A = b.createChild("div", {
    className: "motifContainer"
  });
  this.selector = A.appendChild(new u());
  this.selector.on("change", function (e) {
    var t = i.symbolScroller.content.getChildren();
    e = parseInt(e, 10);
    for (var n = 0; n < t.length; n++) {
      e !== t[n].categoryId ? t[n].hide() : t[n].show();
    }
    i.symbolScroller.refresh();
  });
  this.symbolScroller = A.appendChild(new _({
    className: "iconScroller"
  }));
  b.once("opened", function () {
    i.symbolScroller.refresh();
  });
  this.motifColorPicker = b.appendChild(new p({
    tintWidth: T,
    tintHeight: C,
    lumWidth: I,
    showHexButton: !0
  }));
  this.motifColorPicker.on("colorChanged", t);
  this.motifColorPicker.on("newColor", t);
  var S = this.windowBody.createChild("div", {
      className: "buttonContainer"
    }),
    E = S.appendChild(new h(l("ui.common.validation")));
  E.on("tap", function () {
    var e = r.getValue(),
      t = {
        symbolShape: i.symbolId,
        symbolColor: i.symbolColor,
        backgroundShape: i.bgId,
        backgroundColor: i.bgColor
      };
    if ("alliance" === i.mode) {
      if (!o(e, w.MIN_ALLIANCENAME_LEN, w.MAX_ALLIANCENAME_LEN, l("ui.alliance.invalidLengthName"))) {
        return;
      }
      var n = d.getValue();
      if (!o(n, w.MIN_ALLIANCETAG_LEN, w.MAX_ALLIANCETAG_LEN, l("ui.alliance.invalidLengthTag"))) {
        return;
      }
      if (!i.modification) {
        return window.dofus.sendMessage("AllianceCreationValidMessage", {
          allianceName: e,
          allianceTag: n,
          allianceEmblem: t
        });
      }
      switch (i.modification) {
        case "all":
          window.dofus.sendMessage("AllianceModificationValidMessage", {
            allianceName: e,
            allianceTag: n,
            Alliancemblem: t
          });
          break;
        case "emblem":
          window.dofus.sendMessage("AllianceModificationEmblemValidMessage", {
            Alliancemblem: t
          });
          break;
        case "name":
          window.dofus.sendMessage("AllianceModificationNameAndTagValidMessage", {
            allianceName: e,
            allianceTag: n
          });
      }
    } else {
      if (!o(e, w.MIN_GUILDNAME_LEN, w.MAX_GUILDNAME_LEN, l("ui.alliance.invalidLengthName"))) {
        return;
      }
      if (!i.modification) {
        return window.dofus.sendMessage("GuildCreationValidMessage", {
          guildName: e,
          guildEmblem: t
        });
      }
      switch (i.modification) {
        case "all":
          window.dofus.sendMessage("GuildModificationValidMessage", {
            guildName: e,
            guildEmblem: t
          });
          break;
        case "emblem":
          window.dofus.sendMessage("GuildModificationEmblemValidMessage", {
            guildEmblem: t
          });
          break;
        case "name":
          window.dofus.sendMessage("GuildModificationNameValidMessage", {
            guildName: e
          });
      }
    }
  });
};
n.prototype._updateUISize = function () {
  var e = this.bgColorPicker.rootElement.clientHeight,
    t = this.bgColorPicker.rootElement.clientWidth;
  0 !== e && 0 !== t && (this.bgColorPicker.updateDimensions(t, e, I), this.motifColorPicker.updateDimensions(t, e, I));
};
this.nameInput.enable();
this.tagInput.enable();
this.cover.hide();
this.nameInput.enable();
this.tagInput.enable();
this.cover.show();
this.nameInput.disable();
this.tagInput.disable();
this.cover.hide();
this.emblem.setValue(e, !0);
this.bgColor = e.backgroundColor;
this.bgId = e.backgroundShape;
this.symbolColor = e.symbolColor;
this.symbolId = e.symbolShape;
this.selector.clearContent();
this._isModeratorOrMore = window.gui.playerData.isModeratorOrMore();
this.bgColorPicker.generateRandomColor();
this.motifColorPicker.generateRandomColor();
this._setBackgroundShape(this.emblemBackgrounds[e].id);
this._setSymbolShape(this.emblemSymbols[t].iconId);
this.emblem.setValue({
  backgroundShape: e
});
this.bgId = e;
this.emblem.setValue({
  symbolShape: e
});
this.symbolId = e;
a.setStyle("backgroundImage", n[o] + ", " + i.slotIconImage);
a.id = e[o].id;
n.push("gfx/emblems/icons/up/" + e[o].iconId + ".png");
e[o].colorizable || i.notColorizable.push(e[o].id);
a.setStyle("backgroundImage", n[o] + ", " + i.slotIconImage);
a.categoryId = e[o].categoryId;
a.id = e[o].id;
c.createChild("div", {
  className: "label",
  text: l("ui.alliance.tagInfo") + l("ui.common.colon")
});
s = c.createChild("div", {
  className: "info"
});
a(s, l("ui.alliance.tagRules"), {
  openOnTap: !0
});
this.emblem = this.windowBody.appendChild(new y());
this.windowBody.createChild("div", {
  className: "text",
  text: l("ui.social.createEmblem") + l("ui.common.colon")
});
f.addTab(l("ui.social.emblemBack"), g, "background");
f.addTab(l("ui.social.emblemUp"), b, "motif");
f.openTab("background");
this.backgroundScroller = g.appendChild(new _({
  className: "iconScroller"
}));
this.bgColorPicker = g.appendChild(new p({
  tintWidth: T,
  tintHeight: C,
  lumWidth: I,
  showHexButton: !0
}));
this.bgColorPicker.on("colorChanged", e);
this.bgColorPicker.on("newColor", e);
this.selector = A.appendChild(new u());
this.selector.on("change", function (e) {
  var t = i.symbolScroller.content.getChildren();
  e = parseInt(e, 10);
  for (var n = 0; n < t.length; n++) {
    e !== t[n].categoryId ? t[n].hide() : t[n].show();
  }
  i.symbolScroller.refresh();
});
this.symbolScroller = A.appendChild(new _({
  className: "iconScroller"
}));
b.once("opened", function () {
  i.symbolScroller.refresh();
});
this.motifColorPicker = b.appendChild(new p({
  tintWidth: T,
  tintHeight: C,
  lumWidth: I,
  showHexButton: !0
}));
this.motifColorPicker.on("colorChanged", t);
this.motifColorPicker.on("newColor", t);
this.deltaX = e.x - t.left - this.picker.x;
this.deltaY = e.y - t.top - this.picker.y;
this.box = t;
c.call(this, "div", {
  className: "ColorPicker"
});
this.hexSelector = this.appendChild(new d());
this.hexSelector.on("confirm", function (e) {
  var t = u.hexToRgb(e);
  t && (m.setCurrentColor([t.r, t.g, t.b]), i());
});
this.params = {
  tintWidth: e.tintWidth || 162,
  tintHeight: e.tintHeight || 110,
  lumWidth: e.lumWidth || 16,
  lumHeight: e.lumHeight || 110,
  showHexButton: !!e.showHexButton
};
this.currentTint = [255, 0, 0];
this.currentColor = [255, 0, 0];
this.tintWrapper = this.createChild("div", {
  className: "tintWrapper"
});
this.tintCanvas = this.tintWrapper.createChild("canvas", {
  className: "tintCanvas"
});
this.tintCanvas.rootElement.width = this.params.tintWidth;
this.tintCanvas.rootElement.height = this.params.tintHeight;
o(this.tintCanvas);
a(this.tintCanvas);
this.tintCanvas.panelType = "tint";
this.tintCanvas.on("slideStart", t);
this.tintCanvas.on("slide", s);
this.tintCanvas.on("slideEnd", i);
this.tintCanvas.on("tapstart", t);
this.tintCanvas.on("tap", n);
this.tintCanvas.on("doubletap", this.openHexInput.bind(this));
this.tintPicker = this.tintWrapper.createChild("div", {
  className: "tintPicker"
});
this.tintCanvas.picker = this.tintPicker;
this.lumWrapper = this.createChild("div", {
  className: "lumWrapper"
});
this.lumCanvas = this.lumWrapper.createChild("canvas", {
  className: "lumCanvas"
});
this.lumCanvas.rootElement.width = 1;
this.lumCanvas.rootElement.height = this.params.lumHeight;
o(this.lumCanvas);
a(this.lumCanvas);
this.lumCanvas.panelType = "lum";
this.lumCanvas.on("slideStart", t);
this.lumCanvas.on("slide", s);
this.lumCanvas.on("slideEnd", i);
this.lumCanvas.on("tapstart", t);
this.lumCanvas.on("tap", n);
s(n, c);
e.exports = n;
n.prototype.updateDimensions = function (e, t, i) {
  this.params.lumWidth = i || Math.min(e / 5, h);
  var n = this.params.showHexButton ? f : 0,
    o = e - this.params.lumWidth - p - n;
  o = o > 0 ? o : this.params.tintWidth;
  this.params.tintWidth = o;
  this.params.tintHeight = t;
  this.tintCanvas.rootElement.width = o;
  this.tintCanvas.rootElement.height = t;
  this.tintCanvas.setStyles({
    width: o + "px",
    height: t + "px"
  });
  this.params.lumHeight = this.params.showHexButton ? t - m : t;
  this.lumCanvas.rootElement.height = this.params.lumHeight;
  this.lumCanvas.setStyles({
    width: this.params.lumWidth + "px",
    height: this.params.lumHeight + "px"
  });
  this.lumPicker.setStyle("width", this.params.lumWidth + "px");
  this.fillTint();
  this.updateLuminosity();
  this.setCurrentColor(this.currentColor);
};
n.prototype._lumCoordinatesToColor = function (e) {
  var t = e / (this.params.lumHeight / 2),
    i = t < 1 ? [255, 255, 255] : this.currentTint,
    n = t < 1 ? this.currentTint : [0, 0, 0],
    o = t % 1;
  return [i[0] * (1 - o) + n[0] * o, i[1] * (1 - o) + n[1] * o, i[2] * (1 - o) + n[2] * o];
};
n.prototype._tintCoordinatesToColor = function (e, t) {
  var i = this.params.tintWidth / (v.length - 1),
    n = Math.floor(e / i),
    o = v[n],
    a = v[n + 1];
  if (void 0 === o || null === o) {
    return console.error(new Error("CP: topColor is missing with x: " + e + ", y: " + t + ", tintWidth: " + this.params.tintWidth)), [255, 0, 0];
  }
  if (void 0 === a || null === a) {
    return console.error(new Error("CP: topColorNext is missing with x: " + e + ", y: " + t + ", tintWidth: " + this.params.tintWidth)), [255, 0, 0];
  }
  var s = o[0],
    r = a[0],
    l = o[1],
    c = a[1],
    d = o[2],
    u = a[2],
    h = e / i % 1,
    p = s * (1 - h) + r * h,
    m = l * (1 - h) + c * h,
    f = d * (1 - h) + u * h,
    g = t / this.params.tintHeight,
    y = p * (1 - g) + _ * g,
    w = m * (1 - g) + _ * g,
    b = f * (1 - g) + _ * g;
  return [y, w, b];
};
n.prototype._colorToTintAndLum = function (e) {
  var t = this.params.tintWidth,
    i = this.params.tintHeight,
    n = this.params.lumHeight,
    o = n / 2,
    a = Math.min.apply(Math, e),
    s = Math.max.apply(Math, e),
    r = e.indexOf(a),
    l = e.indexOf(s);
  if (r === l) {
    var c = (1 - a / 255) * n - g;
    return [0, i - g, c];
  }
  var d;
  d = 0 !== r && 0 !== l ? 0 : 1 !== r && 1 !== l ? 1 : 2;
  var u,
    h = e[l],
    p = e[d],
    m = e[r],
    f = [[null, 3, 2], [4, null, 5], [1, 0, null]],
    y = f[r][d],
    w = (p - m) / (h - m),
    b = y % 2 ? 1 - w : w,
    M = t / (v.length - 1),
    T = M * (y + b) % t,
    C = (m + h) / 255;
  u = C <= 1 ? 255 * m / _ / (h + m) : (255 * h - 65025) / (_ * (h + m) - 65025);
  var I = u * i,
    A = o + (1 - C) / 2 * n;
  return [T, I, A];
};
n.prototype.setCurrentColor = function (e) {
  var t = this._colorToTintAndLum(e);
  this.cursorMoveTo(t[0], t[1], "tint", !0);
  this.cursorMoveTo(0, t[2], "lum", !0);
};
n.prototype.updateLuminosity = function () {
  for (var e = this.lumCanvas.rootElement, t = e.getContext("2d"), i = t.getImageData(0, 0, e.width, e.height), n = 0; n < this.params.lumHeight; n++) {
    var o = this._lumCoordinatesToColor(n),
      a = 4 * n;
    i.data[a] = Math.round(o[0]);
    i.data[a + 1] = Math.round(o[1]);
    i.data[a + 2] = Math.round(o[2]);
    i.data[a + 3] = 255;
  }
  t.putImageData(i, 0, 0);
};
n.prototype.cursorMoveTo = function (e, t, i, n) {
  this._setPickerPosition(this[i + "Picker"], e, t);
  "tint" === i && (this.currentTint = this._tintCoordinatesToColor(e, t), this.updateLuminosity());
  this.currentColor = this._lumCoordinatesToColor(this.lumPicker.y);
  this.hexSelector.updateValue(this.getCurrentColor().hex.slice(1));
  n || this.emit("newColor", this.getCurrentColor());
};
n.prototype.randomize = function (e, t) {
  var i = this[e + "Canvas"].rootElement,
    n = Math.random() * i.width,
    o = Math.random() * i.height;
  this.cursorMoveTo(n, o, e, t);
};
n.prototype.generateRandomColor = function (e) {
  this.randomize("tint", e);
  this.randomize("lum", e);
};
n.prototype._cursorMove = function (e, t, i) {
  var n = this[i + "Canvas"].rootElement,
    o = "x: " + e.x + ", y: " + e.y + ", panel: " + i;
  o += "width: " + t.width + ", height: " + t.height;
  o += "panelW: " + n.width + ", panelH: " + n.height;
  var a = e.x,
    s = e.y,
    r = n.width / t.width,
    l = n.height / t.height;
  return a = Math.round(a * r), s = Math.round(s * l), a = Math.max(0, Math.min(a, n.width - 1)), s = Math.max(0, Math.min(s, n.height - 1)), isNaN(a) ? void console.error(new Error("posX is nan with " + o)) : isNaN(s) ? void console.error(new Error("posY is nan with " + o)) : void this.cursorMoveTo(a, s, i);
};
n.prototype.fillTint = function () {
  for (var e = this.tintCanvas.rootElement, t = e.getContext("2d"), i = t.getImageData(0, 0, e.width, e.height), n = 0; n < this.params.tintWidth; n++) {
    for (var o = 0; o < this.params.tintHeight; o++) {
      var a = this._tintCoordinatesToColor(n, o),
        s = 4 * (o * this.params.tintWidth + n);
      i.data[s] = Math.round(a[0]);
      i.data[s + 1] = Math.round(a[1]);
      i.data[s + 2] = Math.round(a[2]);
      i.data[s + 3] = 255;
    }
  }
  t.putImageData(i, 0, 0);
};
n.prototype.getCurrentColor = function () {
  var e = this.currentColor,
    t = [Math.round(e[0]), Math.round(e[1]), Math.round(e[2])];
  return {
    rgb: t,
    hex: u.colorArrayToHexa(t)
  };
};
n.prototype._setPickerPosition = function (e, t, i) {
  if (e.setStyle("webkitTransform", "translate3d(" + t + "px," + i + "px,0)"), e.x = t, e.y = i, e === this.lumPicker) {
    var n = i / this.params.lumHeight > .5 ? 1 : 0;
    e.bright.setStyle("opacity", n);
    e.dark.setStyle("opacity", 1 - n);
  }
};
n.prototype.reset = function () {
  this._setPickerPosition(this.tintPicker, 0, 0);
  this.currentTint = this._tintCoordinatesToColor(0, 0);
  this.updateLuminosity();
  this._setPickerPosition(this.lumPicker, 0, this.params.lumHeight / 2);
  this.currentColor = this._lumCoordinatesToColor(this.lumPicker.y);
};
n.prototype.getCursorPosition = function (e) {
  var t = this[e + "Picker"];
  return {
    x: t.x,
    y: t.y
  };
};
n.prototype.openHexInput = function () {
  var e = this.getCurrentColor().hex.slice(1);
  this.hexSelector.open({
    x: 0,
    y: 0,
    defaultValue: e
  });
};
o = o > 0 ? o : this.params.tintWidth;
this.params.tintWidth = o;
this.params.tintHeight = t;
this.tintCanvas.rootElement.width = o;
this.tintCanvas.rootElement.height = t;
this.tintCanvas.setStyles({
  width: o + "px",
  height: t + "px"
});
this.params.lumHeight = this.params.showHexButton ? t - m : t;
this.lumCanvas.rootElement.height = this.params.lumHeight;
this.lumCanvas.setStyles({
  width: this.params.lumWidth + "px",
  height: this.params.lumHeight + "px"
});
this.lumPicker.setStyle("width", this.params.lumWidth + "px");
this.fillTint();
this.updateLuminosity();
this.setCurrentColor(this.currentColor);
this.cursorMoveTo(t[0], t[1], "tint", !0);
this.cursorMoveTo(0, t[2], "lum", !0);
i.data[a] = Math.round(o[0]);
i.data[a + 1] = Math.round(o[1]);
i.data[a + 2] = Math.round(o[2]);
i.data[a + 3] = 255;
this._setPickerPosition(this[i + "Picker"], e, t);
"tint" === i && (this.currentTint = this._tintCoordinatesToColor(e, t), this.updateLuminosity());
this.currentColor = this._lumCoordinatesToColor(this.lumPicker.y);
this.hexSelector.updateValue(this.getCurrentColor().hex.slice(1));
n || this.emit("newColor", this.getCurrentColor());
this.randomize("tint", e);
this.randomize("lum", e);
o += "width: " + t.width + ", height: " + t.height;
o += "panelW: " + n.width + ", panelH: " + n.height;
i.data[s] = Math.round(a[0]);
i.data[s + 1] = Math.round(a[1]);
i.data[s + 2] = Math.round(a[2]);
i.data[s + 3] = 255;
e.bright.setStyle("opacity", n);
e.dark.setStyle("opacity", 1 - n);
this._setPickerPosition(this.tintPicker, 0, 0);
this.currentTint = this._tintCoordinatesToColor(0, 0);
this.updateLuminosity();
this._setPickerPosition(this.lumPicker, 0, this.params.lumHeight / 2);
this.currentColor = this._lumCoordinatesToColor(this.lumPicker.y);
t.closeHex();
t.emit("confirm", t.currentValue);
c.call(this, "div", {
  className: "HexSelector",
  hidden: !0
});
this.close = this.appendChild(new s({
  className: ["simpleButton", "closeBtn"]
}));
this.createChild("div", {
  className: "hexLabel",
  text: "#"
});
this.inputBox = this.appendChild(new r({
  className: "hexInputBox",
  attr: {
    maxlength: 6
  }
}, e));
this.confirm = this.appendChild(new s({
  className: ["simpleButton", "confirmBtn"]
}));
this.currentValue = 0;
this.confirm.on("tap", e);
this.close.on("tap", function () {
  t.closeHex();
});
this.inputBox.on("change", function (e) {
  t.currentValue = e;
});
a(n, c);
e.exports = n;
n.prototype.position = function (e, t) {
  var i = o(this, e, t);
  this.setStyles({
    left: i.x + "px",
    top: i.y + "px"
  });
};
n.prototype.updateValue = function (e) {
  this.currentValue = e;
  this.inputBox.setValue(e);
};
n.prototype.open = function (e) {
  function t() {
    delete i.openTweener;
    i.inputBox.focus();
    i.emit("opened");
  }
  var i = this;
  return e = e || {}, void 0 !== e.placeholder && void 0 === e.defaultValue ? (this.inputBox.setPlaceholder(e.placeholder), this.currentValue = "") : void 0 !== e.defaultValue && (this.currentValue = e.defaultValue), this.inputBox.setValue(this.currentValue), this.show(), e.hasOwnProperty("x") && e.hasOwnProperty("y") && this.position(e.x, e.y), this.setStyles(d), this.openTweener ? (this.openTweener.cancel(), t()) : void (this.openTweener = l.tween(this, u, {
    time: 150,
    delay: 0,
    easing: "ease-out"
  }, t));
};
n.prototype.closeHex = function () {
  function e() {
    delete t.closeTweener;
    t.hide();
    t.emit("closed");
    t.inputBox.blur();
  }
  var t = this;
  return this.closeTweener ? (this.closeTweener.cancel(), e()) : void (this.closeTweener = l.tween(this, d, {
    time: 150,
    delay: 0,
    easing: "ease-out"
  }, e));
};
this.currentValue = e;
this.inputBox.setValue(e);
delete i.openTweener;
i.inputBox.focus();
i.emit("opened");
delete t.closeTweener;
t.hide();
t.emit("closed");
t.inputBox.blur();
u.call(this, {
  className: "AllianceCardWindow",
  positionInfo: {
    top: "c",
    left: "c",
    width: 400,
    height: 380
  }
});
this.once("open", function () {
  this._createDom();
});
this.on("open", function (e) {
  this._setAlliance(e);
});
c(n, u);
n.prototype._createDom = function () {
  var e = this.windowBody.createChild("div", {
    className: "description"
  });
  this.emblem = e.appendChild(new s({
    width: 70,
    height: 70
  }));
  var t = e.createChild("div", {
    className: "labelBox"
  });
  t.createChild("div", {
    className: "label",
    text: l("ui.alliance.tag") + l("ui.common.colon")
  });
  t.createChild("div", {
    className: "label",
    text: l("ui.social.guilds") + l("ui.common.colon")
  });
  t.createChild("div", {
    className: "label",
    text: l("ui.common.members") + l("ui.common.colon")
  });
  t.createChild("div", {
    className: "label",
    text: l("ui.common.creationDate") + l("ui.common.colon")
  });
  var i = e.createChild("div", {
    className: "valueBox"
  });
  this.tag = i.createChild("div", {
    className: "value"
  });
  this.guilds = i.createChild("div", {
    className: "value"
  });
  this.members = i.createChild("div", {
    className: "value"
  });
  this.creationDate = i.createChild("div", {
    className: "value"
  });
  this.prisms = this.windowBody.createChild("div", {
    className: "prisms"
  });
  this.guildList = this.windowBody.appendChild(new d({
    colCount: 3,
    headerContent: ["", l("ui.common.name"), l("ui.common.level")]
  }));
};
n.prototype.display = function (e) {
  this.openState ? (this._setAlliance(e), p.focusWindow("allianceCard")) : p.open("allianceCard", e);
};
n.prototype._setAlliance = function (e) {
  var t = e.infos,
    i = e.guilds;
  this.setTitle(l("ui.common.alliance") + " - " + t.allianceName);
  this.emblem.setValue(t.allianceEmblem, !0);
  this.tag.setText("[" + t.allianceTag + "]");
  this.guilds.setText(i.length);
  var n = new a(1e3 * t.creationDate).getServerDate().toString(!1);
  this.creationDate.setText(n.date);
  this.prisms.setText(l("ui.prism.nbPrisms", e.controlledSubareaIds.length));
  this.guildList.clearContent();
  for (var s = 0, r = 0, c = i.length; r < c; r += 1) {
    var d = i[r];
    s += d.nbMembers;
    this.guildList.addRow(o(d));
  }
  this.members.setText(s);
};
e.exports = n;
t.createChild("div", {
  className: "label",
  text: l("ui.alliance.tag") + l("ui.common.colon")
});
t.createChild("div", {
  className: "label",
  text: l("ui.social.guilds") + l("ui.common.colon")
});
t.createChild("div", {
  className: "label",
  text: l("ui.common.members") + l("ui.common.colon")
});
t.createChild("div", {
  className: "label",
  text: l("ui.common.creationDate") + l("ui.common.colon")
});
this.tag = i.createChild("div", {
  className: "value"
});
this.guilds = i.createChild("div", {
  className: "value"
});
this.members = i.createChild("div", {
  className: "value"
});
this.creationDate = i.createChild("div", {
  className: "value"
});
this.prisms = this.windowBody.createChild("div", {
  className: "prisms"
});
this.guildList = this.windowBody.appendChild(new d({
  colCount: 3,
  headerContent: ["", l("ui.common.name"), l("ui.common.level")]
}));
this.setTitle(l("ui.common.alliance") + " - " + t.allianceName);
this.emblem.setValue(t.allianceEmblem, !0);
this.tag.setText("[" + t.allianceTag + "]");
this.guilds.setText(i.length);
this.creationDate.setText(n.date);
this.prisms.setText(l("ui.prism.nbPrisms", e.controlledSubareaIds.length));
this.guildList.clearContent();
s += d.nbMembers;
this.guildList.addRow(o(d));
p.call(this, {
  className: "GuildCardWindow",
  positionInfo: {
    top: "c",
    left: "c",
    width: 400,
    height: 420
  }
});
this.once("open", function () {
  this._createDom();
});
this.on("open", function (e) {
  this._setGuild(e);
});
d(n, p);
n.prototype._createDom = function () {
  var e = this.windowBody.createChild("div", {
    className: "description"
  });
  this.emblem = e.appendChild(new l({
    width: 70,
    height: 70
  }));
  var t = e.createChild("div", {
    className: "labelBox"
  });
  t.createChild("div", {
    className: "label",
    text: c("ui.common.level") + c("ui.common.colon")
  });
  t.createChild("div", {
    className: "label",
    text: c("ui.guild.right.leader") + c("ui.common.colon")
  });
  t.createChild("div", {
    className: "label",
    text: c("ui.common.members") + c("ui.common.colon")
  });
  t.createChild("div", {
    className: "label",
    text: c("ui.common.creationDate") + c("ui.common.colon")
  });
  var i = this,
    n = e.createChild("div", {
      className: "valueBox"
    });
  this.level = n.createChild("div", {
    className: "value"
  });
  this.leader = n.createChild("div", {
    className: ["value", "link"]
  });
  g(this.leader);
  this.leader.on("tap", function () {
    window.gui.openContextualMenu("player", {
      playerName: i._leaderName,
      playerId: i._leaderId,
      hasGuild: !0,
      guildId: i._guild.guildId
    });
  });
  this.members = n.createChild("div", {
    className: "value"
  });
  this.creationDate = n.createChild("div", {
    className: "value"
  });
  this.perceptors = this.windowBody.createChild("div", {
    className: "perceptors"
  });
  this._publicMsg = new u(this.windowBody, {
    className: "publicMsg"
  });
  this.memberList = this.windowBody.appendChild(new h({
    colCount: 2,
    headerContent: [c("ui.common.name"), c("ui.common.level")]
  }));
  var o = this.windowBody.createChild("div", {
      className: "alliance"
    }),
    r = o.createChild("div", {
      className: "value"
    });
  this.allianceLabel = r.createChild("span");
  this.allianceName = r.createChild("span", {
    className: "link"
  });
  g(r);
  r.on("tap", function () {
    a.openAllianceCard(i._allianceId);
  });
  this.allianceInvite = o.createChild("div", {
    className: "inviteBtn"
  });
  this.allianceInviteTooltip = new m("div");
  s(this.allianceInvite, this.allianceInviteTooltip);
  this.allianceInvite.on("tap", function () {
    window.dofus.sendMessage("AllianceInvitationMessage", {
      targetId: i._leaderId
    });
  });
};
n.prototype.display = function (e) {
  this.openState ? (this._setGuild(e), f.focusWindow("guildCard")) : f.open("guildCard", e);
};
n.prototype._setGuild = function (e) {
  var t = this._guild = e.infos,
    i = e.members;
  this.setTitle(c("ui.common.guild") + " - " + t.guildName);
  this.emblem.setValue(t.guildEmblem, !0);
  this.level.setText(t.guildLevel);
  this.members.setText(t.nbMembers);
  var n = new r(1e3 * e.creationDate).getServerDate().toString(!1);
  this.creationDate.setText(n.date);
  this._leaderId = t.leaderId;
  this._leaderName = i[0].name;
  this.leader.setText(this._leaderName);
  this.perceptors.setText(c("ui.guild.taxcollectorsCurrentlyCollecting", e.nbTaxCollectors, e.nbTaxCollectors));
  this._publicMsg.setText(e.publicMsg);
  this.memberList.clearContent();
  for (var a = 0, s = i.length; a < s; a += 1) {
    this.memberList.addRow(o(i[a], t.guildId));
  }
  var l = e.allianceInfos;
  if (l) {
    this.allianceLabel.setText(c("ui.common.alliance") + c("ui.common.colon"));
    this.allianceName.setText(l.allianceName);
    this._allianceId = l.allianceId;
    this.allianceInvite.hide();
  } else {
    this.allianceLabel.setText(c("ui.alliance.noAllianceForThisGuild"));
    this.allianceName.setText("");
    var d = window.gui.playerData.alliance;
    this.allianceInviteTooltip.setText(c("ui.alliance.inviteLeader", this._leaderName));
    this.allianceInvite.toggleDisplay(d.hasAlliance() && d.isBoss());
  }
};
e.exports = n;
t.createChild("div", {
  className: "label",
  text: c("ui.common.level") + c("ui.common.colon")
});
t.createChild("div", {
  className: "label",
  text: c("ui.guild.right.leader") + c("ui.common.colon")
});
t.createChild("div", {
  className: "label",
  text: c("ui.common.members") + c("ui.common.colon")
});
t.createChild("div", {
  className: "label",
  text: c("ui.common.creationDate") + c("ui.common.colon")
});
this.level = n.createChild("div", {
  className: "value"
});
this.leader = n.createChild("div", {
  className: ["value", "link"]
});
g(this.leader);
this.leader.on("tap", function () {
  window.gui.openContextualMenu("player", {
    playerName: i._leaderName,
    playerId: i._leaderId,
    hasGuild: !0,
    guildId: i._guild.guildId
  });
});
this.members = n.createChild("div", {
  className: "value"
});
this.creationDate = n.createChild("div", {
  className: "value"
});
this.perceptors = this.windowBody.createChild("div", {
  className: "perceptors"
});
this._publicMsg = new u(this.windowBody, {
  className: "publicMsg"
});
this.memberList = this.windowBody.appendChild(new h({
  colCount: 2,
  headerContent: [c("ui.common.name"), c("ui.common.level")]
}));
this.allianceLabel = r.createChild("span");
this.allianceName = r.createChild("span", {
  className: "link"
});
g(r);
r.on("tap", function () {
  a.openAllianceCard(i._allianceId);
});
this.allianceInvite = o.createChild("div", {
  className: "inviteBtn"
});
this.allianceInviteTooltip = new m("div");
s(this.allianceInvite, this.allianceInviteTooltip);
this.allianceInvite.on("tap", function () {
  window.dofus.sendMessage("AllianceInvitationMessage", {
    targetId: i._leaderId
  });
});
this.setTitle(c("ui.common.guild") + " - " + t.guildName);
this.emblem.setValue(t.guildEmblem, !0);
this.level.setText(t.guildLevel);
this.members.setText(t.nbMembers);
this.creationDate.setText(n.date);
this._leaderId = t.leaderId;
this._leaderName = i[0].name;
this.leader.setText(this._leaderName);
this.perceptors.setText(c("ui.guild.taxcollectorsCurrentlyCollecting", e.nbTaxCollectors, e.nbTaxCollectors));
this._publicMsg.setText(e.publicMsg);
this.memberList.clearContent();
this.allianceLabel.setText(c("ui.common.alliance") + c("ui.common.colon"));
this.allianceName.setText(l.allianceName);
this._allianceId = l.allianceId;
this.allianceInvite.hide();
this.allianceLabel.setText(c("ui.alliance.noAllianceForThisGuild"));
this.allianceName.setText("");
this.allianceInviteTooltip.setText(c("ui.alliance.inviteLeader", this._leaderName));
this.allianceInvite.toggleDisplay(d.hasAlliance() && d.isBoss());
t = t || {};
this._text = "";
this._isPartHidden = !1;
this._displayDiv = e.createChild("div", {
  className: ["longTextDisplay", t.className]
});
a(this._displayDiv, o);
this._displayDiv.longText = this;
this._textDiv = this._displayDiv.createChild("div", {
  className: "longTextContent"
});
this._showAllBtn = this._displayDiv.createChild("div", {
  className: "longTextBtn"
});
r(this._displayDiv);
this._displayDiv.on("tap", i);
this._displayDiv.on("longTap", i);
e.exports = n;
n.prototype.setText = function (e) {
  this._text = e;
  this._textDiv.setText(e);
  this.refresh();
};
n.prototype.refresh = function () {
  this._isPartHidden = this._textDiv.rootElement.clientHeight > this._displayDiv.rootElement.clientHeight;
  this._showAllBtn.toggleDisplay(this._isPartHidden);
};
n.prototype._tapHandler = function () {
  if (this._isPartHidden) {
    var e = new l("div", {
      className: "longTextTooltip",
      text: this._text
    });
    s.showClosableNotification(e, this._displayDiv, {
      centerOnTarget: !0
    });
  }
};
this._text = e;
this._textDiv.setText(e);
this.refresh();
this._isPartHidden = this._textDiv.rootElement.clientHeight > this._displayDiv.rootElement.clientHeight;
this._showAllBtn.toggleDisplay(this._isPartHidden);
a.call(this, {
  className: "guildHouseInfoWindow",
  positionInfo: {
    top: "c",
    left: "c",
    width: 450,
    height: 380
  }
});
this.rights = [];
this.rightsText = [s("ui.guildHouse.Right1"), s("ui.guildHouse.Right2"), s("ui.guildHouse.Right4"), s("ui.guildHouse.Right8"), s("ui.guildHouse.Right16"), s("ui.guildHouse.Right32"), s("ui.guildHouse.Right64"), s("ui.guildHouse.Right128"), s("ui.guildHouse.Right256")];
this.setupDom();
this.on("open", this.open);
o(n, a);
e.exports = n;
n.prototype.setupDom = function () {
  this.tabs = this.windowBody.appendChild(new r({
    className: "tabs"
  }));
  var e = {
    colIds: ["content"],
    minRows: 10
  };
  this.rights = this.windowBody.appendChild(new l(e));
  this.skills = this.windowBody.appendChild(new l(e));
  this.tabs.addTab(s("ui.social.guildHouseRights"), this.rights);
  this.tabs.addTab(s("ui.common.abilities"), this.skills);
  this.tabs.openTab(0);
};
n.prototype.open = function (e) {
  var t,
    i = this,
    n = e.guildshareParams,
    o = e.skillListIds;
  for (this.windowTitle.setText(e.houseName), this.tabs.openTab(0), this.rights.clearContent(), this.skills.clearContent(), t = 0; t < d; t++) {
    n >> t & 1 && this.rights.addRow({
      content: this.rightsText[t]
    });
  }
  c.getData("Skills", o, function (e, n) {
    for (e && console.error("Failed to retrieve skills data", e), t = 0; t < n.length; t++) {
      i.skills.addRow([n[t].nameId]);
    }
  });
};
this.rights = this.windowBody.appendChild(new l(e));
this.skills = this.windowBody.appendChild(new l(e));
this.tabs.addTab(s("ui.social.guildHouseRights"), this.rights);
this.tabs.addTab(s("ui.common.abilities"), this.skills);
this.tabs.openTab(0);
this.checkboxes = [];
this.once("open", function () {
  e._setupDom();
  e.setupSockets();
});
this.on("open", function () {
  var t = window.gui.playerData.guild.current;
  t && e.emblemLogo.setValue({
    guild: t
  });
});
e._setupDom();
e.setupSockets();
o(n, a);
e.exports = n;
n.prototype._setupDom = function () {
  var e = this,
    t = this.windowBody.createChild("div", {
      className: ["container", "topContainer"]
    });
  this.emblemLogo = t.appendChild(new d({
    width: 100,
    height: 100
  }));
  var i = t.createChild("div", {
    className: "content"
  });
  this.checkboxes.push(i.appendChild(new l(c("ui.common.guildHouseEnabledForThisHouse"))));
  i.createChild("div", {
    className: "description",
    text: c("ui.common.guildHouseNotice")
  });
  var n = this.windowBody.createChild("div", {
      className: ["container", "bottomContainer"]
    }),
    o = n.appendChild(new u({
      className: "scroller"
    })),
    a = o.content,
    h = this.doorEmblem = a.createChild("div", {
      className: "section"
    });
  h.createChild("div", {
    className: "title",
    text: c("ui.common.guildHouseDisplayEmblemOnDoorTitle") + ":"
  });
  this.checkboxes.push(h.appendChild(new l(c("ui.common.guildHouseDisplayEmblemForGuild"))));
  this.checkboxes.push(h.appendChild(new l(c("ui.common.guildHouseDisplayEmblemForOthers"))));
  h = this.houseAccess = a.createChild("div", {
    className: "section"
  });
  h.createChild("div", {
    className: "title",
    text: c("ui.common.guildHouseHouseAccessTitle") + ":"
  });
  this.checkboxes.push(h.appendChild(new l(c("ui.common.guildHouseAccessHouseAllowGuildmates"))));
  this.checkboxes.push(h.appendChild(new l(c("ui.common.guildHouseAccessHouseDenyOthers"))));
  h = this.chests = a.createChild("div", {
    className: "section"
  });
  h.createChild("div", {
    className: "title",
    text: c("ui.common.guildHouseSafesAccessTitle") + ":"
  });
  this.checkboxes.push(h.appendChild(new l(c("ui.common.guildHouseRight32"))));
  this.checkboxes.push(h.appendChild(new l(c("ui.common.guildHouseRight64"))));
  h = this.miscellaneous = a.createChild("div", {
    className: "section"
  });
  h.createChild("div", {
    className: "title",
    text: c("ui.common.guildHouseOtherTitle") + ":"
  });
  this.checkboxes.push(h.appendChild(new l(c("ui.common.guildHouseAllowTeleport"))));
  this.checkboxes.push(h.appendChild(new l(c("ui.common.guildHouseAllowRespawn"))));
  var p = this.windowBody.createChild("div", {
      className: "buttonContainer"
    }),
    m = p.appendChild(new r(c("ui.common.validation")));
  m.on("tap", function () {
    for (var t = 0, i = 0; i < e.checkboxes.length; i++) {
      e.checkboxes[i].isActivate() && (t += 1 << i);
    }
    var n = e.checkboxes[0].isActivate();
    window.dofus.sendMessage("HouseGuildShareRequestMessage", {
      enable: n,
      rights: t
    });
    s.close(e.id);
  });
  this.checkboxes[0].on("activate", function () {
    e.enableContainers();
  });
  this.checkboxes[0].on("deactivate", function () {
    e.disableContainers();
  });
  o.refresh();
};
n.prototype.updateCheckboxes = function (e) {
  for (var t = 0; t < this.checkboxes.length; t++) {
    e >> t & 1 ? this.checkboxes[t].activate() : this.checkboxes[t].deactivate();
  }
};
n.prototype.enableContainers = function () {
  this.doorEmblem.delClassNames("disabled");
  this.houseAccess.delClassNames("disabled");
  this.chests.delClassNames("disabled");
  this.miscellaneous.delClassNames("disabled");
  for (var e = 0; e < this.checkboxes.length; e++) {
    this.checkboxes[e].enable();
  }
};
n.prototype.disableContainers = function () {
  this.doorEmblem.addClassNames("disabled");
  this.houseAccess.addClassNames("disabled");
  this.chests.addClassNames("disabled");
  this.miscellaneous.addClassNames("disabled");
  for (var e = 1; e < this.checkboxes.length; e++) {
    this.checkboxes[e].disable();
  }
};
n.prototype.setupSockets = function () {
  var e = this;
  window.gui.on("HouseGuildRightsMessage", function (t) {
    e.windowTitle.setText(c("ui.common.houseOwnerName", t.guildInfo.guildName));
    var i = t.guildInfo.guildEmblem;
    e.emblemLogo.setValue(i, !0);
    e.updateCheckboxes(t.rights);
    e.enableContainers();
  });
  window.gui.on("HouseGuildNoneMessage", function () {
    for (var t = 0; t < e.checkboxes.length; t++) {
      e.checkboxes[t].deactivate();
    }
    e.disableContainers();
  });
};
this.checkboxes.push(i.appendChild(new l(c("ui.common.guildHouseEnabledForThisHouse"))));
i.createChild("div", {
  className: "description",
  text: c("ui.common.guildHouseNotice")
});
h.createChild("div", {
  className: "title",
  text: c("ui.common.guildHouseDisplayEmblemOnDoorTitle") + ":"
});
this.checkboxes.push(h.appendChild(new l(c("ui.common.guildHouseDisplayEmblemForGuild"))));
this.checkboxes.push(h.appendChild(new l(c("ui.common.guildHouseDisplayEmblemForOthers"))));
h = this.houseAccess = a.createChild("div", {
  className: "section"
});
h.createChild("div", {
  className: "title",
  text: c("ui.common.guildHouseHouseAccessTitle") + ":"
});
this.checkboxes.push(h.appendChild(new l(c("ui.common.guildHouseAccessHouseAllowGuildmates"))));
this.checkboxes.push(h.appendChild(new l(c("ui.common.guildHouseAccessHouseDenyOthers"))));
h = this.chests = a.createChild("div", {
  className: "section"
});
h.createChild("div", {
  className: "title",
  text: c("ui.common.guildHouseSafesAccessTitle") + ":"
});
this.checkboxes.push(h.appendChild(new l(c("ui.common.guildHouseRight32"))));
this.checkboxes.push(h.appendChild(new l(c("ui.common.guildHouseRight64"))));
h = this.miscellaneous = a.createChild("div", {
  className: "section"
});
h.createChild("div", {
  className: "title",
  text: c("ui.common.guildHouseOtherTitle") + ":"
});
this.checkboxes.push(h.appendChild(new l(c("ui.common.guildHouseAllowTeleport"))));
this.checkboxes.push(h.appendChild(new l(c("ui.common.guildHouseAllowRespawn"))));
m.on("tap", function () {
  for (var t = 0, i = 0; i < e.checkboxes.length; i++) {
    e.checkboxes[i].isActivate() && (t += 1 << i);
  }
  var n = e.checkboxes[0].isActivate();
  window.dofus.sendMessage("HouseGuildShareRequestMessage", {
    enable: n,
    rights: t
  });
  s.close(e.id);
});
this.checkboxes[0].on("activate", function () {
  e.enableContainers();
});
this.checkboxes[0].on("deactivate", function () {
  e.disableContainers();
});
o.refresh();
window.dofus.sendMessage("HouseGuildShareRequestMessage", {
  enable: n,
  rights: t
});
s.close(e.id);
this.doorEmblem.delClassNames("disabled");
this.houseAccess.delClassNames("disabled");
this.chests.delClassNames("disabled");
this.miscellaneous.delClassNames("disabled");
this.doorEmblem.addClassNames("disabled");
this.houseAccess.addClassNames("disabled");
this.chests.addClassNames("disabled");
this.miscellaneous.addClassNames("disabled");
window.gui.on("HouseGuildRightsMessage", function (t) {
  e.windowTitle.setText(c("ui.common.houseOwnerName", t.guildInfo.guildName));
  var i = t.guildInfo.guildEmblem;
  e.emblemLogo.setValue(i, !0);
  e.updateCheckboxes(t.rights);
  e.enableContainers();
});
window.gui.on("HouseGuildNoneMessage", function () {
  for (var t = 0; t < e.checkboxes.length; t++) {
    e.checkboxes[t].deactivate();
  }
  e.disableContainers();
});
e.emblemLogo.setValue(i, !0);
e.updateCheckboxes(t.rights);
e.enableContainers();
t.windowTitle.setText(e.name + " - " + s("ui.common.short.level") + " " + e.level);
t._updateContent(e);
o.call(this, {
  className: "GuildMemberRightsWindow",
  positionInfo: {
    left: "c",
    top: "c",
    width: 450,
    height: 490
  }
});
this.rightCheckboxes = [];
this.rightNames = [{
  right: f.GUILD_RIGHT_BOSS,
  label: s("ui.social.guildRightsAllRights")
}, {
  right: f.GUILD_RIGHT_MANAGE_GUILD_BOOSTS,
  label: s("ui.social.guildRightsBoost")
}, {
  right: f.GUILD_RIGHT_MANAGE_RIGHTS,
  label: s("ui.social.guildRightsRights")
}, {
  right: f.GUILD_RIGHT_INVITE_NEW_MEMBERS,
  label: s("ui.social.guildRightsInvit")
}, {
  right: f.GUILD_RIGHT_BAN_MEMBERS,
  label: s("ui.social.guildRightsBann")
}, {
  right: f.GUILD_RIGHT_MANAGE_XP_CONTRIBUTION,
  label: s("ui.social.guildRightsPercentXP")
}, {
  right: f.GUILD_RIGHT_MANAGE_MY_XP_CONTRIBUTION,
  label: s("ui.social.guildRightManageOwnXP")
}, {
  right: f.GUILD_RIGHT_MANAGE_RANKS,
  label: s("ui.social.guildRightsRank")
}, {
  right: f.GUILD_RIGHT_DEFENSE_PRIORITY,
  label: s("ui.social.guildRightsPrioritizeMe")
}, {
  right: f.GUILD_RIGHT_HIRE_TAX_COLLECTOR,
  label: s("ui.social.guildRightsHiretax")
}, {
  right: f.GUILD_RIGHT_COLLECT,
  label: s("ui.social.guildRightsCollect")
}, {
  right: f.GUILD_RIGHT_COLLECT_MY_TAX_COLLECTOR,
  label: s("ui.social.guildRightsCollectMy")
}, {
  right: f.GUILD_RIGHT_USE_PADDOCKS,
  label: s("ui.social.guildRightsMountParkUse")
}, {
  right: f.GUILD_RIGHT_ORGANIZE_PADDOCKS,
  label: s("ui.social.guildRightsMountParkArrange")
}, {
  right: f.GUILD_RIGHT_TAKE_OTHERS_MOUNTS_IN_PADDOCKS,
  label: s("ui.social.guildRightsManageOtherMount")
}, {
  right: f.GUILD_RIGHT_SET_ALLIANCE_PRISM,
  label: s("ui.social.guildRightsSetAlliancePrism")
}, {
  right: f.GUILD_RIGHT_TALK_IN_ALLIANCE_CHAN,
  label: s("ui.social.guildRightsTalkInAllianceChannel")
}];
this.minXpGivenPercentage = 0;
this.maxXpGivenPercentage = 90;
this.once("open", function (i) {
  var n = [],
    o = window.gui.databases.RankNames;
  for (var a in o) {
    n.push(o[a]);
  }
  u.sortObjectInArray(n, "order");
  t.rankNames = n;
  t._setupDom();
  e(i);
  this.on("open", e);
});
u.sortObjectInArray(n, "order");
t.rankNames = n;
t._setupDom();
e(i);
this.on("open", e);
a(n, o);
e.exports = n;
n.prototype._updateContent = function (e) {
  var t = this.selector;
  if (t) {
    var i = this.rank,
      n = window.gui.playerData,
      o = n.guild,
      a = e.id === n.id,
      s = e.id === o.current.leaderId,
      l = n.id === o.current.leaderId,
      c = !a && !s;
    this.memberInfo = {
      memberId: e.id,
      experienceGivenPercent: e.experienceGivenPercent,
      name: e.name,
      rank: e.rank
    };
    t.toggleOption(0, l);
    t.setValue(e.rank);
    var d,
      u = [];
    for (d = 0; d < this.rankNames.length; d++) {
      var h = r(this.rankNames[d].nameId, e.sex ? 1 : 0);
      u.push(h);
    }
    t.changeTexts(u);
    i.setText(r(window.gui.databases.RankNames[e.rank].nameId, e.sex ? 1 : 0));
    this.xpContributionLabel.setText(e.experienceGivenPercent + "%");
    var p,
      m = o.checkRight(f.GUILD_RIGHT_BOSS, e.rights),
      g = o.hasRight(f.GUILD_RIGHT_MANAGE_RIGHTS);
    for (d = 0; d < this.rightNames.length; d++) {
      var _ = this.rightNames[d].right;
      p = this.rightCheckboxes[d];
      p && (s || m || o.checkRight(_, e.rights) ? p.activate() : p.deactivate(), p.disable(), (_ !== f.GUILD_RIGHT_MANAGE_RIGHTS || l) && (l || g && c && o.hasRight(_)) && p.enable());
    }
    if (this.setXpButton.disable(), (o.hasRight(f.GUILD_RIGHT_MANAGE_XP_CONTRIBUTION) || o.hasRight(f.GUILD_RIGHT_MANAGE_MY_XP_CONTRIBUTION)) && this.setXpButton.enable(), !s && o.hasRight(f.GUILD_RIGHT_MANAGE_RANKS) || m) {
      return t.show(), i.hide(), void this.rankTitleText.delClassNames("noMargin");
    }
    t.hide();
    i.show();
    this.rankTitleText.addClassNames("noMargin");
  }
};
n.prototype._setupDom = function () {
  var e,
    t,
    i = this,
    n = this.windowBody.createChild("div", {
      className: "upperPanel"
    }),
    o = n.createChild("div", {
      className: "container"
    });
  this.rankTitleText = o.createChild("div", {
    className: "text",
    text: s("ui.social.guildRank")
  });
  this.rank = o.createChild("div", {
    className: "rank"
  });
  this.selector = o.appendChild(new d());
  var a = this.rankNames;
  for (e = 0, t = a.length; e < t; e += 1) {
    this.selector.addOption(a[e].nameId, a[e].id);
  }
  this.selector.on("change", function (e, t) {
    return 1 === parseInt(e, 10) ? window.gui.openConfirmPopup({
      title: s("ui.popup.warning"),
      message: s("ui.social.doUGiveRights", i.memberInfo.name),
      cb: function (n) {
        return n ? void (i.memberInfo.rank = e) : void i.selector.setValue(t);
      }
    }) : void (i.memberInfo.rank = e);
  });
  var r = n.createChild("div", {
    className: ["container", "XpToGuild"]
  });
  r.createChild("div", {
    className: "text",
    text: s("ui.social.percentXpFull")
  });
  this.setXpButton = r.appendChild(new l("", {
    className: "setXpButton"
  }));
  var u = r.appendChild(new p());
  u.on("confirm", function (e) {
    i.xpContributionLabel.setText(e + "%");
    i.memberInfo.experienceGivenPercent = e;
  });
  this.setXpButton.on("tap", function () {
    u.open({
      min: i.minXpGivenPercentage,
      max: i.maxXpGivenPercentage,
      defaultValue: parseInt(i.xpContributionLabel.getText(), 10)
    });
  });
  this.xpContributionLabel = r.createChild("div", {
    className: "xpLabel",
    text: "0%"
  });
  for (var f = this.windowBody.appendChild(new h({
      colIds: ["name", "checkbox"]
    })), g = 0; g < this.rightNames.length; g++) {
    var _ = this.rightNames[g],
      v = new c("");
    this.rightCheckboxes.push(v);
    f.addRow({
      name: _.label,
      checkbox: v
    });
  }
  var y = this.windowBody.createChild("div", {
      className: "buttonContainer"
    }),
    w = y.appendChild(new l(s("ui.common.validation")));
  w.on("tap", function () {
    i.memberInfo.rights = i.getRightsMask();
    window.dofus.sendMessage("GuildChangeMemberParametersMessage", i.memberInfo);
    m.close(i.id);
  });
  this.on("close", function () {
    u.hide();
  });
};
n.prototype.getRightsMask = function () {
  for (var e = 0, t = 0; t < this.rightNames.length; t++) {
    var i = this.rightCheckboxes[t];
    i && i.isActivate() && (e += this.rightNames[t].right);
  }
  return e;
};
this.memberInfo = {
  memberId: e.id,
  experienceGivenPercent: e.experienceGivenPercent,
  name: e.name,
  rank: e.rank
};
t.toggleOption(0, l);
t.setValue(e.rank);
t.changeTexts(u);
i.setText(r(window.gui.databases.RankNames[e.rank].nameId, e.sex ? 1 : 0));
this.xpContributionLabel.setText(e.experienceGivenPercent + "%");
p = this.rightCheckboxes[d];
p && (s || m || o.checkRight(_, e.rights) ? p.activate() : p.deactivate(), p.disable(), (_ !== f.GUILD_RIGHT_MANAGE_RIGHTS || l) && (l || g && c && o.hasRight(_)) && p.enable());
t.hide();
i.show();
this.rankTitleText.addClassNames("noMargin");
this.rankTitleText = o.createChild("div", {
  className: "text",
  text: s("ui.social.guildRank")
});
this.rank = o.createChild("div", {
  className: "rank"
});
this.selector = o.appendChild(new d());
r.createChild("div", {
  className: "text",
  text: s("ui.social.percentXpFull")
});
this.setXpButton = r.appendChild(new l("", {
  className: "setXpButton"
}));
u.on("confirm", function (e) {
  i.xpContributionLabel.setText(e + "%");
  i.memberInfo.experienceGivenPercent = e;
});
this.setXpButton.on("tap", function () {
  u.open({
    min: i.minXpGivenPercentage,
    max: i.maxXpGivenPercentage,
    defaultValue: parseInt(i.xpContributionLabel.getText(), 10)
  });
});
this.xpContributionLabel = r.createChild("div", {
  className: "xpLabel",
  text: "0%"
});
i.xpContributionLabel.setText(e + "%");
i.memberInfo.experienceGivenPercent = e;
this.rightCheckboxes.push(v);
f.addRow({
  name: _.label,
  checkbox: v
});
w.on("tap", function () {
  i.memberInfo.rights = i.getRightsMask();
  window.dofus.sendMessage("GuildChangeMemberParametersMessage", i.memberInfo);
  m.close(i.id);
});
this.on("close", function () {
  u.hide();
});
i.memberInfo.rights = i.getRightsMask();
window.dofus.sendMessage("GuildChangeMemberParametersMessage", i.memberInfo);
m.close(i.id);
this.currency = g;
this.once("open", function () {
  var t = this.windowBody.createChild("div", {
      className: "container"
    }),
    i = t.createChild("div", {
      className: "imageContainer"
    });
  e.image = i.createChild("div", {
    className: "image"
  });
  e.image.setStyle("backgroundImage", e.imageUrl);
  e.title = t.createChild("div", {
    className: ["text", "title"],
    text: e.titleText
  });
  e.description = t.createChild("div", {
    className: ["text", "description"],
    text: e.descriptionText
  });
  var n = this.windowBody.createChild("div", {
    className: "priceContainer"
  });
  n.createChild("div", {
    className: "priceText",
    text: d("ui.common.price") + d("ui.common.colon")
  });
  e.price = n.appendChild(new r({
    title: d("ui.common.price")
  }));
  e.price.hide();
  e.price.on("change", function (t) {
    e.proposedPrice = t;
  });
  e.priceTextOnly = n.createChild("div", {
    className: "priceText"
  });
  e.priceTextOnly.hide();
  e.currencyIcon = n.createChild("div", {
    className: ["currencyIcon", "soft"]
  });
  var o = this.windowBody.createChild("div", {
    className: "footer"
  });
  e.cancelSaleButton = o.appendChild(new s(d("ui.common.cancelTheSale"), {
    className: "cancelSaleButton"
  }));
  e.confirmButton = o.appendChild(new s(d("ui.common.validation"), {
    className: "confirmButton"
  }));
  e.switchButton = o.appendChild(new p());
  e.switchButton.on("switchToHard", function () {
    e._setCurrency(_);
    e.updateDisplay(e.houseInfo);
  });
  e.switchButton.on("switchToSoft", function () {
    e._setCurrency(g);
    e.updateDisplay(e.houseInfo);
  });
  e.cancelSaleButton.on("tap", function () {
    if (!e.houseInfo || !e.houseInfo.buyOrSell) {
      return e.fromInside ? (window.dofus.sendMessage("HouseSellFromInsideRequestMessage", {
        amount: 0
      }), void l.close(e.id)) : void window.dofus.sendMessage("HouseSellRequestMessage", {
        amount: 0
      });
    }
  });
  e.confirmButton.on("tap", function () {
    if (e.houseInfo && e.houseInfo.buyOrSell) {
      var t;
      return t = e.currency === _ ? d("tablet.price.hard", e.priceTextOnly.getText()) : d("tablet.price.soft", e.priceTextOnly.getText()), window.gui.openConfirmPopup({
        title: d("ui.common.housePurchase"),
        message: d("tablet.ui.common.doUBuyHouse", e.houseOwner, t),
        cb: function (t) {
          if (t) {
            if (e.currency === g) {
              return window.dofus.sendMessage("HouseBuyRequestMessage", {
                proposedPrice: e.proposedPrice
              });
            }
            var i = e.proposedPriceHard - window.gui.playerData.inventory.goultines;
            return i > 0 ? f.openNotEnoughHardCurrencyPopup(i) : window.dofus.send("houseBuyRequest", {
              houseId: e.houseInfo.purchasableId,
              amountHard: e.proposedPriceHard,
              amountSoft: e.proposedPrice
            });
          }
        }
      }, {
        isModal: !0
      });
    }
    return e.fromInside ? (window.dofus.sendMessage("HouseSellFromInsideRequestMessage", {
      amount: e.proposedPrice
    }), void l.close(e.id)) : void window.dofus.sendMessage("HouseSellRequestMessage", {
      amount: e.proposedPrice
    });
  });
});
this.on("open", function (t) {
  return t = t || {}, e.fromInside = t.fromInside, e.switchButton.setCurrency(g), e.fromInside ? void e.fromInsideUpdateDisplay(t.myHouse) : void e.updateDisplay(t.msg);
});
this.setupSocketEvents();
e.image = i.createChild("div", {
  className: "image"
});
e.image.setStyle("backgroundImage", e.imageUrl);
e.title = t.createChild("div", {
  className: ["text", "title"],
  text: e.titleText
});
e.description = t.createChild("div", {
  className: ["text", "description"],
  text: e.descriptionText
});
n.createChild("div", {
  className: "priceText",
  text: d("ui.common.price") + d("ui.common.colon")
});
e.price = n.appendChild(new r({
  title: d("ui.common.price")
}));
e.price.hide();
e.price.on("change", function (t) {
  e.proposedPrice = t;
});
e.priceTextOnly = n.createChild("div", {
  className: "priceText"
});
e.priceTextOnly.hide();
e.currencyIcon = n.createChild("div", {
  className: ["currencyIcon", "soft"]
});
e.cancelSaleButton = o.appendChild(new s(d("ui.common.cancelTheSale"), {
  className: "cancelSaleButton"
}));
e.confirmButton = o.appendChild(new s(d("ui.common.validation"), {
  className: "confirmButton"
}));
e.switchButton = o.appendChild(new p());
e.switchButton.on("switchToHard", function () {
  e._setCurrency(_);
  e.updateDisplay(e.houseInfo);
});
e.switchButton.on("switchToSoft", function () {
  e._setCurrency(g);
  e.updateDisplay(e.houseInfo);
});
e.cancelSaleButton.on("tap", function () {
  if (!e.houseInfo || !e.houseInfo.buyOrSell) {
    return e.fromInside ? (window.dofus.sendMessage("HouseSellFromInsideRequestMessage", {
      amount: 0
    }), void l.close(e.id)) : void window.dofus.sendMessage("HouseSellRequestMessage", {
      amount: 0
    });
  }
});
e.confirmButton.on("tap", function () {
  if (e.houseInfo && e.houseInfo.buyOrSell) {
    var t;
    return t = e.currency === _ ? d("tablet.price.hard", e.priceTextOnly.getText()) : d("tablet.price.soft", e.priceTextOnly.getText()), window.gui.openConfirmPopup({
      title: d("ui.common.housePurchase"),
      message: d("tablet.ui.common.doUBuyHouse", e.houseOwner, t),
      cb: function (t) {
        if (t) {
          if (e.currency === g) {
            return window.dofus.sendMessage("HouseBuyRequestMessage", {
              proposedPrice: e.proposedPrice
            });
          }
          var i = e.proposedPriceHard - window.gui.playerData.inventory.goultines;
          return i > 0 ? f.openNotEnoughHardCurrencyPopup(i) : window.dofus.send("houseBuyRequest", {
            houseId: e.houseInfo.purchasableId,
            amountHard: e.proposedPriceHard,
            amountSoft: e.proposedPrice
          });
        }
      }
    }, {
      isModal: !0
    });
  }
  return e.fromInside ? (window.dofus.sendMessage("HouseSellFromInsideRequestMessage", {
    amount: e.proposedPrice
  }), void l.close(e.id)) : void window.dofus.sendMessage("HouseSellRequestMessage", {
    amount: e.proposedPrice
  });
});
e._setCurrency(_);
e.updateDisplay(e.houseInfo);
e._setCurrency(g);
e.updateDisplay(e.houseInfo);
o(n, a);
e.exports = n;
n.prototype.setupSocketEvents = function () {
  var e = this,
    t = window.gui,
    i = window.dofus.connectionManager;
  t.on("PurchasableDialogMessage", function (t) {
    l.openDialog(e.id, {
      fromInside: !1,
      msg: t
    });
  });
  t.on("HouseBuyResultMessage", function (i) {
    i.bought ? t.openPopup({
      title: d("ui.popup.information"),
      message: d("ui.common.houseBuy", e.houseOwner, c.kamasToString(i.realPrice, ""))
    }) : t.openPopup({
      title: d("ui.popup.information"),
      message: d("ui.common.cantBuyHouse", c.kamasToString(i.realPrice, ""))
    });
  });
  t.on("HouseSoldMessage", function (e) {
    if (t.playerData.identification.uniqueNickname.toString() === e.buyerName) {
      var i = d("ui.house.homeOf", t.playerData.identification.uniqueNickname.getForDisplay());
      0 === e.realPrice ? t.openPopup({
        title: d("ui.popup.information"),
        message: d("ui.common.houseNosell", "'" + i + "'")
      }) : t.openPopup({
        title: d("ui.popup.information"),
        message: d("ui.common.houseSell", "'" + i + "'", c.kamasToString(e.realPrice, ""))
      });
    }
  });
  m.on("computedHardPricesChange", function () {
    e.currency === _ && e.updateDisplay(e.houseInfo);
  });
  i.on("houseBuyError", function () {
    this.send("moneyGoultinesAmountRequest");
  });
  i.on("houseBuySuccess", function () {
    this.send("moneyGoultinesAmountRequest");
  });
};
n.prototype._setCurrency = function (e) {
  if (this.currency !== e) {
    var t = this.currency;
    this.currency = e;
    this.currencyIcon && this.currencyIcon.replaceClassNames([t], [e]);
  }
};
n.prototype.prepareDialog = function (e, t, i) {
  var n = this;
  u.getData("Houses", e, function (o, a) {
    return o || !a ? console.warn("Houses Id: " + e + " not found!", o) : void h.preloadImage("gfx/houses/" + a.gfxId + ".png", function (e) {
      n.houseOwner = "?" === t ? d("ui.common.houseWithNoOwner") : d("ui.house.homeOf", i);
      var o = a.nameId;
      return n.image ? (delete n.imageUrl, delete n.titleText, delete n.descriptionText, n.image.setStyle("backgroundImage", e), n.title.setText(n.houseOwner), void n.description.setText(o)) : (n.imageUrl = e, n.titleText = n.houseOwner, void (n.descriptionText = o));
    });
  });
};
n.prototype.updateDisplay = function (e) {
  if (!e) {
    return console.warn("Missing purchaseMsg from PurchasableDialogMessage.");
  }
  this.proposedPrice = e.price;
  this.proposedPriceHard = m.computeHardPrice(e.price);
  this.houseInfo = e;
  var t = this.currency === _,
    i = t ? this.proposedPriceHard : e.price;
  if (this.priceTextOnly.toggleDisplay(e.buyOrSell), this.price.toggleDisplay(!e.buyOrSell), e.buyOrSell) {
    this.windowTitle.setText(d("ui.common.housePurchase"));
    this.cancelSaleButton.disable();
    var n = window.gui.playerData.inventory,
      o = t || i && i <= n.kamas;
    o ? this.confirmButton.enable() : this.confirmButton.disable();
  } else {
    this.windowTitle.setText(d("ui.common.houseSale"));
    this.cancelSaleButton.enable();
    this.confirmButton.enable();
  }
  return this.switchButton.toggleDisplay(e.buyOrSell && !window.gui.playerData.isShopDisabled()), i ? void (e.buyOrSell ? this.priceTextOnly.setText(c.kamasToString(i, "")) : this.price.setValue(c.kamasToString(i, ""))) : e.buyOrSell ? this.priceTextOnly.setText(d("ui.item.averageprice.unavailable")) : this.price.setValue(d("ui.item.averageprice.unavailable"));
};
n.prototype.fromInsideUpdateDisplay = function (e) {
  var t = this;
  return this.switchButton.hide(), this.confirmButton.enable(), e ? (this.priceTextOnly.hide(), this.price.show(), this.windowTitle.setText(d("ui.common.houseSale")), e.price ? (this.cancelSaleButton.enable(), this.proposedPrice = e.price, void this.price.setValue(c.kamasToString(e.price, ""))) : (this.cancelSaleButton.disable(), void u.getData("Houses", e.modelId, function (i, n) {
    return i || !n ? console.warn("Houses Id: " + e.modelId + " not found!", i) : (t.proposedPrice = n.defaultPrice, void t.price.setValue(c.kamasToString(t.proposedPrice, "")));
  }))) : console.warn("Missing current house info.");
};
t.on("PurchasableDialogMessage", function (t) {
  l.openDialog(e.id, {
    fromInside: !1,
    msg: t
  });
});
t.on("HouseBuyResultMessage", function (i) {
  i.bought ? t.openPopup({
    title: d("ui.popup.information"),
    message: d("ui.common.houseBuy", e.houseOwner, c.kamasToString(i.realPrice, ""))
  }) : t.openPopup({
    title: d("ui.popup.information"),
    message: d("ui.common.cantBuyHouse", c.kamasToString(i.realPrice, ""))
  });
});
t.on("HouseSoldMessage", function (e) {
  if (t.playerData.identification.uniqueNickname.toString() === e.buyerName) {
    var i = d("ui.house.homeOf", t.playerData.identification.uniqueNickname.getForDisplay());
    0 === e.realPrice ? t.openPopup({
      title: d("ui.popup.information"),
      message: d("ui.common.houseNosell", "'" + i + "'")
    }) : t.openPopup({
      title: d("ui.popup.information"),
      message: d("ui.common.houseSell", "'" + i + "'", c.kamasToString(e.realPrice, ""))
    });
  }
});
m.on("computedHardPricesChange", function () {
  e.currency === _ && e.updateDisplay(e.houseInfo);
});
i.on("houseBuyError", function () {
  this.send("moneyGoultinesAmountRequest");
});
i.on("houseBuySuccess", function () {
  this.send("moneyGoultinesAmountRequest");
});
this.currency = e;
this.currencyIcon && this.currencyIcon.replaceClassNames([t], [e]);
this.proposedPrice = e.price;
this.proposedPriceHard = m.computeHardPrice(e.price);
this.houseInfo = e;
this.windowTitle.setText(d("ui.common.housePurchase"));
this.cancelSaleButton.disable();
this.windowTitle.setText(d("ui.common.houseSale"));
this.cancelSaleButton.enable();
this.confirmButton.enable();
e = e || {};
this.currency = s;
a.call(this, e, function () {
  t.toggleCurrency();
});
this.addClassNames("button", "SwitchCurrencyButton", s);
o(n, a);
e.exports = n;
n.prototype.toggleCurrency = function () {
  this.setCurrency(this.currency === s ? r : s);
};
n.prototype.setCurrency = function (e) {
  if (this.currency !== e) {
    var t = this.currency;
    return this.currency = e, this.replaceClassNames([t], [this.currency]), this.currency === r ? this.emit("switchToHard") : this.emit("switchToSoft");
  }
};
s.delClassNames("spinner");
s.confirmButton.enable();
s.selectedSlot && (s.selectedSlot.unselect(), delete s.selectedSlot);
this.itemSlots = [];
this.selectedSlot = null;
this.itemInstance = null;
this.once("open", function () {
  this.itemSlotsBox = this.windowBody.createChild("div", {
    className: "itemSlotsBox"
  });
  for (var i = 0; i < h; i += 1) {
    var l = this.itemSlotsBox.appendChild(new r());
    l.on("tap", n);
    s.itemSlots.push(l);
  }
  this.confirmButton = this.windowBody.appendChild(new o(a("ui.common.validation")));
  this.confirmButton.on("tap", t);
  window.gui.playerData.inventory.on("itemModified", function (t) {
    s.itemInstance && t.objectUID === s.itemInstance.objectUID && e();
  });
});
this.on("open", function (e) {
  return e.itemInstance && e.itemInstance.livingObjectCategory ? void this._displayItem(e.itemInstance) : console.error("Must provide a living object or living object associated itemInstance");
});
this.on("close", function () {
  i();
});
l.on("tap", n);
s.itemSlots.push(l);
this.confirmButton = this.windowBody.appendChild(new o(a("ui.common.validation")));
this.confirmButton.on("tap", t);
window.gui.playerData.inventory.on("itemModified", function (t) {
  s.itemInstance && t.objectUID === s.itemInstance.objectUID && e();
});
s(n, c);
e.exports = n;
n.prototype._displayItem = function (e) {
  this.itemInstance = e;
  var t = this;
  this.addClassNames("spinner");
  this.confirmButton.disable();
  t.itemSlots[e.livingObjectSkin - 1].emit("tap");
  var i = e.livingObjectId || e.objectGID;
  l.getData("LivingObjectSkinJntMood", i, function (i, n) {
    if (i) {
      return console.error(i);
    }
    var o,
      a = [];
    for (o = 0; o < n.moods[e.livingObjectMood].length; o += 1) {
      var s = n.moods[e.livingObjectMood][o];
      a.push("gfx/items/" + s + ".png");
    }
    u.preloadImages(a, function (e) {
      for (var i = 0; i < t.itemSlots.length; i += 1) {
        var n = t.itemSlots[i];
        i >= t.itemInstance.livingObjectLevel ? n.unset() : n.setImage(e[i]);
      }
      t.delClassNames("spinner");
      t.confirmButton.enable();
    });
  });
};
this.addClassNames("spinner");
this.confirmButton.disable();
t.itemSlots[e.livingObjectSkin - 1].emit("tap");
t.delClassNames("spinner");
t.confirmButton.enable();
this._itemBox = null;
this._domCreated = !1;
this.on("open", function (a) {
  a = a || {};
  n._domCreated || n._createDom();
  var s = a.itemData,
    r = a.objectUID,
    l = a.objectGID,
    c = a.objectItem,
    d = a.options || {};
  return n.setTitle(""), n._itemBox.hide(), n.windowBody.addClassNames("spinner"), !s && r && (s = o.playerData.inventory.objects[r]), !s && c ? i(c, d) : void (s ? e(s, d) : l ? t(l, d) : console.error("ItemBoxWindow need itemData or objectUID or objectGID"));
});
this.on("close", function () {
  n._itemBox.hide();
  n.windowBody.delClassNames("spinner");
});
a = a || {};
n._domCreated || n._createDom();
n._itemBox.hide();
n.windowBody.delClassNames("spinner");
o(n, a);
e.exports = n;
n.prototype._createDom = function () {
  var e = this.windowBody;
  this._itemBox = e.appendChild(new s({
    showItemActions: !0
  }));
  this._itemBox.hide();
  this._domCreated = !0;
};
this._itemBox = e.appendChild(new s({
  showItemActions: !0
}));
this._itemBox.hide();
this._domCreated = !0;
n.lastLivingObjectId = n.itemInstance.livingObjectId;
window.dofus.sendMessage("LivingObjectDissociateMessage", {
  livingUID: n.itemInstance.objectUID,
  livingPosition: n.itemInstance.position
});
this.itemInstance = null;
this.lastLivingObjectId = "";
this.once("open", function () {
  var r = this.windowBody.createChild("div", {
    className: "topRow"
  });
  this.itemSlot = r.appendChild(new l());
  var d = r.createChild("div", {
    className: "buttons"
  });
  this.feedButton = d.appendChild(new a(s("ui.item.feed")));
  this.feedButton.on("tap", e);
  this.dissociateButton = d.appendChild(new a(s("ui.item.dissociate")));
  this.dissociateButton.on("tap", t);
  this.appearanceButton = d.appendChild(new a(s("ui.item.skin")));
  this.appearanceButton.on("tap", i);
  var u = this.windowBody.createChild("div", {
      className: "botRow"
    }),
    p = u.createChild("div", {
      className: "statsBox"
    });
  p.createChild("div", {
    className: "label",
    text: s("ui.common.state") + s("ui.common.colon")
  });
  this.moodBox = p.createChild("div", {
    className: "value"
  });
  this.lastFedBox = p.createChild("div", {
    className: ["label", "lastFedBox"]
  });
  var m = s("ui.common.level") + s("ui.common.colon");
  p.createChild("div", {
    className: "label",
    text: m
  });
  this.levelBox = p.createChild("div", {
    className: "value"
  });
  m = s("ui.common.experiment") + s("ui.common.colon");
  p.createChild("div", {
    className: "label",
    text: m
  });
  this.expBar = p.appendChild(new c());
  this.expBar.addClassNames("expBar", "blue", "value");
  this.expTooltip = new h("div", {
    className: "expTooltip"
  });
  o(this.expBar, this.expTooltip);
  window.gui.playerData.inventory.on("itemAdded", function (e) {
    if (e.objectGID === n.lastLivingObjectId) {
      var t = window.gui.playerData.inventory.objects[e.objectUID];
      n._displayItem(t);
    }
  });
  window.gui.playerData.inventory.on("itemModified", function (e) {
    e && n.itemInstance && (e.livingObjectId && e.livingObjectId === n.itemInstance.objectGID ? n._displayItem(e) : e.objectUID === n.itemInstance.objectUID && n._displayItem(e));
  });
});
this.on("open", function (e) {
  return e.itemInstance && e.itemInstance.livingObjectCategory ? void this._displayItem(e.itemInstance) : console.error("Must provide a living object or living object associated itemInstance");
});
this.feedButton = d.appendChild(new a(s("ui.item.feed")));
this.feedButton.on("tap", e);
this.dissociateButton = d.appendChild(new a(s("ui.item.dissociate")));
this.dissociateButton.on("tap", t);
this.appearanceButton = d.appendChild(new a(s("ui.item.skin")));
this.appearanceButton.on("tap", i);
p.createChild("div", {
  className: "label",
  text: s("ui.common.state") + s("ui.common.colon")
});
this.moodBox = p.createChild("div", {
  className: "value"
});
this.lastFedBox = p.createChild("div", {
  className: ["label", "lastFedBox"]
});
p.createChild("div", {
  className: "label",
  text: m
});
this.levelBox = p.createChild("div", {
  className: "value"
});
m = s("ui.common.experiment") + s("ui.common.colon");
p.createChild("div", {
  className: "label",
  text: m
});
this.expBar = p.appendChild(new c());
this.expBar.addClassNames("expBar", "blue", "value");
this.expTooltip = new h("div", {
  className: "expTooltip"
});
o(this.expBar, this.expTooltip);
window.gui.playerData.inventory.on("itemAdded", function (e) {
  if (e.objectGID === n.lastLivingObjectId) {
    var t = window.gui.playerData.inventory.objects[e.objectUID];
    n._displayItem(t);
  }
});
window.gui.playerData.inventory.on("itemModified", function (e) {
  e && n.itemInstance && (e.livingObjectId && e.livingObjectId === n.itemInstance.objectGID ? n._displayItem(e) : e.objectUID === n.itemInstance.objectUID && n._displayItem(e));
});
r(n, d);
e.exports = n;
n.prototype._updateMood = function (e) {
  var t;
  switch (e.livingObjectMood) {
    case p.MOOD_LEAN:
      t = s("ui.common.lean");
      break;
    case p.MOOD_SATISFIED:
      t = s("ui.common.satisfied");
      break;
    case p.MOOD_FAT:
      t = s("ui.common.fat");
  }
  this.moodBox.setText(t);
};
n.prototype._updateLastFed = function (e) {
  this.lastFedBox.setText(e.livingObjectFoodDate);
};
n.prototype._updateExp = function (e) {
  this.levelBox.setText(e.livingObjectLevel);
  var t = e.livingObjectXp,
    i = e.livingObjectMaxXp;
  this.expBar.setValue(0 !== i ? t / i : 1);
  this.expTooltip.setText(t + " / " + i);
};
n.prototype._displayItem = function (e) {
  this.itemInstance = e;
  this.itemSlot.setItem(e);
  this.itemSlot.setQuantity(1);
  e.livingObjectId && e.objectGID ? (this.feedButton.enable(), this.dissociateButton.enable()) : (this.feedButton.disable(), this.dissociateButton.disable());
  this._updateMood(e);
  this._updateLastFed(e);
  this._updateExp(e);
};
this.expBar.setValue(0 !== i ? t / i : 1);
this.expTooltip.setText(t + " / " + i);
this.itemInstance = e;
this.itemSlot.setItem(e);
this.itemSlot.setQuantity(1);
e.livingObjectId && e.objectGID ? (this.feedButton.enable(), this.dissociateButton.enable()) : (this.feedButton.disable(), this.dissociateButton.disable());
this._updateMood(e);
this._updateLastFed(e);
this._updateExp(e);
f.call(this, {
  className: "ItemRecipesWindow",
  positionInfo: {
    left: "c",
    top: "c",
    width: 800,
    height: 525
  }
});
this.dbItemId = null;
this.itemBox = null;
this.itemHistory = [];
this._isReloading = !1;
this.on("open", this._onOpen);
this.on("close", this._onClose);
c(n, f);
e.exports = n;
n.prototype._onOpen = function (e) {
  this.itemBox || this._createContent();
  var t = e.itemData && e.itemData.item ? e.itemData.item : e.itemData;
  this._displayNextItem(t);
};
n.prototype._onClose = function () {
  this.dbItemId = null;
  this.itemHistory = [];
  this.windowBody.clearContent();
  this.itemBox = null;
  this.itemRecipeBox = null;
  this.recipeList = null;
  this.windowHeadWrapper.removeChild(this.backButton);
  this.backButton = null;
};
n.prototype._displayNextItem = function (e) {
  e.id !== this.dbItemId && (this.itemHistory.push(e.id), this._displayItem(e));
};
n.prototype._createContent = function () {
  var e = this.windowBody.createChild("div", {
    className: "leftCol"
  });
  this.itemBox = new d({
    showDescription: !0,
    showTitle: !0,
    withBidHouseBtn: !0
  });
  e.appendChild(this.itemBox);
  this.itemRecipeBox = e.createChild("div", {
    className: "itemRecipeBox"
  });
  this.itemRecipeBox.createChild("div", {
    className: "title",
    name: "title"
  });
  this.itemRecipeBox.on("itemTapped", o);
  this.itemRecipeBox.myWindow = this;
  var t = this.windowBody.createChild("div", {
    className: "rightCol"
  });
  this.recipeList = new p({
    isMenuOnItemDisabled: !0
  });
  this.recipeList.on("itemTapped", o);
  this.recipeList.on("recipeSelected", a);
  this.recipeList.myWindow = this;
  t.appendChild(this.recipeList);
  var i = this.backButton = new g({
    className: "backButton"
  }, s);
  i.insertBefore(this.windowTitle);
  i.myWindow = this;
};
n.prototype._displayItem = function (e) {
  this.recipeList.reset();
  this.dbItemId = e.id;
  this._isReloading = !1;
  var t = this;
  this.windowTitle.setText(e.nameId);
  this.backButton.toggleDisplay(this.itemHistory.length > 1);
  this.itemBox.displayItem(e);
  var i = [e.id].concat(e.recipeIds);
  m.getDataMap("Recipes", i, function (n, o) {
    if (n) {
      return console.error(n);
    }
    if (t.recipeList) {
      for (var a = o[i[0]], s = [], c = 1; c < i.length; c++) {
        var d = o[i[c]];
        d && s.push(d);
      }
      t.recipeBox && (t.recipeBox.destroy(), t._craftDetails.destroy());
      var u = !e.getProperty("secretRecipe");
      t.itemRecipeBox.toggleClassName("empty", !a || u);
      a ? (t.itemRecipeBox.getChild("title").setText(l("ui.item.utilityReceipt")), t.recipeBox = new h(a, {
        isMenuOnItemDisabled: !0
      }), t._craftDetails = new _("div", {
        "class": "craftDetails"
      }), t.recipeBox.on("itemTapped", r), t.recipeBox.myWindow = t, t.recipeBox.setupRecipe(function (e) {
        return e ? void console.error(new Error("setupRecipe error: " + e)) : void (t.itemRecipeBox && (t.itemRecipeBox.appendChild(t.recipeBox), t._craftDetails.setText(t.recipeBox.craftDetails), t.itemRecipeBox.appendChild(t._craftDetails)));
      }), t.recipeBox.myWindow = t) : u ? t.itemRecipeBox.getChild("title").setText(l("ui.item.secretReceipt")) : t.itemRecipeBox.getChild("title").setText(l("ui.item.utilityNoReceipt"));
      t.recipeList.addRecipes(s, {
        usingItemId: e.id
      });
    }
  });
};
this.dbItemId = null;
this.itemHistory = [];
this.windowBody.clearContent();
this.itemBox = null;
this.itemRecipeBox = null;
this.recipeList = null;
this.windowHeadWrapper.removeChild(this.backButton);
this.backButton = null;
this.itemBox = new d({
  showDescription: !0,
  showTitle: !0,
  withBidHouseBtn: !0
});
e.appendChild(this.itemBox);
this.itemRecipeBox = e.createChild("div", {
  className: "itemRecipeBox"
});
this.itemRecipeBox.createChild("div", {
  className: "title",
  name: "title"
});
this.itemRecipeBox.on("itemTapped", o);
this.itemRecipeBox.myWindow = this;
this.recipeList = new p({
  isMenuOnItemDisabled: !0
});
this.recipeList.on("itemTapped", o);
this.recipeList.on("recipeSelected", a);
this.recipeList.myWindow = this;
t.appendChild(this.recipeList);
i.insertBefore(this.windowTitle);
i.myWindow = this;
this.recipeList.reset();
this.dbItemId = e.id;
this._isReloading = !1;
this.windowTitle.setText(e.nameId);
this.backButton.toggleDisplay(this.itemHistory.length > 1);
this.itemBox.displayItem(e);
t.itemRecipeBox.toggleClassName("empty", !a || u);
a ? (t.itemRecipeBox.getChild("title").setText(l("ui.item.utilityReceipt")), t.recipeBox = new h(a, {
  isMenuOnItemDisabled: !0
}), t._craftDetails = new _("div", {
  "class": "craftDetails"
}), t.recipeBox.on("itemTapped", r), t.recipeBox.myWindow = t, t.recipeBox.setupRecipe(function (e) {
  return e ? void console.error(new Error("setupRecipe error: " + e)) : void (t.itemRecipeBox && (t.itemRecipeBox.appendChild(t.recipeBox), t._craftDetails.setText(t.recipeBox.craftDetails), t.itemRecipeBox.appendChild(t._craftDetails)));
}), t.recipeBox.myWindow = t) : u ? t.itemRecipeBox.getChild("title").setText(l("ui.item.secretReceipt")) : t.itemRecipeBox.getChild("title").setText(l("ui.item.utilityNoReceipt"));
t.recipeList.addRecipes(s, {
  usingItemId: e.id
});
e = n[o];
e.select();
this.selectedItemIds = [];
this._logic = new r(_, f, u);
this.once("open", function () {
  function n() {
    i._updateItemSlotsOwned();
  }
  this.currentSetId = null;
  var s = this.windowBody.createChild("div", {
    className: "leftCol"
  });
  this.itemListBox = s.createChild("div", {
    className: "itemListBox"
  });
  this.itemBox = new a({
    parent: this,
    showDescription: !0,
    showTitle: !0,
    withBidHouseBtn: !0
  });
  s.appendChild(this.itemBox);
  var r = this.windowBody.createChild("div", {
      className: "rightCol"
    }),
    d = r.createChild("div", {
      className: "selectorContainer"
    });
  d.createChild("div", {
    className: "tableTitle",
    text: h("ui.set.bonus")
  });
  this.bonusSelector = d.appendChild(new l());
  this.bonusSelector.on("change", function (e) {
    i._updateBonusTable(e, i.combineBonusesCheckbox.isActivate());
  });
  this.combineBonusesCheckbox = d.appendChild(new o(h("ui.set.addObjectBonus")));
  this.combineBonusesCheckbox.on("change", function (n) {
    n ? t() : e();
    var o = i.selectedItemIds.length;
    i.bonusSelector.select(n ? o : v);
    i.bonusSelector.toggleOption(o, n);
    i.bonusSelector.setEnable(!n);
    i.bonusSelector.toggleClassName("disabled", n);
  });
  this.bonusTable = r.appendChild(new c([{
    id: "description"
  }], null, {
    noHeader: !0,
    clickable: !1
  }));
  window.gui.on("SetUpdateMessage", function (e) {
    i.openState && e.setId === i.currentSetId && i._updateEquippedItems(e.setObjects);
  });
  var u = window.gui.playerData.inventory;
  u.on("itemAdded", n);
  u.on("itemsAdded", n);
  u.on("itemDeleted", n);
  u.on("itemsDeleted", n);
});
this.on("open", function (e) {
  var t = e.item ? e.item : e;
  this._displayItemSet(t);
});
this.on("close", function () {
  this.currentSetId = null;
});
this.itemListBox = s.createChild("div", {
  className: "itemListBox"
});
this.itemBox = new a({
  parent: this,
  showDescription: !0,
  showTitle: !0,
  withBidHouseBtn: !0
});
s.appendChild(this.itemBox);
d.createChild("div", {
  className: "tableTitle",
  text: h("ui.set.bonus")
});
this.bonusSelector = d.appendChild(new l());
this.bonusSelector.on("change", function (e) {
  i._updateBonusTable(e, i.combineBonusesCheckbox.isActivate());
});
this.combineBonusesCheckbox = d.appendChild(new o(h("ui.set.addObjectBonus")));
this.combineBonusesCheckbox.on("change", function (n) {
  n ? t() : e();
  var o = i.selectedItemIds.length;
  i.bonusSelector.select(n ? o : v);
  i.bonusSelector.toggleOption(o, n);
  i.bonusSelector.setEnable(!n);
  i.bonusSelector.toggleClassName("disabled", n);
});
this.bonusTable = r.appendChild(new c([{
  id: "description"
}], null, {
  noHeader: !0,
  clickable: !1
}));
window.gui.on("SetUpdateMessage", function (e) {
  i.openState && e.setId === i.currentSetId && i._updateEquippedItems(e.setObjects);
});
i.bonusSelector.select(n ? o : v);
i.bonusSelector.toggleOption(o, n);
i.bonusSelector.setEnable(!n);
i.bonusSelector.toggleClassName("disabled", n);
u.on("itemAdded", n);
u.on("itemsAdded", n);
u.on("itemDeleted", n);
u.on("itemsDeleted", n);
m(n, d);
e.exports = n;
n.prototype._updateItemSlotsOwned = function () {
  for (var e = this.itemListBox.getChildren(), t = window.gui.playerData.inventory.quantityList, i = 0; i < e.length; i += 1) {
    var n = e[i];
    n.delClassNames("notOwned");
    t.hasOwnProperty(n.dbItem.id) || n.addClassNames("notOwned");
  }
};
n.prototype._updateEquippedItems = function (e) {
  for (var t = this.itemListBox.getChildren(), i = 0, n = 0; n < t.length; n += 1) {
    var o = t[n];
    o.delClassNames("equipped");
    e.indexOf(o.dbItem.id) > -1 && (o.addClassNames("equipped"), i++);
    o.dbItem.id === this.itemBox.itemId && this._updateItemBox(f.items[o.dbItem.id]);
    var a = p.getEquippedItemById(window.gui.playerData.inventory, o.dbItem.id);
    o.setItem(a || o.dbItem);
  }
  this.bonusSelector.select(i);
};
n.prototype._displayItemSet = function (e) {
  if (e.itemSetId) {
    var t = this;
    this.currentSetId = e.itemSetId;
    this._updateItemBox(e);
    g.getData("ItemSets", e.itemSetId, function (e, i) {
      return e ? console.error(e) : (t.itemSet = i, t.windowTitle.setText(i.nameId), t.itemListBox.clearContent(), t.bonusSelector.clearContent(), void f.getItems(i.items, function (e) {
        if (e) {
          return console.error(e);
        }
        var n = 0;
        t.bonusSelector.addOption("0 " + h("ui.common.objects"), 0);
        t.bonusSelector.toggleOption(0, !1);
        for (var o, a, s, r, l = window.gui.playerData.inventory.quantityList, c = 0; c < i.items.length; c += 1) {
          s = i.items[c];
          a = f.items[s];
          o = p.getEquippedItemById(window.gui.playerData.inventory, s);
          o && (n += 1);
          r = t._createItemSlot(o || a);
          l.hasOwnProperty(s) || r.addClassNames("notOwned");
          t.itemListBox.appendChild(r);
          t.bonusSelector.addOption(c + 1 + " " + h("ui.common.objects"), c + 1);
        }
        t.combineBonusesCheckbox.deactivate();
        t.bonusSelector.select(n);
      }));
    });
  }
};
n.prototype._createItemSlot = function (e) {
  var t = this,
    i = new s({
      itemData: e
    });
  return i.createChild("div", {
    className: "equippedIcon"
  }), i.toggleClassName("equipped", !!i.itemInstance), i.on("tap", function () {
    var e = this.itemInstance && this.itemInstance.isInitialised ? this.itemInstance : null,
      n = window.gui.playerData.inventory.getGenericItem(this.dbItem.id);
    if (n && !n.isInitialised && (n = null), t.itemBox.displayItem(e || n || this.dbItem), t.combineBonusesCheckbox.isActivate()) {
      var o = t.selectedItemIds.indexOf(i.dbItem.id);
      o < 0 ? (t.selectedItemIds.push(i.dbItem.id), this.select()) : (t.selectedItemIds.splice(o, 1), this.unselect());
      t.bonusSelector.select(t.selectedItemIds.length);
    }
  }), i;
};
n.prototype._updateItemBox = function (e) {
  var t = p.getEquippedItemById(window.gui.playerData.inventory, e.id),
    i = window.gui.playerData.inventory.getGenericItem(e.id);
  this.itemBox.displayItem(t || i || e);
};
n.prototype._updateBonusTable = function (e, t) {
  var i = this;
  this.bonusTable.clearContent();
  this._logic.constructEffectInstances(e, t, this.selectedItemIds, this.itemSet, window.gui.playerData.inventory, function (e, t) {
    return e ? console.error(e) : (i.bonusTable.clearContent(), void i._addEffectsToTable(t));
  });
};
n.prototype._addEffectsToTable = function (e) {
  if (this.itemSet.bonusIsSecret && !e.length) {
    return void this.bonusTable.addRow({
      description: h("ui.set.secretBonus")
    });
  }
  for (var t = 0; t < e.length; t += 1) {
    var i = e[t];
    if (i) {
      var n = this.bonusTable.addRow({
        description: i.description
      });
      n.toggleClassName("negative", i.effect.bonusType === y);
    }
  }
};
n.delClassNames("notOwned");
t.hasOwnProperty(n.dbItem.id) || n.addClassNames("notOwned");
o.delClassNames("equipped");
e.indexOf(o.dbItem.id) > -1 && (o.addClassNames("equipped"), i++);
o.dbItem.id === this.itemBox.itemId && this._updateItemBox(f.items[o.dbItem.id]);
this.currentSetId = e.itemSetId;
this._updateItemBox(e);
g.getData("ItemSets", e.itemSetId, function (e, i) {
  return e ? console.error(e) : (t.itemSet = i, t.windowTitle.setText(i.nameId), t.itemListBox.clearContent(), t.bonusSelector.clearContent(), void f.getItems(i.items, function (e) {
    if (e) {
      return console.error(e);
    }
    var n = 0;
    t.bonusSelector.addOption("0 " + h("ui.common.objects"), 0);
    t.bonusSelector.toggleOption(0, !1);
    for (var o, a, s, r, l = window.gui.playerData.inventory.quantityList, c = 0; c < i.items.length; c += 1) {
      s = i.items[c];
      a = f.items[s];
      o = p.getEquippedItemById(window.gui.playerData.inventory, s);
      o && (n += 1);
      r = t._createItemSlot(o || a);
      l.hasOwnProperty(s) || r.addClassNames("notOwned");
      t.itemListBox.appendChild(r);
      t.bonusSelector.addOption(c + 1 + " " + h("ui.common.objects"), c + 1);
    }
    t.combineBonusesCheckbox.deactivate();
    t.bonusSelector.select(n);
  }));
});
t.bonusSelector.addOption("0 " + h("ui.common.objects"), 0);
t.bonusSelector.toggleOption(0, !1);
s = i.items[c];
a = f.items[s];
o = p.getEquippedItemById(window.gui.playerData.inventory, s);
o && (n += 1);
r = t._createItemSlot(o || a);
l.hasOwnProperty(s) || r.addClassNames("notOwned");
t.itemListBox.appendChild(r);
t.bonusSelector.addOption(c + 1 + " " + h("ui.common.objects"), c + 1);
t.combineBonusesCheckbox.deactivate();
t.bonusSelector.select(n);
o < 0 ? (t.selectedItemIds.push(i.dbItem.id), this.select()) : (t.selectedItemIds.splice(o, 1), this.unselect());
t.bonusSelector.select(t.selectedItemIds.length);
this.bonusTable.clearContent();
this._logic.constructEffectInstances(e, t, this.selectedItemIds, this.itemSet, window.gui.playerData.inventory, function (e, t) {
  return e ? console.error(e) : (i.bonusTable.clearContent(), void i._addEffectsToTable(t));
});
this._logger = e;
a(this._logger);
this._itemManager = t;
a(this._itemManager);
this._effectInstanceFactory = i;
a(this._effectInstanceFactory);
e.exports = s;
s.prototype._mergeEffectInstances = function (e, t) {
  for (var i = [], n = {}, a = [], s = 0; s < e.length; s += 1) {
    var l = e[s];
    l && (l.effect.category === r.special ? a.push(l) : n[l.effectId] ? n[l.effectId].effect.useDice && (n[l.effectId].diceNum += l.diceNum || 0, n[l.effectId].diceSide += l.diceSide || 0, n[l.effectId].value += l.value || 0) : n[l.effectId] = o(l));
  }
  for (var c in n) {
    n.hasOwnProperty(c) && i.push(o(n[c]));
  }
  i = i.concat(a);
  this._effectInstanceFactory.createEffectInstances(i, t);
};
s.prototype.constructEffectInstances = function (e, t, i, o, a, s) {
  var c,
    d = this,
    u = [],
    h = [],
    p = o.bonusIsSecret,
    m = Math.max(e - 1, 0);
  if (o.effects.length && !p) {
    var f = o.effects[m];
    n(f, u);
  }
  var g = o.id,
    _ = a.itemSets[g] || {},
    v = _.setEffects || [],
    y = _.setObjects || [],
    w = e === y.length;
  if (v.length && w && p && n(v, u), t && i.length) {
    var b = [];
    for (c = 0; c < i.length; c += 1) {
      var M = i[c],
        T = l.getEquippedItemById(a, M),
        C = {};
      if (T) {
        C = T.effects;
      } else {
        var I = this._itemManager.items[M];
        I ? C = I.possibleEffects : (this._logger.error("Missing item", M), C = {});
      }
      for (var A in C) {
        if (C.hasOwnProperty(A)) {
          var S = C[A];
          S.effect && S.effect.category === r.special ? h.push(S) : S.effect.showInSet && b.push(S);
        }
      }
    }
    u = u.concat(b);
  }
  for (c = 0; c < u.length; c += 1) {
    var E = u[c];
    E.effectCaller || (E.effectCaller = "itemSet " + g);
  }
  this._effectInstanceFactory.createEffectInstances(u, function (e, t) {
    return e ? s(e) : void d._mergeEffectInstances(t, function (e, t) {
      return e ? s(e) : (t = t.concat(h), s(null, t));
    });
  });
};
i = i.concat(a);
this._effectInstanceFactory.createEffectInstances(i, t);
s.call(this, {
  className: "LevelUpWindow",
  positionInfo: {
    left: "c",
    top: "c",
    width: 535,
    height: 260
  }
});
this.hasDom = !1;
this._setupEvents();
a(n, s);
e.exports = n;
n.prototype._setupSpellData = function () {
  var e = window.gui.playerData.characters.mainCharacter.spellData.spells,
    t = window.gui.playerData.characterBaseInformations.level;
  this.spells = [];
  for (var i = window.gui.playerData.characterBreed, n = 0; n < i.breedSpellsId.length; n++) {
    var a = i.breedSpellsId[n];
    t <= e[a].getProperty("minPlayerLevel") && this.spells.push(e[a]);
  }
  o(this.spells);
};
n.prototype._createDom = function () {
  this._characterDisplay = this.windowBody.appendChild(new u({
    scale: "fitin",
    horizontalAlign: "center"
  }));
  var e = this.windowBody.createChild("div", {
      className: "info"
    }),
    t = e.createChild("div", {
      className: "spellBlock"
    }),
    i = e.createChild("div", {
      className: "pointBlock"
    }),
    n = t.createChild("div", {
      className: "spellTextBox"
    });
  this.spellText = n.createChild("div", {
    className: "spellText"
  });
  this.spellIcon = t.createChild("div", {
    className: "spellIcon"
  });
  this.spellDescription = new c();
  d.addTooltip(this.spellIcon, this.spellDescription, {
    longTapExplanation: !0
  });
  var o = i.createChild("div", {
      className: ["healthPoints", "points"]
    }),
    a = i.createChild("div", {
      className: ["spellPoints", "points"]
    }),
    s = i.createChild("div", {
      className: ["charaPoints", "points"]
    });
  o.createChild("div", {
    className: "icon"
  });
  o.createChild("div", {
    className: "text",
    text: l("ui.levelUp.LifePoints")
  });
  this.health = o.createChild("div", {
    className: "point"
  });
  a.createChild("div", {
    className: "icon"
  });
  a.createChild("div", {
    className: "text",
    text: l("ui.levelUp.SpellPoints")
  });
  this.spell = a.createChild("div", {
    className: "point"
  });
  s.createChild("div", {
    className: "icon"
  });
  s.createChild("div", {
    className: "text",
    text: l("ui.levelUp.CaracPoints")
  });
  this.charac = s.createChild("div", {
    className: "point"
  });
  this.hasDom = !0;
};
n.prototype.freeContent = function () {
  this.windowBody.clearContent();
  this._characterDisplay = null;
  this.spellText = this.spellIcon = this.spellDescription = null;
  this.health = this.spell = this.charac = null;
  this.hasDom = !1;
};
n.prototype.updateSpellIcon = function (e) {
  var t = this;
  this.spellDescription.updateUI({
    spell: e
  });
  var i = e.spell.iconId;
  i < 0 && console.error(new Error("iconId < 0 for spellId " + e.spell.id + ": " + i));
  p.preloadImage("gfx/spells/sort_" + i + ".png", function (e) {
    t.hasDom && t.spellIcon.setStyle("backgroundImage", e);
  });
};
n.prototype._setupEvents = function () {
  var e = this,
    t = window.gui.playerData;
  t.on("characterLevelUp", function (t) {
    window.gui.scenarioManager.isBehaviourEnabled(f.LEVEL_FIGHT_POPUP) && new m(37, function () {
      e._levelUp(t.newLevel, t.previousLevel);
    }).start();
  });
  this.on("open", this._onOpen);
};
n.prototype._onOpen = function () {
  this.hasDom || this._createDom();
  var e = window.gui.playerData.characterBaseInformations.entityLook;
  this._characterDisplay.setLook(e, {
    direction: h.DIRECTION_SOUTH_EAST,
    animation: "AnimStatique",
    boneType: "characters/",
    skinType: "characters/"
  });
};
n.prototype._levelUp = function (e, t) {
  r.open(this.id);
  this._setupSpellData();
  this.windowTitle.setText(l("ui.levelUp.TitleLevel", e));
  for (var i = this.spells, n = 0; n < i.length; n++) {
    var o = i[n],
      a = o.getProperty("minPlayerLevel");
    if (e === a) {
      this.updateSpellIcon(o);
      this.spellText.setText(l("ui.levelUp.newSpell"));
      break;
    }
    if (e < a) {
      this.updateSpellIcon(o);
      this.spellText.setText(l("ui.levelUp.nextSpell") + " " + l("ui.levelUp.nextSpellLevel", a));
      break;
    }
  }
  var s = e - t;
  this.health.setText("+ " + 5 * s);
  this.spell.setText("+ " + s);
  this.charac.setText("+ " + 5 * s);
};
this.spellText = n.createChild("div", {
  className: "spellText"
});
this.spellIcon = t.createChild("div", {
  className: "spellIcon"
});
this.spellDescription = new c();
d.addTooltip(this.spellIcon, this.spellDescription, {
  longTapExplanation: !0
});
o.createChild("div", {
  className: "icon"
});
o.createChild("div", {
  className: "text",
  text: l("ui.levelUp.LifePoints")
});
this.health = o.createChild("div", {
  className: "point"
});
a.createChild("div", {
  className: "icon"
});
a.createChild("div", {
  className: "text",
  text: l("ui.levelUp.SpellPoints")
});
this.spell = a.createChild("div", {
  className: "point"
});
s.createChild("div", {
  className: "icon"
});
s.createChild("div", {
  className: "text",
  text: l("ui.levelUp.CaracPoints")
});
this.charac = s.createChild("div", {
  className: "point"
});
this.hasDom = !0;
this.windowBody.clearContent();
this._characterDisplay = null;
this.spellText = this.spellIcon = this.spellDescription = null;
this.health = this.spell = this.charac = null;
this.hasDom = !1;
i < 0 && console.error(new Error("iconId < 0 for spellId " + e.spell.id + ": " + i));
p.preloadImage("gfx/spells/sort_" + i + ".png", function (e) {
  t.hasDom && t.spellIcon.setStyle("backgroundImage", e);
});
t.on("characterLevelUp", function (t) {
  window.gui.scenarioManager.isBehaviourEnabled(f.LEVEL_FIGHT_POPUP) && new m(37, function () {
    e._levelUp(t.newLevel, t.previousLevel);
  }).start();
});
this.on("open", this._onOpen);
r.open(this.id);
this._setupSpellData();
this.windowTitle.setText(l("ui.levelUp.TitleLevel", e));
this.updateSpellIcon(o);
this.spellText.setText(l("ui.levelUp.newSpell"));
this.updateSpellIcon(o);
this.spellText.setText(l("ui.levelUp.nextSpell") + " " + l("ui.levelUp.nextSpellLevel", a));
this.health.setText("+ " + 5 * s);
this.spell.setText("+ " + s);
this.charac.setText("+ " + 5 * s);
g.call(this, {
  title: d("ui.mimicry.associate"),
  className: "MimicryWindow",
  positionInfo: {
    left: "c",
    top: "c",
    width: 450,
    height: 326
  }
});
this._reset();
this.on("open", this._onOpen);
this.on("close", this._onClose);
this._setListeners();
u(n, g);
e.exports = n;
n.prototype.freeContent = function () {
  this.windowBody.clearContent();
  this._reset();
};
n.prototype._reset = function () {
  this.mimicryItem = null;
  this.foodItem = null;
  this.hostItem = null;
  this.previewItem = null;
  this.hasDom = !1;
  this.hostSlot = this.foodSlot = this.mimicrySlot = this.previewSlot = null;
  this.selectedSlot = null;
};
n.prototype._onOpen = function (e) {
  var t = window.gui.playerData.inventory.objects;
  this.mimicryItem = t[e];
  this.mimicryItem || console.error("Missing mimicry. UID=" + e);
  this.hasDom || this._createDom();
  this._prepareItemPickingWindow();
  this.mimicrySlot.setItem(this.mimicryItem, 1);
  this._showHelp(d("tablet.mimicry.help"));
  this.mergeBtn.disable();
};
n.prototype._onClose = function () {
  this.itemPicking && (this.itemPicking.removeAllListeners("close"), this.itemPicking.removeAllListeners("unpickItem"), this.itemPicking.removeAllListeners("slot-doubletap"), this.itemPicking = null);
  _.close("itemPicking");
};
n.prototype._prepareItemPickingWindow = function () {
  var e = this.itemPicking = _.open("itemPicking");
  e.once("close", function () {
    _.close("mimicry");
  });
  e.on("unpickItem", this._dragItemAwayFromSlot.bind(this));
  e.on("slot-doubletap", this._addItemByDoubleTap.bind(this));
  e.showEquippableItems();
  _.arrangeOpeningWindow(this.id, {
    leftOf: e.id
  });
};
n.prototype._createDom = function () {
  this.hasDom = !0;
  var e = this.windowBody.createChild("div", {
      className: "content"
    }),
    t = e.createChild("div", {
      className: "workDiv"
    }),
    i = t.createChild("div", {
      className: "slotsZone"
    });
  this.mimicrySlot = o(i, "mimicrySlot", d("ui.mimicry.mimicry") + " " + d("ui.mimicry.toBeDestroyed"));
  i.createChild("div", {
    className: "plusOrEqualSign",
    text: "+"
  });
  this.hostSlot = o(i, "hostSlot", d("tablet.mimicry.host"));
  i.createChild("div", {
    className: "plusOrEqualSign",
    text: "+"
  });
  this._setActiveSlot(this.hostSlot);
  this.foodSlot = o(i, "foodSlot", d("tablet.mimicry.food") + " " + d("ui.mimicry.toBeDestroyed"));
  i.createChild("div", {
    className: "plusOrEqualSign",
    text: "="
  });
  this._setActiveSlot(this.foodSlot);
  this.previewSlot = o(i, "previewSlot", d("ui.craft.itemCreated"));
  this.messageBox = t.createChild("div");
  this.messageText = this.messageBox.createChild("div", {
    className: "msgText"
  });
  this.mergeBtn = e.appendChild(new l({
    text: d("ui.common.merge"),
    className: ["greenButton", "mergeBtn"]
  }, this._mergeBtnAction.bind(this)));
};
a.prototype.prepareForDrag = function (e) {
  var t = e.slot;
  return !!t.data && (this.backgroundImage = t.getImage(), !0);
};
n.prototype._setActiveSlot = function (e) {
  var t = e.mySlotDiv,
    i = {
      isDropAllowed: s
    };
  r.setDroppable(t, ["itemPicking", "mimicry"], i);
  t.mySlot = e;
  var n = this;
  t.on("drop", function (t, i) {
    n._dropItem(t.getItem(), e, i);
  });
  var o = new a(),
    l = {
      dragElement: !1
    };
  r.setDraggable(e, o, "mimicry", {
    slot: e
  }, l);
  e.on("tap", function () {
    n._simpleTapOnSlot(e);
  });
  e.on("doubletap", function () {
    n._simpleTapOnSlot(e);
    n._simpleTapOnSlot(e);
  });
};
n.prototype._simpleTapOnSlot = function (e) {
  e.getItem() && (e === this.selectedSlot ? (e.unselect(), e.unset(), this._refreshAfterSlotChange()) : (this.selectedSlot && this.selectedSlot.unselect(), this.selectedSlot = e, e.select()));
};
n.prototype._dragItemAwayFromSlot = function (e, t) {
  "mimicry" === t && (e.unset(), this._refreshAfterSlotChange());
};
n.prototype._dropItem = function (e, t, i) {
  if ("mimicry" === i) {
    var n = t === this.hostSlot ? this.foodSlot : this.hostSlot,
      o = t.getItem();
    n.setItem(o, 1);
    t.setItem(e, 1);
  } else {
    t.setItem(e, 1);
  }
  this._refreshAfterSlotChange();
};
n.prototype._addItemByDoubleTap = function (e) {
  var t = e.getItem();
  if (this.hostItem) {
    if (this.foodItem) {
      t.objectUID === this.foodItem.objectUID || t.objectUID === this.hostItem.objectUID ? (this.hostSlot.setItem(t, 1), this.foodSlot.unset()) : this.foodSlot.setItem(t, 1);
    } else {
      if (t.objectUID === this.hostItem.objectUID) {
        return;
      }
      this.foodSlot.setItem(t, 1);
    }
  } else {
    this.hostSlot.setItem(t, 1);
  }
  this._refreshAfterSlotChange();
};
n.prototype._refreshAfterSlotChange = function () {
  this._clearPreviewSlot();
  this.mergeBtn.disable();
  this.selectedSlot && (this.selectedSlot.unselect(), this.selectedSlot = null);
  var e = this.hostItem = this.hostSlot.getItem(),
    t = this.foodItem = this.foodSlot.getItem();
  return e && !e.item.isEquippable() ? this._showError(d("tablet.mimicry.errorEquippable")) : t && !t.item.isEquippable() ? this._showError(d("tablet.mimicry.errorEquippable")) : e && t ? e.getProperty("iconId") === t.getProperty("iconId") ? this._showError(d("ui.mimicry.error.sameSkin")) : e.getProperty("typeId") !== t.getProperty("typeId") ? this._showError(d("ui.mimicry.error.foodType")) : t.getProperty("level") > e.getProperty("level") ? this._showError(d("ui.mimicry.error.foodLevel")) : void this._requestMergeOrPreview(!0) : e ? this._showHelp(d("tablet.mimicry.helpFood")) : this._showHelp(d("tablet.mimicry.help"));
};
n.prototype._requestMergeOrPreview = function (e) {
  window.dofus.sendMessage("MimicryObjectFeedAndAssociateRequestMessage", {
    mimicryUID: this.mimicryItem.objectUID,
    mimicryPos: this.mimicryItem.position,
    foodUID: this.foodItem.objectUID,
    foodPos: this.foodItem.position,
    hostUID: this.hostItem.objectUID,
    hostPos: this.hostItem.position,
    preview: e
  });
};
n.prototype._mergeBtnAction = function () {
  var e = this;
  window.gui.openConfirmPopup({
    message: d("ui.mimicry.confirmPopup", this.hostItem.getName(), this.foodItem.getName(), this.mimicryItem.getName()),
    cb: function (t) {
      t && (e.mergeBtn.disable(), e._requestMergeOrPreview(!1));
    }
  });
};
n.prototype._clearPreviewSlot = function () {
  this.previewItem = null;
  this.previewSlot.unset();
  this.previewSlot.delClassNames("success");
};
n.prototype._showPreviewItem = function (e) {
  this.previewItem = e;
  this.previewSlot.setItem(e);
  this.previewSlot.addClassNames("success");
  this.mergeBtn.enable();
  e.item.isChangingCharacterLookWhenEquipped() ? this._showHelp(d("tablet.mimicry.helpMerge")) : this._showWarning(d("tablet.mimicry.fixedAppearance"));
};
n.prototype._showHelp = function (e) {
  this.messageBox.setClassNames(["msgBox", "help"]);
  this.messageText.setText(e);
};
n.prototype._showWarning = function (e) {
  this.messageBox.setClassNames(["msgBox", "warn"]);
  this.messageText.setText(e);
};
n.prototype._showError = function (e) {
  this.messageBox.setClassNames(["msgBox", "error"]);
  this.messageText.setText(e);
};
n.prototype._setListeners = function () {
  var e = window.dofus.connectionManager,
    t = this;
  e.on("ClientUIOpenedByObjectMessage", function (e) {
    e.type === c.CLIENT_UI_OBJECT_MIMICRY && _.open(t.id, e.uid);
  });
  e.on("MimicryObjectPreviewMessage", function (e) {
    h.createItemInstances(e.result, function (e, i) {
      return e ? console.error("Failed creating preview item:" + e) : void t._showPreviewItem(i.array[0]);
    });
  });
  e.on("MimicryObjectAssociatedMessage", function (e) {
    var i = window.gui.playerData.inventory.objects,
      n = i[e.hostUID],
      o = "{itemStats," + n.objectGID + "," + n.objectUID + "}";
    window.gui.chat.logMsg(d("ui.mimicry.success", o));
    _.close(t.id);
  });
  e.on("MimicryObjectErrorMessage", function (e) {
    if (e.reason === m.MIMICRY_OBJECT_ERROR) {
      var i,
        n = !1;
      switch (e.errorCode) {
        case -1:
          i = d("ui.error.state");
          break;
        case -2:
          i = d("ui.charSel.deletionErrorUnsecureMode");
          break;
        case -7:
          i = d("ui.mimicry.error.foodType");
          break;
        case -8:
          i = d("ui.mimicry.error.foodLevel");
          break;
        case -9:
          i = d("ui.mimicry.error.noValidMimicry");
          break;
        case -10:
          i = d("ui.mimicry.error.noValidHost");
          break;
        case -11:
          i = d("ui.mimicry.error.noValidFood");
          break;
        case -16:
          i = d("ui.mimicry.error.noMimicryAssociated");
          break;
        case -17:
          i = d("ui.mimicry.error.sameSkin");
          break;
        case -3:
        case -4:
        case -5:
        case -6:
        case -12:
        case -13:
        case -14:
        case -15:
          i = d("ui.popup.impossible_action");
          n = !0;
          break;
        default:
          i = d("ui.common.unknownFail");
          n = !0;
      }
      n && console.error("Abnormal mimicry error: " + e.errorCode);
      t._showError(i);
    }
  });
};
this.windowBody.clearContent();
this._reset();
this.mimicryItem = null;
this.foodItem = null;
this.hostItem = null;
this.previewItem = null;
this.hasDom = !1;
this.hostSlot = this.foodSlot = this.mimicrySlot = this.previewSlot = null;
this.selectedSlot = null;
this.mimicryItem = t[e];
this.mimicryItem || console.error("Missing mimicry. UID=" + e);
this.hasDom || this._createDom();
this._prepareItemPickingWindow();
this.mimicrySlot.setItem(this.mimicryItem, 1);
this._showHelp(d("tablet.mimicry.help"));
this.mergeBtn.disable();
this.itemPicking && (this.itemPicking.removeAllListeners("close"), this.itemPicking.removeAllListeners("unpickItem"), this.itemPicking.removeAllListeners("slot-doubletap"), this.itemPicking = null);
_.close("itemPicking");
e.once("close", function () {
  _.close("mimicry");
});
e.on("unpickItem", this._dragItemAwayFromSlot.bind(this));
e.on("slot-doubletap", this._addItemByDoubleTap.bind(this));
e.showEquippableItems();
_.arrangeOpeningWindow(this.id, {
  leftOf: e.id
});
this.mimicrySlot = o(i, "mimicrySlot", d("ui.mimicry.mimicry") + " " + d("ui.mimicry.toBeDestroyed"));
i.createChild("div", {
  className: "plusOrEqualSign",
  text: "+"
});
this.hostSlot = o(i, "hostSlot", d("tablet.mimicry.host"));
i.createChild("div", {
  className: "plusOrEqualSign",
  text: "+"
});
this._setActiveSlot(this.hostSlot);
this.foodSlot = o(i, "foodSlot", d("tablet.mimicry.food") + " " + d("ui.mimicry.toBeDestroyed"));
i.createChild("div", {
  className: "plusOrEqualSign",
  text: "="
});
this._setActiveSlot(this.foodSlot);
this.previewSlot = o(i, "previewSlot", d("ui.craft.itemCreated"));
this.messageBox = t.createChild("div");
this.messageText = this.messageBox.createChild("div", {
  className: "msgText"
});
this.mergeBtn = e.appendChild(new l({
  text: d("ui.common.merge"),
  className: ["greenButton", "mergeBtn"]
}, this._mergeBtnAction.bind(this)));
r.setDroppable(t, ["itemPicking", "mimicry"], i);
t.mySlot = e;
r.setDraggable(e, o, "mimicry", {
  slot: e
}, l);
e.on("tap", function () {
  n._simpleTapOnSlot(e);
});
e.on("doubletap", function () {
  n._simpleTapOnSlot(e);
  n._simpleTapOnSlot(e);
});
n._simpleTapOnSlot(e);
n._simpleTapOnSlot(e);
n.setItem(o, 1);
t.setItem(e, 1);
this._clearPreviewSlot();
this.mergeBtn.disable();
this.selectedSlot && (this.selectedSlot.unselect(), this.selectedSlot = null);
this.previewItem = null;
this.previewSlot.unset();
this.previewSlot.delClassNames("success");
this.previewItem = e;
this.previewSlot.setItem(e);
this.previewSlot.addClassNames("success");
this.mergeBtn.enable();
e.item.isChangingCharacterLookWhenEquipped() ? this._showHelp(d("tablet.mimicry.helpMerge")) : this._showWarning(d("tablet.mimicry.fixedAppearance"));
this.messageBox.setClassNames(["msgBox", "help"]);
this.messageText.setText(e);
this.messageBox.setClassNames(["msgBox", "warn"]);
this.messageText.setText(e);
this.messageBox.setClassNames(["msgBox", "error"]);
this.messageText.setText(e);
e.on("ClientUIOpenedByObjectMessage", function (e) {
  e.type === c.CLIENT_UI_OBJECT_MIMICRY && _.open(t.id, e.uid);
});
e.on("MimicryObjectPreviewMessage", function (e) {
  h.createItemInstances(e.result, function (e, i) {
    return e ? console.error("Failed creating preview item:" + e) : void t._showPreviewItem(i.array[0]);
  });
});
e.on("MimicryObjectAssociatedMessage", function (e) {
  var i = window.gui.playerData.inventory.objects,
    n = i[e.hostUID],
    o = "{itemStats," + n.objectGID + "," + n.objectUID + "}";
  window.gui.chat.logMsg(d("ui.mimicry.success", o));
  _.close(t.id);
});
e.on("MimicryObjectErrorMessage", function (e) {
  if (e.reason === m.MIMICRY_OBJECT_ERROR) {
    var i,
      n = !1;
    switch (e.errorCode) {
      case -1:
        i = d("ui.error.state");
        break;
      case -2:
        i = d("ui.charSel.deletionErrorUnsecureMode");
        break;
      case -7:
        i = d("ui.mimicry.error.foodType");
        break;
      case -8:
        i = d("ui.mimicry.error.foodLevel");
        break;
      case -9:
        i = d("ui.mimicry.error.noValidMimicry");
        break;
      case -10:
        i = d("ui.mimicry.error.noValidHost");
        break;
      case -11:
        i = d("ui.mimicry.error.noValidFood");
        break;
      case -16:
        i = d("ui.mimicry.error.noMimicryAssociated");
        break;
      case -17:
        i = d("ui.mimicry.error.sameSkin");
        break;
      case -3:
      case -4:
      case -5:
      case -6:
      case -12:
      case -13:
      case -14:
      case -15:
        i = d("ui.popup.impossible_action");
        n = !0;
        break;
      default:
        i = d("ui.common.unknownFail");
        n = !0;
    }
    n && console.error("Abnormal mimicry error: " + e.errorCode);
    t._showError(i);
  }
});
window.gui.chat.logMsg(d("ui.mimicry.success", o));
_.close(t.id);
i = d("ui.popup.impossible_action");
n = !0;
i = d("ui.common.unknownFail");
n = !0;
n && console.error("Abnormal mimicry error: " + e.errorCode);
t._showError(i);
l.call(this, {
  title: a("ui.common.inventory"),
  className: "ItemPickingWindow",
  plusButton: !1,
  positionInfo: {
    right: "10%",
    top: "c",
    width: 280,
    height: 564
  },
  openingSound: "OPEN_INVENTORY",
  closingSound: "CLOSE_INVENTORY"
});
this.storageView = e;
this.storageView.registerView(this, {
  manualOpening: !0,
  enableAveragePrice: !1,
  enableSlotContext: !1,
  tapSelectedEmitsDoubleTap: !0,
  filters: {
    quest: !0,
    preset: !0
  }
});
this.hasDom = !1;
this.on("open", this._onOpen);
s(n, l);
e.exports = n;
n.prototype._onOpen = function () {
  this.hasDom || this._createDom();
  this.storageBox.appendChild(this.storageView.storageUI);
  this.isReadyForUserInteraction = !1;
  var e = this;
  this.storageView.once("StorageViewerOpen", function () {
    e.isReadyForUserInteraction = !0;
  });
};
n.prototype._createDom = function () {
  var e = this;
  this.hasDom = !0;
  this.storageBox = this.windowBody.createChild("div", {
    className: "storageBox"
  });
  r(this.storageBox, ["mimicry"]);
  this.storageBox.on("drop", function (t, i) {
    e.emit("unpickItem", t, i);
  });
};
n.prototype.showEquippableItems = function () {
  this.storageView.showEquippableItems();
};
this.hasDom || this._createDom();
this.storageBox.appendChild(this.storageView.storageUI);
this.isReadyForUserInteraction = !1;
this.hasDom = !0;
this.storageBox = this.windowBody.createChild("div", {
  className: "storageBox"
});
r(this.storageBox, ["mimicry"]);
this.storageBox.on("drop", function (t, i) {
  e.emit("unpickItem", t, i);
});
this.padlockInfo = {
  codeSize: 8
};
this.once("open", function () {
  function t() {
    e.enterCode(this.id);
  }
  var i,
    n = 9,
    o = {};
  e.currentCodeDigit = 0;
  e.codeDigitContainer = [];
  e.codeDigit = [];
  var a = e.windowBody.createChild("div", {
    className: "codeContainer"
  });
  for (i = 0; i < e.padlockInfo.codeSize; i++) {
    e.codeDigitContainer.push(a.createChild("div", {
      className: "codeDigitContainer"
    }));
    e.codeDigit.push(e.codeDigitContainer[i].createChild("div", {
      className: "codeDigit"
    }));
  }
  var c = e.windowBody.createChild("div", {
      className: "container"
    }),
    d = c.createChild("div", {
      className: "leftPanel"
    });
  e.messageText = d.createChild("div", {
    className: "text"
  });
  e.resetButton = d.createChild("div", {
    className: "resetButton"
  });
  e.resetButton.createChild("div", {
    className: "resetButtonIcon"
  });
  e.resetButton.createChild("div", {
    className: "resetButtonText",
    text: l("ui.common.resetCode")
  });
  s(e.resetButton);
  var u = c.createChild("div", {
    className: "keypadContainer"
  });
  for (i = n; i >= 0; i--) {
    o[i] = u.appendChild(new r(i, {
      className: ["keypad", "num" + i]
    }));
    o[i].id = i;
    o[i].on("tap", t);
  }
  var h = this.windowBody.createChild("div", {
    className: "confirmPanel"
  });
  e.confirmButton = h.appendChild(new r(l("ui.common.validation"), {
    className: "confirmButton"
  }));
  e.setupButtonEvents();
});
this.on("open", function (t) {
  t = t || {};
  e.fromInside = t.fromInside;
  e.resetCode();
  var i = e.padlockInfo.changeOrUse || t.fromInside;
  e.messageText.setText(l(i ? "ui.common.lockInfos" : "ui.common.unlockInfos"));
});
e.setupListeners();
e.currentCodeDigit = 0;
e.codeDigitContainer = [];
e.codeDigit = [];
e.codeDigitContainer.push(a.createChild("div", {
  className: "codeDigitContainer"
}));
e.codeDigit.push(e.codeDigitContainer[i].createChild("div", {
  className: "codeDigit"
}));
e.messageText = d.createChild("div", {
  className: "text"
});
e.resetButton = d.createChild("div", {
  className: "resetButton"
});
e.resetButton.createChild("div", {
  className: "resetButtonIcon"
});
e.resetButton.createChild("div", {
  className: "resetButtonText",
  text: l("ui.common.resetCode")
});
s(e.resetButton);
o[i] = u.appendChild(new r(i, {
  className: ["keypad", "num" + i]
}));
o[i].id = i;
o[i].on("tap", t);
e.confirmButton = h.appendChild(new r(l("ui.common.validation"), {
  className: "confirmButton"
}));
e.setupButtonEvents();
t = t || {};
e.fromInside = t.fromInside;
e.resetCode();
o(n, a);
e.exports = n;
n.prototype.setupButtonEvents = function () {
  var e = this;
  this.confirmButton.on("tap", function () {
    for (var t = "", i = 0; i < e.padlockInfo.codeSize; i++) {
      t += isNaN(parseInt(e.codeDigit[i].getText(), 10)) ? "_" : e.codeDigit[i].getText();
    }
    var n = {
      code: t
    };
    return e.fromInside ? (window.dofus.sendMessage("HouseLockFromInsideRequestMessage", n), void c.close(e.id)) : void (e.padlockInfo.changeOrUse ? window.dofus.sendMessage("LockableChangeCodeMessage", n) : window.dofus.sendMessage("LockableUseCodeMessage", n));
  });
  this.resetButton.on("tap", function () {
    e.resetCode();
  });
  this.resetButton.on("tapstart", function () {
    this.addClassNames("pressed");
  });
  this.resetButton.on("tapend", function () {
    this.delClassNames("pressed");
  });
};
n.prototype.setupListeners = function () {
  var e = this,
    t = {
      0: l("ui.house.codeChanged"),
      1: l("ui.error.badCode")
    };
  window.gui.on("LockableShowCodeDialogMessage", function (t) {
    e.padlockInfo = t;
    c.openDialog(e.id, {
      fromInside: !1
    });
  });
  window.gui.on("LockableCodeResultMessage", function (e) {
    window.gui.openPopup({
      title: l("ui.common.code"),
      message: t[e.result]
    });
  });
};
n.prototype.enterCode = function (e) {
  var t = this.currentCodeDigit % this.padlockInfo.codeSize;
  this.codeDigit[t].setText(e);
  this.codeDigit[t].show();
  this.currentCodeDigit++;
  this.highlightDigit();
};
n.prototype.resetCode = function () {
  for (var e = 0; e < this.codeDigit.length; e++) {
    this.codeDigit[e].setText("");
    this.codeDigit[e].hide();
  }
  this.currentCodeDigit = 0;
  this.highlightDigit();
};
n.prototype.highlightDigit = function () {
  for (var e = this.currentCodeDigit % this.padlockInfo.codeSize, t = 0; t < this.codeDigitContainer.length; t++) {
    t === e ? this.codeDigitContainer[t].addClassNames("highlight") : this.codeDigitContainer[t].delClassNames("highlight");
  }
};
this.confirmButton.on("tap", function () {
  for (var t = "", i = 0; i < e.padlockInfo.codeSize; i++) {
    t += isNaN(parseInt(e.codeDigit[i].getText(), 10)) ? "_" : e.codeDigit[i].getText();
  }
  var n = {
    code: t
  };
  return e.fromInside ? (window.dofus.sendMessage("HouseLockFromInsideRequestMessage", n), void c.close(e.id)) : void (e.padlockInfo.changeOrUse ? window.dofus.sendMessage("LockableChangeCodeMessage", n) : window.dofus.sendMessage("LockableUseCodeMessage", n));
});
this.resetButton.on("tap", function () {
  e.resetCode();
});
this.resetButton.on("tapstart", function () {
  this.addClassNames("pressed");
});
this.resetButton.on("tapend", function () {
  this.delClassNames("pressed");
});
window.gui.on("LockableShowCodeDialogMessage", function (t) {
  e.padlockInfo = t;
  c.openDialog(e.id, {
    fromInside: !1
  });
});
window.gui.on("LockableCodeResultMessage", function (e) {
  window.gui.openPopup({
    title: l("ui.common.code"),
    message: t[e.result]
  });
});
e.padlockInfo = t;
c.openDialog(e.id, {
  fromInside: !1
});
this.codeDigit[t].setText(e);
this.codeDigit[t].show();
this.currentCodeDigit++;
this.highlightDigit();
this.codeDigit[e].setText("");
this.codeDigit[e].hide();
this.currentCodeDigit = 0;
this.highlightDigit();
a.call(this, {
  className: "PartyInviteDetailsWindow",
  positionInfo: f
});
this.partyMap = {};
this.numParties = 0;
this.partyId = null;
o(n, a);
e.exports = n;
n.prototype.showPartyDetails = function (e) {
  return e === this.partyId ? s.open(this.id) : (window.dofus.sendMessage("PartyInvitationDetailsRequestMessage", {
    partyId: e
  }), this.partyMap[e] || (this.partyMap[e] = !0, this.numParties++, 1 === this.numParties && this._setupListeners(!0)), void (this.text ? this._resetDom() : this._setupDom()));
};
n.prototype._closeAll = function () {
  for (var e in this.partyMap) {
    this._closePartyInvitation(e);
  }
  this.partyMap = {};
  this.numParties = 0;
  this.partyId = null;
};
n.prototype._closePartyInvitation = function (e) {
  this.partyMap[e] && (delete this.partyMap[e], this.numParties--, 0 === this.numParties && this._setupListeners(!1), window.gui.notificationBar.removeNotification("party" + e), e === this.partyId && (this.partyId = null, s.close(this.id), this.windowBody.clearContent(), this.text = null, this.characters = [], this.members = null, this.scroller = null, this.slotList = null));
};
n.prototype._setupDom = function () {
  var e = this;
  this.text = this.windowBody.createChild("div", {
    className: "text"
  });
  var t = this.windowBody.createChild("div", {
    className: "container"
  });
  this.scroller = t.appendChild(new m({
    className: "slotList"
  }, {
    isHorizontal: !0
  }));
  this.slotList = this.scroller.content;
  this.characters = [];
  var i = this.windowBody.createChild("div", {
      className: "buttons"
    }),
    n = i.appendChild(new r(c("ui.common.accept"), {
      className: "acceptButton"
    })),
    o = i.appendChild(new r(c("ui.common.refuse"), {
      className: "refuseButton"
    })),
    a = i.appendChild(new r(c("ui.social.blackListTemporarly"), {
      className: "ignoreButton"
    }));
  n.on("tap", function () {
    window.dofus.sendMessage("PartyAcceptInvitationMessage", {
      partyId: e.partyId
    });
    e._closePartyInvitation(e.partyId);
  });
  o.on("tap", function () {
    window.dofus.sendMessage("PartyRefuseInvitationMessage", {
      partyId: e.partyId
    });
    e._closePartyInvitation(e.partyId);
  });
  a.on("tap", function () {
    window.dofus.sendMessage("IgnoredAddRequestMessage", {
      name: e.fromName,
      session: !0
    });
    e._closePartyInvitation(e.partyId);
  });
};
n.prototype._newCharacterSlot = function () {
  var e = this.slotList.createChild("div", {
    className: "character"
  });
  e.createChild("div", {
    className: "background",
    name: "background"
  });
  e.appendChild(new h({
    name: "characterDisplay",
    scale: 1.4,
    verticalAlign: "bottom"
  }));
  e.createChild("div", {
    className: "name",
    name: "name"
  });
  e.createChild("div", {
    className: "breed",
    name: "breed"
  });
  e.createChild("div", {
    className: "level",
    name: "level"
  });
  l(e);
  var t = this;
  return e.on("tap", function () {
    if (e.characterId) {
      var i = t.members[e.characterId];
      window.gui.openContextualMenu("player", {
        playerId: i.id,
        playerName: i.name,
        guildId: i.guildInfo.guildId
      });
    }
  }), e;
};
n.prototype._resetDom = function () {
  this.characters = [];
  this.slotList.clearContent();
};
n.prototype._removeMember = function (e, t) {
  if (e === this.partyId) {
    var i = this.members[t];
    if (i) {
      var n = i.index,
        o = this.characters.splice(n, 1)[0];
      this.slotList.removeChild(o);
      this.characters.push(this._newCharacterSlot());
      for (var a in this.members) {
        i = this.members[a];
        i.index > n && i.index--;
      }
      delete this.members[t];
      this.scroller.refresh();
    }
  }
};
this.partyMap = {};
this.numParties = 0;
this.partyId = null;
this.scroller = t.appendChild(new m({
  className: "slotList"
}, {
  isHorizontal: !0
}));
this.slotList = this.scroller.content;
this.characters = [];
n.on("tap", function () {
  window.dofus.sendMessage("PartyAcceptInvitationMessage", {
    partyId: e.partyId
  });
  e._closePartyInvitation(e.partyId);
});
o.on("tap", function () {
  window.dofus.sendMessage("PartyRefuseInvitationMessage", {
    partyId: e.partyId
  });
  e._closePartyInvitation(e.partyId);
});
a.on("tap", function () {
  window.dofus.sendMessage("IgnoredAddRequestMessage", {
    name: e.fromName,
    session: !0
  });
  e._closePartyInvitation(e.partyId);
});
window.dofus.sendMessage("PartyAcceptInvitationMessage", {
  partyId: e.partyId
});
e._closePartyInvitation(e.partyId);
window.dofus.sendMessage("PartyRefuseInvitationMessage", {
  partyId: e.partyId
});
e._closePartyInvitation(e.partyId);
window.dofus.sendMessage("IgnoredAddRequestMessage", {
  name: e.fromName,
  session: !0
});
e._closePartyInvitation(e.partyId);
e.createChild("div", {
  className: "background",
  name: "background"
});
e.appendChild(new h({
  name: "characterDisplay",
  scale: 1.4,
  verticalAlign: "bottom"
}));
e.createChild("div", {
  className: "name",
  name: "name"
});
e.createChild("div", {
  className: "breed",
  name: "breed"
});
e.createChild("div", {
  className: "level",
  name: "level"
});
l(e);
this.characters = [];
this.slotList.clearContent();
this.slotList.removeChild(o);
this.characters.push(this._newCharacterSlot());
i = this.members[a];
i.index > n && i.index--;
delete this.members[t];
this.scroller.refresh();
n.prototype._addOrUpdateMember = function (e, t, i) {
  if (e === this.partyId) {
    if (g.indexOf(t._type) === -1) {
      return console.error("Unhandled type for character: " + t._type);
    }
    var n = this.members[t.id];
    n ? t.index = n.index : t.index = Object.keys(this.members).length;
    this.members[t.id] = t;
    this._updateCharacterSlot(t);
    i || this.scroller.refresh();
  }
};
n.prototype._updateCharacterSlot = function (e) {
  var t = this.characters[e.index];
  t || (t = this.characters[e.index] = this._newCharacterSlot());
  t.characterId = e.id;
  t.getChild("name").setText(e.name);
  t.getChild("level").setText(c("ui.common.level") + " " + e.level);
  t.getChild("breed").setText(window.gui.databases.Breeds[e.breed].shortNameId);
  var i = t.getChild("characterDisplay");
  i.setLook(e.entityLook, {
    direction: p.DIRECTION_SOUTH_EAST,
    animation: "AnimStatique",
    boneType: "characters/",
    skinType: "characters/",
    riderOnly: !0
  });
  this._toggleGuest(e.id, e.isGuest);
};
n.prototype._toggleGuest = function (e, t) {
  var i = this.members[e];
  if (i) {
    var n = this.characters[i.index];
    n.getChild("background").toggleClassName("guestFrame", !!t);
  }
};
n.prototype._toggleLeader = function (e, t) {
  var i = this.members[e];
  if (i) {
    var n = this.characters[i.index];
    n.getChild("background").toggleClassName("leaderIcon", !!t);
  }
};
n.prototype._setLeader = function (e, t) {
  e === this.partyId && (this._toggleLeader(this.leaderId, !1), this._toggleLeader(t, !0), this.leaderId = t);
};
n.prototype._joinParty = function (e) {
  var t = e.partyId;
  this.partyId = t;
  var i = e.partyType === u.PARTY_TYPE_ARENA;
  this.position = null;
  s.open(this.id);
  this.windowTitle.setText(c(i ? "ui.common.invitationArena" : "ui.common.invitationGroupe"));
  this.slotList.toggleClassName("arena", i);
  this.slotList.toggleClassName("classic", !i);
  for (var n = i ? d.NUM_SLOTS_ARENA : d.NUM_SLOTS_CLASSIC, o = n; o > 0; o--) {
    this.characters.push(this._newCharacterSlot());
  }
  for (this.text.setText(c("ui.common.invitationPresentation", e.fromName) + "."), this.fromName = e.fromName, this.members = {}, o = 0; o < e.members.length; o++) {
    this._addOrUpdateMember(t, e.members[o], !0);
  }
  for (o = 0; o < e.guests.length; o++) {
    this._addOrUpdateMember(t, e.guests[o], !0);
  }
  this._setLeader(t, e.leaderId);
  this.scroller.refresh();
};
n.prototype._setupListeners = function (e) {
  var t = window.gui.playerData.partyData;
  this.joinPartyHandler || (this.joinPartyHandler = this._joinParty.bind(this), this.closePartyInvitationHandler = this._closePartyInvitation.bind(this), this.setLeaderHandler = this._setLeader.bind(this), this.addOrUpdateMemberHandler = this._addOrUpdateMember.bind(this), this.removeMemberHandler = this._removeMember.bind(this));
  e ? (t.on("partyInvitationDetails", this.joinPartyHandler), t.on("partyInvitationCancelled", this.closePartyInvitationHandler), t.on("partyLeaderUpdate", this.setLeaderHandler), t.on("partyNewGuest", this.addOrUpdateMemberHandler), t.on("partyNewMember", this.addOrUpdateMemberHandler), t.on("partyUpdateMember", this.addOrUpdateMemberHandler), t.on("partyMemberLeaving", this.removeMemberHandler), t.on("partyGuestLeaving", this.removeMemberHandler)) : (t.removeListener("partyInvitationDetails", this.joinPartyHandler), t.removeListener("partyInvitationCancelled", this.closePartyInvitationHandler), t.removeListener("partyLeaderUpdate", this.setLeaderHandler), t.removeListener("partyNewGuest", this.addOrUpdateMemberHandler), t.removeListener("partyNewMember", this.addOrUpdateMemberHandler), t.removeListener("partyUpdateMember", this.addOrUpdateMemberHandler), t.removeListener("partyMemberLeaving", this.removeMemberHandler), t.removeListener("partyGuestLeaving", this.removeMemberHandler));
};
n ? t.index = n.index : t.index = Object.keys(this.members).length;
this.members[t.id] = t;
this._updateCharacterSlot(t);
i || this.scroller.refresh();
t || (t = this.characters[e.index] = this._newCharacterSlot());
t.characterId = e.id;
t.getChild("name").setText(e.name);
t.getChild("level").setText(c("ui.common.level") + " " + e.level);
t.getChild("breed").setText(window.gui.databases.Breeds[e.breed].shortNameId);
i.setLook(e.entityLook, {
  direction: p.DIRECTION_SOUTH_EAST,
  animation: "AnimStatique",
  boneType: "characters/",
  skinType: "characters/",
  riderOnly: !0
});
this._toggleGuest(e.id, e.isGuest);
this.position = null;
s.open(this.id);
this.windowTitle.setText(c(i ? "ui.common.invitationArena" : "ui.common.invitationGroupe"));
this.slotList.toggleClassName("arena", i);
this.slotList.toggleClassName("classic", !i);
this._setLeader(t, e.leaderId);
this.scroller.refresh();
this.joinPartyHandler || (this.joinPartyHandler = this._joinParty.bind(this), this.closePartyInvitationHandler = this._closePartyInvitation.bind(this), this.setLeaderHandler = this._setLeader.bind(this), this.addOrUpdateMemberHandler = this._addOrUpdateMember.bind(this), this.removeMemberHandler = this._removeMember.bind(this));
e ? (t.on("partyInvitationDetails", this.joinPartyHandler), t.on("partyInvitationCancelled", this.closePartyInvitationHandler), t.on("partyLeaderUpdate", this.setLeaderHandler), t.on("partyNewGuest", this.addOrUpdateMemberHandler), t.on("partyNewMember", this.addOrUpdateMemberHandler), t.on("partyUpdateMember", this.addOrUpdateMemberHandler), t.on("partyMemberLeaving", this.removeMemberHandler), t.on("partyGuestLeaving", this.removeMemberHandler)) : (t.removeListener("partyInvitationDetails", this.joinPartyHandler), t.removeListener("partyInvitationCancelled", this.closePartyInvitationHandler), t.removeListener("partyLeaderUpdate", this.setLeaderHandler), t.removeListener("partyNewGuest", this.addOrUpdateMemberHandler), t.removeListener("partyNewMember", this.addOrUpdateMemberHandler), t.removeListener("partyUpdateMember", this.addOrUpdateMemberHandler), t.removeListener("partyMemberLeaving", this.removeMemberHandler), t.removeListener("partyGuestLeaving", this.removeMemberHandler));
r.call(this, {
  className: "PresetChooseIconWindow",
  title: a("ui.option.tabPic"),
  positionInfo: {
    left: "c",
    top: "c",
    width: 460,
    height: 250
  }
});
this.once("open", function (t) {
  this.windowBody.appendChild(t);
  this.saveButton = this.windowBody.appendChild(new o(a("ui.common.save")));
  this.saveButton.on("tap", function () {
    e();
  });
});
this.windowBody.appendChild(t);
this.saveButton = this.windowBody.appendChild(new o(a("ui.common.save")));
this.saveButton.on("tap", function () {
  e();
});
s(n, r);
e.exports = n;
s.call(this, {
  title: r("ui.achievement.rewardsWaiting"),
  className: "rewardsPending",
  positionInfo: {
    left: "c",
    top: "c-32px",
    width: 500,
    height: 300
  }
});
this.rewards = {};
this._rewardItems = [];
this.isInFight = !1;
this.rewardsList = this.windowBody.createChild("div", {
  className: "rewardsList"
});
this.counter = this.windowBody.createChild("div", {
  className: "counter"
});
this.acceptAllButton = this.windowBody.appendChild(new l(r("ui.common.acceptAll")));
this.acceptAllButton.on("tap", function () {
  e.collectAll();
});
t.playerData.achievements.on("achievementFinished", function (t) {
  e.addReward(t.id, t.finishedlevel);
});
t.playerData.achievements.on("achievementListUpdated", function (t) {
  e.reset();
  for (var i = 0; i < t.rewardableAchievements.length; i += 1) {
    var n = t.rewardableAchievements[i];
    e.addReward(n.id, n.finishedlevel);
  }
});
t.playerData.achievements.on("achievementRewardSuccess", function (t) {
  e.removeReward(t);
  for (var i = e._rewardItems.length - 1; i >= 0; i--) {
    if (e._rewardItems[i].id === t) {
      for (var n = 0; n < e._rewardItems[i].itemsReward.length; n++) {
        window.gui.chat.logMsg(r("ui.common.newItem", e._rewardItems[i].itemsQuantityReward[n], e._rewardItems[i].itemsReward[n]));
      }
      e._rewardItems.splice(i, 1);
    }
  }
});
t.on("disconnect", function () {
  e.reset();
});
t.fightManager.on("fightStart", function () {
  e.isInFight = !0;
  e.handleRewardsIndicatorDisplay();
});
t.fightManager.on(p.FIGHT_END, function () {
  e.isInFight = !1;
  e.handleRewardsIndicatorDisplay();
});
e.isInFight = !0;
e.handleRewardsIndicatorDisplay();
e.isInFight = !1;
e.handleRewardsIndicatorDisplay();
a(n, s);
e.exports = n;
n.prototype.addReward = function (e, t) {
  function i(t) {
    h.getData("Achievements", e, function (e, i) {
      return e ? t(e) : (I = i.nameId, E = i.categoryId, x = i.rewardIds, A = i, t());
    });
  }
  function n(e) {
    h.getData("AchievementCategories", E, function (t, i) {
      return t ? e(t) : (S = i.parentId, N = i.nameId, e());
    });
  }
  function a(e) {
    return 0 === S ? e() : void h.getData("AchievementCategories", S, function (t, i) {
      return t ? e(t) : (N = i.nameId, e());
    });
  }
  function s(e) {
    return 0 === x.length ? e() : void h.getData("AchievementRewards", x, function (i, n) {
      if (i) {
        return e(i);
      }
      if (!y.rootElement) {
        return e();
      }
      for (var o = 0; o < n.length; o += 1) {
        var a = n[o],
          s = window.gui.playerData.achievements.completedData(A.id),
          r = a.isLinkedToAccount && s.isAccountCompleted,
          l = s.finishedlevel || window.gui.playerData.characterBaseInformations.level;
        if (a.experienceRatio) {
          var c = 0;
          r || (c = window.gui.playerData.achievements.getAchievementExperienceReward(a, A.level, l));
          y.xp.setText(f.kamasToString(c, ""));
        } else if (a.kamasRatio) {
          var d = 0;
          r || (d = window.gui.playerData.achievements.getAchievementKamasReward(a, A.level, l));
          y.kamas.setText(f.kamasToString(d, ""));
        }
        !r && (a.levelMin === -1 || a.levelMin <= t) && (a.levelMax === -1 || a.levelMax >= t) && (a.itemsReward && a.itemsReward.length > 0 && Array.prototype.push.apply(L, a.itemsReward), a.itemsQuantityReward && a.itemsQuantityReward.length > 0 && Array.prototype.push.apply(O, a.itemsQuantityReward), v._rewardItems.push({
          id: A.id,
          itemsReward: a.itemsReward,
          itemsQuantityReward: a.itemsQuantityReward
        }), a.emotesReward && a.emotesReward.length > 0 && Array.prototype.push.apply(R, a.emotesReward), a.titlesReward && a.titlesReward.length > 0 && Array.prototype.push.apply(D, a.titlesReward), a.ornamentsReward && a.ornamentsReward.length > 0 && Array.prototype.push.apply(P, a.ornamentsReward));
      }
      return e();
    });
  }
  function r(e) {
    return 0 === L.length ? e() : void g.getItems(L, function (t) {
      if (t) {
        return e(t);
      }
      for (var i = 0; i < L.length; i += 1) {
        var n = g.items[L[i]];
        n || (n = g.items[g.FALLBACK_DB_ITEM_ID]);
        B.push("gfx/items/" + n.iconId + ".png");
      }
      return e();
    });
  }
  function l(e) {
    for (var t = 0; t < R.length; t += 1) {
      B.push("gfx/emotes/" + R[t] + ".png");
    }
    return e();
  }
  function u(e) {
    for (var t = 0; t < D.length; t += 1) {
      B.push("gfx/illusUi/genericTitleIcon.png");
    }
    return e();
  }
  function p(e) {
    return 0 === P.length ? e() : void h.getData("Ornaments", P, function (t, i) {
      if (t) {
        return e(t);
      }
      for (var n = 0; n < i.length; n += 1) {
        B.push("gfx/ornaments/" + i[n].iconId + ".png");
      }
      return e();
    });
  }
  function _(e) {
    return 0 === B.length ? e() : void m.preloadImages(B, function (t) {
      for (var i = 0; i < t.length; i += 1) {
        var n = T[i];
        n && n.rootElement && (n.setImage(t[i]), n.setQuantity(O[i]));
      }
      return e();
    });
  }
  var v = this,
    y = this.rewardsList.createChild("div", {
      className: "reward"
    });
  y.id = e;
  y.left = y.createChild("div", {
    className: "rewardLeft"
  });
  y.right = y.createChild("div", {
    className: "rewardRight"
  });
  y.nameText = y.left.createChild("div", {
    className: "rewardName"
  });
  y.category = y.right.createChild("div", {
    className: "rewardCategory"
  });
  y.numbers = y.right.createChild("div", {
    className: "rewardNumbers"
  });
  y.xp = y.numbers.createChild("div", {
    className: "rewardXp"
  });
  y.kamas = y.numbers.createChild("div", {
    className: "rewardKamas"
  });
  y.collectButton = y.right.createChild("div", {
    className: "collectButton"
  });
  d(y.collectButton);
  y.collectButton.on("tap", function () {
    v.collectReward(y.id);
  });
  for (var w = y.left.createChild("div", {
      className: "rewards",
      name: "rewards"
    }), b = w.createChild("div", {
      className: "rewardList"
    }), M = 6, T = [], C = 0; C < M; C += 1) {
    T[C] = b.appendChild(new c({
      name: "icon" + C
    }));
  }
  this.rewards[e] = y;
  this.updateCounter();
  this.handleRewardsIndicatorDisplay();
  var I,
    A,
    S,
    E,
    N,
    x,
    L = [],
    O = [],
    R = [],
    D = [],
    P = [],
    B = [];
  o.series([i, n, a, s, r, l, u, p, _], function (e) {
    return e ? console.error(e) : void (y.rootElement && (y.nameText.setText(I), y.category.setText(N)));
  });
};
n.prototype.removeReward = function (e) {
  var t = this.rewards[e];
  t.destroy();
  delete this.rewards[e];
  this.updateCounter();
  this.handleRewardsIndicatorDisplay();
};
n.prototype.collectAll = function () {
  window.dofus.sendMessage("AchievementRewardRequestMessage", {
    achievementId: -1
  });
};
n.prototype.collectReward = function (e) {
  window.dofus.sendMessage("AchievementRewardRequestMessage", {
    achievementId: e
  });
};
n.prototype.updateCounter = function () {
  var e = Object.keys(this.rewards).length;
  this.counter.setText(r("ui.achievement.rewardsRemaining", e));
};
n.prototype.handleRewardsIndicatorDisplay = function () {
  var e = Object.keys(this.rewards).length;
  0 === e && u.close("rewardsPending");
  window.gui.rewardsIndicator.toggleDisplay(e > 0 && !this.isInFight);
};
n.prototype.reset = function () {
  this.rewards = {};
  this._rewardItems = [];
  this.isInFight = !1;
  this.rewardsList.clearContent();
};
r || (c = window.gui.playerData.achievements.getAchievementExperienceReward(a, A.level, l));
y.xp.setText(f.kamasToString(c, ""));
r || (d = window.gui.playerData.achievements.getAchievementKamasReward(a, A.level, l));
y.kamas.setText(f.kamasToString(d, ""));
n || (n = g.items[g.FALLBACK_DB_ITEM_ID]);
B.push("gfx/items/" + n.iconId + ".png");
y.id = e;
y.left = y.createChild("div", {
  className: "rewardLeft"
});
y.right = y.createChild("div", {
  className: "rewardRight"
});
y.nameText = y.left.createChild("div", {
  className: "rewardName"
});
y.category = y.right.createChild("div", {
  className: "rewardCategory"
});
y.numbers = y.right.createChild("div", {
  className: "rewardNumbers"
});
y.xp = y.numbers.createChild("div", {
  className: "rewardXp"
});
y.kamas = y.numbers.createChild("div", {
  className: "rewardKamas"
});
y.collectButton = y.right.createChild("div", {
  className: "collectButton"
});
d(y.collectButton);
y.collectButton.on("tap", function () {
  v.collectReward(y.id);
});
this.rewards[e] = y;
this.updateCounter();
this.handleRewardsIndicatorDisplay();
t.destroy();
delete this.rewards[e];
this.updateCounter();
this.handleRewardsIndicatorDisplay();
0 === e && u.close("rewardsPending");
window.gui.rewardsIndicator.toggleDisplay(e > 0 && !this.isInFight);
this.rewards = {};
this._rewardItems = [];
this.isInFight = !1;
this.rewardsList.clearContent();
d.on("tap", function () {
  return e ? (d.disable(), window.gui.serversData.selectServer(e.id), void r.close(t.id)) : console.error("No server");
});
u.on("tap", function () {
  r.close(t.id);
});
this.on("open", function (t) {
  e = t;
  n.setServer(e);
  3 === e.status ? d.enable() : d.disable();
});
e = t;
n.setServer(e);
3 === e.status ? d.enable() : d.disable();
o(n, s);
e.exports = n;
t.createChild("div", {
  className: ["line", "label"],
  text: n[e]
});
i._detailsBlock[e] = t.createChild("div", {
  className: ["line", "text"]
});
this._detailsBlock = {};
e("name");
e("empty");
e("community");
e("population");
e("type");
e("status");
e("openingDate");
s(h);
s(p);
h.on("tap", function () {
  t("description");
});
p.on("tap", function () {
  t("rules");
});
this._descContent = m.createChild("div", {
  className: "descContent"
});
this._rulesContent = m.createChild("div", {
  className: "rulesContent"
});
h.addClassNames("selected");
this._rulesContent.hide();
o(n, a);
e.exports = n;
n.prototype.setServer = function (e) {
  var t = this,
    i = {
      0: r("ui.server.state.unknown"),
      1: r("ui.server.state.offline"),
      2: r("ui.server.state.starting"),
      3: r("ui.server.state.online"),
      4: r("ui.server.state.nojoin"),
      5: r("ui.server.state.saving"),
      6: r("ui.server.state.stoping"),
      7: r("ui.server.state.full")
    },
    n = {
      0: r("ui.server.rules.0"),
      1: r("ui.server.rules.1")
    };
  window.gui.serversData.syncServerStaticData(function (o) {
    if (o) {
      return console.error("ServerDetails setServer error", o);
    }
    l.getServerImage(e.id, function (e, i) {
      return e ? console.error(e) : void t._image.setStyle("backgroundImage", i);
    });
    t._detailsBlock.status.setText(i[e.status]);
    var a = window.gui.serversData.staticContent,
      s = a.data[e.id] || {},
      r = a.gameTypes[s.gameTypeId] || {},
      c = a.populations[s.populationId] || {},
      d = a.communities[s.communityId] || {};
    t._detailsBlock.name.setText(s.nameId || e.id);
    t._detailsBlock.community.setText(d.nameId || "n/a");
    t._detailsBlock.population.setText(c.nameId || "n/a");
    t._detailsBlock.type.setText(r.nameId || "n/a");
    var u = new Date(s.openingDate || 0);
    t._detailsBlock.openingDate.setText(u.getDate() + "/" + (u.getMonth() + 1) + "/" + u.getFullYear());
    t._descContent.setText(s.commentId);
    t._rulesContent.setText(n[s.gameTypeId] || "");
  });
};
l.getServerImage(e.id, function (e, i) {
  return e ? console.error(e) : void t._image.setStyle("backgroundImage", i);
});
t._detailsBlock.status.setText(i[e.status]);
t._detailsBlock.name.setText(s.nameId || e.id);
t._detailsBlock.community.setText(d.nameId || "n/a");
t._detailsBlock.population.setText(c.nameId || "n/a");
t._detailsBlock.type.setText(r.nameId || "n/a");
t._detailsBlock.openingDate.setText(u.getDate() + "/" + (u.getMonth() + 1) + "/" + u.getFullYear());
t._descContent.setText(s.commentId);
t._rulesContent.setText(n[s.gameTypeId] || "");
A && (A.delClassNames("selected"), A = null);
z.hide();
Y.disable();
L.playerData.identification.hasConsoleRight || (e = e.filter(function (e) {
  var t = g.indexOf(e.id) !== -1;
  return !t;
}));
C && (e = e.filter(function (e) {
  return e.charactersCount > 0;
}));
T || (e = e.filter(function (e) {
  return S.indexOf(e.id) !== -1;
}));
M && (e = e.filter(function (e) {
  return M.indexOf(e.id) !== -1;
}));
L.serversData.syncServerStaticData(function (t) {
  if (t) {
    return console.error("ServerRow getServerStaticData error", t);
  }
  var i = L.serversData.staticContent;
  e.sort(function (e, t) {
    if (!i.data[e.id]) {
      return 1;
    }
    if (!i.data[t.id]) {
      return -1;
    }
    var n = i.data[e.id].populationId,
      o = i.data[t.id].populationId,
      a = i.populations[n].weight,
      s = i.populations[o].weight,
      r = a - s;
    return 0 !== r ? r : t.id - e.id;
  });
  for (var n = 0, a = Math.max(e.length, E.length); n < a; n += 1) {
    var s = e[n],
      r = E[n];
    s ? r ? (r.setServer(s), r.show()) : o(s, E.length % 2) : r && r.hide();
  }
  !A && e[0] && E[0].emit("tap");
});
E.push(i);
i.on("tap", function () {
  A && A.delClassNames("selected");
  i.addClassNames("selected");
  A = i;
  z.setServer(i.data);
  z.show();
  i.data.isSelectable ? Y.enable() : Y.disable();
});
A && A.delClassNames("selected");
i.addClassNames("selected");
A = i;
z.setServer(i.data);
z.show();
i.data.isSelectable ? Y.enable() : Y.disable();
R.createChild("div", {
  className: "findFriendLabel",
  text: d("ui.sersel.findFriend") + ": "
});
O = R.appendChild(new h({
  className: "inputFriend",
  attr: {
    type: "text",
    id: "inputFriend",
    placeholder: "nickname#1234"
  }
}, t));
e(R, ["okBtn", "btn"], t);
e(R, ["clearBtn", "btn"], function () {
  O && (O.setValue(""), M = null, n());
});
F.createChild("div", {
  className: ["listHeadBox", "empty"]
});
F.createChild("div", {
  className: ["listHeadBox", "name"],
  text: d("ui.common.name")
});
F.createChild("div", {
  className: ["listHeadBox", "population"],
  text: d("ui.sersel.population")
});
F.createChild("div", {
  className: ["listHeadBox", "status"],
  text: d("ui.sersel.state")
});
_();
n();
v();
n();
Q.on("tap", function () {
  L.serversData.pickUpOneServerForMe();
});
this.on("open", function () {
  y = L.serversData.serversRawData;
  i();
  L.serversData.getAutoChosenServers(function (e, t) {
    e && console.warn(e);
    b = t || [];
    T = !1;
    G.delClassNames("selected");
    C = !1;
    U.delClassNames("selected");
    S = [];
    for (var i = 0, o = b.length; i < o; i += 1) {
      S.push(b[i].id);
    }
    n();
    L.serversData.on("serversUpdate", n);
  });
});
this.on("close", function () {
  L.serversData.removeListener("serversUpdate", n);
});
f.on("AcquaintanceSearchErrorMessage", function (e) {
  var t = e.reason;
  t && L.openPopup({
    title: d("ui.common.error"),
    message: N[t].replace("%1", w)
  });
});
f.on("AcquaintanceServerListMessage", function (e) {
  M = e.servers;
  n();
});
L.on("TrustStatusMessage", function () {
  u.close(I.id);
});
y = L.serversData.serversRawData;
i();
L.serversData.getAutoChosenServers(function (e, t) {
  e && console.warn(e);
  b = t || [];
  T = !1;
  G.delClassNames("selected");
  C = !1;
  U.delClassNames("selected");
  S = [];
  for (var i = 0, o = b.length; i < o; i += 1) {
    S.push(b[i].id);
  }
  n();
  L.serversData.on("serversUpdate", n);
});
e && console.warn(e);
b = t || [];
T = !1;
G.delClassNames("selected");
C = !1;
U.delClassNames("selected");
S = [];
n();
L.serversData.on("serversUpdate", n);
M = e.servers;
n();
o(n, a);
e.exports = n;
a.call(this, "div", {
  className: ["ServerRow", "listRow"]
});
s(this);
t && this.addClassNames("odd");
this._DEFAULT_POPULATION_CLASSES = ["listBox", "listCell", "population"];
this._DEFAULT_NAME_CLASSES = ["listBox", "listCell", "name"];
this._flag = i.createChild("div", {
  className: "flagImage"
});
this._serverName = this.createChild("div", {
  className: this._DEFAULT_NAME_CLASSES
});
this._population = this.createChild("div", {
  className: this._DEFAULT_POPULATION_CLASSES
});
this._status = n.createChild("div", {
  className: "statusImage"
});
this.setServer(e);
o(n, a);
e.exports = n;
n.prototype.setServer = function (e) {
  if (!e) {
    return this._flag.hide(), this._serverName.setText(""), this._population.setText(""), void this._status.hide();
  }
  var t = this;
  this.id = e.id;
  this.data = e;
  var i = window.gui.serversData.staticContent,
    n = window.gui.serversData.staticContent.data[this.id] || {};
  this._flag.show();
  this._status.show();
  this._serverName.setText(n.nameId || e.id);
  this._serverName.setClassNames(this._DEFAULT_NAME_CLASSES);
  1 === n.gameTypeId && this._serverName.setClassNames(this._DEFAULT_NAME_CLASSES, "heroic");
  this._population.setClassNames(this._DEFAULT_POPULATION_CLASSES, "popu_", n.populationId);
  var o = i.populations[n.populationId] || {};
  this._population.setText(o.nameId || "n/a");
  this._status.setClassNames(["statusImage", "status_" + e.status]);
  r.preloadImage("gfx/flags/flag_" + n.communityId + ".png", function (e) {
    t._flag.setStyle("backgroundImage", e);
  });
};
this.id = e.id;
this.data = e;
this._flag.show();
this._status.show();
this._serverName.setText(n.nameId || e.id);
this._serverName.setClassNames(this._DEFAULT_NAME_CLASSES);
1 === n.gameTypeId && this._serverName.setClassNames(this._DEFAULT_NAME_CLASSES, "heroic");
this._population.setClassNames(this._DEFAULT_POPULATION_CLASSES, "popu_", n.populationId);
this._population.setText(o.nameId || "n/a");
this._status.setClassNames(["statusImage", "status_" + e.status]);
r.preloadImage("gfx/flags/flag_" + n.communityId + ".png", function (e) {
  t._flag.setStyle("backgroundImage", e);
});
n && n.delClassNames("selected");
n = e;
e && (e.addClassNames("selected"), u = e.data.id, o.selectBtn.enable(), o.createCharBtn.enable());
n.setServer(o);
o && o.id === u && o.isSelectable && e(n);
h <= 0 ? f.disable() : f.enable();
h >= t.length - d ? _.disable() : _.enable();
i.on("tap", function () {
  e(this);
});
p.push(i);
f.on("disabled", function () {
  this.addClassNames("disabled");
});
f.on("enabled", function () {
  this.delClassNames("disabled");
});
_.on("disabled", function () {
  this.addClassNames("disabled");
});
_.on("enabled", function () {
  this.delClassNames("disabled");
});
y.disable();
o.createCharBtn.disable();
window.gui.serversData.connectedServerId === u ? (window.dofus.sendMessage("CharactersListRequestMessage"), r.close(o.id)) : window.gui.serversData.selectServer(u);
this.selectBtn = y;
y.disable();
this.createCharBtn = w.appendChild(new a({
  className: ["greenButton", "createCharacterBtn"],
  text: c("ui.charsel.createCharacter")
}, function () {
  r.close(o.id);
  r.open("serverSimpleSelection");
}));
window.gui.on("TrustStatusMessage", function () {
  r.close(o.id);
});
this.on("open", function () {
  var e = window.gui.serversData.serversWithMyCharacter;
  if (!u) {
    var i = e[0] || {};
    u = i.id;
  }
  h = 0;
  f.disable();
  e.length <= d && _.disable();
  t();
  window.gui.serversData.on("serversUpdate", t);
  o.consoleButton.toggleDisplay(window.gui.playerData.identification.hasConsoleRight);
});
this.on("close", function () {
  window.gui.serversData.removeListener("serversUpdate", t);
});
this.consoleButton = m.appendChild(new a({
  className: ["consoleButton"],
  hidden: !0
}, function () {
  r["switch"]("adminConsole");
}));
r.close(o.id);
r.open("serverSimpleSelection");
h = 0;
f.disable();
e.length <= d && _.disable();
t();
window.gui.serversData.on("serversUpdate", t);
o.consoleButton.toggleDisplay(window.gui.playerData.identification.hasConsoleRight);
o(n, s);
e.exports = n;
n.prototype.backButtonClose = function () {
  this.close();
  window.dofus.disconnect();
};
this.close();
window.dofus.disconnect();
a.call(this, "div", {
  className: "ServerBox"
});
s(this);
this._SERVER_STATUS = {
  0: r("ui.server.state.unknown"),
  1: r("ui.server.state.offline"),
  2: r("ui.server.state.starting"),
  3: r("ui.server.state.online"),
  4: r("ui.server.state.nojoin"),
  5: r("ui.server.state.saving"),
  6: r("ui.server.state.stoping"),
  7: r("ui.server.state.full")
};
this._completions = [];
this._title = this.createChild("div", {
  className: "title"
});
this._content = this.createChild("div", {
  className: "content"
});
this._placeholder = this.createChild("div", {
  className: "placeholderDiv"
});
this._content.createChild("div", {
  className: "selection"
});
this._image = this._content.createChild("div", {
  className: "image"
});
this._statusIcon = i.createChild("div", {
  className: "statusIcon"
});
this._statusText = i.createChild("div", {
  className: "statusText"
});
this.setServer(e);
o(n, a);
e.exports = n;
n.prototype.setServer = function (e) {
  var t = this;
  if (this.delClassNames("placeHolder"), this._placeholder.hide(), !e) {
    return this.addClassNames("placeHolder"), this.disable(), this._content.hide(), this._placeholder.show(), void this._title.setText("");
  }
  this._title.setText(e._name || e.id);
  for (var i = 0, n = this._completions.length; i < n; i += 1) {
    var o = this._completions[i];
    i < e.charactersCount ? o.addClassNames("on") : o.delClassNames("on");
  }
  var a = 1 === e._gameTypeId;
  this._heroicIcon.toggleDisplay(a);
  this.data = e;
  e.isSelectable ? this.enable() : this.disable();
  this._statusIcon.setClassNames(["statusIcon", "status_" + e.status]);
  this._statusText.setText(this._SERVER_STATUS[e.status || 0]);
  this._content.show();
  l.getServerImage(e.id, function (e, i) {
    return e ? console.error(e) : void t._image.setStyle("backgroundImage", i);
  });
};
this._heroicIcon.toggleDisplay(a);
this.data = e;
e.isSelectable ? this.enable() : this.disable();
this._statusIcon.setClassNames(["statusIcon", "status_" + e.status]);
this._statusText.setText(this._SERVER_STATUS[e.status || 0]);
this._content.show();
l.getServerImage(e.id, function (e, i) {
  return e ? console.error(e) : void t._image.setStyle("backgroundImage", i);
});
a.call(this, {
  className: "ServerSimpleSelectionWindow",
  title: c("ui.sersel.choseServer"),
  positionInfo: {
    left: "c",
    top: "c",
    width: 700,
    height: 400
  },
  hidden: !0
});
this.once("open", n.prototype._createContent);
o(n, a);
e.exports = n;
n.prototype._createContent = function () {
  var e = this,
    t = this.windowBody,
    i = t.createChild("div", {
      className: "bg"
    });
  d.preloadImage("gfx/illusUi/simpleServerChoiceIllu.png", function (e) {
    i.setStyle("backgroundImage", e);
  });
  var n = t.appendChild(new l(c("ui.sersel.autoChoice"), {
    className: "autoSelectServerBtn"
  }));
  n.on("tap", function () {
    window.gui.serversData.pickUpOneServerForMe();
  });
  var o = t.createChild("div", {
      className: "manualCreationDiv"
    }),
    a = o.appendChild(new l(c("ui.sersel.manualChoice"), {
      className: "manualCreationBtn"
    }));
  a.on("tap", function () {
    s.open("serverListSelection");
  });
  this.on("close", function (e) {
    e && e.validated || s.open("serverSelection");
  });
  window.gui.on("TrustStatusMessage", function () {
    s.close(e.id, {
      validated: !0
    });
  });
  this.consoleButton = t.appendChild(new r({
    className: ["consoleButton"],
    hidden: !window.gui.playerData.identification.hasConsoleRight
  }, function () {
    s["switch"]("adminConsole");
  }));
};
n.prototype.backButtonClose = function () {
  this.close({
    validated: !1
  });
};
a.on("tap", function () {
  s.open("serverListSelection");
});
this.on("close", function (e) {
  e && e.validated || s.open("serverSelection");
});
window.gui.on("TrustStatusMessage", function () {
  s.close(e.id, {
    validated: !0
  });
});
this.consoleButton = t.appendChild(new r({
  className: ["consoleButton"],
  hidden: !window.gui.playerData.identification.hasConsoleRight
}, function () {
  s["switch"]("adminConsole");
}));
this.parentBody = null;
this.zaapBody = this.windowBody.createChild("div", {
  className: ["teleporterBody", "zaapBody"]
});
this.subwayBody = this.windowBody.createChild("div", {
  className: ["teleporterBody", "subwayBody"]
});
this.createTabs(this.zaapBody, [{
  title: _("ui.zaap.zaap"),
  name: "Zaap"
}, {
  title: _("ui.zaap.prism"),
  name: "Prism"
}]);
this.createTabs(this.subwayBody, [{
  title: _("ui.map.craftHouse"),
  name: "CraftHouse"
}, {
  title: _("ui.map.bidHouse"),
  name: "BidHouse"
}, {
  title: _("ui.common.misc"),
  name: "Misc"
}]);
this.createFooter();
window.gui.on("ZaapListMessage", function (t) {
  e.setContent(t);
});
window.gui.on("TeleportDestinationsListMessage", function (t) {
  e.setContent(t);
});
o[i] = n;
T.setValue("zaap-" + e + "-" + t, o);
u(n, h);
e.exports = n;
n.prototype.createTabs = function (e, t) {
  var i = this;
  e.tabs = new y();
  e.appendChild(e.tabs);
  e.panels = e.createChild("div", {
    className: "panels"
  });
  e.panelCollection = {};
  t.forEach(function (t) {
    var n = t.name,
      o = e.panelCollection[n] = e.panels.createChild("div", {
        className: ["panel", n]
      });
    e.tabs.addTab(t.title, o);
    o.on("open", function () {
      this.selectedMapId ? i.buttonOk.enable() : i.buttonOk.disable();
    });
    i.createTable(o);
  });
};
n.prototype.createTable = function (e) {
  function t(t) {
    e.selectedTeleporterType = t.teleporterType;
    e.selectedMapId = t.mapId;
    i.buttonOk.enable();
  }
  var i = this,
    n = _("ui.zaap.destination") + _("ui.common.colon"),
    o = _("ui.common.area") + " (" + _("ui.common.subarea") + ")";
  e.table = e.appendChild(new w({
    colIds: ["favorite", "saved", "destination", "coordinates", "cost"],
    colCount: 5,
    highlightable: !0,
    disableAutoSelect: !0,
    headerContent: ["", "", n + o, _("ui.common.coordinatesSmall"), _("ui.common.cost")],
    onRowTap: t
  }));
};
n.prototype.createFooter = function () {
  var e = this,
    t = this.windowBody.createChild("div", {
      className: "footer"
    });
  this.buttonOk = t.appendChild(new m({
    className: "greenButton",
    text: _("ui.common.validation")
  }));
  this.buttonOk.on("tap", function () {
    var t = e.parentBody.tabs.getCurrentTab().target;
    window.dofus.sendMessage("TeleportRequestMessage", {
      teleporterType: t.selectedTeleporterType,
      mapId: t.selectedMapId
    });
  });
  this.nbKamas = t.createChild("div", {
    className: "nbKamas"
  });
};
n.prototype.setContent = function (e) {
  switch (g.openDialog(this.id), this.setClassNames("window", "teleporterListWindow"), this.buttonOk.disable(), l = window.gui.playerData.inventory.kamas, c = window.gui.playerData.position.mapId, d = window.gui.playerData.position.subArea.nameId, e.teleporterType) {
    case b.TELEPORTER_ZAAP:
    case b.TELEPORTER_PRISM:
      this.setupZaapBody(e);
      break;
    case b.TELEPORTER_SUBWAY:
      this.setupSubwayBody(e);
  }
  this.nbKamas.setText(v.kamasToString(l, ""));
};
n.prototype.setupZaapBody = function (e) {
  var t, i, n;
  n = _(e.teleporterType === b.TELEPORTER_ZAAP ? "ui.zaap.zaap" : "ui.zaap.prism");
  this.windowTitle.setText(n + " - " + d);
  c === e.spawnMapId ? this.windowTitle.addClassNames("saved") : this.windowTitle.delClassNames("saved");
  this.parentBody = this.zaapBody;
  this.zaapBody.show();
  this.subwayBody.hide();
  for (t in this.zaapBody.panelCollection) {
    i = this.zaapBody.panelCollection[t];
    i.table && (i.table.clearContent(), i.selectedTeleporterType = null, i.selectedMapId = null);
  }
  var o = e._subAreas.length,
    s = [];
  for (t = 0; t < o; t += 1) {
    var l = e._subAreas[t],
      u = e._maps[t],
      h = e.destTeleporterType[t],
      p = a(h, A, u.id);
    s.push({
      name: l.areaName + " (" + l.name + ")",
      category: A,
      type: h,
      posX: u.posX,
      posY: u.posY,
      mapId: u.id,
      teleporterCost: e.costs[t],
      saved: u.id === e.spawnMapId,
      isFavorite: p
    });
  }
  for (t = 0; t < o; t += 1) {
    var m = s[t],
      f = m.type === b.TELEPORTER_ZAAP || m.type === b.TELEPORTER_PRISM;
    if (m.mapId !== c && f) {
      var g;
      m.type === b.TELEPORTER_ZAAP && (g = this.zaapBody.panelCollection.Zaap);
      m.type === b.TELEPORTER_PRISM && (g = this.zaapBody.panelCollection.Prism);
      this._addTeleporter({
        parentPanel: g,
        teleporterType: m.type,
        category: m.category,
        destinationName: m.name,
        posX: m.posX,
        posY: m.posY,
        mapId: m.mapId,
        teleporterCost: m.teleporterCost,
        saved: m.saved,
        isFavorite: m.isFavorite
      });
    }
  }
  for (t in this.zaapBody.panelCollection) {
    this.zaapBody.panelCollection.hasOwnProperty(t) && this.zaapBody.panelCollection[t].table.sort(r);
  }
  this.setupTabs();
};
n.prototype.setupSubwayBody = function (e) {
  var t, i, n;
  this.windowTitle.setText(_("ui.zaap.zaapi") + " - " + d);
  c === e.spawnMapId ? this.windowTitle.addClassNames("saved") : this.windowTitle.delClassNames("saved");
  this.parentBody = this.subwayBody;
  this.zaapBody.hide();
  this.subwayBody.show();
  for (t in this.subwayBody.panelCollection) {
    i = this.subwayBody.panelCollection[t];
    i.table && (i.table.clearContent(), i.selectedTeleporterType = null, i.selectedMapId = null);
  }
  var o = e._hints.length,
    s = [];
  for (t = 0; t < o; t += 1) {
    n = e._hints[t];
    var l = n.realMapId || n.mapId,
      u = a(b.TELEPORTER_SUBWAY, n.categoryId, l);
    s.push({
      name: n.nameId,
      category: n.categoryId,
      posX: n.x,
      posY: n.y,
      mapId: l,
      teleporterCost: n.teleporterCost,
      saved: n.mapId === e.spawnMapId,
      isFavorite: u
    });
  }
  for (t = 0; t < o; t += 1) {
    if (n = s[t], n.mapId !== c) {
      var h;
      h = n.category === C ? this.subwayBody.panelCollection.CraftHouse : n.category === I ? this.subwayBody.panelCollection.BidHouse : this.subwayBody.panelCollection.Misc;
      this._addTeleporter({
        parentPanel: h,
        teleporterType: b.TELEPORTER_SUBWAY,
        destinationName: n.name,
        category: n.category,
        posX: n.posX,
        posY: n.posY,
        mapId: n.mapId,
        teleporterCost: n.teleporterCost,
        saved: n.saved,
        isFavorite: n.isFavorite
      });
    }
  }
  for (t in this.subwayBody.panelCollection) {
    this.subwayBody.panelCollection.hasOwnProperty(t) && this.subwayBody.panelCollection[t].table.sort(r);
  }
  this.setupTabs();
};
n.prototype._addTeleporter = function (e) {
  var t = e.parentPanel.table,
    i = e.teleporterCost,
    n = e.isFavorite,
    a = new p("div");
  a.createChild("div", {
    className: "destinationName",
    text: e.destinationName
  });
  var c = a.appendChild(new f({
      type: "zaap",
      x: e.posX,
      y: e.posY
    })),
    d = new p("div"),
    u = d.createChild("div", {
      className: "favoriteButton"
    });
  M(u);
  u.toggleClassName("fullStar", n);
  var h = t.addRow({
    favorite: d,
    saved: e.saved ? new p("div", {
      className: "saved"
    }) : null,
    destination: a,
    coordinates: e.posX + "," + e.posY,
    cost: v.kamasToString(i)
  }, {
    teleporterType: e.teleporterType,
    category: e.category,
    mapId: e.mapId,
    isFavorite: n,
    name: e.destinationName
  });
  l < i && h.addClassNames("disabled");
  c.myTable = t;
  c.myRow = h;
  c.on("tap", o);
  u.on("tap", function () {
    n = !n;
    s(e.teleporterType, e.category, e.mapId, n);
    h.isFavorite = n;
    u.toggleClassName("fullStar", n);
    t.sort(r);
  });
};
n.prototype.setupTabs = function () {
  var e = this.parentBody.tabs,
    t = e.getTabsMap(),
    i = !1;
  for (var n in t) {
    var o = t[n];
    o.target.table.getRows().length <= 0 ? o.tab.disable() : (o.tab.enable(), i || (e.openTab(n), i = !0));
  }
  if (!i) {
    var a = e.getFirstTab();
    a.tab.enable();
    e.openFirstTab();
  }
};
e.tabs = new y();
e.appendChild(e.tabs);
e.panels = e.createChild("div", {
  className: "panels"
});
e.panelCollection = {};
t.forEach(function (t) {
  var n = t.name,
    o = e.panelCollection[n] = e.panels.createChild("div", {
      className: ["panel", n]
    });
  e.tabs.addTab(t.title, o);
  o.on("open", function () {
    this.selectedMapId ? i.buttonOk.enable() : i.buttonOk.disable();
  });
  i.createTable(o);
});
e.tabs.addTab(t.title, o);
o.on("open", function () {
  this.selectedMapId ? i.buttonOk.enable() : i.buttonOk.disable();
});
i.createTable(o);
e.selectedTeleporterType = t.teleporterType;
e.selectedMapId = t.mapId;
i.buttonOk.enable();
this.buttonOk = t.appendChild(new m({
  className: "greenButton",
  text: _("ui.common.validation")
}));
this.buttonOk.on("tap", function () {
  var t = e.parentBody.tabs.getCurrentTab().target;
  window.dofus.sendMessage("TeleportRequestMessage", {
    teleporterType: t.selectedTeleporterType,
    mapId: t.selectedMapId
  });
});
this.nbKamas = t.createChild("div", {
  className: "nbKamas"
});
n = _(e.teleporterType === b.TELEPORTER_ZAAP ? "ui.zaap.zaap" : "ui.zaap.prism");
this.windowTitle.setText(n + " - " + d);
c === e.spawnMapId ? this.windowTitle.addClassNames("saved") : this.windowTitle.delClassNames("saved");
this.parentBody = this.zaapBody;
this.zaapBody.show();
this.subwayBody.hide();
i = this.zaapBody.panelCollection[t];
i.table && (i.table.clearContent(), i.selectedTeleporterType = null, i.selectedMapId = null);
m.type === b.TELEPORTER_ZAAP && (g = this.zaapBody.panelCollection.Zaap);
m.type === b.TELEPORTER_PRISM && (g = this.zaapBody.panelCollection.Prism);
this._addTeleporter({
  parentPanel: g,
  teleporterType: m.type,
  category: m.category,
  destinationName: m.name,
  posX: m.posX,
  posY: m.posY,
  mapId: m.mapId,
  teleporterCost: m.teleporterCost,
  saved: m.saved,
  isFavorite: m.isFavorite
});
this.windowTitle.setText(_("ui.zaap.zaapi") + " - " + d);
c === e.spawnMapId ? this.windowTitle.addClassNames("saved") : this.windowTitle.delClassNames("saved");
this.parentBody = this.subwayBody;
this.zaapBody.hide();
this.subwayBody.show();
i = this.subwayBody.panelCollection[t];
i.table && (i.table.clearContent(), i.selectedTeleporterType = null, i.selectedMapId = null);
h = n.category === C ? this.subwayBody.panelCollection.CraftHouse : n.category === I ? this.subwayBody.panelCollection.BidHouse : this.subwayBody.panelCollection.Misc;
this._addTeleporter({
  parentPanel: h,
  teleporterType: b.TELEPORTER_SUBWAY,
  destinationName: n.name,
  category: n.category,
  posX: n.posX,
  posY: n.posY,
  mapId: n.mapId,
  teleporterCost: n.teleporterCost,
  saved: n.saved,
  isFavorite: n.isFavorite
});
M(u);
u.toggleClassName("fullStar", n);
l < i && h.addClassNames("disabled");
c.myTable = t;
c.myRow = h;
c.on("tap", o);
u.on("tap", function () {
  n = !n;
  s(e.teleporterType, e.category, e.mapId, n);
  h.isFavorite = n;
  u.toggleClassName("fullStar", n);
  t.sort(r);
});
n = !n;
s(e.teleporterType, e.category, e.mapId, n);
h.isFavorite = n;
u.toggleClassName("fullStar", n);
t.sort(r);
a.tab.enable();
e.openFirstTab();
_.addClassNames("depositButton");
_.on("tap", function () {
  var t = e.kamasValue;
  if (t) {
    var i = p.getWindow("exchangeStorage");
    i.closeMinMaxSelector();
    d.positionNextTo(g, _);
    r = "kamas";
    g.open({
      min: 1,
      max: t
    });
  }
});
this.on("open", function (t) {
  this.exchangeType = t.exchangeType;
  this.exchangeType === a.STORAGE && e.addFilters([l.unlinkedItemsFilter]);
  e.filterList();
  e.resetDisplay();
  this.windowBody.appendChild(_);
  _.toggleDisplay(t.exchangeType !== a.MOUNT);
  _.setEnable(!!e.kamasValue);
});
this.on("close", function () {
  this.exchangeType === a.STORAGE && e.removeFilter(l.unlinkedItemsFilter);
  g.closeMinMax();
  this.exchangeType = -1;
});
this.on("kamasUpdated", function (e) {
  _.isVisible() && _.setEnable(!!e);
});
this.on("slot-doubletap", i);
this.on("leftArrow-tap", function (t) {
  window.gui.openContextualMenu("storage", {
    toInventory: !1,
    viewer: e
  }, {
    x: t.x,
    y: t.y
  });
});
u(this, ["exchangeStorage"]);
this.on("drop", function (e, t, n) {
  i(e, n.x, n.y, !0);
});
i.closeMinMaxSelector();
d.positionNextTo(g, _);
r = "kamas";
g.open({
  min: 1,
  max: t
});
this.exchangeType = t.exchangeType;
this.exchangeType === a.STORAGE && e.addFilters([l.unlinkedItemsFilter]);
e.filterList();
e.resetDisplay();
this.windowBody.appendChild(_);
_.toggleDisplay(t.exchangeType !== a.MOUNT);
_.setEnable(!!e.kamasValue);
this.exchangeType === a.STORAGE && e.removeFilter(l.unlinkedItemsFilter);
g.closeMinMax();
this.exchangeType = -1;
r(n, h);
e.exports = n;
n.prototype.closeMinMaxSelector = function () {
  this.minMaxSelector.closeMinMax();
};
b.removeItems(e);
w.exchangeType !== r.MOUNT && b.refreshSlotGauge();
T.addClassNames("withdrawButton");
T.on("tap", function () {
  var e = b.kamasValue;
  if (e) {
    var t = f.getWindow("exchangeInventory");
    t.closeMinMaxSelector();
    h.positionNextTo(M, T);
    _ = "kamas";
    M.open({
      min: 1,
      max: e
    });
  }
});
this.on("open", function (e) {
  this.exchangeType = e.exchangeType;
  c = window.gui.playerData.belongings;
  var t;
  switch (this.exchangeType) {
    case r.TAXCOLLECTOR:
      t = l("ui.common.taxCollector");
      break;
    case r.STORAGE:
      b.setBarLabel(l("tablet.common.slots") + ":");
      t = l("ui.common.storage");
      break;
    case r.MOUNT:
      t = l("ui.common.ride");
      break;
    default:
      console.error("Unexpected exchangeType value:", e.exchangeType);
      t = l("ui.common.storage");
  }
  this.setTitle(t);
  this.windowBody.appendChild(T);
  T.setEnable(!!b.kamasValue);
  T.toggleDisplay(e.exchangeType !== r.MOUNT);
  b.kamas.toggleClassName("hiddenKamas", e.exchangeType === r.MOUNT);
});
this.on("close", function () {
  this.exchangeType = -1;
  M.closeMinMax();
  b.unloadContent();
});
this.on("kamasUpdated", function (e) {
  T.isVisible() && T.setEnable(!!e);
});
this.on("rightArrow-tap", function (e) {
  window.gui.openContextualMenu("storage", {
    toInventory: !0,
    viewer: b
  }, {
    x: e.x,
    y: e.y
  });
});
this.on("slot-doubletap", t);
s(this, ["exchangeInventory"]);
this.on("drop", function (e, i, n) {
  t(e, n.x, n.y, !0);
});
a.on("ExchangeStartedWithStorageMessage", function (e) {
  b.setMaxWeight(e.storageMaxSlot);
  y = e.exchangeType === r.STORAGE && e.storageMaxSlot > 2e9;
  f.openDialog(["exchangeInventory", "exchangeStorage"], e);
});
a.on("ExchangeStartedMountStockMessage", function (e) {
  f.openDialog(["exchangeInventory", "exchangeStorage"], {
    exchangeType: r.MOUNT
  });
  c.setMountItems(e.objectsInfos);
  d.createItemInstances(e.objectsInfos, function (e, t) {
    return e ? console.error(e) : void b.setItemList(t.map);
  });
});
a.on("ExchangeStartedMessage", function (e) {
  e.exchangeType === r.TAXCOLLECTOR && f.openDialog(["exchangeInventory", "exchangeStorage"], e);
});
a.on("StorageInventoryContentMessage", function (e) {
  y && c.setBankItems(e.objects);
  b.setKamas(e.kamas);
  d.createItemInstances(e.objects, function (e, t) {
    return e ? console.error(e) : (b.setItemList(t.map), void b.refreshSlotGauge());
  });
});
a.on("StorageKamasUpdateMessage", function (e) {
  b.setKamas(e.kamasTotal);
});
a.on("ExchangeWeightMessage", function (e) {
  b.setWeight(e.currentWeight, e.maxWeight);
});
a.on("StorageObjectUpdateMessage", function (e) {
  i([e.object]);
});
a.on("StorageObjectsUpdateMessage", function (e) {
  i(e.objectList);
});
a.on("StorageObjectRemoveMessage", function (e) {
  n([e.objectUID]);
});
a.on("StorageObjectsRemoveMessage", function (e) {
  n(e.objectUIDList);
});
t.closeMinMaxSelector();
h.positionNextTo(M, T);
_ = "kamas";
M.open({
  min: 1,
  max: e
});
this.exchangeType = e.exchangeType;
c = window.gui.playerData.belongings;
b.setBarLabel(l("tablet.common.slots") + ":");
t = l("ui.common.storage");
console.error("Unexpected exchangeType value:", e.exchangeType);
t = l("ui.common.storage");
this.setTitle(t);
this.windowBody.appendChild(T);
T.setEnable(!!b.kamasValue);
T.toggleDisplay(e.exchangeType !== r.MOUNT);
b.kamas.toggleClassName("hiddenKamas", e.exchangeType === r.MOUNT);
this.exchangeType = -1;
M.closeMinMax();
b.unloadContent();
b.setMaxWeight(e.storageMaxSlot);
y = e.exchangeType === r.STORAGE && e.storageMaxSlot > 2e9;
f.openDialog(["exchangeInventory", "exchangeStorage"], e);
f.openDialog(["exchangeInventory", "exchangeStorage"], {
  exchangeType: r.MOUNT
});
c.setMountItems(e.objectsInfos);
d.createItemInstances(e.objectsInfos, function (e, t) {
  return e ? console.error(e) : void b.setItemList(t.map);
});
y && c.setBankItems(e.objects);
b.setKamas(e.kamas);
d.createItemInstances(e.objects, function (e, t) {
  return e ? console.error(e) : (b.setItemList(t.map), void b.refreshSlotGauge());
});
c(n, m);
e.exports = n;
n.prototype.closeMinMaxSelector = function () {
  this.minMaxSelector.closeMinMax();
};
_.call(this, {
  className: "tradeItemWindow",
  noCloseButton: !0,
  fixed: !0,
  positionInfo: {
    width: w,
    height: b
  }
});
this._setupEvents();
this.mode = "";
this.item = null;
this.msg = null;
this.itemDescription = null;
this.settingBox = null;
this.selection = null;
this.tradeItemConfirm = null;
this.isTradePending = !1;
this.tradeTimeout = null;
this.on("open", function (e) {
  switch (this.tradeItemConfirm = null, this.isTradePending = !1, this.tradeTimeout = null, this.itemDescription || this._createDom(), this.buyHardSoftDiv.hide(), this.msg._messageType) {
    case "ExchangeStartOkNpcShopMessage":
      this.settingBox = this.exchangeBox;
      v.arrangeOpeningWindow(this.id, {
        rightOf: "tradeStorage",
        height: b
      });
      break;
    case "ExchangeStartedBidSellerMessage":
      this.settingBox = this.bidHouseSellerBox;
      this.settingBox.setDescriptorData(this.msg.sellerDescriptor);
      v.arrangeOpeningWindow(this.id, {
        rightOf: "tradeStorage",
        height: M
      });
      break;
    case "ExchangeStartedBidBuyerMessage":
      this.settingBox = this.bidHouseBuyerBox;
      this.settingBox.setDescriptorData(this.msg.buyerDescriptor);
      this.buyHardSoftDiv.show();
      v.arrangeOpeningWindow(this.id, {
        rightOf: "bidHouseShop",
        height: "100%"
      });
      break;
    default:
      return;
  }
  this._setContent(e.mode, e.item, e.currency);
});
this.on("close", function () {
  this.item = null;
  this.selection = null;
  this.isTradePending = !1;
  window.clearTimeout(this.tradeTimeout);
  this._closeTradeConfirmWindow();
});
this.on("closed", function () {
  this.settingBox.hide();
});
this.settingBox = this.exchangeBox;
v.arrangeOpeningWindow(this.id, {
  rightOf: "tradeStorage",
  height: b
});
this.settingBox = this.bidHouseSellerBox;
this.settingBox.setDescriptorData(this.msg.sellerDescriptor);
v.arrangeOpeningWindow(this.id, {
  rightOf: "tradeStorage",
  height: M
});
this.settingBox = this.bidHouseBuyerBox;
this.settingBox.setDescriptorData(this.msg.buyerDescriptor);
this.buyHardSoftDiv.show();
v.arrangeOpeningWindow(this.id, {
  rightOf: "bidHouseShop",
  height: "100%"
});
this.item = null;
this.selection = null;
this.isTradePending = !1;
window.clearTimeout(this.tradeTimeout);
this._closeTradeConfirmWindow();
h(n, _);
e.exports = n;
n.minWidth = w;
n.prototype._setupEvents = function () {
  var e = this,
    t = window.gui;
  l.on("ExchangeStartOkNpcShopMessage", function (t) {
    e.msg = t;
    o(t.tokenId, function (e) {
      e && (t.token = e);
      v.openDialog(["tradeInventory", "tradeStorage"], t);
    });
  });
  l.on("ExchangeStartedBidSellerMessage", function (t) {
    e.msg = t;
    v.openDialog(["tradeInventory", "tradeStorage"], t);
  });
  l.on("ExchangeStartedBidBuyerMessage", function (t) {
    e.msg = t;
    v.openDialog(["wallet", "bidHouseShop"], t);
  });
  var i = {};
  i[g.REQUEST_IMPOSSIBLE] = d("ui.exchange.cantExchange");
  i[g.REQUEST_CHARACTER_OCCUPIED] = d("ui.exchange.cantExchangeCharacterOccupied");
  i[g.REQUEST_CHARACTER_JOB_NOT_EQUIPED] = d("ui.exchange.cantExchangeCharacterJobNotEquiped");
  i[g.REQUEST_CHARACTER_TOOL_TOO_FAR] = d("ui.craft.notNearCraftTable");
  i[g.REQUEST_CHARACTER_OVERLOADED] = d("ui.exchange.cantExchangeCharacterOverloaded");
  i[g.REQUEST_CHARACTER_NOT_SUSCRIBER] = d("ui.exchange.cantExchangeCharacterNotSuscriber");
  i[g.REQUEST_CHARACTER_RESTRICTED] = d("ui.exchange.cantExchangeCharacterRestricted");
  i[g.BUY_ERROR] = d("ui.exchange.cantExchangeBuyError");
  i[g.SELL_ERROR] = d("ui.exchange.cantExchangeSellError");
  i[g.MOUNT_PADDOCK_ERROR] = d("ui.exchange.cantExchangeMountPaddockError");
  i[g.BID_SEARCH_ERROR] = d("ui.bidhouse.itemNotInBigStore");
  i[g.REQUEST_RESTRICTED_AREA] = d("ui.popup.bidhouseDenied");
  l.on("ExchangeErrorMessage", function (n) {
    var o = i[n.errorType];
    if (!e._concludeTrade(!1, o)) {
      if (!o) {
        return console.error("ExchangeErrorMessage: no error message for type", n.errorType);
      }
      t.openSimplePopup(o);
    }
  });
  l.on("ObjectErrorMessage", function (t) {
    t.reason === f.INVENTORY_FULL && e._concludeTrade(!1);
  });
  l.on("exchangeBidHouseBuyError", function () {
    e._concludeTrade(!1, d("tablet.purchaseInHardCcyError"));
  });
  l.on("exchangeHumanBuyError", function () {
    e._concludeTrade(!1, d("tablet.purchaseInHardCcyError"));
  });
  l.on("exchangeBidHouseBuySuccess", function () {
    this.send("moneyGoultinesAmountRequest");
  });
  l.on("exchangeHumanBuySuccess", function () {
    this.send("moneyGoultinesAmountRequest");
  });
  l.on("ExchangeBidHouseBuyResultMessage", function (t) {
    e._concludeTrade(t.bought, d("tablet.tradeItemFailed"));
  });
  l.on("ExchangeBuyOkMessage", function () {
    e._concludeTrade(!0);
    v.close(e.id);
  });
  l.on("ExchangeSellOkMessage", function () {
    e._concludeTrade(!0);
    v.close(e.id);
  });
  l.on("ExchangeBidHouseItemAddOkMessage", function () {
    e._concludeTrade(!0);
  });
};
n.prototype._beginTrade = function () {
  this.isTradePending = !0;
  this.tradeTimeout = window.setTimeout(function (e) {
    e._tradeTimedOut();
  }, T, this);
};
n.prototype._concludeTrade = function (e, t) {
  return !!this.tradeTimeout && (this.isTradePending = !1, window.clearTimeout(this.tradeTimeout), this.tradeTimeout = null, this._closeTradeConfirmWindow(), !e && t && window.gui.openSimplePopup(t), !0);
};
n.prototype._tradeTimedOut = function () {
  this._concludeTrade(!1, d("tablet.tradeItemTimeout"));
};
n.prototype.getCurrentItem = function () {
  return this.selection ? this.selection.item : this.item;
};
n.prototype.updateSelection = function (e) {
  if (e) {
    var t = window.gui.playerData.inventory;
    this.buySoftBtn.setEnable(t.kamas >= e.amountSoft);
    this.buySoftBtnLabel.setText(u.intToString(e.amountSoft));
    this.buyHardBtn.setEnable(!!e.amountHard);
    this.buyHardBtnLabel.setText(e.amountHard ? u.intToString(e.amountHard) : "");
    e.item !== this.itemDescription.item && this.itemDescription.displayItem(e.item);
  } else {
    this.buySoftBtn.disable();
    this.buyHardBtn.disable();
    var i = d("ui.common.buy");
    this.buySoftBtnLabel.setText(i);
    this.buyHardBtnLabel.setText(i);
    this._closeTradeConfirmWindow();
  }
  this.selection = e;
};
n.prototype.updateBidHouseBuyPriceRealtime = function (e, t) {
  if (this.tradeItemConfirm && !this.isTradePending) {
    var i = this.isHardCcyTrade ? t : e;
    if (i > this.initialPrice) {
      return this._closeTradeConfirmWindow();
    }
    this.currentPrice = i;
    this.tradeItemConfirm.updatePriceRealtime(i);
  }
};
n.prototype._confirmTrade = function (e, t) {
  this.isHardCcyTrade = !!e.amountHard;
  this.initialPrice = this.currentPrice = e.amountHard || e.amountSoft;
  this.tradeItemConfirm = v.getWindow("tradeItemConfirm");
  var i = this;
  this.tradeItemConfirm.confirmTrade(e, function (e) {
    e && (i._beginTrade(), t());
  });
};
n.prototype._closeTradeConfirmWindow = function () {
  this.tradeItemConfirm && (this.tradeItemConfirm = null, v.close("tradeItemConfirm"));
};
n.prototype._buyInGoultines = function () {
  var e = this,
    t = this.selection,
    i = t.item,
    n = t.amountHard,
    o = t.amountSoft,
    a = t.qty,
    s = n - window.gui.playerData.inventory.goultines;
  return s > 0 ? y.openNotEnoughHardCurrencyPopup(s) : void this._confirmTrade({
    itemInstance: i,
    amountHard: n,
    qty: a
  }, function () {
    window.dofus.send("exchangeBidHouseBuyRequest", {
      id: i.getProperty("id"),
      uid: i.objectUID,
      qty: a,
      amountHard: n,
      amountSoft: o
    });
    e._prepareKpi("ExchangeBidHouseBuyResultMessage");
  });
};
n.prototype._buyInKamas = function () {
  var e = this.selection,
    t = e.item,
    i = e.qty,
    n = this;
  this._confirmTrade({
    itemInstance: t,
    amountSoft: e.amountSoft,
    qty: i
  }, function () {
    window.dofus.sendMessage("ExchangeBidHouseBuyMessage", {
      uid: t.objectUID,
      qty: i,
      price: n.currentPrice
    });
    n._prepareKpi("ExchangeBidHouseBuyResultMessage");
  });
};
n.prototype.buyItemFromNpc = function (e, t, i) {
  i = i || e.item.price;
  this._confirmTrade({
    itemInstance: e,
    amountSoft: i * t,
    qty: t,
    token: this.msg.token
  }, function () {
    window.dofus.sendMessage("ExchangeBuyMessage", {
      objectToBuyId: e.item.id,
      quantity: t
    });
  });
};
n.prototype.sellItemToNpc = function (e, t, i) {
  i = i || e.item.price;
  this._confirmTrade({
    isSell: !0,
    itemInstance: e,
    amountSoft: i * t,
    qty: t
  }, function () {
    window.dofus.sendMessage("ExchangeSellMessage", {
      objectToSellId: e.objectUID,
      quantity: t
    });
  });
};
n.prototype.sellInBidHouse = function (e, t, i, n) {
  return t <= 0 ? window.gui.openSimplePopup(d("ui.error.invalidPrice")) : void this._confirmTrade({
    isSell: !0,
    itemInstance: e,
    amountSoft: t,
    qty: i,
    fee: n
  }, function () {
    window.dofus.sendMessage("ExchangeObjectMovePricedMessage", {
      objectUID: e.objectUID,
      quantity: i,
      price: t
    });
  });
};
n.prototype.removeFromBidHouse = function (e, t, i) {
  window.gui.openConfirmPopup({
    title: d("ui.popup.warning"),
    message: d("ui.bidhouse.doUWithdrawItemBigStore", i + " x " + e.item.nameId, u.kamasToString(t / i)),
    cb: function (n) {
      n && window.dofus.sendMessage("ExchangeObjectMoveMessage", {
        objectUID: e.objectUID,
        quantity: -i,
        price: t
      });
    }
  });
};
n.prototype._createDom = function () {
  this.itemDescription = this.windowBody.appendChild(new p({
    showTitle: !0,
    withCraftBtn: !0
  }));
  v.makeMovable(this, this.itemDescription.getChildren()[0]);
  this.exchangeBox = this.windowBody.appendChild(new c());
  this.bidHouseSellerBox = this.windowBody.appendChild(new a());
  this.bidHouseBuyerBox = this.windowBody.appendChild(new s());
  this._createBuyHardSoftButtons();
  this.errorBox = this.windowBody.createChild("div", {
    className: "errorBox"
  });
  this.errorText = this.errorBox.createChild("div", {
    className: "errorText"
  });
};
n.prototype._createBuyHardSoftButtons = function () {
  var e = this.buyHardSoftDiv = this.windowBody.createChild("div", {
      className: "buyHardSoftButtons"
    }),
    t = this;
  this.buyHardBtn = e.appendChild(new r({
    className: ["button", "buyHardBtn"],
    text: d("ui.common.buy"),
    addIcon: !0
  }, function () {
    t._buyInGoultines();
  }));
  this.buyHardBtnLabel = this.buyHardBtn.getChildren()[0];
  this.buySoftBtn = e.appendChild(new r({
    className: ["greenButton", "buySoftBtn"],
    text: d("ui.common.buy"),
    addIcon: !0
  }, function () {
    t._buyInKamas();
  }));
  this.buySoftBtnLabel = this.buySoftBtn.getChildren()[0];
};
n.prototype.displayItem = function (e, t, i) {
  this.openState ? this._setContent(e, t, i) : v.open(this.id, {
    mode: e,
    item: t,
    currency: i
  });
};
n.prototype._setContent = function (e, t, i) {
  if (e !== this.mode || t !== this.item) {
    this.mode = e;
    this.item = t;
    var n = t.item || t,
      o = n.nameId + " (" + n.id + ") " + d("ui.common.short.level") + " " + n.level;
    this.errorBox.hide();
    this.setTitle(o);
    this.itemDescription.displayItem(t);
    this.settingBox.updateSettingBox(this, t, i);
    this.errorBox.isVisible() || this.settingBox.show();
  }
};
n.prototype.showError = function (e) {
  this.errorText.setHtml(e);
  this.errorBox.show();
  this.settingBox.hide();
};
n.prototype._prepareKpi = function (e) {
  if (!("ExchangeBidHouseBuyResultMessage" !== e || this.selection && this.selection.item)) {
    return console.error("TradeItemWindow._prepareKpi: this.selection is not valid");
  }
};
l.on("ExchangeStartOkNpcShopMessage", function (t) {
  e.msg = t;
  o(t.tokenId, function (e) {
    e && (t.token = e);
    v.openDialog(["tradeInventory", "tradeStorage"], t);
  });
});
l.on("ExchangeStartedBidSellerMessage", function (t) {
  e.msg = t;
  v.openDialog(["tradeInventory", "tradeStorage"], t);
});
l.on("ExchangeStartedBidBuyerMessage", function (t) {
  e.msg = t;
  v.openDialog(["wallet", "bidHouseShop"], t);
});
e.msg = t;
o(t.tokenId, function (e) {
  e && (t.token = e);
  v.openDialog(["tradeInventory", "tradeStorage"], t);
});
e && (t.token = e);
v.openDialog(["tradeInventory", "tradeStorage"], t);
e.msg = t;
v.openDialog(["tradeInventory", "tradeStorage"], t);
e.msg = t;
v.openDialog(["wallet", "bidHouseShop"], t);
i[g.REQUEST_IMPOSSIBLE] = d("ui.exchange.cantExchange");
i[g.REQUEST_CHARACTER_OCCUPIED] = d("ui.exchange.cantExchangeCharacterOccupied");
i[g.REQUEST_CHARACTER_JOB_NOT_EQUIPED] = d("ui.exchange.cantExchangeCharacterJobNotEquiped");
i[g.REQUEST_CHARACTER_TOOL_TOO_FAR] = d("ui.craft.notNearCraftTable");
i[g.REQUEST_CHARACTER_OVERLOADED] = d("ui.exchange.cantExchangeCharacterOverloaded");
i[g.REQUEST_CHARACTER_NOT_SUSCRIBER] = d("ui.exchange.cantExchangeCharacterNotSuscriber");
i[g.REQUEST_CHARACTER_RESTRICTED] = d("ui.exchange.cantExchangeCharacterRestricted");
i[g.BUY_ERROR] = d("ui.exchange.cantExchangeBuyError");
i[g.SELL_ERROR] = d("ui.exchange.cantExchangeSellError");
i[g.MOUNT_PADDOCK_ERROR] = d("ui.exchange.cantExchangeMountPaddockError");
i[g.BID_SEARCH_ERROR] = d("ui.bidhouse.itemNotInBigStore");
i[g.REQUEST_RESTRICTED_AREA] = d("ui.popup.bidhouseDenied");
l.on("ExchangeErrorMessage", function (n) {
  var o = i[n.errorType];
  if (!e._concludeTrade(!1, o)) {
    if (!o) {
      return console.error("ExchangeErrorMessage: no error message for type", n.errorType);
    }
    t.openSimplePopup(o);
  }
});
l.on("ObjectErrorMessage", function (t) {
  t.reason === f.INVENTORY_FULL && e._concludeTrade(!1);
});
l.on("exchangeBidHouseBuyError", function () {
  e._concludeTrade(!1, d("tablet.purchaseInHardCcyError"));
});
l.on("exchangeHumanBuyError", function () {
  e._concludeTrade(!1, d("tablet.purchaseInHardCcyError"));
});
l.on("exchangeBidHouseBuySuccess", function () {
  this.send("moneyGoultinesAmountRequest");
});
l.on("exchangeHumanBuySuccess", function () {
  this.send("moneyGoultinesAmountRequest");
});
l.on("ExchangeBidHouseBuyResultMessage", function (t) {
  e._concludeTrade(t.bought, d("tablet.tradeItemFailed"));
});
l.on("ExchangeBuyOkMessage", function () {
  e._concludeTrade(!0);
  v.close(e.id);
});
l.on("ExchangeSellOkMessage", function () {
  e._concludeTrade(!0);
  v.close(e.id);
});
l.on("ExchangeBidHouseItemAddOkMessage", function () {
  e._concludeTrade(!0);
});
e._concludeTrade(!0);
v.close(e.id);
e._concludeTrade(!0);
v.close(e.id);
this.isTradePending = !0;
this.tradeTimeout = window.setTimeout(function (e) {
  e._tradeTimedOut();
}, T, this);
this.buySoftBtn.setEnable(t.kamas >= e.amountSoft);
this.buySoftBtnLabel.setText(u.intToString(e.amountSoft));
this.buyHardBtn.setEnable(!!e.amountHard);
this.buyHardBtnLabel.setText(e.amountHard ? u.intToString(e.amountHard) : "");
e.item !== this.itemDescription.item && this.itemDescription.displayItem(e.item);
this.buySoftBtn.disable();
this.buyHardBtn.disable();
this.buySoftBtnLabel.setText(i);
this.buyHardBtnLabel.setText(i);
this._closeTradeConfirmWindow();
this.currentPrice = i;
this.tradeItemConfirm.updatePriceRealtime(i);
this.isHardCcyTrade = !!e.amountHard;
this.initialPrice = this.currentPrice = e.amountHard || e.amountSoft;
this.tradeItemConfirm = v.getWindow("tradeItemConfirm");
window.dofus.send("exchangeBidHouseBuyRequest", {
  id: i.getProperty("id"),
  uid: i.objectUID,
  qty: a,
  amountHard: n,
  amountSoft: o
});
e._prepareKpi("ExchangeBidHouseBuyResultMessage");
window.dofus.sendMessage("ExchangeBidHouseBuyMessage", {
  uid: t.objectUID,
  qty: i,
  price: n.currentPrice
});
n._prepareKpi("ExchangeBidHouseBuyResultMessage");
i = i || e.item.price;
this._confirmTrade({
  itemInstance: e,
  amountSoft: i * t,
  qty: t,
  token: this.msg.token
}, function () {
  window.dofus.sendMessage("ExchangeBuyMessage", {
    objectToBuyId: e.item.id,
    quantity: t
  });
});
i = i || e.item.price;
this._confirmTrade({
  isSell: !0,
  itemInstance: e,
  amountSoft: i * t,
  qty: t
}, function () {
  window.dofus.sendMessage("ExchangeSellMessage", {
    objectToSellId: e.objectUID,
    quantity: t
  });
});
this.itemDescription = this.windowBody.appendChild(new p({
  showTitle: !0,
  withCraftBtn: !0
}));
v.makeMovable(this, this.itemDescription.getChildren()[0]);
this.exchangeBox = this.windowBody.appendChild(new c());
this.bidHouseSellerBox = this.windowBody.appendChild(new a());
this.bidHouseBuyerBox = this.windowBody.appendChild(new s());
this._createBuyHardSoftButtons();
this.errorBox = this.windowBody.createChild("div", {
  className: "errorBox"
});
this.errorText = this.errorBox.createChild("div", {
  className: "errorText"
});
this.buyHardBtn = e.appendChild(new r({
  className: ["button", "buyHardBtn"],
  text: d("ui.common.buy"),
  addIcon: !0
}, function () {
  t._buyInGoultines();
}));
this.buyHardBtnLabel = this.buyHardBtn.getChildren()[0];
this.buySoftBtn = e.appendChild(new r({
  className: ["greenButton", "buySoftBtn"],
  text: d("ui.common.buy"),
  addIcon: !0
}, function () {
  t._buyInKamas();
}));
this.buySoftBtnLabel = this.buySoftBtn.getChildren()[0];
this.mode = e;
this.item = t;
this.errorBox.hide();
this.setTitle(o);
this.itemDescription.displayItem(t);
this.settingBox.updateSettingBox(this, t, i);
this.errorBox.isVisible() || this.settingBox.show();
this.errorText.setHtml(e);
this.errorBox.show();
this.settingBox.hide();
_.call(this, "div", {
  className: "BidHouseSellerBox",
  hidden: !0
});
this.tradeItemWindow = null;
this.item = null;
this.mode = null;
this.descriptor = null;
this.quantity = 0;
this.price = 0;
this.fees = 0;
this.minPricesCache = {};
this.isDomCreated = !1;
v[e.objectGID + "x" + t] = i;
y[e.objectGID] = t;
r(n, _);
e.exports = n;
n.prototype._onHide = function () {
  this.item = null;
  this.minPricesCache = {};
};
n.prototype.updateSettingBox = function (e, t) {
  var i = this;
  this.tradeItemWindow = e;
  var n = this.mode = e.mode;
  switch (this.item = t, this._hideAll(), n) {
    case "modify-bidHouse":
      this.priceLabel.setText(u.kamasToString(t.objectPrice));
      this.priceLabel.show();
      this.quantityLabel.setText(u.intToString(t.quantity));
      this.quantityLabel.show();
      this.quantity = t.quantity;
      this.removeBtn.show();
      this.timeLeft.setText(t.unsoldDelay + " " + c("ui.common.hourShort"));
      this.timeLeftBox.show();
      break;
    case "sell-bidHouse":
      if (this.descriptor.types.indexOf(t.item.typeId) === -1) {
        return e.showError(c("ui.bidhouse.badType"));
      }
      if (t.isLinked()) {
        return e.showError(c("ui.bidhouse.badExchange"));
      }
      if (t.item.level > this.descriptor.maxItemLevel) {
        return e.showError(c("ui.bidhouse.badLevel"));
      }
      this.sellBtn.show();
      this.sellBtn.disable();
      var o = this.descriptor.quantities;
      this.quantitySelect.clearContent();
      for (var s = 1, r = 0, l = o.length; r < l; r += 1) {
        var d = o[r];
        t.quantity >= d && (this.quantitySelect.addOption(d, d), s = d);
      }
      var p = y[t.objectGID],
        m = p ? Math.min(p, s) : s;
      this.quantitySelect.select(m);
      this.quantitySelect.show();
      var f = a(t, m);
      this.priceInput.setValue(f);
      this.price = f;
      this.priceInput.show();
      this._updateFees();
  }
  this.quantityBox.show();
  this.averagePriceBox.show();
  this.priceBox.show();
  this._refreshMinPrice();
  this._displayAveragePrice(t.item.averagePrice);
  h.getFreshAveragePrice(t.objectGID, function (e) {
    i._displayAveragePrice(e);
  });
};
n.prototype._hideAll = function () {
  this.quantityBox.hide();
  this.averagePriceBox.hide();
  this.quantitySelect.hide();
  this.quantityLabel.hide();
  this.priceBox.hide();
  this.priceLabel.hide();
  this.priceInput.hide();
  this.timeLeftBox.hide();
  this.saleFeeBox.hide();
  this.sellBtn.hide();
  this.removeBtn.hide();
};
n.prototype.setDescriptorData = function (e) {
  this.descriptor = e;
  this.isDomCreated || (this.isDomCreated = !0, this._createDom(), this._setupEvents());
};
n.prototype._displayAveragePrice = function (e) {
  e === -1 ? this.averagePrice.setText(c("ui.item.averageprice.unavailable")) : this.averagePrice.setText(u.kamasToString(e));
};
n.prototype._updateFees = function () {
  this.fees = Math.max(1, Math.round(this.descriptor.taxPercentage * (this.price - (this.item.objectPrice || 0)) / 100));
  this.saleFee.setText(this.price > 0 ? u.kamasToString(this.fees) : "-");
  this.saleFeeBox.show();
  var e = window.gui.playerData.inventory.kamas >= this.fees;
  this.saleFee.toggleClassName("red", !e);
  this.sellBtn.setEnable(e);
};
n.prototype._setupEvents = function () {
  var e = window.dofus.connectionManager,
    t = this;
  this.on("hide", this._onHide);
  window.gui.on("disconnect", function () {
    v = {};
    y = {};
  });
  e.on("ExchangeBidhouseMinimumItemPriceListMessage", function (e) {
    null !== t.item && t._updateMinSellingPrice(e.objectGID, e.prices);
  });
};
n.prototype._createDom = function () {
  var e = this,
    t = this.createChild("div", {
      className: "settingBox"
    }),
    i = this.quantityBox = t.createChild("div", {
      className: ["setting", "quantity"]
    });
  i.createChild("div", {
    className: "label",
    text: c("ui.common.quantity") + c("ui.common.colon")
  });
  this.quantitySelect = i.appendChild(new m());
  this.quantitySelect.on("change", function (t) {
    e.quantity = t;
    e.price = a(e.item, t);
    e.priceInput.setValue(e.price);
    e._updateFees();
  });
  this.quantityLabel = i.createChild("div", {
    className: "value"
  });
  var n = this.priceBox = t.createChild("div", {
    className: ["setting", "batchPrice"]
  });
  n.createChild("div", {
    className: "label",
    text: c("ui.bidhouse.setPrice") + c("ui.common.colon")
  });
  this.priceLabel = n.createChild("div", {
    className: "value"
  });
  this.priceInput = n.appendChild(new l({
    title: c("ui.bidhouse.setPrice"),
    attr: {
      placeholder: c("tablet.price.placeHolder")
    }
  }));
  this.priceInput.on("change", function (t) {
    e.price = t;
    e._updateFees();
  });
  t.createChild("div", {
    className: "minPriceLabel",
    text: c("tablet.sellPrice") + c("ui.common.colon")
  });
  var s = t.createChild("div", {
    className: "minPrice"
  });
  g.addTooltip(s, c("tablet.sellPriceTooltip"));
  this.minPriceValues = [];
  for (var r = this.descriptor.quantities, u = 0; u < r.length; u++) {
    this.minPriceValues[u] = this._createMinPriceValueBox(s, "x" + r[u], u);
  }
  var h = this.averagePriceBox = t.createChild("div", {
    className: ["setting", "averagePrice"]
  });
  h.createChild("div", {
    className: "label",
    text: c("ui.bidhouse.bigStoreAveragePrice") + c("ui.common.colon")
  });
  this.averagePrice = h.createChild("div", {
    className: "value"
  });
  var p = this.saleFeeBox = t.createChild("div", {
    className: ["setting", "saleFee"]
  });
  p.createChild("div", {
    className: "label",
    text: c("ui.bidhouse.bigStoreTax") + c("ui.common.colon")
  });
  this.saleFee = p.createChild("div", {
    className: ["value", "text"]
  });
  var f = this.timeLeftBox = t.createChild("div", {
    className: ["setting", "timeLeft"]
  });
  f.createChild("div", {
    className: "label",
    text: c("ui.bidhouse.bigStoreTime") + c("ui.common.colon")
  });
  this.timeLeft = f.createChild("div", {
    className: "value"
  });
  var _ = this.createChild("div", {
    className: "buttonBox"
  });
  this.sellBtn = _.appendChild(new d({
    className: "greenButton",
    text: c("ui.common.putOnSell")
  }, function () {
    return 0 === e.price ? e.priceInput.promptForValue() : (o(e.item, e.quantity, e.price), void e.tradeItemWindow.sellInBidHouse(e.item, e.price, e.quantity, e.fees));
  }));
  this.removeBtn = _.appendChild(new d({
    className: "greenButton",
    text: c("ui.common.remove")
  }, function () {
    e.tradeItemWindow.removeFromBidHouse(e.item, e.item.objectPrice, e.quantity);
  }));
};
n.prototype._createMinPriceValueBox = function (e, t, i) {
  var n = e.createChild("div", {
    className: "valueBox"
  });
  return f(n), n.on("tap", s), n.bidHouseSellerBox = this, n.index = i, n.createChild("div", {
    className: "title",
    text: t
  }), n.createChild("div", {
    className: "value",
    text: b
  });
};
n.prototype._refreshMinPrice = function () {
  var e = this.item.objectGID,
    t = this.minPricesCache[e];
  !t || Date.now() - t.timestamp > w ? window.dofus.sendMessage("ExchangeBidHouseListMessage", {
    id: e
  }) : this._displayMinPrice();
};
n.prototype._displayMinPrice = function () {
  for (var e = this.minPricesCache[this.item.objectGID], t = this.descriptor.quantities, i = 0; i < t.length; i++) {
    var n = e && e[i] ? u.intToString(e[i]) : b;
    this.minPriceValues[i].setText(n);
  }
};
n.prototype._useMinPriceAndQuantity = function (e) {
  if ("sell-bidHouse" !== this.mode) {
    return p("NO_ACTION");
  }
  var t = this.descriptor.quantities[e];
  if (t > this.item.quantity) {
    return p("NO_ACTION");
  }
  p("GEN_BUTTON");
  this.quantitySelect.select(t);
  var i = this.minPricesCache[this.item.objectGID],
    n = i ? i[e] : 0;
  this.priceInput.setValue(n);
  this.price = n;
  this._updateFees();
  this.priceInput.promptForValue();
};
n.prototype._updateMinSellingPrice = function (e, t) {
  this.minPricesCache[e] = t;
  t.timestamp = Date.now();
  this._displayMinPrice();
};
this.item = null;
this.minPricesCache = {};
this.priceLabel.setText(u.kamasToString(t.objectPrice));
this.priceLabel.show();
this.quantityLabel.setText(u.intToString(t.quantity));
this.quantityLabel.show();
this.quantity = t.quantity;
this.removeBtn.show();
this.timeLeft.setText(t.unsoldDelay + " " + c("ui.common.hourShort"));
this.timeLeftBox.show();
this.sellBtn.show();
this.sellBtn.disable();
this.quantitySelect.select(m);
this.quantitySelect.show();
this.priceInput.setValue(f);
this.price = f;
this.priceInput.show();
this._updateFees();
this.quantityBox.show();
this.averagePriceBox.show();
this.priceBox.show();
this._refreshMinPrice();
this._displayAveragePrice(t.item.averagePrice);
h.getFreshAveragePrice(t.objectGID, function (e) {
  i._displayAveragePrice(e);
});
this.quantityBox.hide();
this.averagePriceBox.hide();
this.quantitySelect.hide();
this.quantityLabel.hide();
this.priceBox.hide();
this.priceLabel.hide();
this.priceInput.hide();
this.timeLeftBox.hide();
this.saleFeeBox.hide();
this.sellBtn.hide();
this.removeBtn.hide();
this.descriptor = e;
this.isDomCreated || (this.isDomCreated = !0, this._createDom(), this._setupEvents());
this.fees = Math.max(1, Math.round(this.descriptor.taxPercentage * (this.price - (this.item.objectPrice || 0)) / 100));
this.saleFee.setText(this.price > 0 ? u.kamasToString(this.fees) : "-");
this.saleFeeBox.show();
this.saleFee.toggleClassName("red", !e);
this.sellBtn.setEnable(e);
this.on("hide", this._onHide);
window.gui.on("disconnect", function () {
  v = {};
  y = {};
});
e.on("ExchangeBidhouseMinimumItemPriceListMessage", function (e) {
  null !== t.item && t._updateMinSellingPrice(e.objectGID, e.prices);
});
v = {};
y = {};
i.createChild("div", {
  className: "label",
  text: c("ui.common.quantity") + c("ui.common.colon")
});
this.quantitySelect = i.appendChild(new m());
this.quantitySelect.on("change", function (t) {
  e.quantity = t;
  e.price = a(e.item, t);
  e.priceInput.setValue(e.price);
  e._updateFees();
});
this.quantityLabel = i.createChild("div", {
  className: "value"
});
e.quantity = t;
e.price = a(e.item, t);
e.priceInput.setValue(e.price);
e._updateFees();
n.createChild("div", {
  className: "label",
  text: c("ui.bidhouse.setPrice") + c("ui.common.colon")
});
this.priceLabel = n.createChild("div", {
  className: "value"
});
this.priceInput = n.appendChild(new l({
  title: c("ui.bidhouse.setPrice"),
  attr: {
    placeholder: c("tablet.price.placeHolder")
  }
}));
this.priceInput.on("change", function (t) {
  e.price = t;
  e._updateFees();
});
t.createChild("div", {
  className: "minPriceLabel",
  text: c("tablet.sellPrice") + c("ui.common.colon")
});
e.price = t;
e._updateFees();
g.addTooltip(s, c("tablet.sellPriceTooltip"));
this.minPriceValues = [];
h.createChild("div", {
  className: "label",
  text: c("ui.bidhouse.bigStoreAveragePrice") + c("ui.common.colon")
});
this.averagePrice = h.createChild("div", {
  className: "value"
});
p.createChild("div", {
  className: "label",
  text: c("ui.bidhouse.bigStoreTax") + c("ui.common.colon")
});
this.saleFee = p.createChild("div", {
  className: ["value", "text"]
});
f.createChild("div", {
  className: "label",
  text: c("ui.bidhouse.bigStoreTime") + c("ui.common.colon")
});
this.timeLeft = f.createChild("div", {
  className: "value"
});
this.sellBtn = _.appendChild(new d({
  className: "greenButton",
  text: c("ui.common.putOnSell")
}, function () {
  return 0 === e.price ? e.priceInput.promptForValue() : (o(e.item, e.quantity, e.price), void e.tradeItemWindow.sellInBidHouse(e.item, e.price, e.quantity, e.fees));
}));
this.removeBtn = _.appendChild(new d({
  className: "greenButton",
  text: c("ui.common.remove")
}, function () {
  e.tradeItemWindow.removeFromBidHouse(e.item, e.item.objectPrice, e.quantity);
}));
p("GEN_BUTTON");
this.quantitySelect.select(t);
this.priceInput.setValue(n);
this.price = n;
this._updateFees();
this.priceInput.promptForValue();
this.minPricesCache[e] = t;
t.timestamp = Date.now();
this._displayMinPrice();
M.call(this, "div", {
  className: "BidHouseBuyerBox",
  hidden: !0
});
this.tradeItemWindow = null;
this.item = null;
this.currentOffer = null;
this.descriptor = null;
this.table = null;
this.actions = [];
this.mountWindow = null;
this.serverAveragePrice = -1;
this.displayedUnitCount = 0;
this.displayedUnitPrice = 0;
this.isDomCreated = !1;
i.currentOffer = t;
i.tradeItemWindow.updateSelection(t);
i._showSpecialItemInfo(t.item);
m(n, M);
e.exports = n;
n.prototype.updateSettingBox = function (e, t) {
  var i = this;
  this.tradeItemWindow = e;
  this.item = t;
  e.updateSelection(null);
  window.dofus.sendMessage("ExchangeBidHouseListMessage", {
    id: t.id
  });
  this._setAveragePrice(t.averagePrice);
  f.getFreshAveragePrice(t.id, function (e) {
    i._setAveragePrice(e);
  });
  this.displayedUnitCount = 0;
  this.displayedUnitPrice = 0;
  this.pendingItemGid = null;
  this.expectedItems = null;
  window.clearTimeout(this.chunkLoadTimeout);
  this.searchedText = "";
  this.searchBox.clear();
  this.table.clearContent();
  this.addClassNames("spinner");
};
n.prototype._updateOffer = function (e, t) {
  if (this.currentOffer && e === this.currentOffer.id) {
    if (t > this.currentOffer.amountSoft) {
      return this.tradeItemWindow.updateSelection(null);
    }
    this.table.selectRow(e, !0);
    this.tradeItemWindow.updateBidHouseBuyPriceRealtime(t, g.computeHardPrice(t));
  }
};
n.prototype._removeOffer = function (e) {
  this.currentOffer && e === this.currentOffer.id && this.tradeItemWindow.updateSelection(null);
};
n.prototype._hideMountPreview = function () {
  this.mountWindow && (this.mountWindow.close(), this.mountWindow = null);
};
n.prototype._showSpecialItemInfo = function (e) {
  _.getMountInfoFromCertificate(e) ? (this.mountWindow = T.getWindow("mount"), this.mountWindow.showCertificateMount(e)) : this._hideMountPreview();
};
n.prototype.setDescriptorData = function (e) {
  function t(e) {
    var t = new M("div", {
      className: "icon"
    });
    return t.setStyle("backgroundImage", e.item.getProperty("image")), t.createChild("div", {
      className: "quantity",
      text: "x " + e.qty
    }), t;
  }
  this.descriptor = e;
  this.isDomCreated || (this.isDomCreated = !0, this._createDom(), this._setupEvents());
  var i = new M("div", {
      className: ["currencyIcon", "soft"]
    }),
    n = new M("div", {
      className: ["currencyIcon", "hard"]
    }),
    l = [{
      id: "icon",
      format: t,
      sort: r
    }, {
      id: "shortName",
      header: h("ui.common.name"),
      format: o,
      sort: r
    }, {
      id: "amountHard",
      header: n,
      format: a,
      sort: r
    }, {
      id: "amountSoft",
      header: i,
      format: s,
      sort: r,
      defaultSorter: !0,
      order: "descending"
    }];
  this.item = null;
  this.expectedItems = null;
  this.itemCache = {
    monstersCache: {}
  };
  this.table ? this.table.clearContent() : this.table = this.tableBox.appendChild(new w(l, "id", {
    scaleOnPress: !0
  }));
  this.table.bidHouseBuyerBox = this;
  this.table.on("rowTap", c);
  this.table.addFilter(d);
};
n.prototype._onHide = function () {
  this._hideMountPreview();
  window.clearTimeout(this.chunkLoadTimeout);
  window.clearTimeout(this.actionTimeout);
  this.actionTimeout = null;
  this.actions = [];
  this.itemCache = null;
  this.item = null;
};
n.prototype._setupEvents = function () {
  var e = this,
    t = window.dofus.connectionManager;
  this.on("hide", this._onHide);
  t.on("ExchangeErrorMessage", function (t) {
    t.errorType === u.BID_SEARCH_ERROR && e.delClassNames("spinner");
  });
  t.on("ExchangeBidHouseInListUpdatedMessage", function (t) {
    var i = {
      objectUID: t.itemUID,
      objectGID: t.objGenericId,
      prices: t.prices,
      effects: t.effects,
      quantity: 1
    };
    e._queueAction({
      type: E,
      GID: t.objGenericId,
      rawItem: i
    });
  });
  t.on("ExchangeBidHouseInListAddedMessage", function (t) {
    var i = {
      objectUID: t.itemUID,
      objectGID: t.objGenericId,
      prices: t.prices,
      effects: t.effects,
      quantity: 1
    };
    e._queueAction({
      type: S,
      GID: t.objGenericId,
      rawItems: [i]
    });
  });
  t.on("ExchangeTypesItemsExchangerDescriptionForUserMessage", function (t) {
    null !== e.item && e._loadItemList(t.itemTypeDescriptions);
  });
  t.on("ExchangeBidHouseInListRemovedMessage", function (t) {
    e._queueAction({
      type: N,
      GID: e.pendingItemGid,
      UID: t.itemUID
    });
  });
  g.on("computedHardPricesChange", function () {
    e.table && e.table.refreshRows();
  });
};
n.prototype._loadItemList = function (e) {
  this.pendingItemGid = this.item.id;
  window.clearTimeout(this.chunkLoadTimeout);
  this.table.clearContent();
  this._queueAction({
    type: A,
    GID: this.pendingItemGid,
    bidExchangerObjectInfos: e
  });
};
n.prototype._queueAction = function (e) {
  this.actions.push(e);
  this.actionTimeout || this._processNextAction();
};
n.prototype._processNextAction = function () {
  for (var e;;) {
    if (!this.actions.length) {
      return;
    }
    if (e = this.actions.shift(), e.GID === this.pendingItemGid) {
      break;
    }
  }
  switch (e.type) {
    case A:
      return this._addItemListChunk(this.pendingItemGid, e.bidExchangerObjectInfos, 0);
    case S:
      return this._addItems(e.rawItems, S, this._scheduleNextAction.bind(this));
    case N:
      return this._removeItem(e.UID, N), this._scheduleNextAction();
    case E:
      return this._updateItem(e.rawItem, this._scheduleNextAction.bind(this));
    default:
      console.error("Invalid action: " + e.type);
  }
};
n.prototype._scheduleNextAction = function () {
  !this.actionTimeout && this.actions.length && (this.actionTimeout = window.setTimeout(function (e) {
    e.actionTimeout = null;
    e._processNextAction();
  }, R, this));
};
n.prototype._addItemListChunk = function (e, t, i) {
  if (e === this.pendingItemGid) {
    for (var n = 0 === i, o = Math.min(i + (n ? L : x), t.length), a = [], s = i; s < o; s++) {
      var r = t[s];
      a.push({
        objectUID: r.objectUID,
        objectGID: e,
        prices: r.prices,
        effects: r.effects,
        quantity: 1
      });
    }
    this._addItems(a, n ? A : S, this._nextItemListChunk.bind(this, e, t, o));
  }
};
n.prototype._nextItemListChunk = function (e, t, i) {
  e === this.pendingItemGid && (i !== t.length ? (this.rowCount.show(), this.rowCount.setText(i + " / " + t.length), this.chunkLoadTimeout = window.setTimeout(function (n) {
    n._addItemListChunk(e, t, i);
  }, O, this)) : (this.rowCount.hide(), this.delClassNames("spinner")));
};
n.prototype._adaptTableToItemType = function (e) {
  this.isItemSearchable = e && e.getRawName() !== e.shortName;
  this.isItemSearchable ? (this.searchDiv.toggleDisplay(!0), this.rowCount.setText("..."), this.rowCount.show(), this.table.sortByColumnId("shortName", "ascending"), this.table.delClassNames("noShortName")) : (this.searchDiv.toggleDisplay(!1), this.table.sortBy && "shortName" === this.table.sortBy.id && this.table.resetSort(), this.table.addClassNames("noShortName"));
  this.table.sortAgain();
};
n.prototype._removeItem = function (e, t) {
  for (var i = this.descriptor.quantities, n = 0; n < i.length; n++) {
    var o = e + "x" + i[n];
    this.table.delRow(o);
    t === N && this._removeOffer(o);
  }
};
n.prototype._updateItem = function (e, t) {
  this._removeItem(e.objectUID, E);
  this._addItems([e], E, t);
};
n.prototype._addItems = function (e, t, i) {
  this.expectedItems = e;
  var n = this;
  f.createItemInstances(e, this.itemCache, function (o, a) {
    if (o) {
      return console.error(o), i && i(o);
    }
    if (e === n.expectedItems) {
      n.expectedItems = null;
      t === A && n._adaptTableToItemType(a.array[0]);
      var s = a.map,
        r = [];
      for (var l in s) {
        n._separateItemBulks(s[l], r);
      }
      if (n.table.addList(r), t === E) {
        for (var c = 0; c < r.length; c++) {
          var d = r[c];
          n._updateOffer(d.id, d.amountSoft);
        }
      }
      return n._updatePriceHighlighting(), i && i();
    }
  });
};
n.prototype._separateItemBulks = function (e, t) {
  for (var i = this.descriptor.quantities, n = 0; n < i.length; n++) {
    var o = e.prices[n];
    if (o) {
      var a = i[n];
      t.push({
        id: e.getProperty("objectUID") + "x" + a,
        item: e,
        qty: a,
        amountSoft: o,
        unitPrice: o / a,
        amountHard: null
      });
      this.displayedUnitCount += a;
      this.displayedUnitPrice += o;
    }
  }
};
n.prototype._setAveragePrice = function (e) {
  if (this.serverAveragePrice = e, e === -1) {
    return this.averagePriceElement.setText(h("ui.item.averageprice.unavailable"));
  }
  var t = g.computeHardPrice(e);
  this.averagePriceElement.setText(p.hardAndSoftToString(t, e));
};
n.prototype._createDom = function () {
  var e = this;
  this.searchDiv = this.createChild("div", {
    className: "searchDiv"
  });
  this.searchBox = this.searchDiv.appendChild(new y({
    label: h("ui.common.search") + h("ui.common.colon")
  }));
  this.searchBox.on("search", function (t) {
    e._search(t);
  });
  this.rowCount = this.searchDiv.createChild("div", {
    className: "rowCount"
  });
  this.tableBox = this.createChild("div", {
    className: "tableBox"
  });
  var t = this.createChild("div", {
    className: ["setting", "averagePrice"]
  });
  t.createChild("div", {
    className: "label",
    text: h("ui.bidhouse.bigStoreAveragePrice") + h("ui.common.colon")
  });
  this.averagePriceElement = t.createChild("div", {
    className: "value"
  });
};
n.prototype._search = function (e) {
  this.searchedText = p.simplifyString(e);
  this.addClassNames("spinner");
  window.setTimeout(function (e) {
    e.table.filter();
    e.delClassNames("spinner");
  }, 0, this);
};
n.prototype._computeAveragePrice = function () {
  return this.serverAveragePrice !== -1 ? this.serverAveragePrice : this.displayedUnitPrice / this.displayedUnitCount;
};
n.prototype._updatePriceHighlighting = function () {
  for (var e = this._computeAveragePrice(), t = this.table.rows.getChildren(), i = 0; i < t.length; i++) {
    var n = t[i],
      o = n.rowContent;
    n.toggleClassName("expensive", o.unitPrice >= e * C);
    n.toggleClassName("cheap", o.unitPrice <= e * I);
  }
};
this.tradeItemWindow = e;
this.item = t;
e.updateSelection(null);
window.dofus.sendMessage("ExchangeBidHouseListMessage", {
  id: t.id
});
this._setAveragePrice(t.averagePrice);
f.getFreshAveragePrice(t.id, function (e) {
  i._setAveragePrice(e);
});
this.displayedUnitCount = 0;
this.displayedUnitPrice = 0;
this.pendingItemGid = null;
this.expectedItems = null;
window.clearTimeout(this.chunkLoadTimeout);
this.searchedText = "";
this.searchBox.clear();
this.table.clearContent();
this.addClassNames("spinner");
this.table.selectRow(e, !0);
this.tradeItemWindow.updateBidHouseBuyPriceRealtime(t, g.computeHardPrice(t));
this.descriptor = e;
this.isDomCreated || (this.isDomCreated = !0, this._createDom(), this._setupEvents());
this.item = null;
this.expectedItems = null;
this.itemCache = {
  monstersCache: {}
};
this.table ? this.table.clearContent() : this.table = this.tableBox.appendChild(new w(l, "id", {
  scaleOnPress: !0
}));
this.table.bidHouseBuyerBox = this;
this.table.on("rowTap", c);
this.table.addFilter(d);
this._hideMountPreview();
window.clearTimeout(this.chunkLoadTimeout);
window.clearTimeout(this.actionTimeout);
this.actionTimeout = null;
this.actions = [];
this.itemCache = null;
this.item = null;
this.on("hide", this._onHide);
t.on("ExchangeErrorMessage", function (t) {
  t.errorType === u.BID_SEARCH_ERROR && e.delClassNames("spinner");
});
t.on("ExchangeBidHouseInListUpdatedMessage", function (t) {
  var i = {
    objectUID: t.itemUID,
    objectGID: t.objGenericId,
    prices: t.prices,
    effects: t.effects,
    quantity: 1
  };
  e._queueAction({
    type: E,
    GID: t.objGenericId,
    rawItem: i
  });
});
t.on("ExchangeBidHouseInListAddedMessage", function (t) {
  var i = {
    objectUID: t.itemUID,
    objectGID: t.objGenericId,
    prices: t.prices,
    effects: t.effects,
    quantity: 1
  };
  e._queueAction({
    type: S,
    GID: t.objGenericId,
    rawItems: [i]
  });
});
t.on("ExchangeTypesItemsExchangerDescriptionForUserMessage", function (t) {
  null !== e.item && e._loadItemList(t.itemTypeDescriptions);
});
t.on("ExchangeBidHouseInListRemovedMessage", function (t) {
  e._queueAction({
    type: N,
    GID: e.pendingItemGid,
    UID: t.itemUID
  });
});
g.on("computedHardPricesChange", function () {
  e.table && e.table.refreshRows();
});
this.pendingItemGid = this.item.id;
window.clearTimeout(this.chunkLoadTimeout);
this.table.clearContent();
this._queueAction({
  type: A,
  GID: this.pendingItemGid,
  bidExchangerObjectInfos: e
});
this.actions.push(e);
this.actionTimeout || this._processNextAction();
e.actionTimeout = null;
e._processNextAction();
this.isItemSearchable = e && e.getRawName() !== e.shortName;
this.isItemSearchable ? (this.searchDiv.toggleDisplay(!0), this.rowCount.setText("..."), this.rowCount.show(), this.table.sortByColumnId("shortName", "ascending"), this.table.delClassNames("noShortName")) : (this.searchDiv.toggleDisplay(!1), this.table.sortBy && "shortName" === this.table.sortBy.id && this.table.resetSort(), this.table.addClassNames("noShortName"));
this.table.sortAgain();
this.table.delRow(o);
t === N && this._removeOffer(o);
this._removeItem(e.objectUID, E);
this._addItems([e], E, t);
n.expectedItems = null;
t === A && n._adaptTableToItemType(a.array[0]);
t.push({
  id: e.getProperty("objectUID") + "x" + a,
  item: e,
  qty: a,
  amountSoft: o,
  unitPrice: o / a,
  amountHard: null
});
this.displayedUnitCount += a;
this.displayedUnitPrice += o;
this.searchDiv = this.createChild("div", {
  className: "searchDiv"
});
this.searchBox = this.searchDiv.appendChild(new y({
  label: h("ui.common.search") + h("ui.common.colon")
}));
this.searchBox.on("search", function (t) {
  e._search(t);
});
this.rowCount = this.searchDiv.createChild("div", {
  className: "rowCount"
});
this.tableBox = this.createChild("div", {
  className: "tableBox"
});
t.createChild("div", {
  className: "label",
  text: h("ui.bidhouse.bigStoreAveragePrice") + h("ui.common.colon")
});
this.averagePriceElement = t.createChild("div", {
  className: "value"
});
this.searchedText = p.simplifyString(e);
this.addClassNames("spinner");
window.setTimeout(function (e) {
  e.table.filter();
  e.delClassNames("spinner");
}, 0, this);
e.table.filter();
e.delClassNames("spinner");
n.toggleClassName("expensive", o.unitPrice >= e * C);
n.toggleClassName("cheap", o.unitPrice <= e * I);
c.call(this, "div", {
  className: "ExchangeBox",
  hidden: !0
});
this._createDom();
this.mode = null;
this.current = {};
this.tradeItemWindow = null;
this.currency = "";
this.tokenItem = null;
o(n, c);
e.exports = n;
n.prototype._createDom = function () {
  var e = this,
    t = this.createChild("div", {
      className: "settingBox"
    }),
    i = t.createChild("div", {
      className: "setting"
    });
  i.createChild("div", {
    className: "label",
    text: s("ui.common.quantity") + s("ui.common.colon")
  });
  var n = this.quantityValue = i.appendChild(new a({
    minValue: 1,
    title: s("ui.common.quantity")
  }));
  n.on("focus", function () {
    n.maxValue = e._getMaxQuantity();
  });
  n.on("change", function () {
    e._updatePrices();
  });
  var o = t.createChild("div", {
    className: "setting"
  });
  o.createChild("div", {
    className: "label",
    text: s("ui.common.unitPrice") + s("ui.common.colon")
  });
  this.unitPriceValue = o.createChild("div", {
    className: "value"
  });
  var l = this.totalPrice = t.createChild("div", {
    className: "setting"
  });
  l.createChild("div", {
    className: "label",
    text: s("ui.common.totalPrice") + s("ui.common.colon")
  });
  this.totalPriceValue = l.createChild("div", {
    className: "value"
  });
  var c = this.createChild("div", {
    className: "buttonBox"
  });
  this.sellButton = c.appendChild(new r({
    text: s("ui.common.sell"),
    className: "greenButton"
  }, function () {
    var t = e.current;
    e.tradeItemWindow.sellItemToNpc(t.item, t.quantity, t.unitPrice);
  }));
  this.buyButton = c.appendChild(new r({
    text: s("ui.common.buy"),
    className: "greenButton"
  }, function () {
    var t = e.current;
    e.tradeItemWindow.buyItemFromNpc(t.item, t.quantity, t.unitPrice);
  }));
};
n.prototype._updatePrices = function () {
  var e = this.pricePerUnit,
    t = this.quantityValue.getValue();
  this.current.quantity = t;
  this.current.unitPrice = e;
  var i = t * e;
  if (this.totalPrice.show(), this.currency ? this.totalPriceValue.setText(this.currency + " x " + l.intToString(i)) : this.totalPriceValue.setText(l.kamasToString(i)), this.buyButton.isVisible()) {
    var n = window.gui.playerData.inventory,
      o = this.tokenItem ? n.getGenericItemCount(this.tokenItem.id) : n.kamas;
    i > o ? (this.buyButton.disable(), this.totalPriceValue.addClassNames("red")) : (this.buyButton.enable(), this.totalPriceValue.delClassNames("red"));
  }
};
n.prototype._getMaxQuantity = function () {
  var e = this.current.item;
  return e.quantity;
};
n.prototype.updateSettingBox = function (e, t, i) {
  this.tradeItemWindow = e;
  this.current.item = t;
  var n = this.mode = e.mode;
  this.tokenItem = e.msg.token;
  this.currency = i;
  var o = !1;
  this.totalPriceValue.delClassNames("red");
  this._hideButtons();
  var a,
    r = t.getProperty("quantity"),
    c = 1;
  switch (n) {
    case "sell-npc":
      o = !0;
      this.sellButton.show();
      var u = t.getProperty("price");
      a = u > 0 ? Math.max(1, Math.floor(u / d)) : 0;
      break;
    case "buy-npc":
      this.buyButton.show();
      a = t.getProperty("objectPrice") || t.getProperty("price");
      break;
    default:
      console.error(new Error("Invalid exchange mode: " + n));
  }
  return o && t.isLinked() ? e.showError(s("ui.bidhouse.badExchange")) : (this.pricePerUnit = a, this.quantityValue.setValue(c), this.quantityValue.setReadonly(1 === r), this.unitPriceValue.setText(i ? i + " x " + l.intToString(a) : l.kamasToString(a)), void this._updatePrices());
};
n.prototype._hideButtons = function () {
  this.sellButton.hide();
  this.buyButton.hide();
};
n.on("focus", function () {
  n.maxValue = e._getMaxQuantity();
});
n.on("change", function () {
  e._updatePrices();
});
o.createChild("div", {
  className: "label",
  text: s("ui.common.unitPrice") + s("ui.common.colon")
});
this.unitPriceValue = o.createChild("div", {
  className: "value"
});
l.createChild("div", {
  className: "label",
  text: s("ui.common.totalPrice") + s("ui.common.colon")
});
this.totalPriceValue = l.createChild("div", {
  className: "value"
});
this.sellButton = c.appendChild(new r({
  text: s("ui.common.sell"),
  className: "greenButton"
}, function () {
  var t = e.current;
  e.tradeItemWindow.sellItemToNpc(t.item, t.quantity, t.unitPrice);
}));
this.buyButton = c.appendChild(new r({
  text: s("ui.common.buy"),
  className: "greenButton"
}, function () {
  var t = e.current;
  e.tradeItemWindow.buyItemFromNpc(t.item, t.quantity, t.unitPrice);
}));
this.current.quantity = t;
this.current.unitPrice = e;
this.tradeItemWindow = e;
this.current.item = t;
this.tokenItem = e.msg.token;
this.currency = i;
this.totalPriceValue.delClassNames("red");
this._hideButtons();
o = !0;
this.sellButton.show();
this.buyButton.show();
a = t.getProperty("objectPrice") || t.getProperty("price");
this.sellButton.hide();
this.buyButton.hide();
l.call(this, {
  title: a("ui.common.confirm"),
  className: "TradeItemConfirmWindow",
  positionInfo: {
    left: "c",
    top: "c",
    width: 350,
    height: 300,
    isModal: !0
  }
});
this._reset();
this.on("open", this._onOpen);
this.on("close", this._onClose);
r(n, l);
e.exports = n;
n.prototype._reset = function () {
  this.cb = null;
  this.itemLabel = null;
  this.itemImg = null;
  this.itemQuantity = null;
  this.buyBtn = null;
  this.buyBtnLabel = null;
};
n.prototype._onOpen = function () {
  this.itemLabel || this._createContent();
};
n.prototype._onClose = function () {
  this.cb(!1);
};
n.prototype.freeContent = function () {
  this.windowBody.clearContent();
  this._reset();
};
n.prototype._createContent = function () {
  var e = this.windowBody.createChild("div", {
      className: "itemLabelBox"
    }),
    t = this.windowBody.createChild("div", {
      className: "twoColumns"
    });
  this.itemLabel = e.createChild("div", {
    className: "itemLabel"
  });
  var i = t.createChild("div", {
      className: "leftCol"
    }),
    n = i.createChild("div", {
      className: "itemContainer"
    });
  this.itemImg = n.createChild("div", {
    className: "itemImg"
  });
  this.itemQuantity = n.createChild("div", {
    className: "itemQuantity"
  });
  var a = t.createChild("div", {
      className: "rightCol"
    }),
    s = this,
    r = a.createChild("div", {
      className: "btnAndFee"
    });
  this.buyBtn = r.appendChild(new o({
    addIcon: !0,
    className: ["buyBtn", "greenButton"]
  }, function () {
    this.disable();
    s.cb(!0);
  }));
  var l = this.buyBtnIcon = this.buyBtn.getChildren()[0];
  this.buyBtnLabel = this.buyBtn.insertChildBefore(new d("div", {
    className: "btnLabel"
  }), l);
  this.buyBtnAmount = this.buyBtn.insertChildBefore(new d("div", {
    className: "btnAmount"
  }), l);
  this.feeAmount = r.createChild("div", {
    className: "feeAmount"
  });
};
n.prototype.confirmTrade = function (e, t) {
  c.open(this.id);
  var i = e.itemInstance;
  this.itemLabel.setText(i.getName());
  this.itemImg.setStyle("backgroundImage", i.getProperty("image"));
  this.itemQuantity.setText("x" + e.qty);
  this.buyBtnLabel.setText(a(e.isSell ? "ui.common.sell" : "ui.common.buy").toUpperCase());
  this.buyBtnAmount.setText(s.intToString(e.amountHard || e.amountSoft));
  this.buyBtn.toggleClassName("hardCcy", !!e.amountHard);
  this.buyBtn.toggleClassName("softCcy", !e.amountHard);
  var n = e.token ? e.token.getProperty("image") : null;
  this.buyBtnIcon.setStyle("backgroundImage", n);
  this.feeAmount.setText(e.fee ? a("tablet.salesFee") + a("ui.common.colon") + s.kamasToString(e.fee) : "");
  this.cb = t;
};
n.prototype.updatePriceRealtime = function (e) {
  this.buyBtnAmount.setText(s.intToString(e));
};
this.cb = null;
this.itemLabel = null;
this.itemImg = null;
this.itemQuantity = null;
this.buyBtn = null;
this.buyBtnLabel = null;
this.windowBody.clearContent();
this._reset();
this.itemImg = n.createChild("div", {
  className: "itemImg"
});
this.itemQuantity = n.createChild("div", {
  className: "itemQuantity"
});
this.disable();
s.cb(!0);
this.buyBtnLabel = this.buyBtn.insertChildBefore(new d("div", {
  className: "btnLabel"
}), l);
this.buyBtnAmount = this.buyBtn.insertChildBefore(new d("div", {
  className: "btnAmount"
}), l);
this.feeAmount = r.createChild("div", {
  className: "feeAmount"
});
this.itemLabel.setText(i.getName());
this.itemImg.setStyle("backgroundImage", i.getProperty("image"));
this.itemQuantity.setText("x" + e.qty);
this.buyBtnLabel.setText(a(e.isSell ? "ui.common.sell" : "ui.common.buy").toUpperCase());
this.buyBtnAmount.setText(s.intToString(e.amountHard || e.amountSoft));
this.buyBtn.toggleClassName("hardCcy", !!e.amountHard);
this.buyBtn.toggleClassName("softCcy", !e.amountHard);
this.buyBtnIcon.setStyle("backgroundImage", n);
this.feeAmount.setText(e.fee ? a("tablet.salesFee") + a("ui.common.colon") + s.kamasToString(e.fee) : "");
this.cb = t;
this.mode = null;
this.openOnItem = null;
this.storageView = e;
e.registerView(this, {
  tapSelectedEmitsDoubleTap: !0,
  contextParams: {
    enableDestroy: !0
  }
});
_.on("change", function (e) {
  i(e);
});
this.on("open", function (t) {
  var n = this.mode = h[t._messageType],
    a = s.windowFullScreenWidth - o.minWidth - l.minWidth;
  a = Math.max(a, p);
  d.positionWindow(this.id, {
    right: 0,
    top: 0,
    width: a,
    height: "100%"
  });
  "sell-bidHouse" === n && (e.storageUI.appendChild(_), f = t.sellerDescriptor || t.buyerDescriptor, i(!0), _.activate(!0), this.openOnItem && this.navigateToItem(this.openOnItem));
  t.token && e.showTokens(t.token.type.category);
});
this.on("closed", function () {
  "sell-bidHouse" === this.mode && (e.storageUI.removeChild(_), i(!1));
});
this.on("slot-tap", n);
this.on("slot-doubletap", n);
this.on("itemAdded", r);
this.on("itemQuantity", r);
this.on("itemRemoved", function (e) {
  var t = d.getWindow("tradeItem"),
    i = t.getCurrentItem();
  i && e === i.getProperty("objectUID") && d.close("tradeItem");
});
a = Math.max(a, p);
d.positionWindow(this.id, {
  right: 0,
  top: 0,
  width: a,
  height: "100%"
});
"sell-bidHouse" === n && (e.storageUI.appendChild(_), f = t.sellerDescriptor || t.buyerDescriptor, i(!0), _.activate(!0), this.openOnItem && this.navigateToItem(this.openOnItem));
t.token && e.showTokens(t.token.type.category);
r(n, c);
e.exports = n;
n.prototype.navigateToItem = function (e) {
  this.openOnItem = null;
  var t, i;
  return "number" == typeof e ? t = e : (t = e.getProperty("id"), i = e.getItemInstance()), !(!i || !this._selectItem(i, !0)) || !!(i = this.storageView.selectAndShowSlotByGID(t)) && (this._selectItem(i, !0), !0);
};
n.prototype._selectItem = function (e, t) {
  return !!this.mode && !!this.storageView.selectAndShowSlotByUID(e.objectUID) && (t && d.getWindow("tradeStorage").setFilter(e.getProperty("typeId")), d.getWindow("tradeItem").displayItem(this.mode, e), d.focusWindow("tradeItem"), d.focusWindow("tradeInventory"), !0);
};
h.call(this, {
  className: "TradeStorageWindow",
  positionInfo: g
});
this.openOnItem = null;
this.mode = null;
this.currentItem = null;
this.on("open", this._onOpen);
this.on("closed", this._onClose);
l(n, h);
e.exports = n;
n.prototype.navigateToItem = function (e) {
  this.openOnItem = null;
  var t, i;
  "number" == typeof e ? t = e : (t = e.getProperty("id"), i = e.getItemInstance());
  var n = p.getWindow("tradeInventory");
  if (n.navigateToItem(e)) {
    return !0;
  }
  if (i && this._selectItemByUID(i.objectUID, !0)) {
    return !0;
  }
  var o = this.shopViewer.findItemByGID(t);
  return !(!o || !this._selectItemByUID(o, !0));
};
n.prototype._onOpen = function (e) {
  if (this.mode = f[e._messageType], !this.mode) {
    return console.error(new Error("Unexpected msg type for TradeStorageWindow: " + e._messageType));
  }
  this.shopViewer || (this._createContent(), this._setupEventListeners());
  var t = this,
    i = !1,
    n = !1;
  switch (this.mode) {
    case "buy-npc":
      this.setTitle(s("ui.common.shop"));
      this.shopViewer.table.setSlideEnable(!1);
      break;
    case "modify-bidHouse":
      this.setTitle(s("ui.common.shopStock"));
      var o = this.descriptor = e.sellerDescriptor;
      this.npcId = o.npcContextualId;
      i = !0;
      this.infoContent.setHtml(this._getBidHouseInfoHtml(o));
      this._totalItemsPrice = 0;
      this._itemCount = e.objectsInfos.length;
      this._updatePlayerInformation();
      this.switchToBuyModeBtn.enable();
      this.shopViewer.table.setSlideEnable(!0);
      this._slideBack.modify.hide();
      this._slideBack.remove.show();
  }
  n ? p.arrangeOpeningWindowVertically(this.id, {
    below: "wallet",
    fullHeight: !0
  }) : p.positionWindow(this.id, g);
  this.headerRow.toggleDisplay(i);
  this.shopViewer.table.setContentLoading(!0);
  this.lastOpenMode !== this.mode && (this.lasOpenMode && this.delClassNames(this.lasOpenMode), this.addClassNames(this.mode));
  this.lasOpenMode = this.mode;
  c.createItemInstances(e.objectsInfos, function (i, n) {
    return t.shopViewer.table.setContentLoading(!1), i ? console.error(i) : (t.currency = e.tokenId, t.token = e.token || null, t.shopViewer.setItemList(n.array, "modify-bidHouse" === t.mode), void (t.openOnItem && t.navigateToItem(t.openOnItem)));
  });
};
n.prototype._onClose = function () {
  this.currentItem = null;
  this.shopViewer.clearContent();
  p.close("tradeItem");
};
n.prototype._createContent = function () {
  this._createHeader();
  this._createViewer();
};
n.prototype._createHeader = function () {
  var e = this.headerRow = this.windowBody.createChild("div", {
    className: "headerRow"
  });
  this._playerInfoElt = e.createChild("div", {
    className: "playerInfoElt"
  });
  this._itemCountElt = this._playerInfoElt.createChild("div", {
    className: "itemCountElt"
  });
  this._totalItemsPriceElt = this._playerInfoElt.createChild("div", {
    className: "totalItemsPriceElt"
  });
  this._playerInfoTooltop = new m("div");
  this._itemCountTooltip = this._playerInfoTooltop.createChild("div", {
    className: "itemCount"
  });
  this._totalItemsPriceTooltip = this._playerInfoTooltop.createChild("div", {
    className: "totalItemsPrice"
  });
  u.addTooltip(this._playerInfoElt, this._playerInfoTooltop);
  this._createInfoButton();
  this._createSwitchToBuyModeButton();
};
n.prototype._updatePlayerInformation = function () {
  this._itemCountElt.setText(this._itemCount + "/" + this.descriptor.maxItemPerAccount);
  this._itemCountTooltip.setText(s("ui.bidhouse.quantityObjectSold", this._itemCount, this.descriptor.maxItemPerAccount));
  this._totalItemsPriceElt.setText(r.intToString(this._totalItemsPrice) + " K");
  this._totalItemsPriceTooltip.setText(s("ui.bidhouse.quantityKamas", r.intToString(this._totalItemsPrice)));
};
n.prototype._getBidHouseInfoHtml = function (e) {
  var t = s("ui.common.colon"),
    i = "";
  return e.maxItemLevel < 1e3 && (i += s("ui.common.maxLevel") + t + e.maxItemLevel + "<br/>"), i + s("ui.bidhouse.bigStoreTax") + t + e.taxPercentage + "%<br/>" + s("ui.bidhouse.bigStoreMaxSellTime") + t + e.unsoldDelay + " " + s("ui.time.hours", e.unsoldDelay) + "<br/>" + s("ui.bidhouse.unsold");
};
n.prototype._createInfoButton = function () {
  var e = this.infoContent = new m("div"),
    t = this.headerRow.createChild("div", {
      className: "infoButton"
    });
  u.addTooltip(t, e, {
    openOnTap: !0
  });
};
n.prototype._createSwitchToBuyModeButton = function () {
  var e = this;
  this.switchToBuyModeBtn = this.headerRow.appendChild(new a({
    addIcon: !0,
    className: ["buyModeBtn", "greenButton"],
    tooltip: s("ui.bidhouse.bigStoreModeBuy")
  }, function () {
    o.switchBuySellMode(!1, e.npcId);
    this.disable();
  }));
};
n.prototype._createViewer = function () {
  function e(e, t) {
    return e.objectPrice - t.objectPrice;
  }
  function t(e) {
    window.dofus.sendMessage("ExchangeObjectMoveMessage", {
      objectUID: e.objectUID,
      quantity: -e.quantity
    });
  }
  var i = this,
    n = [{
      id: "icon",
      format: function (e) {
        var t = new m("div", {
            className: "slot"
          }),
          i = t.createChild("div", {
            className: "icon"
          });
        return i.setStyle("backgroundImage", e.getProperty("image")), i.createChild("div", {
          className: "quantity",
          text: e.quantity > 1 ? e.quantity : ""
        }), t;
      }
    }, {
      id: "name",
      header: s("ui.common.name"),
      getContent: function (e) {
        return e.item.nameId;
      },
      sort: !0
    }, {
      id: "price",
      header: s("ui.common.price"),
      format: function (e) {
        var t;
        if (i.currency) {
          t = new m("div", {
            className: "token"
          });
          var n = t.createChild("div", {
            className: "icon"
          });
          n.setStyle("backgroundImage", i.token.image);
          t.createChild("div", {
            className: "quantity",
            text: "x" + e.objectPrice
          });
        } else {
          t = r.kamasToString(e.objectPrice);
        }
        return t;
      },
      sort: e,
      defaultSorter: !0
    }],
    o = this._slideBack = new m("div", {
      className: "slideBack"
    });
  o.modify = o.createChild("div", {
    className: "modify",
    text: s("ui.common.modify")
  });
  o.remove = o.createChild("div", {
    className: "remove",
    text: s("ui.common.remove")
  });
  o.createChild("div", {
    className: ["remove", "right"],
    text: s("ui.common.remove")
  });
  this.shopViewer = this.windowBody.appendChild(new d(n, function (e) {
    return e.hasOwnProperty("objectUID") ? e.objectUID : e.hasOwnProperty("objectGID") ? e.objectGID : 0;
  }, {
    tableOption: {
      slidable: o,
      scaleOnPress: !0
    }
  }));
  this.shopViewer.on("itemSelected", function (e) {
    i._showCurrentItem(e);
  });
  this.shopViewer.on("rowSlidedRight", function (e, i) {
    t(i);
  });
  this.shopViewer.on("rowSlidedLeft", function (e, i) {
    t(i);
  });
  this.shopViewer.on("totalPriceUpdated", function (e) {
    i._totalItemsPrice = e;
    i._updatePlayerInformation();
  });
};
n.prototype._showCurrentItem = function (e) {
  this.currentItem = e;
  p.getWindow("tradeItem").displayItem(this.mode, e, this.token && this.token.nameId);
};
n.prototype._selectItemByUID = function (e, t) {
  var i = this.shopViewer.getItem(e);
  return !!i && (t && this.setFilter(i.getProperty("typeId")), this.shopViewer.selectItem(e), this._showCurrentItem(i), !0);
};
n.prototype.setFilter = function (e) {
  return this.shopViewer.selectFilter(e);
};
n.prototype._setupEventListeners = function () {
  function e(e, t) {
    c.createItemInstances(e, function (e, i) {
      return e ? console.error(e) : void (t ? n.shopViewer.addItemsAndHighlightThem(i.array, "modify-bidHouse" === n.mode) : n.shopViewer.addItems(i.array, "modify-bidHouse" === n.mode));
    });
  }
  function t(e) {
    n.currentItem && e.indexOf(n.currentItem.objectUID) >= 0 && "modify-bidHouse" === n.mode && p.close("tradeItem");
    for (var t = 0; t < e.length; t++) {
      n.shopViewer.table.endSlide(e[t]);
    }
    n.shopViewer.removeItems(e, "modify-bidHouse" === n.mode);
  }
  var i = window.dofus.connectionManager,
    n = this;
  i.on("ExchangeBidHouseItemAddOkMessage", function (t) {
    e([t.itemInfo], !1);
    n._itemCount++;
    n._updatePlayerInformation();
  });
  i.on("ExchangeBidHouseItemRemoveOkMessage", function (e) {
    t([e.sellerId]);
    n._itemCount--;
    n._updatePlayerInformation();
  });
};
this.setTitle(s("ui.common.shop"));
this.shopViewer.table.setSlideEnable(!1);
this.npcId = o.npcContextualId;
i = !0;
this.infoContent.setHtml(this._getBidHouseInfoHtml(o));
this._totalItemsPrice = 0;
this._itemCount = e.objectsInfos.length;
this._updatePlayerInformation();
this.switchToBuyModeBtn.enable();
this.shopViewer.table.setSlideEnable(!0);
this._slideBack.modify.hide();
this._slideBack.remove.show();
n ? p.arrangeOpeningWindowVertically(this.id, {
  below: "wallet",
  fullHeight: !0
}) : p.positionWindow(this.id, g);
this.headerRow.toggleDisplay(i);
this.shopViewer.table.setContentLoading(!0);
this.lastOpenMode !== this.mode && (this.lasOpenMode && this.delClassNames(this.lasOpenMode), this.addClassNames(this.mode));
this.lasOpenMode = this.mode;
c.createItemInstances(e.objectsInfos, function (i, n) {
  return t.shopViewer.table.setContentLoading(!1), i ? console.error(i) : (t.currency = e.tokenId, t.token = e.token || null, t.shopViewer.setItemList(n.array, "modify-bidHouse" === t.mode), void (t.openOnItem && t.navigateToItem(t.openOnItem)));
});
this.currentItem = null;
this.shopViewer.clearContent();
p.close("tradeItem");
this._createHeader();
this._createViewer();
this._playerInfoElt = e.createChild("div", {
  className: "playerInfoElt"
});
this._itemCountElt = this._playerInfoElt.createChild("div", {
  className: "itemCountElt"
});
this._totalItemsPriceElt = this._playerInfoElt.createChild("div", {
  className: "totalItemsPriceElt"
});
this._playerInfoTooltop = new m("div");
this._itemCountTooltip = this._playerInfoTooltop.createChild("div", {
  className: "itemCount"
});
this._totalItemsPriceTooltip = this._playerInfoTooltop.createChild("div", {
  className: "totalItemsPrice"
});
u.addTooltip(this._playerInfoElt, this._playerInfoTooltop);
this._createInfoButton();
this._createSwitchToBuyModeButton();
this._itemCountElt.setText(this._itemCount + "/" + this.descriptor.maxItemPerAccount);
this._itemCountTooltip.setText(s("ui.bidhouse.quantityObjectSold", this._itemCount, this.descriptor.maxItemPerAccount));
this._totalItemsPriceElt.setText(r.intToString(this._totalItemsPrice) + " K");
this._totalItemsPriceTooltip.setText(s("ui.bidhouse.quantityKamas", r.intToString(this._totalItemsPrice)));
o.switchBuySellMode(!1, e.npcId);
this.disable();
n.setStyle("backgroundImage", i.token.image);
t.createChild("div", {
  className: "quantity",
  text: "x" + e.objectPrice
});
o.modify = o.createChild("div", {
  className: "modify",
  text: s("ui.common.modify")
});
o.remove = o.createChild("div", {
  className: "remove",
  text: s("ui.common.remove")
});
o.createChild("div", {
  className: ["remove", "right"],
  text: s("ui.common.remove")
});
this.shopViewer = this.windowBody.appendChild(new d(n, function (e) {
  return e.hasOwnProperty("objectUID") ? e.objectUID : e.hasOwnProperty("objectGID") ? e.objectGID : 0;
}, {
  tableOption: {
    slidable: o,
    scaleOnPress: !0
  }
}));
this.shopViewer.on("itemSelected", function (e) {
  i._showCurrentItem(e);
});
this.shopViewer.on("rowSlidedRight", function (e, i) {
  t(i);
});
this.shopViewer.on("rowSlidedLeft", function (e, i) {
  t(i);
});
this.shopViewer.on("totalPriceUpdated", function (e) {
  i._totalItemsPrice = e;
  i._updatePlayerInformation();
});
i._totalItemsPrice = e;
i._updatePlayerInformation();
this.currentItem = e;
p.getWindow("tradeItem").displayItem(this.mode, e, this.token && this.token.nameId);
i.on("ExchangeBidHouseItemAddOkMessage", function (t) {
  e([t.itemInfo], !1);
  n._itemCount++;
  n._updatePlayerInformation();
});
i.on("ExchangeBidHouseItemRemoveOkMessage", function (e) {
  t([e.sellerId]);
  n._itemCount--;
  n._updatePlayerInformation();
});
e([t.itemInfo], !1);
n._itemCount++;
n._updatePlayerInformation();
t([e.sellerId]);
n._itemCount--;
n._updatePlayerInformation();
s.call(this, {
  className: "WalletWindow",
  positionInfo: {
    left: 0,
    top: 0,
    width: r,
    height: l
  },
  noCloseButton: !0,
  noTitle: !0
});
this.wallet = null;
this.on("open", this._onOpen);
o(n, s);
e.exports = n;
n.height = l;
n.width = r;
n.prototype._onOpen = function () {
  this.wallet || (this.wallet = this.windowBody.appendChild(new a({
    className: "small"
  })));
};
e = e || {};
d.call(this, "div", e);
this.addClassNames("wallet");
this._isFakingGoultine = !1;
this.goultineAmount = 0;
this.kamaAmount = 0;
this.emitTap = e.emitTap;
this.showBonusPack = Boolean(e.showBonusPack);
this._createContent();
this._initialize();
l(n, d);
e.exports = n;
n.prototype._initialize = function () {
  this._setupListeners();
  var e = window.gui.playerData.inventory;
  this._setSoftAmount(e.kamas);
  this._setHardAmount(e.goultines);
};
n.prototype._setHardAmount = function (e) {
  this.goultineAmount = e;
  this._isFakingGoultine || this.hardAmountElt.setText(r.intToString(e));
};
n.prototype._setSoftAmount = function (e) {
  this.kamaAmount = e;
  this.softAmountElt.setText(r.intToString(e));
};
n.prototype._createContent = function () {
  if (this.showBonusPack) {
    var e = this.createChild("div", {
      className: ["currency", "bonusPack"]
    });
    e.createChild("div", {
      className: "counterCrown"
    });
    var t = e.createChild("div", {
      className: "text"
    });
    this.bonusPackEliteDuration = t.createChild("div", {
      className: "eliteDuration",
      text: "0"
    });
    t.createChild("div", {
      className: "separatorBonus",
      text: " / "
    });
    this.bonusPackDuration = t.createChild("div", {
      className: "duration",
      text: "0"
    });
    e.createChild("div", {
      className: "currencyIcon"
    });
    this._refreshSubscriptionCountdown();
    h.addTooltip(this.bonusPackEliteDuration, u("ui.shop.bonusPackEliteTooltip"), {
      longTapExplanation: !0
    });
    h.addTooltip(this.bonusPackDuration, u("ui.shop.bonusPackTooltip"), {
      longTapExplanation: !0
    });
    this.bonusPackBtn = e.appendChild(new s({
      className: "moreButton"
    }, a));
    this.bonusPackBtn.myWallet = this;
  }
  var i = this.createChild("div", {
    className: ["currency", "goultines"]
  });
  this.hardAmountElt = i.createChild("div", {
    className: "text"
  });
  i.createChild("div", {
    className: "currencyIcon"
  });
  this.goultinesBtn = i.appendChild(new s({
    className: "moreButton"
  }, o));
  this.goultinesBtn.myWallet = this;
  var n = this.createChild("div", {
    className: ["currency", "kamas"]
  });
  this.softAmountElt = n.createChild("div", {
    className: "text"
  });
  n.createChild("div", {
    className: "currencyIcon"
  });
};
n.prototype._setupListeners = function () {
  function e(e) {
    n._setHardAmount(e);
  }
  function t(e) {
    n._setSoftAmount(e);
  }
  var i = window.gui.playerData.inventory,
    n = this;
  i.on("goultinesUpdated", e);
  i.on("kamasUpdated", t);
  window.gui.playerData.on("subscriptionChanged", function () {
    n._refreshSubscriptionCountdown();
  });
  this.on("destroy", function () {
    i.removeListener("goultinesUpdated", e);
    i.removeListener("kamasUpdated", t);
    n.bonusPackCountdown && n.bonusPackCountdown.clear();
    n.bonusPackEliteCountdown && n.bonusPackEliteCountdown.clear();
  });
};
n.prototype._refreshSubscriptionCountdown = function () {
  var e = this,
    t = window.gui.playerData;
  if (this.bonusPackEliteDuration && this.bonusPackDuration) {
    var i = f.now() + t.getSubscriptionRemainingTime(m.NORMAL),
      n = f.now() + t.getSubscriptionRemainingTime(m.ELITE);
    this.bonusPackCountdown && this.bonusPackCountdown.clear();
    this.bonusPackCountdown = new p(new Date(i), function (t, i, n) {
      return t ? console.error(t) : void e.bonusPackDuration.setText(n.toUpperCase());
    }, function () {
      e.bonusPackDuration.setText("0 " + u("tablet.time.days.short"));
    });
    this.bonusPackDuration.delClassNames("paused");
    t.isSubscriberAtMinLevel(m.ELITE) && (this.bonusPackCountdown.clear(), this.bonusPackDuration.addClassNames("paused"));
    this.bonusPackEliteCountdown && this.bonusPackEliteCountdown.clear();
    this.bonusPackEliteCountdown = new p(new Date(n), function (t, i, n) {
      return t ? console.error(t) : void e.bonusPackEliteDuration.setText(n.toUpperCase());
    }, function () {
      e.bonusPackEliteDuration.setText("0 " + u("tablet.time.days.short"));
    });
  }
};
n.prototype.setFakeHardAmount = function (e) {
  this._isFakingGoultine = !0;
  this.hardAmountElt.setText(r.intToString(e));
};
n.prototype.resetFakeHardAmount = function () {
  this._isFakingGoultine = !1;
  this.hardAmountElt.setText(r.intToString(this.goultineAmount));
};
this._setSoftAmount(e.kamas);
this._setHardAmount(e.goultines);
this.goultineAmount = e;
this._isFakingGoultine || this.hardAmountElt.setText(r.intToString(e));
this.kamaAmount = e;
this.softAmountElt.setText(r.intToString(e));
this.bonusPackEliteDuration = t.createChild("div", {
  className: "eliteDuration",
  text: "0"
});
t.createChild("div", {
  className: "separatorBonus",
  text: " / "
});
this.bonusPackDuration = t.createChild("div", {
  className: "duration",
  text: "0"
});
e.createChild("div", {
  className: "currencyIcon"
});
this._refreshSubscriptionCountdown();
h.addTooltip(this.bonusPackEliteDuration, u("ui.shop.bonusPackEliteTooltip"), {
  longTapExplanation: !0
});
h.addTooltip(this.bonusPackDuration, u("ui.shop.bonusPackTooltip"), {
  longTapExplanation: !0
});
this.bonusPackBtn = e.appendChild(new s({
  className: "moreButton"
}, a));
this.bonusPackBtn.myWallet = this;
this.hardAmountElt = i.createChild("div", {
  className: "text"
});
i.createChild("div", {
  className: "currencyIcon"
});
this.goultinesBtn = i.appendChild(new s({
  className: "moreButton"
}, o));
this.goultinesBtn.myWallet = this;
this.softAmountElt = n.createChild("div", {
  className: "text"
});
n.createChild("div", {
  className: "currencyIcon"
});
i.on("goultinesUpdated", e);
i.on("kamasUpdated", t);
window.gui.playerData.on("subscriptionChanged", function () {
  n._refreshSubscriptionCountdown();
});
this.on("destroy", function () {
  i.removeListener("goultinesUpdated", e);
  i.removeListener("kamasUpdated", t);
  n.bonusPackCountdown && n.bonusPackCountdown.clear();
  n.bonusPackEliteCountdown && n.bonusPackEliteCountdown.clear();
});
i.removeListener("goultinesUpdated", e);
i.removeListener("kamasUpdated", t);
n.bonusPackCountdown && n.bonusPackCountdown.clear();
n.bonusPackEliteCountdown && n.bonusPackEliteCountdown.clear();
this.bonusPackCountdown && this.bonusPackCountdown.clear();
this.bonusPackCountdown = new p(new Date(i), function (t, i, n) {
  return t ? console.error(t) : void e.bonusPackDuration.setText(n.toUpperCase());
}, function () {
  e.bonusPackDuration.setText("0 " + u("tablet.time.days.short"));
});
this.bonusPackDuration.delClassNames("paused");
t.isSubscriberAtMinLevel(m.ELITE) && (this.bonusPackCountdown.clear(), this.bonusPackDuration.addClassNames("paused"));
this.bonusPackEliteCountdown && this.bonusPackEliteCountdown.clear();
this.bonusPackEliteCountdown = new p(new Date(n), function (t, i, n) {
  return t ? console.error(t) : void e.bonusPackEliteDuration.setText(n.toUpperCase());
}, function () {
  e.bonusPackEliteDuration.setText("0 " + u("tablet.time.days.short"));
});
this._isFakingGoultine = !0;
this.hardAmountElt.setText(r.intToString(e));
this._isFakingGoultine = !1;
this.hardAmountElt.setText(r.intToString(this.goultineAmount));
this._endTimestamp = e;
this._updateCallback = t;
this._endCallback = i;
this._endTimeout = null;
this._updateTimeout = null;
this._setUpdateTimeout();
this._setEndTimeout();
e.exports = n;
n.prototype.clear = function () {
  window.clearTimeout(this._updateTimeout);
  window.clearTimeout(this._endTimeout);
  this._endTimeout = null;
  this._updateTimeout = null;
  this._endTimestamp = null;
  this._updateCallback = null;
  this._endCallback = null;
};
n.prototype._setEndTimeout = function () {
  var e = this,
    t = s.now(),
    i = this._endTimestamp - t;
  i > c || (i > 0 ? this._endTimeout = window.setTimeout(function () {
    e._endCallback();
    e.clear();
  }, i) : (this._endCallback(), this.clear()));
};
n.prototype._setUpdateTimeout = function () {
  var e,
    t = this,
    i = s.now(),
    n = this._endTimestamp - i;
  if (!(n <= 0)) {
    var a = n % r === 0 ? 1 : 0,
      d = Math.max(0, ~~(n / c) - a),
      u = Math.max(0, ~~(n / l) - a),
      h = Math.max(0, ~~(n / r) - a);
    d ? e = n % c || c : u ? e = n % l || l : h && (e = n % r || r);
    var p = {
        day: d,
        hour: u,
        minute: h || 1
      },
      m = o(p);
    if (!m) {
      return t._updateCallback(new Error("Time left could not be formatted, day: " + p.day + ", hour: " + p.hour + ", minute: " + p.minute));
    }
    t._updateCallback(null, p, m);
    e && (this._updateTimeout = window.setTimeout(function () {
      t._setUpdateTimeout();
    }, e));
  }
};
window.clearTimeout(this._updateTimeout);
window.clearTimeout(this._endTimeout);
this._endTimeout = null;
this._updateTimeout = null;
this._endTimestamp = null;
this._updateCallback = null;
this._endCallback = null;
e._endCallback();
e.clear();
t._updateCallback(null, p, m);
e && (this._updateTimeout = window.setTimeout(function () {
  t._setUpdateTimeout();
}, e));
d.call(this, {
  className: ["WorldMapWindow", "withoutLeftColumn"],
  plusButton: !0,
  minusButton: !0,
  positionInfo: {
    width: "w",
    height: "h",
    isDefault: !0
  },
  title: u("ui.cartography.title")
});
this.status = {
  isWorldMapRefreshing: !1,
  isLoading: !1,
  openAtInfo: {},
  lastWindowInfo: {
    x: null,
    y: null,
    w: null,
    h: null
  }
};
this._worldMap = null;
this._conquestUIList = new y(e);
this._conquestPresenter = new g(new v(), this._conquestUIList);
this._taxCollectors = new b();
this._poiUpdater = null;
this._optionButtonsLoaded = !1;
this._buttonBox = null;
this._optionButtons = null;
this._maxContentSize = null;
this.minusButton.hide();
this.plusButton.hide();
this._isOpened = !1;
this.once("open", function (e) {
  this._addSpinner();
  var t = {
    x: p.mapLeft,
    y: p.mapTop,
    width: Math.round(p.mapWidth / 2),
    height: Math.round(p.mapHeight / 2)
  };
  m.positionWindow(this.id, t);
  this.status.lastWindowInfo.x = this.position.x;
  this.status.lastWindowInfo.y = this.position.y;
  this.status.lastWindowInfo.w = this.position.width;
  this.status.lastWindowInfo.h = this.position.height;
  var i = this;
  this._createWorldMap(function (t) {
    return t ? (i._removeSpinner(), console.error(t)) : (i._createDom(), i._setEvents(), i._poiUpdater = new c(i._worldMap), i.on("open", i._onOpen), void i._onOpen(e));
  });
});
this.on("close", this._onClose);
window.gui.on("disconnect", this._onDisconnect.bind(this));
this._isConquestListDisplayed = !1;
this._isMaximized = !1;
m.positionWindow(this.id, t);
this.status.lastWindowInfo.x = this.position.x;
this.status.lastWindowInfo.y = this.position.y;
this.status.lastWindowInfo.w = this.position.width;
this.status.lastWindowInfo.h = this.position.height;
r(n, d);
e.exports = n;
n.prototype._onDisconnect = function () {
  this._conquestPresenter.clear();
  this._worldMap && this._worldMap.clear();
  this._optionButtonsLoaded && this._resetOptionsButtons();
};
n.prototype._onClose = function () {
  this.status.isWorldMapRefreshing && this._worldMap.stopRefreshing();
  this._buttonBox && this._buttonBox.addClassNames("hidden");
  this._searchBox.setValue("");
  this._conquestPresenter.search("");
  this._isOpened = !1;
};
n.prototype._centerAndHighlight = function () {
  var e = this.status.openAtInfo;
  if (e.subareaConquest) {
    this._conquestPresenter.selectSubarea(e.subareaConquest);
  } else if (e.subarea) {
    this._worldMap.clearSubAreaHighlights();
    this._worldMap.addSubAreaHighlight(e.subarea, C);
    this._worldMap.centerOnSubArea(e.subarea);
  } else if (e.subareas) {
    var t = e.subareas;
    if (t.length >= 1) {
      this._worldMap.clearSubAreaHighlights();
      for (var i = 0; i < t.length; i++) {
        var n = t[i] === e.favorite ? I : C;
        this._worldMap.addSubAreaHighlight(t[i], n);
      }
      var o;
      switch (e.centerOn) {
        case "favorite":
          o = e.favorite;
          break;
        case "nearest":
          o = this._worldMap.getNearestSubarea(t);
          break;
        default:
          o = t[0];
      }
      this._worldMap.centerOnSubArea(o);
    }
  } else {
    this._worldMap.centerToPosition(e.coords);
  }
};
n.prototype._onOpen = function (e) {
  var t = this,
    i = window.gui;
  e = e || {};
  window.dofus.sendMessage("QuestListRequestMessage");
  this._cropWorldMapToWindow();
  var n = {
    posX: i.playerData.position.coordinates.posX,
    posY: i.playerData.position.coordinates.posY
  };
  return void 0 !== e.subarea ? this.status.openAtInfo = {
    subarea: e.subarea
  } : void 0 !== e.subareas ? this.status.openAtInfo = {
    subareas: e.subareas,
    favorite: e.favorite,
    centerOn: e.centerOn
  } : void 0 !== e.subareaConquest ? this.status.openAtInfo = {
    subareaConquest: e.subarea
  } : (void 0 !== e.x && void 0 !== e.y && (n.posX = e.x, n.posY = e.y), this.status.openAtInfo = {
    coords: n
  }), this._isOpened && i.playerData.position.worldmapId === this._worldMap.getDisplayedWorldmapId() ? this._centerAndHighlight() : void (this.status.isLoading || (this.status.isLoading = !0, this._addSpinner(), this._worldMap.initialize(n, function () {
    if (t.status.isWorldMapRefreshing = !0, t._removeSpinner(), t.status.isLoading = !1, t._isOpened = !0, !t.openState) {
      return t._onClose();
    }
    t._centerAndHighlight();
    var e = i.playerData.position.coordinates;
    t._worldMap.setIconPosition("userPosition", e.posX, e.posY);
    t._poiUpdater.updatePois();
    t._taxCollectors.updateTaxCollectors();
    t._conquestPresenter.setWorldMap(t._worldMap);
    t._taxCollectors.setWorldMap(t._worldMap);
    t._optionButtonsLoaded ? t._refreshOptionsButtonsSelections() : (t._createOptionsButtons(), t._createConquestButton());
    1 === t._worldMap.getDisplayedWorldmapId() ? t.conquestButton.show() : t.conquestButton.hide();
  })));
};
n.prototype._addSpinner = function () {
  this.windowBodyWrapper.addClassNames("spinner");
};
n.prototype._removeSpinner = function () {
  this.windowBodyWrapper.delClassNames("spinner");
};
n.prototype._getMaxContentSize = function () {
  if (!this._maxContentSize) {
    var e = this._getCurrentInnerBoundaries();
    this._maxContentSize = {
      width: p.windowFullScreenWidth - (this.position.width - e.width),
      height: p.windowFullScreenHeight - (this.position.height - e.height)
    };
  }
  return this._maxContentSize;
};
n.prototype._getCurrentInnerBoundaries = function () {
  var e = this.rightColumn.getComputedStyles("width", "height");
  return {
    width: parseInt(e.width, 10),
    height: parseInt(e.height, 10)
  };
};
n.prototype._cropWorldMapToWindow = function () {
  var e = this._getMaxContentSize(),
    t = this._getCurrentInnerBoundaries();
  this._worldMap.crop((e.width - t.width) / 2, (e.height - t.height) / 2, t.width, t.height);
};
n.prototype._exitFullScreen = function () {
  this.setStyles({
    width: this.status.lastWindowInfo.w + "px",
    height: this.status.lastWindowInfo.h + "px",
    webkitTransform: "translate3d(" + this.status.lastWindowInfo.x + "px," + this.status.lastWindowInfo.y + "px,0)"
  });
  this.position.x = this.status.lastWindowInfo.x;
  this.position.y = this.status.lastWindowInfo.y;
  this.position.width = this.status.lastWindowInfo.w;
  this.position.height = this.status.lastWindowInfo.h;
  this.emit("resize", !1);
};
n.prototype._setEvents = function () {
  var e = this,
    t = window.gui;
  t.playerData.position.on("mapUpdate", function () {
    if (e.openState) {
      if (e._worldMap.isLoading()) {
        var t = this.coordinates.posX,
          i = this.coordinates.posY;
        e._worldMap.once("loaded", function () {
          e._worldMap.setIconPosition("userPosition", t, i);
          e._worldMap.centerToMyPosition();
        });
      } else {
        e._worldMap.setIconPosition("userPosition", this.coordinates.posX, this.coordinates.posY);
        e._worldMap.centerToMyPosition();
      }
      e.status.isLoading && (e.status.openAtInfo = {
        coords: this.coordinates
      });
    }
  });
  this.on("repositioned", function () {
    e.emit("resize", !0);
  });
  this.on("positioned", function () {
    e.status.lastWindowInfo.x = e.position.x;
    e.status.lastWindowInfo.y = e.position.y;
    e._updateMySize();
  });
  t.playerData.position.on("worldMapUpdate", function () {
    e._onOpen();
    e._poiUpdater.updatePois();
  });
};
n.prototype._createWorldMap = function (e) {
  var t = this;
  this.leftColumn = this.createChild("div", {
    className: "leftColumn"
  });
  this.rightColumn = this.createChild("div", {
    className: "rightColumn"
  });
  this.searchBlock = this.leftColumn.createChild("div", {
    className: "searchBlock"
  });
  this._searchBox = this.searchBlock.appendChild(new _());
  this._searchBox.on("search", function (e) {
    t._conquestPresenter.search(e);
  });
  this._worldMap = new l();
  this._leftColumScroll = this.leftColumn.createChild("div", {
    className: "scroll"
  });
  this._leftColumScroll.appendChild(this._conquestUIList);
  this.rightColumn.appendChild(this._worldMap);
  this.windowBody.appendChild(this.leftColumn);
  this.windowBody.appendChild(this.rightColumn);
  this._worldMap.setupUI(this);
  var i = this._getMaxContentSize();
  this._worldMap.setDimensions(i.width, i.height);
  this._cropWorldMapToWindow();
  this._worldMap.addClassNames("centerMap");
  this._worldMap.preloadGenericAssets(e);
};
n.prototype._createOptionsButtons = function () {
  var e = this;
  this._optionButtons = {};
  this._buttonBox = this.windowBody.createChild("div", {
    className: ["buttonBox", "hidden"]
  });
  var t = o("grid", !1);
  this._worldMap.setGridVisibility(t);
  this._buttonBox.appendChild(this._createToggleButton("grid", t, u("ui.option.displayGrid"), function () {
    e._worldMap.setGridVisibility(this.selected);
    a("grid", this.selected);
  }));
  var i = o("landmarks", !0);
  this._worldMap.setVisibilityOfIconType("customFlag", i);
  this._worldMap.setVisibilityOfIconType("userPosition", i);
  this._worldMap.setVisibilityOfIconType("questObjective", i);
  this._worldMap.setVisibilityOfIconType("hint", i);
  this._buttonBox.appendChild(this._createToggleButton("landmarks", i, u("ui.cartography.flags"), function () {
    e._worldMap.setVisibilityOfIconType("customFlag", this.selected);
    e._worldMap.setVisibilityOfIconType("userPosition", this.selected);
    e._worldMap.setVisibilityOfIconType("questObjective", this.selected);
    e._worldMap.setVisibilityOfIconType("hint", this.selected);
    a("landmarks", this.selected);
  }));
  var n = o(A.possessions, !0);
  this._worldMap.setVisibilityOfIconType(A.possessions, n);
  this._buttonBox.appendChild(this._createToggleButton("possessions", n, u("ui.common.possessions"), function () {
    e._setIconsVisibleAndSaveUserPref(A.possessions, this.selected);
  }));
  var r = o(A.temples, !0);
  this._worldMap.setVisibilityOfIconType(A.temples, r);
  this._buttonBox.appendChild(this._createToggleButton("temples", r, u("ui.map.temple"), function () {
    e._setIconsVisibleAndSaveUserPref(A.temples, this.selected);
  }));
  var l = o(A.markets, !0);
  this._worldMap.setVisibilityOfIconType(A.markets, l);
  this._buttonBox.appendChild(this._createToggleButton("markets", l, u("ui.map.bidHouse"), function () {
    e._setIconsVisibleAndSaveUserPref(A.markets, this.selected);
  }));
  var c = o(A.workshops, !0);
  this._worldMap.setVisibilityOfIconType(A.workshops, c);
  this._buttonBox.appendChild(this._createToggleButton("workshops", c, u("ui.map.craftHouse"), function () {
    e._setIconsVisibleAndSaveUserPref(A.workshops, this.selected);
  }));
  var d = o(A.miscellaneous, !0);
  this._worldMap.setVisibilityOfIconType(A.miscellaneous, d);
  this._buttonBox.appendChild(this._createToggleButton("miscellaneous", d, u("ui.common.misc"), function () {
    e._setIconsVisibleAndSaveUserPref(A.miscellaneous, this.selected);
  }));
  var p = o("prisms", !0);
  this._worldMap.setVisibilityOfIconType("prisms", p);
  this._buttonBox.appendChild(this._createToggleButton("conquests", p, u("ui.map.conquest"), function () {
    e._setIconsVisibleAndSaveUserPref("prisms", this.selected);
  }));
  var m = o(A.dungeons, !0);
  this._worldMap.setVisibilityOfIconType(A.dungeons, m);
  this._buttonBox.appendChild(this._createToggleButton("dungeons", m, u("ui.map.dungeon"), function () {
    e._setIconsVisibleAndSaveUserPref(A.dungeons, this.selected);
  }));
  var f = o(A.lairs, !0);
  this._worldMap.setVisibilityOfIconType(A.lairs, f);
  this._buttonBox.appendChild(this._createToggleButton("lairs", f, u("tablet.ui.map.lair"), function () {
    e._setIconsVisibleAndSaveUserPref(A.lairs, this.selected);
  }));
  this.optionButton = new h({
    className: "optionButton",
    scaleOnPress: !0
  }, function () {
    e._buttonBox.toggleClassName("hidden");
  });
  this.optionButton.insertBefore(this.windowTitle);
  this.centerButton = new h({
    className: "centerButton",
    scaleOnPress: !0
  }, function () {
    e._worldMap.centerToMyPosition();
  });
  s(this.centerButton, u("ui.map.player"));
  this.centerButton.insertBefore(this.windowTitle);
  e._optionButtonsLoaded = !0;
};
n.prototype._createToggleButton = function (e, t, i, n) {
  var o = new h({
    className: ["mapBtn", e]
  }, function () {
    o.selected = !o.selected;
    o.toggleClassName("selected", this.selected);
    n.call(this);
  });
  return t ? (o.selected = !0, o.addClassNames("selected")) : o.selected = !1, o.defaultSelected = t, this._optionButtons[e] = o, s(o, i), o;
};
n.prototype._createConquestButton = function () {
  var e = this;
  this.conquestButton = new h({
    className: "conquestButton",
    text: u("ui.common.conquest")
  }, function () {
    e._isConquestListDisplayed ? (e._conquestPresenter.hideConquestList(), e._isConquestListDisplayed = !1, e.toggleClassName("withoutLeftColumn", !0)) : (e._conquestPresenter.showConquestList(), e._isConquestListDisplayed = !0, e.toggleClassName("withoutLeftColumn", !1));
    e.emit("resize", e._isMaximized);
  });
  this.conquestButton.insertBefore(e.optionButton);
};
n.prototype._setIconsVisibleAndSaveUserPref = function (e, t) {
  a(e, t);
  this._worldMap.setVisibilityOfIconType(e, t);
};
n.prototype._setIconsVisibleFromUserPref = function (e, t) {
  var i = o(e, t);
  this._worldMap.setVisibilityOfIconType(e, i);
};
n.prototype._refreshOptionsButtonsSelections = function () {
  this._setIconsVisibleFromUserPref("grid", !1);
  var e = o("landmarks", !0);
  this._worldMap.setVisibilityOfIconType("customFlag", e);
  this._worldMap.setVisibilityOfIconType("userPosition", e);
  this._worldMap.setVisibilityOfIconType("questObjective", e);
  this._worldMap.setVisibilityOfIconType("hint", e);
  this._setIconsVisibleFromUserPref(A.possessions, !0);
  this._setIconsVisibleFromUserPref(A.temples, !0);
  this._setIconsVisibleFromUserPref(A.markets, !0);
  this._setIconsVisibleFromUserPref(A.workshops, !0);
  this._setIconsVisibleFromUserPref(A.miscellaneous, !0);
  this._setIconsVisibleFromUserPref("prisms", !0);
  this._setIconsVisibleFromUserPref(A.dungeons, !0);
  this._setIconsVisibleFromUserPref(A.lairs, !0);
};
n.prototype._createDom = function () {
  var e = this;
  f(this, {
    minWidth: M,
    minHeight: M
  });
  this.on("resizeStart", function () {
    var t = e._getMaxContentSize();
    e._worldMap.crop(0, 0, t.width, t.height);
  });
  this.on("resize", function (t) {
    e._cropWorldMapToWindow();
    e._updateMySize(t);
  });
  this.plusButton.on("tap", function () {
    m.positionWindow("worldMap");
  });
  this.plusButton.show();
  this.minusButton.on("tap", function () {
    e._exitFullScreen();
  });
};
n.prototype._updateMySize = function (e) {
  if (this.plusButton.toggleDisplay(!e), this.minusButton.toggleDisplay(!!e), this._isMaximized = e, !e) {
    var t = parseInt(this.getStyle("width"), 10),
      i = parseInt(this.getStyle("height"), 10);
    t > .9 * p.windowFullScreenWidth && i > .9 * p.windowFullScreenHeight || (this.status.lastWindowInfo.w = t, this.status.lastWindowInfo.h = i);
  }
};
n.prototype._resetOptionsButtons = function () {
  for (var e in this._optionButtons) {
    var t = this._optionButtons[e];
    t.selected = t.defaultSelected;
    t.toggleClassName("selected", t.selected);
  }
};
n.prototype.isMaximized = function () {
  return this._isMaximized;
};
n.prototype.getWorldMap = function () {
  return this._worldMap;
};
this._conquestPresenter.clear();
this._worldMap && this._worldMap.clear();
this._optionButtonsLoaded && this._resetOptionsButtons();
this.status.isWorldMapRefreshing && this._worldMap.stopRefreshing();
this._buttonBox && this._buttonBox.addClassNames("hidden");
this._searchBox.setValue("");
this._conquestPresenter.search("");
this._isOpened = !1;
this._worldMap.clearSubAreaHighlights();
this._worldMap.addSubAreaHighlight(e.subarea, C);
this._worldMap.centerOnSubArea(e.subarea);
e = e || {};
window.dofus.sendMessage("QuestListRequestMessage");
this._cropWorldMapToWindow();
t._worldMap.setIconPosition("userPosition", e.posX, e.posY);
t._poiUpdater.updatePois();
t._taxCollectors.updateTaxCollectors();
t._conquestPresenter.setWorldMap(t._worldMap);
t._taxCollectors.setWorldMap(t._worldMap);
t._optionButtonsLoaded ? t._refreshOptionsButtonsSelections() : (t._createOptionsButtons(), t._createConquestButton());
1 === t._worldMap.getDisplayedWorldmapId() ? t.conquestButton.show() : t.conquestButton.hide();
this.setStyles({
  width: this.status.lastWindowInfo.w + "px",
  height: this.status.lastWindowInfo.h + "px",
  webkitTransform: "translate3d(" + this.status.lastWindowInfo.x + "px," + this.status.lastWindowInfo.y + "px,0)"
});
this.position.x = this.status.lastWindowInfo.x;
this.position.y = this.status.lastWindowInfo.y;
this.position.width = this.status.lastWindowInfo.w;
this.position.height = this.status.lastWindowInfo.h;
this.emit("resize", !1);
t.playerData.position.on("mapUpdate", function () {
  if (e.openState) {
    if (e._worldMap.isLoading()) {
      var t = this.coordinates.posX,
        i = this.coordinates.posY;
      e._worldMap.once("loaded", function () {
        e._worldMap.setIconPosition("userPosition", t, i);
        e._worldMap.centerToMyPosition();
      });
    } else {
      e._worldMap.setIconPosition("userPosition", this.coordinates.posX, this.coordinates.posY);
      e._worldMap.centerToMyPosition();
    }
    e.status.isLoading && (e.status.openAtInfo = {
      coords: this.coordinates
    });
  }
});
this.on("repositioned", function () {
  e.emit("resize", !0);
});
this.on("positioned", function () {
  e.status.lastWindowInfo.x = e.position.x;
  e.status.lastWindowInfo.y = e.position.y;
  e._updateMySize();
});
t.playerData.position.on("worldMapUpdate", function () {
  e._onOpen();
  e._poiUpdater.updatePois();
});
e._worldMap.setIconPosition("userPosition", t, i);
e._worldMap.centerToMyPosition();
e._worldMap.setIconPosition("userPosition", this.coordinates.posX, this.coordinates.posY);
e._worldMap.centerToMyPosition();
e.status.lastWindowInfo.x = e.position.x;
e.status.lastWindowInfo.y = e.position.y;
e._updateMySize();
e._onOpen();
e._poiUpdater.updatePois();
this.leftColumn = this.createChild("div", {
  className: "leftColumn"
});
this.rightColumn = this.createChild("div", {
  className: "rightColumn"
});
this.searchBlock = this.leftColumn.createChild("div", {
  className: "searchBlock"
});
this._searchBox = this.searchBlock.appendChild(new _());
this._searchBox.on("search", function (e) {
  t._conquestPresenter.search(e);
});
this._worldMap = new l();
this._leftColumScroll = this.leftColumn.createChild("div", {
  className: "scroll"
});
this._leftColumScroll.appendChild(this._conquestUIList);
this.rightColumn.appendChild(this._worldMap);
this.windowBody.appendChild(this.leftColumn);
this.windowBody.appendChild(this.rightColumn);
this._worldMap.setupUI(this);
this._worldMap.setDimensions(i.width, i.height);
this._cropWorldMapToWindow();
this._worldMap.addClassNames("centerMap");
this._worldMap.preloadGenericAssets(e);
this._optionButtons = {};
this._buttonBox = this.windowBody.createChild("div", {
  className: ["buttonBox", "hidden"]
});
this._worldMap.setGridVisibility(t);
this._buttonBox.appendChild(this._createToggleButton("grid", t, u("ui.option.displayGrid"), function () {
  e._worldMap.setGridVisibility(this.selected);
  a("grid", this.selected);
}));
e._worldMap.setGridVisibility(this.selected);
a("grid", this.selected);
this._worldMap.setVisibilityOfIconType("customFlag", i);
this._worldMap.setVisibilityOfIconType("userPosition", i);
this._worldMap.setVisibilityOfIconType("questObjective", i);
this._worldMap.setVisibilityOfIconType("hint", i);
this._buttonBox.appendChild(this._createToggleButton("landmarks", i, u("ui.cartography.flags"), function () {
  e._worldMap.setVisibilityOfIconType("customFlag", this.selected);
  e._worldMap.setVisibilityOfIconType("userPosition", this.selected);
  e._worldMap.setVisibilityOfIconType("questObjective", this.selected);
  e._worldMap.setVisibilityOfIconType("hint", this.selected);
  a("landmarks", this.selected);
}));
e._worldMap.setVisibilityOfIconType("customFlag", this.selected);
e._worldMap.setVisibilityOfIconType("userPosition", this.selected);
e._worldMap.setVisibilityOfIconType("questObjective", this.selected);
e._worldMap.setVisibilityOfIconType("hint", this.selected);
a("landmarks", this.selected);
this._worldMap.setVisibilityOfIconType(A.possessions, n);
this._buttonBox.appendChild(this._createToggleButton("possessions", n, u("ui.common.possessions"), function () {
  e._setIconsVisibleAndSaveUserPref(A.possessions, this.selected);
}));
this._worldMap.setVisibilityOfIconType(A.temples, r);
this._buttonBox.appendChild(this._createToggleButton("temples", r, u("ui.map.temple"), function () {
  e._setIconsVisibleAndSaveUserPref(A.temples, this.selected);
}));
this._worldMap.setVisibilityOfIconType(A.markets, l);
this._buttonBox.appendChild(this._createToggleButton("markets", l, u("ui.map.bidHouse"), function () {
  e._setIconsVisibleAndSaveUserPref(A.markets, this.selected);
}));
this._worldMap.setVisibilityOfIconType(A.workshops, c);
this._buttonBox.appendChild(this._createToggleButton("workshops", c, u("ui.map.craftHouse"), function () {
  e._setIconsVisibleAndSaveUserPref(A.workshops, this.selected);
}));
this._worldMap.setVisibilityOfIconType(A.miscellaneous, d);
this._buttonBox.appendChild(this._createToggleButton("miscellaneous", d, u("ui.common.misc"), function () {
  e._setIconsVisibleAndSaveUserPref(A.miscellaneous, this.selected);
}));
this._worldMap.setVisibilityOfIconType("prisms", p);
this._buttonBox.appendChild(this._createToggleButton("conquests", p, u("ui.map.conquest"), function () {
  e._setIconsVisibleAndSaveUserPref("prisms", this.selected);
}));
this._worldMap.setVisibilityOfIconType(A.dungeons, m);
this._buttonBox.appendChild(this._createToggleButton("dungeons", m, u("ui.map.dungeon"), function () {
  e._setIconsVisibleAndSaveUserPref(A.dungeons, this.selected);
}));
this._worldMap.setVisibilityOfIconType(A.lairs, f);
this._buttonBox.appendChild(this._createToggleButton("lairs", f, u("tablet.ui.map.lair"), function () {
  e._setIconsVisibleAndSaveUserPref(A.lairs, this.selected);
}));
this.optionButton = new h({
  className: "optionButton",
  scaleOnPress: !0
}, function () {
  e._buttonBox.toggleClassName("hidden");
});
this.optionButton.insertBefore(this.windowTitle);
this.centerButton = new h({
  className: "centerButton",
  scaleOnPress: !0
}, function () {
  e._worldMap.centerToMyPosition();
});
s(this.centerButton, u("ui.map.player"));
this.centerButton.insertBefore(this.windowTitle);
e._optionButtonsLoaded = !0;
o.selected = !o.selected;
o.toggleClassName("selected", this.selected);
n.call(this);
this.conquestButton = new h({
  className: "conquestButton",
  text: u("ui.common.conquest")
}, function () {
  e._isConquestListDisplayed ? (e._conquestPresenter.hideConquestList(), e._isConquestListDisplayed = !1, e.toggleClassName("withoutLeftColumn", !0)) : (e._conquestPresenter.showConquestList(), e._isConquestListDisplayed = !0, e.toggleClassName("withoutLeftColumn", !1));
  e.emit("resize", e._isMaximized);
});
this.conquestButton.insertBefore(e.optionButton);
e._isConquestListDisplayed ? (e._conquestPresenter.hideConquestList(), e._isConquestListDisplayed = !1, e.toggleClassName("withoutLeftColumn", !0)) : (e._conquestPresenter.showConquestList(), e._isConquestListDisplayed = !0, e.toggleClassName("withoutLeftColumn", !1));
e.emit("resize", e._isMaximized);
a(e, t);
this._worldMap.setVisibilityOfIconType(e, t);
this._worldMap.setVisibilityOfIconType("customFlag", e);
this._worldMap.setVisibilityOfIconType("userPosition", e);
this._worldMap.setVisibilityOfIconType("questObjective", e);
this._worldMap.setVisibilityOfIconType("hint", e);
this._setIconsVisibleFromUserPref(A.possessions, !0);
this._setIconsVisibleFromUserPref(A.temples, !0);
this._setIconsVisibleFromUserPref(A.markets, !0);
this._setIconsVisibleFromUserPref(A.workshops, !0);
this._setIconsVisibleFromUserPref(A.miscellaneous, !0);
this._setIconsVisibleFromUserPref("prisms", !0);
this._setIconsVisibleFromUserPref(A.dungeons, !0);
this._setIconsVisibleFromUserPref(A.lairs, !0);
f(this, {
  minWidth: M,
  minHeight: M
});
this.on("resizeStart", function () {
  var t = e._getMaxContentSize();
  e._worldMap.crop(0, 0, t.width, t.height);
});
this.on("resize", function (t) {
  e._cropWorldMapToWindow();
  e._updateMySize(t);
});
this.plusButton.on("tap", function () {
  m.positionWindow("worldMap");
});
this.plusButton.show();
this.minusButton.on("tap", function () {
  e._exitFullScreen();
});
e._cropWorldMapToWindow();
e._updateMySize(t);
t.selected = t.defaultSelected;
t.toggleClassName("selected", t.selected);
r.call(this, "div", {
  className: "WorldMap"
});
this.canvas = this.createChild("canvas", {
  className: ["WorldMap", "canvas"]
}).rootElement;
this._scene = new l({
  canvas: this.canvas,
  name: "worldMapScene",
  l: 0,
  t: 0,
  w: 1,
  h: 1,
  pixelRatio: c.PIXEL_RATIO,
  textureRatio: c.PRERENDER_RATIO_WORLDMAP,
  nbCacheableSprites: c.MAX_SPRITES_BUFFER_WORLDMAP,
  textureMemoryCacheSize: c.MAX_TEXTURE_MEMORY_WORLDMAP,
  prerenderQualityRatio: c.PRERENDER_RATIO_WORLDMAP
});
this._nZonesHorizontally = 0;
this._nZonesVertically = 0;
this._worldMapWidth = 1;
this._worldMapHeight = 1;
this.cropPosition = {
  x: 0,
  y: 0,
  width: 1,
  height: 1
};
this._topLeftZoneCoordinate = null;
this._worldMapId = 0;
this._worldMapData = null;
this._isLoadingWorldMapData = !1;
this._zoomLevels = [];
this._chunkSprites = {};
this._chunkBatchIndexes = {};
this._chunkBatchCurrent = 0;
this._fullMapSprite = null;
this._subAreaSprites = {};
this._subAreaData = {};
this._subAreaIdPerCoordinate = {};
this._gridSprite = null;
this._zoneHighlight = null;
this.dimensions = {
  width: 0,
  height: 0
};
this._iconsInfo = {};
this._iconsImage = null;
this._iconBatchData = new E(this);
this._setupListeners();
s(n, r);
e.exports = n;
n.prototype._setupListeners = function () {
  function e() {
    t._iconBatchData && t._iconBatchData.checkIconsCriterions();
  }
  var t = this,
    i = window.gui.playerData,
    n = i.quests;
  i.on("characterLevelUp", e);
  n.on("questStarted", e);
  n.on("questUpdate", e);
  n.on("stepValidated", e);
  n.on("objectiveValidated", e);
  n.on("questFinished", e);
  n.on("listUpdated", e);
};
n.prototype.preloadGenericAssets = function (e) {
  var t = this;
  _.getAllDataMap(["SubAreaIdPerCoordinate", "SubAreasWorldMapData", "Hints"], function (i, n) {
    return i ? e(i) : (t._subAreaIdPerCoordinate = n.SubAreaIdPerCoordinate, t._subAreaData = n.SubAreasWorldMapData, t._iconsInfo = n.Hints, void g.loadModel("icon", "assets", function (i, n) {
      var o = 1;
      i.meta && i.symbols && (o = i.meta.scale / M.ICONS_ORIGINAL_EXPORT_SCALE, i = i.symbols);
      t._iconsImage = n;
      var a = t._scene.createTexture(n, "worldMapIcons", "linear", "permanent");
      t._iconBatchData.createIconModels(i, a, o);
      e();
    }));
  });
};
n.prototype.stopMovingWorldMap = function () {
  this._scene.camera.stopMoving();
  this._loadChunksInView();
};
n.prototype.centerToPosition = function (e) {
  if (this._worldMapData) {
    if (!e) {
      return void console.error(new Error("centerToPosition no coords"));
    }
    if (void 0 === e.posX || void 0 === e.posY) {
      return void console.error(new Error("centerToPosition no pos: " + e.constructor.name));
    }
    var t = this._convertGridToSceneCoordinate(e.posX, e.posY);
    this._scene.camera.follow(t);
    this._loadChunksInView();
  }
};
n.prototype.centerOnSubArea = function (e) {
  var t = this.getSubAreaBounds(e);
  return !!t && (this.centerToPosition({
    posX: t.x + t.width / 2,
    posY: t.y + t.height / 2
  }), !0);
};
n.prototype.getNearestSubarea = function (e) {
  for (var t, i = window.gui.playerData.position.coordinates, n = 1 / 0, o = 0; o < e.length; o++) {
    var a = e[o],
      s = this.getSubAreaBounds(a);
    if (s) {
      var r = s.x + s.width / 2,
        l = s.y + s.height / 2,
        c = Math.abs(r - i.posX) + Math.abs(l - i.posY);
      c >= n || (n = c, t = a);
    }
  }
  return t;
};
n.prototype.centerToMyPosition = function () {
  if (this._worldMapData) {
    var e = window.gui.playerData.position.coordinates;
    this.centerToPosition(e);
  }
};
n.prototype.setDimensions = function (e, t) {
  this.dimensions.width = e;
  this.dimensions.height = t;
  this.cropPosition.width = e;
  this.cropPosition.height = t;
  this.setStyles({
    width: e + "px",
    height: t + "px"
  });
  this.setCanvasDimensions(e, t);
};
n.prototype.getDisplayedWorldmapId = function () {
  return this._worldMapId;
};
n.prototype.initialize = function (e, t) {
  var i = window.gui.playerData.position.worldmapId;
  if (this._worldMapId === i) {
    return this._isLoadingWorldMapData ? console.error("[WorldMap.initialize]", "Initialisation already launched") : this._display(), t();
  }
  if (this._isLoadingWorldMapData) {
    return console.error("[WorldMap.initialize]", "Initialisation of a world map of another id is already launched", "Asked ", i, "Loading", this._worldMapId), t();
  }
  null !== this._fullMapSprite && this.clear();
  this._worldMapId = i || 1;
  this._isLoadingWorldMapData = !0;
  var n = window.gui.databases.WorldMaps[this._worldMapId];
  if (window.gui.playerData.position.worldmapId !== this._worldMapId) {
    return this.initialize(e, t);
  }
  this._worldMapData = n;
  3 === this._worldMapId ? (this._worldMapWidth = n.totalWidth / 2, this._worldMapHeight = n.totalHeight / 2) : (this._worldMapWidth = n.totalWidth, this._worldMapHeight = n.totalHeight);
  this._zoneWidth = n.mapWidth;
  this._zoneHeight = n.mapHeight;
  var o = window.gui.playerData.position.coordinates,
    a = e.posX || o.posX,
    s = e.posY || o.posY,
    r = this._convertGridToSceneCoordinate(a, s),
    l = n.zoom,
    u = parseFloat(l[0]),
    h = parseFloat(l[1]);
  this._zoomLevels = [u];
  for (var p = 2; p < l.length; p += 1) {
    var m = parseFloat(l[p]);
    2 * m < u ? (this._zoomLevels.push(h), u = h, h = m) : h = m;
  }
  this._zoomLevels.push(h);
  this._scene.camera.setZoomMax(this._zoomLevels[0]);
  this._scene.setDimensions(0, 0, this._worldMapWidth, this._worldMapHeight);
  this._scene.camera.setZoom(this._zoomLevels[0]);
  this._scene.camera.setPosition(r.x, r.y);
  this._topLeftZoneCoordinate = this.convertSceneToGridCoordinate(0, 0);
  var g = this,
    _ = c.WORLDMAP_PATH + this._worldMapId + "-full.jpg";
  f.loadTexture(_, function (e) {
    return g._fullMapSprite = new d({
      scene: g._scene,
      x: 0,
      y: 0,
      w: g._worldMapWidth,
      h: g._worldMapHeight,
      layer: -1
    }, e), g._prepareGrid(), g._prepareIcons(), g._display(), g._isLoadingWorldMapData = !1, g.emit("loaded"), t();
  }, this._scene.renderer, "linear");
};
n.prototype.isLoading = function () {
  return this._isLoadingWorldMapData;
};
n.prototype.getScene = function () {
  return this._scene;
};
n.prototype._display = function () {
  this._loadChunksInView();
  y.addScene(this._scene);
};
n.prototype._prepareGrid = function () {
  null !== this._gridSprite && this._gridSprite.remove();
  var e = this._zoneWidth,
    t = this._zoneHeight,
    i = 0,
    n = 0;
  this._worldMapData ? (i = this._worldMapData.origineX % e, n = this._worldMapData.origineY % t) : console.error(new Error("worldMapData are not ready yet!"));
  var o = Math.floor((this._worldMapWidth - i) / e),
    a = Math.floor((this._worldMapHeight - n) / t);
  this._nZonesHorizontally = o;
  this._nZonesVertically = a;
  for (var s = o + 1, r = a + 1, l = s * e, d = r * t, h = [], m = 0; m < s; m += 1) {
    var f = m * e;
    h.push(new u(f, -n, f, d - n));
  }
  for (var g = 0; g < r; g += 1) {
    var _ = g * t;
    h.push(new u(-i, _, l - i, _));
  }
  this._gridSprite = new p({
    scene: this._scene,
    x: i,
    y: n,
    lines: h,
    alpha: 0,
    lineWidth: 1 * c.PIXEL_RATIO,
    hue: [.85, .85, .85, .8],
    layer: 2,
    id: "worldMapGrid" + this._worldMapId
  });
  this._gridSprite.hide();
  this._gridTween = new z(this._gridSprite, ["alpha"]);
  var v = window.gui.playerData.position.coordinates,
    y = this._convertGridToSceneCoordinate(v.posX, v.posY),
    w = [{
      x0: -e / 2,
      y0: -t / 2,
      x1: -e / 2,
      y1: -t / 4
    }, {
      x0: -e / 2,
      y0: -t / 2,
      x1: -e / 4,
      y1: -t / 2
    }, {
      x0: e / 2,
      y0: t / 4,
      x1: e / 2,
      y1: t / 2
    }, {
      x0: e / 4,
      y0: t / 2,
      x1: e / 2,
      y1: t / 2
    }, {
      x0: e / 2,
      y0: -t / 4,
      x1: e / 2,
      y1: -t / 2
    }, {
      x0: e / 2,
      y0: -t / 2,
      x1: e / 4,
      y1: -t / 2
    }, {
      x0: -e / 2,
      y0: t / 4,
      x1: -e / 2,
      y1: t / 2
    }, {
      x0: -e / 4,
      y0: t / 2,
      x1: -e / 2,
      y1: t / 2
    }];
  this._zoneHighlight = new p({
    scene: this._scene,
    x: y.x,
    y: y.y,
    w: e,
    h: t,
    lines: w,
    lineWidth: 4 * c.PIXEL_RATIO,
    hue: [.1, .1, .1, 1],
    layer: 3,
    id: "worldMapHighlight" + this._worldMapId
  });
  this._zoneHighlight.hide();
  this._zoneHighlightTween = new z(this._zoneHighlight, ["x", "y"]);
};
n.prototype.setHighlightOn = function (e, t) {
  if (!this._isLoadingWorldMapData) {
    var i = this._convertGridToSceneCoordinate(e, t);
    this._zoneHighlight.isDisplayed ? ((this._zoneHighlightTween.starting || this._zoneHighlightTween.playing) && this._zoneHighlightTween.stop(), this._zoneHighlightTween.reset().from({
      x: this._zoneHighlight.x,
      y: this._zoneHighlight.y
    }).to({
      x: i.x,
      y: i.y
    }, 16, W.polyOut, 9).start()) : (this._zoneHighlight.show(), this._zoneHighlight.x = i.x, this._zoneHighlight.y = i.y);
  }
};
n.prototype.hideHighlight = function () {
  this._zoneHighlight && ((this._zoneHighlightTween.starting || this._zoneHighlightTween.playing) && this._zoneHighlightTween.stop(), this._zoneHighlight.hide());
};
n.prototype.setGridVisibility = function (e) {
  if (this._gridTween) {
    this._gridTween.playing && this._gridTween.stop();
    this._gridTween.removeOnFinish();
    var t = this._gridSprite.isDisplayed ? this._gridSprite.alpha : 0;
    if (e) {
      this._gridSprite.show();
      this._gridTween.reset().from({
        alpha: t
      }).to({
        alpha: 1
      }, 4);
    } else {
      this._gridTween.reset().from({
        alpha: t
      }).to({
        alpha: 0
      }, 4);
      var i = this._gridSprite;
      this._gridTween.onFinish(function () {
        i.hide();
      });
    }
    this._gridTween.start();
  }
};
i.on("characterLevelUp", e);
n.on("questStarted", e);
n.on("questUpdate", e);
n.on("stepValidated", e);
n.on("objectiveValidated", e);
n.on("questFinished", e);
n.on("listUpdated", e);
i.meta && i.symbols && (o = i.meta.scale / M.ICONS_ORIGINAL_EXPORT_SCALE, i = i.symbols);
t._iconsImage = n;
t._iconBatchData.createIconModels(i, a, o);
e();
this._scene.camera.stopMoving();
this._loadChunksInView();
this._scene.camera.follow(t);
this._loadChunksInView();
this.dimensions.width = e;
this.dimensions.height = t;
this.cropPosition.width = e;
this.cropPosition.height = t;
this.setStyles({
  width: e + "px",
  height: t + "px"
});
this.setCanvasDimensions(e, t);
null !== this._fullMapSprite && this.clear();
this._worldMapId = i || 1;
this._isLoadingWorldMapData = !0;
this._worldMapData = n;
3 === this._worldMapId ? (this._worldMapWidth = n.totalWidth / 2, this._worldMapHeight = n.totalHeight / 2) : (this._worldMapWidth = n.totalWidth, this._worldMapHeight = n.totalHeight);
this._zoneWidth = n.mapWidth;
this._zoneHeight = n.mapHeight;
this._zoomLevels.push(h);
this._scene.camera.setZoomMax(this._zoomLevels[0]);
this._scene.setDimensions(0, 0, this._worldMapWidth, this._worldMapHeight);
this._scene.camera.setZoom(this._zoomLevels[0]);
this._scene.camera.setPosition(r.x, r.y);
this._topLeftZoneCoordinate = this.convertSceneToGridCoordinate(0, 0);
this._loadChunksInView();
y.addScene(this._scene);
this._nZonesHorizontally = o;
this._nZonesVertically = a;
this._gridSprite = new p({
  scene: this._scene,
  x: i,
  y: n,
  lines: h,
  alpha: 0,
  lineWidth: 1 * c.PIXEL_RATIO,
  hue: [.85, .85, .85, .8],
  layer: 2,
  id: "worldMapGrid" + this._worldMapId
});
this._gridSprite.hide();
this._gridTween = new z(this._gridSprite, ["alpha"]);
this._zoneHighlight = new p({
  scene: this._scene,
  x: y.x,
  y: y.y,
  w: e,
  h: t,
  lines: w,
  lineWidth: 4 * c.PIXEL_RATIO,
  hue: [.1, .1, .1, 1],
  layer: 3,
  id: "worldMapHighlight" + this._worldMapId
});
this._zoneHighlight.hide();
this._zoneHighlightTween = new z(this._zoneHighlight, ["x", "y"]);
this._gridTween.playing && this._gridTween.stop();
this._gridTween.removeOnFinish();
this._gridSprite.show();
this._gridTween.reset().from({
  alpha: t
}).to({
  alpha: 1
}, 4);
n.prototype.getSubAreaAtGridCoordinate = function (e, t) {
  for (var i = this._convertGridCoordinateToCompressedCoordinate(e, t), n = this._subAreaIdPerCoordinate[this._worldMapId][i]; void 0 === n && t >= q;) {
    i -= 1;
    t--;
    n = this._subAreaIdPerCoordinate[this._worldMapId][i];
  }
  if (n) {
    return this._subAreaData[n];
  }
};
n.prototype.convertGridCoordinateToZoneId = function (e, t) {
  return (t - this._topLeftZoneCoordinate.j) * this._nZonesHorizontally + (e - this._topLeftZoneCoordinate.i);
};
n.prototype.convertSceneToGridCoordinate = function (e, t) {
  return this._worldMapData ? {
    i: Math.floor((e - this._worldMapData.origineX) / this._zoneWidth),
    j: Math.floor((t - this._worldMapData.origineY) / this._zoneHeight)
  } : (console.error(new Error("worldMapData are not ready yet!")), {
    i: 0,
    j: 0
  });
};
n.prototype.convertCanvasToGridCoordinate = function (e, t) {
  var i = this._scene.convertCanvasToSceneCoordinate(e, t);
  return this.convertSceneToGridCoordinate(i.x, i.y);
};
n.prototype.convertGridToCanvasCoordinate = function (e, t) {
  var i = this._convertGridToSceneCoordinate(e, t);
  return this._scene.convertSceneToCanvasCoordinate(i.x, i.y);
};
n.prototype._getZoneGridPositions = function (e) {
  var t = this._subAreaData[e];
  if (!t) {
    return console.error("SubareaData not found for " + e);
  }
  var i = t.gridPositions[this._worldMapId];
  if (!i) {
    for (var n in t.gridPositions) {
      i = t.gridPositions[n];
      break;
    }
    if (!i) {
      return console.error("Grid positions missing for subarea " + e);
    }
  }
  return i;
};
n.prototype.getSubAreaBounds = function (e) {
  var t = window.gui.playerData.position.coordinates,
    i = this._getZoneGridPositions(e);
  if (i) {
    for (var n = o(i), a = {
        xMin: 0,
        yMin: 0,
        xMax: 0,
        yMax: 0
      }, s = 1 / 0, r = 0; r < n.length; r++) {
      for (var l = n[r], c = {
          xMin: 1 / 0,
          yMin: 1 / 0,
          xMax: -(1 / 0),
          yMax: -(1 / 0)
        }, d = 0; d < l.length; d++) {
        var u = l[d],
          h = i[u],
          p = i[u + 1];
        c.xMin = Math.min(h, c.xMin);
        c.xMax = Math.max(h, c.xMax);
        c.yMin = Math.min(p, c.yMin);
        c.yMax = Math.max(p, c.yMax);
      }
      var m = (c.xMin + c.xMax) / 2,
        f = (c.yMin + c.yMax) / 2,
        g = Math.abs(m - t.posX, f - t.posY);
      g < s && (s = g, a = c);
    }
    var _ = a.xMax - a.xMin,
      v = a.yMax - a.yMin;
    return {
      x: a.xMin,
      y: a.yMin,
      width: _,
      height: v
    };
  }
};
n.prototype.addSubAreaHighlight = function (e, t) {
  var i = "subAreaOverlay" + e;
  if (!this._subAreaSprites[e] || this._subAreaSprites[e].id !== i) {
    var n = this._getZoneGridPositions(e);
    if (n) {
      for (var o = [], a = 1 / 0, s = 1 / 0, r = -(1 / 0), l = -(1 / 0), c = {}, d = 0; d < n.length; d += 2) {
        var u = n[d],
          p = n[d + 1],
          f = u + ":" + p;
        if (void 0 === c[f]) {
          c[f] = !0;
          var g = this._convertGridToSceneCoordinate(u, p),
            _ = g.x - this._zoneWidth / 2,
            v = g.y - this._zoneHeight / 2;
          o.push(new h(_, v, _ + this._zoneWidth, v, _ + this._zoneWidth, v + this._zoneHeight, _, v + this._zoneHeight));
          _ < a && (a = _);
          _ > r && (r = _);
          v < s && (s = v);
          v > l && (l = v);
        }
      }
      null !== this._subAreaSprites[e] && void 0 !== this._subAreaSprites[e] && this._subAreaSprites[e].remove();
      this._subAreaSprites[e] = new m({
        scene: this._scene,
        x: 0,
        y: 0,
        boxes: o,
        hue: t || T,
        layer: 1,
        id: "subAreaOverlay" + e
      });
      new z(this._subAreaSprites[e], ["alpha"]).from({
        alpha: .4
      }).to({
        alpha: 1
      }, 15, W.polyOut, 3).to({
        alpha: .4
      }, 15, W.polyIn, 2).start(!0);
      new z(this._subAreaSprites[e].highlight, ["red", "green", "blue"]).from({
        red: .3,
        green: .3,
        blue: .3
      }).to({
        red: 1,
        green: 1,
        blue: 1
      }, 15, W.polyOut, 3).to({
        red: .3,
        green: .3,
        blue: .3
      }, 15, W.polyIn, 2).start(!0);
    }
  }
};
n.prototype.removeSubAreaHighlight = function (e) {
  if (null !== this._subAreaSprites[e] && void 0 !== this._subAreaSprites[e]) {
    var t = this._subAreaSprites[e];
    delete this._subAreaSprites[e];
    new z(t, ["alpha"]).from({
      alpha: 1
    }).to({
      alpha: 0
    }, 5).start().onFinish(function () {
      t.remove();
    });
  }
};
n.prototype.clearSubAreaHighlights = function (e) {
  for (var t in this._subAreaSprites) {
    e !== Number(t) && this.removeSubAreaHighlight(t);
  }
};
n.prototype.move = function (e, t, i, n, o) {
  this._scene.move(e, t, i, n, o);
  this._loadChunksInView();
};
n.prototype.addInertia = function (e, t) {
  this._scene.camera.addInertia(e, t, .8);
  this._loadChunksInView();
};
n.prototype._getZoomLevel = function (e) {
  for (var t, i = this._zoomLevels[0], n = 1; n < this._zoomLevels.length && (t = this._zoomLevels[n], !(e >= 1.2 * t)); n += 1) {
    i = t;
  }
  return i;
};
n.prototype._loadChunksInView = function () {
  function e(e, t) {
    var i = G._chunkBatchIndexes[e.id];
    return i !== G._chunkBatchCurrent ? (delete G._chunkBatchIndexes[e.id], t()) : void f.loadTexture(e.path, function (i) {
      var n = G._chunkBatchIndexes[e.id];
      return delete G._chunkBatchIndexes[e.id], n !== G._chunkBatchCurrent ? (i.release(), t()) : (e.texture = i, G._createChunkGraphic(e), void t());
    }, G._scene.renderer, "linear");
  }
  var t = this._scene.camera.zoomTarget;
  if (void 0 !== t) {
    if (0 === this._zoomLevels.length || 1.5 * t <= this._zoomLevels[this._zoomLevels.length - 1]) {
      return void this._clearChunks();
    }
    this._chunkBatchCurrent += 1;
    var i,
      n,
      o,
      s,
      r = this._getZoomLevel(t),
      l = this._scene.camera,
      d = l.followee.x - l.fovW / 2 * C;
    if (d < 0) {
      i = 0;
      n = Math.min(l.fovW * C, this._worldMapWidth);
    } else {
      var u = l.followee.x + l.fovW / 2 * C;
      u > this._worldMapWidth ? (i = Math.max(this._worldMapWidth - l.fovW * C, 0), n = this._worldMapWidth) : (i = d, n = u);
    }
    var h = l.followee.y - l.fovH / 2 * C;
    if (h < 0) {
      o = 0;
      s = Math.min(l.fovH * C, this._worldMapHeight);
    } else {
      var p = l.followee.y + l.fovH / 2 * C;
      p > this._worldMapHeight ? (o = Math.max(this._worldMapHeight - l.fovH * C, 0), s = this._worldMapHeight) : (o = h, s = p);
    }
    var m = this._convertSceneToChunkCoordinate(r, i, o),
      g = this._convertSceneToChunkCoordinate(r, n, s),
      _ = m.k,
      v = g.k,
      y = m.l,
      b = g.l,
      M = [],
      T = r * this._worldMapWidth / I,
      S = r * this._worldMapHeight / A,
      E = Math.ceil(T),
      N = Math.ceil(S);
    v === T && T === E && (v -= 1);
    b === S && S === N && (b -= 1);
    var x,
      L,
      O,
      R = Object.keys(this._chunkSprites);
    for (O = 0; O < R.length; O += 1) {
      this._chunkSprites[R[O]].id = null;
    }
    for (var D = y; D <= b; D += 1) {
      for (var P = _; P <= v; P += 1) {
        if (x = this._worldMapId + "-" + r + "-" + (D * E + P + 1).toString(), L = this._chunkSprites[x], void 0 === L) {
          if (void 0 === this._chunkBatchIndexes[x]) {
            var B = c.WORLDMAP_PATH + x + ".jpg",
              k = D - (y + b) / 2,
              F = P - (_ + v) / 2,
              H = Math.sqrt(k * k + F * F),
              z = this._scene.holdTexture(x),
              W = new w(P, D, r, x, B, z, this._scene, H);
            void 0 === z ? (M.push(W), this._chunkBatchIndexes[x] = this._chunkBatchCurrent) : this._createChunkGraphic(W);
          } else {
            this._chunkBatchIndexes[x] = this._chunkBatchCurrent;
          }
        } else {
          L.id = x;
        }
      }
    }
    for (O = 0; O < R.length; O += 1) {
      x = R[O];
      L = this._chunkSprites[x];
      null === L.id && (L.remove(), delete this._chunkSprites[x]);
    }
    M.sort(function (e, t) {
      return e.distToViewCenter - t.distToViewCenter;
    });
    var G = this;
    a.eachLimit(M, 5, e, function (e) {
      e && console.error("Chunk textures not loaded correctly", e);
    });
  }
};
n.prototype._createChunkGraphic = function (e) {
  e.w *= e.texture.element.width / I;
  e.h *= e.texture.element.height / A;
  this._chunkSprites[e.id] = new d(e, e.texture);
};
n.prototype._clearChunks = function () {
  for (var e = Object.keys(this._chunkSprites), t = 0; t < e.length; t += 1) {
    var i = this._chunkSprites[e[t]];
    i.remove();
  }
  this._chunkSprites = {};
};
n.prototype._convertGridCoordinateToCompressedCoordinate = function (e, t) {
  return ((e < 0 ? 32768 | 32767 & e : 32767 & e) << 16) + (t < 0 ? 32768 | 32767 & t : 32767 & t);
};
n.prototype._convertGridToSceneCoordinate = function (e, t) {
  if (!this._worldMapData) {
    return console.error(new Error("worldMapData are not ready yet!")), {
      x: 0,
      y: 0
    };
  }
  var i = this._worldMapData.origineX + e * this._zoneWidth + this._zoneWidth / 2,
    n = this._worldMapData.origineY + t * this._zoneHeight + this._zoneHeight / 2;
  return {
    x: i,
    y: n
  };
};
n.prototype._convertSceneToChunkCoordinate = function (e, t, i) {
  var n = Math.floor(e * t / I),
    o = Math.floor(e * i / A);
  return {
    k: n,
    l: o
  };
};
n.prototype.setCanvasDimensions = function (e, t) {
  this._scene.setCanvasDimensions(e, t);
  this._loadChunksInView();
};
n.prototype.stopRefreshing = function () {
  y.removeScene(this._scene);
};
n.prototype.crop = function (e, t, i, n) {
  this.cropPosition.x = e;
  this.cropPosition.y = t;
  this.cropPosition.width = i;
  this.cropPosition.height = n;
  this._scene.crop(e, t, i, n);
  this._loadChunksInView();
};
n.prototype.resetCropping = function () {
  this.cropPosition.x = this.cropPosition.y = 0;
  this.cropPosition.width = this.dimensions.width;
  this.cropPosition.height = this.dimensions.height;
  this._scene.resetCropping();
  this._loadChunksInView();
};
n.prototype.clear = function () {
  this._scene.clean();
  this._scene.clear();
  this._worldMapId = 0;
  this._fullMapSprite = null;
  this._chunkSprites = {};
  this._zoomLevels = [];
  this._worldMapData = null;
  this._iconBatchData.clearIconBatch();
};
n.prototype._prepareIcons = function () {
  this._iconBatchData.reset();
  this._iconBatchData.createIconsFromInfo(this._iconsInfo, this._worldMapId);
  this._iconBatchData.iconBatch = new N({
    id: "iconWorldMap_" + this._worldMapId,
    x: 0,
    y: 0,
    w: this._worldMapWidth,
    h: this._worldMapHeight,
    layer: 4,
    scene: this._scene,
    iconsData: this._iconBatchData
  });
  var e = window.gui.playerData.position.coordinates,
    t = this._convertGridToSceneCoordinate(e.posX, e.posY),
    i = "userPosition",
    n = new S(i, i, {
      color: [1, 1.1, 2, 1],
      clusterId: i
    }, this._iconBatchData.iconDimensions.myPosition),
    o = new x(i, t.x, t.y);
  this._iconBatchData.addCluster(o);
  o.add(n);
  n.cluster = o;
  this._iconBatchData.addIcon(n);
};
n.prototype.hasIcon = function (e) {
  return this._iconBatchData.hasIcon(e);
};
n.prototype.getIcon = function (e) {
  return this._iconBatchData.getIcon(e);
};
n.prototype.addIcon = function (e, t) {
  return this._iconBatchData.createIcon(e, t);
};
n.prototype.removeIcon = function (e) {
  this._iconBatchData.removeIcon(e);
};
n.prototype.setVisibilityOfIconType = function (e, t) {
  this._iconBatchData.setVisibilityOfIconType(e, t);
};
n.prototype.setIconPosition = function (e, t, i) {
  this._iconBatchData.setIconPosition(e, t, i);
};
n.prototype.convertZoneIdToGridCoordinate = function (e) {
  var t = Math.floor(e / this._nZonesHorizontally),
    i = this._topLeftZoneCoordinate;
  return {
    i: e - t * this._nZonesHorizontally + i.i,
    j: t + i.j
  };
};
n.prototype.getSubAreaAtCanvasCoordinate = function (e, t) {
  var i = this.convertCanvasToGridCoordinate(e, t);
  return this.getSubAreaAtGridCoordinate(i.i, i.j);
};
n.prototype.getIconsAtCanvasCoordinate = function (e, t) {
  var i = this.convertCanvasToGridCoordinate(e, t),
    n = this.convertGridCoordinateToZoneId(i.i, i.j);
  return this._iconBatchData.getClusterIcons(n);
};
n.prototype.setupUI = function (e) {
  this._setupMapTransform();
  this._setupMapTooltip(e);
};
n.prototype._setupMapTransform = function () {
  B(this, "HIGH");
  var e,
    t = 0,
    i = 0;
  this.on("transformStart", function () {
    e = Date.now();
    t = 0;
    i = 0;
  });
  this.on("transform", function (n, o, a, s, r) {
    e = Date.now();
    t = .5 * t + .5 * -a;
    i = .5 * i + .5 * -s;
    this.move(n, o, -a, -s, r);
  });
  this.on("transformEnd", function () {
    Date.now() - e > 100 || this.addInertia(t, i);
  });
};
n.prototype._setupMapTooltip = function (e) {
  function t(e) {
    if (p = H(g.rootElement), e = b.getCoordinatesRelativeToBody(e.x, e.y), r = e.x, l = e.y, c = r - p.left, d = l - p.top, m) {
      var t = null,
        i = null,
        n = c - g.cropPosition.x,
        o = Math.min(.1 * g.cropPosition.width, 50),
        a = 0;
      n < o ? (t = 0, a = n) : n > g.cropPosition.width - o && (t = g._worldMapWidth, a = g.cropPosition.width - n);
      var s = d - g.cropPosition.y,
        u = 0;
      if (s < o ? (i = 0, u = s) : s > g.cropPosition.height - o && (i = g._worldMapHeight, u = g.cropPosition.height - s), null === t && null === i) {
        M.playing && (M.stop(), g._loadChunksInView());
      } else {
        w.x = g._scene.camera.x;
        w.y = g._scene.camera.y;
        g._scene.camera.follow(w);
        var h = {
            x: w.x,
            y: w.y
          },
          f = {},
          v = 0,
          y = T;
        null === t ? f.x = w.x : (f.x = t, Math.abs(t - w.x) > v && (v = Math.abs(t - w.x), y = T * (o - a) / o));
        null === i ? f.y = w.y : (f.y = i, Math.abs(i - w.y) > v && (v = Math.abs(i - w.y), y = T * (o - u) / o));
        M.playing || M.start(!1);
        _.closeTooltip();
        M.reset().from(h).to(f, v / y);
        g._loadChunksInView();
      }
    }
  }
  function i() {
    p = H(g.rootElement);
  }
  function n(e, t) {
    var i = g.convertGridToCanvasCoordinate(e, t),
      n = g._scene.camera.zoom;
    return {
      centerX: i.x + p.left,
      centerY: i.y + p.top,
      width: Math.round(g._zoneWidth * n),
      height: Math.round(g._zoneHeight * n)
    };
  }
  function o(e, t, i) {
    var n = e.subAreaData,
      o = g.getSubAreaAtGridCoordinate(t, i);
    if (e.setCoordinates(t, i), o) {
      if (o && o !== n) {
        n && g.removeSubAreaHighlight(n.id);
        e.subAreaData = n = o;
        e.setSubArea(n);
        var a = O.entities.prism[n.id];
        if (a && a.prism) {
          var s = a.getAlliance();
          e.setAlliance(s);
          var r = P.hexToRgb(s.allianceEmblem.backgroundColor.toString(16));
          g.addSubAreaHighlight(n.id, [r[0] / 255, r[1] / 255, r[2] / 255, .25]);
        } else {
          e.unsetAlliance();
          g.addSubAreaHighlight(n.id, [1, 0, 0, .25]);
        }
      }
    } else {
      n && (g.removeSubAreaHighlight(n.id), n = null);
      e.unsetSubArea();
    }
    var l = g._iconBatchData.getClusterIcons(g.convertGridCoordinateToZoneId(t, i));
    l ? (e.setIcons(l, g._iconsImage), e.displayIcons()) : n ? e.displaySubArea() : e.displayCoordinates();
  }
  function a() {
    if (!M.playing) {
      var e = g.convertCanvasToGridCoordinate(c, d);
      if ((u !== e.i || h !== e.j) && m) {
        u = e.i;
        h = e.j;
        g.setHighlightOn(u, h);
        o(v, u, h);
        var t = n(u, h),
          i = 2 * G;
        _.openTooltipAt(t.centerX, t.centerY, t.width + i, t.height + i);
      }
    }
  }
  function s(e) {
    t(D(e));
    a();
  }
  k(this);
  var r,
    l,
    c,
    d,
    u,
    h,
    p,
    m,
    f = window.gui,
    g = this,
    _ = f.tooltipBox,
    v = new F();
  this.on("tap", function () {
    if (g._worldMapData) {
      var e = g.convertCanvasToGridCoordinate(c, d),
        t = this.convertGridCoordinateToZoneId(e.i, e.j);
      e.icons = this._iconBatchData.getClusterIcons(t);
      f.openContextualMenu("map", e);
      g.setHighlightOn(e.i, e.j);
    }
  });
  var y = R.getContextMenu("map");
  y.on("open", function (e) {
    o(y.worldMapTooltip, e.i, e.j);
  });
  y.on("close", function (e) {
    "reopen" !== e && g.hideHighlight();
  });
  var w = {},
    M = new z(w, ["x", "y"]);
  M.onFinish(function () {
    g._loadChunksInView();
  });
  var T = 50;
  this.on("dom.touchstart", function (e) {
    this.stopMovingWorldMap();
    t(D(e));
  });
  e.on("positioned", i);
  e.on("resize", i);
  L(this, v);
  this.on("tooltipOn", function () {
    m = !0;
    _.closeForRecomputing();
    a();
    f.wBody.on("dom.touchmove", s);
  });
  this.on("tooltipOut", function () {
    m = !1;
    f.wBody.removeListener("dom.touchmove", s);
    var e = v.subAreaData;
    e && g.removeSubAreaHighlight(e.id);
    g.hideHighlight();
    M.playing && M.stop();
    e = u = h = null;
  });
};
i -= 1;
t--;
n = this._subAreaIdPerCoordinate[this._worldMapId][i];
c.xMin = Math.min(h, c.xMin);
c.xMax = Math.max(h, c.xMax);
c.yMin = Math.min(p, c.yMin);
c.yMax = Math.max(p, c.yMax);
o.push(new h(_, v, _ + this._zoneWidth, v, _ + this._zoneWidth, v + this._zoneHeight, _, v + this._zoneHeight));
_ < a && (a = _);
_ > r && (r = _);
v < s && (s = v);
v > l && (l = v);
null !== this._subAreaSprites[e] && void 0 !== this._subAreaSprites[e] && this._subAreaSprites[e].remove();
this._subAreaSprites[e] = new m({
  scene: this._scene,
  x: 0,
  y: 0,
  boxes: o,
  hue: t || T,
  layer: 1,
  id: "subAreaOverlay" + e
});
new z(this._subAreaSprites[e], ["alpha"]).from({
  alpha: .4
}).to({
  alpha: 1
}, 15, W.polyOut, 3).to({
  alpha: .4
}, 15, W.polyIn, 2).start(!0);
new z(this._subAreaSprites[e].highlight, ["red", "green", "blue"]).from({
  red: .3,
  green: .3,
  blue: .3
}).to({
  red: 1,
  green: 1,
  blue: 1
}, 15, W.polyOut, 3).to({
  red: .3,
  green: .3,
  blue: .3
}, 15, W.polyIn, 2).start(!0);
delete this._subAreaSprites[e];
new z(t, ["alpha"]).from({
  alpha: 1
}).to({
  alpha: 0
}, 5).start().onFinish(function () {
  t.remove();
});
this._scene.move(e, t, i, n, o);
this._loadChunksInView();
this._scene.camera.addInertia(e, t, .8);
this._loadChunksInView();
i = 0;
n = Math.min(l.fovW * C, this._worldMapWidth);
o = 0;
s = Math.min(l.fovH * C, this._worldMapHeight);
v === T && T === E && (v -= 1);
b === S && S === N && (b -= 1);
x = R[O];
L = this._chunkSprites[x];
null === L.id && (L.remove(), delete this._chunkSprites[x]);
e.w *= e.texture.element.width / I;
e.h *= e.texture.element.height / A;
this._chunkSprites[e.id] = new d(e, e.texture);
this._scene.setCanvasDimensions(e, t);
this._loadChunksInView();
this.cropPosition.x = e;
this.cropPosition.y = t;
this.cropPosition.width = i;
this.cropPosition.height = n;
this._scene.crop(e, t, i, n);
this._loadChunksInView();
this.cropPosition.x = this.cropPosition.y = 0;
this.cropPosition.width = this.dimensions.width;
this.cropPosition.height = this.dimensions.height;
this._scene.resetCropping();
this._loadChunksInView();
this._scene.clean();
this._scene.clear();
this._worldMapId = 0;
this._fullMapSprite = null;
this._chunkSprites = {};
this._zoomLevels = [];
this._worldMapData = null;
this._iconBatchData.clearIconBatch();
this._iconBatchData.reset();
this._iconBatchData.createIconsFromInfo(this._iconsInfo, this._worldMapId);
this._iconBatchData.iconBatch = new N({
  id: "iconWorldMap_" + this._worldMapId,
  x: 0,
  y: 0,
  w: this._worldMapWidth,
  h: this._worldMapHeight,
  layer: 4,
  scene: this._scene,
  iconsData: this._iconBatchData
});
this._iconBatchData.addCluster(o);
o.add(n);
n.cluster = o;
this._iconBatchData.addIcon(n);
this._setupMapTransform();
this._setupMapTooltip(e);
this.on("transformStart", function () {
  e = Date.now();
  t = 0;
  i = 0;
});
this.on("transform", function (n, o, a, s, r) {
  e = Date.now();
  t = .5 * t + .5 * -a;
  i = .5 * i + .5 * -s;
  this.move(n, o, -a, -s, r);
});
this.on("transformEnd", function () {
  Date.now() - e > 100 || this.addInertia(t, i);
});
e = Date.now();
t = 0;
i = 0;
e = Date.now();
t = .5 * t + .5 * -a;
i = .5 * i + .5 * -s;
this.move(n, o, -a, -s, r);
w.x = g._scene.camera.x;
w.y = g._scene.camera.y;
g._scene.camera.follow(w);
null === t ? f.x = w.x : (f.x = t, Math.abs(t - w.x) > v && (v = Math.abs(t - w.x), y = T * (o - a) / o));
null === i ? f.y = w.y : (f.y = i, Math.abs(i - w.y) > v && (v = Math.abs(i - w.y), y = T * (o - u) / o));
M.playing || M.start(!1);
_.closeTooltip();
M.reset().from(h).to(f, v / y);
g._loadChunksInView();
n && g.removeSubAreaHighlight(n.id);
e.subAreaData = n = o;
e.setSubArea(n);
e.unsetAlliance();
g.addSubAreaHighlight(n.id, [1, 0, 0, .25]);
n && (g.removeSubAreaHighlight(n.id), n = null);
e.unsetSubArea();
u = e.i;
h = e.j;
g.setHighlightOn(u, h);
o(v, u, h);
t(D(e));
a();
e.icons = this._iconBatchData.getClusterIcons(t);
f.openContextualMenu("map", e);
g.setHighlightOn(e.i, e.j);
y.on("open", function (e) {
  o(y.worldMapTooltip, e.i, e.j);
});
y.on("close", function (e) {
  "reopen" !== e && g.hideHighlight();
});
this.on("dom.touchstart", function (e) {
  this.stopMovingWorldMap();
  t(D(e));
});
e.on("positioned", i);
e.on("resize", i);
L(this, v);
this.on("tooltipOn", function () {
  m = !0;
  _.closeForRecomputing();
  a();
  f.wBody.on("dom.touchmove", s);
});
this.on("tooltipOut", function () {
  m = !1;
  f.wBody.removeListener("dom.touchmove", s);
  var e = v.subAreaData;
  e && g.removeSubAreaHighlight(e.id);
  g.hideHighlight();
  M.playing && M.stop();
  e = u = h = null;
});
this.stopMovingWorldMap();
t(D(e));
m = !0;
_.closeForRecomputing();
a();
f.wBody.on("dom.touchmove", s);
m = !1;
f.wBody.removeListener("dom.touchmove", s);
e && g.removeSubAreaHighlight(e.id);
g.hideHighlight();
M.playing && M.stop();
e = u = h = null;
e.width = 128;
e.height = 128;
void 0 === e.name && console.error("[Scene] Parameter `name` required.");
void 0 === e.canvas && console.error("[Scene] Parameter `canvas` required.");
void 0 === e.pixelRatio && console.error("[Scene] Parameter `pixelRatio` required.");
void 0 === e.textureRatio && e.usePrecisionRendering && console.error("[Scene] Parameter `textureRatio` required.");
void 0 === e.w && console.error("[Scene] Parameter `w` required.");
void 0 === e.h && console.error("[Scene] Parameter `h` required.");
void 0 === e.t && console.error("[Scene] Parameter `t` required.");
void 0 === e.l && console.error("[Scene] Parameter `l` required.");
void 0 === e.nbCacheableSprites && console.error("[Scene] Parameter `nbCacheableSprites` required.");
void 0 === e.textureMemoryCacheSize && console.error("[Scene] Parameter `textureMemoryCacheSize` required.");
void 0 === e.prerenderQualityRatio && console.error("[Scene] Parameter `prerenderQualityRatio` required.");
this.name = e.name;
this.canvas = e.canvas;
this.canvas.id = this.name + "-canvas";
this.maxZoom = e.maxZoom || 1;
this.pixelRatio = e.pixelRatio;
this.sceneTextureRatio = e.textureRatio;
this.viewWidth = this.canvas.width;
this.viewHeight = this.canvas.height;
this.adjustToCanvasRatio = e.adjustToCanvasRatio || !1;
this.w = e.w;
this.h = e.h;
this.l = e.l;
this.t = e.t;
this.r = this.l + this.w;
this.b = this.t + this.h;
this.camera = new s(t, i, 1, this.l, this.r, this.t, this.b, this.canvas.width, this.canvas.height, this.maxZoom);
e.cameraAcceleration && this.camera.setDefaultAcceleration(e.cameraAcceleration);
this.cropping = {
  x: -(1 / 0),
  y: -(1 / 0),
  w: 1 / 0,
  h: 1 / 0,
  isActive: !1
};
this.displayList = new r(n);
this.hudDisplayList = new r(n);
this.staticElements = {
  sprite: null,
  render: function (e, t) {
    null !== this.sprite && this.sprite.draw(e, t);
  },
  add: function (e) {
    return this.sprite = e, e;
  },
  removeByRef: function (e) {
    return e === this.sprite && (this.sprite = null, !0);
  },
  reposition: function (e) {
    return e;
  },
  clear: function () {
    null !== this.sprite && (this.sprite.remove(), this.sprite = null);
  }
};
this.updateList = [];
this.renderer = new l(this.canvas, 0, 0, e.nbCacheableSprites, e.textureMemoryCacheSize, e.prerenderQualityRatio, !1);
this._debug = !1;
this._textureDebug = this.createTexture(o(), "mapDebug", "linear", "permanent");
this.usePrecisionRendering = e.usePrecisionRendering || !1;
this.usePrecisionRendering ? (this.areasToRefresh = [], this.sceneRendering = this.renderer.startTextureUsage(this.r - this.l, this.b - this.t, this.sceneTextureRatio, this.name), this.sceneTextureRatio = this.sceneRendering.width / (this.r - this.l), this.renderingProgram = this.renderer._programFiltering, this.renderingParams = {
  ratio: .15,
  resolution: 250
}, this.refresh = this._refreshPrecisionRendering, this.render = this._compositePrecisionRendering, this.clear = this._clearPrecisionRendering) : (this.refresh = this._refresh, this.render = this._composite, this.clear = this._clear);
this.setCanvasDimensions(this.canvas.width, this.canvas.height);
e.exports = a;
a.prototype.togglePixelArt = function () {
  this.renderingProgram === this.renderer._programPixelArt ? this.renderingProgram = this.renderer._programFiltering : this.renderingProgram = this.renderer._programPixelArt;
};
a.prototype.setShader = function (e) {
  switch (e) {
    case "pixelArt":
      this.renderingProgram = this.renderer._programPixelArt;
      break;
    case "mapTransition":
      this.renderingProgram = this.renderer._programMapTransition;
      break;
    default:
      this.renderingProgram = this.renderer._programFiltering;
  }
};
a.prototype._limitBoundArea = function (e) {
  e[0] = Math.min(this.r, Math.max(this.l, e[0]));
  e[1] = Math.min(this.r, Math.max(this.l, e[1]));
  e[2] = Math.min(this.b, Math.max(this.t, e[2]));
  e[3] = Math.min(this.b, Math.max(this.t, e[3]));
};
a.prototype._setSceneTransform = function () {
  var e = this.canvas.width / this.w,
    t = this.canvas.height / this.h,
    i = Math.max(e, t),
    n = Math.max(0, this.cropping.x) * this.pixelRatio,
    o = Math.max(0, this.cropping.y) * this.pixelRatio;
  this.renderer.setTransform(i, 0, 0, i, n, o);
};
a.prototype._setFieldOfView = function () {
  this.viewWidth = Math.min(this.cropping.w, this.canvas.width / this.pixelRatio);
  this.viewHeight = Math.min(this.cropping.h, this.canvas.height / this.pixelRatio);
  this.camera.setFieldOfView(this.viewWidth, this.viewHeight);
  this._setSceneTransform();
};
a.prototype.setCanvasDimensions = function (e, t, i, n, o) {
  if (void 0 !== o && (this.canvas.style.position = o), this._viewWidth === e && this._viewHeight === t && this._viewLeft === i && this._viewTop === n) {
    return !1;
  }
  this._viewWidth = e;
  this._viewHeight = t;
  this._viewLeft = i;
  this._viewTop = n;
  this.canvas.style.width = e.toString() + "px";
  this.canvas.style.height = t.toString() + "px";
  void 0 !== i && (this.canvas.style.left = i + "px");
  void 0 !== n && (this.canvas.style.top = n + "px");
  var a = e * this.pixelRatio,
    s = t * this.pixelRatio;
  if (this.canvas.width = a, this.canvas.height = s, this.renderer.resetDimension(a, s), this.adjustToCanvasRatio) {
    var r = this.h * a / s;
    this.setDimensions(this.l, this.t, r, this.h);
  }
  return this._setFieldOfView(), !0;
};
a.prototype.setDimensions = function (e, t, i, n) {
  this.w = i;
  this.h = n;
  this.l = e;
  this.t = t;
  this.r = this.l + this.w;
  this.b = this.t + this.h;
  this.camera.setBounds(this.l, this.r, this.t, this.b);
  this._setSceneTransform();
};
a.prototype.requireCompleteRefresh = function () {
  this.areasToRefresh.push([this.l, this.r, this.t, this.b]);
};
a.prototype._refresh = function (e) {
  var t = this.camera.updatePosition(e);
  if (0 !== this.updateList.length || t !== !1) {
    if (this.renderer.clear(), this.cropping.isActive) {
      var i = this.pixelRatio,
        n = Math.ceil(i * this.cropping.x),
        o = Math.ceil(i * this.cropping.y),
        a = Math.ceil(i * this.cropping.w),
        s = Math.ceil(i * this.cropping.h);
      o = this.canvas.height - s - o;
      this.renderer.enableScissor(n, o, a, s);
    }
    this._composite();
    this.cropping.isActive && this.renderer.disableScissor();
  }
};
a.prototype._composite = function () {
  for (var e = 0; e < this.updateList.length; e += 1) {
    this.updateList[e].refreshAnimation();
  }
  this.updateList.length = 0;
  var t = this.pixelRatio * this.camera.zoom * Math.min(this.w / this.canvas.width, this.h / this.canvas.height);
  this.renderer.save();
  this.renderer.translate(t / this.camera.zoom * this.viewWidth / 2, t / this.camera.zoom * this.viewHeight / 2);
  this.renderer.scale(t, t);
  this.renderer.translate(-this.camera.x, -this.camera.y);
  for (var i = this.displayList.first; null !== i; i = i.next) {
    i.object.render();
  }
  this._debug && this._renderDebug();
  this.renderer.restore();
};
a.prototype._renderDebug = function () {
  for (var e = this.displayList.first; null !== e; e = e.next) {
    var t = e.object;
    this.renderer.drawImage(this._textureDebug, t.x, t.y, t.w, t.h);
  }
};
a.prototype._refreshPrecisionRendering = function (e) {
  var t = this.camera.updatePosition(e);
  if (0 !== this.updateList.length) {
    for (var i = 0; i < this.updateList.length; i += 1) {
      this.updateList[i].refreshAnimation(this.areasToRefresh);
    }
    this.updateList.length = 0;
  }
  if (0 !== this.areasToRefresh.length) {
    for (var n = 0; n < this.areasToRefresh.length; n += 1) {
      this._limitBoundArea(this.areasToRefresh[n]);
    }
    for (var o = 0; o < this.areasToRefresh.length; o += 1) {
      var a = this.areasToRefresh[o];
      if (a[1] <= a[0] || a[3] <= a[2]) {
        this.areasToRefresh.splice(o, 1);
        o -= 1;
      } else {
        for (var s = 0; s < this.areasToRefresh.length; s += 1) {
          if (o !== s) {
            var r = this.areasToRefresh[s],
              l = (a[0] - r[1]) * (r[0] - a[1]) > 0,
              c = (a[2] - r[3]) * (r[2] - a[3]) > 0;
            l && c && (a[0] = Math.min(a[0], r[0]), a[1] = Math.max(a[1], r[1]), a[2] = Math.min(a[2], r[2]), a[3] = Math.max(a[3], r[3]), this.areasToRefresh.splice(s, 1), s -= 1, s < o && (o -= 1));
          }
        }
      }
    }
    this._refreshAreas();
    t = !0;
  }
  (t || this.hudDisplayList.count > 0) && (this._compositePrecisionRendering(), this._debug && this._renderDebugPrecisionRendering(this.areasToRefresh), this.areasToRefresh.length = 0);
  this.areasToRefresh.length > 0 && (this.areasToRefresh.length = 0);
};
e[0] = Math.min(this.r, Math.max(this.l, e[0]));
e[1] = Math.min(this.r, Math.max(this.l, e[1]));
e[2] = Math.min(this.b, Math.max(this.t, e[2]));
e[3] = Math.min(this.b, Math.max(this.t, e[3]));
this.viewWidth = Math.min(this.cropping.w, this.canvas.width / this.pixelRatio);
this.viewHeight = Math.min(this.cropping.h, this.canvas.height / this.pixelRatio);
this.camera.setFieldOfView(this.viewWidth, this.viewHeight);
this._setSceneTransform();
this._viewWidth = e;
this._viewHeight = t;
this._viewLeft = i;
this._viewTop = n;
this.canvas.style.width = e.toString() + "px";
this.canvas.style.height = t.toString() + "px";
void 0 !== i && (this.canvas.style.left = i + "px");
void 0 !== n && (this.canvas.style.top = n + "px");
this.w = i;
this.h = n;
this.l = e;
this.t = t;
this.r = this.l + this.w;
this.b = this.t + this.h;
this.camera.setBounds(this.l, this.r, this.t, this.b);
this._setSceneTransform();
o = this.canvas.height - s - o;
this.renderer.enableScissor(n, o, a, s);
this._composite();
this.cropping.isActive && this.renderer.disableScissor();
this.renderer.save();
this.renderer.translate(t / this.camera.zoom * this.viewWidth / 2, t / this.camera.zoom * this.viewHeight / 2);
this.renderer.scale(t, t);
this.renderer.translate(-this.camera.x, -this.camera.y);
this._debug && this._renderDebug();
this.renderer.restore();
this.areasToRefresh.splice(o, 1);
o -= 1;
this._refreshAreas();
t = !0;
(t || this.hudDisplayList.count > 0) && (this._compositePrecisionRendering(), this._debug && this._renderDebugPrecisionRendering(this.areasToRefresh), this.areasToRefresh.length = 0);
this.areasToRefresh.length > 0 && (this.areasToRefresh.length = 0);
a.prototype._refreshAreas = function () {
  this.renderer.startTextureRendering(this.sceneRendering, this.l, this.r, this.t, this.b);
  for (var e = c, t = 0; t < this.areasToRefresh.length; t += 1) {
    var i = this.areasToRefresh[t];
    this._limitBoundArea(i);
    var n = Math.floor(this.sceneTextureRatio * (i[0] - this.l)) - 1,
      o = Math.floor(this.sceneTextureRatio * (i[2] - this.t)) - 1,
      a = Math.ceil(this.sceneTextureRatio * (i[1] - i[0])) + 2,
      s = Math.ceil(this.sceneTextureRatio * (i[3] - i[2])) + 2;
    this.renderer.enableScissor(n, o, a, s);
    for (var r = this.displayList.first; null !== r; r = r.next) {
      var l = r.object,
        u = l.bbox;
      if (!(u[0] >= u[1])) {
        var h = (i[0] - u[1]) * (u[0] - i[1]) >= 0,
          p = (i[2] - u[3]) * (u[2] - i[3]) >= 0;
        h && p && (this.staticElements.render(e, l), e = l, l.render());
      }
    }
    this.staticElements.render(e, d);
  }
  this.renderer.stopTextureRendering();
  this.renderer.disableScissor();
};
a.prototype._compositePrecisionRendering = function () {
  var e = this.pixelRatio * this.camera.zoom * Math.min(this.w / this.canvas.width, this.h / this.canvas.height);
  if (this.renderer.disableBlending(), this.renderer.useProgram(this.renderingProgram, this.renderingParams), this.renderer.drawImage(this.sceneRendering.texture, this.w / 2 - (this.camera.x - this.l) * e, this.h / 2 - (this.camera.y - this.t) * e, e * this.w, e * this.h), this.renderer.stopProgram(), this.renderer.enableBlending(), this.hudDisplayList.count > 0) {
    this.renderer.useProgram(this.renderer._programRegular);
    for (var t = this.hudDisplayList.first; null !== t; t = t.next) {
      t.object.render();
    }
    this.renderer.stopProgram();
  }
};
a.prototype._renderDebugPrecisionRendering = function (e) {
  var t = this.camera.zoom * this.pixelRatio * this.w / this.canvas.width;
  this.renderer.save();
  this.renderer.translate(this.w / 2, this.h / 2);
  this.renderer.scale(t, t);
  this.renderer.translate(-(this.camera.x - this.l), -(this.camera.y - this.t));
  this.renderer.enableBlending();
  for (var i = 0; i < e.length; i += 1) {
    var n = e[i],
      o = n[0] - this.l,
      a = n[2] - this.t,
      s = n[1] - n[0],
      r = n[3] - n[2];
    this.renderer.drawImage(this._textureDebug, o, a, s, r);
  }
  this.renderer.restore();
};
a.prototype.crop = function (e, t, i, n) {
  this.cropping.isActive = !0;
  this.cropping.x = e;
  this.cropping.y = t;
  this.cropping.w = i;
  this.cropping.h = n;
  this._setFieldOfView();
};
a.prototype.resetCropping = function () {
  this.cropping.isActive = !1;
  this.cropping.x = -(1 / 0);
  this.cropping.y = -(1 / 0);
  this.cropping.w = 1 / 0;
  this.cropping.h = 1 / 0;
  this._setFieldOfView();
};
a.prototype.convertSceneToCanvasCoordinate = function (e, t) {
  var i = Math.max(0, this.cropping.x),
    n = Math.max(0, this.cropping.y);
  return {
    x: (e - this.camera.x + this.camera.fovW / 2) * this.camera.zoom + i,
    y: (t - this.camera.y + this.camera.fovH / 2) * this.camera.zoom + n
  };
};
a.prototype.convertCanvasToSceneCoordinate = function (e, t) {
  var i = Math.max(0, this.cropping.x),
    n = Math.max(0, this.cropping.y);
  return {
    x: (e - i) / this.camera.zoom + this.camera.x - this.camera.fovW / 2,
    y: (t - n) / this.camera.zoom + this.camera.y - this.camera.fovH / 2
  };
};
a.prototype.move = function (e, t, i, n, o) {
  e -= Math.max(0, this.cropping.x);
  t -= Math.max(0, this.cropping.y);
  this.camera.transform(e, t, i, n, o);
};
a.prototype.toggleDebugMode = function () {
  this._debug = !this._debug;
};
a.prototype.showSprites = function (e) {
  for (var t = 0; t < e.length; t++) {
    e[t].show();
  }
};
a.prototype.hideSprites = function (e) {
  for (var t = 0; t < e.length; t++) {
    e[t].hide();
  }
};
a.prototype.createTexture = function (e, t, i, n) {
  return this.renderer.createTexture(e, t, i, n);
};
a.prototype.useTexture = function (e) {
  return this.renderer.useTexture(e);
};
a.prototype.holdTexture = function (e) {
  return this.renderer.holdTexture(e);
};
a.prototype.clean = function () {
  for (var e = this.displayList.first; null !== e;) {
    var t = e.next;
    e.object.remove();
    e = t;
  }
  this.staticElements.clear();
};
a.prototype._clear = function (e, t, i, n) {
  this.renderer.setClearColor(e, t, i, n);
  this.renderer.clear();
  this.renderer.resetClearColor();
};
a.prototype._clearPrecisionRendering = function (e, t, i, n) {
  this.renderer.startTextureRendering(this.sceneRendering, this.l, this.r, this.t, this.b);
  this.renderer.setClearColor(e, t, i, n);
  this.renderer.clear();
  this.renderer.stopTextureRendering();
  this.renderer.clear();
  this.renderer.resetClearColor();
};
a.prototype.getImage = function (e, t) {
  var i = this.viewWidth,
    n = this.viewHeight;
  this.refresh(200);
  this.setCanvasDimensions(t * (i / n), t);
  var o = 4;
  this.render(200);
  this.renderer.clear();
  this.renderer.drawImage(this.sceneRendering.texture, this.w / 2 - (e.x - this.l) * o, this.h / 2 - (e.y - 10 - this.t) * o, o * this.w, o * this.h);
  var a = this.canvas.toDataURL("image/png");
  return this.setCanvasDimensions(i, n), this.render(200), a;
};
this.renderer.stopTextureRendering();
this.renderer.disableScissor();
this.renderer.save();
this.renderer.translate(this.w / 2, this.h / 2);
this.renderer.scale(t, t);
this.renderer.translate(-(this.camera.x - this.l), -(this.camera.y - this.t));
this.renderer.enableBlending();
this.cropping.isActive = !0;
this.cropping.x = e;
this.cropping.y = t;
this.cropping.w = i;
this.cropping.h = n;
this._setFieldOfView();
this.cropping.isActive = !1;
this.cropping.x = -(1 / 0);
this.cropping.y = -(1 / 0);
this.cropping.w = 1 / 0;
this.cropping.h = 1 / 0;
this._setFieldOfView();
e -= Math.max(0, this.cropping.x);
t -= Math.max(0, this.cropping.y);
this.camera.transform(e, t, i, n, o);
e.object.remove();
e = t;
this.renderer.setClearColor(e, t, i, n);
this.renderer.clear();
this.renderer.resetClearColor();
this.renderer.startTextureRendering(this.sceneRendering, this.l, this.r, this.t, this.b);
this.renderer.setClearColor(e, t, i, n);
this.renderer.clear();
this.renderer.stopTextureRendering();
this.renderer.clear();
this.renderer.resetClearColor();
this.refresh(200);
this.setCanvasDimensions(t * (i / n), t);
this.render(200);
this.renderer.clear();
this.renderer.drawImage(this.sceneRendering.texture, this.w / 2 - (e.x - this.l) * o, this.h / 2 - (e.y - 10 - this.t) * o, o * this.w, o * this.h);
o.call(this);
this.l = n;
this.r = a;
this.t = s;
this.b = l;
this.w = a - n;
this.h = l - s;
this.min = {
  x: 0,
  y: 0
};
this.max = {
  x: 0,
  y: 0
};
this.fovWAbsolute = c;
this.fovHAbsolute = d;
this.setZoomMax(u);
this._updateZoomBounds();
this.setZoom(i);
this.setPosition(e, t);
this.acceleration = r;
this.a = this.acceleration;
this._frozen = !1;
this.emitAtDestination = !1;
a(n, o);
e.exports = n;
n.prototype.setAcceleration = function (e) {
  this.a = e;
};
n.prototype.setDefaultAcceleration = function (e) {
  this.acceleration = e;
};
n.prototype.freeze = function () {
  this._frozen = !0;
};
n.prototype.unfreeze = function () {
  this._frozen = !1;
};
n.prototype.stopMoving = function () {
  this.followee = {
    x: this.x,
    y: this.y
  };
  this.zoomTarget = this.zoom;
  this.z = l / this.zoom;
};
n.prototype.setZoom = function (e) {
  e = Math.max(this.minZoom, Math.min(this.maxZoom, e));
  this.z = l / e;
  this.zoom = e;
  this.zoomTarget = e;
  this._updatePositionBounds();
};
n.prototype.setZoomMax = function (e) {
  this.maxZoom = e;
};
n.prototype.setPosition = function (e, t) {
  this.x = Math.min(this.max.x, Math.max(this.min.x, e));
  this.y = Math.min(this.max.y, Math.max(this.min.y, t));
  this.followee = {
    x: e,
    y: t
  };
};
n.prototype._updateZoomBounds = function () {
  var e = this.fovWAbsolute / this.w,
    t = this.fovHAbsolute / this.h;
  this.minZoom = Math.min(Math.max(e, t), this.maxZoom);
  this.zoom < this.minZoom && (this.zoom = this.minZoom);
  this.zoomTarget < this.minZoom && (this.zoomTarget = this.minZoom);
  this.z = l / this.zoom;
};
n.prototype._updatePositionBounds = function () {
  this.fovW = this.fovWAbsolute / this.zoomTarget;
  this.fovH = this.fovHAbsolute / this.zoomTarget;
  this.min.x = this.l + this.fovW / 2;
  this.min.y = this.t + this.fovH / 2;
  this.max.x = this.r - this.fovW / 2;
  this.max.y = this.b - this.fovH / 2;
  this.min.x > this.max.x && (this.min.x = this.max.x = (this.min.x + this.max.x) / 2);
  this.min.y > this.max.y && (this.min.y = this.max.y = (this.min.y + this.max.y) / 2);
};
n.prototype.zoomTo = function (e) {
  this.zoomTarget = Math.min(Math.max(e, this.minZoom), this.maxZoom);
  this._updatePositionBounds();
};
n.prototype.moveTo = function (e, t, i) {
  this.followee = {
    x: e,
    y: t
  };
  null !== i && void 0 !== i && (this.emitAtDestination = !0);
};
n.prototype.transform = function (e, t, i, n, o) {
  var a = this.zoomTarget;
  e /= a;
  t /= a;
  i /= a;
  n /= a;
  var s = Math.max(this.minZoom, Math.min(this.maxZoom, a * o)),
    r = 1 - a / s,
    l = Math.min(this.max.x, Math.max(this.min.x, this.followee.x)),
    c = Math.min(this.max.y, Math.max(this.min.y, this.followee.y)),
    d = l + (e - this.fovW / 2) * r + i,
    u = c + (t - this.fovH / 2) * r + n;
  this.zoomTo(s);
  this.moveTo(d, u);
};
n.prototype.addInertia = function (e, t, i) {
  e /= this.zoom;
  t /= this.zoom;
  var n = Math.sqrt(e * e + t * t);
  if (0 !== n) {
    this.a = Math.pow(this.acceleration, 1 - i);
    var o = Math.log(n / s) / Math.log(this.a) - 1,
      a = s * (1 - Math.pow(this.a, o)) / (1 - this.a);
    this.moveTo(this.x + a * e / n, this.y + t * a / n);
  }
};
n.prototype.setFieldOfView = function (e, t) {
  this.fovWAbsolute = e;
  this.fovHAbsolute = t;
  this._updateZoomBounds();
  this._updatePositionBounds();
};
n.prototype.setBounds = function (e, t, i, n) {
  this.l = e;
  this.r = t;
  this.t = i;
  this.b = n;
  this.w = t - e;
  this.h = n - i;
  this._updateZoomBounds();
  this._updatePositionBounds();
};
n.prototype.follow = function (e) {
  this.followee = e;
};
n.prototype.updatePosition = function (e) {
  if (!this._frozen) {
    this.a += (this.acceleration - this.a) * (d * e);
    var t = this.min.x,
      i = this.max.x,
      n = this.min.y,
      o = this.max.y,
      a = Math.min(i, Math.max(t, this.followee.x)),
      s = Math.min(o, Math.max(n, this.followee.y)),
      r = l / this.zoomTarget,
      u = a - this.x,
      h = s - this.y,
      p = r - this.z;
    if (0 === u && 0 === h && 0 === p) {
      return this.emitAtDestination && (this.emitAtDestination = !1, this.emit("atDestination")), !1;
    }
    if (Math.abs(u) < .5 && Math.abs(h) < .5 && Math.abs(p) < .5) {
      return this.x = a, this.y = s, this.z = r, this.zoom = this.zoomTarget, this.a += (1 - this.a) * c, !1;
    }
    var m = 1 - Math.pow(2 - this.a, e);
    this.x += m * u;
    this.y += m * h;
    this.z += m * p;
    this.zoom = l / this.z;
    var f = this.fovWAbsolute / this.zoom,
      g = this.fovHAbsolute / this.zoom;
    return t = this.l + f / 2, n = this.t + g / 2, i = this.r - f / 2, o = this.b - g / 2, this.x < t ? this.x = t : this.x > i && (this.x = i), this.y < n ? this.y = n : this.y > o && (this.y = o), !0;
  }
};
this.followee = {
  x: this.x,
  y: this.y
};
this.zoomTarget = this.zoom;
this.z = l / this.zoom;
e = Math.max(this.minZoom, Math.min(this.maxZoom, e));
this.z = l / e;
this.zoom = e;
this.zoomTarget = e;
this._updatePositionBounds();
this.x = Math.min(this.max.x, Math.max(this.min.x, e));
this.y = Math.min(this.max.y, Math.max(this.min.y, t));
this.followee = {
  x: e,
  y: t
};
this.minZoom = Math.min(Math.max(e, t), this.maxZoom);
this.zoom < this.minZoom && (this.zoom = this.minZoom);
this.zoomTarget < this.minZoom && (this.zoomTarget = this.minZoom);
this.z = l / this.zoom;
this.fovW = this.fovWAbsolute / this.zoomTarget;
this.fovH = this.fovHAbsolute / this.zoomTarget;
this.min.x = this.l + this.fovW / 2;
this.min.y = this.t + this.fovH / 2;
this.max.x = this.r - this.fovW / 2;
this.max.y = this.b - this.fovH / 2;
this.min.x > this.max.x && (this.min.x = this.max.x = (this.min.x + this.max.x) / 2);
this.min.y > this.max.y && (this.min.y = this.max.y = (this.min.y + this.max.y) / 2);
this.zoomTarget = Math.min(Math.max(e, this.minZoom), this.maxZoom);
this._updatePositionBounds();
this.followee = {
  x: e,
  y: t
};
null !== i && void 0 !== i && (this.emitAtDestination = !0);
e /= a;
t /= a;
i /= a;
n /= a;
this.zoomTo(s);
this.moveTo(d, u);
e /= this.zoom;
t /= this.zoom;
this.fovWAbsolute = e;
this.fovHAbsolute = t;
this._updateZoomBounds();
this._updatePositionBounds();
this.l = e;
this.r = t;
this.t = i;
this.b = n;
this.w = t - e;
this.h = n - i;
this._updateZoomBounds();
this._updatePositionBounds();
this.x += m * u;
this.y += m * h;
this.z += m * p;
this.zoom = l / this.z;
this.x0 = e;
this.y0 = t;
this.x1 = i;
this.y1 = n;
a.call(this, e);
this._lines = e.lines;
this._lineWidth = e.lineWidth * s.PIXEL_RATIO;
this._lineByteSize = this.renderer.getNbBytesPerLine();
this._bbox = [1 / 0, -(1 / 0), 1 / 0, -(1 / 0)];
this._createVertexBuffer();
o(n, a);
e.exports = n;
n.prototype._createVertexBuffer = function () {
  var e = this._lines.length;
  this._vertexBuffer = new window.ArrayBuffer(e * this._lineByteSize);
  this._positions = new window.Float32Array(this._vertexBuffer);
  this._colorView = new window.Uint32Array(this._vertexBuffer);
  for (var t = 0; t < e; t += 1) {
    var i = this._lines[t];
    this._expandToFitLine(i);
    var n = t * this._lineByteSize / 4;
    this._positions[n + 0] = i.x0;
    this._positions[n + 1] = i.y0;
    this._positions[n + 5] = i.x1;
    this._positions[n + 6] = i.y1;
    this._colorView[n + 3] = this._colorView[n + 8] = 1077952576;
  }
  this.renderer.releaseBuffer(this.id);
  this.forceRefresh();
};
n.prototype.draw = function () {
  this.renderer.drawLineBatch(this.id, this._lineWidth);
};
n.prototype._expandToFitPoint = function (e, t) {
  this._bbox[0] > e && (this._bbox[0] = e);
  this._bbox[2] > t && (this._bbox[2] = t);
  this._bbox[1] < e && (this._bbox[1] = e);
  this._bbox[3] < t && (this._bbox[3] = t);
};
n.prototype._expandToFitLine = function (e) {
  this._expandToFitPoint(e.x0, e.y0);
  this._expandToFitPoint(e.x1, e.y1);
};
n.prototype.generateCurrentFrameData = function () {
  var e = this.renderer.getBufferData(this.id);
  if (void 0 === e) {
    var t = this._positions,
      i = !1;
    this.renderer.loadLineBuffer(this.id, t, this._bbox, i);
    this.renderer.lockBuffer(this.id);
  }
  return this._bbox;
};
n.prototype.clear = function () {
  this.renderer.releaseBuffer(this.id);
};
this._vertexBuffer = new window.ArrayBuffer(e * this._lineByteSize);
this._positions = new window.Float32Array(this._vertexBuffer);
this._colorView = new window.Uint32Array(this._vertexBuffer);
this._positions[n + 0] = i.x0;
this._positions[n + 1] = i.y0;
this._positions[n + 5] = i.x1;
this._positions[n + 6] = i.y1;
this._colorView[n + 3] = this._colorView[n + 8] = 1077952576;
this.renderer.releaseBuffer(this.id);
this.forceRefresh();
this._bbox[0] > e && (this._bbox[0] = e);
this._bbox[2] > t && (this._bbox[2] = t);
this._bbox[1] < e && (this._bbox[1] = e);
this._bbox[3] < t && (this._bbox[3] = t);
this._expandToFitPoint(e.x0, e.y0);
this._expandToFitPoint(e.x1, e.y1);
this.renderer.loadLineBuffer(this.id, t, this._bbox, i);
this.renderer.lockBuffer(this.id);
s.now() - i >= 1e3 && (window.performanceMonitor.logFPS(t), t = 0, i = s.now());
t++;
n.previousUpdate = l - c % a;
c /= a;
this.x = e * d;
this.y = t * u;
this.w = d;
this.h = u;
this.id = n;
this.path = o;
this.texture = r;
this.scene = l;
this.distToViewCenter = c;
t.WORLDMAP_PATH = i(13).WORLDMAP_PATH;
t.SUBAREA_COLOR = [16 / 255, 186 / 255, 105 / 255, .25];
t.VIEW_MARGIN = 1.1;
t.CHUNK_WIDTH = 250;
t.CHUNK_HEIGHT = 250;
t.ICON_DIAMETER = 28;
t.ICONS_ANCHOR_POINT = {
  DEFAULT: {
    x: -.5,
    y: -.5
  },
  myPosition: {
    x: -.5,
    y: -1
  },
  flag0: {
    x: -.5,
    y: -1
  },
  flag1: {
    x: -.5,
    y: -1
  }
};
t.ICONS_ORIGINAL_EXPORT_SCALE = 1.5;
this.id = e;
this.visible = !0;
this.color = null;
this.categoryId = t;
this.infoData = i;
this.dimensions = n;
this.cluster = null;
this.vertexBufferSlot = null;
e.exports = i;
i.prototype.setVisibility = function (e) {
  return this.visible !== e && (this.visible = e, this.cluster && (e ? this.cluster.nVisibleIcons += 1 : this.cluster.nVisibleIcons -= 1), !0);
};
this.texture = null;
this.iconDimensions = null;
this.iconBatch = null;
this.worldMap = e;
this.reset();
e.exports = n;
n.prototype.getClusterIcons = function (e) {
  var t = this.iconClusters[e];
  if (t) {
    return t.icons;
  }
};
n.prototype.reset = function () {
  this.icons = {};
  this.iconClusters = {};
  this.iconsPerCategory = {};
  this.zIndexedIconClusters = [];
};
n.prototype.addCluster = function (e) {
  this.iconClusters[e.id] = e;
  this.zIndexedIconClusters.push(e);
  this.zIndexedIconClusters.sort(o);
};
n.prototype.removeCluster = function (e) {
  var t = this.zIndexedIconClusters.indexOf(e);
  return t === -1 ? void console.error(new Error("[IconBatchData.removeCluster] Trying to remove inexistent cluster")) : (delete this.iconClusters[e.id], void this.zIndexedIconClusters.splice(t, 1));
};
n.prototype.createIconModels = function (e, t, i) {
  var n = {},
    o = Object.keys(e);
  i = i || 1;
  for (var a = 0; a < o.length; a += 1) {
    var s = e[o[a]];
    s.w *= i;
    s.h *= i;
    var l = r[s.className] || r.DEFAULT;
    l && (s.x = s.w * l.x, s.y = s.h * l.y);
    n[s.className] = s;
  }
  this.texture = t;
  this.iconDimensions = n;
};
n.prototype.clearIconBatch = function () {
  null !== this.iconBatch && (this.iconBatch.clear(), this.iconBatch = null);
};
n.prototype.addIcon = function (e) {
  var t = e.id;
  if (void 0 !== this.icons[t]) {
    return void console.error("addIcon: An icon of id", t, "already exists.");
  }
  this.icons[t] = e;
  var i = e.categoryId;
  void 0 === this.iconsPerCategory[i] ? this.iconsPerCategory[i] = [e] : this.iconsPerCategory[i].push(e);
  null !== this.iconBatch && this.iconBatch.addIcon(e);
};
n.prototype.removeIcon = function (e) {
  var t = this.icons[e];
  if (void 0 !== t) {
    delete this.icons[e];
    var i = t.cluster;
    i.remove(t);
    0 === i.icons.length && this.removeCluster(i);
    var n = this.iconsPerCategory[t.categoryId],
      o = n.indexOf(t.id);
    n.splice(o, 1);
    null !== this.iconBatch && this.iconBatch.removeIcon(t);
  }
};
n.prototype._addIconToZoneCluster = function (e, t, i) {
  var n = this.worldMap.convertGridCoordinateToZoneId(t, i),
    o = this.iconClusters[n];
  if (void 0 === o) {
    var s = this.worldMap._convertGridToSceneCoordinate(t, i);
    o = new a(n, s.x, s.y);
    this.addCluster(o);
  }
  o.add(e);
  e.cluster = o;
};
n.prototype.createIcon = function (e, t) {
  if (!this.iconDimensions[t]) {
    return console.error("WorldMap (IconBatchData): unknown icon " + t);
  }
  var i = e.x,
    n = e.y,
    o = e.categoryId,
    a = new s(e.id, o, e, this.iconDimensions[t]);
  return void 0 === this.icons[e.id] ? (this._addIconToZoneCluster(a, i, n), this.addIcon(a)) : console.warn("createIcon: An icon of id", e.id, "already exists."), a;
};
n.prototype.checkIconsCriterions = function () {
  var e = [],
    t = [];
  for (var i in this.icons) {
    var n = this.icons[i],
      o = n.infoData.groupCriterion;
    if (o) {
      var a = Boolean(o.isRespected()),
        s = n.setVisibility(a);
      s && a ? t.push(n) : s && e.push(n);
    }
  }
  null !== this.iconBatch && (this.iconBatch.setVisibility(t, !0), this.iconBatch.setVisibility(e, !1));
};
n.prototype.createIconsFromInfo = function (e, t) {
  for (var i = Object.keys(e), n = 0; n < i.length; n += 1) {
    var o = e[i[n]];
    o.isHintFromDB = !0;
    o.criterion && "null" !== o.criterion && (o.groupCriterion = l.createGroupCriterion(o.criterion));
    o.worldMapId === t && this.createIcon(o, "icon_" + o.gfx);
  }
  this.checkIconsCriterions();
};
n.prototype.hasIcon = function (e) {
  return this.icons.hasOwnProperty(e);
};
n.prototype.getIcon = function (e) {
  return this.icons[e];
};
n.prototype.setVisibilityOfIconType = function (e, t) {
  var i = this.iconsPerCategory[e];
  if (void 0 !== i) {
    for (var n = [], o = 0; o < i.length; o += 1) {
      var a = i[o],
        s = a.infoData.groupCriterion;
      if (!s || Boolean(s.isRespected()) === t) {
        var r = a.setVisibility(t);
        r && n.push(a);
      }
    }
    null !== this.iconBatch && this.iconBatch.setVisibility(n, t);
  }
};
n.prototype.setIconPosition = function (e, t, i) {
  var n = this.icons[e];
  if (void 0 !== n) {
    var a = n.cluster;
    if ("userPosition" === e) {
      var s = this.worldMap._convertGridToSceneCoordinate(t, i);
      a.position.x = s.x;
      a.position.y = s.y;
      this.zIndexedIconClusters.sort(o);
    } else {
      a.remove(n);
      this._addIconToZoneCluster(n, t, i);
    }
    null !== this.iconBatch && this.iconBatch.updateIconPosition(n);
  }
};
this.icons = {};
this.iconClusters = {};
this.iconsPerCategory = {};
this.zIndexedIconClusters = [];
this.iconClusters[e.id] = e;
this.zIndexedIconClusters.push(e);
this.zIndexedIconClusters.sort(o);
s.w *= i;
s.h *= i;
l && (s.x = s.w * l.x, s.y = s.h * l.y);
n[s.className] = s;
this.texture = t;
this.iconDimensions = n;
void 0 === this.iconsPerCategory[i] ? this.iconsPerCategory[i] = [e] : this.iconsPerCategory[i].push(e);
null !== this.iconBatch && this.iconBatch.addIcon(e);
i.remove(t);
0 === i.icons.length && this.removeCluster(i);
n.splice(o, 1);
null !== this.iconBatch && this.iconBatch.removeIcon(t);
o = new a(n, s.x, s.y);
this.addCluster(o);
o.add(e);
e.cluster = o;
o.isHintFromDB = !0;
o.criterion && "null" !== o.criterion && (o.groupCriterion = l.createGroupCriterion(o.criterion));
o.worldMapId === t && this.createIcon(o, "icon_" + o.gfx);
a.position.x = s.x;
a.position.y = s.y;
this.zIndexedIconClusters.sort(o);
a.remove(n);
this._addIconToZoneCluster(n, t, i);
t.positionOrdering = function (e, t) {
  var i = e.y - t.y;
  return 0 === i ? e.x - t.x : i;
};
t.clusterOrdering = function (e, t) {
  var i = e.position,
    n = t.position,
    o = i.y - n.y;
  return 0 === o ? i.x - n.x : o;
};
t.computeRelativePositions = function (e) {
  for (var i = [], s = e <= 1 ? 0 : n / (2 * Math.sin(Math.PI / e)), r = 0; r < e; r += 1) {
    var l = 2 * Math.PI * r / e;
    i[r] = new o(Math.cos(l) * s, Math.sin(l) * s);
  }
  return i.sort(t.positionOrdering), i.push(new o(0, 0)), a[e] = i, i;
};
t.getRelativePositions = function (e) {
  var i = a[e];
  return void 0 === i && (i = t.computeRelativePositions(e)), i;
};
this.x = e;
this.y = t;
e.exports = i;
i.prototype.plus = function (e) {
  return new i(this.x + e.x, this.y + e.y);
};
i.prototype.copy = function () {
  return new i(this.x, this.y);
};
this.id = e;
this.position = new o(t, i);
this.icons = [];
this.nVisibleIcons = 0;
e.exports = n;
n.prototype.getIconPosition = function (e) {
  var t = a(this.nVisibleIcons);
  if (!t[e]) {
    var i = "";
    if (this.icons && this.icons.length > 0) {
      var n = this.icons[0];
      n.infoData && n.infoData.x && n.infoData.y && (i = "[" + n.infoData.x + "," + n.infoData.y + "]");
    }
    return console.error(new Error("relativePositions for " + e + " is null, nVisibleIcons on the cluster is " + this.nVisibleIcons + ", clusterId is " + this.id + " " + i)), this.position;
  }
  return this.position.plus(t[e]);
};
n.prototype.add = function (e) {
  this.icons.unshift(e);
  e.visible && (this.nVisibleIcons += 1);
};
n.prototype.remove = function (e) {
  var t = this.icons.indexOf(e);
  t === -1 ? console.error(new Error("[IconCluster.remove] Icon not in cluster: " + e.id)) : (this.icons.splice(t, 1), e.visible && (this.nVisibleIcons -= 1));
};
this.icons.unshift(e);
e.visible && (this.nVisibleIcons += 1);
this.icon = e;
this.index = t;
this.reference = null;
s.call(this, e);
this._bbox = [0, e.w, 0, e.h];
this._iconsData = e.iconsData;
this._texture = this._iconsData.texture;
this._textureWidth = this._texture.element.width;
this._textureHeight = this._texture.element.height;
this._iconByteSize = this.renderer.getNbBytesPerSprite();
this._vertexBufferSlots = new l();
this._populateVertexBuffer();
a(o, s);
e.exports = o;
o.prototype._createVertexBuffer = function () {
  this._vertexBuffer = new window.ArrayBuffer(this._vertexBufferSlots.length * this._iconByteSize);
  this._floatView = new window.Float32Array(this._vertexBuffer);
  this._longView = new window.Uint32Array(this._vertexBuffer);
  this._shortView = new window.Uint16Array(this._vertexBuffer);
  this._byteView = new window.Uint8Array(this._vertexBuffer);
};
o.prototype._assignVertexBufferSlots = function () {
  for (var e = 0, t = this._iconsData.zIndexedIconClusters, i = 0; i < t.length; i += 1) {
    for (var o = t[i], a = o.icons, s = 0; s < a.length; s += 1) {
      var r = a[s],
        l = new n(r, e);
      l.reference = this._vertexBufferSlots.addBack(l);
      r.vertexBufferSlot = l;
      e += 1;
    }
  }
};
o.prototype._populateVertexBuffer = function () {
  this._assignVertexBufferSlots();
  this._createVertexBuffer();
  for (var e = this._iconsData.zIndexedIconClusters, t = 0; t < e.length; t++) {
    this._populateClusterVertexBuffer(e[t]);
  }
  this.renderer.releaseBuffer(this.id);
  this.forceRefresh();
};
o.prototype._populateClusterVertexBuffer = function (e) {
  for (var t = 0, i = e.icons, n = 0; n < i.length; n += 1) {
    t = this._populateIconVertexBuffer(i[n], t);
  }
};
o.prototype._populateIconVertexBuffer = function (e, t) {
  var i = this._floatView,
    n = this._longView,
    o = this._longView,
    a = e.cluster.getIconPosition(t),
    s = e.vertexBufferSlot.index * this._iconByteSize / 4;
  i[s + 0] = i[s + 5] = i[s + 10] = a.x;
  i[s + 15] = i[s + 20] = i[s + 25] = a.x;
  i[s + 1] = i[s + 6] = i[s + 11] = a.y;
  i[s + 16] = i[s + 21] = i[s + 26] = a.y;
  var r = e.dimensions,
    l = r.sx / this._textureWidth,
    c = r.sy / this._textureHeight,
    d = (r.sx + r.sw) / this._textureWidth,
    h = (r.sy + r.sh) / this._textureHeight,
    p = 65535 & 65535 * l,
    m = 65535 & 65535 * d,
    f = 4294901760 & 4294901760 * c,
    g = 4294901760 & 4294901760 * h;
  n[s + 2] = p + f;
  n[s + 7] = p + g;
  n[s + 12] = m + g;
  n[s + 17] = p + f;
  n[s + 22] = m + g;
  n[s + 27] = m + f;
  var _ = e.infoData.color || [1, 1, 1, 1],
    v = Math.max(-128, Math.min(127, 64 * _[0])),
    y = Math.max(-128, Math.min(127, 64 * _[1])),
    w = Math.max(-128, Math.min(127, 64 * _[2])),
    b = e.visible ? Math.max(-128, Math.min(127, 64 * _[3])) : 0,
    M = (b << 24 & 4278190080) + (w << 16 & 16711680) + (y << 8 & 65280) + (255 & v);
  n[s + 3] = n[s + 8] = n[s + 13] = M;
  n[s + 18] = n[s + 23] = n[s + 28] = M;
  var T = r.x,
    C = r.w + T,
    I = r.y,
    A = r.h + I,
    S = 255 & T,
    E = 255 & C,
    N = (255 & I) << 8,
    x = (255 & A) << 8,
    L = 127 * (1 - u) & 255,
    O = (L << 24) + (L << 16);
  return o[s + 4] = S + N + O, o[s + 9] = S + x + O, o[s + 14] = E + x + O, o[s + 19] = S + N + O, o[s + 24] = E + x + O, o[s + 29] = E + N + O, e.visible ? t + 1 : t;
};
o.prototype.setVisibility = function (e, t, i, n) {
  for (var o, a, s = n || {}, r = 0; r < e.length; r += 1) {
    o = e[r];
    o.visible === t ? (a = o.cluster, void 0 === s[a.id] && (s[a.id] = a)) : console.error("setVisibility: icon " + o.id + " visibility != " + t);
  }
  for (var l = [], d = {}, p = Object.keys(s), m = 0; m < p.length; m += 1) {
    var f = p[m];
    a = s[f];
    var g = a.icons,
      _ = 0;
    for (r = 0; r < g.length; r += 1) {
      if (o = g[r], o.visible) {
        var v = o.vertexBufferSlot.index * this._iconByteSize / 4;
        l.push(o);
        d[o.id] = {
          origin: {
            x: this._floatView[v],
            y: this._floatView[v + 1]
          },
          destination: a.getIconPosition(_)
        };
        _ += 1;
      }
    }
  }
  var y = {
      ease: 0
    },
    w = this,
    b = new c(y, ["ease"]);
  b.onUpdate(function () {
    var i = w._floatView,
      n = w._shortView,
      o = w._byteView,
      a = y.ease,
      s = t ? a : 1 - a,
      r = 64 * s & 255,
      c = s - 1,
      h = 2,
      p = c * c * ((h + 1) * c + h) + 1 - u;
    p = 127 * p & 255;
    p += p << 8;
    for (var m = 0; m < e.length; m += 1) {
      var f = e[m];
      if (null !== f.vertexBufferSlot) {
        var g = f.vertexBufferSlot.index * w._iconByteSize,
          _ = g / 2;
        n[_ + 9] = n[_ + 19] = n[_ + 29] = p;
        n[_ + 39] = n[_ + 49] = n[_ + 59] = p;
        o[g + 15] = o[g + 35] = o[g + 55] = r;
        o[g + 75] = o[g + 95] = o[g + 115] = r;
      } else {
        console.warn("setVisibility skipping fading icon " + f.id);
      }
    }
    var v = 1 - Math.pow((1 - a) / 1, 4);
    for (m = 0; m < l.length; m += 1) {
      var b = l[m];
      if (null !== b.vertexBufferSlot) {
        var M = d[b.id],
          T = M.origin.x * (1 - v) + M.destination.x * v,
          C = M.origin.y * (1 - v) + M.destination.y * v,
          I = b.vertexBufferSlot.index * w._iconByteSize / 4;
        i[I + 0] = i[I + 5] = i[I + 10] = T;
        i[I + 15] = i[I + 20] = i[I + 25] = T;
        i[I + 1] = i[I + 6] = i[I + 11] = C;
        i[I + 16] = i[I + 21] = i[I + 26] = C;
      } else {
        console.warn("setVisibility skipping moving icon " + b.id);
      }
    }
    w.renderer.releaseBuffer(w.id);
    w.forceRefresh();
  });
  b.from({
    ease: 0
  });
  b.to({
    ease: 1
  }, h);
  b.onFinish(i);
  b.start();
};
o.prototype.getSlotWhereIconShouldFit = function (e) {
  var t = e.cluster,
    i = this._iconsData.zIndexedIconClusters,
    n = i,
    o = n.indexOf(t);
  if (o === -1) {
    return void console.error(new Error("[IconBatch.addIconToVertexBuffer] Icon cluster not present in ordered list"));
  }
  var a = t.icons,
    s = a.indexOf(e);
  if (s === -1) {
    return void console.error(new Error("[IconBatch.addIconToVertexBuffer] Icon not present in its cluster"));
  }
  var r;
  if (s === a.length - 1) {
    if (o === i.length - 1) {
      if (0 === o) {
        if (!this._vertexBufferSlots.first) {
          return null;
        }
        r = this._vertexBufferSlots.first.object;
      } else {
        var l = i[o - 1].icons;
        r = l[l.length - 1].vertexBufferSlot;
      }
    } else {
      r = i[o + 1].icons[0].vertexBufferSlot;
    }
  } else {
    r = a[s + 1].vertexBufferSlot;
  }
  var c = e.vertexBufferSlot;
  return null !== e.vertexBufferSlot && c.index < r.index && (r = r.reference.previous.object), r;
};
o.prototype.addIcon = function (e) {
  if (null !== e.vertexBufferSlot) {
    return void console.warn("[IconBatch.addIconToVertexBuffer] Trying to add an icon already present in the vertex buffer");
  }
  var t,
    i,
    o = this.getSlotWhereIconShouldFit(e);
  if (null === o) {
    var a = new n(e, 0);
    a.reference = this._vertexBufferSlots.add(a);
    e.vertexBufferSlot = a;
    i = null;
    t = 0;
  } else {
    t = o.index;
    var s = new n(e, t);
    for (s.reference = this._vertexBufferSlots.addBefore(o.reference, s), e.vertexBufferSlot = s, i = o.reference; null !== i && null !== i.icon;) {
      i.object.index += 1;
      i = i.next;
    }
  }
  if (null === i) {
    var r = this._floatView;
    this._createVertexBuffer();
    var l = t * this._iconByteSize / 4,
      c = r.subarray(0, l),
      d = r.subarray(l);
    this._floatView.set(c, 0);
    this._floatView.set(d, l + this._iconByteSize / 4);
  } else {
    var u = t * this._iconByteSize / 4,
      h = i.object.index * this._iconByteSize / 4;
    this._vertexBufferSlots.removeByReference(i);
    var p = this._floatView.subarray(u, h);
    this._floatView.set(p, u + this._iconByteSize / 4);
  }
  this._populateIconVertexBuffer(e, 0);
  this.setVisibility([e], !0);
};
o.prototype.updateIconPosition = function (e) {
  var t = e.vertexBufferSlot;
  if (null === t) {
    return void console.error(new Error("[IconBatch.updateIconPosition] Given icon is not present in the vertex buffer"));
  }
  var i = this.getSlotWhereIconShouldFit(e);
  if (t.index !== i.index) {
    var n,
      o,
      a,
      s,
      r,
      l = t.index * this._iconByteSize / 4,
      c = l + this._iconByteSize / 4,
      d = new window.Float32Array(this._floatView.subarray(l, c));
    if (t.index < i.index) {
      for (n = c, o = i.index * this._iconByteSize / 4 + this._iconByteSize / 4, this._floatView.set(this._floatView.subarray(n, o), l), r = t.reference; null !== r && r.object !== i;) {
        a = r.object;
        r = r.next;
        s = r.object.icon;
        s && (s.vertexBufferSlot = a);
        a.icon = s;
      }
    } else {
      for (n = i.index * this._iconByteSize / 4, o = l, this._floatView.set(this._floatView.subarray(n, o), n + this._iconByteSize / 4), r = t.reference; null !== r && r.object !== i;) {
        a = r.object;
        r = r.previous;
        s = r.object.icon;
        s && (s.vertexBufferSlot = a);
        a.icon = s;
      }
    }
    i.icon = e;
    e.vertexBufferSlot = i;
    this._floatView.set(d, i.index * this._iconByteSize / 4);
  }
  var u = {},
    h = e.cluster;
  u[h.id] = h;
  this.setVisibility([], !0, null, u);
};
o.prototype.removeIcon = function (e) {
  e.visible && (e.visible = !1, this.setVisibility([e], !1, function () {
    e.visible === !1 && (e.vertexBufferSlot.icon = null, e.vertexBufferSlot = null);
  }));
};
o.prototype.render = function () {
  this.renderer.drawSpriteBatchAbsoluteScale(this.id, d * this.scene.pixelRatio);
};
o.prototype.generateCurrentFrameData = function () {
  var e = this.renderer.getBufferData(this.id);
  if (void 0 === e) {
    var t = this.id,
      i = this._floatView,
      n = this._texture,
      o = !1;
    this.renderer.loadSpriteBuffer(t, i, n, this._bbox, o);
    this.renderer.lockBuffer(this.id);
  }
  return this._bbox;
};
o.prototype.clear = function () {
  this.renderer.releaseBuffer(this.id);
};
this._vertexBuffer = new window.ArrayBuffer(this._vertexBufferSlots.length * this._iconByteSize);
this._floatView = new window.Float32Array(this._vertexBuffer);
this._longView = new window.Uint32Array(this._vertexBuffer);
this._shortView = new window.Uint16Array(this._vertexBuffer);
this._byteView = new window.Uint8Array(this._vertexBuffer);
l.reference = this._vertexBufferSlots.addBack(l);
r.vertexBufferSlot = l;
e += 1;
this._assignVertexBufferSlots();
this._createVertexBuffer();
this.renderer.releaseBuffer(this.id);
this.forceRefresh();
i[s + 0] = i[s + 5] = i[s + 10] = a.x;
i[s + 15] = i[s + 20] = i[s + 25] = a.x;
i[s + 1] = i[s + 6] = i[s + 11] = a.y;
i[s + 16] = i[s + 21] = i[s + 26] = a.y;
n[s + 2] = p + f;
n[s + 7] = p + g;
n[s + 12] = m + g;
n[s + 17] = p + f;
n[s + 22] = m + g;
n[s + 27] = m + f;
n[s + 3] = n[s + 8] = n[s + 13] = M;
n[s + 18] = n[s + 23] = n[s + 28] = M;
o = e[r];
o.visible === t ? (a = o.cluster, void 0 === s[a.id] && (s[a.id] = a)) : console.error("setVisibility: icon " + o.id + " visibility != " + t);
l.push(o);
d[o.id] = {
  origin: {
    x: this._floatView[v],
    y: this._floatView[v + 1]
  },
  destination: a.getIconPosition(_)
};
_ += 1;
b.onUpdate(function () {
  var i = w._floatView,
    n = w._shortView,
    o = w._byteView,
    a = y.ease,
    s = t ? a : 1 - a,
    r = 64 * s & 255,
    c = s - 1,
    h = 2,
    p = c * c * ((h + 1) * c + h) + 1 - u;
  p = 127 * p & 255;
  p += p << 8;
  for (var m = 0; m < e.length; m += 1) {
    var f = e[m];
    if (null !== f.vertexBufferSlot) {
      var g = f.vertexBufferSlot.index * w._iconByteSize,
        _ = g / 2;
      n[_ + 9] = n[_ + 19] = n[_ + 29] = p;
      n[_ + 39] = n[_ + 49] = n[_ + 59] = p;
      o[g + 15] = o[g + 35] = o[g + 55] = r;
      o[g + 75] = o[g + 95] = o[g + 115] = r;
    } else {
      console.warn("setVisibility skipping fading icon " + f.id);
    }
  }
  var v = 1 - Math.pow((1 - a) / 1, 4);
  for (m = 0; m < l.length; m += 1) {
    var b = l[m];
    if (null !== b.vertexBufferSlot) {
      var M = d[b.id],
        T = M.origin.x * (1 - v) + M.destination.x * v,
        C = M.origin.y * (1 - v) + M.destination.y * v,
        I = b.vertexBufferSlot.index * w._iconByteSize / 4;
      i[I + 0] = i[I + 5] = i[I + 10] = T;
      i[I + 15] = i[I + 20] = i[I + 25] = T;
      i[I + 1] = i[I + 6] = i[I + 11] = C;
      i[I + 16] = i[I + 21] = i[I + 26] = C;
    } else {
      console.warn("setVisibility skipping moving icon " + b.id);
    }
  }
  w.renderer.releaseBuffer(w.id);
  w.forceRefresh();
});
b.from({
  ease: 0
});
b.to({
  ease: 1
}, h);
b.onFinish(i);
b.start();
p = 127 * p & 255;
p += p << 8;
n[_ + 9] = n[_ + 19] = n[_ + 29] = p;
n[_ + 39] = n[_ + 49] = n[_ + 59] = p;
o[g + 15] = o[g + 35] = o[g + 55] = r;
o[g + 75] = o[g + 95] = o[g + 115] = r;
i[I + 0] = i[I + 5] = i[I + 10] = T;
i[I + 15] = i[I + 20] = i[I + 25] = T;
i[I + 1] = i[I + 6] = i[I + 11] = C;
i[I + 16] = i[I + 21] = i[I + 26] = C;
w.renderer.releaseBuffer(w.id);
w.forceRefresh();
a.reference = this._vertexBufferSlots.add(a);
e.vertexBufferSlot = a;
i = null;
t = 0;
i.object.index += 1;
i = i.next;
this._floatView.set(c, 0);
this._floatView.set(d, l + this._iconByteSize / 4);
this._populateIconVertexBuffer(e, 0);
this.setVisibility([e], !0);
a = r.object;
r = r.next;
s = r.object.icon;
s && (s.vertexBufferSlot = a);
a.icon = s;
a = r.object;
r = r.previous;
s = r.object.icon;
s && (s.vertexBufferSlot = a);
a.icon = s;
i.icon = e;
e.vertexBufferSlot = i;
this._floatView.set(d, i.index * this._iconByteSize / 4);
u[h.id] = h;
this.setVisibility([], !0, null, u);
this.renderer.loadSpriteBuffer(t, i, n, this._bbox, o);
this.renderer.lockBuffer(this.id);
this._lastWorld = null;
this._worldMap = e;
n.on("addPOI", function (e) {
  var n = i.playerData.position.worldmapId;
  n === e.worldMapId && (t._worldMap.hasIcon(e.id) || (t._worldMap.isLoading() ? t._worldMap.once("loaded", function () {
    t._worldMap.addIcon(e, e.iconId);
  }) : t._worldMap.addIcon(e, e.iconId)));
});
n.on("removePOI", function (e) {
  t._worldMap.hasIcon(e.id) && t._worldMap.removeIcon(e.id);
});
n.on("updatePOI", function (e) {
  t._worldMap.hasIcon(e.id) && (t._worldMap.removeIcon(e.id), t._worldMap.addIcon(e, e.iconId));
});
e.exports = i;
i.prototype.updatePois = function () {
  var e = window.gui,
    t = e.GPS,
    i = e.playerData.position.worldmapId;
  if (this._lastWorld !== i) {
    var n = t.getPOIs(this._lastWorld);
    for (var o in n) {
      this._worldMap.hasIcon(o) && this._worldMap.removeIcon(o);
    }
    n = t.getPOIs();
    for (o in n) {
      if (!this._worldMap.hasIcon(o)) {
        var a = n[o];
        this._worldMap.addIcon(a, a.iconId);
      }
    }
    this._lastWorld = i;
  }
};
this._prisms = e;
this._worldMap = null;
this._conquestUIList = t;
this._worldMapLoaded = !1;
this._isUiLoaded = !1;
this._subareaToShow = null;
this._deferredActionQueue = new m();
window.gui.on("PrismsListMessage", function (e) {
  function t() {
    i._prisms.setPrisms(e.prisms);
    i._updateWorldMapIcons();
    i.loadUILists();
  }
  i._worldMapLoaded ? t() : i._deferredActionQueue.enqueue(t);
});
window.gui.on("PrismsListUpdateMessage", function (e) {
  function t() {
    i._prisms.updatePrisms(e.prisms);
    i._updateWorldMapIcons();
    i.loadUILists();
  }
  i._worldMapLoaded ? t() : i._deferredActionQueue.enqueue(t);
});
i._prisms.setPrisms(e.prisms);
i._updateWorldMapIcons();
i.loadUILists();
i._prisms.updatePrisms(e.prisms);
i._updateWorldMapIcons();
i.loadUILists();
e.exports = n;
n.prototype.clear = function () {
  this._worldMap = null;
  this._worldMapLoaded = !1;
  this._isUiLoaded = !1;
  this._subareaToShow = null;
  this._deferredActionQueue.clear();
  this._prisms.clear();
};
n.prototype.setWorldMap = function (e) {
  1 === e._worldMapId && (this._worldMap = e, this._worldMapLoaded = !0, this._deferredActionQueue.signal());
};
n.prototype.selectSubarea = function (e) {
  if (!this._isUiLoaded) {
    return void (this._subareaToShow = e);
  }
  this._subareaToShow = null;
  var t = this._selectSublist("AllTerritories");
  t.selectItem(e);
};
n.prototype._selectSublist = function (e) {
  return this._conquestUIList.selectItem(e).sublist;
};
n.prototype._updateWorldMapIcons = function () {
  var e = this;
  this._prisms.forEachEmptyPrism(function (t) {
    e._worldMap.removeIcon(t.subAreaId);
  });
  this._prisms.forEachChangingActivePrism(function (t) {
    var i = p.getIconInfo(t);
    e._worldMapLoaded ? (e._worldMap.removeIcon(i.id), e._worldMap.addIcon(i, "icon_" + i.gfx)) : console.error("map not loaded!");
  });
};
n.prototype.showConquestList = function () {
  this._conquestUIList.show();
};
n.prototype.hideConquestList = function () {
  this._conquestUIList.hide();
};
n.prototype._matchesSearchTerm = function (e, t) {
  return !e || t.toLowerCase().indexOf(e.toLowerCase()) !== -1;
};
n.prototype.loadUILists = function (e) {
  var t = this;
  o.getAllDataMap("SubAreas", function (i, n) {
    if (i) {
      return console.error("WorldMapWindow: getAllDataAreas error", i);
    }
    t._conquestUIList.empty();
    var o = [{
      id: "AllTerritories",
      nameId: h("ui.pvp.conquestAllAreas")
    }, {
      id: "Conquerable",
      nameId: h("ui.pvp.conquestCapturableAreas")
    }, {
      id: "Normal",
      nameId: h("ui.prism.cartography.normal")
    }, {
      id: "Weakened",
      nameId: h("ui.prism.cartography.weakened")
    }, {
      id: "Vulnerable",
      nameId: h("ui.prism.cartography.vulnerable")
    }];
    o.forEach(function (e) {
      t.addToList(t._conquestUIList, e);
    });
    var s = u.createStringCompareFunc(),
      d = new r(s),
      p = new r(s),
      m = new r(s),
      f = new r(s),
      g = new r(s);
    t._prisms.forEachPrism(function (e) {
      var t = n[e.subAreaId];
      t && d.add(t);
    });
    t._prisms.forEachEmptyPrism(function (e) {
      var t = n[e.subAreaId];
      t && p.add(t);
    });
    t._prisms.forEachPrism(function (e) {
      var t = n[e.subAreaId];
      t && m.add(t);
    }, l.PRISM_STATE_NORMAL);
    t._prisms.forEachPrism(function (e) {
      var t = n[e.subAreaId];
      t && f.add(t);
    }, l.PRISM_STATE_WEAKENED);
    t._prisms.forEachPrism(function (e) {
      var t = n[e.subAreaId];
      t && g.add(t);
    }, l.PRISM_STATE_VULNERABLE);
    d.forEach(function (i) {
      var n = new a("div", {
        className: "label",
        text: i.nameId
      });
      t._matchesSearchTerm(e, i.nameId) && t._conquestUIList.items.AllTerritories.sublist.addItem(i.id, n, i);
    });
    p.forEach(function (i) {
      var n = new a("div", {
        className: "label",
        text: i.nameId
      });
      t._matchesSearchTerm(e, i.nameId) && t._conquestUIList.items.Conquerable.sublist.addItem(i.id, n, i);
    });
    m.forEach(function (i) {
      var n = new a("div", {
        className: "label",
        text: i.nameId
      });
      t._matchesSearchTerm(e, i.nameId) && t._conquestUIList.items.Normal.sublist.addItem(i.id, n, i);
    });
    f.forEach(function (i) {
      var n = new a("div", {
        className: "label",
        text: i.nameId
      });
      t._matchesSearchTerm(e, i.nameId) && t._conquestUIList.items.Weakened.sublist.addItem(i.id, n, i);
    });
    g.forEach(function (i) {
      var n = new a("div", {
        className: "label",
        text: i.nameId
      });
      t._matchesSearchTerm(e, i.nameId) && t._conquestUIList.items.Vulnerable.sublist.addItem(i.id, n, i);
    });
    t._conquestUIList.removeAllListeners();
    t._conquestUIList.on("activate", function (e) {
      e.sublist.show();
      c("TAB");
      t._worldMap.clearSubAreaHighlights();
      for (var i in e.sublist.items) {
        var n = e.sublist.items[i].data;
        t._highlightSubArea(n.id);
      }
    });
    t._conquestUIList.on("deactivate", function (e) {
      e.sublist.hide();
      e.sublist.deactivate();
    });
    t._isUiLoaded = !0;
    null !== t._subareaToShow && t.selectSubarea(t._subareaToShow);
  });
};
n.prototype.addToList = function (e, t) {
  var i = this,
    n = new a("div", {
      className: "label"
    });
  n.createChild("div", {
    className: "arrow"
  });
  n.createChild("div", {
    className: "text",
    text: t.nameId
  });
  var o = e.addItem(t.id, n, t);
  o.sublist = o.appendChild(new s());
  o.sublist.addClassNames("tree");
  o.sublist.hide();
  o.sublist.on("activate", function (e) {
    var t = e.data.id;
    i._worldMap.clearSubAreaHighlights(t);
    i._highlightSubArea(t);
    i._worldMap.centerOnSubArea(t);
  });
  o.sublist.on("deactivate", function (e) {
    i._worldMap.removeSubAreaHighlight(e.data.id);
  });
};
n.prototype._highlightSubArea = function (e) {
  var t = d.entities.prism[e];
  if (t && t.prism) {
    var i = t.getAlliance(),
      n = u.hexToRgb(i.allianceEmblem.backgroundColor.toString(16));
    this._worldMap.addSubAreaHighlight(e, [n[0] / 255, n[1] / 255, n[2] / 255, .5]);
  } else {
    this._worldMap.addSubAreaHighlight(e, [1, 0, 0, .25]);
  }
};
n.prototype.search = function (e) {
  this.loadUILists(e);
};
this._worldMap = null;
this._worldMapLoaded = !1;
this._isUiLoaded = !1;
this._subareaToShow = null;
this._deferredActionQueue.clear();
this._prisms.clear();
this._prisms.forEachEmptyPrism(function (t) {
  e._worldMap.removeIcon(t.subAreaId);
});
this._prisms.forEachChangingActivePrism(function (t) {
  var i = p.getIconInfo(t);
  e._worldMapLoaded ? (e._worldMap.removeIcon(i.id), e._worldMap.addIcon(i, "icon_" + i.gfx)) : console.error("map not loaded!");
});
t._prisms.forEachPrism(function (e) {
  var t = n[e.subAreaId];
  t && d.add(t);
});
t._prisms.forEachEmptyPrism(function (e) {
  var t = n[e.subAreaId];
  t && p.add(t);
});
t._prisms.forEachPrism(function (e) {
  var t = n[e.subAreaId];
  t && m.add(t);
}, l.PRISM_STATE_NORMAL);
t._prisms.forEachPrism(function (e) {
  var t = n[e.subAreaId];
  t && f.add(t);
}, l.PRISM_STATE_WEAKENED);
t._prisms.forEachPrism(function (e) {
  var t = n[e.subAreaId];
  t && g.add(t);
}, l.PRISM_STATE_VULNERABLE);
d.forEach(function (i) {
  var n = new a("div", {
    className: "label",
    text: i.nameId
  });
  t._matchesSearchTerm(e, i.nameId) && t._conquestUIList.items.AllTerritories.sublist.addItem(i.id, n, i);
});
p.forEach(function (i) {
  var n = new a("div", {
    className: "label",
    text: i.nameId
  });
  t._matchesSearchTerm(e, i.nameId) && t._conquestUIList.items.Conquerable.sublist.addItem(i.id, n, i);
});
m.forEach(function (i) {
  var n = new a("div", {
    className: "label",
    text: i.nameId
  });
  t._matchesSearchTerm(e, i.nameId) && t._conquestUIList.items.Normal.sublist.addItem(i.id, n, i);
});
f.forEach(function (i) {
  var n = new a("div", {
    className: "label",
    text: i.nameId
  });
  t._matchesSearchTerm(e, i.nameId) && t._conquestUIList.items.Weakened.sublist.addItem(i.id, n, i);
});
g.forEach(function (i) {
  var n = new a("div", {
    className: "label",
    text: i.nameId
  });
  t._matchesSearchTerm(e, i.nameId) && t._conquestUIList.items.Vulnerable.sublist.addItem(i.id, n, i);
});
t._conquestUIList.removeAllListeners();
t._conquestUIList.on("activate", function (e) {
  e.sublist.show();
  c("TAB");
  t._worldMap.clearSubAreaHighlights();
  for (var i in e.sublist.items) {
    var n = e.sublist.items[i].data;
    t._highlightSubArea(n.id);
  }
});
t._conquestUIList.on("deactivate", function (e) {
  e.sublist.hide();
  e.sublist.deactivate();
});
t._isUiLoaded = !0;
null !== t._subareaToShow && t.selectSubarea(t._subareaToShow);
e.sublist.show();
c("TAB");
t._worldMap.clearSubAreaHighlights();
e.sublist.hide();
e.sublist.deactivate();
n.createChild("div", {
  className: "arrow"
});
n.createChild("div", {
  className: "text",
  text: t.nameId
});
o.sublist = o.appendChild(new s());
o.sublist.addClassNames("tree");
o.sublist.hide();
o.sublist.on("activate", function (e) {
  var t = e.data.id;
  i._worldMap.clearSubAreaHighlights(t);
  i._highlightSubArea(t);
  i._worldMap.centerOnSubArea(t);
});
o.sublist.on("deactivate", function (e) {
  i._worldMap.removeSubAreaHighlight(e.data.id);
});
i._worldMap.clearSubAreaHighlights(t);
i._highlightSubArea(t);
i._worldMap.centerOnSubArea(t);
t = h;
i = s + "\n" + y;
a = n(e, i);
t = h;
i = m + "\n" + y;
a = n(e, i);
t = h;
i = l + "\n" + y;
a = n(e, i);
t = h;
i = p + "\n" + y;
a = n(e, i);
t = u;
i = f + "\n" + v;
a = o(e, i);
t = d;
i = g;
a = function (e) {
  return function () {
    return e;
  };
}(i);
t = d;
i = _;
a = function (e) {
  return function () {
    return e;
  };
}(i);
t = d;
i = _;
a = function (e) {
  return function () {
    return e;
  };
}(i);
this._queue = [];
this._isProcessing = !1;
e.exports = i;
i.prototype.enqueue = function (e) {
  this._queue.push(e);
};
i.prototype.signal = function () {
  if (!this._isProcessing) {
    for (this._isProcessing = !0; this._queue.length;) {
      var e = this._queue.shift();
      e();
    }
    this._isProcessing = !1;
  }
};
i.prototype.hasActions = function () {
  return this._queue.length > 0;
};
i.prototype.clear = function () {
  this._isProcessing && console.error(new Error("DeferredActionQueue.clear during signal"));
  this._queue.length = 0;
  this._isProcessing = !1;
};
this._isProcessing && console.error(new Error("DeferredActionQueue.clear during signal"));
this._queue.length = 0;
this._isProcessing = !1;
e.exports = i;
i.prototype.clear = function () {
  this._prisms = {};
  this._emptyPrisms = {};
  this._activePrisms = {};
  this._changingPrisms = {};
};
i.prototype.setPrisms = function (e) {
  this._changingPrisms = e;
  for (var t = Object.keys(e), i = 0; i < t.length; i++) {
    var n = e[t[i]];
    this._prisms[n.subAreaId] = n;
    "PrismGeolocalizedInformation" === n._type ? this._activePrisms[n.subAreaId] = n : this._emptyPrisms[n.subAreaId] = n;
  }
};
i.prototype.updatePrisms = function (e) {
  this._changingPrisms = {};
  for (var t = Object.keys(e), i = 0; i < t.length; i++) {
    var n = e[t[i]],
      o = n.subAreaId,
      a = this._prisms[n.subAreaId];
    "PrismGeolocalizedInformation" === n._type ? ((!a || a.mapId !== n.mapId || a.worldX !== n.worldX || a.worldY !== n.worldY || a.subAreaId !== n.subAreaId || a.prism.state !== n.prism.state || a.prism.alliance && n.prism.alliance && a.prism.alliance.allianceTag !== n.prism.alliance.allianceTag) && (this._changingPrisms[n.subAreaId] = n), this._activePrisms[o] = n, delete this._emptyPrisms[o]) : (this._emptyPrisms[o] = n, delete this._activePrisms[o]);
    this._prisms[n.subAreaId] = n;
  }
};
i.prototype.forEachChangingActivePrism = function (e) {
  for (var t = Object.keys(this._changingPrisms), i = 0; i < t.length; i++) {
    var n = this._changingPrisms[t[i]];
    this._activePrisms[n.subAreaId] && e(n);
  }
};
i.prototype.forEachPrism = function (e, t) {
  for (var i = Object.keys(this._prisms), n = 0; n < i.length; n++) {
    var o = this._prisms[i[n]];
    o.prism && (null !== t && void 0 !== t && o.prism.state !== t || e(this._prisms[i[n]]));
  }
};
i.prototype.forEachEmptyPrism = function (e) {
  for (var t = Object.keys(this._emptyPrisms), i = 0; i < t.length; i++) {
    e(this._emptyPrisms[t[i]]);
  }
};
this._prisms = {};
this._emptyPrisms = {};
this._activePrisms = {};
this._changingPrisms = {};
this._prisms[n.subAreaId] = n;
"PrismGeolocalizedInformation" === n._type ? this._activePrisms[n.subAreaId] = n : this._emptyPrisms[n.subAreaId] = n;
"PrismGeolocalizedInformation" === n._type ? ((!a || a.mapId !== n.mapId || a.worldX !== n.worldX || a.worldY !== n.worldY || a.subAreaId !== n.subAreaId || a.prism.state !== n.prism.state || a.prism.alliance && n.prism.alliance && a.prism.alliance.allianceTag !== n.prism.alliance.allianceTag) && (this._changingPrisms[n.subAreaId] = n), this._activePrisms[o] = n, delete this._emptyPrisms[o]) : (this._emptyPrisms[o] = n, delete this._activePrisms[o]);
this._prisms[n.subAreaId] = n;
this._deferredActionQueue = new s();
this._iconTaxCollectors = null;
this._worldmap = null;
a.on("taxCollectorList", this.onTaxCollectorsList.bind(this));
e.exports = n;
n.prototype.updateTaxCollectors = function () {
  window.gui.playerData.guild.hasGuild() && window.dofus.sendMessage("GuildGetInformationsMessage", {
    infoType: l.INFO_TAX_COLLECTOR_GUILD_ONLY
  });
};
n.prototype._updateIconsFromTaxCollectors = function (e) {
  var t = this,
    i = {};
  c.each(e, function (e, n) {
    if (!o(e, window.gui.playerData.guild.current)) {
      return n();
    }
    var a = t.getIconInfo(e),
      s = a.subAreaId;
    return void 0 === s || null === s ? (i[a.id] = a, n()) : void d.getDataMap("SubAreas", [s], function (e, o) {
      if (e) {
        return n(e);
      }
      var r = o[s],
        l = r.areaId,
        c = window.gui.databases.Areas[l];
      if (!c) {
        return n(new Error("The area " + l + " doesn't exist"));
      }
      var d = c.superAreaId,
        u = window.gui.databases.SuperAreas[c.superAreaId];
      if (!u) {
        return n(new Error("The super area " + d + " doesn't exist"));
      }
      var h = r.customWorldMap[0] || u.worldmapId;
      return h === t._worldmap.getDisplayedWorldmapId() && (i[a.id] = a), n();
    });
  }, function (e) {
    if (e) {
      return console.error(e);
    }
    var n, o;
    if (t._iconTaxCollectors) {
      for (n in t._iconTaxCollectors) {
        o = t._iconTaxCollectors[n];
        i.hasOwnProperty(o.id) || t._worldmap.removeIcon(o.id);
      }
    }
    for (n in i) {
      o = i[n];
      t._iconTaxCollectors && !t._iconTaxCollectors.hasOwnProperty(o.id) && t._worldmap.addIcon(o, "icon_" + o.gfx);
    }
    t._iconTaxCollectors = i;
  });
};
n.prototype.onTaxCollectorsList = function (e, t) {
  function i() {
    n._updateIconsFromTaxCollectors(t);
  }
  var n = this;
  this._worldmap ? i() : this._deferredActionQueue.enqueue(i);
};
n.prototype.setWorldMap = function (e) {
  this._worldmap = e;
  this._deferredActionQueue.signal();
};
n.prototype.getIconInfo = function (e) {
  return {
    id: "tax_" + e.worldX + "_" + e.worldY,
    x: e.worldX,
    y: e.worldY,
    subAreaId: e.subAreaId,
    categoryId: 7,
    gfx: "1003",
    nameId: r("ui.common.taxCollector")
  };
};
o = t._iconTaxCollectors[n];
i.hasOwnProperty(o.id) || t._worldmap.removeIcon(o.id);
o = i[n];
t._iconTaxCollectors && !t._iconTaxCollectors.hasOwnProperty(o.id) && t._worldmap.addIcon(o, "icon_" + o.gfx);
this._worldmap = e;
this._deferredActionQueue.signal();
a.call(this, {
  window: {
    className: "SocialWindow",
    positionInfo: {
      top: 40,
      left: 80,
      right: 40,
      bottom: 40
    }
  }
});
this.addTab("friends", new d(), s("ui.common.friends"));
this.addTab("guild", new u(), s("ui.common.guild"));
this.addTab("alliance", new l(), s("ui.common.alliance"));
this.addTab("spouse", new h(), s("ui.common.spouse", 0));
this.addTab("directory", new p(), s("ui.common.directory"));
this.closedWithGuildFightLeaveRequest = !1;
this.on("open", function (e) {
  this.openTab(e.tabId, e.tabParams, {
    delayOpenedEvent: !0,
    forceOpen: !0
  });
});
this.on("close", function () {
  var e,
    t = window.gui.playerData.id;
  e = r.isPlayerDefending(r.entityType.taxCollector, t);
  e && r.playerAutoKick(r.entityType.taxCollector, e);
  e = r.isPlayerDefending(r.entityType.prism, t);
  e && r.playerAutoKick(r.entityType.prism, e);
});
f.on("gameContextChanged", this.onGameContextChanged.bind(this));
this._setupEvents();
e = r.isPlayerDefending(r.entityType.taxCollector, t);
e && r.playerAutoKick(r.entityType.taxCollector, e);
e = r.isPlayerDefending(r.entityType.prism, t);
e && r.playerAutoKick(r.entityType.prism, e);
o(n, a);
e.exports = n;
n.prototype.onGameContextChanged = function () {
  f.isFightMode && m.close(this.id);
};
n.prototype._setupEvents = function () {
  var e = this,
    t = window.dofus.connectionManager;
  t.on("ClientUIOpenedMessage", function (t) {
    e._clientUiOpen(t.type);
  });
  t.on("ClientUIOpenedByObjectMessage", function (t) {
    e._clientUiOpen(t.type);
  });
};
n.prototype._clientUiOpen = function (e) {
  if (window.gui.playerData.guild.hasGuild()) {
    var t;
    switch (e) {
      case c.CLIENT_UI_TELEPORT_GUILD_PADDOCK:
        t = "paddocks";
        break;
      case c.CLIENT_UI_TELEPORT_GUILD_HOUSE:
        t = "houses";
        break;
      default:
        return;
    }
    this.openState ? (this.openTab("guild", {
      tabId: t
    }), m.focusWindow(this.id)) : m.open(this.id, {
      tabId: "guild",
      tabParams: {
        tabId: t
      }
    });
  }
};
t.on("ClientUIOpenedMessage", function (t) {
  e._clientUiOpen(t.type);
});
t.on("ClientUIOpenedByObjectMessage", function (t) {
  e._clientUiOpen(t.type);
});
this.once("open", function () {
  this._createDom();
  window.gui.playerData.alliance.on("allianceUpdated", function (t) {
    e._updateAllianceInformation();
    var i = e.tabs.tabMap;
    for (var n in i) {
      i[n].content.emit("allianceUpdated", t);
    }
  });
});
this.on("open", function (e) {
  e = e || {};
  var t = e.tabId || "guilds";
  this.tabs.openTab(t);
  this._guilds.emit("allianceUpdateRequested");
  window.dofus.sendMessage("AllianceInsiderInfoRequestMessage");
  window.dofus.sendMessage("PrismsListRegisterMessage", {
    listen: u.PRISM_LISTEN_MINE
  });
});
this.on("close", function () {
  this.tabs.close();
});
this._createDom();
window.gui.playerData.alliance.on("allianceUpdated", function (t) {
  e._updateAllianceInformation();
  var i = e.tabs.tabMap;
  for (var n in i) {
    i[n].content.emit("allianceUpdated", t);
  }
});
this.tabs.openTab(t);
this._guilds.emit("allianceUpdateRequested");
window.dofus.sendMessage("AllianceInsiderInfoRequestMessage");
window.dofus.sendMessage("PrismsListRegisterMessage", {
  listen: u.PRISM_LISTEN_MINE
});
a(n, l);
e.exports = n;
n.prototype._updateAllianceInformation = function () {
  var e = window.gui.playerData.alliance.current;
  this._updateAllianceCreationData(e);
  this.emblem.setValue(e.allianceEmblem, !0);
  var t = p.getWindow("social");
  t.setTitle(s("ui.common.alliance") + " - " + e.allianceName);
  this.tag.setText("[" + e.allianceTag + "]");
  this.members.setText(s("ui.alliance.membersInGuilds", e.nbMembers, e.guildCount, e.guildCount));
};
n.prototype._updateAllianceCreationData = function (e) {
  var t = new d(1e3 * e.creationDate).getServerDate().toString(!1);
  this.creationDate.setText(t.date);
};
n.prototype._createDom = function () {
  this._buildHeader();
  this._buildTabs();
};
n.prototype._buildHeader = function () {
  var e = this.createChild("div", {
      className: "description"
    }),
    t = e.createChild("div", {
      className: ["column", "title"]
    }),
    i = e.createChild("div", {
      className: ["column", "content"]
    }),
    n = e.createChild("div", {
      className: ["column", "emblem"]
    });
  this.emblem = n.appendChild(new c({
    width: 70,
    height: 70
  }));
  t.createChild("div", {
    text: s("ui.alliance.tag") + ":"
  });
  this.tag = i.createChild("div", {
    className: "link"
  });
  h(this.tag);
  this.tag.on("tap", function () {
    o.openAllianceCard(window.gui.playerData.alliance.current.allianceId);
  });
  t.createChild("div", {
    text: s("ui.common.creationDate") + ":"
  });
  this.creationDate = i.createChild("div");
  t.createChild("div", {
    text: s("ui.common.members") + ":"
  });
  this.members = i.createChild("div");
};
n.prototype._buildTabs = function () {
  var e = this.tabs = this.appendChild(new r());
  this._guilds = new m();
  e.addTab(s("ui.social.guilds"), this._guilds, "guilds");
  e.addTab(s("ui.common.conquest"), new f(), "conquests");
  e.addTab(s("ui.common.attacks"), new g(), "attacks");
};
this._updateAllianceCreationData(e);
this.emblem.setValue(e.allianceEmblem, !0);
t.setTitle(s("ui.common.alliance") + " - " + e.allianceName);
this.tag.setText("[" + e.allianceTag + "]");
this.members.setText(s("ui.alliance.membersInGuilds", e.nbMembers, e.guildCount, e.guildCount));
this._buildHeader();
this._buildTabs();
this.emblem = n.appendChild(new c({
  width: 70,
  height: 70
}));
t.createChild("div", {
  text: s("ui.alliance.tag") + ":"
});
this.tag = i.createChild("div", {
  className: "link"
});
h(this.tag);
this.tag.on("tap", function () {
  o.openAllianceCard(window.gui.playerData.alliance.current.allianceId);
});
t.createChild("div", {
  text: s("ui.common.creationDate") + ":"
});
this.creationDate = i.createChild("div");
t.createChild("div", {
  text: s("ui.common.members") + ":"
});
this.members = i.createChild("div");
this._guilds = new m();
e.addTab(s("ui.social.guilds"), this._guilds, "guilds");
e.addTab(s("ui.common.conquest"), new f(), "conquests");
e.addTab(s("ui.common.attacks"), new g(), "attacks");
_.call(this, "div", {
  className: "GuildsTab"
});
this._createDom();
this.on("allianceUpdated", function (e) {
  this.table.clearContent();
  this.table.addList(e.guilds);
  this.table.setContentLoading(!1);
});
this.on("allianceUpdateRequested", function () {
  this.table.setContentLoading(!0);
});
this.table.clearContent();
this.table.addList(e.guilds);
this.table.setContentLoading(!1);
window.gui.playerData.alliance.on("guildLeft", function (t) {
  e.table.delRow(t);
});
this.on("open", function () {
  this._updateAvaMode();
});
p(n, _);
e.exports = n;
n.prototype._updateAvaMode = function () {
  var e = window.gui.playerData.characterBaseInformations,
    t = !1;
  if (e.level >= 50) {
    this.avaMode.enable();
    var i = window.gui.playerData.characters.mainCharacter.characteristics.alignmentInfos.aggressable;
    t = i === s.AvA_ENABLED_AGGRESSABLE || i === s.AvA_ENABLED_NON_AGGRESSABLE || i === s.AvA_DISQUALIFIED || i === s.AvA_PREQUALIFIED_AGGRESSABLE;
    var n = this.avaMode.isActivate();
    n !== t && this.avaMode.toggleActivation(t);
  } else {
    this.avaMode.disable();
  }
};
n.prototype._createDom = function () {
  function e(e) {
    var t = new _("div", {
        className: "nameBox"
      }),
      i = t.createChild("div", {
        text: e.guildName,
        className: "link"
      });
    f(i);
    i.on("tap", function () {
      h.openGuildCard(e.guildId);
    });
    var n = t.createChild("div");
    return f(n), n.on("tap", function () {
      window.gui.openContextualMenu("player", {
        playerName: e.leaderName,
        playerId: e.leaderId,
        guildId: e.guildId,
        hasGuild: !0
      });
    }), n.createChild("span", {
      text: u("ui.guild.leadBy", "")
    }), n.createChild("span", {
      text: e.leaderName,
      className: "link"
    }), t;
  }
  function t(e) {
    var t = new _("div", {
        className: "memberBox"
      }),
      i = t.createChild("div", {
        text: u("ui.guild.onlineMembers", e.nbConnectedMembers, e.nbMembers)
      });
    if (0 === e.nbConnectedMembers && e.lastActivity > 0) {
      var n,
        o = e.getHoursSinceLastConnection(),
        a = Math.floor(o / 720),
        s = Math.floor((o - 720 * a) / 24);
      n = a > 0 ? s > 0 ? u("ui.social.monthsAndDaysSinceLastConnection", a, s, s) : u("ui.social.monthsSinceLastConnection", a, a) : s > 0 ? u("ui.social.daysSinceLastConnection", s, s) : u("ui.social.lessThanADay");
      l(i, u("ui.social.lastConnection", n));
    }
    return t.createChild("div", {
      text: e.nbTaxCollectors + " " + u("ui.social.guildTaxCollectors")
    }), t;
  }
  function i(e) {
    var t,
      i = e.leaderId === g;
    return p ? (t = new _("div", {
      className: "buttonBox"
    }), t.appendChild(o(r, e, i)), i || t.appendChild(a(e))) : i ? (t = new _("div", {
      className: "buttonBox"
    }), t.appendChild(o(r, e, !0))) : t = "", t;
  }
  function n(e) {
    var t = new d({
      width: 50,
      height: 50
    });
    return t.setValue({
      guild: e
    }), t;
  }
  var s = window.gui.playerData,
    r = s.alliance.current,
    p = s.alliance.isBoss(),
    g = s.id;
  this.table = this.appendChild(new m([{
    id: "emblem",
    format: n
  }, {
    id: "guildName",
    header: u("ui.common.name"),
    format: e,
    defaultSorter: !0,
    sort: !0
  }, {
    id: "guildLevel",
    header: u("ui.common.level"),
    sort: !0
  }, {
    id: "nbMembers",
    header: u("ui.common.members"),
    format: t,
    sort: !0
  }, {
    id: "actions",
    format: i
  }], "guildId", {
    clickable: !1
  }));
  this.avaMode = this.appendChild(new c(u("ui.alliance.activateAvA")));
  this.avaMode.on("change", function (e) {
    window.dofus.sendMessage("SetEnableAVARequestMessage", {
      enable: e
    });
  });
};
f(i);
i.on("tap", function () {
  h.openGuildCard(e.guildId);
});
n = a > 0 ? s > 0 ? u("ui.social.monthsAndDaysSinceLastConnection", a, s, s) : u("ui.social.monthsSinceLastConnection", a, a) : s > 0 ? u("ui.social.daysSinceLastConnection", s, s) : u("ui.social.lessThanADay");
l(i, u("ui.social.lastConnection", n));
this.table = this.appendChild(new m([{
  id: "emblem",
  format: n
}, {
  id: "guildName",
  header: u("ui.common.name"),
  format: e,
  defaultSorter: !0,
  sort: !0
}, {
  id: "guildLevel",
  header: u("ui.common.level"),
  sort: !0
}, {
  id: "nbMembers",
  header: u("ui.common.members"),
  format: t,
  sort: !0
}, {
  id: "actions",
  format: i
}], "guildId", {
  clickable: !1
}));
this.avaMode = this.appendChild(new c(u("ui.alliance.activateAvA")));
this.avaMode.on("change", function (e) {
  window.dofus.sendMessage("SetEnableAVARequestMessage", {
    enable: e
  });
});
g.call(this, "div", {
  className: "ConquestsTab"
});
this.once("open", function () {
  this._createDom();
  this._setupEvents();
  this._updateConquests();
});
this._createDom();
this._setupEvents();
this._updateConquests();
d(n, g);
e.exports = n;
n.prototype._setupEvents = function () {
  function e() {
    var e = window.gui.playerData.position.subAreaId;
    t.table.hasRow(e) ? t.table.selectRow(e) : t.table.unSelectRow();
  }
  var t = this;
  this.on("open", e);
  var i = window.gui.playerData.alliance;
  i.on("prismUpdatedList", function (i) {
    t.table.updateRows(i);
    t._updateConquests();
    e();
  });
  i.on("prismDeletedList", function (i) {
    t.table.delRows(i);
    t._updateConquests();
    e();
  });
  this.on("allianceUpdated", function (t) {
    this.table.clearContent();
    this.table.addMap(t.prisms);
    this._updateConquests();
    this.table.setContentLoading(!1);
    e();
  });
  this.on("allianceUpdateRequested", function () {
    this.table.setContentLoading(!0);
  });
  this.table.addMap(i.current.prisms);
  e();
};
n.prototype._createDom = function () {
  function e(e) {
    var t,
      i = e.prism,
      s = new p.DofusDate(1e3 * i.nextVulnerabilityDate),
      d = s.getServerDate(),
      h = d.toString().time,
      m = n.guild.hasRight(c.GUILD_RIGHT_SET_ALLIANCE_PRISM);
    if (i.state !== u.PRISM_STATE_INVULNERABLE && i.state !== u.PRISM_STATE_NORMAL || !m) {
      t = h;
    } else {
      t = new g("div", {
        className: "timeSetting"
      });
      var f = t.createChild("div", {
          text: h
        }),
        _ = r.guilds[i.lastTimeSlotModificationAuthorGuildId];
      _ && a(f, l("ui.prism.lastVulnerabilityChange", new p.DofusDate(1e3 * i.lastTimeSlotModificationDate).getLocalDate().toString().date, i.lastTimeSlotModificationAuthorName, _.guildName) + "\n" + l("ui.prism.serverVulnerabilityHour") + " : " + h + "\n" + l("ui.prism.localVulnerabilityHour") + " : " + s.getLocalDate().toString().time);
      t.appendChild(o(e, s));
    }
    return t;
  }
  function t(e) {
    var t = e.prism,
      i = new g("div", {
        text: s.prismState[t.state]
      }),
      n = s.getPrismStateInfo(t.state, 1e3 * t.nextVulnerabilityDate - Date.now());
    return a(i, n), i;
  }
  function i(e) {
    var t = e.enrichData,
      i = new g("div", {
        text: t.subAreaName + " (" + t.areaName + ")"
      });
    return a(i, l(t.isConquestVillage ? "ui.zaap.village" : "ui.zaap.prism")), i;
  }
  this.conquestsInfo = this.createChild("div", {
    className: "conquestsInfo"
  });
  var n = window.gui.playerData;
  this.table = this.appendChild(new h([{
    id: "subArea",
    header: l("ui.map.subarea"),
    format: i,
    getContent: function (e) {
      return e.enrichData.subAreaName;
    },
    sort: !0,
    defaultSorter: !0
  }, {
    id: "worldX",
    header: l("ui.common.coordinatesSmall"),
    format: function (e) {
      return e.worldX + "," + e.worldY;
    },
    sort: !0
  }, {
    id: "placementDate",
    header: l("ui.social.guild.taxStartDate"),
    format: function (e) {
      return new p.DofusDate(1e3 * e.prism.placementDate).getServerDate().toString().date;
    },
    getContent: function (e) {
      return e.prism.placementDate;
    },
    sort: !0
  }, {
    id: "state",
    header: l("ui.common.state"),
    format: t,
    getContent: function (e) {
      return e.prism.state;
    },
    sort: !0
  }, {
    id: "nextVulnerabilityDate",
    header: l("ui.prism.startVulnerability"),
    format: e,
    getContent: function (e) {
      return e.prism.nextVulnerabilityDate;
    },
    sort: !0
  }], "subAreaId", {
    clickable: !1
  }));
};
n.prototype._updateConquests = function () {
  var e = window.gui.playerData,
    t = e.alliance.current.prisms,
    i = 0,
    n = 0;
  for (var o in t) {
    var a = t[o];
    a.mapId <= -1 || (a.enrichData.isConquestVillage ? n += 1 : i += 1);
  }
  0 === i && 0 === n ? this.conquestsInfo.setText(l("ui.alliance.noArea")) : i > 0 && 0 === n ? this.conquestsInfo.setText(l("ui.alliance.nbAreas", i, i)) : 0 === i && n > 0 ? this.conquestsInfo.setText(l("ui.alliance.nbVillages", n, n)) : this.conquestsInfo.setText(l("ui.alliance.nbAreasAndVillages", i, n, n + i));
};
i.on("prismUpdatedList", function (i) {
  t.table.updateRows(i);
  t._updateConquests();
  e();
});
i.on("prismDeletedList", function (i) {
  t.table.delRows(i);
  t._updateConquests();
  e();
});
this.on("allianceUpdated", function (t) {
  this.table.clearContent();
  this.table.addMap(t.prisms);
  this._updateConquests();
  this.table.setContentLoading(!1);
  e();
});
this.on("allianceUpdateRequested", function () {
  this.table.setContentLoading(!0);
});
this.table.addMap(i.current.prisms);
e();
t.table.updateRows(i);
t._updateConquests();
e();
t.table.delRows(i);
t._updateConquests();
e();
this.table.clearContent();
this.table.addMap(t.prisms);
this._updateConquests();
this.table.setContentLoading(!1);
e();
_ && a(f, l("ui.prism.lastVulnerabilityChange", new p.DofusDate(1e3 * i.lastTimeSlotModificationDate).getLocalDate().toString().date, i.lastTimeSlotModificationAuthorName, _.guildName) + "\n" + l("ui.prism.serverVulnerabilityHour") + " : " + h + "\n" + l("ui.prism.localVulnerabilityHour") + " : " + s.getLocalDate().toString().time);
t.appendChild(o(e, s));
v.call(this, "div", {
  className: "AttacksTab"
});
this.once("open", function () {
  this._createDom();
  this._setupEvents();
});
this.on("open", function () {
  this._loadCurrentPrismFight();
  this._updateFightCount();
  window.dofus.sendMessage("GuildGetInformationsMessage", {
    infoType: p.INFO_TAX_COLLECTOR_ALLIANCE
  });
});
this.on("close", function () {
  this.table.clearContent();
  window.dofus.sendMessage("GuildGetInformationsMessage", {
    infoType: p.INFO_TAX_COLLECTOR_LEAVE
  });
});
this._createDom();
this._setupEvents();
this._loadCurrentPrismFight();
this._updateFightCount();
window.dofus.sendMessage("GuildGetInformationsMessage", {
  infoType: p.INFO_TAX_COLLECTOR_ALLIANCE
});
this.table.clearContent();
window.dofus.sendMessage("GuildGetInformationsMessage", {
  infoType: p.INFO_TAX_COLLECTOR_LEAVE
});
clearInterval(e.intervalId);
e.intervalId = null;
e.totalWaitTime = Math.round(t.waitTimeForPlacement / 10) || 1;
e.remainSeconds = Math.round(t.timeLeftBeforeFight / 10) || 0;
e.intervalId = setInterval(function () {
  e.remainSeconds -= 1;
  e.remainSeconds > 0 ? o(e) : a(e);
}, 1e3);
o(e);
e.remainSeconds -= 1;
e.remainSeconds > 0 ? o(e) : a(e);
g(n, v);
e.exports = n;
M[y.prism] = function (e) {
  var t = this.fight;
  if (t.state === u.fightState.waitingForHelp) {
    var i = t.id,
      n = window.gui.playerData.id;
    u.isPlayerFightingFor(n, y.prism, i, w.allies) ? e && n === e.id && window.dofus.sendMessage("PrismFightJoinLeaveRequestMessage", {
      subAreaId: i,
      join: !1
    }) : e && 5 === t.fighters[w.allies].length ? window.dofus.sendMessage("PrismFightSwapRequestMessage", {
      subAreaId: i,
      targetId: e.id
    }) : window.dofus.sendMessage("PrismFightJoinLeaveRequestMessage", {
      subAreaId: i,
      join: !0
    });
  }
};
M[y.taxCollector] = function (e) {
  var t = this.fight;
  if (t.state === u.fightState.waitingForHelp) {
    var i = t.id,
      n = window.gui.playerData.id;
    u.isPlayerFightingFor(n, y.taxCollector, i, w.allies) ? e && n === e.id && window.dofus.sendMessage("GuildFightLeaveRequestMessage", {
      taxCollectorId: i,
      characterId: n
    }) : e && 5 === t.fighters[w.allies].length ? window.dofus.sendMessage("GuildFightTakePlaceRequestMessage", {
      taxCollectorId: i,
      replacedCharacterId: e.id
    }) : window.dofus.sendMessage("GuildFightJoinRequestMessage", {
      taxCollectorId: i
    });
  }
};
n.prototype._createDom = function () {
  this.table = this.appendChild(new _([{
    id: "type",
    format: r
  }, {
    id: "target",
    header: h("ui.common.name") + " / " + h("ui.common.localisation"),
    format: l
  }, {
    id: "timer",
    format: c
  }, {
    id: "fightersInfo",
    header: h("ui.common.defenders") + " / " + h("ui.common.attackers"),
    format: d
  }], "id", {
    clickable: !1
  }));
  this.currentFights = this.createChild("div", {
    className: "currentFights"
  });
  this.createChild("div", {
    className: "howTo",
    text: h("ui.alliance.howToDefend")
  });
};
n.prototype._updateFightCount = function () {
  var e = this.table.getRowCount();
  this.currentFights.setText(h("ui.alliance.currentFights", e, e));
};
n.prototype._loadCurrentPrismFight = function () {
  var e = u.fights.prism;
  for (var t in e) {
    var i = e[t];
    i.state === b.waitingForHelp && (this.table.hasRow(i.id) || this.table.addRow(i));
  }
};
n.prototype._setupEvents = function () {
  function e(e, t) {
    var n = i.table.getCell(t, "fightersInfo");
    if (!(n && n.setFighters && n.setFighter && n.setTarget)) {
      var o = "Cannot find the fighters info for type " + e + " fightId " + t;
      return o += " fighters info is null? " + !n, console.error(new Error(o)), null;
    }
    return n;
  }
  function t(e) {
    i.isVisible() && i.table.hasRow(e) && (i.table.delRow(e), i._updateFightCount());
  }
  var i = this;
  u.on("fightStarted", function (e, t) {
    i.isVisible() && t.state === b.waitingForHelp && (i.table.addRow(t), i._updateFightCount());
  });
  u.on("fighting", function (e, i) {
    t(i.id);
  });
  u.on("fightEnded", function (e, i) {
    t(i);
  });
  u.on("fighterList", function (t, n, o, a) {
    if (i.isVisible() && i.table.hasRow(n)) {
      var s = e(t, n);
      s && s.setFighters(o, a);
    }
  });
  u.on("fighterJoined", function (t, n, o, a, s) {
    if (i.isVisible() && i.table.hasRow(n)) {
      var r = e(t, n);
      r && r.setFighter(o, a, s);
    }
  });
  u.on("fightTarget", function (t, n, o) {
    if (i.isVisible() && t === y.prism && i.table.hasRow(n)) {
      var a = e(t, n);
      a && a.setTarget({
        id: o.id,
        entityLook: o.look,
        name: o.getName(),
        level: o.level
      });
    }
  });
  u.on("fighterLeft", function (t, n, o, a, s) {
    if (i.isVisible() && i.table.hasRow(n)) {
      var r = e(t, n);
      r && r.removeFighter(o, s);
    }
  });
};
this.table = this.appendChild(new _([{
  id: "type",
  format: r
}, {
  id: "target",
  header: h("ui.common.name") + " / " + h("ui.common.localisation"),
  format: l
}, {
  id: "timer",
  format: c
}, {
  id: "fightersInfo",
  header: h("ui.common.defenders") + " / " + h("ui.common.attackers"),
  format: d
}], "id", {
  clickable: !1
}));
this.currentFights = this.createChild("div", {
  className: "currentFights"
});
this.createChild("div", {
  className: "howTo",
  text: h("ui.alliance.howToDefend")
});
u.on("fightStarted", function (e, t) {
  i.isVisible() && t.state === b.waitingForHelp && (i.table.addRow(t), i._updateFightCount());
});
u.on("fighting", function (e, i) {
  t(i.id);
});
u.on("fightEnded", function (e, i) {
  t(i);
});
u.on("fighterList", function (t, n, o, a) {
  if (i.isVisible() && i.table.hasRow(n)) {
    var s = e(t, n);
    s && s.setFighters(o, a);
  }
});
u.on("fighterJoined", function (t, n, o, a, s) {
  if (i.isVisible() && i.table.hasRow(n)) {
    var r = e(t, n);
    r && r.setFighter(o, a, s);
  }
});
u.on("fightTarget", function (t, n, o) {
  if (i.isVisible() && t === y.prism && i.table.hasRow(n)) {
    var a = e(t, n);
    a && a.setTarget({
      id: o.id,
      entityLook: o.look,
      name: o.getName(),
      level: o.level
    });
  }
});
u.on("fighterLeft", function (t, n, o, a, s) {
  if (i.isVisible() && i.table.hasRow(n)) {
    var r = e(t, n);
    r && r.removeFighter(o, s);
  }
});
l.call(this, "div", {
  className: "FightersInfo"
});
this.allies = {};
this.enemies = {};
this.allies.icon = e.createChild("div", {
  className: ["fightMode", "defend", "hidden"]
});
this._addFightModeToolTip(this.allies.icon, u("ui.common.defenders"), "allies");
this.enemies.icon = t.createChild("div", {
  className: ["fightMode", "attack", "hidden"]
});
this._addFightModeToolTip(this.enemies.icon, u("ui.common.attackers"), "enemies");
this.allies.slotContainer = e.createChild("div", {
  className: "fighterList"
});
this.enemies.slotContainer = t.createChild("div", {
  className: "fighterList"
});
this.targetSlot = this.allies.slotContainer.appendChild(this._createTargetDisplay());
this.allies.slots = [];
this.enemies.slots = [];
i = this.allies.slotContainer.appendChild(this._createFighterSlot(!0));
this.allies.slots.push(i);
i = this.enemies.slotContainer.appendChild(this._createFighterSlot());
this.enemies.slots.push(i);
e.fighter = t;
h.enableTooltip(e, !0);
e.setLook(t.entityLook, {
  riderOnly: !0,
  direction: d.DIRECTION_SOUTH_WEST,
  animation: "AnimArtwork",
  boneType: "timeline/",
  skinType: "timeline/"
});
e.fighter = null;
e.clear();
h.enableTooltip(e, !1);
r(n, l);
e.exports = n;
n.prototype._addFightModeToolTip = function (e, t, i) {
  var n = this;
  h.addTooltip(e, function () {
    var e = t + u("ui.common.colon") + "\n",
      a = n[i].slots;
    if ("allies" === i) {
      var s = n.targetSlot.fighter;
      e += s.name + " (" + u("ui.common.short.level") + " " + s.level + ")\n";
    }
    for (var r = 0; r < a.length; r += 1) {
      var c = a[r].fighter;
      c && (e += o(c) + "\n");
    }
    return new l("div", {
      text: e
    });
  });
};
n.prototype._createTargetDisplay = function () {
  var e = new c({
    className: "fighterIcon",
    scale: "fitin"
  });
  return h.addTooltip(e, function () {
    var t = e.fighter;
    return new l("div", {
      text: t.name + " (" + u("ui.common.short.level") + " " + t.level + ")"
    });
  }), h.enableTooltip(e, !1), e;
};
n.prototype._createFighterSlot = function (e) {
  var t = new c({
    className: "fighterIcon",
    scale: "fitin"
  });
  if (h.addTooltip(t, function () {
    return new l("div", {
      text: o(t.fighter)
    });
  }), h.enableTooltip(t, !1), !e) {
    return t;
  }
  var i = this;
  return t.on("tap", function () {
    i.fight && i.emit("slotTap", this.fighter);
  }), t;
};
n.prototype.reset = function () {
  this.fight = null;
  this.allies.icon.addClassNames("hidden");
  this.enemies.icon.addClassNames("hidden");
  s(this.targetSlot);
  for (var e = this.allies.slots, t = this.enemies.slots, i = 0; i < m; i += 1) {
    s(e[i]);
    s(t[i]);
  }
};
n.prototype.setTarget = function (e) {
  a(this.targetSlot, e);
};
n.prototype.setFight = function (e, t) {
  this.type = e;
  this.fight = t;
  this.allies.icon.delClassNames("hidden");
  this.enemies.icon.delClassNames("hidden");
  var i = t.fighters;
  this.setFighters(p.allies, i.allies);
  this.setFighters(p.enemies, i.enemies);
};
n.prototype.setFighter = function (e, t, i) {
  a(this[e].slots[i], t);
};
n.prototype.removeFighter = function (e, t) {
  var i = this[e].slots,
    n = i.splice(t, 1)[0];
  s(n);
  this[e].slotContainer.appendChild(n);
  i.push(n);
};
n.prototype.setFighters = function (e, t) {
  for (var i = this[e].slots, n = 0; n < m; n += 1) {
    var o = t[n];
    o ? a(i[n], o) : s(i[n]);
  }
};
this.fight = null;
this.allies.icon.addClassNames("hidden");
this.enemies.icon.addClassNames("hidden");
s(this.targetSlot);
s(e[i]);
s(t[i]);
this.type = e;
this.fight = t;
this.allies.icon.delClassNames("hidden");
this.enemies.icon.delClassNames("hidden");
this.setFighters(p.allies, i.allies);
this.setFighters(p.enemies, i.enemies);
s(n);
this[e].slotContainer.appendChild(n);
i.push(n);
this.ListAddFailureEnum = {
  0: h("ui.common.unknownFail"),
  1: h("ui.social.friend.addFailureListFull"),
  2: h("ui.social.friend.addFailureNotFound"),
  3: h("ui.social.friend.addFailureEgocentric"),
  4: h("ui.social.friend.addFailureAlreadyInList")
};
this.tables = {};
this.tableParams = {
  colIds: ["playerIcon", "name", "level", "guild", "achievement", "stateIcon", "button"],
  headerContent: ["", h("ui.common.name"), h("ui.common.level"), h("ui.common.guild"), h("ui.achievement.achievement")],
  onRowTap: function () {
    window.gui.tooltipBox.closeTooltip();
  }
};
this.deleteTapCallback = {
  friends: function (t, i) {
    e("FriendDeleteRequestMessage", t, i);
  },
  enemies: function (t, i) {
    e("IgnoredDeleteRequestMessage", t, i, !1);
  },
  ignored: function (t, i) {
    e("IgnoredDeleteRequestMessage", t, i, !0);
  }
};
this.once("open", function () {
  t._createDom();
  t._setupEvents();
  var e = window.gui.playerData.socialData;
  for (var i in e.ignoredList) {
    t.addPlayer(e.ignoredList[i], "ignored");
  }
});
this.on("open", function (e) {
  e = e || {};
  t.tabs.openTab(e.tabId || 0);
  t.tables.friends.clearContent();
  t.tables.enemies.clearContent();
  window.dofus.sendMessage("FriendsGetListMessage");
  window.dofus.sendMessage("IgnoredGetListMessage");
});
t._createDom();
t._setupEvents();
e = e || {};
t.tabs.openTab(e.tabId || 0);
t.tables.friends.clearContent();
t.tables.enemies.clearContent();
window.dofus.sendMessage("FriendsGetListMessage");
window.dofus.sendMessage("IgnoredGetListMessage");
i && (n.session = i);
window.dofus.sendMessage(t, n);
s.setValue("");
c(n, d);
e.exports = n;
n.prototype._createDom = function () {
  var e = this.appendChild(new u());
  this.tabs = e;
  this.friendsPanel = this.createChild("div", {
    className: ["mainPanel", "friendsPanel"]
  });
  this.enemiesPanel = this.createChild("div", {
    className: ["mainPanel", "enemiesPanel"]
  });
  this.ignoredPanel = this.createChild("div", {
    className: ["mainPanel", "ignoredPanel"]
  });
  e.addTab(h("ui.common.friends"), this.friendsPanel, "friends");
  e.addTab(h("ui.common.enemies"), this.enemiesPanel, "enemies");
  e.addTab(h("ui.common.ignoreds"), this.ignoredPanel, "ignoreds");
  e.openTab(0);
  this._buildFriendsPanel();
  this._buildEnemiesPanel();
  this._buildIgnoredPanel();
};
n.prototype._buildFriendsPanel = function () {
  var e = this,
    t = this.friendsPanel;
  s(t, "FriendAddRequestMessage");
  this.tables.friends = t.appendChild(new m(this.tableParams));
  var i = v.getValue("showFriendOffline", !0),
    n = t.createChild("div", {
      className: "checkBoxes"
    });
  this.showFriendOfflineCheckbox = n.appendChild(new f(h("ui.social.showOfflinePerson"), {
    defaultValue: i
  }));
  var o = n.appendChild(new f(h("ui.social.warnWhenFriendsComeOnline"), {
    defaultValue: window.gui.playerData.socialData.onConnectNotification
  }));
  this.showFriendOfflineCheckbox.on("change", function (t) {
    r(e.tables.friends, t);
    v.setValue("showFriendOffline", t, 1);
  });
  o.on("change", function (e) {
    window.dofus.sendMessage("FriendSetWarnOnConnectionMessage", {
      enable: e
    });
  });
};
n.prototype._buildEnemiesPanel = function () {
  var e = this,
    t = this.enemiesPanel;
  s(t, "IgnoredAddRequestMessage", !1);
  this.tables.enemies = t.appendChild(new m(this.tableParams));
  var i = v.getValue("showEnemyOffline", !0),
    n = t.createChild("div", {
      className: "checkBoxes"
    });
  this.showEnemyOfflineCheckbox = n.appendChild(new f(h("ui.social.showOfflinePerson"), {
    defaultValue: i
  }));
  this.showEnemyOfflineCheckbox.on("change", function (t) {
    r(e.tables.enemies, t);
    v.setValue("showEnemyOffline", t, 1);
  });
};
n.prototype._buildIgnoredPanel = function () {
  s(this.ignoredPanel, "IgnoredAddRequestMessage", !0);
  this.tables.ignored = this.ignoredPanel.appendChild(new m(this.tableParams));
};
n.prototype._updateStateIcon = function (e, t) {
  var i = e.getChild("stateIcon").getChild("stateIcon");
  if (i.delClassNames("offline", "fight", "smiley"), i.getStyle("backgroundImage") && i.setStyle("backgroundImage", ""), i.clearContent(), i.hide(), !e.isConnected) {
    return i.addClassNames("offline"), void i.show();
  }
  var n;
  if (t.hasOwnProperty("moodSmileyId") && t.moodSmileyId > 0) {
    n = t.moodSmileyId;
    var o = window.gui.databases.Smileys[n];
    if (!o) {
      return console.error("Smiley " + n + " details are not available, it could not be displayed");
    }
    i.addClassNames("smiley");
    _.preloadImage("gfx/smilies/" + o.gfxId + ".png", function (e) {
      i.rootElement && (i.setStyle("backgroundImage", e), i.show());
    });
  }
  t.playerState === y.GAME_TYPE_FIGHT && (n ? i.appendChild(new d("div", {
    className: "smallFight"
  })) : (i.addClassNames("fight"), i.show()));
};
n.prototype._updatePlayerRow = function (e, t) {
  for (var i = this.tables[e], n = i.getRows(), a = 0; a < n.length; a++) {
    var s = n[a];
    if (s.accountId === t.accountId) {
      i.updateRow(a, {
        level: t.level || "?",
        guild: t.guildInfo ? t.guildInfo.guildName : "?",
        achievement: t.achievementPoints > 0 ? t.achievementPoints : "-"
      }, o(t));
      var r = s.isConnected;
      s.toggleClassName("offline", !r);
      var c = s.getChild("playerIcon").getChild("playerIcon");
      if (t.status) {
        var d = c.getChild("onlineStatusIcon");
        d.setClassNames("onlineStatusIcon", "status" + t.status.statusId);
      }
      var u = s.getChild("name").getChild("name");
      u.setText(s.nameText);
      var h = c.getChild("alignmentSide").getChild("headIcon");
      return r && !h.getStyle("backgroundImage") && l(t, h), void this._updateStateIcon(s, t);
    }
  }
};
n.prototype._setupEvents = function () {
  var e = this,
    t = window.gui.playerData.socialData;
  window.gui.on("disconnect", function () {
    e.tables.ignored.clearContent();
  });
  t.on("friendUpdate", function (t) {
    e._updatePlayerRow("friends", t);
    var i = v.getValue("showFriendOffline", !0);
    r(e.tables.friends, i);
  });
  t.on("ignoredUpdate", function (t) {
    e._updatePlayerRow("ignored", t);
  });
  t.on("enemyUpdate", function (t) {
    e._updatePlayerRow("enemies", t);
  });
  t.on("newFriendList", function () {
    var i = t.friendsList;
    for (var n in i) {
      e.addPlayer(i[n], "friends");
    }
    var o = e.showFriendOfflineCheckbox;
    o.isActivate() ? o.activate() : o.deactivate();
  });
  t.on("newEnemyList", function () {
    var i = t.enemiesList;
    for (var n in i) {
      e.addPlayer(i[n], "enemies");
    }
    var o = e.showEnemyOfflineCheckbox;
    o.isActivate() ? o.activate() : o.deactivate();
  });
  t.on("friendAdded", function (t) {
    e.addPlayer(t, "friends");
  });
  t.on("ignoredAdded", function (t) {
    e.addPlayer(t, "ignored");
  });
  t.on("enemyAdded", function (t) {
    e.addPlayer(t, "enemies");
  });
  t.on("friendDeleted", function (t) {
    e.deletePlayer(t, "friends");
  });
  t.on("ignoredDeleted", function (t) {
    e.deletePlayer(t, "ignored");
  });
  t.on("enemyDeleted", function (t) {
    e.deletePlayer(t, "enemies");
  });
};
n.prototype.addPlayer = function (e, t) {
  var i = this,
    n = this.tables[t],
    s = e.guildInfo ? e.guildInfo.guildName : "?",
    r = window.gui.playerData.alignment,
    c = new p({
      name: "deleteButton",
      className: "greenButton"
    });
  c.on("tap", function () {
    i.deleteTapCallback[t](this.accountId, this.playerNameDisplay);
  });
  c.accountId = e.accountId;
  c.playerNameDisplay = e.playerName || e.uniqueNickname.getForDisplay();
  var u = e.achievementPoints > 0 ? e.achievementPoints : "-",
    h = new p({
      name: "playerIcon",
      className: "playerIcon"
    }, a);
  h.createChild("div", {
    name: "onlineStatusIcon",
    className: ["onlineStatusIcon", e.status ? "status" + e.status.statusId : ""]
  });
  var m = h.createChild("div", {
    name: "alignmentSide",
    className: "alignmentSide"
  });
  e.alignmentSide !== w.ALIGNMENT_ANGEL && e.alignmentSide !== w.ALIGNMENT_EVIL || r.getSmallWingsUrl(e.alignmentSide, function (e) {
    m.rootElement && m.setStyle("backgroundImage", e);
  });
  var f = m.createChild("div", {
      className: "playerHead",
      name: "headIcon"
    }),
    g = new p({
      name: "name",
      text: " "
    }, a),
    _ = n.addRow({
      playerIcon: h,
      name: g,
      level: e.level ? e.level : "?",
      guild: s,
      achievement: u,
      stateIcon: new d("div", {
        name: "stateIcon",
        className: "stateIcon"
      }),
      button: c
    }, o(e));
  h.myRow = _;
  g.myRow = _;
  g.setText(_.nameText);
  var v = _.isConnected;
  _.toggleClassName("offline", !v);
  this._updateStateIcon(_, e);
  v && l(e, f);
};
n.prototype.deletePlayer = function (e, t) {
  var i = this.tables[t],
    n = i.getRows();
  e = parseInt(e, 10);
  for (var o = 0; o < n.length; o++) {
    if (n[o].accountId === e) {
      return i.delRow(o);
    }
  }
};
this.tabs = e;
this.friendsPanel = this.createChild("div", {
  className: ["mainPanel", "friendsPanel"]
});
this.enemiesPanel = this.createChild("div", {
  className: ["mainPanel", "enemiesPanel"]
});
this.ignoredPanel = this.createChild("div", {
  className: ["mainPanel", "ignoredPanel"]
});
e.addTab(h("ui.common.friends"), this.friendsPanel, "friends");
e.addTab(h("ui.common.enemies"), this.enemiesPanel, "enemies");
e.addTab(h("ui.common.ignoreds"), this.ignoredPanel, "ignoreds");
e.openTab(0);
this._buildFriendsPanel();
this._buildEnemiesPanel();
this._buildIgnoredPanel();
s(t, "FriendAddRequestMessage");
this.tables.friends = t.appendChild(new m(this.tableParams));
this.showFriendOfflineCheckbox.on("change", function (t) {
  r(e.tables.friends, t);
  v.setValue("showFriendOffline", t, 1);
});
o.on("change", function (e) {
  window.dofus.sendMessage("FriendSetWarnOnConnectionMessage", {
    enable: e
  });
});
r(e.tables.friends, t);
v.setValue("showFriendOffline", t, 1);
s(t, "IgnoredAddRequestMessage", !1);
this.tables.enemies = t.appendChild(new m(this.tableParams));
this.showEnemyOfflineCheckbox = n.appendChild(new f(h("ui.social.showOfflinePerson"), {
  defaultValue: i
}));
this.showEnemyOfflineCheckbox.on("change", function (t) {
  r(e.tables.enemies, t);
  v.setValue("showEnemyOffline", t, 1);
});
r(e.tables.enemies, t);
v.setValue("showEnemyOffline", t, 1);
s(this.ignoredPanel, "IgnoredAddRequestMessage", !0);
this.tables.ignored = this.ignoredPanel.appendChild(new m(this.tableParams));
i.addClassNames("smiley");
_.preloadImage("gfx/smilies/" + o.gfxId + ".png", function (e) {
  i.rootElement && (i.setStyle("backgroundImage", e), i.show());
});
window.gui.on("disconnect", function () {
  e.tables.ignored.clearContent();
});
t.on("friendUpdate", function (t) {
  e._updatePlayerRow("friends", t);
  var i = v.getValue("showFriendOffline", !0);
  r(e.tables.friends, i);
});
t.on("ignoredUpdate", function (t) {
  e._updatePlayerRow("ignored", t);
});
t.on("enemyUpdate", function (t) {
  e._updatePlayerRow("enemies", t);
});
t.on("newFriendList", function () {
  var i = t.friendsList;
  for (var n in i) {
    e.addPlayer(i[n], "friends");
  }
  var o = e.showFriendOfflineCheckbox;
  o.isActivate() ? o.activate() : o.deactivate();
});
t.on("newEnemyList", function () {
  var i = t.enemiesList;
  for (var n in i) {
    e.addPlayer(i[n], "enemies");
  }
  var o = e.showEnemyOfflineCheckbox;
  o.isActivate() ? o.activate() : o.deactivate();
});
t.on("friendAdded", function (t) {
  e.addPlayer(t, "friends");
});
t.on("ignoredAdded", function (t) {
  e.addPlayer(t, "ignored");
});
t.on("enemyAdded", function (t) {
  e.addPlayer(t, "enemies");
});
t.on("friendDeleted", function (t) {
  e.deletePlayer(t, "friends");
});
t.on("ignoredDeleted", function (t) {
  e.deletePlayer(t, "ignored");
});
t.on("enemyDeleted", function (t) {
  e.deletePlayer(t, "enemies");
});
c.on("tap", function () {
  i.deleteTapCallback[t](this.accountId, this.playerNameDisplay);
});
c.accountId = e.accountId;
c.playerNameDisplay = e.playerName || e.uniqueNickname.getForDisplay();
h.myRow = _;
g.myRow = _;
g.setText(_.nameText);
_.toggleClassName("offline", !v);
this._updateStateIcon(_, e);
v && l(e, f);
this.openedTabId = null;
this.once("open", function () {
  e._setupDom();
  e._setupEvents();
});
this.on("open", function (t) {
  t = t || {};
  window.dofus.sendMessage("GuildGetInformationsMessage", {
    infoType: g.INFO_GENERAL
  });
  this.openedTabId = t.tabId || "members";
  e.tabs.openTab(this.openedTabId, null, {
    forceOpen: !0
  });
});
this.on("close", function () {
  this._resetTabs();
});
e._setupDom();
e._setupEvents();
t = t || {};
window.dofus.sendMessage("GuildGetInformationsMessage", {
  infoType: g.INFO_GENERAL
});
this.openedTabId = t.tabId || "members";
e.tabs.openTab(this.openedTabId, null, {
  forceOpen: !0
});
o(n, r);
e.exports = n;
n.prototype._buildGuildGeneralInfoArea = function () {
  var e = this.createChild("div", {
      className: "guildGeneralInfo"
    }),
    t = e.createChild("div", {
      className: ["column", "title"]
    }),
    i = e.createChild("div", {
      className: ["column", "content"]
    }),
    n = e.createChild("div", {
      className: ["column", "emblem"]
    });
  this.emblem = n.appendChild(new f({
    width: 70,
    height: 70
  }));
  this.level = t.createChild("div");
  t.createChild("div", {
    className: "member",
    text: a("ui.common.members") + ":"
  });
  t.createChild("div", {
    text: a("ui.common.creationDate") + ":"
  });
  this.levelBar = i.appendChild(new m({
    className: "yellow"
  }));
  l(this.levelBar, function () {
    var e = window.gui.playerData.guild.current,
      t = _.intToString(e.experience || 0),
      i = _.intToString(e.expNextLevelFloor || 0);
    return new r("div", {
      text: t + " / " + i
    });
  });
  this.membersValue = i.createChild("div", {
    className: "memberValue"
  });
  this.creationDateValue = i.createChild("div");
};
n.prototype._setupDom = function () {
  function e() {
    window.dofus.sendMessage("GuildGetInformationsMessage", {
      infoType: this.id
    });
  }
  this._buildGuildGeneralInfoArea();
  this.tabs = this.appendChild(new s());
  var t = new c({
      className: "panel"
    }),
    i = new u(),
    n = new p(),
    o = new h({
      className: "panel"
    }),
    r = new d();
  t.id = g.INFO_MEMBERS;
  n.id = g.INFO_TAX_COLLECTOR_GUILD_ONLY;
  o.id = g.INFO_PADDOCKS;
  r.id = g.INFO_HOUSES;
  this.tabs.addTab(a("ui.common.members"), t, "members");
  this.tabs.addTab(a("tablet.social.announcements"), i, "customisation");
  this.tabs.addTab(a("ui.social.guildTaxCollectors"), n, "perceptors");
  this.tabs.addTab(a("ui.common.mountPark"), o, "paddocks");
  this.tabs.addTab(a("ui.common.housesWord"), r, "houses");
  t.on("open", e);
  o.on("open", e);
  r.on("open", e);
};
n.prototype._setupEvents = function () {
  var e = this,
    t = window.gui.playerData.guild;
  t.on("guildMemberCountUpdate", function () {
    e.isVisible() && e.membersValue.setText(t.current.nbConnectedMembers + " / " + t.current.nbMembers);
  });
  t.on("GuildGeneralInformationUpdate", function () {
    e.isVisible() && (e._updateEmblemLogoAndWindowTitle(), e._updateTabNotification());
  });
};
n.prototype._resetTabs = function () {
  null !== this.openedTabId && (this.openedTabId = null, this.tabs.close());
  this._updateTabNotification(!0);
};
n.prototype._updateTabNotification = function (e) {
  var t = window.gui.playerData.guild.current,
    i = !e && !!t.abandonnedPaddock;
  this.tabs.toggleTabNotification("paddocks", i);
};
n.prototype._updateGuildCreationData = function () {
  var e = new y(1e3 * window.gui.playerData.guild.current.creationDate).getServerDate().toString(!1);
  this.creationDateValue.setText(e.date);
};
n.prototype._updateEmblemLogoAndWindowTitle = function () {
  var e = window.gui.playerData.guild.current,
    t = e.guildEmblem,
    i = v.getWindow("social");
  i.setTitle(a("ui.common.guild") + " - " + e.guildName);
  this.level.setText(a("ui.common.rank", e.level));
  this.levelBar.setValue(e.experiencePercentage);
  this.membersValue.setText(e.nbConnectedMembers + " / " + e.nbMembers);
  this._updateGuildCreationData();
  this.emblem.setValue(t, !0);
};
this.emblem = n.appendChild(new f({
  width: 70,
  height: 70
}));
this.level = t.createChild("div");
t.createChild("div", {
  className: "member",
  text: a("ui.common.members") + ":"
});
t.createChild("div", {
  text: a("ui.common.creationDate") + ":"
});
this.levelBar = i.appendChild(new m({
  className: "yellow"
}));
l(this.levelBar, function () {
  var e = window.gui.playerData.guild.current,
    t = _.intToString(e.experience || 0),
    i = _.intToString(e.expNextLevelFloor || 0);
  return new r("div", {
    text: t + " / " + i
  });
});
this.membersValue = i.createChild("div", {
  className: "memberValue"
});
this.creationDateValue = i.createChild("div");
this._buildGuildGeneralInfoArea();
this.tabs = this.appendChild(new s());
t.id = g.INFO_MEMBERS;
n.id = g.INFO_TAX_COLLECTOR_GUILD_ONLY;
o.id = g.INFO_PADDOCKS;
r.id = g.INFO_HOUSES;
this.tabs.addTab(a("ui.common.members"), t, "members");
this.tabs.addTab(a("tablet.social.announcements"), i, "customisation");
this.tabs.addTab(a("ui.social.guildTaxCollectors"), n, "perceptors");
this.tabs.addTab(a("ui.common.mountPark"), o, "paddocks");
this.tabs.addTab(a("ui.common.housesWord"), r, "houses");
t.on("open", e);
o.on("open", e);
r.on("open", e);
t.on("guildMemberCountUpdate", function () {
  e.isVisible() && e.membersValue.setText(t.current.nbConnectedMembers + " / " + t.current.nbMembers);
});
t.on("GuildGeneralInformationUpdate", function () {
  e.isVisible() && (e._updateEmblemLogoAndWindowTitle(), e._updateTabNotification());
});
null !== this.openedTabId && (this.openedTabId = null, this.tabs.close());
this._updateTabNotification(!0);
i.setTitle(a("ui.common.guild") + " - " + e.guildName);
this.level.setText(a("ui.common.rank", e.level));
this.levelBar.setValue(e.experiencePercentage);
this.membersValue.setText(e.nbConnectedMembers + " / " + e.nbMembers);
this._updateGuildCreationData();
this.emblem.setValue(t, !0);
e = e || {};
r.call(this, "div", {
  className: "GuildMembers"
});
this.addClassNames(e.className);
this.once("open", function () {
  this._setupDom();
  this._setupSocketEvents();
});
this._setupDom();
this._setupSocketEvents();
w[f.NOT_CONNECTED] = "offline";
w[f.GAME_TYPE_ROLEPLAY] = "online";
w[f.GAME_TYPE_FIGHT] = "online";
w[f.UNKNOWN_STATE] = "offline";
l(s, r);
e.exports = s;
s.prototype._setupDom = function () {
  var e = this,
    t = [{
      id: "playerIcon",
      sort: a
    }, {
      id: "nameButton",
      header: d("ui.common.name"),
      sort: n
    }, {
      id: "rankName",
      header: d("ui.pvp.rank"),
      sort: o
    }, {
      id: "level",
      header: d("ui.common.short.level"),
      sort: !0
    }, {
      id: "xpPercentage",
      header: "%" + d("ui.common.xp"),
      sort: !0
    }, {
      id: "xp",
      header: d("ui.common.xp"),
      sort: !0
    }, {
      id: "achievement",
      header: d("ui.achievement.achievement"),
      sort: !0
    }, {
      id: "stateIcon",
      sort: a
    }, {
      id: "buttons"
    }];
  this.table = this.appendChild(new c(t, null, {
    clickable: !1
  }));
  this.table.addFilter(function (t) {
    return !!e.showOfflineCheckbox.isActivate() || "online" === t.onlineStatus;
  });
  var i = window.gui.playerData.guild.current.warnMemberOnConnectionState,
    s = y.getValue("showGuildMembersOffline", !1),
    r = this.createChild("div", {
      className: "underTable"
    });
  this.showOfflineCheckbox = r.appendChild(new m(d("ui.social.displayOfflineGuildMembers"), {
    defaultValue: s
  }));
  var l = r.appendChild(new m(d("ui.social.warnWhenGuildMembersComeOnline"), {
    defaultValue: i
  }));
  this.averageLevel = r.createChild("div", {
    className: "averageLevel"
  });
  this.showOfflineCheckbox.on("change", function (t) {
    e.table.filter();
    y.setValue("showGuildMembersOffline", t);
  });
  l.on("change", function (e) {
    window.dofus.sendMessage("GuildMemberSetWarnOnConnectionMessage", {
      enable: e
    });
    window.gui.playerData.guild.current.warnMemberOnConnectionState = e;
  });
};
s.prototype._setupSocketEvents = function () {
  var e = this;
  window.gui.playerData.guild.on("guildMember", function (t) {
    e.isVisible() && e._updateMembersList(t);
  });
  window.gui.playerData.guild.on("guildMemberStatusUpdate", function (t) {
    if (e.isVisible()) {
      var i = e.table.getCell(t.id, "playerIcon"),
        n = i.getChild("onlineStatusIcon");
      n.setClassNames("onlineStatusIcon", "status" + t.status.statusId);
    }
  });
};
s.prototype._updateMembersList = function (e) {
  function t() {
    p.open("guildMemberRights", this.memberInfo);
  }
  function i() {
    var e = this.memberInfo.id,
      t = 1 === Object.keys(s.members).length;
    if (e === s.leaderId && !t) {
      return window.gui.openSimplePopup(d("ui.social.guildBossCantBeBann"), d("ui.popup.warning"));
    }
    var i = l === e ? d("ui.social.doUDeleteYou") : d("ui.social.doUDeleteMember", this.memberInfo.name);
    window.gui.openConfirmPopup({
      title: d("ui.popup.warning"),
      message: i,
      cb: function (t) {
        t && window.dofus.sendMessage("GuildKickRequestMessage", {
          kickedId: e
        });
      }
    });
  }
  function n() {
    this.connected ? window.gui.openContextualMenu("player", {
      playerId: this.id,
      accountId: this.accountId,
      playerName: this.name,
      guildId: window.gui.playerData.guild.current.guildId
    }) : window.gui.openContextualMenu("offlinePlayer", {
      playerId: this.id,
      playerName: this.name,
      hoursSinceLastConnection: this.hoursSinceLastConnection
    });
  }
  function o(e, t) {
    c.getSmallWingsUrl(t, function (t) {
      e.rootElement && e.setStyle("backgroundImage", t);
    });
  }
  var a = window.gui.playerData.guild,
    s = a.current,
    l = window.gui.playerData.id,
    c = window.gui.playerData.alignment,
    m = l === s.leaderId,
    f = [],
    y = [],
    M = [],
    T = [];
  this.table.clearContent();
  this.averageLevel.setText(d("ui.social.guildAvgMembersLevel") + ": " + s.averageMemberLevel);
  for (var C = m || a.hasRight(g.GUILD_RIGHT_BOSS) || a.hasRight(g.GUILD_RIGHT_MANAGE_GUILD_BOOSTS) || a.hasRight(g.GUILD_RIGHT_MANAGE_RIGHTS) || a.hasRight(g.GUILD_RIGHT_MANAGE_XP_CONTRIBUTION) || a.hasRight(g.GUILD_RIGHT_MANAGE_RANKS), I = a.checkRight(g.GUILD_RIGHT_BOSS, s.members[l].rights), A = window.gui.databases.RankNames, S = 0, E = e.length; S < E; S++) {
    var N = e[S],
      x = w[N.connected],
      L = new r("div", {
        className: "buttons"
      }),
      O = l === e[S].id;
    (O || C || I) && (L.appendChild(new h({
      className: ["boxSizing", "rowButton", "rights"]
    }, t)).memberInfo = {
      id: N.id,
      name: N.name,
      level: N.level,
      rank: N.rank,
      sex: N.sex,
      experienceGivenPercent: N.experienceGivenPercent,
      rights: N.rights
    });
    (O || m || I || a.hasRight(g.GUILD_RIGHT_BAN_MEMBERS)) && (L.appendChild(new h({
      className: ["boxSizing", "rowButton", "deletion"]
    }, i)).memberInfo = {
      id: N.id,
      name: N.name
    });
    var R = new h({
      className: "playerIcon",
      scaleOnPress: !1
    }, n);
    R.createChild("div", {
      name: "onlineStatusIcon",
      className: ["onlineStatusIcon", "status" + N.status.statusId]
    });
    var D = R.createChild("div", {
      className: "alignmentSide"
    });
    N.alignmentSide !== v.ALIGNMENT_ANGEL && N.alignmentSide !== v.ALIGNMENT_EVIL || o(D, N.alignmentSide);
    f.push(D.createChild("div", {
      className: "playerHead"
    }));
    y.push("gfx/heads/SmallHead_" + N.breed + (N.sex ? 1 : 0) + ".png");
    R.id = N.id;
    R.name = N.name;
    R.accountId = N.accountId;
    R.isMySelf = O;
    R.connected = N.connected;
    R.hoursSinceLastConnection = N.hoursSinceLastConnection;
    var P = new h({
      className: "nameButton",
      text: N.name,
      scaleOnPress: !1
    }, n);
    P.id = N.id;
    P.name = N.name;
    P.accountId = N.accountId;
    P.isMySelf = O;
    P.connected = N.connected;
    P.hoursSinceLastConnection = N.hoursSinceLastConnection;
    var B = u(A[N.rank].nameId, N.sex ? 1 : 0),
      k = {
        playerIcon: R,
        nameButton: P,
        name: N.name,
        rankName: B,
        rankValue: N.rank,
        level: N.level,
        xpPercentage: N.experienceGivenPercent + "%",
        xp: N.givenExperience,
        achievement: N.achievementPoints,
        buttons: L,
        onlineStatus: x,
        hoursSinceLastConnection: "offline" === x ? N.hoursSinceLastConnection : -1
      };
    if ("offline" === x) {
      if (N.hoursSinceLastConnection >= b) {
        var F = d("ui.common.inactive") + "<br/>",
          H = Math.floor(N.hoursSinceLastConnection / b);
        F += d("ui.social.monthsSinceLastConnection", H, H);
        k.stateIcon = new r("div", {
          className: ["text"]
        });
        k.stateIcon.setHtml(F);
      } else {
        k.stateIcon = new r("div", {
          className: ["stateIcon", "offline"]
        });
      }
    } else if (N.hasOwnProperty("moodSmileyId") && N.moodSmileyId > 0) {
      var z = N.moodSmileyId,
        W = window.gui.databases.Smileys[z];
      W ? (k.stateIcon = new r("div", {
        className: ["stateIcon", "smiley"]
      }), M.push(k.stateIcon), T.push("gfx/smilies/" + W.gfxId + ".png")) : console.error("Smiley " + z + " details are not available, it could not be displayed");
    }
    this.table.addRow(k, N.id).addClassNames(x);
  }
  this.table.filter();
  _.preloadImages(y, function (e) {
    for (var t = 0, i = e.length; t < i; t++) {
      var n = f[t];
      n && n.rootElement && n.setStyle("backgroundImage", e[t]);
    }
  });
  T.length && _.preloadImages(T, function (e) {
    if (e.length !== M.length) {
      return console.error("Number of smileys preloaded does not match number of state icons");
    }
    for (var t = 0; t < e.length; t++) {
      var i = M[t];
      i && i.rootElement && i.setStyle("backgroundImage", e[t]);
    }
  });
};
this.table = this.appendChild(new c(t, null, {
  clickable: !1
}));
this.table.addFilter(function (t) {
  return !!e.showOfflineCheckbox.isActivate() || "online" === t.onlineStatus;
});
this.averageLevel = r.createChild("div", {
  className: "averageLevel"
});
this.showOfflineCheckbox.on("change", function (t) {
  e.table.filter();
  y.setValue("showGuildMembersOffline", t);
});
l.on("change", function (e) {
  window.dofus.sendMessage("GuildMemberSetWarnOnConnectionMessage", {
    enable: e
  });
  window.gui.playerData.guild.current.warnMemberOnConnectionState = e;
});
e.table.filter();
y.setValue("showGuildMembersOffline", t);
window.dofus.sendMessage("GuildMemberSetWarnOnConnectionMessage", {
  enable: e
});
window.gui.playerData.guild.current.warnMemberOnConnectionState = e;
window.gui.playerData.guild.on("guildMember", function (t) {
  e.isVisible() && e._updateMembersList(t);
});
window.gui.playerData.guild.on("guildMemberStatusUpdate", function (t) {
  if (e.isVisible()) {
    var i = e.table.getCell(t.id, "playerIcon"),
      n = i.getChild("onlineStatusIcon");
    n.setClassNames("onlineStatusIcon", "status" + t.status.statusId);
  }
});
this.table.clearContent();
this.averageLevel.setText(d("ui.social.guildAvgMembersLevel") + ": " + s.averageMemberLevel);
(O || C || I) && (L.appendChild(new h({
  className: ["boxSizing", "rowButton", "rights"]
}, t)).memberInfo = {
  id: N.id,
  name: N.name,
  level: N.level,
  rank: N.rank,
  sex: N.sex,
  experienceGivenPercent: N.experienceGivenPercent,
  rights: N.rights
});
(O || m || I || a.hasRight(g.GUILD_RIGHT_BAN_MEMBERS)) && (L.appendChild(new h({
  className: ["boxSizing", "rowButton", "deletion"]
}, i)).memberInfo = {
  id: N.id,
  name: N.name
});
N.alignmentSide !== v.ALIGNMENT_ANGEL && N.alignmentSide !== v.ALIGNMENT_EVIL || o(D, N.alignmentSide);
f.push(D.createChild("div", {
  className: "playerHead"
}));
y.push("gfx/heads/SmallHead_" + N.breed + (N.sex ? 1 : 0) + ".png");
R.id = N.id;
R.name = N.name;
R.accountId = N.accountId;
R.isMySelf = O;
R.connected = N.connected;
R.hoursSinceLastConnection = N.hoursSinceLastConnection;
P.id = N.id;
P.name = N.name;
P.accountId = N.accountId;
P.isMySelf = O;
P.connected = N.connected;
P.hoursSinceLastConnection = N.hoursSinceLastConnection;
F += d("ui.social.monthsSinceLastConnection", H, H);
k.stateIcon = new r("div", {
  className: ["text"]
});
k.stateIcon.setHtml(F);
this.table.filter();
_.preloadImages(y, function (e) {
  for (var t = 0, i = e.length; t < i; t++) {
    var n = f[t];
    n && n.rootElement && n.setStyle("backgroundImage", e[t]);
  }
});
T.length && _.preloadImages(T, function (e) {
  if (e.length !== M.length) {
    return console.error("Number of smileys preloaded does not match number of state icons");
  }
  for (var t = 0; t < e.length; t++) {
    var i = M[t];
    i && i.rootElement && i.setStyle("backgroundImage", e[t]);
  }
});
e = e || {};
a.call(this, "div", {
  className: "GuildHousesWindow"
});
this.addClassNames(e.className);
this.currentSelectedHouseId = null;
this.once("open", function () {
  t._createDom();
});
this.on("open", function () {
  t._resetAll();
  t.addClassNames("spinner");
});
t._resetAll();
t.addClassNames("spinner");
o(n, a);
e.exports = n;
n.prototype._createDom = function () {
  var e = this,
    t = {
      colIds: ["houseName", "coordinate", "owner", "detail"],
      headerContent: [l("ui.common.houseWord"), l("ui.common.coordinatesSmall"), l("ui.common.ownerWord")],
      highlightable: !0,
      onRowTap: function (t) {
        e.currentSelectedHouseId = t.houseId;
      }
    };
  this.table = this.appendChild(new c(t));
  var i = this.createChild("div", {
    className: "buttonContainer"
  });
  this.joinButton = i.appendChild(new r(l("ui.common.join"), {
    className: "joinButton"
  }));
  this.joinButton.on("tap", function () {
    window.dofus.sendMessage("GuildHouseTeleportRequestMessage", {
      houseId: e.currentSelectedHouseId
    });
    d.close("social");
  });
  this.joinButton.disable();
  this._setupSocketEvents();
};
n.prototype._setupSocketEvents = function () {
  var e = this,
    t = window.gui.playerData.guild;
  t.on("guildHouseUpdateAll", function () {
    e.isVisible() && (e.delClassNames("spinner"), e._updateHouses(), e._updateJoinButton());
  });
  t.on("guildHouseUpdateInfo", function (t) {
    e.isVisible() && (e._updateHouse(t), e._updateJoinButton());
  });
  t.on("guildHouseRemoved", function (t) {
    e.isVisible() && (e._removeHouse(t), e._updateJoinButton());
  });
};
n.prototype._createHouseInfoButton = function (e) {
  var t = this,
    i = new r("?", {
      name: "button"
    });
  return i.on("tap", function () {
    var i = t._getHouseListRowIndexByHouseId(e.houseId);
    t.table.highlight(i);
    d.open("guildHouseInfo", {
      guildshareParams: e.guildshareParams,
      skillListIds: e.skillListIds
    });
  }), i;
};
n.prototype._resetAll = function () {
  this.currentSelectedHouseId = null;
  this.table.clearContent();
  this.joinButton.disable();
};
n.prototype._createHouseListRow = function (e) {
  var t = e.enrichData || {};
  return {
    houseName: t.houseName,
    coordinate: e.worldX + "," + e.worldY,
    owner: e.ownerName,
    detail: this._createHouseInfoButton(e)
  };
};
n.prototype._getHouseListRowIndexByHouseId = function (e) {
  for (var t = this.table.getRows(), i = 0; i < t.length; i += 1) {
    var n = t[i].houseId || {};
    if (e === n) {
      return i;
    }
  }
};
n.prototype._updateJoinButton = function () {
  var e = window.gui.playerData.guild.current.houses || [];
  e.length ? this.joinButton.enable() : this.joinButton.disable();
};
n.prototype._updateHouses = function () {
  var e = window.gui.playerData.guild.current.houses || [];
  this._resetAll();
  for (var t = 0; t < e.length; t += 1) {
    this._addHouse(e[t]);
  }
};
n.prototype._addHouse = function (e) {
  var t = this._createHouseListRow(e),
    i = this.table.addRow(t, {
      houseId: e.houseId
    });
  this._addHouseRowToolTip(i, e);
};
n.prototype._removeHouse = function (e) {
  var t = this._getHouseListRowIndexByHouseId(e);
  t >= 0 && this.table.delRow(t);
};
n.prototype._updateHouse = function (e) {
  var t = e.houseId,
    i = this._getHouseListRowIndexByHouseId(t);
  if (i >= 0) {
    var n = this._createHouseListRow(e);
    this.table.updateRow(i, n, {
      houseId: t
    });
  } else {
    this._addHouse(e);
  }
};
n.prototype._addHouseRowToolTip = function (e, t) {
  var i = t.enrichData,
    n = i.areaName + " (" + i.subAreaName + ")";
  s(e, n);
};
this.joinButton = i.appendChild(new r(l("ui.common.join"), {
  className: "joinButton"
}));
this.joinButton.on("tap", function () {
  window.dofus.sendMessage("GuildHouseTeleportRequestMessage", {
    houseId: e.currentSelectedHouseId
  });
  d.close("social");
});
this.joinButton.disable();
this._setupSocketEvents();
window.dofus.sendMessage("GuildHouseTeleportRequestMessage", {
  houseId: e.currentSelectedHouseId
});
d.close("social");
t.on("guildHouseUpdateAll", function () {
  e.isVisible() && (e.delClassNames("spinner"), e._updateHouses(), e._updateJoinButton());
});
t.on("guildHouseUpdateInfo", function (t) {
  e.isVisible() && (e._updateHouse(t), e._updateJoinButton());
});
t.on("guildHouseRemoved", function (t) {
  e.isVisible() && (e._removeHouse(t), e._updateJoinButton());
});
t.table.highlight(i);
d.open("guildHouseInfo", {
  guildshareParams: e.guildshareParams,
  skillListIds: e.skillListIds
});
this.currentSelectedHouseId = null;
this.table.clearContent();
this.joinButton.disable();
s.call(this, "div", {
  className: "GuildCustomizationPanel"
});
this._isActive = !1;
this.on("open", function () {
  this._isActive || (this._isActive = !0, this._setupDom());
});
this.on("close", this._onClose);
a(n, s);
e.exports = n;
n.prototype._onClose = function () {
  this.clearContent();
  this.motd = null;
  this.privateMsg = null;
  this.publicMsg = null;
  this._isActive = !1;
};
n.prototype._setupDom = function () {
  var e = this.createChild("div", {
      className: "contentDiv"
    }),
    t = e.createChild("div", {
      className: "publicDiv"
    }),
    i = e.createChild("div", {
      className: "privateDiv"
    });
  t.createChild("div", {
    className: "image"
  });
  this.publicMsg = new l(t, "publicMsg", r.SOCIAL_INFO_GUILD_PUBLIC_MSG, o("tablet.social.publicMsg"), o("tablet.social.publicMsgHelp"));
  this.motd = new l(i, "motd", r.SOCIAL_INFO_GUILD_MOTD, o("tablet.social.motd"), o("tablet.social.motdHelp"));
  this.privateMsg = new l(i, "privateMsg", r.SOCIAL_INFO_GUILD_PRIVATE_MSG, o("tablet.social.privateMsg"), o("tablet.social.privateMsgHelp"));
};
this.clearContent();
this.motd = null;
this.privateMsg = null;
this.publicMsg = null;
this._isActive = !1;
t.createChild("div", {
  className: "image"
});
this.publicMsg = new l(t, "publicMsg", r.SOCIAL_INFO_GUILD_PUBLIC_MSG, o("tablet.social.publicMsg"), o("tablet.social.publicMsgHelp"));
this.motd = new l(i, "motd", r.SOCIAL_INFO_GUILD_MOTD, o("tablet.social.motd"), o("tablet.social.motdHelp"));
this.privateMsg = new l(i, "privateMsg", r.SOCIAL_INFO_GUILD_PRIVATE_MSG, o("tablet.social.privateMsg"), o("tablet.social.privateMsgHelp"));
this._infoType = i;
this._label = n;
this._helpText = o;
this._iAmThePopup = t === T;
this._mustEditInPopup = M && !this._iAmThePopup;
this._maxLength = d ? h.MAX_SOCIALINFO_SHORT_LEN : h.MAX_SOCIALINFO_LEN;
this._setupDom(e, t, a);
this._listener = new c();
this._setupEvents();
e.on("destroy", this._onDestroy.bind(this));
e.exports = n;
n.prototype._onDestroy = function () {
  this._listener.stopListening();
};
n.prototype._setupDom = function (e, t, i) {
  var n = this,
    o = e.createChild("div", {
      className: ["socialInfoEditor", t]
    }),
    l = o.createChild("div", {
      className: "headerDiv"
    });
  this._iAmThePopup && l.hide();
  var c = l.createChild("div", {
    className: "btnAndTitle"
  });
  this._editBtn = c.appendChild(new s({
    className: ["editBtn", "greenButton"],
    addIcon: !0,
    tooltip: r("ui.common.modify"),
    hidden: !0
  }, this._editButtonTapHandler.bind(this)));
  i && this._editBtn.show();
  var d = c.createChild("div", {
    className: "labelAndLastChange"
  });
  d.createChild("div", {
    className: "label",
    text: this._label
  });
  this._lastChangeDiv = d.createChild("div", {
    className: "lastChangeDiv",
    hidden: !0
  });
  var h = o.createChild("div", {
    className: "editionDiv"
  });
  a(h, this._helpText);
  this._characterCounter = h.createChild("div", {
    className: "characterCount",
    hidden: !0
  });
  this._textScroller = h.appendChild(new p({
    className: "textDiv"
  }, {
    showHintArrows: !0
  }));
  this._textDiv = this._textScroller.content;
  this._placeholder = new u(h, {
    noHeight: !0
  });
  this._editDiv = h.createChild("textarea", {
    className: "editDiv",
    hidden: !0
  });
  this._editDiv.rootElement.addEventListener("input", this._editDivChangeHandler.bind(this));
  h.rootElement.addEventListener("touchend", function (e) {
    e.stopImmediatePropagation();
    n._editDiv.rootElement.dispatchEvent(new Event("touchend"));
  });
  var m = this._editingBtnDiv = o.createChild("div", {
    className: "editingBtnDiv",
    hidden: !0
  });
  this._submitButton = m.appendChild(new s({
    className: ["submitBtn", "greenButton"],
    text: r("ui.common.save")
  }, this._submitButtonTapHandler.bind(this)));
  this._submitButton.disable();
  this._cancelButton = m.appendChild(new s({
    className: ["cancelBtn", "secondaryButton", "greenButton"],
    text: r("ui.common.cancel")
  }, this._cancelButtonTapHandler.bind(this)));
  this._iAmThePopup && m.show();
};
n.prototype._setupEvents = function () {
  var e = window.gui.playerData.guildData,
    t = window.dofus.connectionManager,
    i = this;
  e.requestSocialInfo(this._infoType);
  this._listener.listenTo(e, "socialInfoUpdated", function (e, t) {
    e === i._infoType && i._onInfoUpdateFromServer(t);
  });
  this._listener.listenTo(t, "SocialInfoEditingRequestReplyMessage", function (e) {
    e.infoType === i._infoType && i._editRequestReplyHandler(e.result, e.editorCharacterId);
  });
};
n.prototype._editButtonTapHandler = function () {
  window.dofus.sendMessage("SocialInfoEditingRequestMessage", {
    infoType: this._infoType
  });
};
n.prototype._editRequestReplyHandler = function (e, t) {
  e ? this._startEditing() : d.showNotification(r("tablet.lockedBy", o(t)), this._editBtn);
};
n.prototype._onInfoUpdateFromServer = function (e) {
  this._updateInfo(e);
  this._iAmThePopup && this._startEditing();
};
n.prototype._startEditing = function () {
  if (this._mustEditInPopup) {
    var e = g.getPanel(C, 1);
    if (e) {
      return;
    }
    var t = new _("div", {
        className: "socialInfoPanelParent"
      }),
      i = new n(t, T, this._infoType, "", this._helpText);
    return e = g.createPanel(C, t, {
      title: this._label,
      top: 10,
      width: "60%",
      height: "40%",
      isModal: !0,
      noCloseButton: !0
    }), void (i._parentEditor = this);
  }
  this._lastChangeDiv.hide();
  this._textScroller.hide();
  this._placeholder.toggleDisplay(!1);
  this._editBtn.hide();
  this._editingBtnDiv.show();
  this._editDiv.show();
  var o = this._editDiv.rootElement;
  o.value = this._originalText;
  o.selectionStart = o.selectionEnd = this._originalText.length;
  o.scrollTop = o.scrollHeight;
  this._characterCounter.show();
  this._editDivChangeHandler();
  o.focus();
};
n.prototype._finishEditing = function (e) {
  if (this._submitButton.disable(), this._cancelButton.disable(), this._iAmThePopup) {
    return this._listener.stopListening(), g.close(g.getPanel(C, 1).id), this._parentEditor._finishEditing(e);
  }
  if (void 0 !== e) {
    var t = window.gui.playerData.id;
    this._updateInfo({
      timestamp: Date.now(),
      editorId: t,
      value: e
    });
  }
  this._lastChangeDiv.toggleDisplay(!!this._lastChangeDiv.getText());
  this._editDiv.hide();
  this._characterCounter.hide();
  var i = !!this._textDiv.getText();
  this._textScroller.toggleDisplay(i);
  this._editBtn.show();
  this._editingBtnDiv.hide();
  document.activeElement.blur();
};
n.prototype._cancelButtonTapHandler = function () {
  this._finishEditing();
  window.dofus.sendMessage("SocialInfoEditingCancelMessage", {
    infoType: this._infoType
  });
};
n.prototype._submitButtonTapHandler = function () {
  var e = this._editDiv.rootElement.value.trimRight();
  if (e === this._originalText) {
    return this._cancelButtonTapHandler();
  }
  var t = v.getUnsendableCharacters(e, I);
  if (t.length) {
    var i = t[0] + " (" + t[0].codePointAt().toString(16) + ")";
    return window.gui.openPopup({
      title: r("ui.common.error"),
      message: r("tablet.chat.unsendableChars", i)
    });
  }
  e = v.encode(e, I);
  window.dofus.sendMessage("SocialInfoEditingCommitMessage", {
    infoType: this._infoType,
    content: e
  });
  this._finishEditing(e);
};
n.prototype._editDivChangeHandler = function () {
  var e = v.encode(this._editDiv.rootElement.value, I),
    t = this._maxLength - e.length;
  this._characterCounter.setText(t);
  this._characterCounter.toggleClassName("tooLong", t < 0);
  this._submitButton.setEnable(t >= 0);
};
n.prototype._updateInfo = function (e) {
  if (this._setTextContent(e.value), e.editorId && e.timestamp) {
    var t = Math.max(Math.round((Date.now() - e.timestamp) / 1e3), 1);
    this._lastChangeDiv.setText(r("tablet.lastChangeBy", l.durationToHuman(t), o(e.editorId)));
    this._lastChangeDiv.show();
  } else {
    this._lastChangeDiv.hide();
  }
};
n.prototype._setTextContent = function (e) {
  var t = v.decode(e, I);
  this._originalText = t;
  this._textDiv.setText(t);
  this._textScroller.toggleDisplay(!!t);
  t && this._textScroller.refresh();
  this._placeholder.toggleDisplay(!t);
  t || this._placeholder.setText(this._helpText);
};
this._editBtn = c.appendChild(new s({
  className: ["editBtn", "greenButton"],
  addIcon: !0,
  tooltip: r("ui.common.modify"),
  hidden: !0
}, this._editButtonTapHandler.bind(this)));
i && this._editBtn.show();
d.createChild("div", {
  className: "label",
  text: this._label
});
this._lastChangeDiv = d.createChild("div", {
  className: "lastChangeDiv",
  hidden: !0
});
a(h, this._helpText);
this._characterCounter = h.createChild("div", {
  className: "characterCount",
  hidden: !0
});
this._textScroller = h.appendChild(new p({
  className: "textDiv"
}, {
  showHintArrows: !0
}));
this._textDiv = this._textScroller.content;
this._placeholder = new u(h, {
  noHeight: !0
});
this._editDiv = h.createChild("textarea", {
  className: "editDiv",
  hidden: !0
});
this._editDiv.rootElement.addEventListener("input", this._editDivChangeHandler.bind(this));
h.rootElement.addEventListener("touchend", function (e) {
  e.stopImmediatePropagation();
  n._editDiv.rootElement.dispatchEvent(new Event("touchend"));
});
e.stopImmediatePropagation();
n._editDiv.rootElement.dispatchEvent(new Event("touchend"));
this._submitButton = m.appendChild(new s({
  className: ["submitBtn", "greenButton"],
  text: r("ui.common.save")
}, this._submitButtonTapHandler.bind(this)));
this._submitButton.disable();
this._cancelButton = m.appendChild(new s({
  className: ["cancelBtn", "secondaryButton", "greenButton"],
  text: r("ui.common.cancel")
}, this._cancelButtonTapHandler.bind(this)));
this._iAmThePopup && m.show();
e.requestSocialInfo(this._infoType);
this._listener.listenTo(e, "socialInfoUpdated", function (e, t) {
  e === i._infoType && i._onInfoUpdateFromServer(t);
});
this._listener.listenTo(t, "SocialInfoEditingRequestReplyMessage", function (e) {
  e.infoType === i._infoType && i._editRequestReplyHandler(e.result, e.editorCharacterId);
});
this._updateInfo(e);
this._iAmThePopup && this._startEditing();
this._lastChangeDiv.hide();
this._textScroller.hide();
this._placeholder.toggleDisplay(!1);
this._editBtn.hide();
this._editingBtnDiv.show();
this._editDiv.show();
o.value = this._originalText;
o.selectionStart = o.selectionEnd = this._originalText.length;
o.scrollTop = o.scrollHeight;
this._characterCounter.show();
this._editDivChangeHandler();
o.focus();
this._lastChangeDiv.toggleDisplay(!!this._lastChangeDiv.getText());
this._editDiv.hide();
this._characterCounter.hide();
this._textScroller.toggleDisplay(i);
this._editBtn.show();
this._editingBtnDiv.hide();
document.activeElement.blur();
this._finishEditing();
window.dofus.sendMessage("SocialInfoEditingCancelMessage", {
  infoType: this._infoType
});
e = v.encode(e, I);
window.dofus.sendMessage("SocialInfoEditingCommitMessage", {
  infoType: this._infoType,
  content: e
});
this._finishEditing(e);
this._characterCounter.setText(t);
this._characterCounter.toggleClassName("tooLong", t < 0);
this._submitButton.setEnable(t >= 0);
this._lastChangeDiv.setText(r("tablet.lastChangeBy", l.durationToHuman(t), o(e.editorId)));
this._lastChangeDiv.show();
this._originalText = t;
this._textDiv.setText(t);
this._textScroller.toggleDisplay(!!t);
t && this._textScroller.refresh();
this._placeholder.toggleDisplay(!t);
t || this._placeholder.setText(this._helpText);
e = e || {};
s.call(this, "div", {
  className: "GuildPaddocksWindow"
});
this.addClassNames(e.className);
this.selectedPaddock = null;
this.once("open", function () {
  this._createDom();
  this._setupEvents();
});
this.on("open", function () {
  this._resetAll();
  this.locationTable.addClassNames("spinner");
});
this._createDom();
this._setupEvents();
this._resetAll();
this.locationTable.addClassNames("spinner");
o(n, s);
e.exports = n;
n.prototype._setupEvents = function () {
  var e = window.gui.playerData.guild,
    t = this;
  e.on("guildPaddockUpdate", function () {
    t.isVisible() && (t.locationTable.delClassNames("spinner"), t._updatePaddocks(), t._updateJoinButton());
  });
  e.on("guildPaddockBought", function (e) {
    t.isVisible() && (t._addPaddock(e), t._updateJoinButton());
  });
  e.on("guildPaddockRemoved", function (e) {
    t.isVisible() && (t._removePaddock(e), t._updateJoinButton());
  });
};
n.prototype._createDom = function () {
  var e = this;
  this.locationTable = this.appendChild(new c({
    className: "locationTable",
    headerContent: [l("ui.common.localisation")],
    colIds: ["location", "abandoned"],
    highlightable: !0,
    onRowTap: function (t) {
      e._updatePaddockDetails(t);
    }
  }));
  var t = this.createChild("div", {
      className: "rightColumn"
    }),
    i = t.createChild("div", {
      className: "infos"
    }),
    n = i.createChild("div", {
      className: "image"
    }),
    o = i.createChild("div", {
      className: "details"
    });
  this.paddockName = o.createChild("div", {
    className: "name"
  });
  o.createChild("div", {
    className: ["text", "clear"],
    text: l("ui.common.objects")
  });
  this.maxItems = o.createChild("div", {
    className: ["text", "right"],
    text: "-"
  });
  o.createChild("div", {
    className: ["text", "clear"],
    text: l("ui.common.mounts")
  });
  this.maxMounts = o.createChild("div", {
    className: ["text", "right"],
    text: "-"
  });
  this.joinButton = new a({
    className: ["button", "clear"],
    text: l("ui.common.join")
  }, function () {
    e.selectedPaddock && e.selectedPaddock.paddockId && (window.dofus.sendMessage("GuildPaddockTeleportRequestMessage", {
      paddockId: e.selectedPaddock.paddockId
    }), d.close("social"));
  });
  o.appendChild(this.joinButton);
  this.mountTable = t.appendChild(new c({
    className: "mountTable",
    headerContent: [l("ui.common.mountType"), l("ui.common.ownerWord")],
    colIds: ["mount", "owner"]
  }));
  u.preloadImage("gfx/illusUi/IllusDinde.png", function (e) {
    n.setStyle("backgroundImage", e);
  });
};
n.prototype._updatePaddockDetails = function (e) {
  var t = this.selectedPaddock = e.paddock,
    i = t.enrichData || {};
  this.paddockName.setText(l("ui.common.mountPark") + " - " + i.subAreaName);
  this.maxItems.setText(t.maxItems + " " + l("ui.common.maxWord"));
  var n = t.mountsInformations,
    o = n.length;
  if (this.maxMounts.setText(o + " / " + t.maxOutdoorMount), this.mountTable.clearContent(), o) {
    for (var a = 0; a < o; a += 1) {
      var s = n[a],
        c = s.enrichData || {},
        d = this.mountTable.addRow({
          mount: c.mountType,
          owner: s.ownerName
        }),
        u = s.name || l("ui.common.noName");
      r(d, u);
    }
  }
};
n.prototype._createLocationTableRow = function (e) {
  var t,
    i = new s("div", {
      className: "locationInfo"
    }),
    n = i.createChild("div");
  e.abandonned && (t = i.createChild("div", {
    className: "abandonedIcon"
  }), r(t, l("ui.social.paddockWithNoOwner")));
  var o = e.enrichData || {},
    a = isNaN(e.worldX) ? o.worldX : e.worldX,
    c = isNaN(e.worldY) ? o.worldY : e.worldY,
    d = "(" + a + ", " + c + ")";
  return n.setText(o.areaName + " (" + o.subAreaName + ") " + d), {
    location: n,
    abandoned: t || ""
  };
};
n.prototype._updateJoinButton = function () {
  var e = window.gui.playerData.guild.current.paddocks || [];
  e.length ? this.joinButton.enable() : this.joinButton.disable();
};
n.prototype._updatePaddocks = function () {
  var e = window.gui.playerData.guild.current.paddocks || [];
  this._resetAll();
  for (var t = 0; t < e.length; t += 1) {
    this._addPaddock(e[t]);
  }
};
n.prototype._addPaddock = function (e) {
  var t = this._createLocationTableRow(e);
  this.locationTable.addRow(t, {
    paddock: e
  });
};
n.prototype._removePaddock = function (e) {
  for (var t = this.locationTable.getRows(), i = 0; i < t.length; i += 1) {
    var n = t[i];
    if (n.paddock.paddockId === e) {
      this.locationTable.delRow(i);
      break;
    }
  }
};
n.prototype._resetAll = function () {
  this.locationTable.clearContent();
  this.mountTable.clearContent();
  this.joinButton.disable();
  this.paddockName.setText("");
  this.maxItems.setText("-");
  this.maxMounts.setText("-");
};
e.on("guildPaddockUpdate", function () {
  t.isVisible() && (t.locationTable.delClassNames("spinner"), t._updatePaddocks(), t._updateJoinButton());
});
e.on("guildPaddockBought", function (e) {
  t.isVisible() && (t._addPaddock(e), t._updateJoinButton());
});
e.on("guildPaddockRemoved", function (e) {
  t.isVisible() && (t._removePaddock(e), t._updateJoinButton());
});
this.paddockName = o.createChild("div", {
  className: "name"
});
o.createChild("div", {
  className: ["text", "clear"],
  text: l("ui.common.objects")
});
this.maxItems = o.createChild("div", {
  className: ["text", "right"],
  text: "-"
});
o.createChild("div", {
  className: ["text", "clear"],
  text: l("ui.common.mounts")
});
this.maxMounts = o.createChild("div", {
  className: ["text", "right"],
  text: "-"
});
this.joinButton = new a({
  className: ["button", "clear"],
  text: l("ui.common.join")
}, function () {
  e.selectedPaddock && e.selectedPaddock.paddockId && (window.dofus.sendMessage("GuildPaddockTeleportRequestMessage", {
    paddockId: e.selectedPaddock.paddockId
  }), d.close("social"));
});
o.appendChild(this.joinButton);
this.mountTable = t.appendChild(new c({
  className: "mountTable",
  headerContent: [l("ui.common.mountType"), l("ui.common.ownerWord")],
  colIds: ["mount", "owner"]
}));
u.preloadImage("gfx/illusUi/IllusDinde.png", function (e) {
  n.setStyle("backgroundImage", e);
});
this.paddockName.setText(l("ui.common.mountPark") + " - " + i.subAreaName);
this.maxItems.setText(t.maxItems + " " + l("ui.common.maxWord"));
this.locationTable.clearContent();
this.mountTable.clearContent();
this.joinButton.disable();
this.paddockName.setText("");
this.maxItems.setText("-");
this.maxMounts.setText("-");
r.call(this, "div", {
  className: "GuildPerceptorsWindow"
});
this.taxCollectorRows = {};
this.once("open", function () {
  this._createDom();
  this._setupEvents();
});
this.on("open", function () {
  this.table.addClassNames("spinner");
  window.dofus.sendMessage("GuildGetInformationsMessage", {
    infoType: d.INFO_TAX_COLLECTOR_GUILD_ONLY
  });
});
this.on("close", function () {
  this._clearAllFightStartTimers();
  window.dofus.sendMessage("GuildGetInformationsMessage", {
    infoType: d.INFO_TAX_COLLECTOR_LEAVE
  });
});
this._createDom();
this._setupEvents();
this.table.addClassNames("spinner");
window.dofus.sendMessage("GuildGetInformationsMessage", {
  infoType: d.INFO_TAX_COLLECTOR_GUILD_ONLY
});
this._clearAllFightStartTimers();
window.dofus.sendMessage("GuildGetInformationsMessage", {
  infoType: d.INFO_TAX_COLLECTOR_LEAVE
});
s(n, r);
e.exports = n;
n.prototype._createDom = function () {
  var e = this.createChild("div", {
    className: "tableContainer"
  });
  this.table = e.appendChild(new f({
    headerContent: ["", c("ui.common.name") + " / " + c("ui.common.localisation"), "", c("ui.common.defenders") + " / " + c("ui.common.attackers")],
    colIds: ["fightState", "taxCollectorInfo", "timer", "fightersInfo"]
  }));
  var t = this.createChild("div", {
      className: "bottomDiv"
    }),
    i = t.createChild("div", {
      className: "leftPart"
    }),
    n = t.createChild("div", {
      className: "rightPart"
    });
  i.appendChild(new a({
    text: c("ui.social.guildBoosts"),
    className: ["boostPanelBtn", "greenButton"]
  }, this._openBoostPanel.bind(this)));
  this.perceptorAmountText = n.createChild("div", {
    className: "rightAlignText"
  });
  this._setPerceptorsAmount(0, 0);
  n.createChild("div", {
    className: "rightAlignText",
    text: c("ui.social.guildHowDefendTax")
  });
};
n.prototype._setupEvents = function () {
  function e(e) {
    return i.taxCollectorRows[e] && i.taxCollectorRows[e].fightersInfo;
  }
  function t(e) {
    return i.taxCollectorRows[e] && i.taxCollectorRows[e].timer;
  }
  var i = this,
    n = 0;
  g.on("taxCollectorList", function (e, t, o) {
    if (i.isVisible() && e === y.taxCollector) {
      i.table.delClassNames("spinner");
      i._resetAll();
      for (var a = 0, s = t.length; a < s; a += 1) {
        i._addTaxCollector(t[a]);
      }
      n = o;
      i._setPerceptorsAmount(t.length, o);
    }
  });
  g.on("entityAdded", function (e, t) {
    i.isVisible() && e === y.taxCollector && (i._addTaxCollector(t), i._setPerceptorsAmount(i.table.getRowCount(), n));
  });
  g.on("entityRemoved", function (e, t) {
    i.isVisible() && e === y.taxCollector && (i._removeTaxCollector(t), i._setPerceptorsAmount(i.table.getRowCount(), n));
  });
  g.on("fightStarted", function (n, o) {
    if (i.isVisible() && n === y.taxCollector) {
      var a = e(o.id);
      if (a) {
        var s = g.entities[n][o.id],
          r = s.enrichData || {};
        a.setFight(n, o);
        a.setTarget({
          id: o.id,
          entityLook: s.look,
          name: r.firstName + " " + r.lastName,
          level: window.gui.playerData.guild.current.level
        });
        i._updateFightState(o.id, o.state);
        var l = t(o.id);
        i._registerFightStartTimer(l, o.waitingForHelpInfo);
      }
    }
  });
  g.on("fighting", function (e, n) {
    if (i.isVisible() && e === y.taxCollector) {
      var o = t(n.id);
      i._updateFightState(n.id, n.state);
      i._clearFightStartTimer(o);
    }
  });
  g.on("fightEnded", function (t, n) {
    if (i.isVisible() && t === y.taxCollector) {
      var o = e(n);
      o && (i._updateFightState(n, g.fightState.noFight), o.reset());
    }
  });
  g.on("fighterList", function (t, n, o, a) {
    if (i.isVisible() && t === y.taxCollector) {
      var s = e(n);
      s && s.setFighters(o, a);
    }
  });
  g.on("fighterJoined", function (t, n, o, a, s) {
    if (i.isVisible() && t === y.taxCollector) {
      var r = e(n);
      r && r.setFighter(o, a, s);
    }
  });
  g.on("fighterLeft", function (t, n, o, a, s) {
    if (i.isVisible() && t === y.taxCollector) {
      var r = e(n);
      r && r.removeFighter(o, s);
    }
  });
};
n.prototype._setPerceptorsAmount = function (e, t) {
  this.perceptorAmountText.setText(c("ui.social.guild.taxCollectorCount", e, t));
};
n.prototype._setNameLocation = function (e, t) {
  var i = t.enrichData || {},
    n = e.getChild("name");
  n.setText(i.firstName + " " + i.lastName);
  var o = " (" + t.worldX + " , " + t.worldY + ")",
    a = e.getChild("location");
  a.setText(i.subAreaName + o);
  var s = t.complements || [],
    r = u.getObjectInArrayById(s, "_type", "TaxCollectorLootInformations") || {},
    l = c("ui.common.short.weight", u.intToString(r.pods || 0)),
    d = c("ui.social.thingsTaxCollectorGet", l, u.intToString(r.experience || 0)),
    h = e.getChild("resources");
  h.setText(d);
  var p = e.getChild("owner"),
    m = t.additionalInfos.collectorCallerName;
  p.toggleClassName("me", window.gui.playerData.characterBaseInformations.name === m);
  p.setText(c("ui.common.ownerWord") + c("ui.common.colon") + m);
};
n.prototype._addFightStateToolTip = function (e, t) {
  l(e, function () {
    var e = "",
      i = t.state || 0;
    e += c(1 === i ? "ui.social.guild.taxInEnterFight" : 2 === i ? "ui.social.guild.taxInFight" : "ui.social.guild.taxInCollect");
    var n = t.additionalInfos || {};
    e += "\n" + c("ui.common.ownerWord") + c("ui.common.colon");
    e += n.collectorCallerName + "\n";
    e += c("ui.social.guild.taxStartDate") + c("ui.common.colon");
    var o = new v(1e3 * n.date).getServerDate().toString(!1);
    return e += o.date + " - " + o.time, e += "\n" + c("ui.social.taxCollector.itemsValue", u.kamasToString(t.complements[0].itemsValue)), new r("div", {
      text: e
    });
  });
};
n.prototype._updateTimerProgressBar = function (e) {
  var t = e.remainSeconds,
    i = e.totalWaitTime,
    n = i - t,
    o = Math.round(n / i * 100) / 100;
  e.setValue(o);
};
n.prototype._registerFightStartTimer = function (e, t) {
  var i = this;
  t && (e.remainSeconds = Math.round(t.timeLeftBeforeFight / 10) || 0, e.totalWaitTime = Math.round(t.waitTimeForPlacement / 10) || 1, e.intervalId = setInterval(function () {
    e.remainSeconds -= 1;
    e.remainSeconds > 0 ? i._updateTimerProgressBar(e) : i._clearFightStartTimer(e);
  }, 1e3), this._updateTimerProgressBar(e));
};
n.prototype._clearFightStartTimer = function (e) {
  clearInterval(e.intervalId);
  e.intervalId = null;
  e.remainSeconds = 0;
  e.totalWaitTime = 0;
  e.setValue(0);
};
n.prototype._clearAllFightStartTimers = function () {
  for (var e = this.table.getRows() || [], t = 0; t < e.length; t += 1) {
    var i = e[t].timer;
    this._clearFightStartTimer(i);
  }
};
n.prototype._createTaxCollectorRow = function (e) {
  var t = new r("div", {
    className: ["fightState", "state" + e.state]
  });
  this._addFightStateToolTip(t, e);
  var i = new r("div", {
    className: "taxCollectorInfo"
  });
  i.createChild("div", {
    name: "name"
  });
  i.createChild("div", {
    name: "location"
  });
  i.createChild("div", {
    name: "resources"
  });
  i.createChild("div", {
    name: "owner",
    className: "taxCollectorInfoOwner"
  });
  this._setNameLocation(i, e);
  var n = new m({
      vertical: !0,
      className: ["green", "timer"]
    }),
    a = new h();
  return a.on("slotTap", o), {
    fightState: t,
    taxCollectorInfo: i,
    timer: n,
    fightersInfo: a
  };
};
n.prototype._addTaxCollector = function (e) {
  var t = e.uniqueId,
    i = this.table.addRow(this._createTaxCollectorRow(e), {
      collectorId: t
    });
  this.taxCollectorRows[t] = i;
};
n.prototype._updateFightState = function (e, t) {
  var i = this.taxCollectorRows[e];
  i && i.fightState.replaceClassNames(["state0", "state1", "state2"], ["state" + t]);
};
n.prototype._removeTaxCollector = function (e) {
  var t = this.taxCollectorRows[e];
  if (t) {
    this._clearFightStartTimer(t.timer);
    delete this.taxCollectorRows[e];
    var i = this.table.getRows().indexOf(t);
    this.table.delRow(i);
  }
};
n.prototype._resetAll = function () {
  this.taxCollectorRows = {};
  this._clearAllFightStartTimers();
  this.table.clearContent();
  this._setPerceptorsAmount(0, 0);
};
n.prototype._openBoostPanel = function () {
  var e = "PerceptorBoostPanel",
    t = _.getPanel(e, 1);
  t ? _.focusWindow(t.id) : _.createPanel(e, new p(), {
    title: c("ui.social.guildTaxCollectors") + " - " + c("ui.social.guildBoosts"),
    width: 797,
    height: 497
  });
};
i.appendChild(new a({
  text: c("ui.social.guildBoosts"),
  className: ["boostPanelBtn", "greenButton"]
}, this._openBoostPanel.bind(this)));
this.perceptorAmountText = n.createChild("div", {
  className: "rightAlignText"
});
this._setPerceptorsAmount(0, 0);
n.createChild("div", {
  className: "rightAlignText",
  text: c("ui.social.guildHowDefendTax")
});
g.on("taxCollectorList", function (e, t, o) {
  if (i.isVisible() && e === y.taxCollector) {
    i.table.delClassNames("spinner");
    i._resetAll();
    for (var a = 0, s = t.length; a < s; a += 1) {
      i._addTaxCollector(t[a]);
    }
    n = o;
    i._setPerceptorsAmount(t.length, o);
  }
});
g.on("entityAdded", function (e, t) {
  i.isVisible() && e === y.taxCollector && (i._addTaxCollector(t), i._setPerceptorsAmount(i.table.getRowCount(), n));
});
g.on("entityRemoved", function (e, t) {
  i.isVisible() && e === y.taxCollector && (i._removeTaxCollector(t), i._setPerceptorsAmount(i.table.getRowCount(), n));
});
g.on("fightStarted", function (n, o) {
  if (i.isVisible() && n === y.taxCollector) {
    var a = e(o.id);
    if (a) {
      var s = g.entities[n][o.id],
        r = s.enrichData || {};
      a.setFight(n, o);
      a.setTarget({
        id: o.id,
        entityLook: s.look,
        name: r.firstName + " " + r.lastName,
        level: window.gui.playerData.guild.current.level
      });
      i._updateFightState(o.id, o.state);
      var l = t(o.id);
      i._registerFightStartTimer(l, o.waitingForHelpInfo);
    }
  }
});
g.on("fighting", function (e, n) {
  if (i.isVisible() && e === y.taxCollector) {
    var o = t(n.id);
    i._updateFightState(n.id, n.state);
    i._clearFightStartTimer(o);
  }
});
g.on("fightEnded", function (t, n) {
  if (i.isVisible() && t === y.taxCollector) {
    var o = e(n);
    o && (i._updateFightState(n, g.fightState.noFight), o.reset());
  }
});
g.on("fighterList", function (t, n, o, a) {
  if (i.isVisible() && t === y.taxCollector) {
    var s = e(n);
    s && s.setFighters(o, a);
  }
});
g.on("fighterJoined", function (t, n, o, a, s) {
  if (i.isVisible() && t === y.taxCollector) {
    var r = e(n);
    r && r.setFighter(o, a, s);
  }
});
g.on("fighterLeft", function (t, n, o, a, s) {
  if (i.isVisible() && t === y.taxCollector) {
    var r = e(n);
    r && r.removeFighter(o, s);
  }
});
i.table.delClassNames("spinner");
i._resetAll();
n = o;
i._setPerceptorsAmount(t.length, o);
a.setFight(n, o);
a.setTarget({
  id: o.id,
  entityLook: s.look,
  name: r.firstName + " " + r.lastName,
  level: window.gui.playerData.guild.current.level
});
i._updateFightState(o.id, o.state);
i._updateFightState(n.id, n.state);
i._clearFightStartTimer(o);
p.toggleClassName("me", window.gui.playerData.characterBaseInformations.name === m);
p.setText(c("ui.common.ownerWord") + c("ui.common.colon") + m);
e += "\n" + c("ui.common.ownerWord") + c("ui.common.colon");
e += n.collectorCallerName + "\n";
e += c("ui.social.guild.taxStartDate") + c("ui.common.colon");
e.remainSeconds -= 1;
e.remainSeconds > 0 ? i._updateTimerProgressBar(e) : i._clearFightStartTimer(e);
clearInterval(e.intervalId);
e.intervalId = null;
e.remainSeconds = 0;
e.totalWaitTime = 0;
e.setValue(0);
i.createChild("div", {
  name: "name"
});
i.createChild("div", {
  name: "location"
});
i.createChild("div", {
  name: "resources"
});
i.createChild("div", {
  name: "owner",
  className: "taxCollectorInfoOwner"
});
this._setNameLocation(i, e);
this._clearFightStartTimer(t.timer);
delete this.taxCollectorRows[e];
this.taxCollectorRows = {};
this._clearAllFightStartTimers();
this.table.clearContent();
this._setPerceptorsAmount(0, 0);
f.call(this, "div", {
  className: "PerceptorBoostPanel"
});
this._buildDomElements();
window.dofus.sendMessage("GuildGetInformationsMessage", {
  infoType: p.INFO_BOOSTS
});
this._listener = new d();
this._listenGameServerEvents();
this.on("destroy", function () {
  this._listener.stopListening();
});
l[d] = t[c];
s.spells[d].setLevel(u);
m.setStyle("backgroundImage", r[h]);
i.addRow([m, p.getName(), l[h], o(p, l[h], n) || ""]);
w(m, new _({
  spell: p
}));
i.clearContent();
m.parallel({
  spells: s,
  spellUrls: a
}, r);
u(n, f);
e.exports = n;
n.prototype._createCharacteristicUpgradeButton = function (e, t) {
  var i = new y({
    className: "UpgradeButton",
    name: "button",
    tooltip: c
  }, l);
  return i.characteristicKeyName = e, i.characteristicLabel = t, i.myWindow = this, i;
};
n.prototype._listenGameServerEvents = function () {
  var e = this;
  this._listener.listenTo(window.gui, "GuildInfosUpgradeMessage", function (t) {
    e.guildInfosUpgradeMessage = t;
    e._updateUI(t);
  });
};
n.prototype._buildDomElements = function () {
  var e = this.createChild("div", {
    className: ["sidePanel", "leftPanel"],
    name: "leftPanel"
  });
  this.spellsTable = new g({
    colIds: ["icon", "name", "level", "upgrade"],
    headerContent: ["", h("ui.common.name"), h("ui.common.level")],
    className: ["sidePanel", "rightPanel"]
  });
  this.appendChild(this.spellsTable);
  var t = e.createChild("div", {
      className: "characterImage"
    }),
    i = t.createChild("div", {
      className: "image"
    });
  b.preloadImage("gfx/illusUi/SocialGuildePersonnalisation_tx_IlluPerco.png", function (e) {
    i.setStyle("backgroundImage", e);
  });
  var n = new g({
    className: "perceptorCharacteristicsTable",
    colIds: ["label", "value", "upgrade"],
    headerContent: [h("ui.social.guildTaxCharacteristics")]
  });
  this.perceptorCharacteristicsTable = n;
  n.addRow([h("ui.common.lifePoints"), "0", ""]);
  n.addRow([h("ui.social.damagesBonus"), "0", ""]);
  this._addCharacteristicRow(h("ui.social.discernment"), "taxCollectorProspecting");
  this._addCharacteristicRow(h("ui.stats.wisdom"), "taxCollectorWisdom");
  this._addCharacteristicRow(h("ui.common.weight"), "taxCollectorPods");
  this._addCharacteristicRow(h("ui.social.taxCollectorCount"), "maxTaxCollectorsCount");
  e.appendChild(n);
  var o = e.createChild("div", {
    className: "pointsToDistributePanel",
    name: "pointsToDistributePanel"
  });
  o.createChild("div", {
    className: "pointsToDistributeLabel",
    name: "pointsToDistributeLabel",
    text: h("ui.social.guildBonusPoints")
  });
  this.pointsToDistributeValue = o.createChild("div", {
    className: "pointsToDistributeValue",
    name: "pointsToDistributeValue",
    text: "0"
  });
};
n.prototype._addCharacteristicRow = function (e, t) {
  this.perceptorCharacteristicsTable.addRow([e, "0", this._createCharacteristicUpgradeButton(t, e)]);
};
n.prototype._updateUI = function (e) {
  var t = e.boostPoints,
    i = this.perceptorCharacteristicsTable,
    n = 0;
  for (var o in I) {
    var a = n++;
    if (i.updateRow(a, {
      value: e[o]
    }), I[o]) {
      var s = t >= I[o].cost,
        l = e[o] < I[o].max,
        c = i.getCol(a, "upgrade").getChild("button");
      c.toggleDisplay(s && l);
    }
  }
  this.pointsToDistributeValue.setText(e.boostPoints);
  r(e.spellId, e.spellLevel, this.spellsTable, e.boostPoints);
};
e.guildInfosUpgradeMessage = t;
e._updateUI(t);
this.spellsTable = new g({
  colIds: ["icon", "name", "level", "upgrade"],
  headerContent: ["", h("ui.common.name"), h("ui.common.level")],
  className: ["sidePanel", "rightPanel"]
});
this.appendChild(this.spellsTable);
this.perceptorCharacteristicsTable = n;
n.addRow([h("ui.common.lifePoints"), "0", ""]);
n.addRow([h("ui.social.damagesBonus"), "0", ""]);
this._addCharacteristicRow(h("ui.social.discernment"), "taxCollectorProspecting");
this._addCharacteristicRow(h("ui.stats.wisdom"), "taxCollectorWisdom");
this._addCharacteristicRow(h("ui.common.weight"), "taxCollectorPods");
this._addCharacteristicRow(h("ui.social.taxCollectorCount"), "maxTaxCollectorsCount");
e.appendChild(n);
o.createChild("div", {
  className: "pointsToDistributeLabel",
  name: "pointsToDistributeLabel",
  text: h("ui.social.guildBonusPoints")
});
this.pointsToDistributeValue = o.createChild("div", {
  className: "pointsToDistributeValue",
  name: "pointsToDistributeValue",
  text: "0"
});
this.pointsToDistributeValue.setText(e.boostPoints);
r(e.spellId, e.spellLevel, this.spellsTable, e.boostPoints);
window.gui.playerData.socialData.once("spouseUpdate", function (t) {
  e._updateSocialWindowTitle(t);
});
this.once("open", function () {
  e._setupDom();
  e._setupEvents();
});
this.on("open", function () {
  window.dofus.sendMessage("SpouseGetInformationsMessage");
});
e._setupDom();
e._setupEvents();
o(n, s);
e.exports = n;
n.prototype._setupDom = function () {
  var e = this,
    t = this.createChild("div", {
      className: "col1"
    }),
    i = this.createChild("div", {
      className: "col2"
    });
  this.name = t.createChild("div", {
    className: "name"
  });
  var n = this.info = t.createChild("div", {
      className: "info"
    }),
    o = n.createChild("div", {
      className: "line"
    });
  o.createChild("div", {
    className: "title",
    text: a("ui.charcrea.breed") + ":"
  });
  this["class"] = o.createChild("div", {
    className: "value"
  });
  o = n.createChild("div", {
    className: "line"
  });
  o.createChild("div", {
    className: "title",
    text: a("ui.common.averageLevel") + ":"
  });
  this.level = o.createChild("div", {
    className: "value"
  });
  o = n.createChild("div", {
    className: "line"
  });
  o.createChild("div", {
    className: "title",
    text: a("ui.common.alignment") + ":"
  });
  this.alignment = o.createChild("div", {
    className: "value"
  });
  o = n.createChild("div", {
    className: ["line", "guild"]
  });
  o.createChild("div", {
    className: "title",
    text: a("ui.common.guild") + ":"
  });
  this.guild = o.createChild("div", {
    className: "value"
  });
  o = n.createChild("div", {
    className: "line"
  });
  o.createChild("div", {
    className: "title",
    text: a("ui.common.state") + ":"
  });
  this.status = o.createChild("div", {
    className: "value"
  });
  o = n.createChild("div", {
    className: "line"
  });
  o.createChild("div", {
    className: "title",
    text: a("ui.common.localisation") + ":"
  });
  this.location = o.createChild("div", {
    className: "value"
  });
  o = n.createChild("div", {
    className: "line"
  });
  this.fightingIcon = o.createChild("div", {
    className: "fightingIcon",
    hidden: !0
  });
  var s = n.createChild("div", {
    className: "buttons"
  });
  this.inviteButton = s.appendChild(new r({
    text: a("ui.party.addToParty"),
    className: "button"
  }, function () {
    window.dofus.sendMessage("PartyInvitationRequestMessage", {
      name: e.name.getText()
    });
  }));
  this.followButton = s.appendChild(new r({
    text: a("ui.common.follow"),
    className: "button"
  }, function () {
    window.dofus.sendMessage("FriendSpouseFollowWithCompassRequestMessage", {
      enable: !0
    });
  }));
  this.stopFollowingButton = s.appendChild(new r({
    text: a("ui.common.stopFollow"),
    className: "button",
    hidden: !0
  }, function () {
    window.dofus.sendMessage("FriendSpouseFollowWithCompassRequestMessage", {
      enable: !1
    });
  }));
  this.joinButton = s.appendChild(new r({
    text: a("ui.common.join"),
    className: "button"
  }, function () {
    window.dofus.sendMessage("FriendSpouseJoinRequestMessage");
  }));
  var l = i.createChild("div", {
    className: ["image", "bird"]
  });
  this.character = i.appendChild(new c({
    scale: 3.5,
    verticalAlign: "center"
  }));
  h.preloadImage("gfx/illusUi/tofus_bague.png", function (e) {
    l.setStyle("backgroundImage", e);
  });
};
n.prototype._setupEvents = function () {
  var e = this;
  window.gui.playerData.socialData.on("spouseUpdate", function (t) {
    e._updateSocialWindowTitle(t);
    e.updateDomData(t);
  });
  window.gui.on("CompassUpdateMessage", function () {
    e.stopFollowingButton.show();
    e.followButton.hide();
  });
  window.gui.on("CompassResetMessage", function () {
    e.stopFollowingButton.hide();
    e.followButton.show();
  });
};
n.prototype.updateDomData = function (e) {
  var t = this,
    i = window.gui.databases;
  this.name.setText(e.spouseName);
  this["class"].setText(i.Breeds[e.breed].shortNameId);
  this.level.setText(e.spouseLevel);
  this.alignment.setText(i.AlignmentSides[e.alignmentSide].nameId);
  var n = e.guildInfo ? e.guildInfo.guildName : "";
  return this.guild.setText("#NONAME#" === n ? a("ui.guild.noName") : n), this.stopFollowingButton.toggleDisplay(!!e.followSpouse), this.followButton.toggleDisplay(!e.followSpouse), this.fightingIcon.toggleDisplay(!!e.inFight), t.character.setLook(e.spouseEntityLook, {
    direction: d.DIRECTION_SOUTH_WEST,
    boneType: "characters/",
    skinType: "characters/",
    riderOnly: !0
  }), e.subAreaId ? (this.status.setText(a("ui.server.state.online")), this.inviteButton.enable(), this.followButton.enable(), this.stopFollowingButton.enable(), this.joinButton.enable(), void l.getData("SubAreas", e.subAreaId, function (e, i) {
    e && console.warn("Failed to retrieve subArea data", e);
    t.location.setText(i.nameId);
  })) : (this.status.setText(a("ui.server.state.offline")), this.location.setText("-"), this.inviteButton.disable(), this.followButton.disable(), this.stopFollowingButton.disable(), void this.joinButton.disable());
};
n.prototype._updateSocialWindowTitle = function (e) {
  var t = u.getWindow("social");
  t.setTitle(a("ui.common.spouse", e.sex));
};
o.createChild("div", {
  className: "title",
  text: a("ui.charcrea.breed") + ":"
});
this["class"] = o.createChild("div", {
  className: "value"
});
o = n.createChild("div", {
  className: "line"
});
o.createChild("div", {
  className: "title",
  text: a("ui.common.averageLevel") + ":"
});
this.level = o.createChild("div", {
  className: "value"
});
o = n.createChild("div", {
  className: "line"
});
o.createChild("div", {
  className: "title",
  text: a("ui.common.alignment") + ":"
});
this.alignment = o.createChild("div", {
  className: "value"
});
o = n.createChild("div", {
  className: ["line", "guild"]
});
o.createChild("div", {
  className: "title",
  text: a("ui.common.guild") + ":"
});
this.guild = o.createChild("div", {
  className: "value"
});
o = n.createChild("div", {
  className: "line"
});
o.createChild("div", {
  className: "title",
  text: a("ui.common.state") + ":"
});
this.status = o.createChild("div", {
  className: "value"
});
o = n.createChild("div", {
  className: "line"
});
o.createChild("div", {
  className: "title",
  text: a("ui.common.localisation") + ":"
});
this.location = o.createChild("div", {
  className: "value"
});
o = n.createChild("div", {
  className: "line"
});
this.fightingIcon = o.createChild("div", {
  className: "fightingIcon",
  hidden: !0
});
this.inviteButton = s.appendChild(new r({
  text: a("ui.party.addToParty"),
  className: "button"
}, function () {
  window.dofus.sendMessage("PartyInvitationRequestMessage", {
    name: e.name.getText()
  });
}));
this.followButton = s.appendChild(new r({
  text: a("ui.common.follow"),
  className: "button"
}, function () {
  window.dofus.sendMessage("FriendSpouseFollowWithCompassRequestMessage", {
    enable: !0
  });
}));
this.stopFollowingButton = s.appendChild(new r({
  text: a("ui.common.stopFollow"),
  className: "button",
  hidden: !0
}, function () {
  window.dofus.sendMessage("FriendSpouseFollowWithCompassRequestMessage", {
    enable: !1
  });
}));
this.joinButton = s.appendChild(new r({
  text: a("ui.common.join"),
  className: "button"
}, function () {
  window.dofus.sendMessage("FriendSpouseJoinRequestMessage");
}));
this.character = i.appendChild(new c({
  scale: 3.5,
  verticalAlign: "center"
}));
h.preloadImage("gfx/illusUi/tofus_bague.png", function (e) {
  l.setStyle("backgroundImage", e);
});
window.gui.playerData.socialData.on("spouseUpdate", function (t) {
  e._updateSocialWindowTitle(t);
  e.updateDomData(t);
});
window.gui.on("CompassUpdateMessage", function () {
  e.stopFollowingButton.show();
  e.followButton.hide();
});
window.gui.on("CompassResetMessage", function () {
  e.stopFollowingButton.hide();
  e.followButton.show();
});
e._updateSocialWindowTitle(t);
e.updateDomData(t);
e.stopFollowingButton.show();
e.followButton.hide();
e.stopFollowingButton.hide();
e.followButton.show();
this.name.setText(e.spouseName);
this["class"].setText(i.Breeds[e.breed].shortNameId);
this.level.setText(e.spouseLevel);
this.alignment.setText(i.AlignmentSides[e.alignmentSide].nameId);
e && console.warn("Failed to retrieve subArea data", e);
t.location.setText(i.nameId);
r.call(this, "div", {
  className: "FellowPagesWindow",
  name: "directory"
});
e = e || {};
this.addClassNames(e.className);
this.on("open", this._onOpen);
this.on("close", this._onClose);
o(n, r);
e.exports = n;
n.prototype._onOpen = function () {
  var e = this._tabs = this.appendChild(new s({
    className: "tabs"
  }));
  e.addTab(a("ui.social.guilds"), new l(), "guilds");
  e.addTab(a("ui.alliance.alliances"), new c(), "alliances");
  e.openTab(0);
};
n.prototype._onClose = function () {
  this._tabs.close();
  this.clearContent();
  this._tabs = null;
};
e.addTab(a("ui.social.guilds"), new l(), "guilds");
e.addTab(a("ui.alliance.alliances"), new c(), "alliances");
e.openTab(0);
this._tabs.close();
this.clearContent();
this._tabs = null;
p.call(this, "div", {
  className: "FellowGuildsWindow"
});
this._isListening = !1;
this._reset();
this.on("open", this._onOpen);
this.on("destroy", this._reset);
l(n, p);
e.exports = n;
n.prototype._reset = function () {
  this._hasDom = !1;
  this._queryTable && this._queryTable.reset();
  this._queryTable = null;
};
n.prototype._onOpen = function () {
  this._hasDom || this._setupDom();
  this._isListening || this._setupListeners();
};
n.prototype._setupDom = function () {
  this._hasDom = !0;
  this._queryTable = new d(this);
  this._queryTable.createMinAndMaxBox("Level", r("ui.common.level"), m);
  this._queryTable.createMinAndMaxBox("MemberCount", r("ui.common.members"), f);
  this._queryTable.createTextSearchBox("text");
  this._queryTable.createSearchAndResetButton(this._sendQuery.bind(this));
  var e = new h([{
    id: "emblem",
    format: function (e) {
      var t = new s({
        width: 40,
        height: 40
      });
      return t.setValue(e.guildEmblem, !0), t;
    }
  }, {
    id: "guildName",
    header: r("ui.common.name"),
    sort: !0
  }, {
    id: "guildLevel",
    header: r("ui.common.level"),
    sort: !0
  }, {
    id: "nbMembers",
    header: r("ui.common.members"),
    sort: !0
  }], "guildId");
  this._queryTable.appendTable(e, o);
  e.on("rowTap", function (e, t) {
    a.openGuildCard(t.guildId);
    c("GEN_BUTTON");
  });
};
n.prototype._setupListeners = function () {
  this._isListening = !0;
  var e = window.dofus.connectionManager,
    t = this;
  e.on("_socialDataErrorMessage", function (e) {
    t._hasDom && "guildList" === e.type && t._handleError();
  });
  e.on("GuildListMessage", function (e) {
    t._hasDom && t._receiveList(e.guilds, e.truncated);
  });
};
n.prototype._sendQuery = function (e) {
  if (this._hasDom) {
    this._queryTable.prepareForResults();
    var t = window.gui.serversData.connectedServerId;
    window.dofus.send("socialDataRequest", {
      type: "guildList",
      serverId: t,
      minLevel: e.minLevel || 0,
      minMemberCount: e.minMemberCount || 0,
      maxLevel: e.maxLevel || 0,
      maxMemberCount: e.maxMemberCount || 0,
      text: e.text || ""
    });
  }
};
n.prototype._handleError = function () {
  this._queryTable.showError(this._sendQuery.bind(this));
};
n.prototype._receiveList = function (e, t) {
  this._queryTable.loadResults(e, t);
};
this._hasDom = !1;
this._queryTable && this._queryTable.reset();
this._queryTable = null;
this._hasDom || this._setupDom();
this._isListening || this._setupListeners();
this._hasDom = !0;
this._queryTable = new d(this);
this._queryTable.createMinAndMaxBox("Level", r("ui.common.level"), m);
this._queryTable.createMinAndMaxBox("MemberCount", r("ui.common.members"), f);
this._queryTable.createTextSearchBox("text");
this._queryTable.createSearchAndResetButton(this._sendQuery.bind(this));
this._queryTable.appendTable(e, o);
e.on("rowTap", function (e, t) {
  a.openGuildCard(t.guildId);
  c("GEN_BUTTON");
});
a.openGuildCard(t.guildId);
c("GEN_BUTTON");
e.on("_socialDataErrorMessage", function (e) {
  t._hasDom && "guildList" === e.type && t._handleError();
});
e.on("GuildListMessage", function (e) {
  t._hasDom && t._receiveList(e.guilds, e.truncated);
});
this.reset();
this._parent = e;
this._queryBox = e.createChild("div", {
  className: "queryBox"
});
e.exports = n;
n.prototype.reset = function () {
  this._parent = null;
  this._queryBox = null;
  this._buttonBox = null;
  this._failureBox = null;
  this._queryBtn = null;
  this._textFilterBox = null;
  this._filterBox = null;
  this._rowCounter = null;
  this._table = null;
  this._fieldMap = {};
};
n.prototype.createMinAndMaxBox = function (e, t, i) {
  var n = s("tablet.filter.to"),
    a = s("ui.common.minWord"),
    r = s("ui.common.maxWord"),
    l = this._queryBox.createChild("div", {
      className: ["minMaxDiv", e]
    });
  l.createChild("div", {
    className: "label",
    text: t + s("ui.common.colon")
  });
  this._fieldMap["min" + e] = o(l, t + " - " + a, a, i);
  l.createChild("span", {
    text: n
  });
  this._fieldMap["max" + e] = o(l, t + " - " + r, r, i);
};
n.prototype.createTextSearchBox = function (e) {
  var t = this._queryBox.createChild("div");
  t.createChild("div", {
    className: "label",
    text: s("ui.common.name") + s("ui.common.colon")
  });
  this._fieldMap[e] = t.appendChild(new r());
};
n.prototype.createSearchAndResetButton = function (e, t) {
  var i = this._buttonBox = this._queryBox.createChild("div", {
      className: "buttonBox"
    }),
    n = this;
  this._queryBtn = i.appendChild(new a({
    className: ["searchBtn", "greenButton"],
    text: s("ui.common.search")
  }, function () {
    return n._checkQuery() ? (n._queryBtn.disable(), void e(n.getQuery())) : n.loadResults([]);
  }));
  i.appendChild(new a({
    className: ["resetBtn", "secondaryButton"],
    text: s("ui.common.reset")
  }, function () {
    n._resetQueryFields();
    t && t();
  }));
};
n.prototype._createFilterBox = function (e, t) {
  var i = this._filterBox = e.createChild("div", {
    className: "filterBox"
  });
  i.createChild("div", {
    className: "filterIcon"
  });
  this._textFilterBox = i.appendChild(new c({
    isLiveSearch: !0,
    placeholder: s("tablet.common.filter")
  }));
  this._setFilterEnable(!1);
  var n = this;
  this._textFilterBox.on("search", function (e) {
    n._table.searchedText = d(e);
    n._table.filter(t);
  });
};
n.prototype._setFilterEnable = function (e) {
  this._textFilterBox.setEnable(e);
  this._filterBox.toggleClassName("disabled", !e);
};
n.prototype._checkQuery = function () {
  var e = !0;
  for (var t in this._fieldMap) {
    if (t.startsWith("min")) {
      var i = t.substr(3),
        n = this._fieldMap[t],
        o = this._fieldMap["max" + i];
      if (o) {
        var a = n.getRawValue(),
          s = o.getRawValue(),
          r = "" !== a && "" !== s && parseInt(a, 10) > parseInt(s, 10);
        n.toggleClassName("invalid", r);
        o.toggleClassName("invalid", r);
        r && (e = !1);
      }
    }
  }
  return e;
};
n.prototype.getQuery = function () {
  var e = {};
  for (var t in this._fieldMap) {
    e[t] = this._fieldMap[t].getValue();
  }
  return e;
};
n.prototype._resetQueryFields = function () {
  for (var e in this._fieldMap) {
    this._fieldMap[e].setValue("");
  }
};
n.prototype.showError = function (e) {
  this._deleteFailureBox();
  this._createFailureBox(e);
  this._table.setContentLoading(!1);
  this._table.setPlaceholderText(s("tablet.searchError"));
  this._setFilterEnable(!1);
};
n.prototype._createFailureBox = function (e) {
  var t = this,
    i = this._failureBox = this._buttonBox.createChild("div", {
      className: "failureBox"
    }),
    n = i.appendChild(new a({
      className: ["retryBtn", "specialButton"],
      text: s("tablet.common.retry")
    }));
  n.on("tap", function () {
    n.disable();
    e(t.getQuery());
  });
};
n.prototype._deleteFailureBox = function () {
  this._failureBox && (this._buttonBox.removeChild(this._failureBox), this._failureBox = null);
};
n.prototype.appendTable = function (e, t) {
  var i = this._parent.createChild("div", {
    className: "aboveTable"
  });
  this._createFilterBox(i, t);
  this._rowCounter = i.createChild("div", {
    className: "rowCounter"
  });
  this._table = this._parent.appendChild(e);
  setTimeout(function (e) {
    e._table && e._table.setPlaceholderText(s("tablet.search"));
  }, 0, this);
};
n.prototype.prepareForResults = function () {
  this._table.clearContent();
  this._table.setContentLoading(!0);
  this._table.setPlaceholderText(s("ui.loadbar.loading") + "...");
  this._rowCounter.setText("");
};
n.prototype.loadResults = function (e, t) {
  this._deleteFailureBox();
  this._setFilterEnable(!0);
  t ? this._rowCounter.setText(s("tablet.firstResults", e.length)) : this._rowCounter.setText(s("tablet.nResults", e.length));
  this._table.setContentLoading(!1);
  e.length ? (this._table.setPlaceholderText(""), this._table.addList(e, !0, !0)) : this._table.setPlaceholderText(s("ui.search.noResult"));
  this._queryBtn.enable();
};
this._parent = null;
this._queryBox = null;
this._buttonBox = null;
this._failureBox = null;
this._queryBtn = null;
this._textFilterBox = null;
this._filterBox = null;
this._rowCounter = null;
this._table = null;
this._fieldMap = {};
l.createChild("div", {
  className: "label",
  text: t + s("ui.common.colon")
});
this._fieldMap["min" + e] = o(l, t + " - " + a, a, i);
l.createChild("span", {
  text: n
});
this._fieldMap["max" + e] = o(l, t + " - " + r, r, i);
t.createChild("div", {
  className: "label",
  text: s("ui.common.name") + s("ui.common.colon")
});
this._fieldMap[e] = t.appendChild(new r());
this._queryBtn = i.appendChild(new a({
  className: ["searchBtn", "greenButton"],
  text: s("ui.common.search")
}, function () {
  return n._checkQuery() ? (n._queryBtn.disable(), void e(n.getQuery())) : n.loadResults([]);
}));
i.appendChild(new a({
  className: ["resetBtn", "secondaryButton"],
  text: s("ui.common.reset")
}, function () {
  n._resetQueryFields();
  t && t();
}));
n._resetQueryFields();
t && t();
i.createChild("div", {
  className: "filterIcon"
});
this._textFilterBox = i.appendChild(new c({
  isLiveSearch: !0,
  placeholder: s("tablet.common.filter")
}));
this._setFilterEnable(!1);
n._table.searchedText = d(e);
n._table.filter(t);
this._textFilterBox.setEnable(e);
this._filterBox.toggleClassName("disabled", !e);
n.toggleClassName("invalid", r);
o.toggleClassName("invalid", r);
r && (e = !1);
this._deleteFailureBox();
this._createFailureBox(e);
this._table.setContentLoading(!1);
this._table.setPlaceholderText(s("tablet.searchError"));
this._setFilterEnable(!1);
n.disable();
e(t.getQuery());
this._createFilterBox(i, t);
this._rowCounter = i.createChild("div", {
  className: "rowCounter"
});
this._table = this._parent.appendChild(e);
setTimeout(function (e) {
  e._table && e._table.setPlaceholderText(s("tablet.search"));
}, 0, this);
this._table.clearContent();
this._table.setContentLoading(!0);
this._table.setPlaceholderText(s("ui.loadbar.loading") + "...");
this._rowCounter.setText("");
this._deleteFailureBox();
this._setFilterEnable(!0);
t ? this._rowCounter.setText(s("tablet.firstResults", e.length)) : this._rowCounter.setText(s("tablet.nResults", e.length));
this._table.setContentLoading(!1);
e.length ? (this._table.setPlaceholderText(""), this._table.addList(e, !0, !0)) : this._table.setPlaceholderText(s("ui.search.noResult"));
this._queryBtn.enable();
f.call(this, "div", {
  className: "FellowAlliancesWindow"
});
this._isListening = !1;
this._reset();
this.on("open", this._onOpen);
this.on("destroy", this._reset);
d(n, f);
e.exports = n;
n.prototype._reset = function () {
  this._hasDom = !1;
  this._queryTable && this._queryTable.reset();
  this._queryTable = null;
};
n.prototype._onOpen = function () {
  this._hasDom || this._setupDom();
  this._isListening || this._setupListeners();
};
n.prototype._setupDom = function () {
  this._hasDom = !0;
  this._queryTable = new h(this);
  this._queryTable.createMinAndMaxBox("GuildCount", l("ui.social.guilds"), _);
  this._queryTable.createMinAndMaxBox("MemberCount", l("ui.common.members"), g);
  this._queryTable.createMinAndMaxBox("Subarea", l("ui.common.territory"), v);
  this._queryTable.createTextSearchBox("text");
  this._queryTable.createSearchAndResetButton(this._sendQuery.bind(this));
  var e = new m([{
    id: "emblem",
    format: function (e) {
      var t = new r({
        width: 40,
        height: 40
      });
      return t.setValue(e.allianceEmblem, !0), t;
    }
  }, {
    id: "allianceName",
    header: l("ui.common.name"),
    sort: !0
  }, {
    id: "allianceTag",
    header: l("ui.alliance.tag"),
    sort: !0
  }, {
    id: "creationDate",
    header: l("tablet.since"),
    format: o,
    sort: function (e, t) {
      return t.creationDate - e.creationDate;
    }
  }, {
    id: "nbGuilds",
    header: l("ui.social.guilds"),
    sort: !0
  }, {
    id: "nbMembers",
    header: l("ui.common.members"),
    sort: !0
  }, {
    id: "nbSubarea",
    header: l("ui.common.territory"),
    sort: !0
  }], "allianceId");
  this._queryTable.appendTable(e, a);
  e.on("rowTap", function (e, t) {
    s.openAllianceCard(t.allianceId);
    u("GEN_BUTTON");
  });
};
n.prototype._setupListeners = function () {
  this._isListening = !0;
  var e = window.dofus.connectionManager,
    t = this;
  e.on("_socialDataErrorMessage", function (e) {
    t._hasDom && "allianceList" === e.type && t._handleError();
  });
  e.on("AllianceListMessage", function (e) {
    t._hasDom && t._receiveList(e.alliances, e.truncated);
  });
};
n.prototype._sendQuery = function (e) {
  if (this._hasDom) {
    this._queryTable.prepareForResults();
    var t = window.gui.serversData.connectedServerId;
    window.dofus.send("socialDataRequest", {
      type: "allianceList",
      serverId: t,
      minGuildCount: e.minGuildCount || 0,
      maxGuildCount: e.maxGuildCount || 0,
      minMemberCount: e.minMemberCount || 0,
      maxMemberCount: e.maxMemberCount || 0,
      minSubarea: e.minSubarea || 0,
      maxSubarea: e.maxSubarea || 0,
      text: e.text || ""
    });
  }
};
n.prototype._handleError = function () {
  this._queryTable.showError(this._sendQuery.bind(this));
};
n.prototype._receiveList = function (e, t) {
  this._queryTable.loadResults(e, t);
};
this._hasDom = !1;
this._queryTable && this._queryTable.reset();
this._queryTable = null;
this._hasDom || this._setupDom();
this._isListening || this._setupListeners();
this._hasDom = !0;
this._queryTable = new h(this);
this._queryTable.createMinAndMaxBox("GuildCount", l("ui.social.guilds"), _);
this._queryTable.createMinAndMaxBox("MemberCount", l("ui.common.members"), g);
this._queryTable.createMinAndMaxBox("Subarea", l("ui.common.territory"), v);
this._queryTable.createTextSearchBox("text");
this._queryTable.createSearchAndResetButton(this._sendQuery.bind(this));
this._queryTable.appendTable(e, a);
e.on("rowTap", function (e, t) {
  s.openAllianceCard(t.allianceId);
  u("GEN_BUTTON");
});
s.openAllianceCard(t.allianceId);
u("GEN_BUTTON");
e.on("_socialDataErrorMessage", function (e) {
  t._hasDom && "allianceList" === e.type && t._handleError();
});
e.on("AllianceListMessage", function (e) {
  t._hasDom && t._receiveList(e.alliances, e.truncated);
});
R = !0;
I.setStyle("backgroundImage", e);
N.replaceClassNames(["buy"], ["sell"]);
M.windowTitle.setText(l("ui.mount.paddockSell"));
x.setText(l("ui.common.cancelTheSale"));
E.setReadonly(!1);
e(L, w);
N.replaceClassNames(["sell"], ["buy"]);
M.windowTitle.setText(l("ui.mount.paddockPurchase"));
x.setText(l("ui.common.cancel"));
E.setReadonly(!0);
a.call(this, {
  className: "PaddockBuyWindow",
  positionInfo: {
    left: "c",
    top: "c",
    width: 350,
    height: 270
  }
});
this.currency = g;
L.on("tap", function () {
  if (o) {
    m.hide();
    i = E.getValue();
    var e = E.getFormattedValue();
    window.gui.openConfirmPopup({
      title: l("ui.mount.paddockSell"),
      message: l("ui.mount.doUSellPaddock", e),
      cb: function (e) {
        e && window.dofus.sendMessage("PaddockSellRequestMessage", {
          price: i
        });
      }
    });
  } else {
    var t,
      a = M.currency === g;
    t = a ? l("tablet.price.soft", r.kamasToString(i, "")) : l("tablet.price.hard", r.kamasToString(n, ""));
    window.gui.openConfirmPopup({
      title: l("ui.mount.paddockPurchase"),
      message: l("tablet.ui.mount.doUBuyPaddock", t),
      cb: function (e) {
        if (e) {
          if (a) {
            return window.dofus.sendMessage("PaddockBuyRequestMessage");
          }
          var t = n - window.gui.playerData.inventory.goultines;
          return t > 0 ? f.openNotEnoughHardCurrencyPopup(t) : window.dofus.send("paddockBuyRequest", {
            amountHard: n,
            amountSoft: i
          });
        }
      }
    }, {
      isModal: !0
    });
  }
});
E.on("change", function (t) {
  M.currency === g ? e(L, t !== b) : e(L, !0);
});
m.hide();
i = E.getValue();
t = a ? l("tablet.price.soft", r.kamasToString(i, "")) : l("tablet.price.hard", r.kamasToString(n, ""));
window.gui.openConfirmPopup({
  title: l("ui.mount.paddockPurchase"),
  message: l("tablet.ui.mount.doUBuyPaddock", t),
  cb: function (e) {
    if (e) {
      if (a) {
        return window.dofus.sendMessage("PaddockBuyRequestMessage");
      }
      var t = n - window.gui.playerData.inventory.goultines;
      return t > 0 ? f.openNotEnoughHardCurrencyPopup(t) : window.dofus.send("paddockBuyRequest", {
        amountHard: n,
        amountSoft: i
      });
    }
  }
}, {
  isModal: !0
});
O.on("switchToHard", function () {
  M._setCurrency(_);
  t();
});
O.on("switchToSoft", function () {
  M._setCurrency(g);
  t();
});
M._setCurrency(_);
t();
M._setCurrency(g);
t();
window.gui.on("PaddockPropertiesMessage", function (e) {
  v = e.properties.maxOutdoorMount;
  y = e.properties.maxItems;
  w = 0 === e.properties.price;
});
window.gui.on("PaddockSellBuyDialogMessage", function (e) {
  o = e.bsell;
  i = b = e.price;
  n = p.computeHardPrice(i);
  O.setCurrency(g);
  t();
  d.openDialog("paddockBuy");
});
p.on("computedHardPricesChange", function () {
  n = p.computeHardPrice(i);
  M.currency === _ && t();
});
v = e.properties.maxOutdoorMount;
y = e.properties.maxItems;
w = 0 === e.properties.price;
o = e.bsell;
i = b = e.price;
n = p.computeHardPrice(i);
O.setCurrency(g);
t();
d.openDialog("paddockBuy");
n = p.computeHardPrice(i);
M.currency === _ && t();
D.on("paddockBuyError", function () {
  this.send("moneyGoultinesAmountRequest");
});
D.on("paddockBuySuccess", function () {
  this.send("moneyGoultinesAmountRequest");
});
this.on("close", function () {
  m.hide();
});
o(n, a);
e.exports = n;
n.prototype._setCurrency = function (e) {
  if (this.currency !== e) {
    var t = this.currency;
    this.currency = e;
    this.currencyIcon && this.currencyIcon.replaceClassNames([t], [e]);
  }
};
this.currency = e;
this.currencyIcon && this.currencyIcon.replaceClassNames([t], [e]);
d.setMount(e, {
  context: i || "equipped"
});
t.windowTitle.setText(d.getName());
a.on("ExchangeStartOkMountMessage", function () {
  c.close(t.id);
});
d.on("freeMount", function () {
  c.close(t.id);
});
d.on("renameMount", function (e) {
  t.windowTitle.setText(e);
});
n.on("setMount", this.localizeEvent(function (t) {
  e(t.mountData);
}));
a.on("MountDataMessage", this.localizeEvent(function (n) {
  if (t.isMountInfoExpected) {
    t.isMountInfoExpected = !1;
    var o = n.mountData;
    o.mountLocation = "certificate";
    e(o, "inventory");
    i.delClassNames("spinner");
    d.show();
  }
}));
a.on("MountDataErrorMessage", function (e) {
  if (e.reason === s.SOMEONE_ELSE_PRIVATE_FARM) {
    c.close(t.id);
    var i = o("ui.mount.impossibleDataPrivateFarm");
    window.gui.openSimplePopup(i);
  }
});
this.on("open", function (t) {
  if (t = t || {}, this.isMountInfoExpected) {
    return d.hide(), void i.addClassNames("spinner");
  }
  var o = t.mountData || n.equippedMount;
  e(o);
});
this.on("close", function () {
  c.close("feed");
});
o.mountLocation = "certificate";
e(o, "inventory");
i.delClassNames("spinner");
d.show();
a(n, r);
e.exports = n;
n.prototype.showPaddockMount = function (e) {
  this.isMountInfoExpected = !0;
  c.open(this.id, {
    forceToOpen: !0
  });
  window.dofus.sendMessage("MountInformationInPaddockRequestMessage", {
    mapRideId: e
  });
};
n.prototype.showCertificateMount = function (e) {
  var t = l.getMountInfoFromCertificate(e);
  t && (this.isMountInfoExpected = !0, c.open(this.id, {
    forceToOpen: !0
  }), window.dofus.sendMessage("MountInformationRequestMessage", {
    id: t.mountId,
    time: t.date
  }));
};
this.isMountInfoExpected = !0;
c.open(this.id, {
  forceToOpen: !0
});
window.dofus.sendMessage("MountInformationInPaddockRequestMessage", {
  mapRideId: e
});
r.call(this, {
  title: o("ui.common.feed"),
  className: "FeedWindow",
  positionInfo: {
    right: 315,
    bottom: 30,
    width: 400,
    height: 510
  }
});
this.feedingBox = new s(this);
this.once("open", function () {
  this._createDom();
});
this.on("open", function (e) {
  this.feedingBox.update(e);
});
this.on("close", function () {
  this.feedingBox.removeFilter();
});
this.on("closed", function () {
  this.feedingBox.unloadContent();
});
this.on("slot-tap", function (e) {
  this.feedingBox.selectItem(e.itemInstance);
});
this.on("itemQuantity", function (e) {
  this.feedingBox.selectItem(e);
});
this.on("itemRemoved", function () {
  this.feedingBox.reset();
});
a(n, r);
n.prototype._createDom = function () {
  this.feedingBox.init(this.windowBody);
};
e.exports = n;
m.quantity.show();
m.quantityLabel.setText(p("ui.common.quantity") + p("ui.common.colon"));
m.maxBtn.show();
m.minBtn.show();
m.quantity.hide();
m.quantityLabel.setText(p("ui.common.quantity") + p("ui.common.colon") + " 1");
m.maxBtn.hide();
m.minBtn.hide();
this.storageViewer = new v({
  enablePresets: !1
});
this.storageViewer.registerView(e, {
  manualOpening: !0,
  enableSlotContext: !1
});
this._settings = {
  mount: {
    handleInput: function () {},
    setupUI: n,
    filter: a,
    confirmMessage: d,
    confirmAction: l,
    dataHandler: window.gui.playerData.inventory
  },
  pet: {
    handleInput: function () {},
    setupUI: n,
    filter: t,
    confirmMessage: c,
    confirmAction: s,
    dataHandler: window.gui.playerData.inventory
  },
  livingObject: {
    handleInput: function (e) {
      h = e.item.livingObjectCategory;
    },
    setupUI: u,
    filter: i,
    confirmMessage: c,
    confirmAction: s,
    dataHandler: window.gui.playerData.inventory
  },
  shield: {
    handleInput: function () {},
    setupUI: n,
    filter: o,
    confirmMessage: c,
    confirmAction: r,
    dataHandler: window.gui.playerData.inventory
  },
  shieldTutorial: {
    handleInput: function () {},
    setupUI: n,
    confirmMessage: c,
    dataHandler: null
  }
};
m(u, w);
u.prototype.init = function (e) {
  this._createDom(e);
};
u.prototype.update = function (e) {
  e = e || {};
  var t = this;
  if (this.reset(), this.mode = e.mode, this.params = e, this.setting = this._settings[this.mode], this.storageViewer.setDataHandler(this.setting.dataHandler), this.setting.handleInput(e), this.setting.setupUI(), "shieldTutorial" === e.mode) {
    y.createItemInstances(M.fakeRune, function (e, i) {
      return e ? console.error(e) : void t.storageViewer.setItemList(i.map);
    });
  } else {
    var i = n(this.setting.filter);
    this.storageViewer.setItemList(i);
    this.storageViewer.addFilters([this.setting.filter]);
  }
  this.quantity.on("change", function (e) {
    t._emitQuantityUpdating(e);
  });
};
u.prototype.unloadContent = function () {
  this.storageViewer.unloadContent();
};
u.prototype.removeFilter = function () {
  this.storageViewer.removeFilter(this.setting.filter);
};
u.prototype.possessFeedItemForMount = function () {
  for (var e = window.gui.playerData.inventory.objects, t = Object.keys(e), i = 0, n = t.length; i < n; i += 1) {
    if (a(e[t[i]])) {
      return !0;
    }
  }
  return !1;
};
u.prototype.possessFeedItemForPet = function (e) {
  for (var t = window.gui.playerData.inventory.objects, i = Object.keys(t), n = e.item.foodItems, o = e.item.foodTypes, a = 0, s = i.length; a < s; a += 1) {
    var r = t[i[a]];
    if (n.indexOf(r.objectGID) !== -1 || o.indexOf(r.item.typeId) !== -1) {
      return !0;
    }
  }
  return !1;
};
u.prototype.possessFeedItemForLivingObject = function (e) {
  for (var t = window.gui.playerData.inventory.objects, i = Object.keys(t), n = e.livingObjectCategory, o = 0, a = i.length; o < a; o += 1) {
    var s = t[i[o]];
    if (!s.livingObjectCategory && s.item.type.id === n) {
      return !0;
    }
  }
  return !1;
};
u.prototype.reset = function () {
  this.placeHolder.setText(p("ui.common.selectItem"));
  this.itemBox.hide();
  this.confirmBtn.disable();
  this.quantity.setValue(1);
  this._givenXp = 0;
  this.quantity.disable();
  "shield" !== this.mode && "shieldTutorial" !== this.mode || (this.emit("quantityReset"), this.item && (this.storageViewer.unSelectSlot(this.item.objectUID), this.item = null));
  this.minBtn.disable();
  this.maxBtn.disable();
};
u.prototype._createDom = function (e) {
  var t = this;
  this.viewerBox = e.createChild("div", {
    className: "viewer"
  });
  this.viewerBox.appendChild(t.storageViewer.storageUI);
  var i = e.createChild("div", {
    className: "itemBox"
  });
  this.itemBox = i.appendChild(new f({
    showTitle: !0
  }));
  this.placeHolder = new _(i);
  var n = e.createChild("div", {
    className: "quantityBox"
  });
  this.quantityLabel = n.createChild("div", {
    className: "label"
  });
  var o = this.quantity = n.appendChild(new g({
    title: p("ui.common.quantity"),
    maxValue: 3e4
  }));
  this.minBtn = n.appendChild(new h({
    text: p("ui.common.minWord"),
    className: ["greenButton", "minButton"]
  }, function () {
    o.setValue(1);
    t._emitQuantityUpdating(1);
  }));
  this.maxBtn = n.appendChild(new h({
    text: p("ui.common.maxWord"),
    className: ["greenButton", "minButton"]
  }, function () {
    o.setValue(Math.min(3e4, t.item.quantity));
    t._emitQuantityUpdating(Math.min(3e4, t.item.quantity));
  }));
  this.confirmBtn = e.appendChild(new h({
    text: p("ui.common.validation"),
    className: ["greenButton", "confirm"]
  }));
  this.confirmBtn.on("tap", function () {
    var e = o.getValue();
    window.gui.openConfirmPopup({
      title: p("ui.popup.warning"),
      message: t.setting.confirmMessage(e, t.item.item.nameId),
      cb: function (i) {
        if (i) {
          if (!t.item || !t.item.objectUID) {
            return console.error("Item or objectUID of the item select for the feeding is undefined");
          }
          if ("shieldTutorial" === t.mode) {
            var n = window.gui.playerData;
            window.dofus.sendMessage("QuestObjectiveValidationMessage", {
              questId: n.shieldTutorialQuestId,
              objectiveId: n.shieldTutorialQuestObjective
            });
            t.unloadContent();
          } else {
            t.setting.confirmAction(e, t.item.objectUID, t.params);
          }
        }
      }
    });
  });
};
u.prototype.selectItem = function (e) {
  if (this.item = e, "shield" === this.mode || "shieldTutorial" === this.mode) {
    for (var t = 0; t < e.effects.length; t++) {
      e.effects[t].actionId === b.ACTION_SHIELD_INTERACT_WITH_TYPE && (this._givenXp = e.effects[t].value);
    }
  }
  this.itemBox.displayItem(e);
  this.itemBox.show();
  this.placeHolder.setText(null);
  this.confirmBtn.enable();
  this.quantity.setValue(1);
  this._emitQuantityUpdating(1);
  this.quantity.maxValue = Math.min(3e4, e.quantity);
  this.quantity.enable();
  this.minBtn.enable();
  this.maxBtn.enable();
};
u.prototype._emitQuantityUpdating = function (e) {
  "shield" !== this.mode && "shieldTutorial" !== this.mode || this.emit("quantityUpdated", e, this._givenXp);
};
e.exports = u;
this.storageViewer.setItemList(i);
this.storageViewer.addFilters([this.setting.filter]);
this.placeHolder.setText(p("ui.common.selectItem"));
this.itemBox.hide();
this.confirmBtn.disable();
this.quantity.setValue(1);
this._givenXp = 0;
this.quantity.disable();
"shield" !== this.mode && "shieldTutorial" !== this.mode || (this.emit("quantityReset"), this.item && (this.storageViewer.unSelectSlot(this.item.objectUID), this.item = null));
this.minBtn.disable();
this.maxBtn.disable();
this.viewerBox = e.createChild("div", {
  className: "viewer"
});
this.viewerBox.appendChild(t.storageViewer.storageUI);
this.itemBox = i.appendChild(new f({
  showTitle: !0
}));
this.placeHolder = new _(i);
this.minBtn = n.appendChild(new h({
  text: p("ui.common.minWord"),
  className: ["greenButton", "minButton"]
}, function () {
  o.setValue(1);
  t._emitQuantityUpdating(1);
}));
this.maxBtn = n.appendChild(new h({
  text: p("ui.common.maxWord"),
  className: ["greenButton", "minButton"]
}, function () {
  o.setValue(Math.min(3e4, t.item.quantity));
  t._emitQuantityUpdating(Math.min(3e4, t.item.quantity));
}));
this.confirmBtn = e.appendChild(new h({
  text: p("ui.common.validation"),
  className: ["greenButton", "confirm"]
}));
this.confirmBtn.on("tap", function () {
  var e = o.getValue();
  window.gui.openConfirmPopup({
    title: p("ui.popup.warning"),
    message: t.setting.confirmMessage(e, t.item.item.nameId),
    cb: function (i) {
      if (i) {
        if (!t.item || !t.item.objectUID) {
          return console.error("Item or objectUID of the item select for the feeding is undefined");
        }
        if ("shieldTutorial" === t.mode) {
          var n = window.gui.playerData;
          window.dofus.sendMessage("QuestObjectiveValidationMessage", {
            questId: n.shieldTutorialQuestId,
            objectiveId: n.shieldTutorialQuestObjective
          });
          t.unloadContent();
        } else {
          t.setting.confirmAction(e, t.item.objectUID, t.params);
        }
      }
    }
  });
});
o.setValue(1);
t._emitQuantityUpdating(1);
o.setValue(Math.min(3e4, t.item.quantity));
t._emitQuantityUpdating(Math.min(3e4, t.item.quantity));
window.dofus.sendMessage("QuestObjectiveValidationMessage", {
  questId: n.shieldTutorialQuestId,
  objectiveId: n.shieldTutorialQuestObjective
});
t.unloadContent();
this.itemBox.displayItem(e);
this.itemBox.show();
this.placeHolder.setText(null);
this.confirmBtn.enable();
this.quantity.setValue(1);
this._emitQuantityUpdating(1);
this.quantity.maxValue = Math.min(3e4, e.quantity);
this.quantity.enable();
this.minBtn.enable();
this.maxBtn.enable();
this._inputName = e.appendChild(new d({
  className: "inputName",
  attr: {
    type: "text",
    maxlength: p
  }
}, t));
this._inputName.on("change", function (e) {
  this.setValue(e.replace(/[^a-zA-Z]+/g, ""));
});
e.appendChild(new s(r("ui.common.ok"), {
  className: "okBtn"
}, t));
this.on("open", function (e) {
  this._previousName = e.name;
  this._mountId = e.mountId;
  this._inputName.setValue(e.name);
  e.inputBox && this._positionNextTo(e.inputBox);
});
this.on("opened", function () {
  this._inputName.focus();
});
this._previousName = e.name;
this._mountId = e.mountId;
this._inputName.setValue(e.name);
e.inputBox && this._positionNextTo(e.inputBox);
o(n, a);
e.exports = n;
n.prototype._validate = function () {
  var e = this._inputName.getValue() || "";
  e = e.replace(/[^a-zA-Z]+/g, "");
  this._inputName.setValue(e);
  e && this._previousName !== e && e.length >= h && e.length <= p && window.dofus.sendMessage("MountRenameRequestMessage", {
    name: e,
    mountId: this._mountId
  });
  c.close(this.id);
};
n.prototype._positionNextTo = function (e) {
  var t = u(e.rootElement);
  this.position.x = t.left - m;
  this.position.y = t.top - f;
};
e = e.replace(/[^a-zA-Z]+/g, "");
this._inputName.setValue(e);
e && this._previousName !== e && e.length >= h && e.length <= p && window.dofus.sendMessage("MountRenameRequestMessage", {
  name: e,
  mountId: this._mountId
});
c.close(this.id);
this.position.x = t.left - m;
this.position.y = t.top - f;
a.call(this, {
  className: "FamilyTreeWindow",
  positionInfo: {
    left: "c",
    top: "c",
    width: "688px",
    height: "511px"
  }
});
this._reset();
this.on("open", this._setMount);
o(n, a);
e.exports = n;
n.prototype._reset = function () {
  this._hasContent = !1;
  this._myMount = null;
  this._myMountName = null;
  this._ancestorBoxes = null;
};
n.prototype.freeContent = function () {
  this.windowBody.clearContent();
  this._reset();
};
n.prototype._createContent = function () {
  this._hasContent = !0;
  var e = this.windowBody.createChild("div", {
    className: "tree"
  });
  this._myMount = e.createChild("div", {
    className: ["mountDisplay", "myMount"]
  });
  this._myMountName = e.createChild("div", {
    className: "myMountName"
  });
  this._ancestorBoxes = [];
  for (var t = 3, i = 0, n = 1; n <= t; n += 1) {
    for (var o = i; i < Math.pow(2, n) + o; i += 1) {
      var a = ["mountDisplay", "ancestor_" + i, "geneMinus" + n];
      this._ancestorBoxes.push(e.createChild("div", {
        className: a
      }));
    }
  }
};
n.prototype._setMount = function (e) {
  this._hasContent || this._createContent();
  var t = e.ancestor || [],
    i = e.name || s("ui.common.noName");
  this.windowTitle.setText(s("ui.mount.ancestors", i));
  this._myMountName.setText(i);
  for (var n = ["gfx/mounts/" + e.model + ".png"], o = 0; o < t.length; o++) {
    t[o] && n.push("gfx/mounts/" + t[o] + ".png");
  }
  var a = this;
  r.preloadImages(n, function (e) {
    if (a._hasContent) {
      a._myMount.setStyle("backgroundImage", e[0]);
      for (var i = 1, n = 0; n < t.length; n++) {
        if (t[n]) {
          var o = e[i++];
          a._ancestorBoxes[n].setStyle("backgroundImage", o);
        } else {
          a._ancestorBoxes[n].setStyle("backgroundImage", "none");
        }
      }
    }
  });
};
this._hasContent = !1;
this._myMount = null;
this._myMountName = null;
this._ancestorBoxes = null;
this.windowBody.clearContent();
this._reset();
this._myMount = e.createChild("div", {
  className: ["mountDisplay", "myMount"]
});
this._myMountName = e.createChild("div", {
  className: "myMountName"
});
this._ancestorBoxes = [];
this.windowTitle.setText(s("ui.mount.ancestors", i));
this._myMountName.setText(i);
u.jobCrafterDirectorySettings = {
  jobId: u.job.id,
  minSlot: m,
  userDefinedParams: e()
};
window.dofus.sendMessage("JobCrafterDirectoryDefineSettingsMessage", {
  settings: u.jobCrafterDirectorySettings
});
u.payingCheckbox.toggleActivation(s);
u.freeOnFailCheckbox.toggleActivation(r);
u.noResourceCheckbox.toggleActivation(l);
u.publicButton.setText(c ? p : h);
u.jobsPublicMode[e] = c;
u.selector.clearContent();
u.jobCrafterDirectorySettings = {
  jobId: u.job.id,
  minSlot: m,
  userDefinedParams: e(!0)
};
window.dofus.sendMessage("JobCrafterDirectoryDefineSettingsMessage", {
  settings: u.jobCrafterDirectorySettings
});
n(u.job.id, !u.jobsPublicMode[u.job.id]);
this.once("open", function () {
  var e = u.windowBody.createChild("div", {
    className: "container"
  });
  e.createChild("div", {
    text: l("ui.craft.referencingOptions")
  });
  u.payingCheckbox = e.appendChild(new c(l("ui.craft.notFree")));
  u.freeOnFailCheckbox = e.appendChild(new c(l("ui.craft.freeIfFailed")));
  u.freeOnFailCheckbox.addClassNames("freeOnFail");
  u.noResourceCheckbox = e.appendChild(new c(l("ui.craft.ressourcesNeeded")));
  var i = e.createChild("div", {
    className: "selectorWrapper"
  });
  i.createChild("div", {
    className: "selectorLabel",
    text: l("ui.craft.minItemInCraft")
  });
  u.selector = i.appendChild(new d());
  u.selector.on("change", function (e) {
    m = Number(e);
  });
  var n = u.windowBody.createChild("div", {
    className: "buttons"
  });
  this.publicButton = n.appendChild(new r(h, {
    className: "publicButton"
  }));
  this.publicButton.on("tap", a);
  this.saveButton = n.appendChild(new r(l("ui.common.save"), {
    className: "saveButton"
  }));
  this.saveButton.on("tap", t);
  window.gui.playerData.jobs.on("jobPublicMode", function (e) {
    u.publicButton.setText(e ? p : h);
    u.jobsPublicMode[u.job.id] = e;
  });
});
this.on("open", function (e) {
  this.job = window.gui.playerData.jobs.list[e.jobId];
  this.freeOnFailCheckbox.toggleDisplay(!!this.job.info.specializationOfId);
  i(e.jobId);
});
window.gui.on("disconnect", function () {
  u.jobsPublicMode = {};
});
e.createChild("div", {
  text: l("ui.craft.referencingOptions")
});
u.payingCheckbox = e.appendChild(new c(l("ui.craft.notFree")));
u.freeOnFailCheckbox = e.appendChild(new c(l("ui.craft.freeIfFailed")));
u.freeOnFailCheckbox.addClassNames("freeOnFail");
u.noResourceCheckbox = e.appendChild(new c(l("ui.craft.ressourcesNeeded")));
i.createChild("div", {
  className: "selectorLabel",
  text: l("ui.craft.minItemInCraft")
});
u.selector = i.appendChild(new d());
u.selector.on("change", function (e) {
  m = Number(e);
});
this.publicButton = n.appendChild(new r(h, {
  className: "publicButton"
}));
this.publicButton.on("tap", a);
this.saveButton = n.appendChild(new r(l("ui.common.save"), {
  className: "saveButton"
}));
this.saveButton.on("tap", t);
window.gui.playerData.jobs.on("jobPublicMode", function (e) {
  u.publicButton.setText(e ? p : h);
  u.jobsPublicMode[u.job.id] = e;
});
u.publicButton.setText(e ? p : h);
u.jobsPublicMode[u.job.id] = e;
this.job = window.gui.playerData.jobs.list[e.jobId];
this.freeOnFailCheckbox.toggleDisplay(!!this.job.info.specializationOfId);
i(e.jobId);
a(n, s);
e.exports = n;
n.selectedSpellId = e.spellId;
n.selectedSpellName = e.spellName;
i.setStyle("backgroundImage", t);
u(i, function () {
  return new h({
    spell: e
  });
});
n.table.addRow({
  icon: i,
  name: e.spell.nameId,
  rank: e.level
}, {
  spellId: e.id,
  spellName: e.spell.nameId
});
this.selectedSpellId = null;
this.selectedSpellName = null;
this.table = this.windowBody.appendChild(new d({
  colIds: ["icon", "name", "rank"],
  colCount: 3,
  highlightable: !0,
  headerContent: ["", l("ui.common.spellName"), l("ui.social.guildRank")],
  onRowTap: e
}));
this.validButton = this.windowBody.appendChild(new r(l("ui.common.validation")));
this.validButton.on("tap", function () {
  n.selectedSpellId && window.gui.openConfirmPopup({
    title: l("ui.popup.warning"),
    message: l("ui.popup.spellForgetConfirm", n.selectedSpellName),
    cb: function (e) {
      e && window.dofus.sendMessage("ValidateSpellForgetMessage", {
        spellId: n.selectedSpellId
      });
    }
  });
});
this.on("open", function () {
  this.table.clearContent();
  var e = window.gui.playerData.characters.mainCharacter.spellData.getSpells(m.USABLE),
    t = [];
  for (var n in e) {
    var o = e[n];
    o.level > 1 && t.push(o);
  }
  i(t);
});
this.on("close", function () {
  this.selectedSpellId = null;
  this.selectedSpellName = null;
});
window.gui.on("SpellForgetUIMessage", function (e) {
  e.open ? a.openDialog("spellForget") : a.close("spellForget");
});
this.selectedSpellId = null;
this.selectedSpellName = null;
o(n, s);
e.exports = n;
_.call(this, "div", {
  className: e
});
this.myWindow = t;
D(this);
this.on("tap", i);
B.call(this, {
  title: "",
  noCloseButton: !0,
  className: "CharacterCreationWindow",
  positionInfo: {
    left: "c",
    top: "c",
    width: "100%",
    height: "100%",
    isFullScreen: !0,
    isModal: !0
  }
});
this.relookingParams = null;
this._reset();
this.on("open", function () {
  this.addClassNames(["disabled"]);
});
this.on("opened", this._initialize);
this._listenersSetup();
window.clearInterval(ye);
ye = null;
ve && ve.rootElement && (ve.setColor(ue, he), ve.myWindow._updateSprite());
ve.setColor(i);
ve.myWindow._updateSprite();
ge++;
Date.now() - _e >= me && h();
e._selectColor(this.id);
p(e.selectedColorBtn);
g(s, _);
s.prototype.setSelected = function (e) {
  e ? this.addClassNames("selected") : this.delClassNames("selected");
};
g(r, B);
e.exports = r;
r.prototype._reset = function () {
  h();
  this.step = ie;
  this.relookingParams = null;
  this._relookingPreviousValues = null;
  this.allBreeds = null;
  this.numBreeds = 0;
  this.headsMap = null;
  this.loadedHeads = [];
  this.lastRendering = 0;
  this._recommendedBreed = null;
  this._nameGeneratorUsed = !1;
  this._styleGeneratorUsed = !1;
  this.breedBtns = [];
  this.headContainers = [];
  this.nameInput = null;
  this.currentIllustration = null;
  this.breedIllustrationBg = this.breedIllustrationBgFade = null;
  this.breedBg = this.breedBgFade = null;
  this.breedDescription = null;
  this.breedName = null;
  this.breedStory = null;
  this.breedSelector = null;
  this.headSelector = null;
  this.colorPicker = null;
  this.colorButtons = null;
  this.selectedColor = null;
  this._currentColors = null;
  this._assetUrlCache = {};
  this.spriteStatus = {};
  this._breedId = 1;
  this._sex = re;
  this._cosmeticId = 1;
  this.headOrder = 0;
};
r.prototype._setStyles = function () {
  this.windowBody.setClassNames(["windowBody", n(this._breedId).bgClass]);
  this._updateBreedBg();
  this._updateBreedIllustration();
};
r.prototype.freeContent = function () {
  document.activeElement.blur();
  this.characterDisplay && this.characterDisplay.release();
  this.characterDisplay = null;
  this.windowBody.clearContent();
  this.centeredContent.clearContent();
  this._reset();
};
r.prototype._initialize = function (e) {
  if (!this.allBreeds) {
    var t = this;
    return void this._createAll(function (i) {
      return i ? console.error("characterCreation: initialize error", i) : (t._initialize(e), void t._loadHeadImages());
    });
  }
  this.relookingParams = e && e.relookingParams;
  this.relookingParams ? this._initCharacterForRelooking(e) : this._initCharacter(e);
  this.delClassNames(["disabled"]);
};
r.prototype._initCharacter = function (e) {
  this._stepLayoutSetup(ne);
  this.nameInput.setValue("");
  var t = Math.floor(Math.random() * ce),
    i = e.breedId ? e.breedId : 1;
  if (e.breedId) {
    this._recommendedBreed = e.breedId;
    this._sex = e.sex;
    t = l(this.headsMap, e.cosmeticId);
  } else {
    this._sex = Math.random() > .45 ? le : re;
    var n = Math.floor(Math.random() * this.numEasyBreeds),
      o = 0;
    for (i = 1; i <= this.numBreeds; i++) {
      if (!(this.allBreeds[i].complexity > 1)) {
        if (o === n) {
          break;
        }
        o++;
      }
    }
  }
  this.breedSexTabs.openTab(this._sex);
  this.headSexTabs.openTab(this._sex);
  this._buttonM.toggleClassName("on", this._sex === re);
  this._buttonF.toggleClassName("on", this._sex === le);
  this._selectBreed(i, t);
};
r.prototype._initCharacterForRelooking = function (e) {
  var t,
    i,
    n = this.relookingParams,
    o = n.characterToRemodel;
  this._relookingPreviousValues = {
    name: o.name,
    breed: o.breed,
    cosmeticId: o.cosmeticId,
    indexedColors: o.colors,
    sex: o.sex
  };
  var a = o.cosmeticId,
    s = o.breed;
  e.breedId ? (this._sex = e.sex, a = e.cosmeticId, s = e.breedId) : this.relookingParams.canRegender ? this._sex = o.sex ? re : le : this._sex = o.sex ? le : re;
  n.canRebreed ? (t = A("tablet.connection.rebreed"), i = A("tablet.charcrea.titleRebreed")) : n.canRename ? (t = A("ui.connection.rename"), i = A("ui.charcrea.titleRename")) : n.canRecolor ? (t = A("ui.connection.recolor"), i = A("ui.charcrea.titleRecolor")) : n.canReface && (t = A("ui.connection.relook"), i = A("ui.charcrea.titleRelook"));
  t && (window.gui.openSimplePopup(t, A("ui.popup.warning")), this.pageTitle.setText(i));
  var r = l(this.headsMap, a);
  this.nameInput.setValue(o.name);
  this._buttonM.toggleClassName("on", this._sex === re);
  this._buttonF.toggleClassName("on", this._sex === le);
  this.breedSexTabs.openTab(this._sex);
  this.headSexTabs.openTab(this._sex);
  n.canRebreed ? this._stepLayoutSetup(ne) : this._stepLayoutSetup(oe);
  this._currentColors = o.colors;
  this._selectBreed(s, r, o.colors);
  n.canRecolor && this._selectColor(0);
};
r.prototype._createAll = function (e) {
  this.allBreeds = window.gui.databases.Breeds;
  this.numBreeds = Object.keys(this.allBreeds).length;
  this.numEasyBreeds = 0;
  for (var t = this, i = 1; i <= this.numBreeds; i++) {
    var n = X[i - 1];
    this.allBreeds[i].complexity = n;
    1 === n && this.numEasyBreeds++;
  }
  this.breedBg = this.windowBody.createChild("div", {
    className: "breedBg"
  });
  this.breedBgFade = this.windowBody.createChild("div", {
    className: "breedBg"
  });
  this._leftSideSetup();
  this._centerSetup();
  this._rightSideSetup();
  this._createBreedElements();
  this._createHeadElements();
  this._createNavButtons();
  var a = this._footer = this.windowBody.createChild("div", {
    className: "footer"
  });
  a.createChild("div", {
    className: "effect"
  });
  var s = a.createChild("div", {
      className: "contentWrapper"
    }),
    r = s.createChild("div", {
      className: "icons"
    });
  this._icons = [];
  for (var l = 1; l <= $; l++) {
    var c = r.createChild("div", {
      className: ["icon", "role" + l]
    });
    P.addTooltip(c, o(l), {
      longTapExplanation: !0
    });
    c.id = l;
    c.hide();
    this._icons.push(c);
  }
  var d = s.createChild("div", {
      className: "texts"
    }),
    u = d.createChild("div", {
      className: "titleWrapper"
    });
  D(u);
  u.on("tap", function () {
    k.open("breedDetail", {
      breedData: t.allBreeds[t._breedId]
    });
  });
  this._breedTitle = u.createChild("div", {
    className: "title"
  });
  this.moreInfoBtn = u.createChild("div", {
    className: "moreInfoBtn"
  });
  this._breedDescription = d.createChild("div", {
    className: "breedDescription"
  });
  a.createChild("div", {
    className: "background"
  });
  this._breedComplexity = s.createChild("div", {
    className: "breedComplexity"
  });
  this._breedComplexity.createChild("div", {
    className: "label",
    text: A("tablet.charCrea.difficulty") + A("ui.common.colon")
  });
  this._breedComplexity.createChild("div", {
    className: ["sword", "sword1"]
  });
  this._breedComplexity.createChild("div", {
    className: ["sword", "sword2"]
  });
  this._breedComplexity.createChild("div", {
    className: ["sword", "sword3"]
  });
  this._stepLayoutSetup(ne);
  this._loadAsyncData(e);
};
r.prototype._leftSideSetup = function () {
  this.breedIllustrationWrapper = this.windowBody.createChild("div", {
    className: "breedIllustration"
  });
  this.breedIllustrationBg = this.breedIllustrationWrapper.createChild("div", {
    className: "breedIllustrationBg"
  });
  this.breedIllustrationBgFade = this.breedIllustrationWrapper.createChild("div", {
    className: "breedIllustrationBg"
  });
};
r.prototype._centerSetup = function () {
  function e() {
    i._sex !== this._sex && (i.headSexTabs.openTab(this._sex), i.breedSexTabs.openTab(this._sex));
  }
  function t() {
    return k.closeAll(), k.open("firstCharacterForm", {
      skipIntro: !0,
      relookingParams: i.relookingParams
    });
  }
  this.centeredContent || (this.centeredContent = this.createChild("div", {
    className: "content"
  }));
  var i = this,
    n = this.centeredContent;
  this._createTopLabel(n);
  this._characterCustomContent = n.createChild("div", {
    className: "characterCustomContent"
  });
  this.headSelector = this._createSelector(this._characterCustomContent, "headSexTabs");
  this._setupColorTool(this._characterCustomContent);
  this._createNameSelector(this._characterCustomContent);
  this._breedSelectorWrapper = n.createChild("div", {
    className: "breedSexTabsWrapper"
  });
  this.breedSelector = this._createSelector(this._breedSelectorWrapper, "breedSexTabs");
  var o = this._breedSelectorWrapper.createChild("div", {
    className: "buttonCharacterWrapper"
  });
  this._buttonM = o.appendChild(new w({
    className: ["sexBtn", "sexM"]
  }, e));
  this._buttonM._sex = re;
  this._buttonF = o.appendChild(new w({
    className: ["sexBtn", "sexF"]
  }, e));
  this._buttonF._sex = le;
  this._breedSelectorWrapper.createChild("div", {
    className: "space"
  });
  var a = this._breedSelectorWrapper.createChild("div", {
    className: "buttonWrapper"
  });
  a.appendChild(new w({
    text: A("ui.charcrea.recommendation"),
    className: ["blackButton", "recommendationBtn"]
  }, function () {
    t();
  }));
  a.appendChild(new w({
    text: A("tablet.charCrea.next"),
    className: ["greenButton", "nextBtn"]
  }, function () {
    i._next();
  }));
};
r.prototype._rightSideSetup = function () {
  this._rightbar = this.windowBody.createChild("div", {
    className: "rightBar"
  });
  this._setupCharacterOnIsland(this._rightbar);
};
r.prototype._rightSideUpdatePosition = function (e) {
  var t = U(this._characterCustomContent.rootElement),
    i = U(this.checkerboardImage.rootElement),
    n = e ? (t.x - (i.width + 80) / 2) / 2 : 0,
    o = e ? i.y - i.height / 2 : 0;
  this._rightbar.setStyle("transform", "translate(" + n + "px," + o + "px)");
};
r.prototype._stepLayoutSetup = function (e) {
  this.step = e;
  var t = e === oe,
    i = e === ne;
  this.characterOnIsland.toggleDisplay(i || t);
  this._footer.toggleDisplay(i);
  var n = U(this.rootElement);
  i && (.3 * n.width < .52 * n.height ? (this._breedSelectorWrapper.setStyle("width", .3 * n.width + "px"), this.breedSexTabs.setStyle("height", .3 * n.width + "px")) : (this._breedSelectorWrapper.setStyle("width", .52 * n.height + "px"), this.breedSexTabs.setStyle("height", .52 * n.height + "px")));
  this._breedSelectorWrapper.toggleDisplay(i);
  this.breedIllustrationWrapper.toggleDisplay(i);
  this._characterCustomContent.toggleDisplay(t);
  this._rightSideUpdatePosition(t);
  i ? this.backButton.setText(A("ui.common.cancel")) : t && (this.headSexTabs.toggleTabAvailability(re, this._sex === re), this.headSexTabs.toggleTabAvailability(le, this._sex === le), this._selectCurrentHeads(), this.relookingParams ? (this._allowElement(this.headSexTabs, this.relookingParams.canRegender), this._allowElement(this.nameSelector, this.relookingParams.canRename, K), this._allowElement(this.colorTool, this.relookingParams.canRecolor, J), this.createBtn.setText(A("ui.common.validation")), this.backButton.setText(A("ui.common.cancel"))) : (this._selectColor(0, !0), this.backButton.setText(A("ui.common.back"))));
};
r.prototype._allowElement = function (e, t, i) {
  if (e.toggleTabAvailability) {
    var n = this._sex === re,
      o = e.header.getChildren(),
      a = o[n ? le : re],
      s = o[this._sex],
      r = e.content;
    return this._allowElement(a, this.relookingParams.canRegender, Z), this._allowElement(s, this.relookingParams.canReface), this._allowElement(r, this.relookingParams.canReface, Q), e.toggleTabAvailability(re, this.relookingParams.canRegender && this._sex === re), void e.toggleTabAvailability(le, this.relookingParams.canRegender && this._sex === le);
  }
  if (e.toggleClassName("disabled", !t), !t) {
    var l = e.appendChild(new _("div", {
      className: "disabledFeature"
    }));
    i && (l.itemId = i, D(l), l.on("tap", c));
  }
};
r.prototype._next = function () {
  this._stepLayoutSetup(oe);
};
r.prototype._canStepBack = function () {
  return this.step !== ne && !(this.relookingParams && !this.relookingParams.canRebreed);
};
r.prototype._back = function () {
  this._canStepBack() ? this._stepLayoutSetup(ne) : (k.close(this.id), T.backToSelection());
};
r.prototype._createSelector = function (e, t, i) {
  var n = {};
  n.females = new _("div", {
    className: "females"
  });
  n.males = new _("div", {
    className: "males"
  });
  var o = e.appendChild(new R({
    className: ["sexTabs", t],
    tabClassName: "mySwipeTabBtn"
  }));
  i && o.hide();
  o.addTab("", n.males, re);
  o.addTab("", n.females, le);
  var a = this;
  return o.on("openTab", function (e) {
    a._updateSex(e);
  }), this[t] = o, n;
};
r.prototype._createBreedButton = function (e, t) {
  var i = new s(["breedSelectionButton", "classe" + e.id], this, d);
  i.breedId = e.id;
  var n = t === re ? this.breedSelector.males : this.breedSelector.females;
  return n.appendChild(i), i;
};
r.prototype._createHeadContainer = function (e, t) {
  var i = new _("div", {
      className: "headContainer"
    }),
    n = 1 + (e - 1) * ce * 2 + t * ce;
  i.buttons = [];
  for (var o = 0; o < ce; o++) {
    var a = new s("headSelectionButton", this, u);
    i.appendChild(a);
    i.buttons.push(a);
    a.headOrder = o;
    a.cosmeticId = n + o;
    a.gender = t;
  }
  var r = t === re ? this.headSelector.males : this.headSelector.females;
  return r.appendChild(i), i;
};
r.prototype._createBreedElements = function () {
  var e = [];
  Object.keys(window.gui.databases.Breeds).forEach(function (t) {
    e.push(window.gui.databases.Breeds[t]);
  });
  for (var t = e.sort(function (e, t) {
      return e.complexity < t.complexity ? -1 : t.complexity < e.complexity ? 1 : 0;
    }), i = 0; i < t.length; i++) {
    var n = t[i],
      o = n.id;
    this.breedBtns[o] = this._createBreedButton(n, re);
    this.breedBtns[o + this.numBreeds] = this._createBreedButton(n, le);
  }
};
r.prototype._createHeadElements = function () {
  for (var e = 1; e <= this.numBreeds; e++) {
    this.headContainers[e] = [this._createHeadContainer(e, re), this._createHeadContainer(e, le)];
  }
};
r.prototype._loadAsyncData = function (e) {
  var t = this;
  O.getAllDataMap("Heads", function (i, n) {
    return i ? e(i) : (t.headsMap = n, void e());
  });
};
r.prototype._loadHeadImages = function (e, t) {
  if (this.loadedHeads[e]) {
    return t && t();
  }
  var i, n;
  e ? (i = 1 + (e - 1) * ce * 2, n = i + 2 * ce - 1, this.loadedHeads[e] = !0) : (i = 1, n = this.numBreeds * ce * 2);
  for (var o = this.headsMap, a = [], s = i; s <= n; s++) {
    a.push("gfx/cosmetics/" + o[~~s].assetId + ".png");
  }
  var r = this;
  v.preloadImages(a, function (a) {
    if (!r.headContainers.length) {
      return t && t();
    }
    if (!e) {
      for (var s = 1; s <= r.numBreeds; s++) {
        r.loadedHeads[s] = !0;
      }
    }
    for (var l = 0, c = i; c <= n; c++) {
      var d = o[~~c],
        u = r.headContainers[d.breed][d.gender].buttons[d.order];
      u.setStyle("backgroundImage", a[l++]);
    }
    return t && t();
  });
};
r.prototype._listenersSetup = function () {
  var e = this;
  window.gui.on("CharacterCreationResultMessage", function (t) {
    if (t.result === b.OK) {
      T.confirmNewCharacterCreation();
      var i = e.nameInput.getValue(!0);
      return q.log("F_T_U_E.creates_new_character", {
        timestamp_event: new Y.DofusDate(Y.now()).getServerDate().timestamp,
        recommanded_breed_id: e._recommendedBreed,
        chosen_breed_id: e._breedId,
        gender_chosen: e._sex,
        face_id_chosen: e._cosmeticId,
        has_used_name_generator: e._nameGeneratorUsed,
        has_used_style_generator: e._styleGeneratorUsed,
        character_name: i
      }), k.close(e.id);
    }
    var n;
    switch (t.result) {
      case b.ERR_INVALID_NAME:
        n = A("ui.charcrea.nameRules");
        break;
      case b.ERR_NAME_ALREADY_EXISTS:
        n = A("ui.popup.charcrea.nameAlreadyExist");
        break;
      case b.ERR_TOO_MANY_CHARACTERS:
        n = A("ui.popup.charcrea.tooManyCharacters");
        break;
      case b.ERR_NOT_ALLOWED:
        n = A("ui.popup.charcrea.notSubscriber");
        break;
      case b.ERR_RESTRICED_ZONE:
        n = A("ui.charSel.deletionErrorUnsecureMode");
        break;
      default:
        n = A("ui.popup.charcrea.noReason");
    }
    P.showNotification(n, e.createBtn);
    e.delClassNames(["disabled"]);
  });
  window.gui.on("CharacterNameSuggestionSuccessMessage", function (t) {
    e.nameInput && e.nameInput.setValue(t.suggestion, !0);
  });
};
r.prototype.backButtonClose = function () {
  this._back();
};
r.prototype._buildColorsArray = function () {
  for (var e = new Array(y.CHARACTER_COLORS), t = [], i = 0; i < y.CHARACTER_COLORS; i++) {
    var n = this.colorButtons[i],
      o = n.getColor(),
      a = I.getIndexedColor(i + 1, o.rgb[0], o.rgb[1], o.rgb[2]);
    e[i] = a;
    t.push(n.isCustomColor() ? a : null);
  }
  return this._currentColors = t, e;
};
r.prototype._selectCurrentHeads = function () {
  if (this.headSexTabs.isVisible()) {
    for (var e = 1, t = this.numBreeds; e <= t; e++) {
      this.headContainers[e][re].hide();
      this.headContainers[e][le].hide();
    }
    this.headContainers[this._breedId][re].show();
    this.headContainers[this._breedId][le].show();
  }
};
r.prototype._updateSprite = function (e) {
  var t = this.allBreeds[this._breedId],
    i = G.parseLook(W, t[(this._sex === le ? "female" : "male") + "Look"], "Breed: " + this._breedId + " sex: " + this._sex),
    n = i.skin,
    o = i.scale,
    a = this.headsMap[this._cosmeticId].skins,
    s = this._buildColorsArray().join("#");
  this.spriteStatus.bodySkin === n && this.spriteStatus.headSkin === a && this.spriteStatus.colorsHash === s && this.spriteStatus.orientation === this.orientation && this.spriteStatus.scale === o || (this.spriteStatus.bodySkin = n, this.spriteStatus.headSkin = a, this.spriteStatus.colorsHash = s, this.spriteStatus.orientation = this.orientation, this.spriteStatus.scale = o, this._drawCharacter(e));
};
r.prototype._getAsset = function (e, t) {
  var i = this;
  return this._assetUrlCache[e] ? t(this._assetUrlCache[e]) : void v.preloadImage(e, function (n) {
    i._assetUrlCache[e] = n;
    t(n);
  });
};
r.prototype._updateBreedIllustration = function () {
  if (this.breedIllustrationBg.isVisible()) {
    var e = this.breedIllustrationBg;
    this.breedIllustrationBg = this.breedIllustrationBgFade;
    this.breedIllustrationBgFade = e;
    var t = "breed" + this._breedId;
    this.breedIllustrationBg.setClassNames(["breedIllustrationBg", t]);
    L(this.breedIllustrationBg, 500, null, this.breedIllustrationBgFade);
  }
};
r.prototype._updateBreedBg = function () {
  var e = this.breedBg;
  this.breedBg = this.breedBgFade;
  this.breedBgFade = e;
  var t = n(this._breedId).bgClass;
  this.breedBg.setClassNames(["breedBg", t]);
  L(this.breedBg, 500, null, this.breedBgFade);
};
r.prototype._updateBreedIsland = function () {
  var e = this;
  this._getAsset("gfx/bases/base_" + this._breedId + ".png", function () {
    if (e.characterDisplay) {
      var t = ee[e._breedId];
      t || (console.warn("Missing center tile data for breed:", e._breedId), t = te);
      L(e.checkerboardImage);
      L(e.rotationLeft);
      L(e.rotationRight);
    }
  });
};
r.prototype._updateBreedDescription = function () {
  var e = this.allBreeds[this._breedId];
  this._breedTitle.setText(e.longNameId);
  this._breedDescription.setText(e.gameplayDescriptionId);
  var t = this;
  this._icons.forEach(function (e) {
    var i = n(t._breedId).roles.indexOf(e.id) > -1;
    e.toggleDisplay(i);
  });
  this._breedComplexity.replaceClassNames(["level1", "level2", "level3"], ["level" + e.complexity]);
};
r.prototype._toggleBreedBtn = function (e, t) {
  this.breedBtns[e].setSelected(t);
  this.breedBtns[e + this.numBreeds].setSelected(t);
};
r.prototype._selectBreed = function (e, t, i) {
  this._toggleBreedBtn(this._breedId, !1);
  this._toggleBreedBtn(e, !0);
  this._breedId = e;
  this._setStyles();
  this.characterDisplay.setStyle("opacity", 0);
  this._updateBreedIsland();
  this._updateBreedDescription();
  this._selectCurrentHeads();
  this._loadHeadImages(e);
  this._selectHead(void 0 !== t ? t : this.headOrder);
  i ? this._loadColors(i, !0) : this._resetColors();
  this.orientation = ae;
  this._updateSprite(!0);
};
r.prototype._updateSex = function (e) {
  this._sex !== e && (this._sex = e, this._selectCurrentHeads(), this._selectHead(this.headOrder), this._buttonM.toggleClassName("on", e === re), this._buttonF.toggleClassName("on", e === le), this._updateSprite(!0));
};
r.prototype._selectHead = function (e, t) {
  var i = this.headContainers[this._breedId][this._sex].buttons[e];
  if (i.cosmeticId !== this._cosmeticId) {
    this._cosmeticId = i.cosmeticId;
    this.headOrder = e;
    for (var n = this.headContainers[this._breedId][this._sex].buttons, o = 0; o < n.length; o++) {
      n[o].setSelected(n[o] === i);
    }
    t && this._updateSprite(!1);
  }
};
h();
this.step = ie;
this.relookingParams = null;
this._relookingPreviousValues = null;
this.allBreeds = null;
this.numBreeds = 0;
this.headsMap = null;
this.loadedHeads = [];
this.lastRendering = 0;
this._recommendedBreed = null;
this._nameGeneratorUsed = !1;
this._styleGeneratorUsed = !1;
this.breedBtns = [];
this.headContainers = [];
this.nameInput = null;
this.currentIllustration = null;
this.breedIllustrationBg = this.breedIllustrationBgFade = null;
this.breedBg = this.breedBgFade = null;
this.breedDescription = null;
this.breedName = null;
this.breedStory = null;
this.breedSelector = null;
this.headSelector = null;
this.colorPicker = null;
this.colorButtons = null;
this.selectedColor = null;
this._currentColors = null;
this._assetUrlCache = {};
this.spriteStatus = {};
this._breedId = 1;
this._sex = re;
this._cosmeticId = 1;
this.headOrder = 0;
this.windowBody.setClassNames(["windowBody", n(this._breedId).bgClass]);
this._updateBreedBg();
this._updateBreedIllustration();
document.activeElement.blur();
this.characterDisplay && this.characterDisplay.release();
this.characterDisplay = null;
this.windowBody.clearContent();
this.centeredContent.clearContent();
this._reset();
this.relookingParams = e && e.relookingParams;
this.relookingParams ? this._initCharacterForRelooking(e) : this._initCharacter(e);
this.delClassNames(["disabled"]);
this._stepLayoutSetup(ne);
this.nameInput.setValue("");
this._recommendedBreed = e.breedId;
this._sex = e.sex;
t = l(this.headsMap, e.cosmeticId);
this.breedSexTabs.openTab(this._sex);
this.headSexTabs.openTab(this._sex);
this._buttonM.toggleClassName("on", this._sex === re);
this._buttonF.toggleClassName("on", this._sex === le);
this._selectBreed(i, t);
e.breedId ? (this._sex = e.sex, a = e.cosmeticId, s = e.breedId) : this.relookingParams.canRegender ? this._sex = o.sex ? re : le : this._sex = o.sex ? le : re;
n.canRebreed ? (t = A("tablet.connection.rebreed"), i = A("tablet.charcrea.titleRebreed")) : n.canRename ? (t = A("ui.connection.rename"), i = A("ui.charcrea.titleRename")) : n.canRecolor ? (t = A("ui.connection.recolor"), i = A("ui.charcrea.titleRecolor")) : n.canReface && (t = A("ui.connection.relook"), i = A("ui.charcrea.titleRelook"));
t && (window.gui.openSimplePopup(t, A("ui.popup.warning")), this.pageTitle.setText(i));
this.nameInput.setValue(o.name);
this._buttonM.toggleClassName("on", this._sex === re);
this._buttonF.toggleClassName("on", this._sex === le);
this.breedSexTabs.openTab(this._sex);
this.headSexTabs.openTab(this._sex);
n.canRebreed ? this._stepLayoutSetup(ne) : this._stepLayoutSetup(oe);
this._currentColors = o.colors;
this._selectBreed(s, r, o.colors);
n.canRecolor && this._selectColor(0);
this.allBreeds = window.gui.databases.Breeds;
this.numBreeds = Object.keys(this.allBreeds).length;
this.numEasyBreeds = 0;
this.allBreeds[i].complexity = n;
1 === n && this.numEasyBreeds++;
this.breedBg = this.windowBody.createChild("div", {
  className: "breedBg"
});
this.breedBgFade = this.windowBody.createChild("div", {
  className: "breedBg"
});
this._leftSideSetup();
this._centerSetup();
this._rightSideSetup();
this._createBreedElements();
this._createHeadElements();
this._createNavButtons();
P.addTooltip(c, o(l), {
  longTapExplanation: !0
});
c.id = l;
c.hide();
this._icons.push(c);
D(u);
u.on("tap", function () {
  k.open("breedDetail", {
    breedData: t.allBreeds[t._breedId]
  });
});
this._breedTitle = u.createChild("div", {
  className: "title"
});
this.moreInfoBtn = u.createChild("div", {
  className: "moreInfoBtn"
});
this._breedDescription = d.createChild("div", {
  className: "breedDescription"
});
a.createChild("div", {
  className: "background"
});
this._breedComplexity = s.createChild("div", {
  className: "breedComplexity"
});
this._breedComplexity.createChild("div", {
  className: "label",
  text: A("tablet.charCrea.difficulty") + A("ui.common.colon")
});
this._breedComplexity.createChild("div", {
  className: ["sword", "sword1"]
});
this._breedComplexity.createChild("div", {
  className: ["sword", "sword2"]
});
this._breedComplexity.createChild("div", {
  className: ["sword", "sword3"]
});
this._stepLayoutSetup(ne);
this._loadAsyncData(e);
this.breedIllustrationWrapper = this.windowBody.createChild("div", {
  className: "breedIllustration"
});
this.breedIllustrationBg = this.breedIllustrationWrapper.createChild("div", {
  className: "breedIllustrationBg"
});
this.breedIllustrationBgFade = this.breedIllustrationWrapper.createChild("div", {
  className: "breedIllustrationBg"
});
this._createTopLabel(n);
this._characterCustomContent = n.createChild("div", {
  className: "characterCustomContent"
});
this.headSelector = this._createSelector(this._characterCustomContent, "headSexTabs");
this._setupColorTool(this._characterCustomContent);
this._createNameSelector(this._characterCustomContent);
this._breedSelectorWrapper = n.createChild("div", {
  className: "breedSexTabsWrapper"
});
this.breedSelector = this._createSelector(this._breedSelectorWrapper, "breedSexTabs");
this._buttonM = o.appendChild(new w({
  className: ["sexBtn", "sexM"]
}, e));
this._buttonM._sex = re;
this._buttonF = o.appendChild(new w({
  className: ["sexBtn", "sexF"]
}, e));
this._buttonF._sex = le;
this._breedSelectorWrapper.createChild("div", {
  className: "space"
});
a.appendChild(new w({
  text: A("ui.charcrea.recommendation"),
  className: ["blackButton", "recommendationBtn"]
}, function () {
  t();
}));
a.appendChild(new w({
  text: A("tablet.charCrea.next"),
  className: ["greenButton", "nextBtn"]
}, function () {
  i._next();
}));
this._rightbar = this.windowBody.createChild("div", {
  className: "rightBar"
});
this._setupCharacterOnIsland(this._rightbar);
this.characterOnIsland.toggleDisplay(i || t);
this._footer.toggleDisplay(i);
i && (.3 * n.width < .52 * n.height ? (this._breedSelectorWrapper.setStyle("width", .3 * n.width + "px"), this.breedSexTabs.setStyle("height", .3 * n.width + "px")) : (this._breedSelectorWrapper.setStyle("width", .52 * n.height + "px"), this.breedSexTabs.setStyle("height", .52 * n.height + "px")));
this._breedSelectorWrapper.toggleDisplay(i);
this.breedIllustrationWrapper.toggleDisplay(i);
this._characterCustomContent.toggleDisplay(t);
this._rightSideUpdatePosition(t);
i ? this.backButton.setText(A("ui.common.cancel")) : t && (this.headSexTabs.toggleTabAvailability(re, this._sex === re), this.headSexTabs.toggleTabAvailability(le, this._sex === le), this._selectCurrentHeads(), this.relookingParams ? (this._allowElement(this.headSexTabs, this.relookingParams.canRegender), this._allowElement(this.nameSelector, this.relookingParams.canRename, K), this._allowElement(this.colorTool, this.relookingParams.canRecolor, J), this.createBtn.setText(A("ui.common.validation")), this.backButton.setText(A("ui.common.cancel"))) : (this._selectColor(0, !0), this.backButton.setText(A("ui.common.back"))));
n.females = new _("div", {
  className: "females"
});
n.males = new _("div", {
  className: "males"
});
i && o.hide();
o.addTab("", n.males, re);
o.addTab("", n.females, le);
i.appendChild(a);
i.buttons.push(a);
a.headOrder = o;
a.cosmeticId = n + o;
a.gender = t;
this.breedBtns[o] = this._createBreedButton(n, re);
this.breedBtns[o + this.numBreeds] = this._createBreedButton(n, le);
window.gui.on("CharacterCreationResultMessage", function (t) {
  if (t.result === b.OK) {
    T.confirmNewCharacterCreation();
    var i = e.nameInput.getValue(!0);
    return q.log("F_T_U_E.creates_new_character", {
      timestamp_event: new Y.DofusDate(Y.now()).getServerDate().timestamp,
      recommanded_breed_id: e._recommendedBreed,
      chosen_breed_id: e._breedId,
      gender_chosen: e._sex,
      face_id_chosen: e._cosmeticId,
      has_used_name_generator: e._nameGeneratorUsed,
      has_used_style_generator: e._styleGeneratorUsed,
      character_name: i
    }), k.close(e.id);
  }
  var n;
  switch (t.result) {
    case b.ERR_INVALID_NAME:
      n = A("ui.charcrea.nameRules");
      break;
    case b.ERR_NAME_ALREADY_EXISTS:
      n = A("ui.popup.charcrea.nameAlreadyExist");
      break;
    case b.ERR_TOO_MANY_CHARACTERS:
      n = A("ui.popup.charcrea.tooManyCharacters");
      break;
    case b.ERR_NOT_ALLOWED:
      n = A("ui.popup.charcrea.notSubscriber");
      break;
    case b.ERR_RESTRICED_ZONE:
      n = A("ui.charSel.deletionErrorUnsecureMode");
      break;
    default:
      n = A("ui.popup.charcrea.noReason");
  }
  P.showNotification(n, e.createBtn);
  e.delClassNames(["disabled"]);
});
window.gui.on("CharacterNameSuggestionSuccessMessage", function (t) {
  e.nameInput && e.nameInput.setValue(t.suggestion, !0);
});
P.showNotification(n, e.createBtn);
e.delClassNames(["disabled"]);
e[i] = a;
t.push(n.isCustomColor() ? a : null);
this.headContainers[e][re].hide();
this.headContainers[e][le].hide();
this.headContainers[this._breedId][re].show();
this.headContainers[this._breedId][le].show();
i._assetUrlCache[e] = n;
t(n);
this.breedIllustrationBg = this.breedIllustrationBgFade;
this.breedIllustrationBgFade = e;
this.breedIllustrationBg.setClassNames(["breedIllustrationBg", t]);
L(this.breedIllustrationBg, 500, null, this.breedIllustrationBgFade);
this.breedBg = this.breedBgFade;
this.breedBgFade = e;
this.breedBg.setClassNames(["breedBg", t]);
L(this.breedBg, 500, null, this.breedBgFade);
t || (console.warn("Missing center tile data for breed:", e._breedId), t = te);
L(e.checkerboardImage);
L(e.rotationLeft);
L(e.rotationRight);
this._breedTitle.setText(e.longNameId);
this._breedDescription.setText(e.gameplayDescriptionId);
this._icons.forEach(function (e) {
  var i = n(t._breedId).roles.indexOf(e.id) > -1;
  e.toggleDisplay(i);
});
this._breedComplexity.replaceClassNames(["level1", "level2", "level3"], ["level" + e.complexity]);
this.breedBtns[e].setSelected(t);
this.breedBtns[e + this.numBreeds].setSelected(t);
this._toggleBreedBtn(this._breedId, !1);
this._toggleBreedBtn(e, !0);
this._breedId = e;
this._setStyles();
this.characterDisplay.setStyle("opacity", 0);
this._updateBreedIsland();
this._updateBreedDescription();
this._selectCurrentHeads();
this._loadHeadImages(e);
this._selectHead(void 0 !== t ? t : this.headOrder);
i ? this._loadColors(i, !0) : this._resetColors();
this.orientation = ae;
this._updateSprite(!0);
this._cosmeticId = i.cosmeticId;
this.headOrder = e;
r.prototype._colorChanged = function (e) {
  this.selectedColorBtn && (this.selectedColorBtn.setColor(e, !0), this._updateSprite());
};
r.prototype._setupColorTool = function (e) {
  var t = this.colorTool = e.createChild("div", {
      className: "colorTool"
    }),
    i = this.colorSelector = t.createChild("div", {
      className: "colorSelector"
    }),
    n = i.createChild("div", {
      className: "colorButtons"
    }),
    o = n.createChild("div", {
      className: "buttonBox"
    });
  this.colorButtons = new Array(y.CHARACTER_COLORS + 1);
  for (var s = 0; s <= y.CHARACTER_COLORS; s++) {
    this.colorButtons[s] = o.appendChild(new N(this, s, m, {
      active: s < y.CHARACTER_COLORS
    }));
  }
  this.selectedColorBtn = null;
  var r = i.createChild("div", {
    className: "picker"
  });
  this.colorPicker = r.appendChild(new C());
  var l = this;
  this.colorPicker.on("newColor", function (e) {
    if (l.selectedColorBtn) {
      l.selectedColorBtn.setColor(e, !0);
      var t = Date.now();
      (!l.colorPicker.lastUpdate || t - l.colorPicker.lastUpdate > se) && (l.colorPicker.lastUpdate = t, l._updateSprite());
    }
  });
  this.colorPicker.on("colorChanged", function (e) {
    l._colorChanged(e);
  });
  var c = this.colorPickerFooter = t.createChild("div", {
    className: "colorPickerFooter"
  });
  c.appendChild(new a("resetColorBtn", "", A("tablet.charCrea.resetCurrentColor"), function () {
    return l.selectedColorBtn && l.selectedColorBtn.getColor() ? (l._resetColorButton(l.selectedColorBtn), l._selectColor(l.selectedColorBtn.id, !0), void l._updateSprite()) : P.showNotification(A("tablet.charCrea.resetCurrentColor"), this);
  }, !0));
  c.appendChild(new a("randomColorBtn", A("tablet.charCrea.randomColors"), A("tablet.charCrea.randomColorsTip"), function () {
    l._styleGeneratorUsed = !0;
    for (var e = 0; e < y.CHARACTER_COLORS; e++) {
      l.colorButtons[e].randomize();
    }
    l._selectColor(0, !0);
    l._updateSprite();
  }, !0));
  c.appendChild(new a("resetAllColorBtn", A("tablet.charCrea.resetAll"), A("tablet.charCrea.resetAllTip"), function () {
    l._resetColors();
    l._updateSprite();
    l._currentColors = null;
  }));
  var d = this.colorPicker.appendChild(new S());
  d.on("confirm", function (e) {
    var t = I.hexToRgb(e);
    t && (l.colorPicker.setCurrentColor([t.r, t.g, t.b]), l._colorChanged(l.colorPicker.getCurrentColor()));
  });
  c.appendChild(new a("hexColorBtn", "#", A("ui.charcrea.hexColorTip"), function () {
    l.colorPicker.openHexInput();
  }));
  var u = this.pickerRect = U(r.rootElement);
  this.colorPicker.updateDimensions(u.width - 10, u.height - 60);
};
r.prototype._createTopLabel = function (e) {
  var t = this.topLabel = e.createChild("div", {
    className: "topLabel"
  });
  t.createChild("div", {
    className: "topLabelBackground"
  });
  t.createChild("div", {
    className: "fioritureRococo"
  });
  this.pageTitle = t.createChild("div", {
    className: "topLabelText",
    text: A("ui.charcrea.title")
  });
};
r.prototype._createNameSelector = function (e) {
  var t = this,
    i = this.nameSelector = e.createChild("div", {
      className: "nameSelector"
    }),
    n = this.nameErrWrapper = i.createChild("div", {
      className: "nameErrors"
    }),
    o = n.appendChild(new H());
  this.nameInput = i.appendChild(new F({
    className: "nameInput",
    attr: {
      type: "text",
      id: "nameInput",
      maxlength: x.MAX_PLAYER_NAME_LEN
    },
    onChangeRules: V,
    onSubmitRules: j,
    blockInvalidInput: !1
  }, function (e) {
    e.blur();
  }));
  this.nameInput.setPlaceholder(A("ui.popup.charcrea.noName"));
  this.nameInput.on("validationFailed", function (e) {
    if (t._needsNameCheck()) {
      var i = [];
      e.forEach(function (e) {
        i.push(" - " + A(e.error));
      });
      i.length > 0 && o.setText(i.join("\n"));
    }
  });
  this.nameInput.on("validationPassed", function () {
    o.setText("");
  });
  this.randomiseBtn = i.appendChild(new a("randomiseBtn", "", A("tablet.charCrea.randomNameTip"), function () {
    t._nameGeneratorUsed = !0;
    window.dofus.sendMessage("CharacterNameSuggestionRequestMessage");
  }, !0));
  this.randomiseBtn.createChild("div", {
    className: "text",
    text: A("ui.charcrea.randomName")
  });
};
r.prototype._createRotationButton = function (e, t) {
  var i = this,
    n = this.characterOnIsland.createChild("div", {
      className: e,
      hidden: !0
    }),
    o = n.appendChild(new w({
      className: "shadow",
      repeatDelay: 100
    }, function () {
      i.orientation = i.characterDisplay.rotateCharacter(t);
    }));
  return o.createChild("div", {
    className: "arrow"
  }), n;
};
r.prototype._setupCharacterOnIsland = function (e) {
  var t = this.characterOnIsland = e.createChild("div", {
    className: "characterOnIsland"
  });
  this.checkerboardImage = t.createChild("div", {
    className: "checkerboardImage"
  });
  this.characterDisplay = t.appendChild(new M({
    scale: 3
  }));
  this.rotationRight = this._createRotationButton("rotationRight", !0);
  this.rotationLeft = this._createRotationButton("rotationLeft", !1);
};
r.prototype._createNavButtons = function () {
  var e = this;
  this.backButton = this.windowBody.appendChild(new a("cancelBtn", "", "", function () {
    e._back();
  }));
  this.createBtn = this.nameSelector.appendChild(new w({
    text: A("ui.charcrea.create"),
    className: ["greenButton", "createButton"]
  }, function () {
    e._createCharacter();
  }));
};
r.prototype._checkRelookingMandatoryChanges = function (e, t) {
  var i = this.relookingParams,
    n = this.nameInput.getValue();
  if (i.canRename === z.MANDATORY && this._relookingPreviousValues.name === n) {
    return P.showNotification(A("tablet.charcrea.sameName"), this.createBtn), !1;
  }
  if (i.canRebreed === z.MANDATORY && this._relookingPreviousValues.breed === this._breedId) {
    return P.showNotification(A("tablet.charcrea.sameBreed"), this.createBtn), !1;
  }
  if (i.canRegender === z.MANDATORY && this._relookingPreviousValues._sex === t) {
    return P.showNotification(A("tablet.charcrea.sameSex"), this.createBtn), !1;
  }
  if (i.canReface === z.MANDATORY && this._relookingPreviousValues._cosmeticId === this._cosmeticId) {
    return P.showNotification(A("tablet.charcrea.sameFace"), this.createBtn), !1;
  }
  if (i.canRecolor === z.MANDATORY) {
    for (var o = !0, a = this._relookingPreviousValues.indexedColors, s = 0; s < a.length; s += 1) {
      if (a[s] !== e[s]) {
        o = !1;
        break;
      }
    }
    if (o) {
      return P.showNotification(A("tablet.charcrea.sameColors"), this.createBtn), !1;
    }
  }
  return !0;
};
r.prototype._createCharacter = function () {
  var e = this.nameInput.getValue(this._needsNameCheck());
  if (this._needsNameCheck()) {
    if (e === !1) {
      return;
    }
    var t = e.length;
    if (0 === t) {
      return P.showNotification(A("ui.popup.charcrea.noName"), this.createBtn);
    }
    if (t < x.MIN_PLAYER_NAME_LEN || t > x.MAX_PLAYER_NAME_LEN) {
      return P.showNotification(A("ui.charcrea.nameRules"), this.createBtn);
    }
  }
  var i = this._buildColorsArray(),
    n = this._sex === le,
    o = {
      name: e,
      breed: this._breedId,
      sex: n,
      colors: i,
      cosmeticId: this._cosmeticId
    };
  if (this.relookingParams) {
    var a = this._checkRelookingMandatoryChanges(i, n);
    if (!a) {
      return;
    }
    o.headSkin = this.spriteStatus.headSkin;
    o.remodelingInformation = {
      name: e,
      breed: this._breedId,
      sex: n,
      colors: i,
      cosmeticId: this._cosmeticId,
      entityLook: this._buildEntityLook()
    };
    T.confirmCharacterRelooking(o);
  } else {
    this.addClassNames(["disabled"]);
    document.activeElement.blur();
    window.dofus.sendMessage("CharacterCreationRequestMessage", o);
  }
};
r.prototype._buildEntityLook = function () {
  return {
    bonesId: 1,
    indexedColors: this._buildColorsArray(),
    scales: [this.spriteStatus.scale],
    skins: [this.spriteStatus.bodySkin, this.spriteStatus.headSkin],
    subentities: []
  };
};
r.prototype._drawCharacter = function (e) {
  this.lastRendering = Date.now();
  var t = this;
  this.characterDisplay.setLook(this._buildEntityLook(), {
    boneType: "characters/",
    skinType: "characters/",
    direction: this.orientation
  }, function () {
    e && L(t.characterDisplay, 300, 50);
  });
};
r.prototype._selectColor = function (e, t) {
  var i = this.colorButtons[e];
  (i !== this.selectedColorBtn || t) && (this.selectedColorBtn && this.selectedColorBtn.deselect(), this.selectedColorBtn = i, i.select(), this.colorPicker.setCurrentColor(i.getColor().rgb));
};
r.prototype._resetColorButton = function (e) {
  var t = (this._sex === le ? "female" : "male") + "Colors",
    i = this.allBreeds[this._breedId][t][e.id];
  f(e, i, !1);
};
r.prototype._resetColors = function (e) {
  for (var t = 0; t < y.CHARACTER_COLORS; t++) {
    var i = this.colorButtons[t];
    e && i.isCustomColor() || this._resetColorButton(i);
  }
  this._selectColor(0, !0);
};
r.prototype._loadColors = function (e, t) {
  for (var i = 0; i < y.CHARACTER_COLORS; i++) {
    null !== e[i] ? f(this.colorButtons[i], e[i], t) : this._resetColorButton(this.colorButtons[i]);
  }
};
r.prototype._needsNameCheck = function () {
  return !this.relookingParams || this.relookingParams.canRename;
};
this.colorPicker.on("newColor", function (e) {
  if (l.selectedColorBtn) {
    l.selectedColorBtn.setColor(e, !0);
    var t = Date.now();
    (!l.colorPicker.lastUpdate || t - l.colorPicker.lastUpdate > se) && (l.colorPicker.lastUpdate = t, l._updateSprite());
  }
});
this.colorPicker.on("colorChanged", function (e) {
  l._colorChanged(e);
});
c.appendChild(new a("resetColorBtn", "", A("tablet.charCrea.resetCurrentColor"), function () {
  return l.selectedColorBtn && l.selectedColorBtn.getColor() ? (l._resetColorButton(l.selectedColorBtn), l._selectColor(l.selectedColorBtn.id, !0), void l._updateSprite()) : P.showNotification(A("tablet.charCrea.resetCurrentColor"), this);
}, !0));
c.appendChild(new a("randomColorBtn", A("tablet.charCrea.randomColors"), A("tablet.charCrea.randomColorsTip"), function () {
  l._styleGeneratorUsed = !0;
  for (var e = 0; e < y.CHARACTER_COLORS; e++) {
    l.colorButtons[e].randomize();
  }
  l._selectColor(0, !0);
  l._updateSprite();
}, !0));
c.appendChild(new a("resetAllColorBtn", A("tablet.charCrea.resetAll"), A("tablet.charCrea.resetAllTip"), function () {
  l._resetColors();
  l._updateSprite();
  l._currentColors = null;
}));
l._selectColor(0, !0);
l._updateSprite();
l._resetColors();
l._updateSprite();
l._currentColors = null;
d.on("confirm", function (e) {
  var t = I.hexToRgb(e);
  t && (l.colorPicker.setCurrentColor([t.r, t.g, t.b]), l._colorChanged(l.colorPicker.getCurrentColor()));
});
c.appendChild(new a("hexColorBtn", "#", A("ui.charcrea.hexColorTip"), function () {
  l.colorPicker.openHexInput();
}));
t.createChild("div", {
  className: "topLabelBackground"
});
t.createChild("div", {
  className: "fioritureRococo"
});
this.pageTitle = t.createChild("div", {
  className: "topLabelText",
  text: A("ui.charcrea.title")
});
this.nameInput = i.appendChild(new F({
  className: "nameInput",
  attr: {
    type: "text",
    id: "nameInput",
    maxlength: x.MAX_PLAYER_NAME_LEN
  },
  onChangeRules: V,
  onSubmitRules: j,
  blockInvalidInput: !1
}, function (e) {
  e.blur();
}));
this.nameInput.setPlaceholder(A("ui.popup.charcrea.noName"));
this.nameInput.on("validationFailed", function (e) {
  if (t._needsNameCheck()) {
    var i = [];
    e.forEach(function (e) {
      i.push(" - " + A(e.error));
    });
    i.length > 0 && o.setText(i.join("\n"));
  }
});
this.nameInput.on("validationPassed", function () {
  o.setText("");
});
this.randomiseBtn = i.appendChild(new a("randomiseBtn", "", A("tablet.charCrea.randomNameTip"), function () {
  t._nameGeneratorUsed = !0;
  window.dofus.sendMessage("CharacterNameSuggestionRequestMessage");
}, !0));
this.randomiseBtn.createChild("div", {
  className: "text",
  text: A("ui.charcrea.randomName")
});
e.forEach(function (e) {
  i.push(" - " + A(e.error));
});
i.length > 0 && o.setText(i.join("\n"));
t._nameGeneratorUsed = !0;
window.dofus.sendMessage("CharacterNameSuggestionRequestMessage");
this.checkerboardImage = t.createChild("div", {
  className: "checkerboardImage"
});
this.characterDisplay = t.appendChild(new M({
  scale: 3
}));
this.rotationRight = this._createRotationButton("rotationRight", !0);
this.rotationLeft = this._createRotationButton("rotationLeft", !1);
this.backButton = this.windowBody.appendChild(new a("cancelBtn", "", "", function () {
  e._back();
}));
this.createBtn = this.nameSelector.appendChild(new w({
  text: A("ui.charcrea.create"),
  className: ["greenButton", "createButton"]
}, function () {
  e._createCharacter();
}));
o.headSkin = this.spriteStatus.headSkin;
o.remodelingInformation = {
  name: e,
  breed: this._breedId,
  sex: n,
  colors: i,
  cosmeticId: this._cosmeticId,
  entityLook: this._buildEntityLook()
};
T.confirmCharacterRelooking(o);
this.addClassNames(["disabled"]);
document.activeElement.blur();
window.dofus.sendMessage("CharacterCreationRequestMessage", o);
n = n || {};
this.myWindow = e;
this.id = t;
this.active = n.active;
this.selected = !1;
this.currentColor = null;
this.isCustom = !1;
s.call(this, "div", {
  className: "plusColorButton"
});
r(this);
this.active && i && "function" == typeof i ? this.on("tap", i) : this.addClassNames("inactive");
this.plainColor = this.createChild("div", {
  className: "plainColor"
});
a(n, s);
e.exports = n;
n.prototype.select = function () {
  this.addClassNames("selected");
  this.selected = !0;
};
n.prototype.deselect = function () {
  this.delClassNames("selected");
  this.selected = !1;
};
n.prototype.isCustomColor = function () {
  return this.isCustom;
};
n.prototype.setColor = function (e, t) {
  this.isCustom = t;
  this.currentColor = e;
  e ? (this.plainColor.setStyle("display", "block"), this.plainColor.setStyle("background", e.hex), this.plainColor.setStyle("background", "-moz-linear-gradient(top,  #ffffff 0%, " + e.hex + " 14%, " + e.hex + " 85%, " + e.hex + " 85%, #110f0d 100%)"), this.plainColor.setStyle("background", "-webkit-gradient(linear, left top, left bottom, color-stop(0%,#ffffff), color-stop(14%," + e.hex + "), color-stop(85%," + e.hex + "), color-stop(85%," + e.hex + "), color-stop(100%,#110f0d))"), this.plainColor.setStyle("background", "-webkit-linear-gradient(top,  #ffffff 0%," + e.hex + " 14%," + e.hex + " 85%," + e.hex + " 85%,#110f0d 100%)"), this.plainColor.setStyle("background", "-o-linear-gradient(top,  #ffffff 0%," + e.hex + " 14%," + e.hex + " 85%," + e.hex + " 85%,#110f0d 100%)"), this.plainColor.setStyle("background", "-ms-linear-gradient(top,  #ffffff 0%," + e.hex + " 14%," + e.hex + " 85%," + e.hex + " 85%,#110f0d 100%)"), this.plainColor.setStyle("background", "linear-gradient(to bottom,  #ffffff 0%," + e.hex + " 14%," + e.hex + " 85%," + e.hex + " 85%,#110f0d 100%)")) : this.plainColor.setStyle("display", "none");
};
n.prototype.getColor = function () {
  return this.currentColor;
};
n.prototype.randomize = function () {
  var e = Math.floor(255 * Math.random()),
    t = Math.floor(255 * Math.random()),
    i = Math.floor(255 * Math.random()),
    n = [e, t, i];
  n = {
    rgb: n,
    hex: o.colorArrayToHexa(n)
  };
  this.setColor(n, !0);
};
this.addClassNames("selected");
this.selected = !0;
this.delClassNames("selected");
this.selected = !1;
this.isCustom = t;
this.currentColor = e;
e ? (this.plainColor.setStyle("display", "block"), this.plainColor.setStyle("background", e.hex), this.plainColor.setStyle("background", "-moz-linear-gradient(top,  #ffffff 0%, " + e.hex + " 14%, " + e.hex + " 85%, " + e.hex + " 85%, #110f0d 100%)"), this.plainColor.setStyle("background", "-webkit-gradient(linear, left top, left bottom, color-stop(0%,#ffffff), color-stop(14%," + e.hex + "), color-stop(85%," + e.hex + "), color-stop(85%," + e.hex + "), color-stop(100%,#110f0d))"), this.plainColor.setStyle("background", "-webkit-linear-gradient(top,  #ffffff 0%," + e.hex + " 14%," + e.hex + " 85%," + e.hex + " 85%,#110f0d 100%)"), this.plainColor.setStyle("background", "-o-linear-gradient(top,  #ffffff 0%," + e.hex + " 14%," + e.hex + " 85%," + e.hex + " 85%,#110f0d 100%)"), this.plainColor.setStyle("background", "-ms-linear-gradient(top,  #ffffff 0%," + e.hex + " 14%," + e.hex + " 85%," + e.hex + " 85%,#110f0d 100%)"), this.plainColor.setStyle("background", "linear-gradient(to bottom,  #ffffff 0%," + e.hex + " 14%," + e.hex + " 85%," + e.hex + " 85%,#110f0d 100%)")) : this.plainColor.setStyle("display", "none");
n = {
  rgb: n,
  hex: o.colorArrayToHexa(n)
};
this.setColor(n, !0);
a.call(this, e, t);
this.addClassNames("InputBoxValidated");
o.forEach(i);
s.forEach(i);
this.on("change", function (e) {
  for (var t = [], i = 0; i < o.length; i += 1) {
    var a = o[i],
      s = void 0 === a.expectedResult || a.expectedResult;
    a.regex && a.regex.test(e) !== s && (a.transform ? e = a.transform(e) : t.push({
      error: a.error
    }));
  }
  t.length > 0 && r ? this.setValue(n, !1) : (n = e, this.setValue(n, !1));
  t.length > 0 ? (this.addClassNames("invalid"), this.emit("validationFailed", t)) : (this.delClassNames("invalid"), this.emit("validationPassed"));
});
t.length > 0 && r ? this.setValue(n, !1) : (n = e, this.setValue(n, !1));
t.length > 0 ? (this.addClassNames("invalid"), this.emit("validationFailed", t)) : (this.delClassNames("invalid"), this.emit("validationPassed"));
o(n, a);
e.exports = n;
n.prototype.getValue = function (e) {
  var t = a.prototype.getValue.call(this);
  if (e = void 0 === e || e, !e) {
    return t;
  }
  var i,
    n,
    o,
    s = [];
  for (i = 0; i < this.onChangeRules.length; i += 1) {
    n = this.onChangeRules[i];
    o = void 0 === n.expectedResult || n.expectedResult;
    n.regex && n.regex.test(t) !== o && n.error && s.push({
      error: n.error
    });
  }
  for (i = 0; i < this.onSubmitRules.length; i += 1) {
    n = this.onSubmitRules[i];
    o = void 0 === n.expectedResult || n.expectedResult;
    n.regex && n.regex.test(t) !== o && n.error && s.push({
      error: n.error
    });
  }
  return 0 === s.length ? (this.delClassNames("invalid"), this.emit("validationPassed"), t) : (this.addClassNames("invalid"), this.emit("validationFailed", s), !1);
};
n = this.onChangeRules[i];
o = void 0 === n.expectedResult || n.expectedResult;
n.regex && n.regex.test(t) !== o && n.error && s.push({
  error: n.error
});
n = this.onSubmitRules[i];
o = void 0 === n.expectedResult || n.expectedResult;
n.regex && n.regex.test(t) !== o && n.error && s.push({
  error: n.error
});
e = e || {};
a.call(this, "div", e);
this.addClassNames("InputBoxErrors");
this.setText(e.text || "");
o(n, a);
e.exports = n;
n.prototype.setText = function (e) {
  a.prototype.setText.call(this, e);
  e ? this.show() : this.hide();
};
a.prototype.setText.call(this, e);
e ? this.show() : this.hide();
t.onChangeRules = [{
  regex: "^[a-z]$",
  expectedResult: !1,
  transform: function (e) {
    return e.toUpperCase();
  }
}, {
  regex: "([A-Z].*|\\[[A-Z].*|)$",
  error: "tablet.charCrea.name.capStart"
}, {
  regex: "^[a-z-\\[\\]]*$",
  regexFlags: "i",
  error: "tablet.charCrea.name.lettersDashes"
}, {
  regex: "[\\s]+",
  expectedResult: !1,
  error: "tablet.charCrea.name.noSpaces"
}, {
  regex: "^(-|[a-z]-)",
  expectedResult: !1,
  regexFlags: "i",
  error: "tablet.charCrea.name.no1st2ndDash"
}, {
  regex: "^.*-.*-",
  expectedResult: !1,
  error: "tablet.charCrea.name.1DashMax"
}, {
  regex: "^.*[^-\\[][A-Z]",
  expectedResult: !1,
  error: "tablet.charCrea.name.capAfterDash"
}, {
  regex: "(.)\\1{2,}",
  expectedResult: !1,
  regexFlags: "i",
  error: "tablet.charCrea.name.identical2Consec"
}, {
  regex: "([b-df-hj-np-tv-xz]){4,}",
  expectedResult: !1,
  regexFlags: "i",
  error: "tablet.charCrea.name.consonants3Consec"
}, {
  regex: "^[\\S]{,20}$",
  expectedResult: !1,
  error: "tablet.charCrea.name.nameLength"
}];
t.onSubmitRules = [{
  regex: "^[\\S]{3,20}$",
  error: "tablet.charCrea.name.nameLength"
}, {
  regex: "[aeiouy]+",
  regexFlags: "i",
  error: "tablet.charCrea.name.must1Vowel"
}];
s.call(this, {
  title: o("ui.orientCharacter"),
  className: "CharacterOrientationWindow",
  freeContentDelay: 5e3,
  positionInfo: {
    left: "c",
    top: "c",
    width: 300,
    height: 340
  }
});
this.hasDom = !1;
this.isListening = !1;
this.on("open", this._onOpen);
a(n, s);
e.exports = n;
n.prototype.freeContent = function () {
  this.character.release();
  this.windowBody.clearContent();
  this.hasDom = !1;
};
n.prototype._onOpen = function () {
  this.hasDom || this._createDom();
  this.isListening || this._setupEvents();
};
n.prototype.updateCharacter = function () {
  var e = window.gui.playerData.characterBaseInformations;
  this.character.setLook(e.entityLook, {
    riderOnly: !1,
    boneType: "characters/",
    skinType: "characters/",
    keepDirection: !1,
    keepModels: !0
  });
};
n.prototype.changeRequested = function () {
  window.dofus.sendMessage("GameMapChangeOrientationRequestMessage", {
    direction: this.character.entity.direction
  });
};
n.prototype._setupEvents = function () {
  this.isListening = !0;
  var e = this,
    t = window.gui.playerData;
  this.on("opened", function () {
    e.updateCharacter();
  });
  t.on("lookUpdate", function () {
    e.updateCharacter();
  });
  t.on("mountRiding", function () {
    e.updateCharacter();
  });
};
n.prototype._createDom = function () {
  var e = this;
  this.hasDom = !0;
  var t = this.windowBody.createChild("div", {
    className: "characterBox"
  });
  this.character = t.appendChild(new l({
    scale: "fitin",
    horizontalAlign: "center"
  }));
  var i = this.character.createChild("div", {
    className: "leftButton"
  });
  c(i, {
    repeatDelay: 100
  });
  i.on("tap", function () {
    e.character.rotateCharacter(!1);
  });
  var n = this.character.createChild("div", {
    className: "rightButton"
  });
  c(n, {
    repeatDelay: 100
  });
  n.on("tap", function () {
    e.character.rotateCharacter(!0);
  });
  this.windowBody.appendChild(new r({
    text: o("ui.common.validation"),
    className: ["button"]
  }, function () {
    e.changeRequested();
    e.close();
  }));
};
this.character.release();
this.windowBody.clearContent();
this.hasDom = !1;
this.hasDom || this._createDom();
this.isListening || this._setupEvents();
this.on("opened", function () {
  e.updateCharacter();
});
t.on("lookUpdate", function () {
  e.updateCharacter();
});
t.on("mountRiding", function () {
  e.updateCharacter();
});
c(i, {
  repeatDelay: 100
});
i.on("tap", function () {
  e.character.rotateCharacter(!1);
});
c(n, {
  repeatDelay: 100
});
n.on("tap", function () {
  e.character.rotateCharacter(!0);
});
this.windowBody.appendChild(new r({
  text: o("ui.common.validation"),
  className: ["button"]
}, function () {
  e.changeRequested();
  e.close();
}));
e.changeRequested();
e.close();
e = e || {};
l._totalFailure = 0;
l._totalSuccess = 0;
l._done = 0;
l._craftResultBox.checkRecipe(t, o);
o.isRecipeKnown && !e.keepResultVisible ? (l._itemResult.hide(), l._craftResultBox._clearProgress(), l.highlightedRecipeId = o.itemToCraft.resultId) : l.highlightedRecipeId = null;
l._recipeList.highlightRecipe(l.highlightedRecipeId);
l._done = l._totalQty - t;
l._craftResultBox.setProgress(l._done, l._totalQty);
c.displayAutoCraftStopReasonMessage(n);
l._isInAutoCraft = !1;
n === p.STOPPED_REASON_OK && t({
  count: 0
});
e({
  keepResultVisible: !0
});
l._restoreMergeStopButtons();
this._inventoryPositionInfos = {
  decrafting: r,
  wrapping: r
};
this._mergeLabels = {
  crafting: s("ui.common.merge"),
  decrafting: s("ui.common.decraft")
};
this._domCreated = !1;
this._recipeList = null;
this._mySlotElems = null;
this._targetSlotElems = null;
this._craftResultBox = null;
this._itemResult = null;
this._totalQty = 1;
this._done = 0;
this._isInAutoCraft = !1;
this._skillId = null;
this.jobsData = h.playerData.jobs;
this._updateQtyToCraft = function (e) {
  l._totalQty = e.count;
  l._craftResultBox.setQty(l._totalQty, !0);
  l._isInAutoCraft = l._totalQty > 1;
};
this.addAndModifySlots = function (t) {
  u.createItemInstances(t, function (t, i) {
    if (t) {
      return console.error("Crafting: addAndModifySlots cannot createItemInstances", t);
    }
    var n = i.array[0];
    h.playerData.inventory.objects[n.objectUID] ? l._mySlotElems.addAndModifySlot(n) : l._targetSlotElems.addAndModifySlot(n);
    l._mySlotElems.setNbSlots();
    l._targetSlotElems.setNbSlots();
    e();
  });
};
this.objectRemoved = function (t) {
  l._targetSlotElems.removeIngredient(t);
  l._mySlotElems.removeIngredient(t);
  l._mySlotElems.setNbSlots();
  l._targetSlotElems.setNbSlots();
  e();
};
this._onResultEvents = function (e) {
  l._onResult(e, function (e, t) {
    return e ? console.error("Crafting: onResult error", e) : void l.giveTheResult(t.objectInfo, t.message);
  });
};
this._slotCountIncreased = function (e) {
  var t = e.newMaxSlot;
  l._updateRecipeList(t);
  l._updateSlotElems(t);
};
this._updateSlotElems = function (e) {
  l._updateMySlotElems(e);
};
h.on("ExchangeCraftResultMessage", n);
h.on("ExchangeCraftResultWithObjectIdMessage", n);
h.on("ExchangeCraftResultWithObjectDescMessage", n);
h.on("ExchangeReplayCountModifiedMessage", n);
h.on("ExchangeItemAutoCraftRemainingMessage", n);
h.on("ExchangeItemAutoCraftStopedMessage", n);
h.on("ExchangeCraftSlotCountIncreasedMessage", n);
this.on("open", function (e) {
  l._domCreated || l._createDom();
  l._onOpen(e);
});
this.on("close", function () {
  l._mySlotElems.clear();
  l._targetSlotElems.clear();
  l._recipeList.reset();
  l._craftResultBox.clear();
  l.jobsData.clearAfterCraft();
  l._skillId = null;
  l._paymentButton.hide();
  d.close("craftPayment");
});
this.on("closed", function () {
  this._updatePerCraftType();
});
this._buttonMergeAction = function () {
  function e() {
    window.dofus.sendMessage("ExchangeReadyMessage", {
      ready: !0,
      step: 2
    });
    l._isInAutoCraft ? l._buttonMerge.disable() : l._restoreMergeStopButtons();
  }
  var t = l._mySlotElems.getGivenIngredientsInfo().length;
  if (t += l._targetSlotElems.getGivenIngredientsInfo().length, !(t < 1)) {
    return l._skillId !== l.jobsData.SKILLID_DECRAFT ? e() : void window.gui.openConfirmPopup({
      title: s("ui.popup.warning"),
      message: s("ui.craft.decraftConfirm"),
      cb: function (t) {
        t && e();
      }
    });
  }
};
l._totalQty = e.count;
l._craftResultBox.setQty(l._totalQty, !0);
l._isInAutoCraft = l._totalQty > 1;
h.playerData.inventory.objects[n.objectUID] ? l._mySlotElems.addAndModifySlot(n) : l._targetSlotElems.addAndModifySlot(n);
l._mySlotElems.setNbSlots();
l._targetSlotElems.setNbSlots();
e();
l._targetSlotElems.removeIngredient(t);
l._mySlotElems.removeIngredient(t);
l._mySlotElems.setNbSlots();
l._targetSlotElems.setNbSlots();
e();
l._updateRecipeList(t);
l._updateSlotElems(t);
l._domCreated || l._createDom();
l._onOpen(e);
l._mySlotElems.clear();
l._targetSlotElems.clear();
l._recipeList.reset();
l._craftResultBox.clear();
l.jobsData.clearAfterCraft();
l._skillId = null;
l._paymentButton.hide();
d.close("craftPayment");
window.dofus.sendMessage("ExchangeReadyMessage", {
  ready: !0,
  step: 2
});
l._isInAutoCraft ? l._buttonMerge.disable() : l._restoreMergeStopButtons();
o(n, a);
e.exports = n;
n.prototype._restoreMergeStopButtons = function () {
  this._stopBtn.disable();
  this._buttonMerge.enable();
};
n.prototype._createDom = function () {
  var e = this,
    t = this.windowBody.createChild("div", {
      className: "col1"
    }),
    i = this.windowBody.createChild("div", {
      className: "col2"
    });
  this._recipeList = t.appendChild(new r({
    isInCraft: !0
  }));
  this._recipeList.on("recipeSelected", function (t) {
    return this.isRecipeCraftableFromInventory(t) ? void (t !== e.highlightedRecipeId ? window.dofus.sendMessage("ExchangeSetCraftRecipeMessage", {
      objectGID: t
    }) : e._totalQty < e._craftResultBox.getMaxQuantity() ? e._requestReplayCountChange(e._totalQty + 1) : e._craftResultBox.setQty(e._totalQty, !0)) : window.gui.openSimplePopup(s("ui.craft.dontHaveAllIngredient"));
  });
  this._targetSlotElems = i.appendChild(new g());
  this._mySlotElems = i.appendChild(new g());
  _.on("dragStart", e.localizeEvent(function (t, i) {
    switch (i) {
      case "craftInventory":
        e._mySlotElems.showDropHighlight(t.getItem());
        t.once("dragEnd", function () {
          e._mySlotElems.hideDropHighlight();
        });
        break;
      case "recipeList":
        e._craftResultBox.selectSlot(!0);
        t.once("dragEnd", function () {
          e._craftResultBox.selectSlot(!1);
        });
    }
  }));
  this._craftResultBox = i.appendChild(new f());
  this._craftResultBox.on("craftReplayCount", function (t) {
    e._requestReplayCountChange(t);
  });
  var n = i.createChild("div", {
    className: "buttonsContainer"
  });
  this._buttonMerge = n.appendChild(new l(s("ui.common.merge"), {
    className: "mergeButton"
  }));
  this._buttonMerge.on("tap", e._buttonMergeAction);
  this._stopBtn = n.appendChild(new l(s("ui.common.stop"), {
    className: "stopButton",
    disable: !0
  }));
  this._stopBtn.on("tap", function () {
    window.dofus.sendMessage("ExchangeReplayStopMessage");
  });
  this._paymentButton = n.appendChild(new l(s("ui.common.payment"), {
    className: "paymentButton"
  }));
  this._paymentButton.on("tap", function () {
    d.open("craftPayment");
  });
  this._itemResult = i.createChild("div", {
    className: "itemResult"
  });
  var o = this._itemResult.createChild("div", {
    className: "titleBar"
  });
  this._itemName = o.createChild("div", {
    className: "itemName"
  });
  this._itemLevel = o.createChild("div", {
    className: "itemLevel"
  });
  this._itemDescription = this._itemResult.appendChild(new m());
  this._domCreated = !0;
};
n.prototype._requestReplayCountChange = function (e) {
  window.dofus.sendMessage("ExchangeReplayMessage", {
    count: e
  });
};
n.prototype._updateRecipeList = function (e) {
  var t = this.jobsData.getRecipesBySkill(this._skillId);
  this._recipeList.addRecipes(t, {
    nbCase: e,
    mode: "craft"
  });
  var i = e > 8 ? 8 : e;
  this.jobsData.setExistingSlotCount(i);
  this.toggleClassName("noRecipe", !t.length);
};
n.prototype._updatePerCraftType = function (e) {
  d.positionWindow(this.id, this._positionInfos[e]);
  d.positionWindow("craftInventory", this._inventoryPositionInfos[e]);
  this._buttonMerge.setText(this._mergeLabels[e] || this._mergeLabels.crafting);
};
n.prototype._updateMySlotElems = function (e) {
  var t = 9 === e;
  this._mySlotElems.setNbSlots();
  this._mySlotElems.toggleSignatureSlot(t);
};
n.prototype._onOpen = function (e) {
  var t = e.msg;
  this._skillId = t.skillId;
  this._totalQty = 1;
  this._totalFailure = 0;
  this._totalSuccess = 0;
  this.highlightedRecipeId = null;
  this._craftResultBox.clear();
  this._itemResult.hide();
  this._targetSlotElems.hide();
  this._paymentButton.hide();
  this._restoreMergeStopButtons();
  this._mySlotElems.setPlayerName(window.gui.playerData.characterBaseInformations.name);
  var i,
    n = t.maxCase || t.nbCase;
  i = void 0 === e.isCrafter ? "SOLO" : e.isCrafter ? "CRAFTER" : "CLIENT";
  this.jobsData.startCraftingSession(i, this._skillId, n);
  this.jobsData.on("objectAdded", this.addAndModifySlots);
  this.jobsData.on("objectModified", this.addAndModifySlots);
  this.jobsData.on("objectRemoved", this.objectRemoved);
  this._updateRecipeList(n);
  this._updateSlotElems(n);
  this._updatePerCraftType(e.type);
};
n.prototype._onResult = function (e, t) {
  var i = "",
    n = null,
    o = window.gui,
    a = this,
    r = "",
    l = e.craftResult,
    c = e.objectInfo && e.objectInfo.quantity || 1;
  return c > 1 && this._updateQtyToCraft({
    count: 0
  }), n = e.objectGenericId || e.objectInfo && e.objectInfo.objectGID, l === h.CRAFT_IMPOSSIBLE ? (a._totalFailure += c, i = s("ui.craft.noResult"), o.openSimplePopup(i)) : l === h.CRAFT_FAILED && (a._totalFailure += c, a._isInAutoCraft || o.openSimplePopup(s("ui.craft.failed"))), a._isInAutoCraft || a._restoreMergeStopButtons(), n ? void u.getItems([n], function (o) {
    if (o) {
      return t(o);
    }
    var d = u.items[n];
    r = d.nameId;
    l === h.CRAFT_SUCCESS && (a._totalSuccess += c, i = s("ui.craft.craftSuccessSelf", c, r));
    t(null, {
      objectName: r,
      objectInfo: e.objectInfo,
      craftResult: l,
      message: i
    });
  }) : t(null, {
    objectName: r,
    objectInfo: e.objectInfo,
    craftResult: l,
    message: i
  });
};
n.prototype.giveTheResult = function (e, t) {
  function i(e) {
    u.createItemInstances(e, function (t, i) {
      if (t) {
        return console.error("Crafting: updateItemResultDescription Failed to create item instances", t);
      }
      var n = i.map[e.objectUID];
      o._itemDescription.displayItem(n);
      o._itemName.setText(n.item.nameId);
      o._itemLevel.setText(s("ui.common.short.level") + n.item.level);
      o._itemResult.show();
    });
  }
  var n = window.gui,
    o = this;
  t && n.chat.logMsg(t);
  this._recipeList.refreshDisplayedRecipes();
  e && i(e);
  this._craftResultBox.updateFailSuccessValues(this._totalFailure, this._totalSuccess);
};
this._stopBtn.disable();
this._buttonMerge.enable();
this._recipeList = t.appendChild(new r({
  isInCraft: !0
}));
this._recipeList.on("recipeSelected", function (t) {
  return this.isRecipeCraftableFromInventory(t) ? void (t !== e.highlightedRecipeId ? window.dofus.sendMessage("ExchangeSetCraftRecipeMessage", {
    objectGID: t
  }) : e._totalQty < e._craftResultBox.getMaxQuantity() ? e._requestReplayCountChange(e._totalQty + 1) : e._craftResultBox.setQty(e._totalQty, !0)) : window.gui.openSimplePopup(s("ui.craft.dontHaveAllIngredient"));
});
this._targetSlotElems = i.appendChild(new g());
this._mySlotElems = i.appendChild(new g());
_.on("dragStart", e.localizeEvent(function (t, i) {
  switch (i) {
    case "craftInventory":
      e._mySlotElems.showDropHighlight(t.getItem());
      t.once("dragEnd", function () {
        e._mySlotElems.hideDropHighlight();
      });
      break;
    case "recipeList":
      e._craftResultBox.selectSlot(!0);
      t.once("dragEnd", function () {
        e._craftResultBox.selectSlot(!1);
      });
  }
}));
this._craftResultBox = i.appendChild(new f());
this._craftResultBox.on("craftReplayCount", function (t) {
  e._requestReplayCountChange(t);
});
e._mySlotElems.showDropHighlight(t.getItem());
t.once("dragEnd", function () {
  e._mySlotElems.hideDropHighlight();
});
e._craftResultBox.selectSlot(!0);
t.once("dragEnd", function () {
  e._craftResultBox.selectSlot(!1);
});
this._buttonMerge = n.appendChild(new l(s("ui.common.merge"), {
  className: "mergeButton"
}));
this._buttonMerge.on("tap", e._buttonMergeAction);
this._stopBtn = n.appendChild(new l(s("ui.common.stop"), {
  className: "stopButton",
  disable: !0
}));
this._stopBtn.on("tap", function () {
  window.dofus.sendMessage("ExchangeReplayStopMessage");
});
this._paymentButton = n.appendChild(new l(s("ui.common.payment"), {
  className: "paymentButton"
}));
this._paymentButton.on("tap", function () {
  d.open("craftPayment");
});
this._itemResult = i.createChild("div", {
  className: "itemResult"
});
this._itemName = o.createChild("div", {
  className: "itemName"
});
this._itemLevel = o.createChild("div", {
  className: "itemLevel"
});
this._itemDescription = this._itemResult.appendChild(new m());
this._domCreated = !0;
this.jobsData.setExistingSlotCount(i);
this.toggleClassName("noRecipe", !t.length);
d.positionWindow(this.id, this._positionInfos[e]);
d.positionWindow("craftInventory", this._inventoryPositionInfos[e]);
this._buttonMerge.setText(this._mergeLabels[e] || this._mergeLabels.crafting);
this._mySlotElems.setNbSlots();
this._mySlotElems.toggleSignatureSlot(t);
this._skillId = t.skillId;
this._totalQty = 1;
this._totalFailure = 0;
this._totalSuccess = 0;
this.highlightedRecipeId = null;
this._craftResultBox.clear();
this._itemResult.hide();
this._targetSlotElems.hide();
this._paymentButton.hide();
this._restoreMergeStopButtons();
this._mySlotElems.setPlayerName(window.gui.playerData.characterBaseInformations.name);
i = void 0 === e.isCrafter ? "SOLO" : e.isCrafter ? "CRAFTER" : "CLIENT";
this.jobsData.startCraftingSession(i, this._skillId, n);
this.jobsData.on("objectAdded", this.addAndModifySlots);
this.jobsData.on("objectModified", this.addAndModifySlots);
this.jobsData.on("objectRemoved", this.objectRemoved);
this._updateRecipeList(n);
this._updateSlotElems(n);
this._updatePerCraftType(e.type);
r = d.nameId;
l === h.CRAFT_SUCCESS && (a._totalSuccess += c, i = s("ui.craft.craftSuccessSelf", c, r));
t(null, {
  objectName: r,
  objectInfo: e.objectInfo,
  craftResult: l,
  message: i
});
o._itemDescription.displayItem(n);
o._itemName.setText(n.item.nameId);
o._itemLevel.setText(s("ui.common.short.level") + n.item.level);
o._itemResult.show();
t && n.chat.logMsg(t);
this._recipeList.refreshDisplayedRecipes();
e && i(e);
this._craftResultBox.updateFailSuccessValues(this._totalFailure, this._totalSuccess);
this._maxQuantity = this._currentQuantity = 1;
this._minMaxSelector = this.appendChild(new r());
this._minMaxSelector.on("confirm", function (t) {
  e.emit("craftReplayCount", t);
});
this._quantity = c.createChild("div", {
  className: "quantity",
  text: "x1"
});
c.createChild("div", {
  className: "btnIcon"
});
m.createChild("div", {
  className: "label",
  text: s("ui.craft.success") + s("ui.common.colon")
});
m.createChild("div", {
  className: "label",
  text: s("ui.craft.failure") + s("ui.common.colon")
});
this._successValue = f.createChild("div", {
  className: "value"
});
this._failureValue = f.createChild("div", {
  className: "value"
});
this._progressLine = t.createChild("div", {
  className: "progressBox",
  hidden: !0
});
this._progressBar = this._progressLine.appendChild(new l({
  className: ["progressBar", "orange"],
  tooltip: !0
}));
this._progressValue = this._progressLine.createChild("div", {
  className: "value"
});
h.setDroppable(this, ["recipeList"]);
this.on("drop", function (e, t, i) {
  i.selectRecipe();
});
this._qtyButton.disable();
this._qtyButton.on("tap", function () {
  e._minMaxSelector.open({
    min: 1,
    max: e._maxQuantity,
    defaultValue: e._currentQuantity
  });
});
o(n, a);
e.exports = n;
n.prototype.prepareItem = function (e) {
  var t = this;
  c.getItems([e], function (i) {
    if (i) {
      return console.error(i);
    }
    var n = c.items[e];
    t._resultSlot.setItem(n);
    t._resultName.setText(n.nameId);
  });
};
n.prototype.setQty = function (e, t) {
  this._currentQuantity = e;
  this._quantity.setText("x " + e);
  t && (this._qtyButton.addClassNames("highlighted"), this.highlightTimeout && window.clearTimeout(this.highlightTimeout), this.highlightTimeout = window.setTimeout(function (e) {
    e._qtyButton.delClassNames("highlighted");
  }, p, this));
};
n.prototype._setMaxQuantity = function (e) {
  this._maxQuantity = e;
};
n.prototype.setProgress = function (e, t) {
  if (1 === e) {
    if (t <= 1) {
      return;
    }
    this._progressLine.show();
    this._progressBar.setValue(e);
  }
  this._progressBar.setValue(e / t);
  this._progressValue.setText(e + " / " + t);
};
n.prototype.updateFailSuccessValues = function (e, t) {
  this.successFailBox.show();
  this._failureValue.setText(e);
  this._successValue.setText(t);
};
n.prototype.checkRecipe = function (e, t) {
  function i() {
    var t,
      i,
      n = window.gui.playerData,
      o = n.inventory.objects,
      a = {},
      s = -1;
    for (t = 0, i = e.length; t < i; t += 1) {
      var r = e[t];
      if (o[r.UID]) {
        var l = o[r.UID].quantity;
        a[r.GID] = l;
      }
    }
    for (t = 0, i = e.length; t < i; t += 1) {
      if (e[t].GID) {
        var c = e[t].GID,
          d = e[t].quantity,
          u = a[c],
          h = Math.floor(u / d);
        (s === -1 || s > h) && (s = h);
      }
    }
    var p = a[n.jobs.RUNE_SIGNATURE_GID];
    return p && s > p && (s = p), s;
  }
  var n = e.length <= 0;
  if (t.isRecipeKnown ? this.prepareItem(t.itemToCraft.resultId) : this._clearItem(), n) {
    this._qtyButton.disable();
    this._setMaxQuantity(1);
  } else {
    this._qtyButton.enable();
    var o = i();
    this._setMaxQuantity(o);
  }
};
n.prototype.getMaxQuantity = function () {
  return this._maxQuantity;
};
n.prototype._clearItem = function () {
  this._resultSlot.unset();
  this._resultName.setText("");
  this.setQty(1);
  this._qtyButton.disable();
};
n.prototype.toggleReady = function (e) {
  this.toggleClassName("isReady", e);
};
n.prototype._clearProgress = function () {
  this._progressLine.hide();
  this.successFailBox.hide();
};
n.prototype.clear = function () {
  this._clearItem();
  this._clearProgress();
  this._setMaxQuantity(1);
};
n.prototype.selectSlot = function (e) {
  this._resultSlot.toggleClassName("selected", e);
};
t._resultSlot.setItem(n);
t._resultName.setText(n.nameId);
this._currentQuantity = e;
this._quantity.setText("x " + e);
t && (this._qtyButton.addClassNames("highlighted"), this.highlightTimeout && window.clearTimeout(this.highlightTimeout), this.highlightTimeout = window.setTimeout(function (e) {
  e._qtyButton.delClassNames("highlighted");
}, p, this));
this._progressLine.show();
this._progressBar.setValue(e);
this._progressBar.setValue(e / t);
this._progressValue.setText(e + " / " + t);
this.successFailBox.show();
this._failureValue.setText(e);
this._successValue.setText(t);
this._qtyButton.disable();
this._setMaxQuantity(1);
this._resultSlot.unset();
this._resultName.setText("");
this.setQty(1);
this._qtyButton.disable();
this._progressLine.hide();
this.successFailBox.hide();
this._clearItem();
this._clearProgress();
this._setMaxQuantity(1);
this._usedSlots = 0;
this._runeSignatureUid = null;
this.highlightedSlots = [];
this._minMaxSelector = this.appendChild(new d());
this._minMaxSelector.setStyles({
  left: "20px",
  top: "30px"
});
s.setDroppable(this, ["craftInventory"], {
  isDropAllowed: i
});
this.on("drop", function (e) {
  t(e.itemInstance, e.getQuantity());
});
this._playerName = l.createChild("div", {
  className: "playerName"
});
this._playerRole = l.createChild("div", {
  className: "playerRole"
});
this._allSlots = l.createChild("div", {
  className: "allSlots"
});
this._signatureSlot = l.appendChild(this._createItemSlot("signatureSlot"));
this._signatureSlot.hide();
l(n, c);
e.exports = n;
n.prototype._createItemSlot = function (e) {
  var t = new r({
    noDoubleTap: !0
  });
  return e && t.addClassNames(e), t.on("tap", a), t.craftActorBox = this, this._isRemote || s.setDraggable(t, {
    prepareForDrag: o
  }, "crafting", {
    slot: t
  }), t;
};
n.prototype._slotTapHandler = function (e) {
  if (!this._isRemote) {
    var t = e.getItem();
    if (t) {
      var i = this.jobsData.getQuickTransferInfo("crafting", t, e.getQuantity());
      e !== this.selectedSlot ? (window.gui.openContextualMenuAround("item", e, {
        item: t
      }), this._selectCurrentSlot(e, i.movedQty > 1 ? "stackMove" : "")) : this.jobsData.removeItemFromCraft(t.objectUID, i.movedQty);
    }
  }
};
n.prototype._selectCurrentSlot = function (e, t) {
  this.selectedSlot && this._unselectCurrentSlot();
  this.selectedSlot = e;
  e.select({
    extraStyle: t
  });
};
n.prototype._unselectCurrentSlot = function () {
  this.selectedSlot && (this.selectedSlot.unselect(), this.selectedSlot = null);
};
n.prototype.setNbSlots = function () {
  for (var e = this._allSlots.getChildren(), t = this._usedSlots + this.jobsData.getFreeSlotCount(), i = 0, n = e.length; i < n; i += 1) {
    var o = e[i],
      a = i >= t;
    o.toggleClassName("locked", a);
    o.isLocked = a;
  }
};
n.prototype.toggleSignatureSlot = function (e) {
  this._signatureSlot.toggleDisplay(e);
};
n.prototype.showDropHighlight = function (e) {
  if (this.highlightedSlots = [], e.objectGID === this.jobsData.RUNE_SIGNATURE_GID) {
    this.highlightedSlots.push(this._signatureSlot);
  } else {
    for (var t = this._allSlots.getChildren(), i = 0; i < t.length; i++) {
      var n = t[i],
        o = n.getItem();
      if (o && o.objectUID === e.objectUID) {
        this.highlightedSlots = [n];
        break;
      }
      o || n.isLocked || this.highlightedSlots.push(n);
    }
  }
  for (var a = 0; a < this.highlightedSlots.length; a++) {
    this.highlightedSlots[a].addClassNames("selected");
  }
};
n.prototype.hideDropHighlight = function () {
  for (var e = 0; e < this.highlightedSlots.length; e++) {
    this.highlightedSlots[e].delClassNames("selected");
  }
  this.highlightedSlots = [];
};
n.prototype.setAsRemote = function () {
  this._isRemote = !0;
  this._slotsContainer.addClassNames("client");
};
n.prototype.setPlayerName = function (e) {
  this._playerName.setText(e);
};
n.prototype.toggleReady = function (e) {
  this.toggleClassName("isReady", e);
};
n.prototype._findSlotByUID = function (e) {
  for (var t = this._allSlots.getChildren(), i = 0, n = t.length; i < n; i += 1) {
    var o = t[i];
    if (o.itemInstance && o.itemInstance.objectUID === e) {
      return i;
    }
  }
  return null;
};
n.prototype.addAndModifySlot = function (e) {
  var t,
    i = this._allSlots.getChildren();
  if (e.objectGID === this.jobsData.RUNE_SIGNATURE_GID) {
    return this._runeSignatureUid = e.objectUID, void this._signatureSlot.setItem(e);
  }
  var n = this._findSlotByUID(e.objectUID);
  n || 0 === n ? (t = i[n], t.setItem(e)) : (t = i[this._usedSlots], t.setItem(e), this._usedSlots += 1);
};
n.prototype.removeIngredient = function (e) {
  if (e === this._runeSignatureUid) {
    return this._signatureSlot.unselect(), this._signatureSlot.unset(), void (this._runeSignatureUid = null);
  }
  var t = this._findSlotByUID(e);
  if (t || 0 === t) {
    this._unselectCurrentSlot();
    for (var i = this._allSlots.getChildren(), n = t + 1; n < i.length; n++) {
      i[n - 1].setItem(i[n].getItem());
    }
    i[i.length - 1].unset();
    this._usedSlots -= 1;
  }
};
n.prototype.getGivenIngredientsInfo = function () {
  for (var e = this._allSlots.getChildren(), t = [], i = 0, n = e.length; i < n; i += 1) {
    var o = e[i].itemInstance;
    o && t.push({
      UID: o.objectUID,
      GID: o.objectGID,
      quantity: o.quantity
    });
  }
  return t;
};
n.prototype.getRuneSignatureInfo = function () {
  var e = this._signatureSlot.itemInstance;
  return e ? {
    UID: e.objectUID,
    GID: e.objectGID,
    quantity: e.quantity
  } : {};
};
n.prototype.setCrafterJobLevel = function (e, t, i) {
  t ? this._playerRole.setText(i + " " + u("ui.common.short.level") + " " + t) : this._playerRole.setText(u("ui.craft.client"));
};
n.prototype.clear = function () {
  this._unselectCurrentSlot();
  this.hideDropHighlight();
  this._minMaxSelector.hide();
  this._isRemote = !1;
  this._usedSlots = 0;
  this._runeSignatureUid = null;
  this._signatureSlot.unset();
  this._signatureSlot.hide();
  for (var e = this._allSlots.getChildren(), t = 0; t < e.length; t++) {
    e[t].unset();
  }
  this.setNbSlots();
};
this.selectedSlot && this._unselectCurrentSlot();
this.selectedSlot = e;
e.select({
  extraStyle: t
});
o.toggleClassName("locked", a);
o.isLocked = a;
this._isRemote = !0;
this._slotsContainer.addClassNames("client");
i[i.length - 1].unset();
this._usedSlots -= 1;
this._unselectCurrentSlot();
this.hideDropHighlight();
this._minMaxSelector.hide();
this._isRemote = !1;
this._usedSlots = 0;
this._runeSignatureUid = null;
this._signatureSlot.unset();
this._signatureSlot.hide();
o._craftResultBox.toggleReady(t);
o._mySlotElems.toggleReady(t);
o._targetSlotElems.toggleReady(t);
t ? c.playerData.id === e.id && (i.setText(a("ui.common.cancel")), o._restoreMergeStopButtons()) : (i.setText(a("ui.common.merge")), o._isReady = !1);
o._craftResultBox.toggleReady(!1);
o._mySlotElems.toggleReady(!1);
o._targetSlotElems.toggleReady(!1);
o._buttonMerge.setText(a("ui.common.merge"));
o._isReady = !1;
this.jobsData = c.playerData.jobs;
this._mySlotElems = null;
this._targetSlotElems = null;
this._craftResultBox = null;
this._isReady = !1;
this._otherName = "";
this._updateSlotElems = function (e) {
  o._updateMySlotElems(e);
  var t = 9 === e;
  o._targetSlotElems.setPlayerName(o._otherName);
  o._targetSlotElems.setNbSlots();
  o._targetSlotElems.setAsRemote();
  o._mySlotElems.toggleSignatureSlot(t && "CRAFTER" === o.jobsData.craftSide);
  o._targetSlotElems.toggleSignatureSlot(t && "CLIENT" === o.jobsData.craftSide);
};
this._onResultEvents = function (e) {
  i();
  o._buttonMerge.disable();
  o._onResult(e, function (e, t) {
    if (e) {
      return console.error("Crafting multi: onResult error", e);
    }
    var i = t.message,
      n = t.craftResult,
      s = t.objectInfo,
      l = t.objectName,
      c = s && s.quantity || 1;
    n === r.CRAFT_SUCCESS && (i = "CRAFTER" === o.jobsData.craftSide ? a("ui.craft.successTarget", c, l, o._otherName) : a("ui.craft.successOther", o._otherName, c, l));
    o.giveTheResult(s, i);
  });
};
c.on("ExchangeObjectAddedMessage", n);
c.on("ExchangeObjectModifiedMessage", n);
c.on("ExchangeObjectRemovedMessage", n);
c.on("ExchangeGoldPaymentForCraftMessage", n);
c.on("ExchangeItemPaymentForCraftMessage", n);
c.on("ExchangeModifiedPaymentForCraftMessage", n);
c.on("ExchangeRemovedPaymentForCraftMessage", n);
c.on("ExchangeClearPaymentForCraftMessage", n);
c.on("ExchangeIsReadyMessage", n);
this.on("close", function () {
  o._otherName = "";
  d = 0;
  i();
  l.close("craftPayment");
});
this._buttonMergeAction = function () {
  var e = o._mySlotElems.getGivenIngredientsInfo().length;
  e += o._targetSlotElems.getGivenIngredientsInfo().length;
  e < 1 || (o._isReady = !o._isReady, window.dofus.sendMessage("ExchangeReadyMessage", {
    ready: o._isReady,
    step: d
  }));
};
o._targetSlotElems.setPlayerName(o._otherName);
o._targetSlotElems.setNbSlots();
o._targetSlotElems.setAsRemote();
o._mySlotElems.toggleSignatureSlot(t && "CRAFTER" === o.jobsData.craftSide);
o._targetSlotElems.toggleSignatureSlot(t && "CLIENT" === o.jobsData.craftSide);
i();
o._buttonMerge.disable();
o._onResult(e, function (e, t) {
  if (e) {
    return console.error("Crafting multi: onResult error", e);
  }
  var i = t.message,
    n = t.craftResult,
    s = t.objectInfo,
    l = t.objectName,
    c = s && s.quantity || 1;
  n === r.CRAFT_SUCCESS && (i = "CRAFTER" === o.jobsData.craftSide ? a("ui.craft.successTarget", c, l, o._otherName) : a("ui.craft.successOther", o._otherName, c, l));
  o.giveTheResult(s, i);
});
n === r.CRAFT_SUCCESS && (i = "CRAFTER" === o.jobsData.craftSide ? a("ui.craft.successTarget", c, l, o._otherName) : a("ui.craft.successOther", o._otherName, c, l));
o.giveTheResult(s, i);
o._otherName = "";
d = 0;
i();
l.close("craftPayment");
e += o._targetSlotElems.getGivenIngredientsInfo().length;
e < 1 || (o._isReady = !o._isReady, window.dofus.sendMessage("ExchangeReadyMessage", {
  ready: o._isReady,
  step: d
}));
o(n, s);
e.exports = n;
n.prototype._onOpen = function (e) {
  var t = e && e.sourceName || "",
    i = e && e.targetName || "",
    n = window.gui.playerData.characterBaseInformations.name,
    o = t === n;
  this._otherName = o ? i : t;
  var a = e && e.isCrafter;
  s.prototype._onOpen.call(this, e);
  l.close("cancel", {
    keepDialog: !0
  });
  var r = e && e.msg || {},
    c = r.enrichData && r.enrichData.jobName || "";
  this._targetSlotElems.setCrafterJobLevel(r.skillId, r.crafterJobLevel, c);
  this._targetSlotElems.show();
  this._paymentButton.show();
  var d = l.getWindow("craftPayment");
  d.setForCrafter(a);
  d.setOnSuccess(!1);
};
s.prototype._onOpen.call(this, e);
l.close("cancel", {
  keepDialog: !0
});
this._targetSlotElems.setCrafterJobLevel(r.skillId, r.crafterJobLevel, c);
this._targetSlotElems.show();
this._paymentButton.show();
d.setForCrafter(a);
d.setOnSuccess(!1);
s.crafter = a;
s.on("tap", e);
w.table.delRow(i);
delete C[e.playerId];
w.selector.clearContent();
w.table.clearContent();
b.on("ExchangeStartOkJobIndexMessage", function (e) {
  u.openDialog(w.id, {
    msg: e
  });
});
b.on("JobCrafterDirectoryListMessage", function (e) {
  f(e.listEntries);
});
b.on("JobCrafterDirectoryAddMessage", function (e) {
  return C[e.listEntry.playerInfo.playerId] ? v(e.listEntry) : void g(e.listEntry);
});
b.on("JobCrafterDirectoryRemoveMessage", _);
this.once("open", function () {
  w.selector = w.windowBody.appendChild(new l());
  w.table = w.windowBody.appendChild(new c({
    colIds: ["avatar", "name", "level", "coord", "cost", "nbSlots", "button"],
    colCount: 7,
    highlightable: !0,
    headerContent: ["", r("ui.common.name"), r("ui.common.short.level"), r("ui.common.coordinatesSmall"), r("ui.common.cost"), "nb", ""]
  }));
  w.selector.on("change", function (e) {
    return e < 0 ? void w.table.clearContent() : (T = e, void window.dofus.sendMessage("JobCrafterDirectoryListRequestMessage", {
      jobId: e.id
    }));
  });
});
this.on("open", function (e) {
  e = e || {};
  M = e.msg.jobs;
  d.getData("Jobs", M, function (e, t) {
    if (e) {
      return console.error(e);
    }
    w.selector.clearContent();
    w.selector.addOption(r("ui.craft.chooseJob"), -1);
    for (var i = 0; i < t.length; i += 1) {
      var n = t[i];
      w.selector.addOption(n.nameId, n);
    }
    1 === t.length && w.selector.select(t[0]);
  });
});
this.on("close", y);
w.selector = w.windowBody.appendChild(new l());
w.table = w.windowBody.appendChild(new c({
  colIds: ["avatar", "name", "level", "coord", "cost", "nbSlots", "button"],
  colCount: 7,
  highlightable: !0,
  headerContent: ["", r("ui.common.name"), r("ui.common.short.level"), r("ui.common.coordinatesSmall"), r("ui.common.cost"), "nb", ""]
}));
w.selector.on("change", function (e) {
  return e < 0 ? void w.table.clearContent() : (T = e, void window.dofus.sendMessage("JobCrafterDirectoryListRequestMessage", {
    jobId: e.id
  }));
});
e = e || {};
M = e.msg.jobs;
d.getData("Jobs", M, function (e, t) {
  if (e) {
    return console.error(e);
  }
  w.selector.clearContent();
  w.selector.addOption(r("ui.craft.chooseJob"), -1);
  for (var i = 0; i < t.length; i += 1) {
    var n = t[i];
    w.selector.addOption(n.nameId, n);
  }
  1 === t.length && w.selector.select(t[0]);
});
w.selector.clearContent();
w.selector.addOption(r("ui.craft.chooseJob"), -1);
a(n, s);
e.exports = n;
n.characterDisplay.clear();
n.characterDisplay.setLook(e, {
  direction: l.DIRECTION_SOUTH,
  animation: "AnimStatique",
  boneType: "characters/",
  skinType: "characters/",
  riderOnly: !0
});
window.gui.playerData.id === o ? e(window.gui.playerData.characterBaseInformations.entityLook) : window.dofus.sendMessage("ContactLookRequestByIdMessage", {
  contactType: r.SOCIAL_CONTACT_CRAFTER,
  playerId: t.playerInfo.playerId
});
n.name.setText(t.playerInfo.playerName);
n.jobName.setText(i.nameId);
n.jobLevel.setText(t.jobInfo.jobLevel);
m.preloadImage(l, function (e) {
  n.characterDisplay.setStyle("backgroundImage", e);
});
n.nearCraftTable.setText(t.playerInfo.isInWorkshop ? c : g);
n.coordinates.setText("-");
t.playerInfo.isInWorkshop && (n.coordinates.setText("( " + t.playerInfo.worldX + "," + t.playerInfo.worldY + " )"), p.getData("SubAreas", t.playerInfo.subAreaId, function (e, t) {
  if (e) {
    return console.error(e);
  }
  var i = window.gui.databases.Areas[t.areaId];
  n.location.setText(i.nameId + " ( " + t.nameId + " )");
}));
n.checkboxNotFree.toggleActivation(u);
n.freeOnFailCheckbox.toggleDisplay(!!i.specializationOfId);
n.freeOnFailCheckbox.toggleActivation(h);
n.checkboxRessourcesNeeded.toggleActivation(_);
n.minItems.setText(t.jobInfo.minSlots);
n.messageButton.enable();
n.characterDisplay.release();
delete n.crafter;
this.once("open", function () {
  var i = this.windowBody.createChild("div", {
      className: "colsWrapper"
    }),
    s = i.createChild("div", {
      className: "col1"
    }),
    r = i.createChild("div", {
      className: "col2"
    }),
    l = s.createChild("div", {
      className: ["block", "blockCharacter"]
    });
  this.characterDisplay = l.appendChild(new a({
    scale: 2
  }));
  this.characterDisplay.clear();
  var c = r.createChild("div", {
    className: ["block", "blockInfos"]
  });
  c.createChild("div", {
    className: "title",
    text: u("ui.common.informations")
  });
  var d = c.createChild("div", {
    className: "line"
  });
  d.createChild("div", {
    className: "label",
    text: u("ui.common.name")
  });
  this.name = d.createChild("div", {
    className: ["value", "name"]
  });
  var p = c.createChild("div", {
    className: "line"
  });
  p.createChild("div", {
    className: "label",
    text: u("ui.craft.job")
  });
  this.jobName = p.createChild("div", {
    className: ["value", "job"]
  });
  var m = c.createChild("div", {
    className: "line"
  });
  m.createChild("div", {
    className: "label",
    text: u("ui.craft.jobLevel")
  });
  this.jobLevel = m.createChild("div", {
    className: ["value", "jobLevel"]
  });
  var f = r.createChild("div", {
    className: ["block", "blockLocation"]
  });
  f.createChild("div", {
    className: "title",
    text: u("ui.common.localisation")
  });
  var g = f.createChild("div", {
    className: "line"
  });
  this.location = g.createChild("div", {
    className: ["value", "location"]
  });
  var _ = f.createChild("div", {
    className: "line"
  });
  _.createChild("div", {
    className: "label",
    text: u("ui.craft.nearCraftTable")
  });
  this.nearCraftTable = _.createChild("div", {
    className: ["value", "nearCraftTable"]
  });
  var v = f.createChild("div", {
    className: "line"
  });
  v.createChild("div", {
    className: "label",
    text: u("ui.common.coordinates")
  });
  this.coordinates = v.createChild("div", {
    className: ["value", "coordinates"]
  });
  var y = r.createChild("div", {
    className: ["block", "blockOptions"]
  });
  y.createChild("div", {
    className: "title",
    text: u("ui.craft.jobOptions")
  });
  this.checkboxNotFree = y.appendChild(new h(u("ui.craft.notFree")));
  this.checkboxNotFree.disable();
  this.freeOnFailCheckbox = y.appendChild(new h(u("ui.craft.freeIfFailed")));
  this.freeOnFailCheckbox.addClassNames("freeOnFail");
  this.freeOnFailCheckbox.disable();
  this.checkboxRessourcesNeeded = y.appendChild(new h(u("ui.craft.ressourcesNeeded")));
  this.checkboxRessourcesNeeded.disable();
  var w = y.createChild("div", {
    className: "line"
  });
  w.createChild("div", {
    className: "label",
    text: u("ui.craft.minItemInCraft")
  });
  this.minItems = w.createChild("div", {
    className: ["value", "minItems"]
  });
  this.messageButton = this.windowBody.appendChild(new o(u("ui.common.wMessage")));
  this.messageButton.addClassNames("messageButton");
  this.messageButton.on("tap", function () {
    window.gui.chat.startPrivateMessage(n.crafter.playerInfo.playerName);
  });
  window.gui.on("ContactLookMessage", function (t) {
    n.crafter && e(t.look);
  });
  window.gui.on("JobCrafterDirectoryAddMessage", function (e) {
    n.crafter && e.listEntry.playerInfo.playerId === n.crafter.playerInfo.playerId && (n.crafter = e.listEntry, t(n.crafter, n.job));
  });
  window.gui.on("JobCrafterDirectoryRemoveMessage", function (e) {
    n.crafter && e.playerId === n.crafter.playerInfo.playerId && n.messageButton.disable();
  });
});
this.on("open", function (e) {
  e = e || {};
  this.crafter = e.crafter;
  this.job = e.job;
  t(this.crafter, this.job);
});
this.on("close", i);
this.characterDisplay = l.appendChild(new a({
  scale: 2
}));
this.characterDisplay.clear();
d.createChild("div", {
  className: "label",
  text: u("ui.common.name")
});
this.name = d.createChild("div", {
  className: ["value", "name"]
});
p.createChild("div", {
  className: "label",
  text: u("ui.craft.job")
});
this.jobName = p.createChild("div", {
  className: ["value", "job"]
});
m.createChild("div", {
  className: "label",
  text: u("ui.craft.jobLevel")
});
this.jobLevel = m.createChild("div", {
  className: ["value", "jobLevel"]
});
_.createChild("div", {
  className: "label",
  text: u("ui.craft.nearCraftTable")
});
this.nearCraftTable = _.createChild("div", {
  className: ["value", "nearCraftTable"]
});
v.createChild("div", {
  className: "label",
  text: u("ui.common.coordinates")
});
this.coordinates = v.createChild("div", {
  className: ["value", "coordinates"]
});
y.createChild("div", {
  className: "title",
  text: u("ui.craft.jobOptions")
});
this.checkboxNotFree = y.appendChild(new h(u("ui.craft.notFree")));
this.checkboxNotFree.disable();
this.freeOnFailCheckbox = y.appendChild(new h(u("ui.craft.freeIfFailed")));
this.freeOnFailCheckbox.addClassNames("freeOnFail");
this.freeOnFailCheckbox.disable();
this.checkboxRessourcesNeeded = y.appendChild(new h(u("ui.craft.ressourcesNeeded")));
this.checkboxRessourcesNeeded.disable();
w.createChild("div", {
  className: "label",
  text: u("ui.craft.minItemInCraft")
});
this.minItems = w.createChild("div", {
  className: ["value", "minItems"]
});
this.messageButton = this.windowBody.appendChild(new o(u("ui.common.wMessage")));
this.messageButton.addClassNames("messageButton");
this.messageButton.on("tap", function () {
  window.gui.chat.startPrivateMessage(n.crafter.playerInfo.playerName);
});
window.gui.on("ContactLookMessage", function (t) {
  n.crafter && e(t.look);
});
window.gui.on("JobCrafterDirectoryAddMessage", function (e) {
  n.crafter && e.listEntry.playerInfo.playerId === n.crafter.playerInfo.playerId && (n.crafter = e.listEntry, t(n.crafter, n.job));
});
window.gui.on("JobCrafterDirectoryRemoveMessage", function (e) {
  n.crafter && e.playerId === n.crafter.playerInfo.playerId && n.messageButton.disable();
});
e = e || {};
this.crafter = e.crafter;
this.job = e.job;
t(this.crafter, this.job);
c(n, d);
e.exports = n;
g.call(this, {
  className: "CraftMagusWindow",
  title: "",
  positionInfo: {
    left: "0.5%",
    bottom: "2%",
    width: "76%",
    height: "95%"
  },
  noCloseButton: !0
});
this._initialize();
this.once("open", this._createDom);
this.on("open", this._onOpen);
this.on("close", this._onClose);
d(n, g);
e.exports = n;
n.prototype._initVariables = function (e) {
  this.isMultiCraft = !!e;
  this.exchangeStep = 0;
  this.isInAutoCraft = !1;
  this.newItemInstance = null;
  this.newItemSlotType = null;
  this.skillId = null;
  this.skillData = null;
  this.droppedLocation = "";
  this.droppedItemSource = "";
  this.currentCraftingItem = null;
};
n.prototype._initialize = function () {
  function e() {
    d.isInAutoCraft = !0;
    d._updateCraftingButtons();
    u("ExchangeReplayMessage", {
      count: -1
    });
    u("ExchangeReadyMessage", {
      ready: !0,
      step: d.exchangeStep
    });
  }
  function t() {
    d.isInAutoCraft = !1;
    d._updateCraftingButtons();
    u("ExchangeReadyMessage", {
      ready: !0,
      step: d.exchangeStep
    });
  }
  function i(e) {
    h.createItemInstances(e.object, function (e, t) {
      if (e) {
        return console.error("Craft Magus: updateSlot cannot createItemInstances", e);
      }
      if (d.openState) {
        var i = t.array[0],
          n = d._getItemSlotType(i.item),
          o = d._getSlotByType(n);
        o.setItem(i);
        o.dragUiInfo.backgroundImage = o.getImage();
        l.enableDrag(o);
        "item" === n && (d.currentCraftingItem = i, d.itemBox.displayItem(i), d.setItemBoxVisibility(!0));
        d._updateCraftingButtons();
      }
    });
  }
  function n(e) {
    var t = e.objectUID,
      i = d._getSlotTypeByUID(t);
    i && (d._unselectCurrentSlot(), d._resetSlot(i), d._updateSlotsImage(), "item" === i && d.setItemBoxVisibility(!1), d._updateCraftingButtons());
  }
  function o(e) {
    i(e);
    p();
  }
  function a(e) {
    n(e);
    p();
  }
  function s(e) {
    var t = window.gui;
    if (e.craftResult === r.CRAFT_IMPOSSIBLE) {
      var i = c("ui.craft.noResult");
      return t.openSimplePopup(i), t.chat.logMsg(i), u("ExchangeReadyMessage", {
        ready: !1,
        step: d.exchangeStep
      }), d.isInAutoCraft = !1, void d._updateCraftingButtons();
    }
    h.createItemInstances(e.objectInfo, function (t, i) {
      if (t) {
        return console.error("CraftMagusWindow createItemInstances", t);
      }
      if (d.openState) {
        var n = i.array[0];
        _.display(d.currentCraftingItem, n, e);
      }
    });
  }
  this._initVariables();
  var d = this,
    u = window.dofus.sendMessage,
    p = this.incrementStep = function () {
      d.exchangeStep += 1;
    };
  this.onMergeAllBtnTap = e;
  this.onMergeBtnTap = t;
  var m = window.gui;
  m.on("ObjectModifiedMessage", this.localizeEvent(i));
  m.on("ExchangeObjectAddedMessage", this.localizeEvent(o));
  m.on("ExchangeObjectModifiedMessage", this.localizeEvent(o));
  m.on("ExchangeObjectRemovedMessage", this.localizeEvent(a));
  m.on("ExchangeCraftResultMagicWithObjectDescMessage", this.localizeEvent(s));
  m.on("ExchangeCraftResultMessage", this.localizeEvent(s));
  m.on("ExchangeItemAutoCraftStopedMessage", this.localizeEvent(this._onAutoCraftStopped.bind(this)));
};
n.prototype._createDom = function () {
  function e(e, t, n) {
    var o = n.getItem();
    return !!o && i.jobsData.getQuickTransferInfo("crafting", o, 1).movedQty > 0;
  }
  function t(t) {
    var n = new p({
      name: t,
      noDoubleTap: !0
    });
    return n.dragUiInfo = {
      backgroundImage: "none",
      prepareForDrag: e
    }, l.setDraggable(n, n.dragUiInfo, "crafting", {
      slot: n
    }), l.disableDrag(n), n.on("tap", function () {
      i._simpleTapOnSlot(n);
    }), n;
  }
  var i = this,
    n = this.col1 = this.windowBody.createChild("div", {
      className: "col1"
    }),
    s = this.col2 = this.windowBody.createChild("div", {
      className: "col2"
    }),
    r = this.craftingBoxContainer = n.createChild("div", {
      className: "craftingBoxContainer"
    }),
    d = r.createChild("div", {
      className: ["craftingBoxDropArea", "hoverable"]
    });
  l.setDroppable(d, ["craftInventory", "ingredientsBag"], {
    isDropAllowed: o
  });
  d.on("drop", this._itemDropOnCraftBox.bind(this));
  d.myWindow = this;
  for (var h = this.craftingBox = d.createChild("div", {
      className: "craftingBox"
    }), g = this.craftingSlots = h.createChild("div", {
      className: "craftingSlots"
    }), _ = 0; _ < M.length; _ += 1) {
    var v = M[_];
    g.appendChild(t(v));
  }
  this.minMaxSelector = this.windowContent.appendChild(new m());
  this.minMaxSelector.on("confirm", this._moveItem.bind(this));
  var y = n.createChild("div", {
    className: "buttonsContainer"
  });
  this.mergeAllBtn = y.appendChild(new a(c("ui.common.mergeAll"), {
    className: "mergeAllBtn"
  }));
  this.mergeAllBtn.on("tap", this.onMergeAllBtnTap);
  this.stopBtn = y.appendChild(new a(c("ui.common.stop"), {
    className: "stopBtn"
  }));
  this.stopBtn.on("tap", this._onStopBtnTap.bind(this));
  this.mergeBtn = y.appendChild(new a(c("ui.common.merge"), {
    className: "mergeBtn"
  }));
  this.mergeBtn.on("tap", this.onMergeBtnTap);
  this._setEnableCraftingButtons(!1);
  this.itemBox = s.appendChild(new u({
    showDescription: !0,
    showTitle: !0,
    minRows: 0
  }));
  this.itemPlaceholder = new f(s, {
    noHeight: !0
  });
  this.itemPlaceholder.setText(" ");
};
n.prototype._onOpen = function (e) {
  this.jobsData = window.gui.playerData.jobs;
  var t = e.msg;
  this.skillId = t.skillId;
  this.skillData = this.jobsData.getSkill(t.skillId);
  this.setTitle(this.skillData.nameId);
  this._updateSlotsImage();
  this.selectedSlot = null;
  this.setItemBoxPlaceholderText(c("tablet.craftHelp.magicSolo"));
  this.setItemBoxVisibility(!1);
  this.jobsData.startCraftingSession("SOLO", this.skillId, 1);
};
n.prototype._onClose = function () {
  this.jobsData.clearAfterCraft();
  this._initVariables();
  this._resetSlots();
  this._unselectCurrentSlot();
  this.setItemBoxVisibility(!1);
  this._setEnableCraftingButtons(!1);
};
n.prototype._isCraftableItem = function (e) {
  return this.skillData.modifiableItemType === e.typeId;
};
n.prototype._hasSignatureSlot = function () {
  var e = window.gui.playerData.jobs.list,
    t = this.skillData.parentJobId,
    i = e[t] || {},
    n = i.experience || {};
  return n.jobLevel >= b;
};
n.prototype._getSlotByType = function (e) {
  return this.craftingSlots.getChild(e);
};
n.prototype._slotHasItem = function (e) {
  var t = this._getSlotByType(e);
  return !!t.itemInstance;
};
n.prototype._updateSlotsImage = function () {
  var e = this.skillData.modifiableItemType;
  this._getSlotByType("item").setBackgroundImageByItemType(e);
  this._getSlotByType("rune").setBackgroundImageByItemType(v);
  var t = this._hasSignatureSlot(),
    i = this._getSlotByType("signatureRune");
  i.toggleClassName("signatureSlot", t);
  i.toggleClassName("locked", !t);
};
n.prototype._resetSlot = function (e) {
  var t = this._getSlotByType(e);
  t.unset();
  l.disableDrag(t);
};
n.prototype._resetSlots = function () {
  for (var e = 0; e < M.length; e += 1) {
    this._resetSlot(M[e]);
  }
};
n.prototype._getItemSlotType = function (e) {
  var t,
    i = this.skillData;
  return this._isCraftableItem(e) ? t = "item" : i.isForgemagus && e.typeId === v || e.typeId === y ? t = "rune" : e.id === w && (t = "signatureRune"), t;
};
n.prototype._getSlotTypeByUID = function (e) {
  for (var t = 0; t < M.length; t += 1) {
    var i = M[t],
      n = this._getSlotByType(i);
    if (n.itemInstance && n.itemInstance.objectUID === e) {
      return i;
    }
  }
};
n.prototype._setEnableMergeButtons = function (e) {
  this.mergeAllBtn.setEnable(e);
  this.mergeBtn.setEnable(e);
};
n.prototype._setEnableCraftingButtons = function (e) {
  this._setEnableMergeButtons(e);
  this.stopBtn.setEnable(e);
};
n.prototype._updateCraftingButtons = function () {
  this._setEnableMergeButtons(!this.isInAutoCraft && this._slotHasItem("item") && this._slotHasItem("rune"));
  this.stopBtn.setEnable(this.isInAutoCraft);
  this.isInAutoCraft ? this.jobsData.startCombining() : this.jobsData.stopCombining();
};
n.prototype._moveItem = function (e) {
  this.jobsData.moveItemToCraft("craftInventory", this.newItemInstance, e);
};
n.prototype._itemDropOnCraftBox = function (e, t) {
  if (this.skillId && e.itemInstance && (this.newItemSlotType = this._getItemSlotType(e.itemInstance.item), this.newItemSlotType)) {
    var i = this.newItemInstance = e.itemInstance;
    this.droppedLocation = "crafting";
    this.droppedItemSource = t;
    var n = e.getQuantity();
    n = this.jobsData.howManyCanBeAddedToCraft(t, i, n);
    0 !== n && (1 === n ? this._moveItem(1) : this.minMaxSelector.open({
      min: 1,
      max: n,
      defaultValue: n,
      x: T,
      y: C
    }));
  }
};
n.prototype._onStopBtnTap = function () {
  window.dofus.sendMessage("ExchangeReplayStopMessage");
};
n.prototype._onAutoCraftStopped = function (e) {
  s.displayAutoCraftStopReasonMessage(e.reason);
  this.isInAutoCraft = !1;
  this._updateCraftingButtons();
};
n.prototype.setItemBoxPlaceholderText = function (e) {
  this.placeholderText = e;
  this.isPlaceholderVisible && this.itemPlaceholder.setText(this.placeholderText);
};
n.prototype.setItemBoxVisibility = function (e) {
  this.itemBox.toggleDisplay(e);
  e ? this.itemPlaceholder.setText(null) : this.itemPlaceholder.setText(this.placeholderText);
  this.isPlaceholderVisible = !e;
};
n.prototype._simpleTapOnSlot = function (e) {
  var t = e.getItem();
  if (t) {
    e !== this.selectedSlot && window.gui.openContextualMenuAround("item", e, {
      item: t
    });
    var i = this.jobsData.getQuickTransferInfo("crafting", t, e.getQuantity());
    i.movedQty && (e !== this.selectedSlot ? this._selectCurrentSlot(e, i.movedQty > 1 ? "stackMove" : "") : this.jobsData.removeItemFromCraft(t.objectUID, i.movedQty));
  }
};
n.prototype._selectCurrentSlot = function (e, t) {
  this.selectedSlot && this._unselectCurrentSlot();
  this.selectedSlot = e;
  e.select({
    extraStyle: t
  });
};
n.prototype._unselectCurrentSlot = function () {
  this.selectedSlot && (this.selectedSlot.unselect(), this.selectedSlot = null);
};
this.isMultiCraft = !!e;
this.exchangeStep = 0;
this.isInAutoCraft = !1;
this.newItemInstance = null;
this.newItemSlotType = null;
this.skillId = null;
this.skillData = null;
this.droppedLocation = "";
this.droppedItemSource = "";
this.currentCraftingItem = null;
d.isInAutoCraft = !0;
d._updateCraftingButtons();
u("ExchangeReplayMessage", {
  count: -1
});
u("ExchangeReadyMessage", {
  ready: !0,
  step: d.exchangeStep
});
d.isInAutoCraft = !1;
d._updateCraftingButtons();
u("ExchangeReadyMessage", {
  ready: !0,
  step: d.exchangeStep
});
o.setItem(i);
o.dragUiInfo.backgroundImage = o.getImage();
l.enableDrag(o);
"item" === n && (d.currentCraftingItem = i, d.itemBox.displayItem(i), d.setItemBoxVisibility(!0));
d._updateCraftingButtons();
i(e);
p();
n(e);
p();
this.onMergeAllBtnTap = e;
this.onMergeBtnTap = t;
m.on("ObjectModifiedMessage", this.localizeEvent(i));
m.on("ExchangeObjectAddedMessage", this.localizeEvent(o));
m.on("ExchangeObjectModifiedMessage", this.localizeEvent(o));
m.on("ExchangeObjectRemovedMessage", this.localizeEvent(a));
m.on("ExchangeCraftResultMagicWithObjectDescMessage", this.localizeEvent(s));
m.on("ExchangeCraftResultMessage", this.localizeEvent(s));
m.on("ExchangeItemAutoCraftStopedMessage", this.localizeEvent(this._onAutoCraftStopped.bind(this)));
l.setDroppable(d, ["craftInventory", "ingredientsBag"], {
  isDropAllowed: o
});
d.on("drop", this._itemDropOnCraftBox.bind(this));
d.myWindow = this;
this.minMaxSelector = this.windowContent.appendChild(new m());
this.minMaxSelector.on("confirm", this._moveItem.bind(this));
this.mergeAllBtn = y.appendChild(new a(c("ui.common.mergeAll"), {
  className: "mergeAllBtn"
}));
this.mergeAllBtn.on("tap", this.onMergeAllBtnTap);
this.stopBtn = y.appendChild(new a(c("ui.common.stop"), {
  className: "stopBtn"
}));
this.stopBtn.on("tap", this._onStopBtnTap.bind(this));
this.mergeBtn = y.appendChild(new a(c("ui.common.merge"), {
  className: "mergeBtn"
}));
this.mergeBtn.on("tap", this.onMergeBtnTap);
this._setEnableCraftingButtons(!1);
this.itemBox = s.appendChild(new u({
  showDescription: !0,
  showTitle: !0,
  minRows: 0
}));
this.itemPlaceholder = new f(s, {
  noHeight: !0
});
this.itemPlaceholder.setText(" ");
this.skillId = t.skillId;
this.skillData = this.jobsData.getSkill(t.skillId);
this.setTitle(this.skillData.nameId);
this._updateSlotsImage();
this.selectedSlot = null;
this.setItemBoxPlaceholderText(c("tablet.craftHelp.magicSolo"));
this.setItemBoxVisibility(!1);
this.jobsData.startCraftingSession("SOLO", this.skillId, 1);
this.jobsData.clearAfterCraft();
this._initVariables();
this._resetSlots();
this._unselectCurrentSlot();
this.setItemBoxVisibility(!1);
this._setEnableCraftingButtons(!1);
this._getSlotByType("item").setBackgroundImageByItemType(e);
this._getSlotByType("rune").setBackgroundImageByItemType(v);
i.toggleClassName("signatureSlot", t);
i.toggleClassName("locked", !t);
t.unset();
l.disableDrag(t);
this.mergeAllBtn.setEnable(e);
this.mergeBtn.setEnable(e);
this._setEnableMergeButtons(e);
this.stopBtn.setEnable(e);
this._setEnableMergeButtons(!this.isInAutoCraft && this._slotHasItem("item") && this._slotHasItem("rune"));
this.stopBtn.setEnable(this.isInAutoCraft);
this.isInAutoCraft ? this.jobsData.startCombining() : this.jobsData.stopCombining();
this.droppedLocation = "crafting";
this.droppedItemSource = t;
n = this.jobsData.howManyCanBeAddedToCraft(t, i, n);
0 !== n && (1 === n ? this._moveItem(1) : this.minMaxSelector.open({
  min: 1,
  max: n,
  defaultValue: n,
  x: T,
  y: C
}));
s.displayAutoCraftStopReasonMessage(e.reason);
this.isInAutoCraft = !1;
this._updateCraftingButtons();
this.placeholderText = e;
this.isPlaceholderVisible && this.itemPlaceholder.setText(this.placeholderText);
this.itemBox.toggleDisplay(e);
e ? this.itemPlaceholder.setText(null) : this.itemPlaceholder.setText(this.placeholderText);
this.isPlaceholderVisible = !e;
this.selectedSlot && this._unselectCurrentSlot();
this.selectedSlot = e;
e.select({
  extraStyle: t
});
d = d.filter(o);
u = u.filter(o);
d.forEach(function (e) {
  m[e.actionId] = e;
});
u.forEach(function (e) {
  f[e.actionId] = e;
});
y = d[g];
_ = y.actionId;
w = y.value;
v && (M.push({
  _type: y._type,
  actionId: _,
  value: v,
  effectCaller: "CraftMagus " + e.objectGID
}), v > 0 && (b = !0));
T.push(_);
y = u[g];
_ = y.actionId;
T.indexOf(_) >= 0 || (w = y.value, M.push({
  _type: y._type,
  actionId: _,
  value: w,
  effectCaller: "CraftMagus " + e.objectGID
}), w > 0 && (b = !0));
n = t[l];
n.effect.bonusType && (o = n.description, o = n.value > 0 ? "+" + o : o, a += " " + o + ",", a = a.replace("--", "-"));
i.magicPoolStatus === r.MAGIC_POOL_INCREASE ? d = " +" + s("ui.craft.smithResidualMagic") : i.magicPoolStatus === r.MAGIC_POOL_LOSS ? d = " -" + s("ui.craft.smithResidualMagic") : a = a.substring(0, a.length - 1);
a += d;
a && (A += s("ui.common.colon"));
c.logMsg(A + a);
c.call(this);
this.addClassNames("CraftMagusMultiWindow");
this.on("opened", function () {
  this._resizeIngredientSlots();
  this._updateIngrediensSlotsPageCount();
});
this._resizeIngredientSlots();
this._updateIngrediensSlotsPageCount();
h(n, c);
e.exports = n;
n.prototype._initVariables = function () {
  c.prototype._initVariables.call(this, !0);
  this.isCrafter = null;
  this.isCraftingMode = !1;
  this.crafterSkillLevel = 1;
  this.currentPage = -1;
  this.pageCount = -1;
};
n.prototype._initialize = function () {
  function e(e) {
    var t = !!e.allowed;
    l.allowCrafterIngredientsCheckbox.toggleActivation(t, !0);
    l.jobsData.setCrafterIngredientsAllowed(t);
  }
  function t(e, t, i) {
    var n = l.jobsData.getQuickTransferInfo("ingredientsBag", i.getItem(), 1);
    return n.movedQty > 0;
  }
  function i(e) {
    l._unselectBagSlot();
    var i = e.object;
    p.createItemInstances(i, function (e, n) {
      if (e) {
        return console.error(e);
      }
      var a = n.map[i.objectUID],
        s = new m({
          itemData: a,
          name: i.objectUID,
          noDoubleTap: !0
        });
      s.setQuantity(a.quantity);
      l.ingredientsSlots.appendChild(s);
      s.on("tap", o);
      s.myWindow = l;
      d.setDraggable(s, {
        backgroundImage: s.getImage(),
        prepareForDrag: t
      }, "ingredientsBag", {
        slot: s
      });
      l._updateIngrediensSlotsPageCount();
    });
  }
  function n(e) {
    l._unselectBagSlot();
    var t = e.object,
      i = t.objectUID,
      n = t.quantity,
      o = l.ingredientsSlots.getChild(i);
    o && o.setQuantity(n);
  }
  function a(e) {
    l._unselectBagSlot();
    var t = e.objectUID,
      i = l.ingredientsSlots.getChild(t);
    i && (i.destroy(), l._updateIngrediensSlotsPageCount());
  }
  function s(e, t, i) {
    if (l._unselectBagSlot(), !(!l.skillId || !e.itemInstance || !l._getItemSlotType(e.itemInstance.item) || l.isCrafter && "craftInventory" === t || l.isCrafter && "crafting" === t && l._isMyItem(e.itemInstance.objectUID))) {
      l.newItemInstance = e.itemInstance;
      l.droppedLocation = "ingredientsBag";
      l.droppedItemSource = t;
      var n = e.getQuantity();
      return 1 === n ? l._moveItem(1) : void l.minMaxSelector.open({
        min: 1,
        max: n,
        defaultValue: n,
        x: i.x,
        y: i.y
      });
    }
  }
  function r(e) {
    var t = e.ready;
    l._updateExchangeReadyDisplay(!!t);
  }
  c.prototype._initialize.call(this);
  var l = this;
  this.itemDropOnBag = s;
  var u = window.gui;
  u.on("ExchangeMultiCraftCrafterCanUseHisRessourcesMessage", this.localizeEvent(e));
  u.on("ExchangeObjectPutInBagMessage", this.localizeEvent(i));
  u.on("ExchangeObjectRemovedFromBagMessage", this.localizeEvent(a));
  u.on("ExchangeObjectModifiedInBagMessage", this.localizeEvent(n));
  u.on("ExchangeIsReadyMessage", this.localizeEvent(r));
  var h = this.incrementStep;
  u.on("ExchangeGoldPaymentForCraftMessage", this.localizeEvent(h));
  u.on("ExchangeItemPaymentForCraftMessage", this.localizeEvent(h));
  u.on("ExchangeModifiedPaymentForCraftMessage", this.localizeEvent(h));
  u.on("ExchangeRemovedPaymentForCraftMessage", this.localizeEvent(h));
  u.on("ExchangeClearPaymentForCraftMessage", this.localizeEvent(h));
};
n.prototype._tapOnBagSlot = function (e) {
  var t = e.getItem(),
    i = e.getQuantity(),
    n = this.jobsData.getQuickTransferInfo("ingredientsBag", t, i),
    o = n.movedQty;
  e !== this.selectedBagSlot && window.gui.openContextualMenuAround("item", e, {
    item: t
  });
  o && (e !== this.selectedBagSlot ? this._selectBagSlot(e, o > 1 ? "stackMove" : "") : this.isCrafter ? this.jobsData.moveItemToCraft("ingredientsBag", t, o) : this.jobsData.removeItemFromCraft(e.itemInstance.objectUID, o));
};
n.prototype._selectBagSlot = function (e, t) {
  this.selectedBagSlot && this._unselectBagSlot();
  this.selectedBagSlot = e;
  e.select({
    extraStyle: t
  });
};
n.prototype._unselectBagSlot = function () {
  this.selectedBagSlot && (this.selectedBagSlot.unselect(), this.selectedBagSlot = null);
};
n.prototype._createDom = function () {
  c.prototype._createDom.call(this);
  var e = this,
    t = this.craftingBox.createChild("div");
  this.crafterName = t.createChild("span", {
    className: "playerName"
  });
  this.crafterDescription = t.createChild("span");
  var i = this.craftingBox.createChild("div");
  this.clientName = i.createChild("span", {
    className: "playerName"
  });
  this.clientDescription = i.createChild("span");
  this.acceptBtn = new s(u("ui.common.accept"), {
    className: "acceptBtn"
  });
  this.acceptBtn.on("tap", function () {
    window.dofus.sendMessage("ExchangeReadyMessage", {
      ready: !0,
      step: e.exchangeStep
    });
  });
  this.acceptBtn.insertBefore(this.stopBtn);
  this.ingredientsBag = this.col1.createChild("div", {
    className: "ingredientsBag"
  });
  this.ingredientsBag.createChild("div", {
    className: "title",
    text: u("ui.craft.ingredientBag")
  });
  this.ingredientsSlotsContainer = this.ingredientsBag.createChild("div", {
    className: "ingredientsSlotsContainer"
  });
  this.ingredientsSlotsBox = this.ingredientsSlotsContainer.createChild("div", {
    className: "ingredientsSlotsBox"
  });
  this.ingredientsSlotsMask = this.ingredientsSlotsBox.createChild("div", {
    className: ["ingredientsSlotsMask", "hoverable"]
  });
  d.setDroppable(this.ingredientsSlotsMask, ["craftInventory", "crafting"], {
    isDropAllowed: a
  });
  this.ingredientsSlotsMask.on("drop", this.itemDropOnBag);
  this.ingredientsSlotsMask.myWindow = this;
  this.ingredientsSlots = this.ingredientsSlotsMask.createChild("div", {
    className: "ingredientsSlots"
  });
  this.pagination = this.ingredientsSlotsContainer.appendChild(new f());
  this.pagination.on("previous", function () {
    e._ingrediensSlotsGoToPage(e.currentPage - 1);
  });
  this.pagination.on("next", function () {
    e._ingrediensSlotsGoToPage(e.currentPage + 1);
  });
  this.pagination.on("page", function (t) {
    e._ingrediensSlotsGoToPage(t);
  });
  this.allowCrafterIngredientsCheckbox = this.ingredientsBag.appendChild(new r(""));
  this.allowCrafterIngredientsCheckbox.on("change", function (e) {
    window.dofus.sendMessage("ExchangeMultiCraftSetCrafterCanUseHisRessourcesMessage", {
      allow: e
    });
  });
  this.paymentBtn = new s(u("ui.common.payment"), {
    className: "paymentBtn"
  });
  this.paymentBtn.on("tap", function () {
    g.open("craftPayment");
  });
  this.col2.appendChild(this.paymentBtn);
};
n.prototype._onOpen = function (e) {
  this.jobsData = window.gui.playerData.jobs;
  var t = e.msg;
  this.skillId = t.skillId;
  this.skillData = this.jobsData.getSkill(t.skillId);
  this.setTitle(this.skillData.nameId);
  this._roleSetup(e);
  this._updateSlotsImage();
  this.selectedBagSlot = null;
  this.jobsData.startCraftingSession(this.isCrafter ? "CRAFTER" : "CLIENT", this.skillId, 1);
  var i = u(this.isCrafter ? "tablet.craftHelp.magicMultiCrafter1" : "tablet.craftHelp.magicMultiClient1");
  this.setItemBoxPlaceholderText(i);
  this.setItemBoxVisibility(!1);
  g.close("cancel", {
    keepDialog: !0
  });
};
n.prototype._onClose = function () {
  c.prototype._onClose.call(this);
  this.ingredientsSlots.clearContent();
  this.selectedBagSlot = null;
  g.close("craftPayment");
};
n.prototype._roleSetup = function (e) {
  var t = e && e.sourceName || "",
    i = e && e.targetName || "",
    n = window.gui.playerData.characterBaseInformations.name,
    o = t === n,
    a = o ? i : t,
    s = e && e.isCrafter;
  this.isCrafter = s;
  this.mergeAllBtn.toggleDisplay(s);
  this.mergeBtn.toggleDisplay(s);
  this.acceptBtn.toggleDisplay(!s);
  this.allowCrafterIngredientsCheckbox.setText(u(s ? "ui.craft.crafterRunesAllowed" : "ui.craft.allowCrafterRunes"));
  var r = !1,
    l = !0;
  this.allowCrafterIngredientsCheckbox.toggleActivation(r, l);
  this.allowCrafterIngredientsCheckbox.setEnable(!s);
  var c = g.getWindow("craftPayment");
  c.setForCrafter(s);
  c.setOnSuccess(!0);
  var d = window.gui.playerData.jobs.list[this.skillData.parentJobId] || {},
    h = d.experience || {};
  this.crafterSkillLevel = e.msg.crafterJobLevel || h.jobLevel;
  this.crafterName.setText(s ? n : a);
  this.clientName.setText(s ? a : n);
  var p = e.msg.enrichData.jobName;
  this.crafterDescription.setText(" - " + p + " " + u("ui.common.level") + " " + this.crafterSkillLevel);
  this.clientDescription.setText(" - " + u("ui.craft.client"));
  this._updateExchangeReadyDisplay(!1);
};
n.prototype._hasSignatureSlot = function () {
  return this.crafterSkillLevel >= w;
};
n.prototype._setEnableIngredientsBag = function (e) {
  this.ingredientsSlotsBox.toggleClassName("disabled", !e);
};
n.prototype._setEnableCraftingBox = function (e) {
  this.craftingSlots.toggleClassName("disabled", !e);
};
n.prototype._resizeIngredientSlots = function () {
  this.ingredientsSlotsBox.hide();
  var e = this.ingredientsSlotsContainer.rootElement,
    t = e.offsetWidth,
    i = e.offsetHeight - y,
    n = this.ingredientsSlotsRowNum = Math.floor(i / _),
    o = Math.floor(t / v);
  this.maxIngredientsSlotsPerPage = n * o;
  var a = o * v,
    s = n * _;
  this.ingredientsSlotsBox.setStyles({
    width: t + "px",
    height: i + "px"
  });
  this.ingredientsSlotsMask.setStyles({
    width: a + "px",
    height: s + "px"
  });
  this.ingredientsSlotsBox.show();
};
n.prototype._updateExchangeReadyDisplay = function (e) {
  var t = this.isCraftingMode = e;
  this.jobsData.switchToCrafter(t);
  var i;
  this.isCrafter ? (this._setEnableCraftingBox(t), this._setEnableIngredientsBag(t), i = e ? "tablet.craftHelp.magicMultiCrafter2" : "tablet.craftHelp.magicMultiCrafter1") : (this._setEnableCraftingBox(!1), this._setEnableIngredientsBag(!t), this.acceptBtn.setEnable(!t), this.stopBtn.setEnable(t), i = e ? "tablet.craftHelp.magicMultiClient2" : "tablet.craftHelp.magicMultiClient1");
  this.setItemBoxPlaceholderText(u(i));
};
n.prototype._updateCraftingButtons = function () {
  this.isCrafter && c.prototype._updateCraftingButtons.call(this);
};
n.prototype._isMyItem = function (e) {
  return !!window.gui.playerData.inventory.objects[e];
};
n.prototype._ingrediensSlotsGoToPage = function (e) {
  if (!(this.currentPage === e || e < 0 || e > this.pageCount - 1)) {
    this.currentPage = e;
    var t = "translateY(-" + e * this.ingredientsSlotsRowNum * _ + "px)";
    this.ingredientsSlots.setStyles({
      webkitTransform: t,
      transform: t
    });
    this.pagination.setCurrent(e);
  }
};
n.prototype._updateIngrediensSlotsPageCount = function () {
  var e = this.ingredientsSlots.getChildren().length;
  this.pageCount = Math.ceil(e / this.maxIngredientsSlotsPerPage) || 1;
  this.pagination.setPageCount(this.pageCount);
  this._ingrediensSlotsGoToPage(this.pageCount - 1);
};
n.prototype._moveItem = function (e) {
  var t = "crafting" === this.droppedLocation || "craftInventory" === this.droppedItemSource && "ingredientsBag" === this.droppedLocation;
  t ? this.jobsData.moveItemToCraft(this.droppedItemSource, this.newItemInstance, e) : this.jobsData.removeItemFromCraft(this.newItemInstance.objectUID, e);
};
n.prototype._onStopBtnTap = function () {
  return this.isCrafter ? c.prototype._onStopBtnTap.call(this) : void window.dofus.sendMessage("ExchangeReadyMessage", {
    ready: !1,
    step: this.exchangeStep
  });
};
n.prototype._onAutoCraftStopped = function (e) {
  return this.isCrafter ? c.prototype._onAutoCraftStopped.call(this, e) : (l.displayAutoCraftStopReasonMessage(e.reason), void (this.isInAutoCraft = !1));
};
c.prototype._initVariables.call(this, !0);
this.isCrafter = null;
this.isCraftingMode = !1;
this.crafterSkillLevel = 1;
this.currentPage = -1;
this.pageCount = -1;
l.allowCrafterIngredientsCheckbox.toggleActivation(t, !0);
l.jobsData.setCrafterIngredientsAllowed(t);
s.setQuantity(a.quantity);
l.ingredientsSlots.appendChild(s);
s.on("tap", o);
s.myWindow = l;
d.setDraggable(s, {
  backgroundImage: s.getImage(),
  prepareForDrag: t
}, "ingredientsBag", {
  slot: s
});
l._updateIngrediensSlotsPageCount();
l.newItemInstance = e.itemInstance;
l.droppedLocation = "ingredientsBag";
l.droppedItemSource = t;
u.on("ExchangeMultiCraftCrafterCanUseHisRessourcesMessage", this.localizeEvent(e));
u.on("ExchangeObjectPutInBagMessage", this.localizeEvent(i));
u.on("ExchangeObjectRemovedFromBagMessage", this.localizeEvent(a));
u.on("ExchangeObjectModifiedInBagMessage", this.localizeEvent(n));
u.on("ExchangeIsReadyMessage", this.localizeEvent(r));
u.on("ExchangeGoldPaymentForCraftMessage", this.localizeEvent(h));
u.on("ExchangeItemPaymentForCraftMessage", this.localizeEvent(h));
u.on("ExchangeModifiedPaymentForCraftMessage", this.localizeEvent(h));
u.on("ExchangeRemovedPaymentForCraftMessage", this.localizeEvent(h));
u.on("ExchangeClearPaymentForCraftMessage", this.localizeEvent(h));
e !== this.selectedBagSlot && window.gui.openContextualMenuAround("item", e, {
  item: t
});
o && (e !== this.selectedBagSlot ? this._selectBagSlot(e, o > 1 ? "stackMove" : "") : this.isCrafter ? this.jobsData.moveItemToCraft("ingredientsBag", t, o) : this.jobsData.removeItemFromCraft(e.itemInstance.objectUID, o));
this.selectedBagSlot && this._unselectBagSlot();
this.selectedBagSlot = e;
e.select({
  extraStyle: t
});
this.crafterName = t.createChild("span", {
  className: "playerName"
});
this.crafterDescription = t.createChild("span");
this.clientName = i.createChild("span", {
  className: "playerName"
});
this.clientDescription = i.createChild("span");
this.acceptBtn = new s(u("ui.common.accept"), {
  className: "acceptBtn"
});
this.acceptBtn.on("tap", function () {
  window.dofus.sendMessage("ExchangeReadyMessage", {
    ready: !0,
    step: e.exchangeStep
  });
});
this.acceptBtn.insertBefore(this.stopBtn);
this.ingredientsBag = this.col1.createChild("div", {
  className: "ingredientsBag"
});
this.ingredientsBag.createChild("div", {
  className: "title",
  text: u("ui.craft.ingredientBag")
});
this.ingredientsSlotsContainer = this.ingredientsBag.createChild("div", {
  className: "ingredientsSlotsContainer"
});
this.ingredientsSlotsBox = this.ingredientsSlotsContainer.createChild("div", {
  className: "ingredientsSlotsBox"
});
this.ingredientsSlotsMask = this.ingredientsSlotsBox.createChild("div", {
  className: ["ingredientsSlotsMask", "hoverable"]
});
d.setDroppable(this.ingredientsSlotsMask, ["craftInventory", "crafting"], {
  isDropAllowed: a
});
this.ingredientsSlotsMask.on("drop", this.itemDropOnBag);
this.ingredientsSlotsMask.myWindow = this;
this.ingredientsSlots = this.ingredientsSlotsMask.createChild("div", {
  className: "ingredientsSlots"
});
this.pagination = this.ingredientsSlotsContainer.appendChild(new f());
this.pagination.on("previous", function () {
  e._ingrediensSlotsGoToPage(e.currentPage - 1);
});
this.pagination.on("next", function () {
  e._ingrediensSlotsGoToPage(e.currentPage + 1);
});
this.pagination.on("page", function (t) {
  e._ingrediensSlotsGoToPage(t);
});
this.allowCrafterIngredientsCheckbox = this.ingredientsBag.appendChild(new r(""));
this.allowCrafterIngredientsCheckbox.on("change", function (e) {
  window.dofus.sendMessage("ExchangeMultiCraftSetCrafterCanUseHisRessourcesMessage", {
    allow: e
  });
});
this.paymentBtn = new s(u("ui.common.payment"), {
  className: "paymentBtn"
});
this.paymentBtn.on("tap", function () {
  g.open("craftPayment");
});
this.col2.appendChild(this.paymentBtn);
this.skillId = t.skillId;
this.skillData = this.jobsData.getSkill(t.skillId);
this.setTitle(this.skillData.nameId);
this._roleSetup(e);
this._updateSlotsImage();
this.selectedBagSlot = null;
this.jobsData.startCraftingSession(this.isCrafter ? "CRAFTER" : "CLIENT", this.skillId, 1);
this.setItemBoxPlaceholderText(i);
this.setItemBoxVisibility(!1);
g.close("cancel", {
  keepDialog: !0
});
c.prototype._onClose.call(this);
this.ingredientsSlots.clearContent();
this.selectedBagSlot = null;
g.close("craftPayment");
this.isCrafter = s;
this.mergeAllBtn.toggleDisplay(s);
this.mergeBtn.toggleDisplay(s);
this.acceptBtn.toggleDisplay(!s);
this.allowCrafterIngredientsCheckbox.setText(u(s ? "ui.craft.crafterRunesAllowed" : "ui.craft.allowCrafterRunes"));
this.allowCrafterIngredientsCheckbox.toggleActivation(r, l);
this.allowCrafterIngredientsCheckbox.setEnable(!s);
c.setForCrafter(s);
c.setOnSuccess(!0);
this.crafterSkillLevel = e.msg.crafterJobLevel || h.jobLevel;
this.crafterName.setText(s ? n : a);
this.clientName.setText(s ? a : n);
this.crafterDescription.setText(" - " + p + " " + u("ui.common.level") + " " + this.crafterSkillLevel);
this.clientDescription.setText(" - " + u("ui.craft.client"));
this._updateExchangeReadyDisplay(!1);
this.ingredientsSlotsBox.setStyles({
  width: t + "px",
  height: i + "px"
});
this.ingredientsSlotsMask.setStyles({
  width: a + "px",
  height: s + "px"
});
this.ingredientsSlotsBox.show();
this.isCrafter ? (this._setEnableCraftingBox(t), this._setEnableIngredientsBag(t), i = e ? "tablet.craftHelp.magicMultiCrafter2" : "tablet.craftHelp.magicMultiCrafter1") : (this._setEnableCraftingBox(!1), this._setEnableIngredientsBag(!t), this.acceptBtn.setEnable(!t), this.stopBtn.setEnable(t), i = e ? "tablet.craftHelp.magicMultiClient2" : "tablet.craftHelp.magicMultiClient1");
this.setItemBoxPlaceholderText(u(i));
this.ingredientsSlots.setStyles({
  webkitTransform: t,
  transform: t
});
this.pagination.setCurrent(e);
this.pageCount = Math.ceil(e / this.maxIngredientsSlotsPerPage) || 1;
this.pagination.setPageCount(this.pageCount);
this._ingrediensSlotsGoToPage(this.pageCount - 1);
this._positionInfoNormal = {
  left: "c",
  bottom: "10%",
  width: 550,
  height: 165
};
this._positionInfoOnSuccess = {
  left: "c",
  bottom: "10%",
  width: 550,
  height: 225
};
a.call(this, {
  className: "CraftPaymentWindow",
  title: s("ui.common.payment"),
  positionInfo: this._positionInfoNormal,
  customClose: !0
});
this._domCreated = !1;
this._readOnly = !1;
this.closeButton.on("tap", function () {
  t.hide();
});
i.on("ExchangeGoldPaymentForCraftMessage", function (i) {
  var n = i.goldSum;
  i.onlySuccess ? t._successPayment.setKama(n) : t._normalPayment.setKama(n);
  e();
});
i.on("ExchangeItemPaymentForCraftMessage", function (i) {
  p.createItemInstances(i.object, function (n, o) {
    if (n) {
      return console.error("PaymentWindow: ExchangeItemPaymentForCraftMessage cannot createItemInstances", n);
    }
    var a = o.array[0];
    i.onlySuccess ? t._successPayment.addItem(a) : t._normalPayment.addItem(a);
    e();
  });
});
i.on("ExchangeModifiedPaymentForCraftMessage", function (i) {
  p.createItemInstances(i.object, function (n, o) {
    if (n) {
      return console.error("PaymentWindow: ExchangeModifiedPaymentForCraftMessage cannot createItemInstances", n);
    }
    var a = o.array[0];
    i.onlySuccess ? t._successPayment.modifyItem(a) : t._normalPayment.modifyItem(a);
    e();
  });
});
i.on("ExchangeRemovedPaymentForCraftMessage", function (i) {
  i.onlySuccess ? t._successPayment.removeItem(i.objectUID) : t._normalPayment.removeItem(i.objectUID);
  e();
});
i.on("ExchangeClearPaymentForCraftMessage", function (e) {
  e.paymentType === d.PAYMENT_ON_SUCCESS_ONLY && t._successPayment.clearPayment();
  e.paymentType === d.PAYMENT_IN_ANY_CASE && t._normalPayment.clearPayment();
  t.hide();
});
this.once("open", function () {
  t._domCreated || t._createDom();
});
this.on("close", function () {
  t._normalPayment.reset();
  t._successPayment.reset();
  t._readOnly = !1;
});
i.onlySuccess ? t._successPayment.setKama(n) : t._normalPayment.setKama(n);
e();
i.onlySuccess ? t._successPayment.addItem(a) : t._normalPayment.addItem(a);
e();
i.onlySuccess ? t._successPayment.modifyItem(a) : t._normalPayment.modifyItem(a);
e();
i.onlySuccess ? t._successPayment.removeItem(i.objectUID) : t._normalPayment.removeItem(i.objectUID);
e();
e.paymentType === d.PAYMENT_ON_SUCCESS_ONLY && t._successPayment.clearPayment();
e.paymentType === d.PAYMENT_IN_ANY_CASE && t._normalPayment.clearPayment();
t.hide();
t._normalPayment.reset();
t._successPayment.reset();
t._readOnly = !1;
o(n, a);
e.exports = n;
n.prototype._createDom = function () {
  function e(e) {
    window.dofus.sendMessage("ExchangeItemObjectAddAsPaymentMessage", {
      paymentType: a,
      bAdd: !0,
      objectToMoveId: o,
      quantity: e
    });
  }
  function t(t, i) {
    return o = t, 1 === i ? e(1) : void n._minMaxSelector.open({
      min: 1,
      max: i
    });
  }
  function i(e) {
    if (!n._readOnly) {
      a = this.paymentType;
      var i = e.itemInstance,
        o = e.getQuantity();
      t(i.objectUID, o);
    }
  }
  var n = this,
    o = null,
    a = d.PAYMENT_IN_ANY_CASE;
  this._minMaxSelector = this.appendChild(new h());
  this._minMaxSelector.setStyles({
    left: "20px",
    top: "30px"
  });
  var l = this.windowBody,
    p = this._normalPayment = l.appendChild(new c(d.PAYMENT_IN_ANY_CASE)),
    m = this._successPayment = l.appendChild(new c(d.PAYMENT_ON_SUCCESS_ONLY));
  this._minMaxSelector.on("confirm", e);
  u.setDroppable(p, ["craftInventory"]);
  p.on("drop", i);
  p.paymentType = d.PAYMENT_IN_ANY_CASE;
  this._addDragEvents(p);
  u.setDroppable(m, ["craftInventory"]);
  m.on("drop", i);
  m.paymentType = d.PAYMENT_ON_SUCCESS_ONLY;
  this._addDragEvents(m);
  p.on("kamaChange", function (e) {
    window.dofus.sendMessage("ExchangeItemGoldAddAsPaymentMessage", {
      paymentType: d.PAYMENT_IN_ANY_CASE,
      quantity: e
    });
  });
  m.on("kamaChange", function (e) {
    window.dofus.sendMessage("ExchangeItemGoldAddAsPaymentMessage", {
      paymentType: d.PAYMENT_ON_SUCCESS_ONLY,
      quantity: e
    });
  });
  var f = l.appendChild(new r(s("ui.common.confirm"), {
    className: "confirmBtn"
  }));
  f.on("tap", function () {
    n.hide();
  });
  n._domCreated = !0;
};
n.prototype.setForCrafter = function (e) {
  this._domCreated || this._createDom();
  this._normalPayment.setReadonly(e);
  this._successPayment.setReadonly(e);
  this._readOnly = e;
};
n.prototype.setOnSuccess = function (e) {
  this._domCreated || this._createDom();
  this._successPayment.toggleDisplay(e);
  e ? this.positionInfo = this._positionInfoOnSuccess : this.positionInfo = this._positionInfoNormal;
};
n.prototype._addDragEvents = function (e) {
  function t(e, t) {
    n && n.selectSlots(t);
  }
  var i = this,
    n = e;
  u.on("dragStart", i.localizeEvent(function (e, i, n) {
    t(n.source, !0);
  }));
  u.on("dragEnd", i.localizeEvent(function (e, i, n) {
    t(n.source, !1);
  }));
};
this._minMaxSelector = this.appendChild(new h());
this._minMaxSelector.setStyles({
  left: "20px",
  top: "30px"
});
this._minMaxSelector.on("confirm", e);
u.setDroppable(p, ["craftInventory"]);
p.on("drop", i);
p.paymentType = d.PAYMENT_IN_ANY_CASE;
this._addDragEvents(p);
u.setDroppable(m, ["craftInventory"]);
m.on("drop", i);
m.paymentType = d.PAYMENT_ON_SUCCESS_ONLY;
this._addDragEvents(m);
p.on("kamaChange", function (e) {
  window.dofus.sendMessage("ExchangeItemGoldAddAsPaymentMessage", {
    paymentType: d.PAYMENT_IN_ANY_CASE,
    quantity: e
  });
});
m.on("kamaChange", function (e) {
  window.dofus.sendMessage("ExchangeItemGoldAddAsPaymentMessage", {
    paymentType: d.PAYMENT_ON_SUCCESS_ONLY,
    quantity: e
  });
});
f.on("tap", function () {
  n.hide();
});
n._domCreated = !0;
this._domCreated || this._createDom();
this._normalPayment.setReadonly(e);
this._successPayment.setReadonly(e);
this._readOnly = e;
this._domCreated || this._createDom();
this._successPayment.toggleDisplay(e);
e ? this.positionInfo = this._positionInfoOnSuccess : this.positionInfo = this._positionInfoNormal;
u.on("dragStart", i.localizeEvent(function (e, i, n) {
  t(n.source, !0);
}));
u.on("dragEnd", i.localizeEvent(function (e, i, n) {
  t(n.source, !1);
}));
this._MAX_SLOTS = 5;
this._currentKama = 0;
this._currentItems = [];
this._currentPage = 1;
this._readOnly = !1;
this._paymentType = e;
t._currentPage -= 1;
t._updateItems();
p.itemUI = {
  width: 40,
  height: 40,
  onDragClassName: "slot"
};
s.setDraggable(p, p.itemUI, "craftPayment", {
  slot: p
});
s.disableDrag(p);
t._currentPage += 1;
t._updateItems();
this._pagesCount = m.createChild("div", {
  className: "pagesCount"
});
this._updatePagesCount();
g.on("focus", function () {
  g.maxValue = window.gui.playerData.inventory.kamas;
});
g.on("change", function (e) {
  t._currentKama !== e && (t._currentKama = e, t.emit("kamaChange", e));
});
o(n, a);
e.exports = n;
n.prototype.setKama = function (e) {
  this._numberInput.setValue(e);
  this._numberInput.blur();
};
n.prototype.setReadonly = function (e) {
  this._numberInput.setReadonly(e);
  this._itemsSlots.toggleClassName("disable", e);
  this._readOnly = e;
};
n.prototype.selectSlots = function (e) {
  this._readOnly && (e = !1);
  for (var t = this._itemsSlots.getChildren(), i = 0, n = t.length; i < n; i += 1) {
    t[i].toggleClassName("selected", e);
  }
};
n.prototype._getPageMax = function () {
  return parseInt(this._currentItems.length / this._MAX_SLOTS, 10) + 1;
};
n.prototype._updatePagesCount = function () {
  var e = this._getPageMax();
  this._currentPage > e && (this._currentPage = e);
  this._currentPage < 1 && (this._currentPage = 1);
  var t = this._currentPage;
  this._pagesCount.setText(t + "/" + e);
  t >= e ? this._nextBtn.disable() : this._nextBtn.enable();
  t <= 1 ? this._previousBtn.disable() : this._previousBtn.enable();
};
n.prototype._getItemIndex = function (e) {
  for (var t = this._currentItems, i = 0, n = t.length; i < n; i += 1) {
    var o = t[i];
    if (o) {
      var a = o.objectUID;
      if (a === e) {
        return i;
      }
    }
  }
  return null;
};
n.prototype.addItem = function (e) {
  this._currentItems.push(e);
  this._updateItems();
};
n.prototype.modifyItem = function (e) {
  var t = this._getItemIndex(e.objectUID);
  null !== t && (this._currentItems[t] = e, this._currentPage = parseInt(t / this._MAX_SLOTS, 10) + 1, this._updateItems());
};
n.prototype.removeItem = function (e) {
  var t = this._getItemIndex(e);
  null !== t && (this._currentItems.splice(t, 1), this._updateItems());
};
n.prototype._updateItems = function () {
  this._updatePagesCount();
  for (var e = this._itemsSlots.getChildren(), t = this._currentPage - 1, i = 0, n = e.length; i < n; i += 1) {
    var o = i + t * this._MAX_SLOTS,
      a = e[i],
      r = this._currentItems[o];
    r ? (a.setItem(r), a.itemUI.backgroundImage = a.getImage(), a.paymentType = this._paymentType, this._readOnly ? s.disableDrag(a) : s.enableDrag(a)) : (delete a.paymentType, a.unset(), s.disableDrag(a));
  }
};
n.prototype.clearPayment = function () {
  this._currentKama = 0;
  this._currentPage = 1;
  this._numberInput.setValue("");
  this._currentItems = [];
  this._updateItems();
};
n.prototype.reset = function () {
  this._readOnly = !1;
  this.clearPayment();
};
this._numberInput.setValue(e);
this._numberInput.blur();
this._numberInput.setReadonly(e);
this._itemsSlots.toggleClassName("disable", e);
this._readOnly = e;
this._currentPage > e && (this._currentPage = e);
this._currentPage < 1 && (this._currentPage = 1);
this._pagesCount.setText(t + "/" + e);
t >= e ? this._nextBtn.disable() : this._nextBtn.enable();
t <= 1 ? this._previousBtn.disable() : this._previousBtn.enable();
this._currentItems.push(e);
this._updateItems();
this._currentKama = 0;
this._currentPage = 1;
this._numberInput.setValue("");
this._currentItems = [];
this._updateItems();
this._readOnly = !1;
this.clearPayment();
e.setItemQuantity(n, a);
a > 0 && !i && y(n);
e.resetItemQuantity(t);
i || y(t);
r.call(this, {
  title: l("ui.common.inventory"),
  className: "CraftInventoryWindow",
  positionInfo: {
    right: "0.5%",
    bottom: "2%",
    width: "23.2%",
    height: "95%",
    isDefault: !0
  }
});
e.registerView(this, {
  enableSlotContext: !1,
  tapSelectedEmitsDoubleTap: !0,
  showHoverFrame: !0,
  prepareForDragFunction: w,
  manualReset: !0
});
P.on("change", function (t) {
  x = t;
  t ? e.addFilters([D]) : e.removeFilter(D);
  e.filterList(!0);
});
A.on("ExchangeItemPaymentForCraftMessage", this.localizeEvent(h));
A.on("ExchangeModifiedPaymentForCraftMessage", this.localizeEvent(h));
A.on("ExchangeObjectPutInBagMessage", this.localizeEvent(h));
A.on("ExchangeObjectModifiedInBagMessage", this.localizeEvent(h));
this.on("itemModified", this.localizeEvent(function (e) {
  h({
    object: e,
    remote: !1
  });
}));
A.on("ExchangeReplayCountModifiedMessage", this.localizeEvent(m));
A.on("ExchangeRemovedPaymentForCraftMessage", this.localizeEvent(f));
A.on("ExchangeClearPaymentForCraftMessage", this.localizeEvent(f));
A.on("ExchangeObjectRemovedFromBagMessage", this.localizeEvent(f));
this.on("open", function (a) {
  C || (C = !0, o(this, ["crafting", "craftPayment", "ingredientsBag"], {
    isDropAllowed: v
  }), this.on("drop", function (e, t, i) {
    I = t;
    _(i.slot, i.x, i.y, i.slot.getQuantity());
  }));
  E.on("objectAdded", p);
  E.on("objectModified", p);
  E.on("objectRemoved", g);
  a = a || {};
  R = a.type;
  var r = a.msg;
  O = r.skillId;
  var l = r.maxCase || r.nbCase;
  "craftMagus" === R ? (L = {}, D = i) : "decrafting" === R ? D = n : (L = E.getStorageCraftFilterMap(O, l), D = t);
  e.storageUI.appendChild(P);
  e.clearFilters();
  e.addFilters([s.unlinkedItemsFilter]);
  x && e.addFilters([D]);
  e.filterList();
  e.resetDisplay();
});
this.on("close", function () {
  N.hide();
  L = null;
  O = null;
  R = null;
});
this.on("closed", function () {
  e.storageUI.removeChild(P);
  e.clearFilters();
  e.resetItemsQuantity();
  e.filterList();
});
this.on("slot-tap", function (t) {
  var i = t.getItem();
  window.gui.openContextualMenuAround("item", t, {
    item: i
  });
  var n = E.getQuickTransferInfo("craftInventory", i, t.getQuantity()),
    o = n.movedQty;
  return 0 === o ? e.unSelectSlot() : void (o > 1 && t.select({
    extraStyle: "stackMove"
  }));
});
this.on("slot-doubletap", function (t) {
  var i = t.getItem(),
    n = E.getQuickTransferInfo("craftInventory", i, t.getQuantity()),
    o = n.movedQty;
  return 0 === o ? e.unSelectSlot() : void E.moveItemToCraft(this.id, i, o);
});
x = t;
t ? e.addFilters([D]) : e.removeFilter(D);
e.filterList(!0);
C || (C = !0, o(this, ["crafting", "craftPayment", "ingredientsBag"], {
  isDropAllowed: v
}), this.on("drop", function (e, t, i) {
  I = t;
  _(i.slot, i.x, i.y, i.slot.getQuantity());
}));
E.on("objectAdded", p);
E.on("objectModified", p);
E.on("objectRemoved", g);
a = a || {};
R = a.type;
I = t;
_(i.slot, i.x, i.y, i.slot.getQuantity());
"craftMagus" === R ? (L = {}, D = i) : "decrafting" === R ? D = n : (L = E.getStorageCraftFilterMap(O, l), D = t);
e.storageUI.appendChild(P);
e.clearFilters();
e.addFilters([s.unlinkedItemsFilter]);
x && e.addFilters([D]);
e.filterList();
e.resetDisplay();
N.hide();
L = null;
O = null;
R = null;
e.storageUI.removeChild(P);
e.clearFilters();
e.resetItemsQuantity();
e.filterList();
a(n, r);
e.exports = n;
g = t.id;
_ = t.characterBaseInformations.name;
t = s(i ? "ui.exchange.success" : "ui.exchange.cancel");
y.chat.logMsg(t);
t > 0 && t >= 2 * e && (i = !0, o = !0);
e > 0 && e >= 2 * t && (i = !0, n = !0);
v._otherCharacterTradeSpace.setEstimationPrice(e, {
  color: i,
  warning: n
});
v._myTradeSpace.setEstimationPrice(t, {
  color: i,
  warning: o
});
i();
window.clearTimeout(S);
S = window.setTimeout(function () {
  (v._myTradeSpace.isGoldOrItemToTrade() || v._otherCharacterTradeSpace.isGoldOrItemToTrade()) && v._buttonConfirm.enable();
}, 1e3 * p);
v._buttonConfirm.disable();
v._exchangeStep += 1;
e.remote ? v._otherCharacterTradeSpace.modifyKama(e.quantity) : v._myTradeSpace.modifyKama(e.quantity);
n();
v._exchangeStep += 1;
v._toggleConfirmForMe(!1);
u.createItemInstances(i, function (e, i) {
  if (e) {
    return console.error(e);
  }
  var s = i.map[o],
    r = s.weight,
    l = E[o];
  l || (l = E[o] = {});
  var c = l.quantity || 0;
  l.weight = r;
  l.quantity = a;
  var d = r * (a - c);
  t ? (v._otherCharacterTradeSpace.addAndModifyItem(s), v._otherCharacterTradeSpace.blink(p), v._otherCharacterTradeSpace.incrementExchangePodsQty(-d), v._myTradeSpace.incrementExchangePodsQty(d)) : (v._myTradeSpace.addAndModifyItem(s), v._otherCharacterTradeSpace.incrementExchangePodsQty(d), v._myTradeSpace.incrementExchangePodsQty(-d));
  n();
});
l.weight = r;
l.quantity = a;
t ? (v._otherCharacterTradeSpace.addAndModifyItem(s), v._otherCharacterTradeSpace.blink(p), v._otherCharacterTradeSpace.incrementExchangePodsQty(-d), v._myTradeSpace.incrementExchangePodsQty(d)) : (v._myTradeSpace.addAndModifyItem(s), v._otherCharacterTradeSpace.incrementExchangePodsQty(d), v._myTradeSpace.incrementExchangePodsQty(-d));
n();
v._exchangeStep += 1;
v._toggleConfirmForMe(!1);
E[i] = {};
t ? (v._otherCharacterTradeSpace.removeItem(i), v._otherCharacterTradeSpace.blink(p), v._otherCharacterTradeSpace.incrementExchangePodsQty(a), v._myTradeSpace.incrementExchangePodsQty(-a)) : (v._myTradeSpace.removeItem(i), v._otherCharacterTradeSpace.incrementExchangePodsQty(-a), v._myTradeSpace.incrementExchangePodsQty(a));
n();
v.targetInfo = {};
E = {};
v._otherCharacterTradeSpace.reset();
v._myTradeSpace.reset();
v._toggleConfirmForMe(!1);
v._otherCharacterTradeSpace.toggleReady(!1);
v._buttonConfirm.disable();
v._exchangeStep = 0;
this._domCreated = !1;
this._otherCharacterTradeSpace = null;
this._myTradeSpace = null;
this._buttonConfirm = null;
this._iConfirmed = !1;
this._exchangeStep = 0;
y.on("ExchangeRequestedTradeMessage", e);
y.on("ExchangeStartedWithPodsMessage", t);
y.on("ExchangeKamaModifiedMessage", this.localizeEvent(o));
y.on("ExchangeObjectAddedMessage", this.localizeEvent(c));
y.on("ExchangeObjectModifiedMessage", this.localizeEvent(c));
y.on("ExchangeObjectRemovedMessage", this.localizeEvent(d));
y.on("ExchangeIsReadyMessage", this.localizeEvent(m));
this._toggleConfirmForMe = function (e) {
  v._iConfirmed = e;
  v._myTradeSpace.toggleReady(e);
  e ? v._buttonConfirm.disable() : v._buttonConfirm.enable();
};
this.on("close", f);
v._iConfirmed = e;
v._myTradeSpace.toggleReady(e);
e ? v._buttonConfirm.disable() : v._buttonConfirm.enable();
o(n, a);
e.exports = n;
n.prototype._createDom = function () {
  var e = this,
    t = this.windowBody,
    i = t.createChild("div", {
      className: ["otherCharacterSpace", "tradeSpace"]
    });
  this._otherCharacterTradeSpace = i.appendChild(new c({
    blinkDuration: p
  }));
  var n = t.createChild("div", {
    className: ["mySpace", "tradeSpace"]
  });
  this._myTradeSpace = n.appendChild(new c({
    blinkDuration: p,
    dragInteraction: !0,
    canRemove: !0
  }));
  var o = t.createChild("div", {
    className: "tradeButtons"
  });
  this._buttonConfirm = o.appendChild(new d(s("ui.common.validation"), {
    className: "buttonConfirm",
    disable: !0
  }));
  this._buttonConfirm.on("tap", function () {
    if (!e._iConfirmed) {
      return !e._otherCharacterTradeSpace.hasFreePods() && e._myTradeSpace.getItemsToTradeCount() > 0 ? window.gui.openSimplePopup(s("ui.storage.noRoomForTransfert")) : void window.dofus.sendMessage("ExchangeReadyMessage", {
        ready: !0,
        step: e._exchangeStep
      });
    }
  });
  var a = o.appendChild(new d(s("ui.common.cancel"), {
    className: "buttonCancel"
  }));
  a.on("tap", function () {
    return e._iConfirmed ? window.dofus.sendMessage("ExchangeReadyMessage", {
      ready: !1,
      step: e._exchangeStep
    }) : void r.close(e.id);
  });
  this._domCreated = !0;
};
n.prototype.prepareMakeExchange = function (e) {
  this._targetInfo = e;
};
this._buttonConfirm = o.appendChild(new d(s("ui.common.validation"), {
  className: "buttonConfirm",
  disable: !0
}));
this._buttonConfirm.on("tap", function () {
  if (!e._iConfirmed) {
    return !e._otherCharacterTradeSpace.hasFreePods() && e._myTradeSpace.getItemsToTradeCount() > 0 ? window.gui.openSimplePopup(s("ui.storage.noRoomForTransfert")) : void window.dofus.sendMessage("ExchangeReadyMessage", {
      ready: !0,
      step: e._exchangeStep
    });
  }
});
a.on("tap", function () {
  return e._iConfirmed ? window.dofus.sendMessage("ExchangeReadyMessage", {
    ready: !1,
    step: e._exchangeStep
  }) : void r.close(e.id);
});
this._domCreated = !0;
e = e || {};
a.call(this, "div", {
  className: "TradeSpace"
});
this._isRemote = !1;
this._blinkDuration = e.blinkDuration || 5;
this._blinkTimeout = null;
this._currentUID = null;
this._podsTooltip = new a("div");
this._podsTooltipText = "";
this._maxPods = 0;
this._currentPods = 0;
this._exchangePods = 0;
this._podsPercent = 0;
this._estimationPrice = {};
this.selectedSlot = null;
this._minMaxSelector = this.appendChild(new l());
this._minMaxSelector.setStyles({
  left: "20px",
  top: "50px"
});
this._minMaxSelector.on("confirm", function (e) {
  window.dofus.sendMessage("ExchangeObjectMoveMessage", {
    objectUID: t._currentUID,
    quantity: e * (this.fromInventory ? 1 : -1)
  });
});
this._tradeGold = this.appendChild(new s());
this._tradeGold.on("kamaChange", function (e) {
  window.dofus.sendMessage("ExchangeObjectMoveKamaMessage", {
    quantity: e
  });
});
this._exchangePodsContent = this.createChild("div", {
  className: "exchangePodsContent"
});
this._exchangePodsProgressBar = this._exchangePodsContent.appendChild(new u({
  className: "exchangePodsProgressBar"
}));
h(this._exchangePodsProgressBar, t._podsTooltip);
e.dragInteraction && (p.setDroppable(i, ["tradeWithPlayerAndNPCInventory"]), i.on("drop", function (e) {
  var i = e.itemInstance,
    n = e.getQuantity();
  return 1 === n ? window.dofus.sendMessage("ExchangeObjectMoveMessage", {
    objectUID: i.objectUID,
    quantity: 1
  }) : (t._currentUID = i.objectUID, t._minMaxSelector.fromInventory = !0, void t._minMaxSelector.open({
    min: 1,
    max: n
  }));
}));
this.canRemove = e.canRemove;
this._allSlots = i.createChild("div", {
  className: "slots"
});
this._estimationValue = o.createChild("div", {
  className: "estimationValue"
});
this._estimationWarning = o.createChild("div", {
  className: "estimationWarning"
});
o(n, a);
e.exports = n;
n.prototype.setAsRemote = function () {
  this._isRemote = !0;
  this._tradeGold.setAsRemote();
};
n.prototype.modifyKama = function (e) {
  this._isRemote && this._tradeGold.blink(this._blinkDuration);
  this._tradeGold.setKama(e);
};
n.prototype.blink = function (e) {
  e = e || 3;
  var t = this;
  window.clearTimeout(this._blinkTimeout);
  this._blinkTimeout = window.setTimeout(function () {
    t._allSlots.delClassNames("blink");
  }, 1e3 * e);
  this._allSlots.addClassNames("blink");
};
n.prototype.setEstimationPrice = function (e, t) {
  t = t || {};
  this._estimationValue.setText(c.kamasToString(e));
  this._estimationValue.toggleClassName("warning", t.color);
  this._estimationWarning.setStyle("visibility", t.warning ? "visible" : "hidden");
};
n.prototype.addAndModifyItem = function (e) {
  function t() {
    var t = a._estimationPrice[l],
      i = e.item.averagePrice;
    i < 0 || (t || (t = a._estimationPrice[l] = {}), t.averagePrice = e.item.averagePrice, t.quantity = c);
  }
  function i() {
    if (!a._isRemote && a.canRemove) {
      var e = o.itemInstance;
      if (e) {
        a._currentUID = e.objectUID;
        var t = e.quantity;
        if (1 === t) {
          return window.dofus.sendMessage("ExchangeObjectMoveMessage", {
            objectUID: a._currentUID,
            quantity: -1
          });
        }
        a._minMaxSelector.fromInventory = !1;
        a._minMaxSelector.open({
          min: 1,
          max: e.quantity
        });
      }
    }
  }
  function n(e) {
    "remove" === e && i();
  }
  var o,
    a = this,
    s = this._allSlots,
    l = e.objectUID,
    c = e.quantity;
  t();
  o = s.getChild("slot" + l);
  o || (o = s.appendChild(new r({
    name: "slot" + l
  })), o.setContextMenu("item", {
    item: o.itemInstance,
    remove: a.canRemove,
    onClose: n,
    enableActions: !1,
    enableDestroy: !1
  }), a.canRemove && (o.on("doubletap", i), o.on("tap", function () {
    a.selectedSlot && a.selectedSlot.delClassNames("selected");
    a.selectedSlot = this;
    a.selectedSlot.addClassNames("selected");
  })));
  o.setItem(e);
  a.canRemove && p.setDraggable(o, {
    backgroundImage: o.getImage()
  }, "tradeSpace");
};
n.prototype.removeItem = function (e) {
  delete this._estimationPrice[e];
  var t = this._allSlots.getChild("slot" + e);
  t && (t === this.selectedSlot && (this.selectedSlot = null), t.destroy());
};
n.prototype.getEstimationPrice = function () {
  var e = this._tradeGold.getKama(),
    t = this._estimationPrice;
  for (var i in t) {
    var n = t[i];
    e += n.quantity * n.averagePrice;
  }
  return e;
};
n.prototype.toggleReady = function (e) {
  this._tradeGold.toggleReady(e);
  this._allSlots.toggleClassName("isReady", e);
};
n.prototype.setPodsProgressBar = function () {
  var e = this._maxPods,
    t = this._currentPods,
    i = this._exchangePods;
  if (e) {
    var n = this._podsPercent = Math.min(100, Math.floor(100 * (t + i) / e));
    this._exchangePodsProgressBar.setValue(this._podsPercent / 100);
    n <= 60 ? this._exchangePodsProgressBar.replaceClassNames(["yellow", "orange", "red"], ["green"]) : n <= 70 ? this._exchangePodsProgressBar.replaceClassNames(["green", "orange", "red"], ["yellow"]) : n <= 80 ? this._exchangePodsProgressBar.replaceClassNames(["green", "yellow", "red"], ["orange"]) : this._exchangePodsProgressBar.replaceClassNames(["green", "yellow", "orange"], ["red"]);
    this._podsTooltipText = d("ui.common.player.weight", c.kamasToString(t + i, ""), c.kamasToString(e, ""));
    this._podsTooltip.setText(this._podsTooltipText);
  }
};
n.prototype.initializePods = function (e, t) {
  this._maxPods = t;
  this._currentPods = e;
  this._exchangePods = 0;
  this.setPodsProgressBar();
};
n.prototype.activateNpcTradeMode = function () {
  this._exchangePodsContent.hide();
  this._tradeGold.setReadOnly(!0);
};
n.prototype.incrementExchangePodsQty = function (e) {
  this._exchangePods += e;
  this.setPodsProgressBar();
};
n.prototype.isGoldOrItemToTrade = function () {
  if (this._tradeGold.getKama() > 0) {
    return !0;
  }
  for (var e = this._allSlots.getChildren(), t = 0, i = e.length; t < i; t += 1) {
    var n = e[t];
    if (n.itemInstance) {
      return !0;
    }
  }
  return !1;
};
n.prototype.getItemsToTradeCount = function () {
  for (var e = 0, t = this._allSlots.getChildren(), i = 0; i < t.length; i++) {
    t[i].itemInstance && e++;
  }
  return e;
};
n.prototype.hasFreePods = function () {
  return this._maxPods - (this._currentPods + this._exchangePods) >= 0;
};
n.prototype.reset = function () {
  this._tradeGold.reset();
  this._isRemote = !1;
  this._currentUID = null;
  this._maxPods = 0;
  this._currentPods = 0;
  this._exchangePods = 0;
  this._podsPercent = 0;
  this._estimationPrice = {};
  this._exchangePodsContent.show();
  this._tradeGold.show();
  window.clearTimeout(this._blinkTimeout);
  this._allSlots.delClassNames("blink");
  this._podsTooltip.setText("");
  this._allSlots.clearContent();
  this.selectedSlot = null;
};
this._isRemote = !0;
this._tradeGold.setAsRemote();
this._isRemote && this._tradeGold.blink(this._blinkDuration);
this._tradeGold.setKama(e);
window.clearTimeout(this._blinkTimeout);
this._blinkTimeout = window.setTimeout(function () {
  t._allSlots.delClassNames("blink");
}, 1e3 * e);
this._allSlots.addClassNames("blink");
t = t || {};
this._estimationValue.setText(c.kamasToString(e));
this._estimationValue.toggleClassName("warning", t.color);
this._estimationWarning.setStyle("visibility", t.warning ? "visible" : "hidden");
a._minMaxSelector.fromInventory = !1;
a._minMaxSelector.open({
  min: 1,
  max: e.quantity
});
t();
o = s.getChild("slot" + l);
o || (o = s.appendChild(new r({
  name: "slot" + l
})), o.setContextMenu("item", {
  item: o.itemInstance,
  remove: a.canRemove,
  onClose: n,
  enableActions: !1,
  enableDestroy: !1
}), a.canRemove && (o.on("doubletap", i), o.on("tap", function () {
  a.selectedSlot && a.selectedSlot.delClassNames("selected");
  a.selectedSlot = this;
  a.selectedSlot.addClassNames("selected");
})));
o.setItem(e);
a.canRemove && p.setDraggable(o, {
  backgroundImage: o.getImage()
}, "tradeSpace");
a.selectedSlot && a.selectedSlot.delClassNames("selected");
a.selectedSlot = this;
a.selectedSlot.addClassNames("selected");
this._tradeGold.toggleReady(e);
this._allSlots.toggleClassName("isReady", e);
this._exchangePodsProgressBar.setValue(this._podsPercent / 100);
n <= 60 ? this._exchangePodsProgressBar.replaceClassNames(["yellow", "orange", "red"], ["green"]) : n <= 70 ? this._exchangePodsProgressBar.replaceClassNames(["green", "orange", "red"], ["yellow"]) : n <= 80 ? this._exchangePodsProgressBar.replaceClassNames(["green", "yellow", "red"], ["orange"]) : this._exchangePodsProgressBar.replaceClassNames(["green", "yellow", "orange"], ["red"]);
this._podsTooltipText = d("ui.common.player.weight", c.kamasToString(t + i, ""), c.kamasToString(e, ""));
this._podsTooltip.setText(this._podsTooltipText);
this._maxPods = t;
this._currentPods = e;
this._exchangePods = 0;
this.setPodsProgressBar();
this._exchangePodsContent.hide();
this._tradeGold.setReadOnly(!0);
this._exchangePods += e;
this.setPodsProgressBar();
this._tradeGold.reset();
this._isRemote = !1;
this._currentUID = null;
this._maxPods = 0;
this._currentPods = 0;
this._exchangePods = 0;
this._podsPercent = 0;
this._estimationPrice = {};
this._exchangePodsContent.show();
this._tradeGold.show();
window.clearTimeout(this._blinkTimeout);
this._allSlots.delClassNames("blink");
this._podsTooltip.setText("");
this._allSlots.clearContent();
this.selectedSlot = null;
this._blinkTimeout = null;
this._currentKama = 0;
this._kamaContent = this.createChild("div", {
  className: "kamaContent"
});
l.addTooltip(this._kamaContent, function () {
  return t || (t = new a("div", {
    className: "kamaTooltip",
    text: s("ui.exchange.kamas")
  })), t;
});
l.enableTooltip(this._kamaContent, !1);
n.createChild("div", {
  className: "kamaUnit",
  text: s("ui.common.short.kama")
});
o.on("focus", function () {
  o.maxValue = window.gui.playerData.inventory.kamas;
});
o.on("change", function (t) {
  e._currentKama !== t && (e._currentKama = t, e.emit("kamaChange", t));
});
o(n, a);
e.exports = n;
n.prototype.getKama = function () {
  return this._input.getValue();
};
n.prototype.setKama = function (e) {
  this._input.setValue(e);
};
n.prototype.blink = function (e) {
  e = e || 3;
  var t = this;
  window.clearTimeout(this._blinkTimeout);
  this._blinkTimeout = window.setTimeout(function () {
    t._kamaContent.delClassNames("blink");
  }, 1e3 * e);
  this._kamaContent.addClassNames("blink");
};
n.prototype.toggleReady = function (e) {
  this._kamaContent.toggleClassName("isReady", e);
};
n.prototype.setAsRemote = function () {
  l.enableTooltip(this._kamaContent, !0);
  this._input.setReadonly(!0);
};
n.prototype.reset = function () {
  this._input.setValue(0);
  this._input.setReadonly(!1);
  window.clearTimeout(this._blinkTimeout);
  this._kamaContent.delClassNames("blink");
  this._currentKama = 0;
  l.enableTooltip(this._kamaContent, !1);
};
n.prototype.setReadOnly = function (e) {
  this._input.setReadonly(e);
};
window.clearTimeout(this._blinkTimeout);
this._blinkTimeout = window.setTimeout(function () {
  t._kamaContent.delClassNames("blink");
}, 1e3 * e);
this._kamaContent.addClassNames("blink");
l.enableTooltip(this._kamaContent, !0);
this._input.setReadonly(!0);
this._input.setValue(0);
this._input.setReadonly(!1);
window.clearTimeout(this._blinkTimeout);
this._kamaContent.delClassNames("blink");
this._currentKama = 0;
l.enableTooltip(this._kamaContent, !1);
p._domCreated || p._createDom();
m.once("ExchangeLeaveMessage", function (e) {
  var t,
    i = e.success;
  t = s(i ? "ui.exchange.success" : "ui.exchange.cancel");
  m.chat.logMsg(t);
});
"" === p._npcName && console.error("TradeWithNPCWindow: npcName is missing on mapid:", window.isoEngine.mapRenderer.mapId);
p.setTitle(p._npcName + " <-> " + m.playerData.characterBaseInformations.name);
p._myTradeSpace.activateNpcTradeMode();
p._npcTradeSpace.setAsRemote();
p._npcTradeSpace.activateNpcTradeMode();
t();
r.continueDialog(["tradeWithNPC", "tradeWithPlayerAndNPCInventory"]);
t = s(i ? "ui.exchange.success" : "ui.exchange.cancel");
m.chat.logMsg(t);
t > 0 && t >= 2 * e && (i = !0, o = !0);
e > 0 && e >= 2 * t && (i = !0, n = !0);
p._npcTradeSpace.setEstimationPrice(e, {
  color: i,
  warning: n
});
p._myTradeSpace.setEstimationPrice(t, {
  color: i,
  warning: o
});
t();
window.clearTimeout(h);
h = window.setTimeout(function () {
  p._npcTradeSpace.isGoldOrItemToTrade() && p._buttonConfirm.enable();
}, 1e3 * u);
p._buttonConfirm.disable();
p._exchangeStep += 1;
d.createItemInstances(n, function (e, n) {
  if (e) {
    return console.error(e);
  }
  var a = n.map[o];
  t ? (p._npcTradeSpace.addAndModifyItem(a), p._npcTradeSpace.blink(u)) : p._myTradeSpace.addAndModifyItem(a);
  i();
});
t ? (p._npcTradeSpace.addAndModifyItem(a), p._npcTradeSpace.blink(u)) : p._myTradeSpace.addAndModifyItem(a);
i();
p._exchangeStep += 1;
t ? (p._npcTradeSpace.removeItem(n), p._npcTradeSpace.blink(u)) : p._myTradeSpace.removeItem(n);
i();
p._npcTradeSpace.reset();
p._myTradeSpace.reset();
p._buttonConfirm.disable();
p._exchangeStep = 0;
p._npcName = "";
p._exchangeStep += 1;
e.remote ? p._npcTradeSpace.modifyKama(e.quantity) : p._myTradeSpace.modifyKama(e.quantity);
this._npcName = "";
this._domCreated = !1;
this._npcTradeSpace = null;
this._myTradeSpace = null;
this._buttonConfirm = null;
this._exchangeStep = 0;
m.on("ExchangeStartOkNpcTradeMessage", e);
m.on("ExchangeKamaModifiedMessage", this.localizeEvent(c));
m.on("ExchangeObjectAddedMessage", this.localizeEvent(n));
m.on("ExchangeObjectModifiedMessage", this.localizeEvent(n));
m.on("ExchangeObjectRemovedMessage", this.localizeEvent(o));
this.on("closed", l);
o(n, a);
e.exports = n;
n.prototype.prepareExchange = function (e) {
  this._npcName = e;
};
n.prototype._createDom = function () {
  var e = this,
    t = this.windowBody,
    i = t.createChild("div", {
      className: ["otherCharacterSpace", "tradeSpace"]
    });
  this._npcTradeSpace = i.appendChild(new l({
    blinkDuration: u
  }));
  var n = t.createChild("div", {
    className: ["mySpace", "tradeSpace"]
  });
  this._myTradeSpace = n.appendChild(new l({
    blinkDuration: u,
    dragInteraction: !0,
    canRemove: !0
  }));
  var o = t.createChild("div", {
    className: "tradeButtons"
  });
  this._buttonConfirm = o.appendChild(new c(s("ui.common.validation"), {
    className: "buttonConfirm",
    disable: !0
  }));
  this._buttonConfirm.on("tap", function () {
    window.dofus.sendMessage("ExchangeReadyMessage", {
      ready: !0,
      step: e._exchangeStep
    });
  });
  var a = o.appendChild(new c(s("ui.common.cancel"), {
    className: "buttonCancel"
  }));
  a.on("tap", function () {
    r.close(e.id);
  });
  this._domCreated = !0;
};
this._buttonConfirm = o.appendChild(new c(s("ui.common.validation"), {
  className: "buttonConfirm",
  disable: !0
}));
this._buttonConfirm.on("tap", function () {
  window.dofus.sendMessage("ExchangeReadyMessage", {
    ready: !0,
    step: e._exchangeStep
  });
});
a.on("tap", function () {
  r.close(e.id);
});
this._domCreated = !0;
e.setItemQuantity(i, n.quantity - t.object.quantity);
h[i] = !0;
e.resetItemQuantity(i);
delete h[i];
s.call(this, {
  title: r("ui.common.inventory"),
  className: "TradeWithPlayerAndNPCInventoryWindow",
  positionInfo: {
    right: "0.5%",
    top: "2%",
    width: "23.2%",
    height: "95%"
  }
});
this.storageViewer = e;
e.registerView(this, {
  manualReset: !0
});
c.setDroppable(this, ["tradeSpace"]);
this.on("drop", function (e) {
  var t = e.itemInstance.quantity;
  return 1 === t ? window.dofus.sendMessage("ExchangeObjectMoveMessage", {
    objectUID: e.itemInstance.objectUID,
    quantity: -1
  }) : (o = e.itemInstance.objectUID, p.fromInventory = !1, void p.open({
    min: 1,
    max: t
  }));
});
p.setStyles({
  left: "-100px",
  top: "100px"
});
p.on("confirm", function (e) {
  window.dofus.sendMessage("ExchangeObjectMoveMessage", {
    objectUID: o,
    quantity: e * (this.fromInventory ? 1 : -1)
  });
});
u.on("ExchangeObjectRemovedMessage", this.localizeEvent(n));
u.on("ExchangeObjectAddedMessage", this.localizeEvent(i));
u.on("ExchangeObjectModifiedMessage", this.localizeEvent(i));
this.on("open", function () {
  e.addFilters([a.unlinkedItemsFilter]);
  e.filterList();
  e.resetDisplay();
});
this.on("close", function () {
  e.removeFilter(a.unlinkedItemsFilter);
  e.filterList();
  p.hide();
  t();
});
this.on("slot-doubletap", function (e) {
  var t = e.itemInstance;
  o = t.objectUID;
  var i = e.getQuantity();
  return 1 === i ? window.dofus.sendMessage("ExchangeObjectMoveMessage", {
    objectUID: o,
    quantity: 1
  }) : (p.fromInventory = !0, void p.open({
    min: 1,
    max: i
  }));
});
e.addFilters([a.unlinkedItemsFilter]);
e.filterList();
e.resetDisplay();
e.removeFilter(a.unlinkedItemsFilter);
e.filterList();
p.hide();
t();
o(n, s);
e.exports = n;
"function" == typeof e.cb && e.cb();
e.close();
o(n, a);
e.exports = n;
n.prototype.update = function (e, t) {
  t = t || {};
  this.windowTitle.setText(e.title);
  this.message.clearContent();
  this.message.appendChild(l.process(e.message, {
    isNonChat: !0
  }));
  this.cb = e.cb;
  this.keepDialog = t.keepDialog;
};
t = t || {};
this.windowTitle.setText(e.title);
this.message.clearContent();
this.message.appendChild(l.process(e.message, {
  isNonChat: !0
}));
this.cb = e.cb;
this.keepDialog = t.keepDialog;
I.call(this, {
  className: "OptionsWindow",
  title: f("ui.common.options"),
  positionInfo: {
    left: "c",
    top: "c",
    width: "80%",
    height: "70%"
  }
});
this.optionDefinitions = null;
this.elements = {};
this.sections = null;
this.currentSection = null;
this._gameOptionChangedHandler = this._gameOptionChanged.bind(this);
this._initOptionDefinitions();
this.on("open", this._open);
this.on("opened", this._opened);
this.on("close", this._close);
this.gameOptionId && (_.changeValue(this.gameOptionId, e, L), window.gui.emit("gameOptionChanged", {
  value: e,
  gameOptionId: this.gameOptionId
}));
this.action && this.action(e);
g(n, I);
e.exports = n;
n.prototype._open = function () {
  this.sections || this._createContent();
  this.refreshUi();
};
n.prototype._opened = function (e) {
  e && e.tab && this._selectTab(e.tab);
};
n.prototype._close = function () {
  C.saveNow();
};
n.prototype.freeContent = function () {
  this.windowBody.clearContent();
  this.sections = this.currentSection = null;
  this.elements = {};
  this.menuList = this.settingsScroller = this.settingsCol = null;
};
n.prototype._createContent = function () {
  var e = this;
  this.sections = {};
  var t = this.windowBody.createChild("div", {
      className: "wrapper"
    }),
    i = t.createChild("div", {
      className: "menuCol"
    });
  this.menuList = i.appendChild(new b({
    className: "menu"
  }, {
    disableSelectionToggle: !0
  }));
  this.menuList.on("selected", function (t) {
    e._showSection(t.id);
    this.scrollToElement(t);
  });
  var n = t.createChild("div", {
    className: "settingsCol"
  });
  this.settingsScroller = n.appendChild(new y({
    className: "settings"
  }));
  this.settingsCol = this.settingsScroller.content;
  for (var o = 0; o < this.optionDefinitions.length; o++) {
    this._createSection(this.optionDefinitions[o], o);
  }
};
n.prototype._createSection = function (e, t) {
  this.menuList.addItem({
    id: t,
    element: e.title
  }, {
    noRefresh: !0
  });
  var i = this.settingsCol.createChild("div", {
    className: ["optionSection", e.name + "Section"],
    hidden: !0
  });
  if (e.text) {
    var n = i.createChild("div", {
      className: "titleBox"
    });
    n.createChild("div", {
      className: "sectionDescription",
      text: e.text
    });
  }
  for (var o = i.createChild("div", {
      className: "allOptions"
    }), a = e.elements, s = 0; s < a.length; s++) {
    var r = this._createElement(o, a[s]);
    this.elements[t + "-" + s] = r;
  }
  this.sections[t] = i;
};
n.prototype._createElement = function (e, t) {
  var i = this,
    n = O[t.type];
  if (!n) {
    return console.error("Invalid element type:", t.type);
  }
  var o = n(e, t);
  t.className && o.addClassNames(t.className);
  var a = t.gameOptionId;
  return a && (_.on(a, this._gameOptionChangedHandler), o.on("destroy", function () {
    _.removeListener(a, i._gameOptionChangedHandler);
  })), o;
};
n.prototype._gameOptionChanged = function (e, t, i) {
  i !== L && this.refreshUi();
};
n.prototype.refreshUi = function () {
  for (var e = 0; e < this.optionDefinitions.length; e++) {
    this._refreshSection(e);
  }
  this._updateTabsVisibility();
  this._updateElementsVisibility();
};
n.prototype._refreshSection = function (e) {
  for (var t = this.optionDefinitions[e], i = t.elements, n = 0; n < i.length; n++) {
    var o,
      a = i[n],
      s = this.elements[e + "-" + n];
    a.getCurrentValue ? o = a.getCurrentValue() : a.gameOptionId && (o = _[a.gameOptionId]);
    "bool" === a.type ? s.toggleActivation(o, !0) : "dropdown" === a.type ? s.select(o, !0) : "custom" === a.type && "function" == typeof s.updateVisual && s.updateVisual(o);
  }
};
n.prototype._updateTabsVisibility = function () {
  for (var e = 0, t = null, i = 0; i < this.optionDefinitions.length; i++) {
    var n = this.optionDefinitions[i],
      o = !n.shouldShow || n.shouldShow(),
      a = this.menuList.getChildren()[0],
      s = a.getChild(i);
    s.toggleDisplay(o);
    o ? (e++, s.toggleClassName("odd", e % 2 === 0), null === t && (t = i)) : this._hideSection(i);
  }
  this.currentSection || null === t || this.menuList.selectItem(t, {
    noSound: !0
  });
};
n.prototype._updateElementsVisibility = function (e) {
  void 0 === e && (e = this.currentSectionId);
  var t = this.optionDefinitions[e];
  if (!t || !t.elements) {
    return console.error("Invalid section ID: " + e);
  }
  for (var i = 0; i < t.elements.length; i++) {
    var n = t.elements[i],
      o = !n.shouldShow || n.shouldShow(),
      a = this.elements[e + "-" + i];
    a.toggleDisplay(o);
  }
};
n.prototype._showSection = function (e) {
  this.currentSection && this.currentSection.hide();
  this.currentSection = this.sections[e];
  this.currentSectionId = e;
  this.currentSection.show();
  this._updateElementsVisibility(e);
  this.settingsScroller.refresh();
};
n.prototype._hideSection = function (e) {
  var t = this.sections[e];
  this.currentSection === t && (this.currentSection.hide(), this.currentSection = null);
};
n.prototype._selectTab = function (e) {
  var t = this._getSectionByName(e);
  return void 0 === t ? console.error("Invalid tab " + e) : void this.menuList.selectItem(t, {
    scrollToElement: !0
  });
};
n.prototype._getSectionByName = function (e) {
  for (var t = 0; t < this.optionDefinitions.length; t++) {
    if (e === this.optionDefinitions[t].name) {
      return t;
    }
  }
};
n.prototype._initOptionDefinitions = function () {
  this.optionDefinitions = [{
    name: "game",
    title: f("ui.common.general"),
    elements: [{
      type: "header",
      text: f("ui.option.worldOption")
    }, {
      type: "bool",
      gameOptionId: "showAllMonsters",
      text: f("ui.option.viewAllMonsterInGroup")
    }, {
      type: "dropdown",
      gameOptionId: "maxTitlesOrnaments",
      text: f("tablet.option.viewTitlesOrnaments"),
      values: [0, 1, 5, 10, 15, 20],
      labels: [0, 1, 5, 10, 15, 20]
    }, {
      type: "dropdown",
      gameOptionId: "maxActorsBeforeCreatureMode",
      text: f("ui.option.creaturesMode"),
      values: [0, 10, 20, 40, 9999],
      labels: [0, 10, 20, 40, f("ui.common.infinit")]
    }, {
      type: "bool",
      gameOptionId: "alwaysShowGrid",
      text: f("tablet.option.alwaysShowGrid")
    }, {
      type: "dropdown",
      gameOptionId: "menubarSize",
      text: f("tablet.option.menubarSize"),
      values: [2, 3, 4, 5, 6],
      labels: [2, 3, 4, 5, 6]
    }, {
      type: "bool",
      gameOptionId: "monsterInfoFirstPosition",
      text: f("ui.option.monsterInfoFirstPosition")
    }, {
      type: "bool",
      shouldShow: function () {
        return v.isIOSApp;
      },
      gameOptionId: "limitToNotch",
      text: f("ui.option.limitToNotch")
    }, {
      type: "bool",
      gameOptionId: "fullscreen",
      text: f("ui.option.fullScreen")
    }, {
      type: "header",
      text: f("tablet.option.compass")
    }, {
      type: "bool",
      gameOptionId: "autoGpsFlags",
      text: f("tablet.option.autoGpsFlags")
    }, {
      type: "button",
      text: f("tablet.option.unfollowAllQuests"),
      action: window.gui.GPS.questFollower.unfollowAllQuests.bind(window.gui.GPS.questFollower)
    }, {
      type: "bool",
      gameOptionId: "autoGpsPhoenixes",
      text: f("tablet.option.autoGpsPhoenixes")
    }]
  }, {
    name: "fight",
    title: f("ui.common.fight"),
    elements: [{
      type: "header",
      text: f("ui.common.fight")
    }, {
      type: "dropdown",
      gameOptionId: "menubarSizeInFight",
      text: f("tablet.option.fight.menubarSizeInFight"),
      values: [2, 3, 4, 5, 6],
      labels: [2, 3, 4, 5, 6]
    }, {
      type: "dropdown",
      gameOptionId: "toolbarThicknessInFight",
      shouldShow: function () {
        return window.gui.ipadRatio;
      },
      text: f("tablet.option.fight.toolbarThicknessInFight"),
      values: [1, 2, 3],
      labels: [1, 2, 3]
    }, {
      type: "bool",
      gameOptionId: "showMountsInFight",
      text: f("tablet.option.showMountsInFight"),
      action: window.isoEngine.actorManager.refreshActorsLook.bind(window.isoEngine.actorManager)
    }, {
      type: "bool",
      gameOptionId: "hideDeadFighters",
      text: f("ui.option.hideDeadFighters")
    }, {
      type: "bool",
      gameOptionId: "allowSpellEffects",
      text: f("ui.option.allowSpellEffects")
    }, {
      type: "bool",
      gameOptionId: "confirmBoxWhenWalking",
      text: f("tablet.option.fight.confirmBoxWhenWalking")
    }, {
      type: "bool",
      gameOptionId: "showSpeechBubbleInFight",
      text: f("tablet.option.fight.showSpeechBubbleInFight")
    }, {
      type: "bool",
      gameOptionId: "orderFighters",
      text: f("tablet.option.fight.orderFighters")
    }, {
      type: "bool",
      gameOptionId: "showApMpUsed",
      text: f("tablet.option.fight.showApMpUsed")
    }, {
      type: "bool",
      gameOptionId: "fightAlwaysShowGrid",
      text: f("tablet.option.fightAlwaysShowGrid")
    }, {
      type: "bool",
      gameOptionId: "regroupDamages",
      text: f("ui.option.regroupDamages")
    }, {
      type: "header",
      text: f("ui.charcrea.spells")
    }, {
      type: "bool",
      gameOptionId: "allowDamagePreview",
      text: f("ui.option.allowDamagePreview")
    }, {
      type: "bool",
      gameOptionId: "confirmBoxAllowDoubleTap",
      text: f("ui.option.allowDoubleTap")
    }, {
      type: "dropdown",
      gameOptionId: "confirmBoxWhenDragCasting",
      text: f("tablet.option.fight.confirmBoxWhenDragCasting"),
      values: [A.NEVER, A.ALWAYS, A.EMPTY_ONLY],
      labels: [f("tablet.option.fight.Never"), f("tablet.option.fight.Always"), f("tablet.option.fight.EmptyOnly")]
    }, {
      type: "dropdown",
      gameOptionId: "confirmBoxWhenClickCasting",
      text: f("tablet.option.fight.confirmBoxWhenClickCasting"),
      values: [A.NEVER, A.ALWAYS, A.EMPTY_ONLY],
      labels: [f("tablet.option.fight.Never"), f("tablet.option.fight.Always"), f("tablet.option.fight.EmptyOnly")]
    }]
  }, {
    name: "sounds",
    title: f("ui.option.audio"),
    elements: [{
      type: "header",
      text: f("ui.option.audioSubtitle")
    }, {
      type: "bool",
      gameOptionId: "soundOnPlayerTurnStart",
      text: f("ui.option.startTurnSound")
    }, {
      type: "custom",
      CustomClass: M,
      text: f("ui.option.musics"),
      channelId: "music"
    }, {
      type: "custom",
      CustomClass: M,
      text: f("ui.option.environment"),
      channelId: "sfx"
    }, {
      type: "custom",
      CustomClass: M,
      text: f("ui.option.sounds"),
      channelId: "ui"
    }]
  }, {
    name: "notification",
    shouldShow: N.isAvailable,
    title: f("ui.common.notification"),
    elements: [{
      type: "header",
      text: f("ui.common.notification")
    }, {
      type: "bool",
      gameOptionId: "systemNotificationsEnabled",
      text: f("tablet.option.enableNotifications"),
      className: "groupSwitch"
    }, {
      type: "bool",
      gameOptionId: "wantPromoNotif",
      text: f("tablet.option.wantPromoNotif"),
      shouldShow: N.isEnabled
    }, {
      type: "bool",
      gameOptionId: "wantPrismAttackedNotif",
      text: f("tablet.option.wantPrismAttackedNotif"),
      shouldShow: N.isEnabled
    }, {
      type: "bool",
      gameOptionId: "wantPrismVulnerableNotif",
      text: f("tablet.option.wantPrismVulnerableNotif"),
      shouldShow: N.isEnabled
    }]
  }, {
    name: "misc",
    title: f("ui.option.miscellaneousOptions"),
    elements: [{
      type: "header",
      text: f("ui.common.chat")
    }, {
      type: "bool",
      gameOptionId: "censorship",
      text: f("ui.option.censorship")
    }, {
      type: "bool",
      gameOptionId: "chatTimestamp",
      text: f("ui.option.useChatTime")
    }, {
      type: "bool",
      gameOptionId: "topChatBar",
      text: f("ui.option.topChatBar")
    }, {
      type: "header",
      text: f("ui.tutorial.tutorial")
    }, {
      type: "bool",
      gameOptionId: "tutorialTips",
      text: f("ui.option.allowTutorial")
    }, {
      type: "button",
      text: f("ui.option.resetHints"),
      action: T.resetTips.bind(T)
    }, {
      type: "header",
      text: f("tablet.option.spellTooltip")
    }, {
      type: "bool",
      gameOptionId: "spellTooltipName",
      text: f("tablet.option.spellTooltipName")
    }, {
      type: "bool",
      gameOptionId: "spellTooltipApRange",
      text: f("tablet.option.spellTooltipApRange")
    }, {
      type: "bool",
      gameOptionId: "spellTooltipCritical",
      text: f("tablet.option.spellTooltipCritical")
    }, {
      type: "bool",
      gameOptionId: "spellTooltipEffect",
      text: f("tablet.option.spellTooltipEffect")
    }, {
      type: "bool",
      gameOptionId: "spellTooltipDescription",
      text: f("tablet.option.spellTooltipDescription")
    }]
  }, {
    name: "about",
    title: f("tablet.ui.about"),
    elements: [{
      type: "header",
      text: f("tablet.ui.about")
    }, {
      type: "infoText",
      text: window.gui.getBuildVersion()
    }, {
      type: "button",
      text: f("ui.legal.tou"),
      action: E.openUrlInAppBrowser.bind(null, f("ui.legal.linktou"))
    }, {
      type: "button",
      text: f("ui.legal.gcs"),
      action: E.openUrlInAppBrowser.bind(null, f("ui.legal.linkgcs"))
    }, {
      type: "button",
      text: f("ui.legal.accountDeletion"),
      action: u.bind(null)
    }, {
      type: "custom",
      CustomClass: S
    }]
  }, {
    name: "performances",
    title: f("tablet.option.performances"),
    shouldShow: function () {
      return x.getAvailableEngineIds().length > 1;
    },
    elements: [{
      type: "dropdown",
      text: f("tablet.option.performances.engine"),
      values: x.getAvailableEngineIds(),
      labels: x.getAvailableEngineNames(),
      action: x.changeEngineOptionAction,
      getCurrentValue: function () {
        return x.getCurrentEngineId();
      }
    }]
  }];
};
this.sections || this._createContent();
this.refreshUi();
this.windowBody.clearContent();
this.sections = this.currentSection = null;
this.elements = {};
this.menuList = this.settingsScroller = this.settingsCol = null;
this.menuList = i.appendChild(new b({
  className: "menu"
}, {
  disableSelectionToggle: !0
}));
this.menuList.on("selected", function (t) {
  e._showSection(t.id);
  this.scrollToElement(t);
});
e._showSection(t.id);
this.scrollToElement(t);
this.settingsScroller = n.appendChild(new y({
  className: "settings"
}));
this.settingsCol = this.settingsScroller.content;
this._updateTabsVisibility();
this._updateElementsVisibility();
a.getCurrentValue ? o = a.getCurrentValue() : a.gameOptionId && (o = _[a.gameOptionId]);
"bool" === a.type ? s.toggleActivation(o, !0) : "dropdown" === a.type ? s.select(o, !0) : "custom" === a.type && "function" == typeof s.updateVisual && s.updateVisual(o);
s.toggleDisplay(o);
o ? (e++, s.toggleClassName("odd", e % 2 === 0), null === t && (t = i)) : this._hideSection(i);
this.currentSection && this.currentSection.hide();
this.currentSection = this.sections[e];
this.currentSectionId = e;
this.currentSection.show();
this._updateElementsVisibility(e);
this.settingsScroller.refresh();
i.changeVolume(this.volume);
l.playUiSound("SPEC_BUTTON");
this.preferences = r.getValue("soundPreferences", l.getDefaultParams(), !0);
this.channelId = e.channelId;
c.push(u);
u.volume = d / 4;
u.disable();
u.on("tap", t);
this.preferences[this.channelId] = this.preferences[this.channelId] || {
  volume: 0,
  muted: !0
};
this.setPosition(this.preferences[this.channelId].volume || 0);
s(n, o);
e.exports = n;
n.prototype.setPosition = function (e) {
  e = Math.max(0, Math.min(4, ~~(4 * e)));
  for (var t = 0; t < 5; t++) {
    this.buttons[t].enable();
  }
  this.buttons[e].disable();
};
n.prototype.changeVolume = function (e) {
  l.setChannelVolume(this.channelId, e);
  this.setPosition(e);
  this.preferences[this.channelId].volume = e;
  this.preferences[this.channelId].muted = 0 === e;
  r.setValue("soundPreferences", this.preferences, null, !0);
};
l.setChannelVolume(this.channelId, e);
this.setPosition(e);
this.preferences[this.channelId].volume = e;
this.preferences[this.channelId].muted = 0 === e;
r.setValue("soundPreferences", this.preferences, null, !0);
a.appendChild(new s("div", {
  className: ["forumButtonLeft"]
}));
this.forumButtonCaption = a.appendChild(new s("div", {
  className: ["forumButtonCenter"]
}));
a.appendChild(new s("div", {
  className: ["forumButtonRight"]
}));
h(t);
t.on("tap", function () {
  var t = o();
  e._openSocialNetwork({
    schemeiOS: "fb://",
    schemeUrl: "fb://profile/" + p[t].facebookPageNumericId,
    browserUrl: "https://www.facebook.com/" + p[t].facebookPageNumericId
  });
});
h(i);
i.on("tap", function () {
  var t = o();
  e._openSocialNetwork({
    schemeiOS: "twitter://",
    schemeAndroid: "com.twitter.android",
    schemeUrl: "twitter://user?screen_name=" + p[t].twitterAccountId,
    browserUrl: "https://twitter.com/" + p[t].twitterAccountId
  });
});
h(n);
n.on("tap", function () {
  var e = o();
  u.openUrlInDeviceBrowser("https://discordapp.com/invite/" + p[e].discordGroupId);
});
h(a);
a.on("tap", function () {
  u.openUrlInAppBrowser(d("tablet.forum.link"));
});
this.updateContent();
a(n, s);
n.prototype._openSocialNetwork = function (e) {
  if (!window.appAvailability) {
    return u.openUrlInDeviceBrowser(e.browserUrl);
  }
  var t = "";
  l.isIOSApp ? t = e.schemeiOS : l.isAndroidApp && (t = e.schemeAndroid);
  window.appAvailability.check(t, function () {
    window.open(e.schemeUrl, "_system", "location=no");
  }, function () {
    u.openUrlInDeviceBrowser(e.browserUrl);
  });
};
n.prototype.updateContent = function () {
  this.forumButtonCaption.setText(d("tablet.login.forum"));
};
e.exports = n;
l.isIOSApp ? t = e.schemeiOS : l.isAndroidApp && (t = e.schemeAndroid);
window.appAvailability.check(t, function () {
  window.open(e.schemeUrl, "_system", "location=no");
}, function () {
  u.openUrlInDeviceBrowser(e.browserUrl);
});
t.getCurrentEngineId = function () {
  return n() ? window.cordova.plugins.WebViewSelector.currentEngine : d;
};
t.getEngineName = function (e) {
  var t = "tablet.webViewSelector.engine." + e;
  return s(t) ? r(t) : e;
};
t.setCurrentEngine = function (e, i) {
  return n() ? t.getAvailableEngineIds().indexOf(e) === -1 ? i(r("tablet.webViewSelector.engineUnknown", e)) : void window.cordova.plugins.WebViewSelector.setEngine(e, function (e) {
    return e ? (console.error("webViewSelector error: " + e), i(r("tablet.webViewSelector.pluginError"))) : void i();
  }) : i(r("tablet.webViewSelector.pluginNotFound"));
};
t.getAvailableEngineIds = function () {
  if (!a) {
    if (n()) {
      try {
        a = JSON.parse(JSON.stringify(window.cordova.plugins.WebViewSelector.availableEngines));
      } catch (e) {
        a = [d];
      }
    } else {
      a = [d];
    }
  }
  return a;
};
t.getAvailableEngineNames = function () {
  for (var e = t.getAvailableEngineIds(), i = [], n = 0; n < e.length; n++) {
    i.push(t.getEngineName(e[n]));
  }
  return i;
};
t.changeEngineOptionAction = function (e) {
  if (n() && e !== t.getCurrentEngineId()) {
    var i = window.gui;
    t.setCurrentEngine(e, function (e) {
      return e ? (i.openSimplePopup(r("tablet.webViewSelector.unableToChangeEngine") + " " + e), void l.getWindow("options").refreshUi()) : void i.openConfirmPopup({
        message: r("tablet.webViewSelector.restartNeeded") + " " + r("tablet.webViewSelector.restartQuestion"),
        cb: function (e) {
          return e ? void navigator.app.exitApp() : i.openSimplePopup(r("tablet.webViewSelector.delayedRestart"), r("ui.popup.information"));
        }
      });
    });
  }
};
r.call(this, {
  className: "FightEndRewardsWindow",
  positionInfo: {
    left: "c",
    top: "c",
    width: 356,
    height: 274
  }
});
this.scroller = this.windowBody.appendChild(new s());
this.scroller.content.addClassNames("overlayBox");
o(n, r);
e.exports = n;
n.prototype.updateContent = function (e, t, i) {
  this.setTitle(e);
  var n = this.scroller.content;
  n.clearContent();
  for (var o = 0; o < t.length; o += 1) {
    n.appendChild(new a({
      itemData: t[o],
      quantity: i[t[o].id] || 0,
      tooltipOptions: {
        openOnTap: !0
      }
    }));
  }
  this.scroller.refresh();
};
o(n, s);
e.exports = n;
n.prototype._createDom = function () {
  var e = this,
    t = this.windowBody.createChild("div", {
      className: "message"
    }),
    i = new r("div", {
      className: "characterIllu"
    });
  this.insertAsFirstChild(i);
  u.preloadImage("gfx/illusUi/Heroique_tx_GameOver.png", function (e) {
    i.setStyle("backgroundImage", e);
  });
  var n = this.windowBody.createChild("div", {
      className: "buttonContainer"
    }),
    o = n.appendChild(new c(d("ui.common.yes")));
  o.on("tap", function () {
    l.close(e.id);
    a.goBackToSelectionOf("character");
  });
  this.windowTitle.setText(d("ui.common.gameover"));
  t.setHtml(d("ui.gameuicore.hardcoreDeath"));
};
this.insertAsFirstChild(i);
u.preloadImage("gfx/illusUi/Heroique_tx_GameOver.png", function (e) {
  i.setStyle("backgroundImage", e);
});
o.on("tap", function () {
  l.close(e.id);
  a.goBackToSelectionOf("character");
});
this.windowTitle.setText(d("ui.common.gameover"));
t.setHtml(d("ui.gameuicore.hardcoreDeath"));
l.close(e.id);
a.goBackToSelectionOf("character");
c.call(this, {
  title: a("ui.common.confirm"),
  className: "ShopConfirmWindow",
  positionInfo: {
    left: "c",
    top: "c",
    width: 700,
    height: 400,
    isModal: !0
  }
});
this._hintArrow = null;
this._reset();
this.on("open", this._onOpen);
this.on("close", this._onClose);
l.on("canNotComputeSoftPrices", function () {
  if (e.articleBox) {
    var t = !e.isPurchasing,
      i = !e.params.article.product && !!e.params.isSoft;
    t && i && d.close(e.id);
  }
});
l.on("computedSoftPricesChange", function () {
  if (e.articleBox) {
    var t = !e.isPurchasing,
      i = !e.params.article.product && !!e.params.isSoft;
    t && i && (u.enrichWithSoftPrice(e.params.article), e.updateAmount());
  }
});
r(n, c);
e.exports = n;
n.prototype._reset = function () {
  this.params = null;
  this.cb = null;
  this.articleBox = null;
  this.buyBtn = null;
  this.buyBtnAmount = null;
  this.buyBtnIcon = null;
  this.purchaseLoader = null;
  this._setIsPurchasing(!1);
};
n.prototype._onOpen = function () {
  this.articleBox || this._createContent();
};
n.prototype._onClose = function () {
  return this._hintArrow.hideArrow(), this.cb && this.cb(!1);
};
n.prototype.freeContent = function () {
  this.windowBody.clearContent();
  this._reset();
};
n.prototype._createContent = function () {
  var e = this.windowBody.createChild("div", {
      className: "twoColumns"
    }),
    t = e.createChild("div", {
      className: "leftCol"
    });
  this.articleBox = t.appendChild(new m(null, {
    boxWidth: 290,
    boxHeight: 330
  }, {
    showTitle: !0,
    promoType: "corner"
  }));
  var i = e.createChild("div", {
      className: "rightCol"
    }),
    n = i.createChild("div", {
      className: "articleLabels"
    });
  this.articleTitle = n.createChild("div", {
    className: "articleTitle"
  });
  this.articleSubtitle = n.createChild("div", {
    className: "articleSubtitle"
  });
  this.itemsList = i.createChild("div", {
    className: "itemsList"
  });
  var s = i.createChild("div", {
      className: "bottomRightContainer"
    }),
    r = s.createChild("div", {
      className: "infoArticle"
    }),
    l = a("ui.common.quantity") + a("ui.common.colon"),
    c = r.createChild("div", {
      className: "quantityContent"
    });
  c.createChild("div", {
    className: "quantityLabel",
    text: l
  });
  c.createChild("div", {
    className: "quantityAmount",
    text: "1"
  });
  var d = a("ui.common.price") + a("ui.common.colon"),
    u = r.createChild("div", {
      className: "priceContent"
    });
  u.createChild("div", {
    className: "priceLabel",
    text: d
  });
  this.amount = u.createChild("div", {
    className: "priceAmount"
  });
  this.priceIcon = u.createChild("div", {
    className: "priceIcon"
  });
  var p = this;
  this.buyBtn = s.appendChild(new o({
    className: ["buyBtn", "greenButton"]
  }, function () {
    p._setIsPurchasing(!0);
    p.cb(!0);
  }));
  this._hintArrow = this.buyBtn.appendChild(new h());
  var f = this.buyBtn.createChild("div", {
    className: "btnContent"
  });
  this.btnLabel = f.createChild("div", {
    className: "btnLabel"
  });
  this.purchaseLoader = i.createChild("div", {
    className: ["purchaseLoader", "spinner"],
    hidden: !0
  });
  this.purchaseLoader.createChild("div", {
    className: "purchaseLoaderLabel",
    text: a("tablet.shop.transactionInProgress")
  });
};
n.prototype.confirmBuy = function (e, t) {
  d.open(this.id);
  this._setIsPurchasing(!1);
  this.params = e;
  this.cb = t;
  this.articleBox.update(e.article);
  this.update();
};
n.prototype._setIsPurchasing = function (e) {
  this.isPurchasing = !!e;
  this.articleBox && (e ? (this.closeButton.disable(), this.buyBtn.disable()) : (this.closeButton.enable(), this.buyBtn.enable()), this.purchaseLoader.toggleDisplay(e));
};
n.prototype.update = function () {
  if (this.articleBox) {
    var e = this.params,
      t = e.article;
    this.articleTitle.setText(t.name);
    this.articleSubtitle.setText(t.subtitle || "");
    this.btnLabel.setText(a("ui.common.buy"));
    var i = t.product;
    if (i && e.isInApp) {
      this.amount.setText(i.price);
      this.priceIcon.hide();
    } else if (t.is_free) {
      this.btnLabel.setText(a("ui.shop.free"));
      this.amount.setText(a("ui.shop.free"));
      this.priceIcon.hide();
    } else {
      var n = e.isSoft,
        o = window.gui.playerData.inventory,
        r = n ? o.kamas : o.goultines,
        l = n ? t._softPrice : t._hardPrice;
      l > r ? this.buyBtn.disable() : this.buyBtn.enable();
      this.amount.setText(s.intToString(l));
      this.priceIcon.show();
      this.priceIcon.toggleClassName("hardCcy", !n);
      this.priceIcon.toggleClassName("softCcy", !!n);
      window.gui.scenarioManager.isBehaviourEnabled(f.DISABLE_FAKE_SHOP) || this.buyBtn.enable();
    }
    this.itemsList.clearContent();
    p(t, this.itemsList);
  }
};
this.params = null;
this.cb = null;
this.articleBox = null;
this.buyBtn = null;
this.buyBtnAmount = null;
this.buyBtnIcon = null;
this.purchaseLoader = null;
this._setIsPurchasing(!1);
this.windowBody.clearContent();
this._reset();
this.articleTitle = n.createChild("div", {
  className: "articleTitle"
});
this.articleSubtitle = n.createChild("div", {
  className: "articleSubtitle"
});
this.itemsList = i.createChild("div", {
  className: "itemsList"
});
c.createChild("div", {
  className: "quantityLabel",
  text: l
});
c.createChild("div", {
  className: "quantityAmount",
  text: "1"
});
u.createChild("div", {
  className: "priceLabel",
  text: d
});
this.amount = u.createChild("div", {
  className: "priceAmount"
});
this.priceIcon = u.createChild("div", {
  className: "priceIcon"
});
this.buyBtn = s.appendChild(new o({
  className: ["buyBtn", "greenButton"]
}, function () {
  p._setIsPurchasing(!0);
  p.cb(!0);
}));
this._hintArrow = this.buyBtn.appendChild(new h());
p._setIsPurchasing(!0);
p.cb(!0);
this.btnLabel = f.createChild("div", {
  className: "btnLabel"
});
this.purchaseLoader = i.createChild("div", {
  className: ["purchaseLoader", "spinner"],
  hidden: !0
});
this.purchaseLoader.createChild("div", {
  className: "purchaseLoaderLabel",
  text: a("tablet.shop.transactionInProgress")
});
d.open(this.id);
this._setIsPurchasing(!1);
this.params = e;
this.cb = t;
this.articleBox.update(e.article);
this.update();
this.isPurchasing = !!e;
this.articleBox && (e ? (this.closeButton.disable(), this.buyBtn.disable()) : (this.closeButton.enable(), this.buyBtn.enable()), this.purchaseLoader.toggleDisplay(e));
this.articleTitle.setText(t.name);
this.articleSubtitle.setText(t.subtitle || "");
this.btnLabel.setText(a("ui.common.buy"));
this.amount.setText(i.price);
this.priceIcon.hide();
this.btnLabel.setText(a("ui.shop.free"));
this.amount.setText(a("ui.shop.free"));
this.priceIcon.hide();
l > r ? this.buyBtn.disable() : this.buyBtn.enable();
this.amount.setText(s.intToString(l));
this.priceIcon.show();
this.priceIcon.toggleClassName("hardCcy", !n);
this.priceIcon.toggleClassName("softCcy", !!n);
window.gui.scenarioManager.isBehaviourEnabled(f.DISABLE_FAKE_SHOP) || this.buyBtn.enable();
this.itemsList.clearContent();
p(t, this.itemsList);
p = "vg_" + g.id;
m[p] && "1" !== h.quantity ? m[p].quantity++ : (m[p] = {
  slot: t.appendChild(new r({
    tooltip: g.name
  })),
  quantity: parseInt(h.quantity, 10) || 1
}, f.push(g.id));
p = "promo_" + T;
f.push(T);
t && t.slot.setImage(e[n]);
i && i.slot.setImage(e[n]);
d.call(this, "div", {
  className: "box"
});
this.options = i || {};
this._createDom();
e && this.update(e);
t && this.resize(t);
c(n, d);
e.exports = n;
n.prototype._createDom = function () {
  var e = this,
    t = this.options,
    i = this.createChild("div", {
      className: "slot"
    });
  this.slotBackground = i.createChild("div", {
    className: "slotBackground"
  });
  var n = i.createChild("div", {
    className: "slotIllu"
  });
  if (this.slotImg = n.createChild("div", {
    className: "slotImg"
  }), t.showReferences && (this.slotItems = n.createChild("div", {
    className: "slotItems"
  })), this.slotPromoImg = n.createChild("div", {
    className: "slotPromoImg"
  }), t.showDescription && (this.description = i.createChild("div", {
    className: "description"
  })), i.createChild("div", {
    className: "slotBorder"
  }), t.canTapImage && (u(i), i.on("tap", o.bind(this))), t.showTitle) {
    var a = this.createChild("div", {
      className: "labels"
    });
    this.title = a.createChild("div", {
      className: "title"
    });
    this.subtitle = a.createChild("div", {
      className: "subtitle"
    });
  }
  if (t.showButtons) {
    var s = this._articleButtons = this.appendChild(new p());
    s.on("tapIAPButton", function () {
      e.emit("tapIAPButton");
    });
    s.on("tapHardButton", function () {
      e.emit("tapHardButton");
    });
    s.on("tapSoftButton", function () {
      e.emit("tapSoftButton");
    });
  }
  if ("banner" === t.promoType) {
    this._promoBanner = i.createChild("div", {
      className: "promoBanner"
    });
    this._promoBannerOver = i.createChild("div", {
      className: "promoBannerOver"
    });
    this._promoBannerFree = i.createChild("div", {
      className: "promoBannerFree"
    });
  } else if ("corner" === t.promoType) {
    var r = this._promoCorner = i.createChild("div", {
      className: "promoCorner"
    });
    r.createChild("div", {
      className: "promoDummy"
    });
    var l = r.createChild("div", {
      className: "promoElement"
    });
    l.createChild("div", {
      className: "margin"
    });
    var c = l.createChild("div", {
      className: "rotatedContainer"
    });
    this._promoRate = c.createChild("div", {
      className: "text"
    });
  } else {
    "strip" === t.promoType && (this._promoStrip = this.createChild("div", {
      className: "promoStrip"
    }));
  }
  this.on("destroy", function () {
    this._clearCountdown();
  });
};
n.prototype._clearCountdown = function () {
  this.countdown && this.countdown.clear();
};
n.prototype.clear = function () {
  this._clearCountdown();
};
n.prototype.update = function (e) {
  var t = this.options,
    i = this;
  this.articleId = e.id;
  var n = a(e);
  this.slotImg.setStyle("backgroundImage", n.imgArticle ? g(n.imgArticle) : "none");
  this.slotPromoImg.clearContent();
  n.imgPromo.forEach(function (e) {
    var t = i.slotPromoImg.createChild("div", {
      className: "promoImg"
    });
    t.setStyle("backgroundImage", g(e));
  });
  var o = !e.hasOwnProperty("_softPrice"),
    c = e.is_free,
    d = l(e);
  this.toggleClassName("goultineOnly", o && !c && !d);
  this.toggleClassName("freeItem", c && !d);
  this.toggleClassName("packGoultine", d);
  this.toggleClassName("bonusPack", r(e));
  this.delClassNames(M);
  for (var u = e.metas || [], p = 0; p < u.length; p++) {
    var _ = u[p];
    if (parseInt(_.id, 10) === w && _.metas.length > 0) {
      var v = _.metas.length > 0 && b[_.metas[0].id];
      v && this.addClassNames(v);
    }
  }
  var y = t.promoType,
    T = e._promoRate,
    C = Boolean(T) || c,
    I = e.enddate && e.showCountDown;
  "banner" === y ? (this._promoBanner.toggleDisplay(!!I && !c), this._promoBannerOver.toggleDisplay(!1), this._promoBannerFree.toggleDisplay(c), I && (this._clearCountdown(), this.countdown = new m(new Date(e.enddate), function (e, t, n) {
    return e ? console.error(e) : (i._promoBanner.setText(h("tablet.shop.promo.banner", n)), void i._promoBannerFree.setText(h("tablet.shop.promo.banner", n)));
  }, function () {
    return i.rootElement ? (i._promoBannerOver.setText(h("tablet.shop.promo.banner.over")), i._promoBannerFree.setText(h("tablet.shop.promo.banner.over")), i._promoBannerOver.toggleDisplay(!c), void i._promoBanner.toggleDisplay(!1)) : console.error(new Error("articleBox onTimeout: the box is missing " + i.articleId));
  }))) : "corner" === y ? (this._promoCorner.toggleDisplay(C), this._promoCorner.toggleClassName("promoCorner", !c), this._promoCorner.toggleClassName("promoCornerFree", c), C && this._promoRate.setText(s(e))) : "strip" === y && (this._promoStrip.toggleDisplay(C), this._promoStrip.toggleClassName("promoStrip", !c), this._promoStrip.toggleClassName("promoStripFree", c), C && this._promoStrip.setText(s(e)));
  t.showTitle && (this.title.setText(e.name), this.subtitle.setText(e.subtitle || ""));
  t.showReferences && f(e, this.slotItems, {
    hideSubscriptionDays: !0
  });
  this.updatePrice(e);
  t.showDescription && this.description.setHtml(e.description);
};
n.prototype.updatePrice = function (e) {
  this.options.showButtons && this._articleButtons.update(e);
};
n.prototype.resize = function (e) {
  this.setStyles({
    width: e.boxWidth + "px",
    height: e.boxHeight + "px"
  });
  this.options.showButtons && this._articleButtons.resize(e);
};
n.prototype.getButtons = function () {
  return this._articleButtons;
};
this.title = a.createChild("div", {
  className: "title"
});
this.subtitle = a.createChild("div", {
  className: "subtitle"
});
s.on("tapIAPButton", function () {
  e.emit("tapIAPButton");
});
s.on("tapHardButton", function () {
  e.emit("tapHardButton");
});
s.on("tapSoftButton", function () {
  e.emit("tapSoftButton");
});
this._promoBanner = i.createChild("div", {
  className: "promoBanner"
});
this._promoBannerOver = i.createChild("div", {
  className: "promoBannerOver"
});
this._promoBannerFree = i.createChild("div", {
  className: "promoBannerFree"
});
this.slotImg.setStyle("backgroundImage", n.imgArticle ? g(n.imgArticle) : "none");
this.slotPromoImg.clearContent();
n.imgPromo.forEach(function (e) {
  var t = i.slotPromoImg.createChild("div", {
    className: "promoImg"
  });
  t.setStyle("backgroundImage", g(e));
});
this.toggleClassName("goultineOnly", o && !c && !d);
this.toggleClassName("freeItem", c && !d);
this.toggleClassName("packGoultine", d);
this.toggleClassName("bonusPack", r(e));
this.delClassNames(M);
"banner" === y ? (this._promoBanner.toggleDisplay(!!I && !c), this._promoBannerOver.toggleDisplay(!1), this._promoBannerFree.toggleDisplay(c), I && (this._clearCountdown(), this.countdown = new m(new Date(e.enddate), function (e, t, n) {
  return e ? console.error(e) : (i._promoBanner.setText(h("tablet.shop.promo.banner", n)), void i._promoBannerFree.setText(h("tablet.shop.promo.banner", n)));
}, function () {
  return i.rootElement ? (i._promoBannerOver.setText(h("tablet.shop.promo.banner.over")), i._promoBannerFree.setText(h("tablet.shop.promo.banner.over")), i._promoBannerOver.toggleDisplay(!c), void i._promoBanner.toggleDisplay(!1)) : console.error(new Error("articleBox onTimeout: the box is missing " + i.articleId));
}))) : "corner" === y ? (this._promoCorner.toggleDisplay(C), this._promoCorner.toggleClassName("promoCorner", !c), this._promoCorner.toggleClassName("promoCornerFree", c), C && this._promoRate.setText(s(e))) : "strip" === y && (this._promoStrip.toggleDisplay(C), this._promoStrip.toggleClassName("promoStrip", !c), this._promoStrip.toggleClassName("promoStripFree", c), C && this._promoStrip.setText(s(e)));
t.showTitle && (this.title.setText(e.name), this.subtitle.setText(e.subtitle || ""));
t.showReferences && f(e, this.slotItems, {
  hideSubscriptionDays: !0
});
this.updatePrice(e);
t.showDescription && this.description.setHtml(e.description);
this.setStyles({
  width: e.boxWidth + "px",
  height: e.boxHeight + "px"
});
this.options.showButtons && this._articleButtons.resize(e);
l.call(this, "div", {
  className: "priceButtonsBox"
});
this._hintArrow = null;
this._createDom();
e && this.update(e);
t && this.resize(t);
"tapHardButton" === e && this._clearHintArrow();
this.emit(e);
e.toggleClassName("iap", !!n);
n ? (e.delClassNames(["unavailable"]), e.currentPriceText.setText(t)) : (e.toggleClassName("unavailable", !t), o ? (e.currentPriceText.setText(h("ui.shop.free")), e.replaceClassNames(["bigPrice"], ["lowPrice"]), e.enable()) : t ? (e.currentPriceText.setText(c.kamasToString(t, "")), t >= p ? e.replaceClassNames(["lowPrice"], ["bigPrice"]) : t < m ? e.replaceClassNames(["bigPrice"], ["lowPrice"]) : e.delClassNames(["lowPrice", "bigPrice"]), e.enable(), i && (a = c.kamasToString(i, ""), e.originalPriceText.setText(a))) : (e.currentPriceText.setText(h("ui.item.averageprice.unavailable")), e.replaceClassNames(["lowPrice"], ["bigPrice"]), e.disable()));
e.currentPriceText.setStyle("fontSize", s + "px");
e.currentIcon.setStyles({
  width: Math.floor(s) + "px",
  height: Math.floor(s) + "px"
});
e.originalPriceText.setStyle("fontSize", r + "px");
e.originalIcon.setStyles({
  width: Math.floor(r) + "px",
  height: Math.floor(r) + "px"
});
r(n, l);
e.exports = n;
n.prototype._createDom = function () {
  function e(e, i) {
    var n = i ? ["priceButton", i] : "priceButton",
      o = t.appendChild(new u("", {
        className: n
      }, e)),
      a = o.createChild("div", {
        className: "prices"
      }),
      s = a.createChild("div", {
        className: "original"
      });
    o.originalPriceText = s.createChild("div", {
      className: "text"
    });
    o.originalIcon = s.createChild("div", {
      className: "icon"
    });
    var r = a.createChild("div", {
      className: "current"
    });
    return o.currentPriceText = r.createChild("div", {
      className: "text"
    }), o.currentIcon = r.createChild("div", {
      className: "icon"
    }), o;
  }
  this.createChild("div", {
    className: "priceBorder"
  });
  var t = this.priceButtons = this.createChild("div", {
    className: "priceButtons"
  });
  this.iapButton = e(o.bind(this, "tapIAPButton"));
  this.hardButton = e(o.bind(this, "tapHardButton"), "hard");
  this.softButton = e(o.bind(this, "tapSoftButton"), "soft");
};
n.prototype.update = function (e) {
  this.articleId = e.id;
  var t = e._hardOriginalPrice,
    i = e.product;
  if (this._clearHintArrow(), this.iapButton.hide(), this.hardButton.hide(), this.softButton.hide(), this.hardButton.delClassNames("twoPrices"), this.iapButton.delClassNames("twoPrices"), e.is_free) {
    return this.priceButtons.toggleClassName("promo", !1), a(this.hardButton, 0, 0, !1, !0), this.hardButton.show(), void this.checkButtons();
  }
  if (i && (this.priceButtons.toggleClassName("promo", !1), a(this.iapButton, e._inAppPrice, e.original_price, !0, !1), this.iapButton.show()), e._hardPrice) {
    this.priceButtons.toggleClassName("promo", !!t);
    a(this.hardButton, e._hardPrice, t, !1, !1);
    a(this.softButton, e._softPrice, e._softOriginalPrice, !1, !1);
    this.hardButton.show();
    var n = !e.hasOwnProperty("_softPrice");
    this.softButton.toggleDisplay(!n);
    n && i && (this.iapButton.addClassNames("twoPrices"), this.hardButton.addClassNames("twoPrices"));
    n || this.hardButton.addClassNames("twoPrices");
  }
  this.checkButtons();
};
n.prototype.checkButtons = function () {
  var e = this;
  window.setTimeout(function () {
    s(e.hardButton);
    s(e.softButton);
    s(e.iapButton);
  }, 0);
};
n.prototype.resize = function () {
  this.checkButtons();
};
n.prototype._clearHintArrow = function () {
  this._hintArrow && (this._hintArrow.clearContent(), this._hintArrow = null);
};
o.originalPriceText = s.createChild("div", {
  className: "text"
});
o.originalIcon = s.createChild("div", {
  className: "icon"
});
this.iapButton = e(o.bind(this, "tapIAPButton"));
this.hardButton = e(o.bind(this, "tapHardButton"), "hard");
this.softButton = e(o.bind(this, "tapSoftButton"), "soft");
this.priceButtons.toggleClassName("promo", !!t);
a(this.hardButton, e._hardPrice, t, !1, !1);
a(this.softButton, e._softPrice, e._softOriginalPrice, !1, !1);
this.hardButton.show();
this.softButton.toggleDisplay(!n);
n && i && (this.iapButton.addClassNames("twoPrices"), this.hardButton.addClassNames("twoPrices"));
n || this.hardButton.addClassNames("twoPrices");
s(e.hardButton);
s(e.softButton);
s(e.iapButton);
a.call(this, {
  window: {
    className: "MarketWindow",
    positionInfo: {
      top: "c",
      left: "c",
      width: "100%",
      height: "100%"
    }
  }
});
this.addTab("shop", new s(e, t));
this.on("open", function (e) {
  this.tabs.openTab(e.tabId, e.tabParams, {
    delayOpenedEvent: !0,
    forceOpen: !0
  });
});
o(n, a);
e.exports = n;
c.call(this, "div", {
  className: "ShopWindow",
  name: "shop"
});
s = t;
this.nbArticlesVisible = 1;
this.activeTopTab = null;
this.selectedTopTab = null;
this.selectedSubTab = null;
this.openedCategory = null;
this.categoriesName = {};
this.categoriesData = {};
this.bonusCountdown = null;
this.requestTimestamp = 0;
this.requestTimeout = null;
this.lastAction = null;
this._isInitializing = !1;
this.articlesMap = {};
this._views = {};
this._currentViewName = null;
this._previousViewName = null;
this._categoryToOpenWhenReady = null;
this._needsResize = !1;
this._isOpened = !1;
this._articleIdToOpen = 0;
window.gui.on("connected", function () {
  a();
});
this.once("open", function () {
  this._createDom();
  this._setupEvents();
});
this.on("open", function (e) {
  e && e.articleId && (this._articleIdToOpen = e.articleId);
});
this.on("opened", function (e) {
  return this._isOpened = !0, this._categoryToOpenWhenReady = null, e && e.tabParams && e.tabParams.category && (this._categoryToOpenWhenReady = e.tabParams.category), window.gui.scenarioManager.isBehaviourEnabled(M.DISABLE_FAKE_SHOP) ? this._currentViewName ? void (e && e.tabParams && e.tabParams.category && this._navigateToCategory(e.tabParams.category)) : (this._isInitializing || this._reinitializeShop(), this._needsResize && this.resize(), void a()) : this._showFakeShop(function (e) {
    if (e) {
      return console.error(e);
    }
  });
});
this.on("close", function () {
  this._isOpened = !1;
  this.wallet.resetFakeHardAmount();
  this.clearShop();
});
this._createDom();
this._setupEvents();
this._isOpened = !1;
this.wallet.resetFakeHardAmount();
this.clearShop();
P[x] = {
  lines: 1,
  promoType: "corner",
  showArticleDescription: !0,
  useBonusPackDisplay: !0,
  canTapImage: !1
};
P[L] = {
  lines: 1,
  promoType: "corner",
  showArticleDescription: !0,
  useBonusPackDisplay: !0,
  position: "left",
  canTapImage: !1
};
B[x] = !0;
B[L] = !0;
window.m = m;
r(o, c);
e.exports = o;
o.prototype._showFakeShop = function (e) {
  var t = this;
  return this.wallet.setFakeHardAmount(400), this._needsResize && this.resize(), T(function (i, n) {
    return i || !n ? e(new Error("ShopWindow._showFakeShop: unable to get data. " + i)) : (t.onShopOpenCategorySuccess(n), t._openCategory(L), e(null));
  });
};
o.prototype.setSubCategoryRowVisible = function (e) {
  var t = F !== e;
  F = e;
  this.subCategoryRow.toggleDisplay(e);
  this.subCategoryRowSeparator.toggleDisplay(e);
  t && (this.viewContainer.toggleClassName("hasSubCategory", e), this.resize());
};
o.prototype._activateTopTab = function (e) {
  var t = e.getWuiName(),
    i = this.activeTopTab;
  if (i) {
    if (e === i) {
      return;
    }
    this._deactivateTopTab(i);
  }
  if (this.setSubCategoryRowVisible(!1), t === E) {
    this.closeCategory(this.openedCategory);
    this._setView(A);
  } else {
    if (this._isSameCategory(t)) {
      return;
    }
    if (e.sublist) {
      for (var n = this.subCategoryRow.getChildren(), o = 0; o < n.length; o++) {
        this.subCategoryRow.removeChild(n[o]);
      }
      this.subCategoryRow.appendChild(e.sublist);
      this.setSubCategoryRowVisible(!0);
      k && (e.sublist.deselectAll(), this.selectedSubTab = null);
    }
    this._openCategory(t);
  }
  this.activeTopTab = e;
  this.selectedTopTab = t;
  e.addClassNames("on");
  u("TAB");
};
o.prototype._activateSubCategory = function (e) {
  var t = e.getWuiName();
  this._isSameCategory(t) || (this.selectedSubTab = t, this._openCategory(t), u("TAB"));
};
F = e;
this.subCategoryRow.toggleDisplay(e);
this.subCategoryRowSeparator.toggleDisplay(e);
t && (this.viewContainer.toggleClassName("hasSubCategory", e), this.resize());
this.closeCategory(this.openedCategory);
this._setView(A);
this.subCategoryRow.appendChild(e.sublist);
this.setSubCategoryRowVisible(!0);
k && (e.sublist.deselectAll(), this.selectedSubTab = null);
this.activeTopTab = e;
this.selectedTopTab = t;
e.addClassNames("on");
u("TAB");
o.prototype._deactivateTopTab = function (e) {
  var t = e.getWuiName();
  t !== E && (e.sublist && (this.setSubCategoryRowVisible(!1), e.sublist.deselectAll()), this._isSameCategory(t) && this.closeCategory(t));
  e.delClassNames("on");
  this.activeTopTab = null;
};
o.prototype._deactivateSubCategory = function (e) {
  var t = e.getWuiName();
  this._isSameCategory(t) && (this.closeCategory(t), H && (this.selectedSubTab = null, this._openCategory(this.selectedTopTab)));
};
o.prototype.deactivateAllCategories = function () {
  H = !1;
  this.activeTopTab && this._deactivateTopTab(this.activeTopTab);
  H = !0;
};
o.prototype.reactivateCategories = function () {
  var e = this.selectedTopTab;
  if (e) {
    k = !1;
    var t = this.topTabsList.getChild(e);
    if (this._activateTopTab(t), !t.sublist || !this.selectedSubTab) {
      return void (k = !0);
    }
    t.sublist.selectItem(this.selectedSubTab);
    k = !0;
  }
};
o.prototype._openGoultinesCategory = function () {
  this._isSameCategory(N) || (this.deactivateAllCategories(), this.setSubCategoryRowVisible(!1), this._openCategory(N));
};
o.prototype._createDom = function () {
  var e = this,
    t = this.createChild("div", {
      className: "row1"
    });
  t.createChild("div", {
    className: ["separator", "first"]
  });
  this.subCategoryRowSeparator = t.createChild("div", {
    className: ["separator", "second"]
  });
  R.name = l("tablet.shop.homepage.name");
  this.topTabsList = t.createChild("div", {
    className: "topTabsList"
  });
  this._closeButton = t.appendChild(new h({
    className: "closeButton",
    scaleOnPress: !0
  }));
  this._closeButton.on("tap", function () {
    n();
  });
  this.wallet = t.appendChild(new f({
    emitTap: !0,
    showBonusPack: !0
  }));
  this.wallet.on("moreGoultinesTap", function () {
    var t = e.topTabsList.getChild(D.id);
    t && e._activateTopTab(t);
  });
  this.wallet.on("bonusPackTap", function () {
    var t = e.topTabsList.getChild(x);
    t && e._activateTopTab(t);
  });
  this.subCategoryRow = this.createChild("div", {
    className: "subCategoryRow"
  });
  this.viewContainer = this.createChild("div", {
    className: "row2"
  });
  this.setSubCategoryRowVisible(!1);
  this._views[A] = new _();
  this._views[I] = new v();
  this._views[S] = new y();
};
o.prototype._setView = function (e, t) {
  if (this._currentViewName !== e) {
    this.deactivateAllCategories();
    this._previousViewName = this._currentViewName;
    this._currentViewName = e;
    for (var i = this.viewContainer, n = i.getChildren(), o = 0; o < n.length; o++) {
      i.removeChild(n[o]);
    }
    var a = this._views[e];
    a && (i.appendChild(a), a.update(t));
  }
};
o.prototype.goToPreviousView = function () {
  return this._previousViewName === A ? this.reactivateCategories() : this._previousViewName === I ? (this.reactivateCategories(), void this._views[I].restoreScrollPosition()) : void this._setView(this._previousViewName);
};
o.prototype._displayItemDetails = function (e) {
  if (this._currentViewName === I) {
    var t = this._views,
      i = t[I];
    i.saveScrollPosition();
  }
  var n = this.articlesMap[e],
    o = this.openedCategory || E,
    a = this.categoriesName[o];
  n && this._setView(S, {
    article: n,
    categoryName: a
  });
};
o.prototype._setupEvents = function () {
  function e(e) {
    window.gui.scenarioManager.isBehaviourEnabled(M.DISABLE_FAKE_SHOP) && w.purchaseArticleOnStore(d.articlesMap[e]);
  }
  function t(e, t) {
    return window.gui.scenarioManager.isBehaviourEnabled(M.DISABLE_FAKE_SHOP) ? void w.purchaseArticleOnAnkama(d.articlesMap[e], t) : (window.gui.scenarioManager.checkCondition(window.gui.scenarioManager.conditionTypeEnum.FAKE_SHOP_BUY), m.close("shopConfirm"), void n());
  }
  function i(e) {
    d.showSubCategoryRow(e);
  }
  function o() {
    d.showSubCategoryRow(!1);
  }
  function a() {
    var e = window.gui.scenarioManager.isBehaviourEnabled(M.SHOP_BUTTONS);
    d.toggleClassName("disabledBehaviour", !e);
  }
  var s = window.dofus.connectionManager,
    r = this._views,
    l = r[I],
    c = r[S],
    d = this;
  s.on("shopOpenError", function (e) {
    d.onShopOpenError(e);
  });
  s.on("shopOpenSuccess", function (e) {
    d.onShopOpenSuccess(e);
  });
  s.on("shopOpenCategoryError", function (e) {
    d.onShopOpenCategoryError(e);
  });
  s.on("shopOpenCategorySuccess", function (e) {
    d.onShopOpenCategorySuccess(e);
  });
  s.on("AccessoryPreviewErrorMessage", function (e) {
    console.error(new Error("Accessory preview failed with: " + e.error + " for article " + c.getArticleId()));
    c.setLook(null);
  });
  s.on("AccessoryPreviewMessage", function (e) {
    c.setLook(e.look);
  });
  window.gui.on("resize", function () {
    d.resize();
  });
  m.getWindow("shopConfirm").on("closed", function (e) {
    e && e.endPurchase && d._refreshCurrentTab();
  });
  for (var u in r) {
    var h = r[u];
    h.on("displayItemDetails", this._displayItemDetails.bind(this));
    h.on("purchaseIAP", e);
    h.on("purchaseOnAnkama", t);
    h.on("showSubCategoryRow", i);
    h.on("hideSubCategoryRow", o);
    h.on("openCategory", function (e) {
      d._openCategory(e);
    });
  }
  l.on("loadAdditionalContent", function () {
    d._saveAndExecuteAction(function () {
      d.loadAdditionalContent();
    });
  });
  l.on("nbArticlesVisibleUpdated", function (e) {
    d.nbArticlesVisible = e;
  });
  c.on("goToPreviousView", function () {
    d.goToPreviousView();
  });
  c.on("requestPrevisualization", function (e) {
    s.sendMessage("AccessoryPreviewRequestMessage", {
      genericId: e
    });
  });
  g.on("canNotComputeSoftPrices", function () {
    d.isOpen() && d.updateArticlesPrices();
  });
  g.on("computedSoftPricesChange", function () {
    d.isOpen() && d.updateArticlesPrices();
  });
  a();
  window.gui.scenarioManager.on("stepChanged", function () {
    a();
  });
};
o.prototype.isOpen = function () {
  return m.getWindow("market").openState;
};
o.prototype.showSubCategoryRow = function (e) {
  for (var t = this.subCategoryRow.getChildren(), i = 0; i < t.length; i++) {
    this.subCategoryRow.removeChild(t[i]);
  }
  var n = !!e;
  this.setSubCategoryRowVisible(n);
  n && this.subCategoryRow.appendChild(e);
};
o.prototype._navigateToCategory = function (e) {
  "goultines" === e ? this._openGoultinesCategory() : "bonuspack" === e && this._openCategory(x);
};
o.prototype.onShopOpenError = function () {
  this._isInitializing = !1;
  this.viewContainer.delClassNames("spinner");
  this.isOpen() && this._showErrorPopup(!0);
};
o.prototype.onShopOpenSuccess = function (e) {
  if (this._isInitializing = !1, this.viewContainer.delClassNames("spinner"), this.isOpen()) {
    this.wallet.goultinesBtn.enable();
    this.wallet.bonusPackBtn.enable();
    var t = e.home;
    this.setCategories(t.categories);
    var i = this.topTabsList.getChildren();
    i.length && this._activateTopTab(i[0]);
    var n;
    if (t._highlightImageArticle) {
      var o = this.validateArticles([t._highlightImageArticle]);
      o.length && (n = o[0]);
    }
    var a;
    if (t.gondolahead_article && (a = this.validateArticles(t.gondolahead_article)), t._highlightCarouselElements && this.validateArticles(t._highlightCarouselArticles), t.hightlight_popup) {
      for (var r = [], l = 0, c = t.hightlight_popup.length; l < c; l += 1) {
        var d = t.hightlight_popup[l];
        d.external_article && r.push(d.external_article);
      }
      this.validateArticles(r);
    }
    var u = {
      gondolaHeadArticles: a,
      highlightCarouselArticles: t._highlightCarouselElements,
      highlightImageArticle: n
    };
    if (this._views[A].update(u), this._categoryToOpenWhenReady && this._navigateToCategory(this._categoryToOpenWhenReady), s.isAvailable() && w.checkPendingPurchases(), this._articleIdToOpen) {
      var h = this.articlesMap[this._articleIdToOpen];
      h ? this._displayItemDetails(this._articleIdToOpen) : console.error(new Error("ShopWindow: Cannot find article: " + this._articleIdToOpen));
    }
  }
};
o.prototype.onShopOpenCategoryError = function (e) {
  if (this._isSameCategory(e.categoryId)) {
    var t = this._views[I];
    t.setSpinnerVisible(!1);
    t.setLoadingAdditionalContent(!1);
    this._showErrorPopup();
  }
};
o.prototype.onShopOpenCategorySuccess = function (e) {
  this._loadCategoryWithMessage(e);
};
o.prototype.resize = function () {
  if (!this._isOpened) {
    return void (this._needsResize = !0);
  }
  var e = this._views;
  for (var t in e) {
    e[t].resize(this.viewContainer);
  }
  this._needsResize = !1;
};
o.prototype._showErrorPopup = function (e) {
  var t = this;
  m.getWindow("confirm").update({
    title: l("ui.common.error"),
    message: l("ui.popup.accessDenied.serviceUnavailable") + " " + l("tablet.common.askRetry"),
    cb: function (i) {
      return i ? t.lastAction ? void t.lastAction() : void t._reinitializeShop() : void (e && n());
    }
  });
  m.openDialog(["confirm"]);
};
o.prototype._isSameCategory = function (e) {
  return e === this.openedCategory;
};
o.prototype._saveAndExecuteAction = function (e) {
  this.lastAction = e;
  e();
};
o.prototype.updateArticlesPrices = function () {
  var e = this.articlesMap;
  for (var t in e) {
    w.enrichWithSoftPrice(e[t]);
  }
  var i = this._views;
  for (var n in i) {
    i[n].updateArticlesPrices(this.articlesMap);
  }
};
o.prototype._reinitializeShop = function () {
  function e(e) {
    console.error(e);
    t._isInitializing = !1;
    t.viewContainer.delClassNames("spinner");
    t.isOpen() && t._showErrorPopup(!0);
  }
  var t = this;
  this._saveAndExecuteAction(function () {
    t._isInitializing = !0;
    t.viewContainer.addClassNames("spinner");
    w.getStoreInfos(function (t) {
      return t ? e(t) : void window.dofus.send("shopOpenRequest");
    });
  });
};
o.prototype.clearShop = function () {
  var e = this.activeTopTab;
  e && this._deactivateTopTab(e);
  this.closeCategory(this.openedCategory);
  this.clearCategories();
  this.requestTimestamp = 0;
  this.requestTimeout = null;
  this.lastAction = null;
  this._isInitializing = !1;
  this._articleIdToOpen = 0;
  this.wallet.goultinesBtn.disable();
  this._setView(A);
  this._currentViewName = null;
  this._previousViewName = null;
  var t = this._views;
  for (var i in t) {
    t[i].clear();
  }
};
o.prototype.setCategories = function (e) {
  this.clearCategories();
  this._addTopCategories(e);
};
o.prototype._createCategoryLabel = function (e) {
  var t = new c("div", {
    className: "textContainer"
  });
  return t.createChild("div", {
    className: "text",
    text: e.name.toUpperCase()
  }), t;
};
o.prototype._addTopCategories = function (e) {
  function t(e) {
    a._activateSubCategory(e);
  }
  function i(e) {
    a._deactivateSubCategory(e);
  }
  function n() {
    a._activateTopTab(this);
  }
  function o(e) {
    if (e.id !== O) {
      a.categoriesName[e.id] = e.name;
      var o = a.topTabsList.createChild("div", {
          name: e.id,
          className: "tab"
        }),
        s = o.createChild("div", {
          className: "icon"
        });
      if (s.addClassNames("icon-" + e.id), p(o), o.on("tap", n.bind(o)), b.addTooltip(o, e.name), e.child.length) {
        var r = o.sublist = new d();
        r.on("selected", t);
        r.on("deselected", i);
        a._addSubCategories(r, e.child);
      }
    }
  }
  var a = this;
  o(R);
  for (var s = 0; s < e.length; s++) {
    o(e[s]);
  }
};
o.prototype._addSubCategories = function (e, t) {
  for (var i = 0; i < t.length; i++) {
    var n = t[i];
    this.categoriesName[n.id] = n.name;
    var o = this._createCategoryLabel(n),
      a = e.addItem({
        id: n.id,
        element: o
      });
    a.addClassNames("tab");
  }
};
o.prototype.clearCategories = function () {
  this.topTabsList.clearContent();
  this.activeTopTab = null;
  this.selectedTopTab = null;
  this.selectedSubTab = null;
  this.openedCategory = null;
  this.categoriesName = {};
  this.categoriesData = {};
  this.articlesMap = {};
};
o.prototype._loadCategoryWithMessage = function (e) {
  var t = e.categoryId,
    i = this.categoriesData[t];
  if (i) {
    if (i.page !== e.page - 1) {
      return;
    }
    i.page = e.page;
    i.articles = i.articles.concat(e.articles);
  } else {
    this.categoriesData[t] = e;
  }
  this._isSameCategory(t) && this._loadCategory(e);
};
o.prototype.validateArticles = function (e) {
  for (var t = w.validateArticles(e), i = 0; i < t.length; i++) {
    var n = t[i];
    this.articlesMap[n.id] = n;
  }
  return t;
};
o.prototype._loadCategory = function (e) {
  var t = this._views[I];
  if (0 === e.totalArticles) {
    return void t.showNoResult(this.categoriesName[this.openedCategory], ~~e.categoryId);
  }
  var i = this.validateArticles(e.articles),
    n = Math.ceil(e.totalArticles / this.nbArticlesVisible),
    o = e.page === n;
  t.addArticles(i, o);
  window.gui.scenarioManager.checkCondition(window.gui.scenarioManager.conditionTypeEnum.SHOP_LOADED);
};
o.prototype.getFirstArticle = function () {
  var e = this._views[I],
    t = e.getLines();
  return t.length > 0 ? t[0].getChildren()[0] : null;
};
o.prototype._refreshCurrentTab = function () {
  if (this.selectedTopTab) {
    if (this.setSubCategoryRowVisible(!1), this._views[S] && (this.reactivateCategories(), this._views[I].restoreScrollPosition()), this.selectedTopTab === E && this._views[A]) {
      return this._views[A].clear(), this.topTabsList.clearContent(), void this._reinitializeShop();
    }
    var e = this.topTabsList.getChild(this.selectedTopTab);
    this.closeCategory(this.selectedTopTab);
    this.categoriesData[this.selectedTopTab] = null;
    this._deactivateTopTab(e);
    this._activateTopTab(e);
  }
};
o.prototype._openCategory = function (e) {
  this._currentViewName !== I && this._setView(I);
  var t = this,
    i = this._views[I],
    n = P[e];
  if (i.setConstraints(n) && i.resize(this.viewContainer), i.setClassNames(["itemsListView", "_" + e]), !this._isSameCategory(e)) {
    (this.openedCategory || 0 === this.openedCategory) && this.closeCategory(this.openedCategory);
    B[e] && this.showSubCategoryRow(!1);
    this.openedCategory = e;
    var o = this.categoriesData[this.openedCategory];
    o ? this._loadCategory(o) : this._saveAndExecuteAction(function () {
      i.setSpinnerVisible(!0);
      t._requestPageOfCategory(e, 1);
    });
  }
};
o.prototype.loadAdditionalContent = function () {
  if (this.openedCategory) {
    this._views[I].setLoadingAdditionalContent(!0);
    var e = this.categoriesData[this.openedCategory];
    return e ? void this._requestPageOfCategory(this.openedCategory, e.page + 1) : console.error(new Error("Trying to load additional content of a non-opened category."));
  }
};
o.prototype._requestPageOfCategory = function (e, t) {
  var i = {
      categoryId: e,
      page: t,
      size: this.nbArticlesVisible
    },
    n = function () {
      window.dofus.send("shopOpenCategoryRequest", i);
    };
  window.clearTimeout(this.requestTimeout);
  var o = Date.now(),
    a = o - this.requestTimestamp;
  a > C ? n() : this.requestTimeout = window.setTimeout(n, C - a);
  this.requestTimestamp = o;
};
o.prototype.closeCategory = function (e) {
  this.openedCategory && this._isSameCategory(e) && (this._views[I].clearItems(), this.openedCategory = null);
};
t !== E && (e.sublist && (this.setSubCategoryRowVisible(!1), e.sublist.deselectAll()), this._isSameCategory(t) && this.closeCategory(t));
e.delClassNames("on");
this.activeTopTab = null;
H = !1;
this.activeTopTab && this._deactivateTopTab(this.activeTopTab);
H = !0;
t.sublist.selectItem(this.selectedSubTab);
k = !0;
t.createChild("div", {
  className: ["separator", "first"]
});
this.subCategoryRowSeparator = t.createChild("div", {
  className: ["separator", "second"]
});
R.name = l("tablet.shop.homepage.name");
this.topTabsList = t.createChild("div", {
  className: "topTabsList"
});
this._closeButton = t.appendChild(new h({
  className: "closeButton",
  scaleOnPress: !0
}));
this._closeButton.on("tap", function () {
  n();
});
this.wallet = t.appendChild(new f({
  emitTap: !0,
  showBonusPack: !0
}));
this.wallet.on("moreGoultinesTap", function () {
  var t = e.topTabsList.getChild(D.id);
  t && e._activateTopTab(t);
});
this.wallet.on("bonusPackTap", function () {
  var t = e.topTabsList.getChild(x);
  t && e._activateTopTab(t);
});
this.subCategoryRow = this.createChild("div", {
  className: "subCategoryRow"
});
this.viewContainer = this.createChild("div", {
  className: "row2"
});
this.setSubCategoryRowVisible(!1);
this._views[A] = new _();
this._views[I] = new v();
this._views[S] = new y();
this.deactivateAllCategories();
this._previousViewName = this._currentViewName;
this._currentViewName = e;
s.on("shopOpenError", function (e) {
  d.onShopOpenError(e);
});
s.on("shopOpenSuccess", function (e) {
  d.onShopOpenSuccess(e);
});
s.on("shopOpenCategoryError", function (e) {
  d.onShopOpenCategoryError(e);
});
s.on("shopOpenCategorySuccess", function (e) {
  d.onShopOpenCategorySuccess(e);
});
s.on("AccessoryPreviewErrorMessage", function (e) {
  console.error(new Error("Accessory preview failed with: " + e.error + " for article " + c.getArticleId()));
  c.setLook(null);
});
s.on("AccessoryPreviewMessage", function (e) {
  c.setLook(e.look);
});
window.gui.on("resize", function () {
  d.resize();
});
m.getWindow("shopConfirm").on("closed", function (e) {
  e && e.endPurchase && d._refreshCurrentTab();
});
console.error(new Error("Accessory preview failed with: " + e.error + " for article " + c.getArticleId()));
c.setLook(null);
h.on("displayItemDetails", this._displayItemDetails.bind(this));
h.on("purchaseIAP", e);
h.on("purchaseOnAnkama", t);
h.on("showSubCategoryRow", i);
h.on("hideSubCategoryRow", o);
h.on("openCategory", function (e) {
  d._openCategory(e);
});
l.on("loadAdditionalContent", function () {
  d._saveAndExecuteAction(function () {
    d.loadAdditionalContent();
  });
});
l.on("nbArticlesVisibleUpdated", function (e) {
  d.nbArticlesVisible = e;
});
c.on("goToPreviousView", function () {
  d.goToPreviousView();
});
c.on("requestPrevisualization", function (e) {
  s.sendMessage("AccessoryPreviewRequestMessage", {
    genericId: e
  });
});
g.on("canNotComputeSoftPrices", function () {
  d.isOpen() && d.updateArticlesPrices();
});
g.on("computedSoftPricesChange", function () {
  d.isOpen() && d.updateArticlesPrices();
});
a();
window.gui.scenarioManager.on("stepChanged", function () {
  a();
});
this.setSubCategoryRowVisible(n);
n && this.subCategoryRow.appendChild(e);
this._isInitializing = !1;
this.viewContainer.delClassNames("spinner");
this.isOpen() && this._showErrorPopup(!0);
this.wallet.goultinesBtn.enable();
this.wallet.bonusPackBtn.enable();
t.setSpinnerVisible(!1);
t.setLoadingAdditionalContent(!1);
this._showErrorPopup();
m.getWindow("confirm").update({
  title: l("ui.common.error"),
  message: l("ui.popup.accessDenied.serviceUnavailable") + " " + l("tablet.common.askRetry"),
  cb: function (i) {
    return i ? t.lastAction ? void t.lastAction() : void t._reinitializeShop() : void (e && n());
  }
});
m.openDialog(["confirm"]);
this.lastAction = e;
e();
console.error(e);
t._isInitializing = !1;
t.viewContainer.delClassNames("spinner");
t.isOpen() && t._showErrorPopup(!0);
t._isInitializing = !0;
t.viewContainer.addClassNames("spinner");
w.getStoreInfos(function (t) {
  return t ? e(t) : void window.dofus.send("shopOpenRequest");
});
e && this._deactivateTopTab(e);
this.closeCategory(this.openedCategory);
this.clearCategories();
this.requestTimestamp = 0;
this.requestTimeout = null;
this.lastAction = null;
this._isInitializing = !1;
this._articleIdToOpen = 0;
this.wallet.goultinesBtn.disable();
this._setView(A);
this._currentViewName = null;
this._previousViewName = null;
this.clearCategories();
this._addTopCategories(e);
r.on("selected", t);
r.on("deselected", i);
a._addSubCategories(r, e.child);
this.topTabsList.clearContent();
this.activeTopTab = null;
this.selectedTopTab = null;
this.selectedSubTab = null;
this.openedCategory = null;
this.categoriesName = {};
this.categoriesData = {};
this.articlesMap = {};
i.page = e.page;
i.articles = i.articles.concat(e.articles);
t.addArticles(i, o);
window.gui.scenarioManager.checkCondition(window.gui.scenarioManager.conditionTypeEnum.SHOP_LOADED);
this.closeCategory(this.selectedTopTab);
this.categoriesData[this.selectedTopTab] = null;
this._deactivateTopTab(e);
this._activateTopTab(e);
(this.openedCategory || 0 === this.openedCategory) && this.closeCategory(this.openedCategory);
B[e] && this.showSubCategoryRow(!1);
this.openedCategory = e;
i.setSpinnerVisible(!0);
t._requestPageOfCategory(e, 1);
a > C ? n() : this.requestTimeout = window.setTimeout(n, C - a);
this.requestTimestamp = o;
s.call(this, "div", {
  className: "homepageView"
});
this.highlightArticleBox = null;
this.highlightCarouselArticle = null;
this._createDom();
a(n, s);
e.exports = n;
n.prototype.clear = function () {
  this.highlightArticleBox && (this.highlightArticleBox.clear(), this.highlightArticleBox = null);
  for (var e = this.gondolaHead.getChildren(), t = 0; t < e.length; t++) {
    e[t].clear();
  }
  this.highlightCarouselArticle = null;
  this.highlightCarouselImage.clear();
  this.highlightCarouselImage.hide();
  this.highlightImage.clearContent();
  this.gondolaHead.clearContent();
};
n.prototype._createDom = function () {
  var e = this,
    t = this.createChild("div", {
      className: "highlights"
    });
  this.gondolaHead = this.createChild("div", {
    className: "gondolaHead"
  });
  var i = t.createChild("div", {
    className: "highlightCarousel"
  });
  this.highlightCarouselImage = i.appendChild(new d({
    onTap: function (t) {
      "ARTICLE" === t.type ? e.emit("displayItemDetails", t.id) : "CATEGORY" === t.type && e.emit("openCategory", t.id);
    }
  }));
  this.highlightCarouselImage.update();
  this.highlightImage = t.createChild("div", {
    className: "highlightImage"
  });
};
n.prototype.resize = function () {};
n.prototype.update = function (e) {
  function t(e) {
    var t = [];
    return e.forEach(function (e) {
      var i = e.image.length > 0 ? e.image[u].url : null;
      e.data && t.push({
        imageUrl: i,
        tapParam: {
          id: e.data.id,
          type: e.type
        }
      });
    }), t;
  }
  function i() {
    w.emit("purchaseIAP", this.articleId);
  }
  function n() {
    w.emit("purchaseOnAnkama", this.articleId, l.GOULTINE);
  }
  function a() {
    w.emit("purchaseOnAnkama", this.articleId, l.KAMA);
  }
  function s() {
    w.emit("displayItemDetails", this.articleId);
  }
  function d(e, t, o) {
    o = o || {};
    o.canTapImage = !0;
    o.showButtons = void 0 === o.showButtons || o.showButtons;
    o.showTitle = void 0 === o.showTitle || o.showTitle;
    var l = e.showCountDown;
    o.promoType = l ? "banner" : o.promoType;
    var c = new r(e, t, o);
    return c.on("tapIAPButton", i), c.on("tapHardButton", n), c.on("tapSoftButton", a), c.on("tapItemImage", s), c;
  }
  if (this.emit("hideSubCategoryRow"), e) {
    this.clear();
    var m = this.highlightCarouselImage,
      f = e.highlightCarouselArticles;
    m.toggleDisplay(f);
    f && (m.update(), this.highlightCarouselArticles = e.highlightCarouselArticles, m.setPages(t(e.highlightCarouselArticles)));
    var v,
      y,
      w = this,
      b = e.highlightImageArticle;
    if (b) {
      this.highlightImage.show();
      var M = c(this.highlightImage.rootElement);
      y = o(M.width, M.height);
      this.highlightArticleBox = d(b, y, {
        promoType: "banner"
      });
      this.highlightImage.appendChild(this.highlightArticleBox);
    } else {
      this.highlightImage.hide();
    }
    var T = e.gondolaHeadArticles;
    if (T) {
      var C = c(this.gondolaHead.rootElement),
        I = ~~C.width + 2 * h,
        A = ~~C.height - p,
        S = ~~(A * _) + 2 * h,
        E = Math.min(T.length, ~~(I / S)),
        N = I - S * E,
        x = ~~(N / E),
        L = S + x;
      S = L / A > g ? A * g - 2 * h : L - 2 * h;
      y = o(S, A);
      for (var O = 0; O < E; O++) {
        v = d(T[O], y, {
          promoType: "corner"
        });
        this.gondolaHead.appendChild(v);
      }
    }
  }
};
n.prototype.updateArticlesPrices = function (e) {
  var t = this.gondolaHead.getChildren();
  this.highlightArticleBox && t.push(this.highlightArticleBox);
  for (var i = 0; i < t.length; i++) {
    var n = t[i],
      o = n.articleId;
    if (o) {
      var a = e[o.toString()];
      a ? n.updatePrice(a) : console.error(new Error("Article " + o + " missing for an ArticleBox"));
    }
  }
};
this.highlightCarouselArticle = null;
this.highlightCarouselImage.clear();
this.highlightCarouselImage.hide();
this.highlightImage.clearContent();
this.gondolaHead.clearContent();
this.highlightCarouselImage = i.appendChild(new d({
  onTap: function (t) {
    "ARTICLE" === t.type ? e.emit("displayItemDetails", t.id) : "CATEGORY" === t.type && e.emit("openCategory", t.id);
  }
}));
this.highlightCarouselImage.update();
this.highlightImage = t.createChild("div", {
  className: "highlightImage"
});
o = o || {};
o.canTapImage = !0;
o.showButtons = void 0 === o.showButtons || o.showButtons;
o.showTitle = void 0 === o.showTitle || o.showTitle;
m.toggleDisplay(f);
f && (m.update(), this.highlightCarouselArticles = e.highlightCarouselArticles, m.setPages(t(e.highlightCarouselArticles)));
y = o(M.width, M.height);
this.highlightArticleBox = d(b, y, {
  promoType: "banner"
});
this.highlightImage.appendChild(this.highlightArticleBox);
S = L / A > g ? A * g - 2 * h : L - 2 * h;
y = o(S, A);
v = d(T[O], y, {
  promoType: "corner"
});
this.gondolaHead.appendChild(v);
e = e || {};
s.call(this, "div", e);
this.addClassNames("Carousel");
this._bannerTitle = Boolean(e.bannerTitle);
this._newsLoadedTime = 0;
this._currentPage = 0;
this._transitioning = !1;
this._setTimoutId = null;
this._pageCount = 0;
this._onTap = e.onTap;
this._carouselPages = [];
this._banners = [];
this._tapParams = [];
this._bannerTitles = [];
this._date = [];
this._dots = [];
this._carouselWrapper = this.createChild("div", {
  className: "carouselWrapper"
});
r.cssTransition(this._carouselWrapper, f + "ms");
this._dotsWrapper = this.createChild("div", {
  className: "dotsWrapper",
  hidden: !0
});
this._resetTransform();
this._updateDots();
this._rightArrow = this.appendChild(new l({
  className: "rightArrow",
  hidden: !0
}, function () {
  t._transitioning || t._scrollToNextElement();
}));
this._leftArrow = this.appendChild(new l({
  className: "leftArrow",
  hidden: !0
}, function () {
  t._transitioning || t._scrollToPrevElement();
}));
this._init();
this.isTapping = !1;
this._carouselWrapper.allowDomEvents();
this._carouselWrapper.on("dom.touchstart", function (e) {
  if (!(t._pageCount <= 1)) {
    var n = p(e);
    i = n.x;
    t.isTapping = !0;
  }
});
this._carouselWrapper.on("dom.touchmove", function (e) {
  if (!(t._pageCount <= 1) && t.isTapping) {
    var n = p(e),
      o = n.x - i;
    o > _ && (t.isTapping = !1, t._scrollToPrevElement());
    o < -_ && (t.isTapping = !1, t._scrollToNextElement());
  }
});
i = n.x;
t.isTapping = !0;
o > _ && (t.isTapping = !1, t._scrollToPrevElement());
o < -_ && (t.isTapping = !1, t._scrollToNextElement());
a(n, s);
e.exports = n;
n.prototype._init = function () {
  this._carouselPages[0] = this._carouselWrapper.createChild("div", {
    className: ["carouselPage", "page0"]
  });
  this._banners[0] = this._carouselPages[0].createChild("div", {
    className: ["banner", "spinner"]
  });
  this._resetTransform();
};
n.prototype.setEndDate = function (e) {
  this._endDate = e;
};
n.prototype.setPages = function (e) {
  var t = h(this.rootElement),
    i = t.width,
    n = this._bannerTitle ? i / g : t.height;
  this._carouselWrapper.clearContent();
  this._dotsWrapper.clearContent();
  this._newsLoadedTime = Date.now();
  this._pageCount = e.length;
  for (var o = this, a = 0; a < e.length; a++) {
    this._carouselPages[a] = this._carouselWrapper.createChild("div", {
      className: ["carouselPage", "page" + a],
      hidden: !0
    });
    this._banners[a] = this._carouselPages[a].createChild("div", {
      className: ["banner", "spinner"]
    });
    this._banners[a].setStyles({
      width: i + "px",
      height: n + "px"
    });
    c(this._banners[a]);
    this._bannerTitle && (this._bannerTitles[a] = this._carouselPages[a].createChild("div", {
      className: "bannerTitle"
    }), c(this._bannerTitles[a]));
    this._date[a] = this._carouselPages[a].createChild("div", {
      className: "date"
    });
    this._dots[a] = this._dotsWrapper.createChild("div", {
      className: "dot"
    });
  }
  for (a = 0; a < e.length; a++) {
    this._dots[a].show();
    this._carouselPages[a].show();
    var s = e[a],
      r = s.imageUrl;
    this._banners[a].delClassNames(["spinner", "noNewsFallback"]);
    r ? this._banners[a].setStyle("backgroundImage", d(r)) : s.className && this._banners[a].addClassNames(s.className);
    this._date[a].setText(s.date);
    this._date[a].show();
    this._tapParams[a] = s.tapParam;
    this._bannerTitle && (this._bannerTitles[a].setText(s.name), this._bannerTitles[a].on("tap", function () {
      o.isTapping && o._onTap(o._tapParams[o._currentPage]);
    }));
    this._banners[a].on("tap", function () {
      o.isTapping && o._onTap(o._tapParams[o._currentPage]);
    });
  }
  var l = this._pageCount > 1;
  this._rightArrow.toggleDisplay(l);
  this._leftArrow.toggleDisplay(l);
  this._dotsWrapper.toggleDisplay(l);
  l && this._registerNextPagesChange();
  this._resetTransform();
  this._updateDots();
};
n.prototype.startCarousel = function () {
  if (this._endDate) {
    var e = this;
    this._interval && clearInterval(this._interval);
    this._interval = setInterval(function () {
      o(e);
    }, 1e3);
  }
};
n.prototype.update = function () {
  this._loading();
};
n.prototype._loading = function () {
  var e = h(this.rootElement),
    t = e.width,
    i = this._bannerTitle ? t / g : e.height;
  this._clearTimeout();
  this._rightArrow.hide();
  this._leftArrow.hide();
  this._dotsWrapper.hide();
  this._newsLoadedTime = 0;
  var n = this._banners[this._currentPage];
  n ? (n.addClassNames("spinner"), n.setStyles({
    width: t + "px",
    height: i + "px"
  })) : console.error(new Error("Cannot find the current banner for page " + this._currentPage));
  this._pageCount = 0;
};
n.prototype._scrollToPrevElement = function () {
  this._scrollElement(-1);
};
n.prototype._scrollToNextElement = function () {
  this._scrollElement(1);
};
n.prototype._scrollElement = function (e) {
  var t = h(this.rootElement).width;
  if (e === -1 || 1 === e) {
    var i = this;
    if (!this._transitioning) {
      this._clearTimeout();
      this._currentPage = (this._currentPage + this._pageCount + e) % this._pageCount;
      var n = e === -1 ? 0 : 2 * t;
      this._carouselPages[this._currentPage].setStyle("left", n + "px");
      r.forceReflow(this._carouselWrapper);
      r.cssTransform(this._carouselWrapper, "translate(" + (1 === e ? 2 * -t : 0) + "px, 0px)");
      this._updateDots();
      this._transitioning = !0;
      setTimeout(function () {
        i._resetTransform();
        i._transitioning = !1;
        i._registerNextPagesChange();
      }, f + 200);
    }
  }
};
n.prototype._updateDots = function () {
  for (var e = 0; e < this._pageCount; e++) {
    this._dots[e].toggleClassName("selected", this._currentPage === e);
  }
};
n.prototype._clearTimeout = function () {
  null !== this._setTimoutId && (clearTimeout(this._setTimoutId), this._setTimoutId = null);
};
n.prototype.clear = function () {
  this._clearTimeout();
  for (var e = 0; e < this._pageCount; e++) {
    this._banners[e].setStyle("backgroundImage", "initial");
  }
  this._newsLoadedTime = 0;
  this._leftArrow.hide();
  this._rightArrow.hide();
};
n.prototype._registerNextPagesChange = function () {
  var e = this;
  null === this._setTimoutId && (this._transitioning || 0 !== e._newsLoadedTime && (this._setTimoutId = setTimeout(function () {
    e._setTimoutId = null;
    0 !== e._newsLoadedTime && (e._scrollToNextElement(), e._registerNextPagesChange());
  }, m)));
};
n.prototype._resetTransform = function () {
  var e = h(this.rootElement).width;
  r.cssTransition(this._carouselWrapper, "0ms");
  r.forceReflow(this._carouselWrapper);
  r.cssTransform(this._carouselWrapper, "translate(-" + e + "px, 0px)");
  r.forceReflow(this._carouselWrapper);
  r.cssTransition(this._carouselWrapper, f + "ms");
  for (var t = 0; t < this._pageCount; t++) {
    var i = t === this._currentPage - 1 || t - this._pageCount === this._currentPage - 1,
      n = t === this._currentPage,
      o = t === this._currentPage + 1 || t + this._pageCount === this._currentPage + 1,
      a = i || n || o;
    if (a) {
      var s = 2 * e;
      n ? s = 0 | e : i && (s = 0);
      this._carouselPages[t].setStyle("left", s + "px");
      this._carouselPages[t].show();
    } else {
      this._carouselPages[t].hide();
    }
  }
};
this._carouselPages[0] = this._carouselWrapper.createChild("div", {
  className: ["carouselPage", "page0"]
});
this._banners[0] = this._carouselPages[0].createChild("div", {
  className: ["banner", "spinner"]
});
this._resetTransform();
this._carouselWrapper.clearContent();
this._dotsWrapper.clearContent();
this._newsLoadedTime = Date.now();
this._pageCount = e.length;
this._carouselPages[a] = this._carouselWrapper.createChild("div", {
  className: ["carouselPage", "page" + a],
  hidden: !0
});
this._banners[a] = this._carouselPages[a].createChild("div", {
  className: ["banner", "spinner"]
});
this._banners[a].setStyles({
  width: i + "px",
  height: n + "px"
});
c(this._banners[a]);
this._bannerTitle && (this._bannerTitles[a] = this._carouselPages[a].createChild("div", {
  className: "bannerTitle"
}), c(this._bannerTitles[a]));
this._date[a] = this._carouselPages[a].createChild("div", {
  className: "date"
});
this._dots[a] = this._dotsWrapper.createChild("div", {
  className: "dot"
});
this._dots[a].show();
this._carouselPages[a].show();
this._banners[a].delClassNames(["spinner", "noNewsFallback"]);
r ? this._banners[a].setStyle("backgroundImage", d(r)) : s.className && this._banners[a].addClassNames(s.className);
this._date[a].setText(s.date);
this._date[a].show();
this._tapParams[a] = s.tapParam;
this._bannerTitle && (this._bannerTitles[a].setText(s.name), this._bannerTitles[a].on("tap", function () {
  o.isTapping && o._onTap(o._tapParams[o._currentPage]);
}));
this._banners[a].on("tap", function () {
  o.isTapping && o._onTap(o._tapParams[o._currentPage]);
});
this._rightArrow.toggleDisplay(l);
this._leftArrow.toggleDisplay(l);
this._dotsWrapper.toggleDisplay(l);
l && this._registerNextPagesChange();
this._resetTransform();
this._updateDots();
this._interval && clearInterval(this._interval);
this._interval = setInterval(function () {
  o(e);
}, 1e3);
this._clearTimeout();
this._rightArrow.hide();
this._leftArrow.hide();
this._dotsWrapper.hide();
this._newsLoadedTime = 0;
n ? (n.addClassNames("spinner"), n.setStyles({
  width: t + "px",
  height: i + "px"
})) : console.error(new Error("Cannot find the current banner for page " + this._currentPage));
this._pageCount = 0;
this._clearTimeout();
this._currentPage = (this._currentPage + this._pageCount + e) % this._pageCount;
this._carouselPages[this._currentPage].setStyle("left", n + "px");
r.forceReflow(this._carouselWrapper);
r.cssTransform(this._carouselWrapper, "translate(" + (1 === e ? 2 * -t : 0) + "px, 0px)");
this._updateDots();
this._transitioning = !0;
setTimeout(function () {
  i._resetTransform();
  i._transitioning = !1;
  i._registerNextPagesChange();
}, f + 200);
i._resetTransform();
i._transitioning = !1;
i._registerNextPagesChange();
this._newsLoadedTime = 0;
this._leftArrow.hide();
this._rightArrow.hide();
e._setTimoutId = null;
0 !== e._newsLoadedTime && (e._scrollToNextElement(), e._registerNextPagesChange());
r.cssTransition(this._carouselWrapper, "0ms");
r.forceReflow(this._carouselWrapper);
r.cssTransform(this._carouselWrapper, "translate(-" + e + "px, 0px)");
r.forceReflow(this._carouselWrapper);
r.cssTransition(this._carouselWrapper, f + "ms");
n ? s = 0 | e : i && (s = 0);
this._carouselPages[t].setStyle("left", s + "px");
this._carouselPages[t].show();
s.call(this, "div", {
  className: "itemsListView"
});
this.articlesPerLine = u;
this.articlesPerColumn = h;
this._isAdditionalContentLoading = !1;
this._boxHeight = v;
this._boxWidth = _;
this._scrollMargin = 0;
this._scrollPosition = null;
this.constraints = {};
this.setConstraints(A);
this._createDom();
o(n, s);
e.exports = n;
n.prototype.clear = function () {
  for (var e = this._getArticleBoxes(), t = 0; t < e.length; t++) {
    e[t].clear();
  }
  this._scrollPosition = null;
};
n.prototype._createDom = function () {
  var e = this;
  this._itemsScroll = this.appendChild(new r({
    className: "scroll"
  }, {
    isHorizontal: !0
  }));
  this._itemsList = this._itemsScroll.content.createChild("div", {
    className: "itemsList"
  });
  for (var t = 0; t < this.articlesPerColumn; t++) {
    this._itemsList.createChild("div", {
      className: "itemsLine"
    });
  }
  this._loadContent = this._itemsScroll.content.createChild("div", {
    className: "loadContent"
  });
  this._loadContent.hide();
  this._noResultMessage = this._itemsScroll.content.createChild("div", {
    className: "rightLabel"
  });
  this._noResultMessageText = this._noResultMessage.createChild("div", {
    className: "text"
  });
  this._noResultMessage.hide();
  this._itemsScroll.on("scrollEnd", function () {
    !e._isAdditionalContentLoading && e._loadContent.isVisible() && Math.abs(this.iScroll.maxScrollX - this.iScroll.x) < w && e.emit("loadAdditionalContent");
  });
};
n.prototype.update = function () {};
n.prototype.resize = function (e) {
  if (this._computeMargins(e), !this.constraints.useBonusPackDisplay) {
    var t = this._getItemsMap(),
      i = this.getArticleBoxSize();
    for (var n in t) {
      t[n].resize(i);
    }
    this._itemsScroll.refresh();
    this.emit("nbArticlesVisibleUpdated", (this.articlesPerLine + 1) * this.articlesPerColumn);
  }
};
n.prototype.saveScrollPosition = function () {
  this._scrollPosition = this._itemsScroll.getScrollPosition();
};
n.prototype.restoreScrollPosition = function () {
  var e = this._scrollPosition;
  e && this._itemsScroll.scrollTo(e.x, e.y);
  this._scrollPosition = null;
};
n.prototype.getArticleBoxSize = function () {
  return {
    boxWidth: this._boxWidth,
    boxHeight: this._boxHeight
  };
};
n.prototype.setConstraints = function (e) {
  e = e || A;
  var t = !1;
  for (var i in A) {
    var n = e.hasOwnProperty(i) ? e[i] : A[i];
    this.constraints[i] !== e[i] && (this.constraints[i] = n, t = !0);
  }
  return t;
};
n.prototype.addArticles = function (e, t) {
  this.setSpinnerVisible(!1);
  this.setLoadingAdditionalContent(!1);
  this._loadContent.toggleDisplay(!t);
  this._addArticles(e);
};
n.prototype.showNoResult = function (e, t) {
  this.clearItems();
  var i;
  i = t === I ? a("tablet.shop.category.emote.noResults") : e ? a("ui.search.noResultFor", e) : a("ui.search.noResult");
  this._noResultMessageText.setText(i);
  this._noResultMessage.show();
};
n.prototype.getLines = function () {
  return this._itemsList.getChildren();
};
n.prototype._addArticles = function (e) {
  function t() {
    u.emit("purchaseIAP", this.articleId);
  }
  function i() {
    u.emit("purchaseOnAnkama", this.articleId, c.GOULTINE);
  }
  function n() {
    u.emit("purchaseOnAnkama", this.articleId, c.KAMA);
  }
  function o() {
    u.emit("displayItemDetails", this.articleId);
  }
  for (var a = 0, s = this._itemsList.getChildren(), r = s.length, u = this, h = 0; h < e.length; h++) {
    var p = this.constraints.useBonusPackDisplay && 0 === h,
      m = {
        showButtons: !0,
        showTitle: !0,
        promoType: this.constraints.promoType,
        showDescription: this.constraints.showArticleDescription,
        canTapImage: this.constraints.canTapImage,
        showReferences: p
      },
      f = e[h].showCountDown;
    m.promoType = f ? "banner" : m.promoType;
    var _ = this.getArticleBoxSize();
    this.constraints.useBonusPackDisplay && (_.boxWidth = 0 === h ? T : b, _.boxHeight = M);
    var v = new l(e[h], _, m);
    v.on("tapIAPButton", t);
    v.on("tapHardButton", i);
    v.on("tapSoftButton", n);
    v.on("tapItemImage", o);
    s[a % r].appendChild(v);
    a++;
  }
  this._itemsList.setStyle("margin-left", "0");
  this._itemsList.setStyle("width", "unset");
  var y = this._itemsList.getChildren();
  if (y.length > 0 && y[0].setStyle("transform", "unset"), this._itemsScroll.refresh(), this.constraints.useBonusPackDisplay && y.length && e.length && this.rootElement) {
    var w = this._boxHeight / (M + C);
    y[0].setStyle("transform", "scale(" + w + ")");
    var I = d(this.rootElement),
      A = T + g;
    A += (b + 2 * g) * (e.length - 1);
    A *= w;
    A += C;
    this._itemsList.setStyle("width", A + "px");
    var S = Math.max(0, (I.width - A) / 2);
    this._itemsList.setStyle("margin-left", S + "px");
    this._itemsScroll.refresh(!0);
  }
  "left" === this.constraints.position && this._itemsList.setStyle("margin-left", 0);
};
n.prototype.setLoadingAdditionalContent = function (e) {
  this._isAdditionalContentLoading = e;
  e ? (this._loadContent.addClassNames("spinner"), this._loadContent.delClassNames("showArrow")) : (this._loadContent.delClassNames("spinner"), this._loadContent.addClassNames("showArrow"));
};
n.prototype.setSpinnerVisible = function (e) {
  e ? this._itemsScroll.addClassNames("spinner") : this._itemsScroll.delClassNames("spinner");
};
n.prototype.clearItems = function () {
  this.setSpinnerVisible(!1);
  this.setLoadingAdditionalContent(!1);
  for (var e = this._itemsList.getChildren(), t = 0; t < e.length; t++) {
    e[t].clearContent();
  }
  this._loadContent.hide();
  this._noResultMessage.hide();
  this._itemsScroll.refresh();
  this._itemsScroll.goToTop();
};
n.prototype._setNumberOfLines = function (e) {
  if (e !== this.articlesPerColumn) {
    this.articlesPerColumn = e;
    var t,
      i = [],
      n = this._itemsList.getChildren(),
      o = n.length - e;
    for (t = 0; t < n.length; t++) {
      for (var a = n[t], s = a.getChildren(), r = 0; r < s.length; r++) {
        i.push(a.removeChild(s[r]));
      }
      o > 0 && (a.destroy(), o--);
    }
    if (n.length < e) {
      var l = e - n.length;
      for (t = 0; t < l; t++) {
        this._itemsList.createChild("div", {
          className: "itemsLine"
        });
      }
    }
    if (i.length) {
      for (n = this._itemsList.getChildren(), t = 0; t < i.length; t++) {
        n[t % e].appendChild(i[t]);
      }
    }
  }
};
n.prototype._computeMargins = function (e) {
  var t = this.constraints,
    i = d(e.rootElement),
    n = i.width - 2 * m,
    o = i.height - (2 * m + p),
    a = t.lines || Math.max(h, ~~(o / y)),
    s = o - y * a,
    r = ~~(s / a);
  if (this._boxHeight = v + r, t.columns) {
    var l = n - (_ + 2 * g) * t.columns,
      c = ~~(l / t.columns);
    this._boxWidth = _ + c;
  } else {
    this._boxWidth = _ + r;
  }
  var w = this._boxHeight + f,
    b = this._boxWidth + 2 * g;
  this.articlesPerLine = t.columns || Math.max(u, ~~(n / b));
  s = o - w * a;
  s > 1 && (this._scrollMargin = ~~(.5 * s), this._itemsScroll.setStyles({
    "margin-top": this._scrollMargin + "px",
    "margin-bottom": this._scrollMargin + "px"
  }));
  this._setNumberOfLines(a);
  this._itemsScroll.refresh();
};
n.prototype._getArticleBoxes = function () {
  for (var e = [], t = this._itemsList.getChildren(), i = 0; i < t.length; i++) {
    e = e.concat(t[i].getChildren());
  }
  return e;
};
n.prototype.updateArticlesPrices = function (e) {
  for (var t = this._getArticleBoxes(), i = 0; i < t.length; i++) {
    var n = t[i],
      o = n.articleId;
    if (o) {
      var a = e[o];
      a ? n.updatePrice(a) : console.error(new Error("Article " + o + " missing for an ArticleBox"));
    }
  }
};
n.prototype._getItemsMap = function () {
  for (var e = {}, t = this._itemsList.getChildren(), i = 0; i < t.length; i++) {
    for (var n = t[i].getChildren(), o = 0; o < n.length; o++) {
      var a = n[o];
      e[a.getWuiName()] = a;
    }
  }
  return e;
};
this._itemsScroll = this.appendChild(new r({
  className: "scroll"
}, {
  isHorizontal: !0
}));
this._itemsList = this._itemsScroll.content.createChild("div", {
  className: "itemsList"
});
this._loadContent = this._itemsScroll.content.createChild("div", {
  className: "loadContent"
});
this._loadContent.hide();
this._noResultMessage = this._itemsScroll.content.createChild("div", {
  className: "rightLabel"
});
this._noResultMessageText = this._noResultMessage.createChild("div", {
  className: "text"
});
this._noResultMessage.hide();
this._itemsScroll.on("scrollEnd", function () {
  !e._isAdditionalContentLoading && e._loadContent.isVisible() && Math.abs(this.iScroll.maxScrollX - this.iScroll.x) < w && e.emit("loadAdditionalContent");
});
this._itemsScroll.refresh();
this.emit("nbArticlesVisibleUpdated", (this.articlesPerLine + 1) * this.articlesPerColumn);
e && this._itemsScroll.scrollTo(e.x, e.y);
this._scrollPosition = null;
this.setSpinnerVisible(!1);
this.setLoadingAdditionalContent(!1);
this._loadContent.toggleDisplay(!t);
this._addArticles(e);
i = t === I ? a("tablet.shop.category.emote.noResults") : e ? a("ui.search.noResultFor", e) : a("ui.search.noResult");
this._noResultMessageText.setText(i);
this._noResultMessage.show();
v.on("tapIAPButton", t);
v.on("tapHardButton", i);
v.on("tapSoftButton", n);
v.on("tapItemImage", o);
s[a % r].appendChild(v);
a++;
this._itemsList.setStyle("margin-left", "0");
this._itemsList.setStyle("width", "unset");
A += (b + 2 * g) * (e.length - 1);
A *= w;
A += C;
this._itemsList.setStyle("width", A + "px");
this._itemsList.setStyle("margin-left", S + "px");
this._itemsScroll.refresh(!0);
this._isAdditionalContentLoading = e;
e ? (this._loadContent.addClassNames("spinner"), this._loadContent.delClassNames("showArrow")) : (this._loadContent.delClassNames("spinner"), this._loadContent.addClassNames("showArrow"));
this.setSpinnerVisible(!1);
this.setLoadingAdditionalContent(!1);
this._loadContent.hide();
this._noResultMessage.hide();
this._itemsScroll.refresh();
this._itemsScroll.goToTop();
this.articlesPerLine = t.columns || Math.max(u, ~~(n / b));
s = o - w * a;
s > 1 && (this._scrollMargin = ~~(.5 * s), this._itemsScroll.setStyles({
  "margin-top": this._scrollMargin + "px",
  "margin-bottom": this._scrollMargin + "px"
}));
this._setNumberOfLines(a);
this._itemsScroll.refresh();
r.call(this, "div", {
  className: "itemDetailsView"
});
this._resetProperties();
this._createDom();
A[M.ACTION_LADDER_ID] = !0;
A[M.ACTION_ITEM_CHANGE_PETS_LIFE] = !0;
A[M.ACTION_ITEM_PETS_SHAPE] = !0;
A[M.ACTION_ITEM_PETS_EAT] = !0;
A[M.ACTION_PETS_LAST_MEAL] = !0;
A[M.ACTION_ID_LIVING_OBJECT_MOOD] = !0;
A[M.ACTION_ID_LIVING_OBJECT_SKIN] = !0;
A[M.ACTION_ID_LIVING_OBJECT_CATEGORY] = !0;
A[M.ACTION_ID_LIVING_OBJECT_LEVEL] = !0;
A[M.ACTION_CLIENT_OPEN_UI] = !0;
A[983] = !0;
A[984] = !0;
A[620] = !0;
a(n, r);
e.exports = n;
n.prototype._resetProperties = function () {
  this._classSymbolImage = null;
  this._firstItemOfSet = null;
  this._articleId = null;
  this.outfits = [];
  this.currentOutfitIndex = 0;
};
n.prototype.clear = function () {
  this._resetProperties();
  this._articleBox.clear();
  this._characterDisplay.release();
};
n.prototype._createDom = function () {
  function e() {
    n.emit("purchaseIAP", n._articleId);
  }
  function t() {
    n.emit("purchaseOnAnkama", n._articleId, y.GOULTINE);
  }
  function i() {
    n.emit("purchaseOnAnkama", n._articleId, y.KAMA);
  }
  var n = this,
    o = this._backToCategory = new r("div", {
      className: "goToPrevious"
    }),
    a = new l({
      className: "arrow"
    }, function () {
      n.emit("goToPreviousView");
    });
  o.appendChild(a);
  this._backToCategoryText = o.createChild("div", {
    className: "text"
  });
  this.promoBanner = this.createChild("div", {
    className: "promoBanner"
  });
  this.promoBannerFree = this.createChild("div", {
    className: "promoBannerFree"
  });
  this._leftColumnScroller = new g({
    className: "left"
  });
  this.appendChild(this._leftColumnScroller);
  var u = this._leftColumnScroller;
  this.promoDescription = u.content.createChild("div", {
    className: "promoDescription"
  });
  var m = u.content.createChild("div", {
      className: "topRow"
    }),
    f = m.createChild("div", {
      className: "illuContainer"
    });
  f.createChild("div", {
    className: "dummy"
  });
  var _ = f.createChild("div", {
    className: "illuElement"
  });
  this._articleBox = _.appendChild(new h());
  var b = m.createChild("div", {
    className: "nameAndDescription"
  });
  this._name = b.createChild("div", {
    className: "section"
  });
  this._description = b.createChild("div", {
    className: "subSection"
  });
  this._weight = this._articleBox.createChild("div", {
    className: "weight"
  });
  this._linkToItemSet = m.appendChild(new l({
    className: "setButton",
    scaleOnPress: !0
  }, function () {
    n._firstItemOfSet && v.open("itemSets", n._firstItemOfSet);
  }));
  this._linkToItemSet.hide();
  var M = this._itemsListRow = u.content.createChild("div", {
    className: "itemsListRow"
  });
  M.createChild("div", {
    className: "section",
    text: s("tablet.shop.comesWith").toUpperCase()
  });
  this._itemsList = M.createChild("div", {
    className: "subSection"
  });
  var T = u.content.createChild("div", {
    className: "leftItemDetails"
  });
  this._effectsBox = T.appendChild(new w(s("ui.common.effects", 2).toUpperCase()));
  var C = u.content.createChild("div", {
    className: "rightItemDetails"
  });
  this._conditionsBox = C.appendChild(new w(s("ui.common.conditions").toUpperCase()));
  this._characBox = C.appendChild(new w(s("ui.common.caracteristics").toUpperCase()));
  var I = this.createChild("div", {
      className: "right"
    }),
    A = I.createChild("div", {
      className: "charaContainer"
    });
  A.createChild("div", {
    className: "dummy"
  });
  var S = A.createChild("div", {
      className: "charaElement"
    }),
    E = S.createChild("div", {
      className: "characterOnIsland"
    });
  this._characterOnIsland = E;
  this._islandImage = E.createChild("div", {
    className: "islandImage"
  });
  var N = this._characterDisplay = E.appendChild(new c()),
    x = N.createChild("div", {
      className: "leftButton"
    });
  d(x, {
    repeatDelay: 100
  });
  x.on("tap", function () {
    N.rotateCharacter(!1);
  });
  var L = N.createChild("div", {
    className: "rightButton"
  });
  d(L, {
    repeatDelay: 100
  });
  L.on("tap", function () {
    N.rotateCharacter(!0);
  });
  var O = E.createChild("div", {
    className: "outfitSelector"
  });
  this.outfitArrows = O.createChild("div", {
    className: "outfitArrows"
  });
  this.outfitDots = O.createChild("div", {
    className: "outfitDots"
  });
  var R = this.outfitArrows.createChild("div", {
    className: "leftArrow"
  });
  d(R);
  R.on("tap", function () {
    n.selectOutfit();
  });
  var D = this.outfitArrows.createChild("div", {
    className: "rightArrow"
  });
  d(D);
  D.on("tap", function () {
    n.selectOutfit({
      right: !0
    });
  });
  var P = I.createChild("div", {
      className: "priceBottomSection"
    }),
    B = this._articleButtons = P.appendChild(new p());
  B.on("tapIAPButton", e);
  B.on("tapHardButton", t);
  B.on("tapSoftButton", i);
};
n.prototype.resize = function () {
  var e = C(this._characterDisplay.rootElement),
    t = N * e.height,
    i = x * e.height;
  this._characterDisplay.setStyle("top", t - i + "px");
  var n = L * e.width;
  this._characterDisplay.setScale(n);
  this._leftColumnScroller.refresh();
};
n.prototype._displayConditions = function (e) {
  for (var t = 0; t < e.length; t++) {
    var i = e[t],
      n = i.text,
      o = i.isMalus ? ["malus"] : [];
    if ("string" == typeof n) {
      this._conditionsBox.addRow(n, o);
    } else {
      for (var a = 0; a < n.length; a++) {
        this._conditionsBox.addRow(n[a], o);
      }
    }
  }
};
n.prototype._displayOneItem = function (e) {
  this._itemsListRow.hide();
  this._linkToItemSet.hide();
  var t = s("ui.common.short.weight", e.getProperty("realWeight"));
  this._weight.setText(s("ui.common.weight") + s("ui.common.colon") + t);
  var i;
  if (this._effectsBox.clearContent(), this._effectsBox.show(), e.hideEffects) {
    this._effectsBox.addRow(s("ui.set.secretBonus"));
  } else {
    var n = b.getSortedEffectInstances(e);
    if (n && n.length) {
      for (i = 0; i < n.length; i++) {
        var o = n[i];
        if (!A[o.effectId]) {
          if ("" !== o.description) {
            var a = o.effect.bonusType,
              r = [];
            a === -1 ? r.push("malus") : 1 === a && r.push("bonus");
            this._effectsBox.addRow(o.description, r);
          } else {
            console.error("Effect " + o.effectId + " not supported for item " + e.getProperty("id"));
          }
        }
      }
    }
    this._effectsBox.hasRow() || this._effectsBox.addRow(s("tablet.common.none", 0), ["placeholder"]);
  }
  this._conditionsBox.clearContent();
  this._conditionsBox.show();
  var l = e.getProperty("conditionsFormatted"),
    c = e.getProperty("targetConditionsFormatted");
  if (0 === l.length && 0 === c.length ? this._conditionsBox.addRow(s("tablet.common.none", 1), ["placeholder"]) : (this._displayConditions(l), this._displayConditions(c)), this._characBox.clearContent(), e.getProperty("isWeapon")) {
    this._characBox.show();
    var d = e.getProperty("statsFormatted");
    if (0 === d.length) {
      this._characBox.addRow(s("tablet.common.none", 1), ["placeholder"]);
    } else {
      for (i = 0; i < d.length; i++) {
        this._characBox.addRow(d[i]);
      }
    }
  } else {
    this._characBox.hide();
  }
  this._leftColumnScroller.refresh();
};
n.prototype._displayMultipleItems = function (e) {
  function t() {
    v.open("itemBox", {
      itemData: this.data
    });
  }
  this._itemsListRow.show();
  this._effectsBox.hide();
  this._conditionsBox.hide();
  this._characBox.hide();
  var i,
    n = 0;
  this._itemsList.clearContent();
  for (var o = 0; o < e.length; o++) {
    i = e[o];
    n += i.getProperty("realWeight");
    var a = new _({
      itemData: i
    });
    a.on("tap", t);
    this._itemsList.appendChild(a);
  }
  var r = s("ui.common.short.weight", n);
  this._weight.setText(s("ui.common.weight") + s("ui.common.colon") + r);
  i = e[0];
  var l = i.itemSetId;
  l && l !== -1 ? (this._firstItemOfSet = i, this._linkToItemSet.show()) : (this._firstItemOfSet = null, this._linkToItemSet.hide());
  this._leftColumnScroller.refresh();
};
n.prototype.getArticleId = function () {
  return this._articleId;
};
n.prototype.update = function (e) {
  if (this.emit("showSubCategoryRow", this._backToCategory), e) {
    this._itemsListRow.hide();
    this._effectsBox.hide();
    this._conditionsBox.hide();
    this._characBox.hide();
    this._backToCategoryText.setText(s("tablet.shop.backTo", e.categoryName));
    var t = e.article;
    this._articleId = t.id;
    t.name || (console.error("Shop: article name missing for id " + t.id), t.name = "");
    this._name.setText(t.name.toUpperCase());
    this._description.setHtml(t.description);
    T.allLinksOnTargetBlank(this._description);
    this._articleBox.update(t);
    this._articleButtons.update(t);
    this._setClassSymbol();
    this._characterDisplay.hide();
    this._islandImage.addClassNames("spinner");
    var i = t.promo && t.promo.length,
      n = t._promoRate,
      a = t.is_free,
      r = t.enddate && t.showCountDown;
    if (i || n || r || a) {
      this._leftColumnScroller.addClassNames("promo");
      this.promoBanner.toggleDisplay(Boolean(n) && !a);
      this.promoBannerFree.toggleDisplay(a);
      this.promoDescription.toggleDisplay(!!i);
      var l, c;
      if (i || n || !r ? (n || r) && (l = "", n && (l += n), r && (n && (l += " "), c = new Date(t.enddate), l += s("tablet.common.until", c.toLocaleDateString()))) : (c = new Date(t.enddate), l = s("tablet.common.available", s("tablet.common.until", c.toLocaleDateString()))), this.promoBanner.setText(l), this.promoBannerFree.setText(s("ui.shop.free")), i) {
        for (var d = t.promo, h = "", p = s("ui.common.colon"), m = 0; m < i - 1; m++) {
          h += d[m].name + p + d[m].description + "<br /><br />";
        }
        h += d[i - 1].name + p + d[i - 1].description;
        this.promoDescription.setHtml(h);
      }
    } else {
      this._leftColumnScroller.delClassNames("promo");
      this.promoBanner.hide();
      this.promoBannerFree.hide();
      this.promoDescription.hide();
    }
    this._leftColumnScroller.refresh();
    var f = this,
      g = t.itemsId;
    this.resetOutfits();
    u.getItems(g, function (e, t) {
      if (e) {
        return console.error("ItemDetailsView#update: getItems", e);
      }
      var i = t.length;
      if (g.length !== i) {
        return console.error(new Error("Some items are missing, ids requested: " + g + ", items get: " + t));
      }
      i && (1 === i ? f._displayOneItem(t[0]) : f._displayMultipleItems(t));
      for (var n = [], a = 0; a < i; a++) {
        var s = t[a];
        s.isEquippable() && n.push(s);
      }
      n.length ? f.generateOutfits(n) : f.setLook(o());
    });
  }
};
n.prototype.resetOutfits = function () {
  this.outfits = [];
  this.outfitDots.clearContent();
  this.outfitDots.createChild("div", {
    className: ["dot", "selected"]
  });
  this.outfitArrows.hide();
};
n.prototype.generateOutfits = function (e) {
  this.outfits = [{}];
  var t;
  for (t = 0; t < e.length; t++) {
    var i = e[t],
      n = i.type.superTypeId;
    if (n !== I.DOFUS_OR_TROPHY) {
      var o;
      for (o = 0; o < this.outfits.length; o++) {
        if (!this.outfits[o][n]) {
          this.outfits[o][n] = i.id;
          break;
        }
      }
      if (o >= this.outfits.length) {
        var a = {};
        a[n] = i.id;
        this.outfits.push(a);
      }
    }
  }
  for (this.setOutfitLook(0), this.outfitDots.clearContent(), this.outfitDots.createChild("div", {
    className: ["dot", "selected"]
  }), t = 1; t < this.outfits.length; t++) {
    this.outfitDots.createChild("div", {
      className: "dot"
    });
  }
  this.outfitArrows.toggleDisplay(this.outfits.length > 1);
};
n.prototype.setOutfitLook = function (e) {
  var t = this.outfits[e];
  if (t) {
    this.currentOutfitIndex = e;
    var i = [];
    for (var n in t) {
      t.hasOwnProperty(n) && i.push(t[n]);
    }
    this.emit("requestPrevisualization", i);
    for (var o = 0; o < this.outfitDots.getChildren().length; o++) {
      var a = this.outfitDots.getChildren()[o];
      a.toggleClassName("selected", o === e);
    }
  }
};
n.prototype.selectOutfit = function (e) {
  e = e || {};
  var t = T.mod(this.currentOutfitIndex + (e.right ? 1 : -1), this.outfits.length);
  this.setOutfitLook(t);
};
n.prototype.setLook = function (e) {
  e = e || o();
  var t = this;
  this._characterDisplay.setLook(e, {
    boneType: "characters/",
    skinType: "characters/",
    direction: m.DIRECTION_SOUTH_WEST,
    keepDirection: !1,
    keepModels: !0
  }, function () {
    t._islandImage.delClassNames("spinner");
    t._characterDisplay.show();
    t._characterDisplay.resize();
  });
};
n.prototype.updateArticlesPrices = function (e) {
  var t,
    i = this._articleBox,
    n = this._articleButtons,
    o = i.articleId;
  o && (t = e[o], t ? i.updatePrice(t) : console.error(new Error("Article " + o + " missing for an ArticleBox")));
  o = n.articleId;
  o && (t = e[o], t ? n.update(t) : console.error(new Error("Article " + o + " missing for an ArticleButtons")));
};
n.prototype._setClassSymbol = function () {
  if (!this._classSymbolImage) {
    var e = this,
      t = window.gui.playerData.characterBaseInformations;
    f.preloadImage("gfx/illusUi/symboles_classe/FichePerso_tx_symboleClasse_frame" + (t.breed - 1) + ".png", function (t) {
      e._classSymbolImage = t;
      e._characterOnIsland.setStyle("backgroundImage", t);
    });
  }
};
this._classSymbolImage = null;
this._firstItemOfSet = null;
this._articleId = null;
this.outfits = [];
this.currentOutfitIndex = 0;
this._resetProperties();
this._articleBox.clear();
this._characterDisplay.release();
o.appendChild(a);
this._backToCategoryText = o.createChild("div", {
  className: "text"
});
this.promoBanner = this.createChild("div", {
  className: "promoBanner"
});
this.promoBannerFree = this.createChild("div", {
  className: "promoBannerFree"
});
this._leftColumnScroller = new g({
  className: "left"
});
this.appendChild(this._leftColumnScroller);
this._name = b.createChild("div", {
  className: "section"
});
this._description = b.createChild("div", {
  className: "subSection"
});
this._weight = this._articleBox.createChild("div", {
  className: "weight"
});
this._linkToItemSet = m.appendChild(new l({
  className: "setButton",
  scaleOnPress: !0
}, function () {
  n._firstItemOfSet && v.open("itemSets", n._firstItemOfSet);
}));
this._linkToItemSet.hide();
M.createChild("div", {
  className: "section",
  text: s("tablet.shop.comesWith").toUpperCase()
});
this._itemsList = M.createChild("div", {
  className: "subSection"
});
this._conditionsBox = C.appendChild(new w(s("ui.common.conditions").toUpperCase()));
this._characBox = C.appendChild(new w(s("ui.common.caracteristics").toUpperCase()));
this._characterOnIsland = E;
this._islandImage = E.createChild("div", {
  className: "islandImage"
});
d(x, {
  repeatDelay: 100
});
x.on("tap", function () {
  N.rotateCharacter(!1);
});
d(L, {
  repeatDelay: 100
});
L.on("tap", function () {
  N.rotateCharacter(!0);
});
this.outfitArrows = O.createChild("div", {
  className: "outfitArrows"
});
this.outfitDots = O.createChild("div", {
  className: "outfitDots"
});
d(R);
R.on("tap", function () {
  n.selectOutfit();
});
d(D);
D.on("tap", function () {
  n.selectOutfit({
    right: !0
  });
});
B.on("tapIAPButton", e);
B.on("tapHardButton", t);
B.on("tapSoftButton", i);
this._characterDisplay.setScale(n);
this._leftColumnScroller.refresh();
this._itemsListRow.hide();
this._linkToItemSet.hide();
a === -1 ? r.push("malus") : 1 === a && r.push("bonus");
this._effectsBox.addRow(o.description, r);
this._conditionsBox.clearContent();
this._conditionsBox.show();
this._itemsListRow.show();
this._effectsBox.hide();
this._conditionsBox.hide();
this._characBox.hide();
i = e[o];
n += i.getProperty("realWeight");
a.on("tap", t);
this._itemsList.appendChild(a);
this._weight.setText(s("ui.common.weight") + s("ui.common.colon") + r);
i = e[0];
l && l !== -1 ? (this._firstItemOfSet = i, this._linkToItemSet.show()) : (this._firstItemOfSet = null, this._linkToItemSet.hide());
this._leftColumnScroller.refresh();
this._itemsListRow.hide();
this._effectsBox.hide();
this._conditionsBox.hide();
this._characBox.hide();
this._backToCategoryText.setText(s("tablet.shop.backTo", e.categoryName));
this._articleId = t.id;
t.name || (console.error("Shop: article name missing for id " + t.id), t.name = "");
this._name.setText(t.name.toUpperCase());
this._description.setHtml(t.description);
T.allLinksOnTargetBlank(this._description);
this._articleBox.update(t);
this._articleButtons.update(t);
this._setClassSymbol();
this._characterDisplay.hide();
this._islandImage.addClassNames("spinner");
this._leftColumnScroller.addClassNames("promo");
this.promoBanner.toggleDisplay(Boolean(n) && !a);
this.promoBannerFree.toggleDisplay(a);
this.promoDescription.toggleDisplay(!!i);
h += d[i - 1].name + p + d[i - 1].description;
this.promoDescription.setHtml(h);
this._leftColumnScroller.delClassNames("promo");
this.promoBanner.hide();
this.promoBannerFree.hide();
this.promoDescription.hide();
this.resetOutfits();
u.getItems(g, function (e, t) {
  if (e) {
    return console.error("ItemDetailsView#update: getItems", e);
  }
  var i = t.length;
  if (g.length !== i) {
    return console.error(new Error("Some items are missing, ids requested: " + g + ", items get: " + t));
  }
  i && (1 === i ? f._displayOneItem(t[0]) : f._displayMultipleItems(t));
  for (var n = [], a = 0; a < i; a++) {
    var s = t[a];
    s.isEquippable() && n.push(s);
  }
  n.length ? f.generateOutfits(n) : f.setLook(o());
});
this.outfits = [];
this.outfitDots.clearContent();
this.outfitDots.createChild("div", {
  className: ["dot", "selected"]
});
this.outfitArrows.hide();
a[n] = i.id;
this.outfits.push(a);
t._islandImage.delClassNames("spinner");
t._characterDisplay.show();
t._characterDisplay.resize();
o && (t = e[o], t ? i.updatePrice(t) : console.error(new Error("Article " + o + " missing for an ArticleBox")));
o = n.articleId;
o && (t = e[o], t ? n.update(t) : console.error(new Error("Article " + o + " missing for an ArticleButtons")));
e._classSymbolImage = t;
e._characterOnIsland.setStyle("backgroundImage", t);
a.call(this, "div", {
  className: "itemDetailsBox"
});
this._createDom(e);
o(n, a);
e.exports = n;
n.prototype._createDom = function (e) {
  var t = this.createChild("div", {
    className: "header"
  });
  t.createChild("div", {
    className: "title",
    text: e
  });
  t.createChild("div", {
    className: "titleCorner"
  });
  this._content = this.createChild("div", {
    className: "content"
  });
};
n.prototype.clearContent = function () {
  this._content.clearContent();
};
n.prototype.addRow = function (e, t) {
  t = t || [];
  t.push("row");
  this._content.createChild("div", {
    className: t,
    text: e
  });
};
n.prototype.hasRow = function () {
  return this._content.getChildCount() > 0;
};
t.createChild("div", {
  className: "title",
  text: e
});
t.createChild("div", {
  className: "titleCorner"
});
this._content = this.createChild("div", {
  className: "content"
});
t = t || [];
t.push("row");
this._content.createChild("div", {
  className: t,
  text: e
});
r.call(this, {
  title: a("tablet.shop.needMoreHardCurrency").toUpperCase(),
  className: "BuyHardCurrencyConfirmWindow",
  positionInfo: {
    left: "c",
    top: "c",
    width: 540,
    height: 440,
    isModal: !0
  }
});
this._reset();
this.on("open", this._onOpen);
t.on("shopIAPArticlesSuccess", function (t) {
  e.content && e.displayHardCurrencyPack(t);
});
t.on("shopIAPArticlesError", function () {
  e.content && e.displayError(u.NO_PACK, new Error("IAP articles are not available"));
});
s(n, r);
e.exports = n;
n.prototype._reset = function () {
  this.content = null;
  this.buyPackText = null;
  this.articleBoxContainer = null;
  this.articleBox = null;
  this.hardCurrencyAmountMissing = 0;
};
n.prototype._onOpen = function () {
  this.content || this._createContent();
};
n.prototype.freeContent = function () {
  this.windowBody.clearContent();
  this._reset();
};
n.prototype._createContent = function () {
  this.content = this.windowBody.createChild("div", {
    className: "content"
  });
  var e = this.content.createChild("div", {
    className: "buyPackTextContainer"
  });
  this.buyPackText = e.createChild("div", {
    className: "buyPackText"
  });
  this.articleBoxContainer = this.content.createChild("div", {
    className: "articleBoxContainer"
  });
  this.articleBox = this.articleBoxContainer.appendChild(new d(null, {
    boxWidth: 190,
    boxHeight: 220
  }, {
    showTitle: !0,
    showButtons: !0,
    promoType: "corner"
  }));
  this.content.appendChild(new o({
    text: a("tablet.shop.seeAllHardCurrencyPacks"),
    className: ["greenButton", "seePacksBtn"]
  }, function () {
    l.close("buyHardCurrencyConfirm");
    l.open("market", {
      tabId: "shop",
      tabParams: {
        category: "goultines"
      }
    });
  }));
};
n.prototype.confirmBuy = function (e) {
  l.open(this.id);
  this.content.hide();
  this.windowBody.addClassNames("spinner");
  this.hardCurrencyAmountMissing = e;
  var t = this;
  c.getStoreInfos(function (e) {
    return e ? t.displayError(u.NO_PACK, e) : void window.dofus.send("shopIAPArticlesRequest");
  });
};
n.prototype.displayError = function (e, t) {
  t && console.error(t);
  this.content && (this.content.show(), this.articleBoxContainer.hide(), this.windowBody.delClassNames("spinner"), e === u.AMOUNT_TOO_HIGH ? this.buyPackText.setText(a("tablet.shop.noHardCurrencyPackForAmount")) : this.buyPackText.setText(a("tablet.shop.noHardCurrencyPack")));
};
n.prototype.displayHardCurrencyPack = function (e) {
  var t = c.validateArticles(e.articles),
    i = null,
    n = Number.MAX_VALUE;
  if (!t.length) {
    return this.displayError(u.NO_PACK, new Error("No valid IAP " + t.length + " out of " + e.articles.length + " articles"));
  }
  for (var o = 0; o < t.length; o++) {
    var s = t[o],
      r = 1 === s.references.length && s.references[0];
    if (r && "GOULTINE" === r.type) {
      var d = parseInt(r.quantity, 10);
      isNaN(d) || d < this.hardCurrencyAmountMissing || d < n && (n = d, i = s);
    }
  }
  return i ? (this.content.show(), this.articleBoxContainer.show(), this.windowBody.delClassNames("spinner"), this.buyPackText.setText(a("tablet.shop.buyHardCurrencyPack", n)), this.articleBox.update(i), void this.articleBox.on("tapIAPButton", function () {
    l.close("buyHardCurrencyConfirm");
    c.purchaseArticleOnStore(i);
  })) : this.displayError(u.AMOUNT_TOO_HIGH);
};
this.content = null;
this.buyPackText = null;
this.articleBoxContainer = null;
this.articleBox = null;
this.hardCurrencyAmountMissing = 0;
this.windowBody.clearContent();
this._reset();
this.buyPackText = e.createChild("div", {
  className: "buyPackText"
});
this.articleBoxContainer = this.content.createChild("div", {
  className: "articleBoxContainer"
});
this.articleBox = this.articleBoxContainer.appendChild(new d(null, {
  boxWidth: 190,
  boxHeight: 220
}, {
  showTitle: !0,
  showButtons: !0,
  promoType: "corner"
}));
this.content.appendChild(new o({
  text: a("tablet.shop.seeAllHardCurrencyPacks"),
  className: ["greenButton", "seePacksBtn"]
}, function () {
  l.close("buyHardCurrencyConfirm");
  l.open("market", {
    tabId: "shop",
    tabParams: {
      category: "goultines"
    }
  });
}));
l.close("buyHardCurrencyConfirm");
l.open("market", {
  tabId: "shop",
  tabParams: {
    category: "goultines"
  }
});
l.open(this.id);
this.content.hide();
this.windowBody.addClassNames("spinner");
this.hardCurrencyAmountMissing = e;
t && console.error(t);
this.content && (this.content.show(), this.articleBoxContainer.hide(), this.windowBody.delClassNames("spinner"), e === u.AMOUNT_TOO_HIGH ? this.buyPackText.setText(a("tablet.shop.noHardCurrencyPackForAmount")) : this.buyPackText.setText(a("tablet.shop.noHardCurrencyPack")));
l.close("buyHardCurrencyConfirm");
c.purchaseArticleOnStore(i);
l.call(this, {
  title: s("tablet.purchasesPending.title"),
  className: "PurchasesPendingWindow",
  noCloseButton: !0,
  positionInfo: {
    left: "c",
    top: "c",
    width: 450,
    height: 243,
    isModal: !0
  }
});
o = t;
this._reset();
this.on("open", this._onOpen);
n.on("shopIAPArticlesSuccess", function (e) {
  if (i._content) {
    var t = e.articles;
    d.validateArticles(t);
    i._displayPurchasesList(null, t);
  }
});
n.on("shopIAPArticlesError", function () {
  i._content && i._displayPurchasesList(new Error("IAP articles are not available"));
});
d.validateArticles(t);
i._displayPurchasesList(null, t);
r(n, l);
e.exports = n;
n.prototype._reset = function () {
  this.windowBody.clearContent();
  this._content = null;
  this._description = null;
  this._spinner = null;
  this._pendingPurchases = [];
  this._purchasesDetails = {};
  this._isProcessing = !1;
};
n.prototype._onOpen = function () {
  this._content || this._createContent();
};
n.prototype.freeContent = function () {
  this._reset();
};
n.prototype._createContent = function () {
  this._content = this.windowBody.createChild("div", {
    className: "content"
  });
  var e = this._content.createChild("div", {
    className: "textBox"
  });
  this._description = e.createChild("div", {
    className: "description"
  });
  this._purchasesList = e.createChild("div", {
    className: "purchasesList"
  });
  this._spinner = e.createChild("div", {
    className: ["spinnerContainer", "spinner"]
  });
  this._validationDone = e.createChild("div", {
    className: "validationDone",
    hidden: !0
  });
  this._okButton = this._content.appendChild(new a({
    text: s("ui.common.ok"),
    className: ["greenButton", "okButton"]
  }, function () {
    c.close("purchasesPending");
  }));
  this._okButton.disable();
};
n.prototype._processNext = function () {
  var e = this._pendingPurchases.shift();
  d.validatePendingIAP(e);
};
n.prototype._displayPurchasesListNotAvailable = function () {
  this._spinner.hide();
  this._purchasesList.setText(s("tablet.purchasesPending.listNotAvailable"));
};
n.prototype._displayPurchasesList = function (e, t) {
  if (e && console.error(e), this._content) {
    if (e) {
      this._displayPurchasesListNotAvailable();
    } else {
      for (var i = 0; i < t.length; i++) {
        var n = t[i],
          o = this._purchasesDetails[n.key];
        if (o) {
          var a = this._purchasesList.getChild(n.key);
          a || (a = this._purchasesList.createChild("div", {
            className: "entry",
            name: n.key,
            text: n.name
          }), a.createChild("div", {
            className: "state"
          }), a.createChild("div", {
            className: "name",
            text: n.name
          }));
          o.article = n;
          var s = o.state;
          switch (s) {
            case u.PENDING:
              a.delClassNames(["failure", "success"]);
              break;
            case u.FAILED:
              a.replaceClassNames(["success"], ["failure"]);
              break;
            case u.SUCCEEDED:
              a.replaceClassNames(["failure"], ["success"]);
          }
        }
      }
      Object.keys(this._purchasesDetails).length <= this._purchasesList.getChildCount() ? this._spinner.hide() : this._spinner.show();
    }
  }
};
n.prototype.validatePendingPurchases = function (e) {
  if (!e || !e.length) {
    return console.error(new Error("No purchase to validate: " + e));
  }
  var t = e.filter(function (e) {
    return !this._purchasesDetails[e.productId];
  }, this);
  if (t.forEach(function (e) {
    this._purchasesDetails[e.productId] = {
      state: u.PENDING,
      article: null
    };
  }, this), this._pendingPurchases = this._pendingPurchases.concat(t), t.length) {
    c.open(this.id);
    this._description.setText(s("tablet.purchasesPending.description", Object.keys(this._purchasesDetails).length) + s("ui.common.colon"));
    this._spinner.show();
    var i = this;
    d.getStoreInfos(function (e) {
      return e ? i._displayPurchasesList(e) : (window.dofus.send("shopIAPArticlesRequest"), void i._startProcessing());
    });
  }
};
n.prototype._startProcessing = function () {
  this._isProcessing || (this._isProcessing = !0, this._validationDone.hide(), this._okButton.disable(), this._processNext());
};
n.prototype._endProcessing = function () {
  var e = 0,
    t = !1;
  for (var i in this._purchasesDetails) {
    var n = this._purchasesDetails[i].state;
    n === u.SUCCEEDED ? e++ : t || n !== u.FAILED || (t = !0);
  }
  t && o.refreshReceipt(function (e) {
    e && console.error("Refresh receipt failed", e);
  });
  this._purchasesList.getChildCount() || this._displayPurchasesListNotAvailable();
  this._isProcessing = !1;
  this._validationDone.setText(s("tablet.purchasesPending.validationDone", e));
  this._validationDone.show();
  this._okButton.enable();
};
n.prototype.validateNextPendingPurchases = function (e, t) {
  if (e && console.error(e), this._content) {
    var i = this._purchasesList.getChild(t);
    this._purchasesDetails[t].state = e ? u.FAILED : u.SUCCEEDED;
    i && (e ? i.replaceClassNames(["success"], ["failure"]) : i.replaceClassNames(["failure"], ["success"]));
    this._pendingPurchases.length ? this._processNext() : this._endProcessing();
  }
};
this.windowBody.clearContent();
this._content = null;
this._description = null;
this._spinner = null;
this._pendingPurchases = [];
this._purchasesDetails = {};
this._isProcessing = !1;
this._description = e.createChild("div", {
  className: "description"
});
this._purchasesList = e.createChild("div", {
  className: "purchasesList"
});
this._spinner = e.createChild("div", {
  className: ["spinnerContainer", "spinner"]
});
this._validationDone = e.createChild("div", {
  className: "validationDone",
  hidden: !0
});
this._okButton = this._content.appendChild(new a({
  text: s("ui.common.ok"),
  className: ["greenButton", "okButton"]
}, function () {
  c.close("purchasesPending");
}));
this._okButton.disable();
this._spinner.hide();
this._purchasesList.setText(s("tablet.purchasesPending.listNotAvailable"));
a || (a = this._purchasesList.createChild("div", {
  className: "entry",
  name: n.key,
  text: n.name
}), a.createChild("div", {
  className: "state"
}), a.createChild("div", {
  className: "name",
  text: n.name
}));
o.article = n;
c.open(this.id);
this._description.setText(s("tablet.purchasesPending.description", Object.keys(this._purchasesDetails).length) + s("ui.common.colon"));
this._spinner.show();
t && o.refreshReceipt(function (e) {
  e && console.error("Refresh receipt failed", e);
});
this._purchasesList.getChildCount() || this._displayPurchasesListNotAvailable();
this._isProcessing = !1;
this._validationDone.setText(s("tablet.purchasesPending.validationDone", e));
this._validationDone.show();
this._okButton.enable();
this._purchasesDetails[t].state = e ? u.FAILED : u.SUCCEEDED;
i && (e ? i.replaceClassNames(["success"], ["failure"]) : i.replaceClassNames(["failure"], ["success"]));
this._pendingPurchases.length ? this._processNext() : this._endProcessing();
a.call(this, {
  className: "ToaWindow",
  title: s("ui.toa.interfaceTitle"),
  positionInfo: {
    left: "c",
    top: "c",
    width: "75%",
    height: "90%",
    minWidth: 700,
    maxHeight: 650,
    mustAvoidToolbar: !0
  }
});
this.once("open", function () {
  var e = window.gui.playerData.ToaData;
  e.initRanksData();
  this.body = this.windowBody.createChild("div", {
    className: "ToaBody"
  });
  var t = new l(),
    i = new c(),
    n = new d();
  this.createTabs(this.body, [{
    title: s("ui.toa.maintabGeneral"),
    content: t,
    name: e.GENERAL_TAB_NAME
  }, {
    title: s("ui.toa.maintabComposition"),
    content: i,
    name: e.COMPOSITION_TAB_NAME
  }, {
    title: s("ui.toa.maintabLadder"),
    content: n,
    name: e.LADDER_TAB_NAME
  }]);
});
this.on("open", function () {
  this.setupTabs();
  this.body.tabs.emitOnCurrentTab("open");
});
e.initRanksData();
this.body = this.windowBody.createChild("div", {
  className: "ToaBody"
});
this.setupTabs();
this.body.tabs.emitOnCurrentTab("open");
o(n, a);
e.exports = n;
n.prototype.createTabs = function (e, t) {
  e.tabs = new r();
  e.appendChild(e.tabs);
  e.panels = e.createChild("div", {
    className: "panels"
  });
  e.panelCollection = {};
  for (var i = 0, n = t.length; i < n; i += 1) {
    var o = t[i].name;
    e.panelCollection[o] = e.panels.appendChild(t[i].content);
    e.tabs.addTab(t[i].title, e.panelCollection[o], i);
  }
  var a = this.body.tabs;
  a.openFirstTab();
  this.setupTabs();
};
n.prototype.setupTabs = function () {
  var e = window.gui.playerData.ToaData,
    t = this.body.tabs,
    i = t.getTabsMap(),
    n = this,
    o = t.getCurrentTab().tab.isEnable();
  for (var a in i) {
    var s = i[a],
      r = s.target.getWuiName();
    e.canTabBeDisable(r) ? s.tab.disable() : s.tab.enable();
  }
  e.isQuestAccomplished() || h || (window.gui.playerData.quests.on("questFinished", function (e) {
    e.questId === u.TOA_QUEST_ID && n.setupTabs();
  }), h = !0);
  o || t.openFirstTab();
};
e.tabs = new r();
e.appendChild(e.tabs);
e.panels = e.createChild("div", {
  className: "panels"
});
e.panelCollection = {};
e.panelCollection[o] = e.panels.appendChild(t[i].content);
e.tabs.addTab(t[i].title, e.panelCollection[o], i);
a.openFirstTab();
this.setupTabs();
e.isQuestAccomplished() || h || (window.gui.playerData.quests.on("questFinished", function (e) {
  e.questId === u.TOA_QUEST_ID && n.setupTabs();
}), h = !0);
o || t.openFirstTab();
this.openedTabId = null;
this.once("open", function () {
  e._setupDom();
});
this.on("open", function () {
  var e = window.gui.playerData.ToaData,
    t = e.current.score,
    i = c.getStepsData();
  this._mapLocationButton && this._mapLocationButton.destroy();
  i ? (this._score.delClassNames("unavailable"), this._score.setText(o("ui.common.score") + o("ui.common.colon") + t)) : (this._score.addClassNames("unavailable"), this._score.setText(o("ui.toa.ascensionClosed")));
  var n = e.isQuestAccomplished(),
    a = {
      type: n ? "zaap" : "quest",
      x: n ? d : h,
      y: n ? u : p
    };
  this._mapLocationButton = this._localisationBox.appendChild(new l(a));
});
this._mapLocationButton && this._mapLocationButton.destroy();
i ? (this._score.delClassNames("unavailable"), this._score.setText(o("ui.common.score") + o("ui.common.colon") + t)) : (this._score.addClassNames("unavailable"), this._score.setText(o("ui.toa.ascensionClosed")));
a(n, s);
e.exports = n;
n.prototype._setupDom = function () {
  var e = this.createChild("div", {
      className: "contentBlock"
    }),
    t = this._mainScroller = e.appendChild(new r({
      className: "ToaScroller"
    })),
    i = t.content.createChild("div", {
      className: "scrollBlock"
    });
  this._createContent(i);
  t.refresh();
};
n.prototype._createContent = function (e) {
  var t = e.createChild("div", {
      className: "generalContent"
    }),
    i = t.createChild("div", {
      className: "introBlock"
    }),
    n = i.createChild("div", {
      className: "col1"
    }),
    a = n.createChild("div", {
      className: "titleHeaderContentBlock"
    });
  a.createChild("div", {
    className: "title"
  }).setHtml(o("ui.toa.welcome"));
  var s = i.createChild("div", {
      className: "col2"
    }),
    r = s.createChild("div", {
      className: "scoreBoxHeaderContentBlock"
    });
  this._score = r.createChild("div", {
    className: "playerScore"
  });
  n.createChild("div", {
    className: "description"
  }).setHtml(o("ui.toa.welcomeText"));
  var l = this._localisationBox = s.createChild("div", {
    className: "localisationBox"
  });
  l.createChild("div", {
    className: "locDescription",
    text: o("ui.toa.localisation")
  });
  t.createChild("hr", {
    className: "separator"
  });
  var d = t.createChild("div", {
      className: "rewardsBlock"
    }),
    u = d.createChild("div", {
      className: "rewardsHeader"
    }),
    h = u.createChild("div", {
      className: "rewardsTitleBox"
    });
  h.createChild("div", {
    className: "title"
  }).setHtml(o("ui.toa.rewards"));
  var p = d.createChild("div", {
      className: "rewardsContent"
    }),
    m = window.gui.playerData.ToaData,
    f = [{
      id: "rankName",
      header: o("ui.toa.rewardsBoardRank"),
      sort: !1
    }, {
      id: "score",
      header: o("ui.toa.rewardsBoardScore"),
      sort: !1
    }, {
      id: "details",
      header: o("ui.toa.maintabLadder"),
      sort: !1
    }, {
      id: "rewards",
      header: o("ui.grimoire.quest.rewards"),
      format: function (e) {
        return c.displayRewardsDetails(e.id);
      },
      sort: !1
    }];
  c.createTable(p, f, !1);
  c.setContent(p, m.ranks);
  p.createChild("div", {
    className: "description"
  }).setHtml(o("ui.toa.rewardsText"));
  t.createChild("hr", {
    className: "separator"
  });
  var g = t.createChild("div", {
      className: "scoreBlock"
    }),
    _ = g.createChild("div", {
      className: "scoreHeader"
    }),
    v = _.createChild("div", {
      className: "scoreTitleBox"
    });
  v.createChild("div", {
    className: "title"
  }).setHtml(o("ui.toa.scoring"));
  var y = g.createChild("div", {
    className: "scoreContent"
  });
  y.createChild("div", {
    className: "description"
  }).setHtml(o("ui.toa.scoringText"));
  t.createChild("hr", {
    className: "separator"
  });
  var w = t.createChild("div", {
      className: "rulesBlock"
    }),
    b = w.createChild("div", {
      className: "rulesHeader"
    }),
    M = b.createChild("div", {
      className: "rulesTitleBox"
    });
  M.createChild("div", {
    className: "title"
  }).setHtml(o("ui.toa.rules"));
  var T = w.createChild("div", {
    className: "rulesContent"
  });
  T.createChild("div", {
    className: "description"
  }).setHtml(o("ui.toa.rulesText"));
};
this._createContent(i);
t.refresh();
this._score = r.createChild("div", {
  className: "playerScore"
});
n.createChild("div", {
  className: "description"
}).setHtml(o("ui.toa.welcomeText"));
l.createChild("div", {
  className: "locDescription",
  text: o("ui.toa.localisation")
});
t.createChild("hr", {
  className: "separator"
});
c.createTable(p, f, !1);
c.setContent(p, m.ranks);
p.createChild("div", {
  className: "description"
}).setHtml(o("ui.toa.rewardsText"));
t.createChild("hr", {
  className: "separator"
});
y.createChild("div", {
  className: "description"
}).setHtml(o("ui.toa.scoringText"));
t.createChild("hr", {
  className: "separator"
});
n || (n = !1);
e.table = e.appendChild(new u(t, i, {
  clickable: !1
}));
e.table.scroller.setEnable(n);
u += p === -1 ? h("ui.item.averageprice.unavailable") : y.kamasToString(p);
c.setContextMenu("item", {
  item: r
});
c.setImage(m);
f && c.setQuantity(f);
b.createChild("div", {
  text: w.nameId || l(w)
});
u && "Item" === d.data._type && b.createChild("div", {
  text: u
});
w.descriptionId && b.createChild("div", {
  text: w.descriptionId,
  className: "details"
});
c.setTooltip(b);
M.icon.addClassNames("iconGoultine");
M.setQuantity(i.goultines);
T.createChild("div", {
  text: h("ui.common.goultines")
});
M.setTooltip(T);
d.push(e.rewards[h].itemId);
u.push(e.rewards[h].quantity);
c[h] = {
  data: u,
  quantity: o[d] || null
};
l.push(h);
e.exports.createTable = n;
e.exports.setContent = o;
e.exports.displayRewardsDetails = a;
e.exports.loadImages = r;
e.exports.tabSpinner = c;
e.exports.getStepsData = d;
t.resolve = function () {
  for (var t = "", o = !1, a = arguments.length - 1; a >= -1 && !o; a--) {
    var s = a >= 0 ? arguments[a] : e.cwd();
    if ("string" != typeof s) {
      throw new TypeError("Arguments to path.resolve must be strings");
    }
    s && (t = s + "/" + t, o = "/" === s.charAt(0));
  }
  return t = i(n(t.split("/"), function (e) {
    return !!e;
  }), !o).join("/"), (o ? "/" : "") + t || ".";
};
t.normalize = function (e) {
  var o = t.isAbsolute(e),
    a = "/" === s(e, -1);
  return e = i(n(e.split("/"), function (e) {
    return !!e;
  }), !o).join("/"), e || o || (e = "."), e && a && (e += "/"), (o ? "/" : "") + e;
};
t.isAbsolute = function (e) {
  return "/" === e.charAt(0);
};
t.join = function () {
  var e = Array.prototype.slice.call(arguments, 0);
  return t.normalize(n(e, function (e, t) {
    if ("string" != typeof e) {
      throw new TypeError("Arguments to path.join must be strings");
    }
    return e;
  }).join("/"));
};
t.relative = function (e, i) {
  function n(e) {
    for (var t = 0; t < e.length && "" === e[t]; t++) {
      ;
    }
    for (var i = e.length - 1; i >= 0 && "" === e[i]; i--) {
      ;
    }
    return t > i ? [] : e.slice(t, i - t + 1);
  }
  e = t.resolve(e).substr(1);
  i = t.resolve(i).substr(1);
  for (var o = n(e.split("/")), a = n(i.split("/")), s = Math.min(o.length, a.length), r = s, l = 0; l < s; l++) {
    if (o[l] !== a[l]) {
      r = l;
      break;
    }
  }
  for (var c = [], l = r; l < o.length; l++) {
    c.push("..");
  }
  return c = c.concat(a.slice(r)), c.join("/");
};
t.sep = "/";
t.delimiter = ":";
t.dirname = function (e) {
  var t = a(e),
    i = t[0],
    n = t[1];
  return i || n ? (n && (n = n.substr(0, n.length - 1)), i + n) : ".";
};
t.basename = function (e, t) {
  var i = a(e)[2];
  return t && i.substr(-1 * t.length) === t && (i = i.substr(0, i.length - t.length)), i;
};
t.extname = function (e) {
  return a(e)[3];
};
e = t.resolve(e).substr(1);
i = t.resolve(i).substr(1);
this.openedTabId = null;
this.once("open", function () {
  t._setupDom();
});
this.on("open", function () {
  o = h.getStepsData();
  var t = e.getCurrentStage();
  p = t.step;
  m = t.stage;
  var i = e.current.score;
  if (this._mapLocationButton && this._mapLocationButton.destroy(), o) {
    b || this._createSteps(this._stepList);
    this._scoreCompo.setText(a("ui.common.score") + a("ui.common.colon") + i);
    var n = e.getStepsScoreRatio();
    this._stepsLabel.forEach(function (e) {
      var t = n[e.stepNumber - 1];
      e.element.setText(a("ui.toa.step") + " " + e.stepNumber + " - " + t + "%");
    });
    this._selectInitialStage(p, m);
  }
});
window.gui.on("disconnect", function () {
  b && t._stepList.clearContent();
  b = !1;
});
p = t.step;
m = t.stage;
b || this._createSteps(this._stepList);
this._scoreCompo.setText(a("ui.common.score") + a("ui.common.colon") + i);
this._stepsLabel.forEach(function (e) {
  var t = n[e.stepNumber - 1];
  e.element.setText(a("ui.toa.step") + " " + e.stepNumber + " - " + t + "%");
});
this._selectInitialStage(p, m);
b && t._stepList.clearContent();
b = !1;
s(n, r);
e.exports = n;
n.prototype._setupDom = function () {
  var e = this.createChild("div", {
    className: "unscrollableContentBlock"
  });
  this._createContent(e);
};
n.prototype._createContent = function (e) {
  var t = this,
    i = e.createChild("div", {
      className: "compositionContent"
    });
  if (o) {
    var n = this.col1 = i.createChild("div", {
        className: "col1"
      }),
      s = i.createChild("div", {
        className: "col2"
      }),
      r = this._stepList = n.appendChild(new c({
        className: "tree"
      }));
    r.on("selected", function (e) {
      p = e.id;
      e.sublist.show();
      l("TAB");
      r.refresh();
      r.scrollToElement(e);
    });
    r.on("deselected", function (e) {
      p = null;
      e.sublist.hide();
      r.refresh();
    });
    var d = s.createChild("div", {
      className: "statBlock"
    });
    this._challengeBlock = d.createChild("div", {
      className: "challengeBlock"
    });
    var u = d.createChild("div", {
        className: "scoreBlock"
      }),
      h = u.createChild("div", {
        className: "scoreBoxHeaderContentBlock"
      });
    this._scoreCompo = h.createChild("div", {
      className: "playerScore"
    });
    this.scoreBox = u.createChild("div", {
      className: "floorScoreBoxHeaderContentBlock"
    });
    s.createChild("hr", {
      className: "separator"
    });
    var m = s.createChild("div", {
        className: "monsterListWrapper"
      }),
      f = this._monsterList = m.appendChild(new c());
    f.on("selected", function (e) {
      e.more ? (e.more.show(), this.refresh()) : (t._createMonsterMoreInfo(e), this.refresh());
    });
    f.on("deselected", function (e) {
      e.more.hide();
      this.refresh();
    });
  } else {
    i.createChild("div", {
      className: "col2",
      text: a("ui.toa.ascensionClosed")
    });
  }
};
n.prototype._createSteps = function (e) {
  var t = this,
    i = window.gui.playerData.ToaData,
    n = i.getStepsScoreRatio();
  return this._stepsLabel = [], o ? (o.forEach(function (o) {
    var s = new r("div", {
      className: "label",
      name: o.stepNumber
    });
    s.createChild("div", {
      className: "arrow"
    });
    t._stepsLabel.push({
      element: s.createChild("div", {
        className: "text",
        text: a("ui.toa.step") + " " + o.stepNumber + " - " + n[o.stepNumber - 1] + "%"
      }),
      stepNumber: o.stepNumber
    });
    var l = e.addItem({
      id: o.stepNumber,
      element: s
    }, {
      noRefresh: !0
    });
    l.sublist = l.appendChild(new r("div", {
      className: "sublist"
    }));
    o.stages.forEach(function (e) {
      var n = new r("div", {
        className: "label",
        name: e.stageLevel
      });
      n.createChild("div", {
        className: "text",
        text: a("ui.toa.stage") + " " + e.stageLevel
      });
      l.sublist.appendChild(n);
      d(n);
      n.on("tap", function () {
        t._resetSelectedSubElement();
        m = e.stageLevel;
        n.addClassNames("selected");
        t.selectedSubAreaElement = n;
        var o = i.getMonsterIds(m, p),
          a = i.getChallengeIds(m, p);
        i.gatheringCompositionData(o, a, function (e, i, n) {
          return e ? console.error(e) : (t._showMonsters(i), t._showChallenges(n), void t._showScore(n));
        });
      });
    });
    l.sublist.hide();
  }), void (b = !0)) : console.error(new Error("Cannot create steps, list is empty."));
};
n.prototype._addMonster = function (e, t, i, n) {
  var o = new r("div", {
      className: "infos"
    }),
    s = o.createChild("div", {
      className: "gfx"
    });
  s.setStyle("backgroundImage", t);
  var l = o.createChild("div", {
      className: "infosGroupRight"
    }),
    c = l.createChild("div", {
      className: "cf"
    }),
    d = ["name"],
    u = {};
  e.isBoss && d.push("boss");
  e.isMiniBoss && d.push("miniBoss");
  e.isQuestMonster && d.push("questMonster");
  var h = window.gui.playerData.isAbleToSeeId(),
    p = e.nameId;
  h && (p += " (" + e.id + ")");
  c.createChild("div", {
    className: d,
    text: p
  });
  e.grades.forEach(function (e) {
    e.grade === n && (u = e);
  });
  var f = window.gui.playerData.ToaData.getMonsterLevelScaled(m),
    g = a("ui.common.short.level") + " " + f;
  c.createChild("div", {
    className: "level",
    text: g
  });
  var _ = this._monsterList.addItem({
    id: i,
    element: o,
    data: e
  }, {
    noRefresh: !0
  });
  _.addClassNames("monster");
  _.monsterData = u;
  _.monsterData.scaledLvl = f;
  _.monsterData.isBoss = e.isBoss;
};
n.prototype._createMonsterMoreInfo = function (e) {
  function t(e, t) {
    var i = "lifePoints" === t ? c : o[t],
      n = e + ": " + i;
    u.createChild("div", {
      className: "stat",
      text: n
    });
  }
  function i(e) {
    var t = o[e],
      i = t;
    h.createChild("div", {
      className: ["stat", "resistance", e],
      text: i
    });
  }
  e.more = e.createChild("div", {
    className: "more"
  });
  var n = e.more.createChild("div", {
      className: "cf"
    }),
    o = e.monsterData,
    s = o.scaledLvl,
    r = o.lifepointsRatio,
    l = o.isBoss ? v : _,
    c = Math.pow(s, f),
    d = r * g + l * y;
  d /= y + g;
  c = Math.trunc(c * d + w);
  var u = n.createChild("div", {
    className: ["col", "colLeft"]
  });
  u.createChild("div", {
    className: "subtitle",
    text: a("ui.common.caracteristics")
  });
  t(a("ui.short.lifePoints"), "lifePoints");
  t(a("ui.short.actionPoints"), "actionPoints");
  t(a("ui.short.movementPoints"), "movementPoints");
  var h = n.createChild("div", {
    className: ["col", "colRight"]
  });
  h.createChild("div", {
    className: "subtitle",
    text: a("ui.common.resistances")
  });
  i("neutralResistance");
  i("earthResistance");
  i("fireResistance");
  i("waterResistance");
  i("airResistance");
};
n.prototype._showChallenges = function (e) {
  var t = window.gui.playerData.ToaData;
  this._challengeBlock.clearContent();
  var i = t.getSelectedStageSucceedChallengeIds(m);
  if (t.isSelectedStageDone(m)) {
    for (var n in e) {
      for (var o = this._challengeBlock.createChild("div", {
          className: "challengeContent"
        }), s = !1, r = 0; r < i.length; r++) {
        i[r] === e[n].id && (o.createChild("div", {
          className: "succeed"
        }), s = !0);
      }
      s || o.createChild("div", {
        className: "failed"
      });
      o.createChild("div", {
        className: "description",
        text: e[n].nameId + a("ui.common.colon") + e[n].points
      });
    }
  } else {
    for (n in e) {
      o = this._challengeBlock.createChild("div", {
        className: "challengeContent"
      });
      o.createChild("div", {
        className: "description",
        text: e[n].nameId + a("ui.common.colon") + e[n].points
      });
    }
  }
  var l = this._challengeBlock.createChild("div", {
    className: "deadContent"
  });
  l.createChild("div", {
    className: "deathIcon"
  });
  l.createChild("div", {
    className: "deathContent",
    text: a("ui.alert.event.13") + a("ui.common.colon") + t.getSelectedMalusScore(m)
  });
};
n.prototype._showScore = function (e) {
  var t = this,
    i = window.gui.playerData.ToaData,
    n = i.calculateMaxStageScore(m, e);
  t.scoreBox.clearContent();
  t.scoreBox.createChild("div", {
    className: "floorScore",
    text: a("ui.toa.floorScore") + a("ui.common.colon") + i.getSelectedStageScore(m)
  });
  t.scoreBox.createChild("div", {
    className: "floorScore",
    text: a("ui.toa.compoFloorScoreMax") + a("ui.common.colon") + n
  });
};
n.prototype._selectInitialStage = function (e, t) {
  if (e) {
    var i = this._stepList.getItem(e);
    if (i) {
      this._stepList.selectItem(e);
      var n = i.sublist.getChild(t);
      n.tap();
      this._stepList.showElement(n);
    }
  }
};
n.prototype._showMonsters = function (e) {
  var t = this,
    i = window.gui.playerData.ToaData;
  this._monsterList.clearContent();
  this._monsterList.delClassNames("spinner");
  var n = [];
  for (var o in e) {
    n.push("gfx/monsters/" + e[o].id + ".png");
  }
  u.preloadImages(n, function (n) {
    var o = 0,
      a = i.getMonstersData(m, p);
    for (var s in e) {
      for (var r = 0; r < a.length; r++) {
        e[s].id === a[r].creatureGenericId && t._addMonster(e[s], n[o], s + r, a[r].grade);
      }
      o++;
    }
    t._monsterList.refresh();
  });
};
n.prototype._resetSelectedSubElement = function () {
  this.selectedSubAreaElement && this.selectedSubAreaElement.rootElement && this.selectedSubAreaElement.hasClassName("selected") && (this.selectedSubAreaElement.delClassNames("selected"), this.selectedSubAreaElement = null);
};
r.on("selected", function (e) {
  p = e.id;
  e.sublist.show();
  l("TAB");
  r.refresh();
  r.scrollToElement(e);
});
r.on("deselected", function (e) {
  p = null;
  e.sublist.hide();
  r.refresh();
});
p = e.id;
e.sublist.show();
l("TAB");
r.refresh();
r.scrollToElement(e);
p = null;
e.sublist.hide();
r.refresh();
this._scoreCompo = h.createChild("div", {
  className: "playerScore"
});
this.scoreBox = u.createChild("div", {
  className: "floorScoreBoxHeaderContentBlock"
});
s.createChild("hr", {
  className: "separator"
});
f.on("selected", function (e) {
  e.more ? (e.more.show(), this.refresh()) : (t._createMonsterMoreInfo(e), this.refresh());
});
f.on("deselected", function (e) {
  e.more.hide();
  this.refresh();
});
e.more.hide();
this.refresh();
s.createChild("div", {
  className: "arrow"
});
t._stepsLabel.push({
  element: s.createChild("div", {
    className: "text",
    text: a("ui.toa.step") + " " + o.stepNumber + " - " + n[o.stepNumber - 1] + "%"
  }),
  stepNumber: o.stepNumber
});
l.sublist = l.appendChild(new r("div", {
  className: "sublist"
}));
o.stages.forEach(function (e) {
  var n = new r("div", {
    className: "label",
    name: e.stageLevel
  });
  n.createChild("div", {
    className: "text",
    text: a("ui.toa.stage") + " " + e.stageLevel
  });
  l.sublist.appendChild(n);
  d(n);
  n.on("tap", function () {
    t._resetSelectedSubElement();
    m = e.stageLevel;
    n.addClassNames("selected");
    t.selectedSubAreaElement = n;
    var o = i.getMonsterIds(m, p),
      a = i.getChallengeIds(m, p);
    i.gatheringCompositionData(o, a, function (e, i, n) {
      return e ? console.error(e) : (t._showMonsters(i), t._showChallenges(n), void t._showScore(n));
    });
  });
});
l.sublist.hide();
n.createChild("div", {
  className: "text",
  text: a("ui.toa.stage") + " " + e.stageLevel
});
l.sublist.appendChild(n);
d(n);
n.on("tap", function () {
  t._resetSelectedSubElement();
  m = e.stageLevel;
  n.addClassNames("selected");
  t.selectedSubAreaElement = n;
  var o = i.getMonsterIds(m, p),
    a = i.getChallengeIds(m, p);
  i.gatheringCompositionData(o, a, function (e, i, n) {
    return e ? console.error(e) : (t._showMonsters(i), t._showChallenges(n), void t._showScore(n));
  });
});
t._resetSelectedSubElement();
m = e.stageLevel;
n.addClassNames("selected");
t.selectedSubAreaElement = n;
e.isBoss && d.push("boss");
e.isMiniBoss && d.push("miniBoss");
e.isQuestMonster && d.push("questMonster");
h && (p += " (" + e.id + ")");
c.createChild("div", {
  className: d,
  text: p
});
e.grades.forEach(function (e) {
  e.grade === n && (u = e);
});
_.addClassNames("monster");
_.monsterData = u;
_.monsterData.scaledLvl = f;
_.monsterData.isBoss = e.isBoss;
d /= y + g;
c = Math.trunc(c * d + w);
u.createChild("div", {
  className: "subtitle",
  text: a("ui.common.caracteristics")
});
t(a("ui.short.lifePoints"), "lifePoints");
t(a("ui.short.actionPoints"), "actionPoints");
t(a("ui.short.movementPoints"), "movementPoints");
h.createChild("div", {
  className: "subtitle",
  text: a("ui.common.resistances")
});
i("neutralResistance");
i("earthResistance");
i("fireResistance");
i("waterResistance");
i("airResistance");
s || o.createChild("div", {
  className: "failed"
});
o.createChild("div", {
  className: "description",
  text: e[n].nameId + a("ui.common.colon") + e[n].points
});
o = this._challengeBlock.createChild("div", {
  className: "challengeContent"
});
o.createChild("div", {
  className: "description",
  text: e[n].nameId + a("ui.common.colon") + e[n].points
});
l.createChild("div", {
  className: "deathIcon"
});
l.createChild("div", {
  className: "deathContent",
  text: a("ui.alert.event.13") + a("ui.common.colon") + t.getSelectedMalusScore(m)
});
t.scoreBox.clearContent();
t.scoreBox.createChild("div", {
  className: "floorScore",
  text: a("ui.toa.floorScore") + a("ui.common.colon") + i.getSelectedStageScore(m)
});
t.scoreBox.createChild("div", {
  className: "floorScore",
  text: a("ui.toa.compoFloorScoreMax") + a("ui.common.colon") + n
});
n.tap();
this._stepList.showElement(n);
this._monsterList.clearContent();
this._monsterList.delClassNames("spinner");
s.call(this, "div", {
  className: ["panel", "ladderTab"],
  name: "ladder"
});
this.openedTabId = null;
this._servers = [];
this.once("open", function () {
  this._setupDom();
  this._setupListener();
});
this.on("open", function () {
  this.currentPage = -1;
  this.pageCount = -1;
  this.selectedServer = "";
  this._servers = window.gui.serversData.getAllowedServerList();
  this._toaClosedblock.toggleClassName("off", Boolean(e));
  this._updateServersSelectorContent();
  this._requestingLadderData();
});
this._setupDom();
this._setupListener();
this.currentPage = -1;
this.pageCount = -1;
this.selectedServer = "";
this._servers = window.gui.serversData.getAllowedServerList();
this._toaClosedblock.toggleClassName("off", Boolean(e));
this._updateServersSelectorContent();
this._requestingLadderData();
a(n, s);
e.exports = n;
n.prototype._setupDom = function () {
  var e = this.createChild("div", {
    className: "unscrollableContentBlock"
  });
  this._createContent(e);
};
n.prototype._requestingLadderData = function () {
  var e = window.gui.playerData.ToaData;
  l.tabSpinner(this._ladderBlock, !0);
  e.requestLadderData(this.currentPage === -1 ? 0 : this.currentPage, this.selectedServer);
  e.requestMaxRankLadderData(window.gui.serversData.connectedServerData.id);
};
n.prototype._setupListener = function () {
  function e() {
    i._updatePageCount();
    l.tabSpinner(i._ladderBlock, !1);
    l.setContent(i._ladderBlock, n.current.ladder.data);
  }
  function t() {
    l.tabSpinner(i._playerBlock, !1);
    l.setContent(i._playerBlock, n.current.ladder.player);
  }
  var i = this,
    n = window.gui.playerData.ToaData;
  n.on("toaLadderDataSuccess", e);
  n.on("toaPlayerRankDataSuccess", t);
  n.on("toaLadderDataFailure", e);
  n.on("toaPlayerRankDataFailure", t);
};
n.prototype._updatePageCount = function () {
  var e = window.gui.playerData.ToaData,
    t = Math.ceil(e.current.ladder.nbPlayer / d.NB_PLAYER_PER_LADDER_PAGE) || 1;
  t !== this.pageCount && (this.pageCount = t, this._displayPage(0), this.pagination.setPageCount(t));
};
n.prototype._updateServersSelectorContent = function () {
  this._serversSelector.clearContent();
  this._serversSelector.addOption(o("ui.toa.ladderFilterChoiceAll"), "");
  for (var e = 0; e < this._servers.length; e++) {
    this._serversSelector.addOption(this._servers[e]._name || this._servers[e].id, this._servers[e].id);
  }
};
n.prototype._createContent = function (e) {
  function t(e) {
    return e.rank + 1;
  }
  function i(e) {
    return window.gui.serversData.getServerNameById(e.server);
  }
  var n = this,
    a = e.createChild("div", {
      className: "ladderContent"
    }),
    s = a.createChild("div", {
      className: "header"
    }),
    d = s.createChild("div", {
      className: "filtersBlock"
    });
  d.createChild("div", {
    className: "description",
    text: o("ui.toa.ladderFilterText") + o("ui.common.colon")
  });
  var u = d.createChild("div", {
      className: "selectorsBlock"
    }),
    h = u.createChild("div", {
      className: "serverSelectorBox"
    });
  h.createChild("div", {
    className: "description",
    text: o("ui.toa.ladderFilterServer")
  });
  var p = this._serversSelector = h.appendChild(new r({
    className: "serverSelector"
  }));
  p.on("change", function (e) {
    n.currentPage = -1;
    n.pageCount = -1;
    n.selectedServer = e;
    n._ladderBlock.table.setPlaceholderText("");
    n._requestingLadderData();
  });
  var m = this._toaClosedblock = s.createChild("div", {
    className: "toaClosedBlock"
  });
  m.createChild("div", {
    className: "toaClosedImg"
  });
  m.createChild("div", {
    className: "toaClosedText",
    text: o("ui.toa.ascensionClosed")
  });
  var f = this._ladderBlock = a.createChild("div", {
      className: "ladderBlock"
    }),
    g = [{
      id: "rank",
      header: o("ui.toa.rewardsBoardRank"),
      sort: !1,
      format: t
    }, {
      id: "name",
      header: o("ui.common.name"),
      sort: !1
    }, {
      id: "breed",
      header: o("ui.toa.ladderFilterBreed"),
      sort: !1
    }, {
      id: "level",
      header: o("ui.common.level"),
      sort: !1
    }, {
      id: "server",
      header: o("ui.toa.ladderFilterServer"),
      sort: !1,
      format: i
    }, {
      id: "score",
      header: o("ui.common.score"),
      sort: !1
    }];
  l.createTable(f, g, "rank", !0);
  this.pagination = f.appendChild(new c());
  this.pagination.on("previous", function () {
    n._displayPage(n.currentPage - 1);
  });
  this.pagination.on("next", function () {
    n._displayPage(n.currentPage + 1);
  });
  this.pagination.on("page", function (e) {
    n._displayPage(e);
  });
  g = [{
    id: "rank",
    header: o("ui.toa.rewardsBoardRank"),
    sort: !1,
    format: t
  }, {
    id: "name",
    header: o("ui.common.name"),
    sort: !1
  }, {
    id: "score",
    header: o("ui.common.score"),
    sort: !1
  }, {
    id: "rewards",
    header: o("ui.grimoire.quest.rewards"),
    format: function (e) {
      return l.displayRewardsDetails(e.rankId);
    },
    sort: !1
  }];
  var _ = this._playerBlock = e.createChild("div", {
    className: "ladderPlayerContent"
  });
  l.createTable(_, g, !1);
};
n.prototype._displayPage = function (e) {
  this.currentPage !== e && (e < 0 || e > this.pageCount || (this.currentPage = e, this.pagination.setCurrent(e), this._requestingLadderData()));
};
l.tabSpinner(this._ladderBlock, !0);
e.requestLadderData(this.currentPage === -1 ? 0 : this.currentPage, this.selectedServer);
e.requestMaxRankLadderData(window.gui.serversData.connectedServerData.id);
i._updatePageCount();
l.tabSpinner(i._ladderBlock, !1);
l.setContent(i._ladderBlock, n.current.ladder.data);
l.tabSpinner(i._playerBlock, !1);
l.setContent(i._playerBlock, n.current.ladder.player);
n.on("toaLadderDataSuccess", e);
n.on("toaPlayerRankDataSuccess", t);
n.on("toaLadderDataFailure", e);
n.on("toaPlayerRankDataFailure", t);
this._serversSelector.clearContent();
this._serversSelector.addOption(o("ui.toa.ladderFilterChoiceAll"), "");
n.currentPage = -1;
n.pageCount = -1;
n.selectedServer = e;
n._ladderBlock.table.setPlaceholderText("");
n._requestingLadderData();
m.createChild("div", {
  className: "toaClosedImg"
});
m.createChild("div", {
  className: "toaClosedText",
  text: o("ui.toa.ascensionClosed")
});
l.createTable(f, g, "rank", !0);
this.pagination = f.appendChild(new c());
this.pagination.on("previous", function () {
  n._displayPage(n.currentPage - 1);
});
this.pagination.on("next", function () {
  n._displayPage(n.currentPage + 1);
});
this.pagination.on("page", function (e) {
  n._displayPage(e);
});
g = [{
  id: "rank",
  header: o("ui.toa.rewardsBoardRank"),
  sort: !1,
  format: t
}, {
  id: "name",
  header: o("ui.common.name"),
  sort: !1
}, {
  id: "score",
  header: o("ui.common.score"),
  sort: !1
}, {
  id: "rewards",
  header: o("ui.grimoire.quest.rewards"),
  format: function (e) {
    return l.displayRewardsDetails(e.rankId);
  },
  sort: !1
}];
this._isTutorial = !1;
this.feedingBox = new r(this);
this.loadedSpells = {};
this._shield = {};
this.once("open", function () {
  this._createDom();
});
this.on("open", function (e) {
  this._isTutorial = e.itemInstance.item.id === f.fakeShieldId;
  this._shieldsListButton.toggleClassName("disabled", this._isTutorial);
  var t = e.itemInstance.item.shieldModelId,
    i = e.itemInstance.item.shieldBonuses;
  this._shield = {
    shieldUID: e.itemInstance.objectUID,
    model: t,
    bonusesPerLevel: i,
    itemInstance: e.itemInstance
  };
  this._isTutorial ? (this._shield.model = 1, this._shield.bonusesPerLevel = [{
    effectId: 125,
    descriptionId: "#1{~1~2 to }#2 Vitality",
    bonusRatio: 1
  }], this._updateTutorialShieldInformations(e.itemInstance), e.mode = "shieldTutorial") : (this._updateShieldInformations(e.itemInstance), e.mode = "shield");
  this.feedingBox.update(e);
});
this.on("close", function () {
  this._isTutorial || this.feedingBox.removeFilter();
  this._resetPreview();
});
this.on("closed", function () {
  this.feedingBox.unloadContent();
  this._shield = {};
});
this.on("slot-tap", function (e) {
  var t = this._isTutorial && !window.gui.shieldTutorialManager.isSpellSlotStepPassed();
  return 100 === this._shield.level || t ? this.feedingBox.storageViewer.unSelectSlot(e.data.objectUID) : void this.feedingBox.selectItem(e.itemInstance);
});
this.on("itemQuantity", function () {
  t.feedingBox.reset();
});
this.on("itemRemoved", function () {
  this.feedingBox.reset();
  this._resetPreview();
});
this.feedingBox.on("quantityUpdated", function (e, i) {
  var n = e * i;
  t._setXpPreview(n);
});
this.feedingBox.on("quantityReset", function () {
  t._resetPreview();
});
g.on("QuestObjectiveValidatedMessage", function () {
  window.gui.playerData.isShieldTutorialFortified() && t._isTutorial && (t.feedingBox.reset(), t._resetPreview(), t._updateTutorialShieldInformations(t._shield.itemInstance));
});
e.on("itemModified", function (e) {
  e.objectUID === t._shield.shieldUID && (t.feedingBox.reset(), t._updateShieldInformations(e));
});
this._isTutorial = e.itemInstance.item.id === f.fakeShieldId;
this._shieldsListButton.toggleClassName("disabled", this._isTutorial);
this._shield = {
  shieldUID: e.itemInstance.objectUID,
  model: t,
  bonusesPerLevel: i,
  itemInstance: e.itemInstance
};
this._isTutorial ? (this._shield.model = 1, this._shield.bonusesPerLevel = [{
  effectId: 125,
  descriptionId: "#1{~1~2 to }#2 Vitality",
  bonusRatio: 1
}], this._updateTutorialShieldInformations(e.itemInstance), e.mode = "shieldTutorial") : (this._updateShieldInformations(e.itemInstance), e.mode = "shield");
this.feedingBox.update(e);
this._isTutorial || this.feedingBox.removeFilter();
this._resetPreview();
this.feedingBox.unloadContent();
this._shield = {};
this.feedingBox.reset();
this._resetPreview();
o(n, a);
e.exports = n;
n.prototype._createDom = function () {
  var e = this.windowBody.createChild("div", {
      className: "ShieldBody"
    }),
    t = this,
    i = e.createChild("div", {
      className: "ShieldContent"
    }),
    n = e.createChild("div", {
      className: "FeedingContent"
    }),
    o = i.createChild("div", {
      className: "PreviewContent"
    });
  this._shieldBg = o.createChild("div", {
    className: "ShieldImg"
  });
  h(this._shieldBg, {
    repeatDelay: 1,
    doubletapTimeout: 1
  });
  this._shieldBg.on("tap", function () {
    t._isTutorial || m.open("ShieldSelectionWindow", t._shield.shieldUID);
  });
  this._shieldsListButton = this._shieldBg.createChild("div", {
    className: "shieldsListButton"
  });
  var a = o.createChild("div", {
    className: "ShieldDescription"
  });
  this._shieldName = a.createChild("div", {
    className: "ShieldName"
  });
  var r = a.createChild("div", {
    className: "ShieldDetails"
  });
  this._spellSlot = r.appendChild(new c());
  var l = r.createChild("div", {
    className: "ShieldLvlDescription"
  });
  this._shieldLvl = l.createChild("div", {
    className: "ShieldLvl"
  });
  this._shieldLvlPreview = l.createChild("div", {
    className: "ShieldLvlPreview"
  });
  var u = i.createChild("div", {
      className: ["statsContent"]
    }),
    p = u.createChild("div", {
      className: "experienceContent"
    }),
    f = p.createChild("div", {
      className: "experienceLabel"
    });
  f.setText(s("ui.common.experiment") + s("ui.common.colon"));
  this._xpbar = p.appendChild(new d({
    valueClassNames: ["oldXp", "gainedXp"]
  }));
  this._xpbar.reached100 = this._xpbar.createChild("div", {
    className: "reached100"
  });
  this._xpbar.reached100.addClassNames("off");
  var g = p.createChild("div", {
    className: "xpDescription"
  });
  this._xpDetails = g.createChild("div", {
    className: "xpDetails"
  });
  this._xpDetailsPreview = g.createChild("div", {
    className: "xpDetailsPreview"
  });
  u.createChild("div", {
    className: "effectsLabel",
    text: s("ui.effects") + s("ui.common.colon")
  });
  this._effects = u.createChild("div", {
    className: "effectsList"
  });
  this.feedingBox.init(n);
};
n.prototype._setEffectsList = function (e) {
  if (e) {
    this._effects.clearContent();
    var t = this._effects.createChild("ul", {
      className: "ShieldEffectsList"
    });
    t.effects = {};
    for (var i = window.gui.playerData.isShieldTutorialFortified(), n = this._shield.bonusesPerLevel, o = 0; o < e.length; o += 1) {
      var a = e[o],
        s = a.effect;
      if (w.indexOf(s.id) === -1) {
        var r = a.description;
        if (i && n[0].effectId === a.effectId) {
          var l = a.value + Math.floor(n[0].bonusRatio * y);
          r = p(a.effect.descriptionId, l);
        }
        r && e[o].actionId !== u.ACTION_CAST_STARTING_SPELL && e[o].actionId !== u.ACTION_SHIELD_EXPERIENCE && (t.effects[s.id] = t.createChild("li"), t.effects[s.id].setText(r), t.effects[s.id].currentStatDescription = r, t.effects[s.id].isPreview = !1, s.bonusType === -1 ? t.effects[s.id].addClassNames("malus") : 1 === s.bonusType && t.effects[s.id].addClassNames("bonus"));
      }
    }
    this._effectsList = t;
  }
};
n.prototype._loadSpellData = function (e, t) {
  if (!e) {
    return t();
  }
  var i = this.loadedSpells;
  l.createSpells(e, function (e, n) {
    if (e) {
      return t(e);
    }
    n = l.sortSpells(n, "minPlayerLevel");
    for (var o = 0; o < n.length; o += 1) {
      var a = n[o];
      i[a.id] = a;
    }
    t();
  });
};
n.prototype._updateSpell = function (e) {
  this._spellSlot.addClassNames("spinner");
  var t = this;
  this._loadSpellData(e, function (i) {
    if (i) {
      return console.error(i);
    }
    var n = t.loadedSpells[e];
    t._spellSlot.setSpell(n, _);
  });
  this._spellSlot.delClassNames("spinner");
};
n.prototype._updateLevel = function () {
  this._shieldLvl.setText(s("ui.common.shieldRank", this._shield.level));
};
n.prototype._calculateXP = function (e, t) {
  return 1e4 * e + t;
};
n.prototype._updateXP = function () {
  var e = window.gui.databases.ShieldModelsLevels[this._shield.model].requiredXpLevels,
    t = e[Math.min(99, this._shield.level)],
    i = e[Math.min(99, this._shield.level) - 1];
  this._xpDetails.setText(this._shield.currentXP + " / " + t);
  this._xpbar.setValues([(this._shield.currentXP - i) / (t - i), 0]);
};
n.prototype._setXpPreview = function (e) {
  this._resetPreview();
  for (var t = window.gui.databases.ShieldModelsLevels[this._shield.model].requiredXpLevels, i = t[Math.min(99, this._shield.level)], n = t[Math.min(99, this._shield.level) - 1], o = e + this._shield.currentXP, a = 0, s = (this._shield.currentXP - n) / (i - n), r = (o - n) / (i - n); this._shield.level < 100 && t[this._shield.level + a] <= o;) {
    a++;
  }
  var l = Math.min(e, t[99] - this._shield.currentXP);
  if (a) {
    this._shieldLvlPreview.setText("( + " + a + " )");
    var c = this._shield.bonusesPerLevel;
    if (c) {
      for (var d, u = 0, h = 0; h < c.length; h++) {
        d = Math.floor(c[h].bonusRatio * (a + this._shield.level));
        u = Math.floor(c[h].bonusRatio * this._shield.level);
        var m = d - u;
        if (m > 1) {
          var f = this._effectsList.effects[c[h].effectId];
          if (f) {
            var g = f.currentStatDescription;
            f.setText(g + " ( +" + m + " )");
          } else {
            var _ = this._effectsList.createChild("li");
            _.isPreview = !0;
            _.setText("( " + p(c[h].descriptionId, m) + " )");
          }
        }
      }
    }
  }
  this._xpbar.reached100.toggleClassName("off", a < 1);
  this._xpDetailsPreview.setText("( + " + l + " )");
  this._xpbar.setValues([s, r]);
};
n.prototype._resetPreview = function () {
  this._shieldLvlPreview.clearContent();
  this._xpDetailsPreview.clearContent();
  this._xpbar.reached100.addClassNames("off");
  this._effectsList.getChildren().forEach(function (e) {
    e.isPreview ? e.destroy() : e.setText(e.currentStatDescription);
  });
};
n.prototype._updateShieldInformations = function (e) {
  var t = this,
    i = e.effectsMap[u.ACTION_CAST_STARTING_SPELL],
    n = e.effectsMap[u.ACTION_SHIELD_EXPERIENCE];
  i && t._updateSpell(i.diceNum);
  n && (t._shield.currentXP = t._calculateXP(n.diceSide, n.value), t._shield.level = n.diceNum, t._updateXP(), t._updateLevel());
  this._shieldBg.setStyle("backgroundImage", e.item.image);
  this._shieldName.setText(e.getProperty("nameId"));
  this._setEffectsList(e.effects);
};
n.prototype._updateTutorialShieldInformations = function (e) {
  this._updateSpell(v);
  var t = window.gui.playerData.isShieldTutorialFortified();
  this._shield.currentXP = t ? this._calculateXP(0, 2500) : this._calculateXP(0, 0);
  this._shield.level = t ? 35 : 1;
  this._updateXP();
  this._updateLevel();
  this._shieldBg.setStyle("backgroundImage", e.item.image);
  this._shieldName.setText(e.getProperty("nameId"));
  this._setEffectsList(e.effects);
};
n.prototype.setNewShield = function (e) {
  this._shield = {
    shieldUID: e.objectUID,
    model: e.item.shieldModelId,
    bonusesPerLevel: e.item.shieldBonuses
  };
  var t = {
    itemInstance: e,
    mode: "shield"
  };
  this.feedingBox.update(t);
  this._resetPreview();
  this.feedingBox.reset();
  this._setEffectsList(e.effects);
  this._updateShieldInformations(e);
};
n.prototype.getShieldSpellSlot = function () {
  return this._spellSlot;
};
this._shieldBg = o.createChild("div", {
  className: "ShieldImg"
});
h(this._shieldBg, {
  repeatDelay: 1,
  doubletapTimeout: 1
});
this._shieldBg.on("tap", function () {
  t._isTutorial || m.open("ShieldSelectionWindow", t._shield.shieldUID);
});
this._shieldsListButton = this._shieldBg.createChild("div", {
  className: "shieldsListButton"
});
this._shieldLvl = l.createChild("div", {
  className: "ShieldLvl"
});
this._shieldLvlPreview = l.createChild("div", {
  className: "ShieldLvlPreview"
});
f.setText(s("ui.common.experiment") + s("ui.common.colon"));
this._xpbar = p.appendChild(new d({
  valueClassNames: ["oldXp", "gainedXp"]
}));
this._xpbar.reached100 = this._xpbar.createChild("div", {
  className: "reached100"
});
this._xpbar.reached100.addClassNames("off");
this._xpDetails = g.createChild("div", {
  className: "xpDetails"
});
this._xpDetailsPreview = g.createChild("div", {
  className: "xpDetailsPreview"
});
u.createChild("div", {
  className: "effectsLabel",
  text: s("ui.effects") + s("ui.common.colon")
});
this._effects = u.createChild("div", {
  className: "effectsList"
});
this.feedingBox.init(n);
this._loadSpellData(e, function (i) {
  if (i) {
    return console.error(i);
  }
  var n = t.loadedSpells[e];
  t._spellSlot.setSpell(n, _);
});
this._spellSlot.delClassNames("spinner");
this._xpDetails.setText(this._shield.currentXP + " / " + t);
this._xpbar.setValues([(this._shield.currentXP - i) / (t - i), 0]);
d = Math.floor(c[h].bonusRatio * (a + this._shield.level));
u = Math.floor(c[h].bonusRatio * this._shield.level);
_.isPreview = !0;
_.setText("( " + p(c[h].descriptionId, m) + " )");
this._xpbar.reached100.toggleClassName("off", a < 1);
this._xpDetailsPreview.setText("( + " + l + " )");
this._xpbar.setValues([s, r]);
this._shieldLvlPreview.clearContent();
this._xpDetailsPreview.clearContent();
this._xpbar.reached100.addClassNames("off");
this._effectsList.getChildren().forEach(function (e) {
  e.isPreview ? e.destroy() : e.setText(e.currentStatDescription);
});
i && t._updateSpell(i.diceNum);
n && (t._shield.currentXP = t._calculateXP(n.diceSide, n.value), t._shield.level = n.diceNum, t._updateXP(), t._updateLevel());
this._shieldBg.setStyle("backgroundImage", e.item.image);
this._shieldName.setText(e.getProperty("nameId"));
this._setEffectsList(e.effects);
this._shield.currentXP = t ? this._calculateXP(0, 2500) : this._calculateXP(0, 0);
this._shield.level = t ? 35 : 1;
this._updateXP();
this._updateLevel();
this._shieldBg.setStyle("backgroundImage", e.item.image);
this._shieldName.setText(e.getProperty("nameId"));
this._setEffectsList(e.effects);
this.feedingBox.update(t);
this._resetPreview();
this.feedingBox.reset();
this._setEffectsList(e.effects);
this._updateShieldInformations(e);
r.call(this, {
  title: a("ui.shield.interfaceTitle"),
  className: "ShieldSelectionWindow",
  positionInfo: {
    right: "c",
    bottom: "c",
    width: 400,
    height: 490,
    mustAvoidToolbar: !0
  }
});
this.once("opened", function () {
  this._createDom();
});
this.on("opened", function (e) {
  this._currentShieldUID = e;
  this._reset();
  this._update();
});
this.on("close", function () {
  this._removeFilter();
});
this.on("closed", function () {
  this._unloadContent();
});
this.on("slot-tap", function (e) {
  this._selectItem(e.itemInstance);
});
this.on("itemRemoved", function () {
  this._reset();
});
this.storageViewer = new u({
  enablePresets: !1,
  dataHandler: window.gui.playerData.inventory,
  enableLookAllObjects: !0
});
this.storageViewer.registerView(this, {
  manualOpening: !0,
  enableSlotContext: !1
});
this._currentShieldUID = e;
this._reset();
this._update();
s(n, r);
n.prototype._filterShield = function (e) {
  return e.isShieldManageable() && this._currentShieldUID !== e.objectUID;
};
n.prototype._update = function () {
  function e(e) {
    return e.isShieldManageable() && t !== e.objectUID;
  }
  var t = this._currentShieldUID;
  this._filter = e;
  this.storageViewer.addFilters([this._filter]);
  var i = o();
  this.storageViewer.setItemList(i);
};
n.prototype._unloadContent = function () {
  this.storageViewer.unloadContent();
};
n.prototype._removeFilter = function () {
  this.storageViewer.removeFilter(this._filter);
};
n.prototype._reset = function () {
  this.placeHolder.setText(a("ui.common.selectItem"));
  this.itemSelected = null;
  this.itemBox.hide();
  this.confirmBtn.disable();
};
n.prototype._createDom = function () {
  var e = this;
  this.viewerBox = this.windowBody.createChild("div", {
    className: "viewer"
  });
  this.viewerBox.appendChild(e.storageViewer.storageUI);
  var t = this.windowBody.createChild("div", {
    className: "itemBox"
  });
  this.itemBox = t.appendChild(new c({
    showTitle: !0
  }));
  this.placeHolder = new d(t);
  this.confirmBtn = this.windowBody.appendChild(new l({
    text: a("ui.common.validation"),
    className: ["greenButton", "confirm"]
  }));
  this.confirmBtn.on("tap", function () {
    h.getWindow("shieldWindow").setNewShield(e.itemSelected);
    h.close("ShieldSelectionWindow");
  });
};
n.prototype._selectItem = function (e) {
  this.itemSelected = e;
  this.itemBox.displayItem(e);
  this.itemBox.show();
  this.placeHolder.setText(null);
  this.confirmBtn.enable();
};
e.exports = n;
this._filter = e;
this.storageViewer.addFilters([this._filter]);
this.placeHolder.setText(a("ui.common.selectItem"));
this.itemSelected = null;
this.itemBox.hide();
this.confirmBtn.disable();
this.viewerBox = this.windowBody.createChild("div", {
  className: "viewer"
});
this.viewerBox.appendChild(e.storageViewer.storageUI);
this.itemBox = t.appendChild(new c({
  showTitle: !0
}));
this.placeHolder = new d(t);
this.confirmBtn = this.windowBody.appendChild(new l({
  text: a("ui.common.validation"),
  className: ["greenButton", "confirm"]
}));
this.confirmBtn.on("tap", function () {
  h.getWindow("shieldWindow").setNewShield(e.itemSelected);
  h.close("ShieldSelectionWindow");
});
h.getWindow("shieldWindow").setNewShield(e.itemSelected);
h.close("ShieldSelectionWindow");
this.itemSelected = e;
this.itemBox.displayItem(e);
this.itemBox.show();
this.placeHolder.setText(null);
this.confirmBtn.enable();
a.call(this, {
  className: "HelpWindow",
  title: s("ui.helpWindow.title"),
  positionInfo: {
    left: "c",
    top: "c",
    width: "90%",
    height: "97%",
    maxWidth: 905,
    maxHeight: 620,
    mustAvoidToolbar: !0
  }
});
this.once("open", function () {
  this._setupDom();
});
this.on("open", function (e) {
  void 0 !== e.part && void 0 !== e.subPart && _[e.part] && _[e.part].subParts[e.subPart] && (f = e.part, g = e.subPart);
  this._setContent();
});
void 0 !== e.part && void 0 !== e.subPart && _[e.part] && _[e.part].subParts[e.subPart] && (f = e.part, g = e.subPart);
this._setContent();
o(n, a);
e.exports = n;
n.prototype._getDopeulsData = function () {
  for (var e = ["20", "40", "60", "80", "100", "120", "140", "160", "180", "200"], t = ["1", "2", "3", "5", "6", "8", "10", "12", "14", "17"], i = ["2450", "8100", "18150", "33800", "56250", "86700", "126350", "176400", "238050", "312500"], n = ["1400", "3600", "6600", "10400", "15000", "20400", "26600", "33600", "41400", "50000"], o = {}, a = 0; a < 10; a += 1) {
    o[a] = {
      level: e[a],
      nbrDoplon: t[a],
      expPerQuest: i[a],
      expPerFight: n[a]
    };
  }
  return o;
};
n.prototype._setupDom = function () {
  this.body = this.windowBody.createChild("div", {
    className: "helpBody"
  });
  var e = this.body.createChild("div", {
      className: "col1"
    }),
    t = this.body.createChild("div", {
      className: "col2"
    });
  e.createChild("div", {
    className: "col1Header",
    text: s("ui.helpWindow.menuTitle")
  });
  var i = this._summaryList = e.appendChild(new l({
    className: "tree"
  }));
  i.on("selected", function (e) {
    e.sublist.show();
    r("TAB");
    i.refresh();
    i.scrollToElement(e);
  });
  i.on("deselected", function (e) {
    e.sublist.hide();
    i.refresh();
  });
  this._createPart(i);
  var n = this._mainScroller = t.appendChild(new c({
      className: "col2Scroller"
    })),
    o = n.content.createChild("div", {
      className: "scrollBlock"
    });
  this._title = o.createChild("h2", {
    className: "contentTitle"
  });
  this._content = o.createChild("div", {
    className: "content"
  });
};
n.prototype._createPart = function (e) {
  function t() {
    n._resetSelectedSubCatElement();
    this.addClassNames("selected");
    n.selectedSubCatElement = this;
    f = this.i;
    g = this.j;
    n._setContent();
    n._mainScroller.goToTop();
  }
  function i(e) {
    for (var t = 0; t < e.length; t++) {
      if (window.Config.language === e[t]) {
        return !1;
      }
    }
    return !0;
  }
  var n = this;
  this._stepsLabel = [];
  for (var o = 0; o < _.length; o++) {
    var a = _[o],
      r = new d("div", {
        className: "label",
        name: "part" + o
      });
    r.createChild("div", {
      className: "arrow"
    });
    n._stepsLabel.push({
      element: r.createChild("div", {
        className: "text",
        text: s(a.title)
      })
    });
    var l = e.addItem({
      id: o,
      element: r
    }, {
      noRefresh: !0
    });
    l.sublist = l.appendChild(new d("div", {
      className: "sublist"
    }));
    for (var c = 0; c < a.subParts.length; c++) {
      var h = a.subParts[c];
      if (i(h.forbiddenLanguages)) {
        var p = new d("div", {
          className: "label",
          name: "subpart" + o + c
        });
        p.createChild("div", {
          className: "text",
          text: s(h.title)
        });
        l.sublist.appendChild(p);
        p.i = o;
        p.j = c;
        u(p);
        p.on("tap", t);
      }
    }
    l.sublist.hide();
  }
};
n.prototype._setContent = function () {
  if (this._title.clearContent(), this._content.clearContent(), f !== -1 && g !== -1) {
    if (this._title.setText(s(_[f].subParts[g].title)), 1 === f && 15 === g) {
      this._content.appendChild(this._formatLinks(s(_[f].subParts[g].text)));
      var e = [{
          id: "level",
          header: s("ui.helpWindow.category2sub16table1"),
          sort: !1
        }, {
          id: "nbrDoplon",
          header: s("ui.helpWindow.category2sub16table2"),
          sort: !1
        }, {
          id: "expPerQuest",
          header: s("ui.helpWindow.category2sub16table3"),
          sort: !1
        }, {
          id: "expPerFight",
          header: s("ui.helpWindow.category2sub16table4"),
          sort: !1
        }],
        t = this._getDopeulsData();
      this._content.table = this._content.appendChild(new h(e, !1, {
        clickable: !1
      }));
      this._content.table.scroller.setEnable(!1);
      this._content.table.addMap(t);
      this._content.appendChild(this._formatLinks(s("ui.helpWindow.category2sub16text2")));
    } else {
      this._content.appendChild(this._formatLinks(s(_[f].subParts[g].text)));
    }
  } else {
    this._content.setText(s("ui.helpWindow.defaultText"));
  }
  this._mainScroller.refresh();
};
n.prototype._formatLinks = function (e) {
  function t(e, t) {
    e.addEventListener(p.end, function (e) {
      m.openUrlInAppBrowser(t);
      e.preventDefault();
    });
  }
  var i = e.replace(/\\n/g, ""),
    n = new d("div");
  n.setHtml(i);
  for (var o, a, s = n.rootElement.getElementsByTagName("a"), r = 0; r < s.length; r++) {
    o = s[r];
    a = o.href;
    t(o, a);
  }
  return n;
};
n.prototype._resetSelectedSubCatElement = function () {
  this.selectedSubCatElement && (this.selectedSubCatElement.delClassNames("selected"), this.selectedSubCatElement = null);
};
i.on("selected", function (e) {
  e.sublist.show();
  r("TAB");
  i.refresh();
  i.scrollToElement(e);
});
i.on("deselected", function (e) {
  e.sublist.hide();
  i.refresh();
});
this._createPart(i);
e.sublist.show();
r("TAB");
i.refresh();
i.scrollToElement(e);
e.sublist.hide();
i.refresh();
this._title = o.createChild("h2", {
  className: "contentTitle"
});
this._content = o.createChild("div", {
  className: "content"
});
n._resetSelectedSubCatElement();
this.addClassNames("selected");
n.selectedSubCatElement = this;
f = this.i;
g = this.j;
n._setContent();
n._mainScroller.goToTop();
r.createChild("div", {
  className: "arrow"
});
n._stepsLabel.push({
  element: r.createChild("div", {
    className: "text",
    text: s(a.title)
  })
});
p.createChild("div", {
  className: "text",
  text: s(h.title)
});
l.sublist.appendChild(p);
p.i = o;
p.j = c;
u(p);
p.on("tap", t);
this._content.table = this._content.appendChild(new h(e, !1, {
  clickable: !1
}));
this._content.table.scroller.setEnable(!1);
this._content.table.addMap(t);
this._content.appendChild(this._formatLinks(s("ui.helpWindow.category2sub16text2")));
m.openUrlInAppBrowser(t);
e.preventDefault();
o = s[r];
a = o.href;
t(o, a);
this._domCreated = !1;
this._stepNumber = -1;
this._retryError = null;
this._logic = new c();
this._message = t.createChild("div", {
  className: "message"
});
this.on("open", function (t) {
  e._domCreated || e._createDom();
  e._retryError = null;
  e._stepNumber = t.stepNumber;
  e._enableButtons(!0);
  e.setTitle(r("ui.toa.retryTitle"));
  window.gui.gifts.getToaRetryPendingUid().length ? e._message.setText(r("ui.toa.retryOwned")) : e._message.setText(r("ui.toa.retryMessage", s.TOA_RETRY_HC_PRICE));
});
e._domCreated || e._createDom();
e._retryError = null;
e._stepNumber = t.stepNumber;
e._enableButtons(!0);
e.setTitle(r("ui.toa.retryTitle"));
window.gui.gifts.getToaRetryPendingUid().length ? e._message.setText(r("ui.toa.retryOwned")) : e._message.setText(r("ui.toa.retryMessage", s.TOA_RETRY_HC_PRICE));
o(n, d);
e.exports = n;
n.prototype._createDom = function () {
  var e = this,
    t = this.windowBody.createChild("div", {
      className: "buttonContainer"
    });
  this._buttonYes = t.appendChild(new a({
    text: s.TOA_RETRY_HC_PRICE.toString(),
    addIcon: "after",
    className: ["button", "buttonYes"]
  }, function () {
    e._enableButtons(!1);
    e._buy();
  }));
  this._buttonNo = t.appendChild(new a({
    text: r("ui.common.no"),
    className: ["button", "buttonNo"]
  }, function () {
    e._retryError && l.error("ToaRetryPopup retry cancelled", e._retryError);
    u.close(e.id);
  }));
  this._setupListeners(window.gui);
  this._domCreated = !0;
};
n.prototype._buy = function () {
  var e = this;
  this._retryError = null;
  this._logic.buy(this._stepNumber, window.gui.playerData.inventory, function (t, i) {
    e._buyCallback(t, i);
  });
};
n.prototype._buyCallback = function (e, t) {
  return e ? e.message === this._logic.NEED_HC ? void this._enableButtons(!0) : e.message === this._logic.ALREADY_IN_PROGRESS ? void l.warning("ToaRetryPopup: already in process") : e.message === this._logic.GET_STORE_INFOS_ERROR ? (this._enableButtons(!0), void this._retry(e)) : e.message === this._logic.CANNOT_ASSIGN_PENDING_RETRY ? (this._enableButtons(!0), window.gui.openPopup({
    title: r("ui.common.error"),
    message: r("tablet.shop.couldNotBuy") + " (code: caprerr)"
  }), l.error("ToaRetryPopup buy (caprerr)", e), void u.close(this.id)) : e.message === this._logic.GIFT_TIMEOUT ? (this._enableButtons(!0), window.gui.openPopup({
    title: r("tablet.gift.unableToAssignTitle"),
    message: r("tablet.gift.unableToAssign") + " (code: gterr)"
  }), l.error("ToaRetryPopup buy (gterr)", e), void u.close(this.id)) : (this._enableButtons(!0), window.gui.openPopup({
    title: r("ui.common.error"),
    message: r("tablet.shop.couldNotBuy") + " (code: genbuyerr)"
  }), l.error("ToaRetryPopup buy (genbuyerr)", e), void u.close(this.id)) : (window.dofus.sendMessage("ContinueTowerOfAscensionWithCreditRequestMessage", {
    stepNumber: t
  }), this._enableButtons(!0), void u.close(this.id));
};
n.prototype._setupListeners = function (e) {
  this._logic.initialize(e.gifts);
};
n.prototype._enableButtons = function (e) {
  return e ? (this._buttonYes.enable(), this._buttonNo.enable(), void this._buttonYes.delClassNames("spinner")) : (this._buttonYes.disable(), this._buttonNo.disable(), void this._buttonYes.addClassNames("spinner"));
};
n.prototype._retry = function (e) {
  this.setTitle(r("ui.common.error"));
  this._message.setText(r("ui.popup.accessDenied.serviceUnavailable") + " " + r("tablet.common.askRetry"));
  this._retryError = e;
};
this._buttonYes = t.appendChild(new a({
  text: s.TOA_RETRY_HC_PRICE.toString(),
  addIcon: "after",
  className: ["button", "buttonYes"]
}, function () {
  e._enableButtons(!1);
  e._buy();
}));
this._buttonNo = t.appendChild(new a({
  text: r("ui.common.no"),
  className: ["button", "buttonNo"]
}, function () {
  e._retryError && l.error("ToaRetryPopup retry cancelled", e._retryError);
  u.close(e.id);
}));
this._setupListeners(window.gui);
this._domCreated = !0;
e._enableButtons(!1);
e._buy();
e._retryError && l.error("ToaRetryPopup retry cancelled", e._retryError);
u.close(e.id);
this._retryError = null;
this._logic.buy(this._stepNumber, window.gui.playerData.inventory, function (t, i) {
  e._buyCallback(t, i);
});
this.setTitle(r("ui.common.error"));
this._message.setText(r("ui.popup.accessDenied.serviceUnavailable") + " " + r("tablet.common.askRetry"));
this._retryError = e;
this._cb = null;
this._inventory = null;
this._actionIdMap = {};
this._giftModule = null;
this._giftTimeout = null;
this._stepNumber = -1;
n.prototype.STEP_NUMBER_IS_NOT_A_VALID_NUMBER = "stepNumberIsNotAValidNumber";
n.prototype.GET_STORE_INFOS_ERROR = "storeInfosFailed";
n.prototype.ALREADY_IN_PROGRESS = "alreadyInProgress";
n.prototype.NEED_HC = "needHardCurrency";
n.prototype.CANNOT_ASSIGN_PENDING_RETRY = "cannotAssignPendingRetry";
n.prototype.GIFT_TIMEOUT = "giftTimeout";
e.exports = n;
n.prototype.initialize = function (e) {
  function t(e) {
    if (e.length) {
      for (var t = 0; t < e.length; t += 1) {
        for (var n = e[t], o = n.uid, a = n.items || [], s = null, r = 0; r < a.length; r += 1) {
          if (a[r].objectGID === l.TOA_RETRY_ITEM_ID) {
            s = a[r];
            break;
          }
        }
        s && (i._actionIdMap[o] = !0);
      }
    }
  }
  var i = this;
  this._giftModule = e;
  o.on("StartupActionsListMessage", function (e) {
    t(e.actions);
  });
  o.on("StartupActionAddMessage", function (e) {
    t([e.newAction]);
  });
  o.on("toaContinueError", function (e) {
    if ("PAIDFAILED" === e.reason) {
      var t = i._inventory.goultines;
      return a.openNotEnoughHardCurrencyPopup(l.TOA_RETRY_HC_PRICE - t), i._fireCallbackAndClean(new Error(i.NEED_HC));
    }
    return i._fireCallbackAndClean(e);
  });
  e.on("giftAssignRequestResult", function (e) {
    if (i._actionIdMap[e.actionId]) {
      return delete i._actionIdMap[e.actionId], i._fireCallbackAndClean();
    }
  });
  o.on("toaContinueSuccess", function () {
    i._startGiftTimeout();
    s.send("moneyGoultinesAmountRequest");
  });
};
n.prototype.buy = function (e, t, i) {
  var n = this;
  if (this._cb) {
    return i(new Error(n.ALREADY_IN_PROGRESS));
  }
  var o = e === parseInt((e || 0).toString(), 10);
  if (!e || !o || e < 0) {
    return i(new Error(this.STEP_NUMBER_IS_NOT_A_VALID_NUMBER + ": " + e));
  }
  if (this._stepNumber = e, this._inventory = t, this._cb = i, this._giftModule.getToaRetryPendingUid().length) {
    var r = this._giftModule.getToaRetryPendingUid()[0];
    this._actionIdMap[r] = !0;
    var c = this._giftModule.assignPendingToaRetry(r);
    if (!c) {
      return this._fireCallbackAndClean(new Error(n.CANNOT_ASSIGN_PENDING_RETRY));
    }
  } else {
    this._giftModule.setAutoAssign(!0);
    a.getStoreInfos(function (e) {
      if (e) {
        return n._fireCallbackAndClean(new Error(n.GET_STORE_INFOS_ERROR));
      }
      var t = n._inventory.goultines;
      return t - l.TOA_RETRY_HC_PRICE < 0 ? (a.openNotEnoughHardCurrencyPopup(l.TOA_RETRY_HC_PRICE - t), n._fireCallbackAndClean(new Error(n.NEED_HC))) : void s.send("toaContinue", {
        goultinesAmount: t
      });
    });
  }
};
n.prototype._fireCallbackAndClean = function (e) {
  this._cb ? this._cb(e, this._stepNumber) : r.error(new Error("ToaRetryPopupLogic: cb is falsy"));
  this._inventory = null;
  this._cb = null;
  this._stepNumber = -1;
  this._actionIdMap = {};
  this._giftModule.setAutoAssign(!1);
  this._stopGiftTimeout();
};
n.prototype._startGiftTimeout = function () {
  var e = this;
  this._giftTimeout = setTimeout(function () {
    e._fireCallbackAndClean(new Error(e.GIFT_TIMEOUT));
  }, l.TOA_RETRY_TIMEOUT);
};
n.prototype._stopGiftTimeout = function () {
  clearTimeout(this._giftTimeout);
};
this._giftModule = e;
o.on("StartupActionsListMessage", function (e) {
  t(e.actions);
});
o.on("StartupActionAddMessage", function (e) {
  t([e.newAction]);
});
o.on("toaContinueError", function (e) {
  if ("PAIDFAILED" === e.reason) {
    var t = i._inventory.goultines;
    return a.openNotEnoughHardCurrencyPopup(l.TOA_RETRY_HC_PRICE - t), i._fireCallbackAndClean(new Error(i.NEED_HC));
  }
  return i._fireCallbackAndClean(e);
});
e.on("giftAssignRequestResult", function (e) {
  if (i._actionIdMap[e.actionId]) {
    return delete i._actionIdMap[e.actionId], i._fireCallbackAndClean();
  }
});
o.on("toaContinueSuccess", function () {
  i._startGiftTimeout();
  s.send("moneyGoultinesAmountRequest");
});
i._startGiftTimeout();
s.send("moneyGoultinesAmountRequest");
this._giftModule.setAutoAssign(!0);
a.getStoreInfos(function (e) {
  if (e) {
    return n._fireCallbackAndClean(new Error(n.GET_STORE_INFOS_ERROR));
  }
  var t = n._inventory.goultines;
  return t - l.TOA_RETRY_HC_PRICE < 0 ? (a.openNotEnoughHardCurrencyPopup(l.TOA_RETRY_HC_PRICE - t), n._fireCallbackAndClean(new Error(n.NEED_HC))) : void s.send("toaContinue", {
    goultinesAmount: t
  });
});
this._cb ? this._cb(e, this._stepNumber) : r.error(new Error("ToaRetryPopupLogic: cb is falsy"));
this._inventory = null;
this._cb = null;
this._stepNumber = -1;
this._actionIdMap = {};
this._giftModule.setAutoAssign(!1);
this._stopGiftTimeout();
s.call(this, {
  className: "DailyQuestRerollWindow",
  title: a("ui.dailyQuest.buyRetry"),
  positionInfo: {
    left: "c",
    top: "c",
    width: 555,
    height: 350
  }
});
this._articleMap = {};
this.spinner = new c(this);
this.once("open", function () {
  e._createDom();
});
this.on("open", function () {
  this._view.clearItems();
  this._view.setSpinnerVisible(!0);
  this._getCategoryInfo();
});
t.on("shopOpenCategorySuccess", function (t) {
  t.categoryId === p && e._loadCategory(t);
});
this._view.clearItems();
this._view.setSpinnerVisible(!0);
this._getCategoryInfo();
o(n, s);
e.exports = n;
n.prototype._createDom = function () {
  function e(e, i) {
    r.purchaseArticleOnAnkama(t._articleMap[e], i);
  }
  var t = this,
    i = this.windowBody.createChild("div", {
      className: "header"
    });
  this._wallet = i.appendChild(new d({
    emitTap: !0
  }));
  this._wallet.on("moreGoultinesTap", function () {
    u.open("market", {
      tabId: "shop",
      tabParams: {
        category: "goultines"
      }
    });
  });
  this._view = this.windowBody.appendChild(new l());
  this._view.on("purchaseOnAnkama", e);
};
n.prototype._loadCategory = function (e) {
  var t = this._view;
  if (0 === e.totalArticles) {
    return void t.showNoResult(a("ui.dailyQuest.premiumReroll"), ~~e.categoryId);
  }
  for (var i = r.validateArticles(e.articles), n = 0; n < i.length; n++) {
    var o = i[n];
    this._articleMap[o.id] = o;
  }
  t.addArticles(i);
  this._view.setSpinnerVisible(!1);
};
n.prototype._requestPageOfCategory = function (e, t) {
  var i = {
      categoryId: e,
      page: t
    },
    n = function () {
      window.dofus.send("shopOpenCategoryRequest", i);
    };
  window.clearTimeout(this.requestTimeout);
  var o = Date.now(),
    a = o - this.requestTimestamp;
  a > h ? n() : this.requestTimeout = window.setTimeout(n, h - a);
  this.requestTimestamp = o;
};
n.prototype._getCategoryInfo = function () {
  function e(e) {
    console.error(e);
    t._view.setSpinnerVisible(!1);
    t.openState && t._showErrorPopup();
  }
  var t = this;
  r.getStoreInfos(function (i) {
    return i ? e(i) : void t._requestPageOfCategory(p, 1);
  });
};
n.prototype._showErrorPopup = function () {
  var e = this;
  u.getWindow("confirm").update({
    title: a("ui.common.error"),
    message: a("ui.popup.accessDenied.serviceUnavailable") + " " + a("tablet.common.askRetry"),
    cb: function (t) {
      return t ? e._getCategoryInfo() : e.close();
    }
  });
  u.openDialog(["confirm"]);
};
this._wallet = i.appendChild(new d({
  emitTap: !0
}));
this._wallet.on("moreGoultinesTap", function () {
  u.open("market", {
    tabId: "shop",
    tabParams: {
      category: "goultines"
    }
  });
});
this._view = this.windowBody.appendChild(new l());
this._view.on("purchaseOnAnkama", e);
t.addArticles(i);
this._view.setSpinnerVisible(!1);
a > h ? n() : this.requestTimeout = window.setTimeout(n, h - a);
this.requestTimestamp = o;
console.error(e);
t._view.setSpinnerVisible(!1);
t.openState && t._showErrorPopup();
u.getWindow("confirm").update({
  title: a("ui.common.error"),
  message: a("ui.popup.accessDenied.serviceUnavailable") + " " + a("tablet.common.askRetry"),
  cb: function (t) {
    return t ? e._getCategoryInfo() : e.close();
  }
});
u.openDialog(["confirm"]);
s.call(this, {
  className: "PromotionPopup",
  positionInfo: {
    left: "c",
    top: "c",
    width: 600,
    height: 200
  }
});
this._createDom();
o(n, s);
e.exports = n;
n.prototype._createDom = function () {
  var e = this,
    t = this.windowBody.createChild("div", {
      className: "messageBox"
    });
  this.setTitle(r("tablet.popup.promotionPopup.title"));
  t.createChild("div", {
    className: "message"
  }).setHtml(r("tablet.popup.promotionPopup.content"));
  var i = this.windowBody.createChild("div", {
    className: "buttonContainer"
  });
  i.appendChild(new a({
    text: r("tablet.popup.promotionPopup.button"),
    className: ["button", "buttonNo"]
  }, function () {
    l.close(e.id);
    l.open("market", {
      tabId: "shop"
    });
  }));
};
this.setTitle(r("tablet.popup.promotionPopup.title"));
t.createChild("div", {
  className: "message"
}).setHtml(r("tablet.popup.promotionPopup.content"));
l.close(e.id);
l.open("market", {
  tabId: "shop"
});
s.call(this, {
  className: "BonusPackElitePopup",
  positionInfo: {
    left: "c",
    top: "c",
    width: 600,
    height: 200
  }
});
this._createDom();
o(n, s);
e.exports = n;
n.prototype._createDom = function () {
  var e = this;
  this.setTitle(r("ui.popup.information"));
  var t = this.windowBody.createChild("div", {
    className: "messageBox"
  });
  t.createChild("div", {
    className: "message",
    text: r("ui.shop.needBonusPackElite")
  });
  var i = this.windowBody.createChild("div", {
      className: "buttonContainer"
    }),
    n = i.appendChild(new a({
      text: r("ui.common.ok"),
      className: ["button"]
    }));
  n.on("tap", function () {
    l.close(e.id);
    l.open("market", {
      tabId: "shop",
      tabParams: {
        category: "bonuspack"
      }
    });
  });
};
l.close(e.id);
l.open("market", {
  tabId: "shop",
  tabParams: {
    category: "bonuspack"
  }
});
d.call(this, {
  className: "MarketingWindow",
  positionInfo: {
    left: "c",
    top: "c",
    width: 500,
    height: f
  }
});
this._popupInfo = {};
this._shopRedirection = !1;
this.promoImg = this.windowBody.createChild("div", {
  className: "promoImg"
});
this._description = this.windowBody.createChild("div", {
  className: "description"
});
this.scroll = this._description.appendChild(new l({
  className: "scroll"
}));
this.scrollContent = this.scroll.content.createChild("div", {
  className: "scrollContent"
});
this.validateBtn = this.windowBody.createChild("div", {
  className: "buttonContainer"
}).appendChild(new a({
  className: "greenButton"
}, function () {
  e._popupInfo.articleId ? (u.close("market"), u.open("market", {
    tabId: "shop",
    tabParams: {
      articleId: e._popupInfo.articleId
    }
  }), e._shopRedirection = !0) : e._popupInfo.link && m.openUrlInAppBrowser(e._popupInfo.link);
  e.close();
}));
this.on("open", function (e) {
  this._updateContent(e);
});
this.on("close", function () {
  this._popupInfo.articleId && p.log("HUD.marketing_window", {
    consult: this._shopRedirection,
    article_id: this._popupInfo.articleId
  });
  this._popupInfo = {};
  this._shopRedirection = !1;
});
e._popupInfo.articleId ? (u.close("market"), u.open("market", {
  tabId: "shop",
  tabParams: {
    articleId: e._popupInfo.articleId
  }
}), e._shopRedirection = !0) : e._popupInfo.link && m.openUrlInAppBrowser(e._popupInfo.link);
e.close();
this._popupInfo.articleId && p.log("HUD.marketing_window", {
  consult: this._shopRedirection,
  article_id: this._popupInfo.articleId
});
this._popupInfo = {};
this._shopRedirection = !1;
o(n, d);
e.exports = n;
n.prototype._updateContent = function (e) {
  this.setTitle(e.name);
  var t = e.external_article || {},
    i = e.image || [];
  this._popupInfo = {
    popupId: e.id,
    articleId: t.id,
    link: e.link
  };
  this.validateBtn.setText(r("ui.popup.shopMarketingConfirm"));
  e.description ? (this.setStyle("height", f + "px"), this._description.setStyle("height", g + "px"), this._description.show()) : (this.setStyle("height", f - g + "px"), this._description.setStyle("height", 0), this._description.hide());
  var n = i.length - 1,
    o = (i[n] || {}).url || "none";
  this.promoImg.setStyle("backgroundImage", s(o));
  this.scrollContent.setHtml(e.description);
  this.scroll.refresh();
  var a = window.gui.playerData.ShopData.getPromoDisplayUserPrefKey(),
    l = c.getValue(a, {});
  l[this._popupInfo.popupId] = h.now();
  c.setValue(a, l);
};
this._popupInfo = {
  popupId: e.id,
  articleId: t.id,
  link: e.link
};
this.validateBtn.setText(r("ui.popup.shopMarketingConfirm"));
e.description ? (this.setStyle("height", f + "px"), this._description.setStyle("height", g + "px"), this._description.show()) : (this.setStyle("height", f - g + "px"), this._description.setStyle("height", 0), this._description.hide());
this.promoImg.setStyle("backgroundImage", s(o));
this.scrollContent.setHtml(e.description);
this.scroll.refresh();
l[this._popupInfo.popupId] = h.now();
c.setValue(a, l);
l.call(this, {
  title: s("ui.popup.ratingTitle"),
  className: "RatingWindow",
  positionInfo: {
    left: "c",
    top: "c",
    width: 500,
    height: 200
  }
});
this.on("open", function () {
  e._initialize();
  e._reset();
});
this.on("close", function () {
  e._addNumAsked();
  e._reset();
});
this.isDislikeDofus = !1;
this.isLikeDofus = !1;
this.question = this.windowBody.createChild("div", {
  className: "question",
  text: s("ui.popup.ratingQuestion")
});
this.buttonContainer = this.windowBody.createChild("div", {
  className: "buttonContainer"
});
e._initialize();
e._reset();
e._addNumAsked();
e._reset();
this.yesButton = this.buttonContainer.appendChild(new a({
  className: "greenButton",
  text: s("ui.popup.ratingYes")
}, function () {
  if (e.isLikeDofus) {
    window && window.LaunchReview && (window.LaunchReview.isRatingSupported() ? window.LaunchReview.rating(t, i) : window.LaunchReview.launch(t, i));
    e._setUserPref({
      isNeverAsk: !0
    });
    e.close();
  } else if (e.isDislikeDofus) {
    e._setUserPref({
      isNeverAsk: !0
    });
    e.close();
    var n = "mailto:" + s("ui.popup.ratingEmail") + "?subject=" + s("ui.popup.ratingEmailSubject");
    window.cordova && window.cordova.InAppBrowser ? window.cordova.InAppBrowser.open(n, "_system", "location=yes,hidden=yes") : window.open(n, "_system");
  } else {
    e._likeDofus();
  }
}));
this.noButton = this.buttonContainer.appendChild(new a({
  className: "greenButton",
  text: s("ui.popup.ratingNo")
}, function () {
  e.isDislikeDofus ? (e._setUserPref({
    isNeverAsk: !0
  }), e.close()) : e.isLikeDofus ? (e._setUserPref({
    isNeverAsk: !1
  }), e.close()) : e._dislikeDofus();
}));
window && window.LaunchReview && (window.LaunchReview.isRatingSupported() ? window.LaunchReview.rating(t, i) : window.LaunchReview.launch(t, i));
e._setUserPref({
  isNeverAsk: !0
});
e.close();
e._setUserPref({
  isNeverAsk: !0
});
e.close();
o(n, l);
e.exports = n;
n.prototype._addNumAsked = function () {
  var e = r.getValue("rateDofus", null);
  e ? e.numAsked++ : e = {
    isNeverAsk: !1,
    numAsked: 1
  };
  r.setValue("rateDofus", e, null);
};
n.prototype._setUserPref = function (e) {
  var t = r.getValue("rateDofus", null);
  t || (t = {
    isNeverAsk: !1,
    numAsked: 1
  });
  e.isNeverAsk && (t.isNeverAsk = !0);
  r.setValue("rateDofus", t, null);
  this.close();
};
n.prototype._reset = function () {
  this.isDislikeDofus = !1;
  this.isLikeDofus = !1;
};
n.prototype._initialize = function () {
  this.question.setText(s("ui.popup.ratingQuestion"));
  this.noButton.setText(s("ui.popup.ratingNo"));
  this.yesButton.setText(s("ui.popup.ratingYes"));
};
n.prototype._dislikeDofus = function () {
  this.isDislikeDofus = !0;
  this.question.setText(s("ui.popup.ratingDislikeQuestion"));
  this.noButton.setText(s("ui.popup.ratingWhyNotNo"));
  this.yesButton.setText(s("ui.popup.ratingWhyNotYes"));
};
n.prototype._likeDofus = function () {
  this.isLikeDofus = !0;
  this.question.setText(s("ui.popup.ratingLikeQuestion"));
  this.noButton.setText(s("ui.popup.ratingLikeNo"));
  this.yesButton.setText(s("ui.popup.ratingLikeYes"));
};
e ? e.numAsked++ : e = {
  isNeverAsk: !1,
  numAsked: 1
};
r.setValue("rateDofus", e, null);
t || (t = {
  isNeverAsk: !1,
  numAsked: 1
});
e.isNeverAsk && (t.isNeverAsk = !0);
r.setValue("rateDofus", t, null);
this.close();
this.isDislikeDofus = !1;
this.isLikeDofus = !1;
this.question.setText(s("ui.popup.ratingQuestion"));
this.noButton.setText(s("ui.popup.ratingNo"));
this.yesButton.setText(s("ui.popup.ratingYes"));
this.isDislikeDofus = !0;
this.question.setText(s("ui.popup.ratingDislikeQuestion"));
this.noButton.setText(s("ui.popup.ratingWhyNotNo"));
this.yesButton.setText(s("ui.popup.ratingWhyNotYes"));
this.isLikeDofus = !0;
this.question.setText(s("ui.popup.ratingLikeQuestion"));
this.noButton.setText(s("ui.popup.ratingLikeNo"));
this.yesButton.setText(s("ui.popup.ratingLikeYes"));
s.call(this, {
  title: o("ui.common.panjidex"),
  className: "panjidexWindow",
  positionInfo: {
    right: "c",
    bottom: "c",
    width: 400,
    height: 490,
    mustAvoidToolbar: !0
  }
});
this.once("open", function (e) {
  this._showModel = e.drawModeleFunction;
  this._createDom();
});
this.on("open", function () {
  this._showPanjis();
});
window.gui.on("disconnect", function () {
  e._panjiList && e._panjiList.getChildren().forEach(function (e) {
    "panji" === e.getClassNames()[0] && e.destroy();
  });
});
this._showModel = e.drawModeleFunction;
this._createDom();
a(n, s);
n.prototype._addPanji = function (e, t) {
  var i = this,
    n = this._panjiList.createChild("div", {
      className: "panji"
    });
  n.id = t;
  n.left = n.createChild("div", {
    className: "panjiLeft"
  });
  n.right = n.createChild("div", {
    className: "panjiRight"
  });
  n.left.slot = n.left.createChild("div", {
    className: "slot"
  });
  n.left.img = n.left.slot.createChild("div", {
    className: ["img", "img" + t]
  });
  n.nameText = n.right.createChild("div", {
    className: "panjiName",
    text: e.name
  });
  n.consultButton = n.right.createChild("div", {
    className: "consultButton"
  });
  l(n.consultButton);
  n.consultButton.on("tap", function () {
    i.windowManager.close(i.id);
    i._showModel(e.model);
  });
};
n.prototype._showPanjis = function () {
  function e(e) {
    return e.id === n;
  }
  var t = this,
    i = window.gui.playerData.inventory,
    n = 0;
  d.forEach(function (a) {
    var s = !!i.quantityList[u] || !!i.quantityList[a.item];
    a.id === h && (s = !!i.quantityList[a.item]);
    n = a.id;
    s && !t._panjiList.getChildren().some(e) && t._addPanji({
      model: r[a.id],
      name: o(a.name)
    }, a.id);
  });
  this._placeHolder.toggleDisplay(this._panjiList.getChildren().length < 2);
};
n.prototype._createDom = function () {
  var e = this.windowBody.createChild("div", {
    className: "panjisListWrapper"
  });
  this._panjiList = e.createChild("div", {
    className: "panjisList"
  });
  this._placeHolder = new c(this._panjiList);
  this._placeHolder.setText(o("ui.common.panjidexEmpty"));
};
e.exports = n;
n.id = t;
n.left = n.createChild("div", {
  className: "panjiLeft"
});
n.right = n.createChild("div", {
  className: "panjiRight"
});
n.left.slot = n.left.createChild("div", {
  className: "slot"
});
n.left.img = n.left.slot.createChild("div", {
  className: ["img", "img" + t]
});
n.nameText = n.right.createChild("div", {
  className: "panjiName",
  text: e.name
});
n.consultButton = n.right.createChild("div", {
  className: "consultButton"
});
l(n.consultButton);
n.consultButton.on("tap", function () {
  i.windowManager.close(i.id);
  i._showModel(e.model);
});
i.windowManager.close(i.id);
i._showModel(e.model);
d.forEach(function (a) {
  var s = !!i.quantityList[u] || !!i.quantityList[a.item];
  a.id === h && (s = !!i.quantityList[a.item]);
  n = a.id;
  s && !t._panjiList.getChildren().some(e) && t._addPanji({
    model: r[a.id],
    name: o(a.name)
  }, a.id);
});
this._placeHolder.toggleDisplay(this._panjiList.getChildren().length < 2);
a.id === h && (s = !!i.quantityList[a.item]);
n = a.id;
s && !t._panjiList.getChildren().some(e) && t._addPanji({
  model: r[a.id],
  name: o(a.name)
}, a.id);
this._panjiList = e.createChild("div", {
  className: "panjisList"
});
this._placeHolder = new c(this._panjiList);
this._placeHolder.setText(o("ui.common.panjidexEmpty"));
this.once("open", function () {
  this.body = this.windowBody.createChild("div", {
    className: "DQBody"
  });
  this.createTabs(this.body, [{
    title: r("ui.dailyQuest.dailyQuest"),
    content: e,
    name: p
  }, {
    title: r("ui.almanax.almanax"),
    content: t,
    name: m
  }]);
});
this.on("open", function (e) {
  this.setupTabs();
  var t = window.gui.playerData.quests.dailyQuests.mainQuest,
    i = e.tabId ? e.tabId : n(!u(t));
  this.body.tabs.openTab(i, {}, {
    forceOpen: !0
  });
});
this.body = this.windowBody.createChild("div", {
  className: "DQBody"
});
this.createTabs(this.body, [{
  title: r("ui.dailyQuest.dailyQuest"),
  content: e,
  name: p
}, {
  title: r("ui.almanax.almanax"),
  content: t,
  name: m
}]);
a(o, s);
e.exports = o;
o.prototype.createTabs = function (e, t) {
  e.tabs = new l();
  e.appendChild(e.tabs);
  e.panels = e.createChild("div", {
    className: "panels"
  });
  e.panelCollection = {};
  for (var i = 0, n = t.length; i < n; i += 1) {
    var o = t[i].name;
    e.panelCollection[o] = e.panels.appendChild(t[i].content);
    e.tabs.addTab(t[i].title, e.panelCollection[o], o);
  }
};
o.prototype.setupTabs = function () {
  function e(e) {
    return e !== m && u(t);
  }
  var t = window.gui.playerData.quests.dailyQuests.mainQuest,
    i = this.body.tabs,
    n = i.getTabsMap(),
    o = this;
  for (var a in n) {
    var s = n[a],
      r = s.target.getWuiName();
    e(r) ? s.tab.disable() : s.tab.enable();
  }
  if (u(t) && !h) {
    var l = window.gui.playerData.quests;
    l.on("mainDQStarted", function () {
      o.setupTabs();
    });
    l.on("listUpdated", function () {
      o.setupTabs();
    });
    h = !0;
  }
};
e.tabs = new l();
e.appendChild(e.tabs);
e.panels = e.createChild("div", {
  className: "panels"
});
e.panelCollection = {};
e.panelCollection[o] = e.panels.appendChild(t[i].content);
e.tabs.addTab(t[i].title, e.panelCollection[o], o);
l.on("mainDQStarted", function () {
  o.setupTabs();
});
l.on("listUpdated", function () {
  o.setupTabs();
});
h = !0;
t._updatetMainQuestPart();
t._fakeSlot || t._addFakeDQSlot();
t.slotList[i] || t._addDQSlot();
t._updatetDQSlot(t.slotList[i], n);
this.slotList = [];
this.rewards = {};
this._pendingReroll = !1;
this._fakeSlot = null;
this._mainQuestName = n.createChild("div", {
  className: "title"
});
this._mainQuestText = n.createChild("div", {
  className: "description"
});
this._questProgressBar = n.appendChild(new p({
  className: "questProgressBar",
  tooltip: !0
}));
this._freeRerollCount = 0;
this._paidRerollCount = 0;
h(v);
v.on("tap", function () {
  m.open("DailyQuestRerollWindow", {
    isPlayerRedirected: !1
  });
});
this._dqList = M.createChild("div", {
  className: "dqList"
});
this._initDQSlots();
C.on("listUpdated", function () {
  e();
});
C.on("mainDQStarted", function () {
  t._updatetMainQuestPart();
});
C.on("questUpdate", function (e) {
  var i = window.gui.playerData.quests;
  return e === i.dailyQuests.mainQuest.questId ? t._updatetMainQuestPart() : i.dailyQuests.active[e] ? t._updatetDQSlot(t.getDQSlot(e), i.dailyQuests.active[e]) : void 0;
});
C.on("questFinished", function (e) {
  var i = t.getDQSlot(e.questId);
  w(i) || t._updatetDQSlot(i, e);
});
C.on("rerollDQ", function (e) {
  t._updatetDQSlot(t.getDQSlot(e.oldDQId), C.dailyQuests.all[e.newDQId]);
  t._pendingReroll = !1;
});
C.on("rerollDQFailed", function () {
  t._pendingReroll = !1;
});
this.on("open", function () {
  e();
  window.dofus.sendMessage("DailyQuestsRerollQuantityRequestMessage");
  this._scroller.refresh();
});
y.on("DailyQuestsRerollQuantityMessage", function (e) {
  t._freeRerollCount = e.free;
  t._paidRerollCount = e.premium;
  _.setText(t._paidRerollCount);
  u.setText(t._freeRerollCount);
});
window.gui.playerData.on("subscriptionChanged", function () {
  t._fakeSlot && t._fakeSlot.toggleDisplay(!window.gui.playerData.isSubscriberAtMinLevel(N.ELITE));
});
window.gui.on("disconnect", function () {
  t.reset();
});
t._updatetDQSlot(t.getDQSlot(e.oldDQId), C.dailyQuests.all[e.newDQId]);
t._pendingReroll = !1;
e();
window.dofus.sendMessage("DailyQuestsRerollQuantityRequestMessage");
this._scroller.refresh();
t._freeRerollCount = e.free;
t._paidRerollCount = e.premium;
_.setText(t._paidRerollCount);
u.setText(t._freeRerollCount);
n.addClassNames("rewardSlot");
n.setItem(t);
n.setQuantity(i[t.id]);
n.on("tap", function () {
  m.open("itemBox", {
    itemData: t
  });
});
i.forEach(function (t) {
  if (t) {
    var i = e.appendChild(new c());
    i.addClassNames("rewardSlot");
    o.push(i);
    i.icon.addClassNames("spinner");
    n.push("gfx/emotes/" + t.id + ".png");
    i.setTooltip(t.nameId);
  }
});
d.preloadImages(n, function (e) {
  for (var t = 0, i = e.length; t < i; t += 1) {
    var n = o[t];
    n.rootElement && (n.icon.delClassNames("spinner"), n.setImage(e[t]));
  }
});
i.addClassNames("rewardSlot");
o.push(i);
i.icon.addClassNames("spinner");
n.push("gfx/emotes/" + t.id + ".png");
i.setTooltip(t.nameId);
r(n, l);
e.exports = n;
n.prototype._initDQSlots = function () {
  var e = Object.keys(window.gui.playerData.quests.dailyQuests.all).sort(),
    t = e.length;
  this._addFakeDQSlot();
  for (var i = 0; i < t; i += 1) {
    this._addDQSlot();
  }
};
n.prototype._addFakeDQSlot = function () {
  this._fakeSlot = this._dqList.createChild("div", {
    className: ["slot", "faked"]
  });
  var e = this._fakeSlot.createChild("div", {
    className: "dqFaked"
  });
  e.createChild("div", {
    className: "bonusPackSlotText",
    text: f("ui.dailyQuest.getBonusPackSlot")
  });
  var t = e.appendChild(new E({
    className: "linkToShop",
    scaleOnPress: !1
  }));
  t.on("tap", function () {
    m.open("market", {
      tabId: "shop",
      tabParams: {
        category: "bonuspack"
      }
    });
  });
  this._fakeSlot.toggleDisplay(!window.gui.playerData.isSubscriberAtMinLevel(N.ELITE));
};
n.prototype._addDQSlot = function () {
  var e = this,
    t = this._dqList,
    i = t.createChild("div", {
      className: "slot"
    }),
    n = i.createChild("div", {
      className: "dqFinished"
    });
  n.createChild("div", {
    className: "dqFinishedTitle",
    text: f("ui.dailyQuest.dqFinished")
  });
  var o = n.createChild("div", {
    className: "dqFinishedContent"
  });
  o.createChild("div", {
    className: "dqFinishedContent",
    text: f("ui.dailyQuest.countdown")
  });
  var a = new b.DofusDate(b.now()).getServerDate(),
    s = new b.DofusDate(Date.UTC(a.year, a.month, a.day + 1));
  i.countdown = o.appendChild(new C({
    endDate: s
  }));
  i.logoWrapper = i.createChild("div", {
    className: "logoWrapper"
  });
  i.logo = i.logoWrapper.createChild("div", {
    className: "logo"
  });
  i.left = i.createChild("div", {
    className: "slotLeft"
  });
  i.right = i.createChild("div", {
    className: "slotRight"
  });
  i.descriptionText = i.left.createChild("div", {
    className: "descriptionText"
  });
  i.rerollButton = i.right.appendChild(new E({
    className: ["greenButton", "rerollButton"]
  }));
  i.rerollButton.createChild("div", {
    className: "iconRerollButton"
  });
  i._timesReroll = 0;
  i._processingRewards = !1;
  h(i.rerollButton);
  i.rerollButton.on("tap", function () {
    if (!e._pendingReroll && !window.gui.playerData.isFighting) {
      if (0 === e._freeRerollCount && 0 === e._paidRerollCount) {
        return m.open("DailyQuestRerollWindow", {
          isPlayerRedirected: !0
        });
      }
      var t = f("ui.dailyQuest.premiumReroll");
      e._freeRerollCount > 0 && (t = f("ui.dailyQuest.freeReroll"));
      window.gui.openConfirmPopup({
        title: f("ui.common.confirm"),
        message: g(f("ui.dailyQuest.confirmReroll"), t),
        cb: function (t) {
          t && !e._pendingReroll && (e._pendingReroll = !0, A.log("User_Life_Cycle.daily_quest_reroll", {
            times_slot_rerolled: i._timesReroll,
            is_free_reroll: e._freeRerollCount > 0,
            quest_id: i.id
          }), i._timesReroll++, window.gui.playerData.quests.rerollDQ(i.id));
        }
      });
    }
  });
  for (var r = i.left.createChild("div", {
      className: "rewards",
      name: "rewards"
    }), l = i.rewardList = r.createChild("div", {
      className: "rewardList"
    }), c = [], d = 0; d < x; d += 1) {
    c[d] = l.appendChild(new u({
      name: "icon" + d
    }));
  }
  i.numbers = r.createChild("div", {
    className: "slotNumbers"
  });
  i.xp = i.numbers.createChild("div", {
    className: "slotXp"
  });
  i.kamas = i.numbers.createChild("div", {
    className: "slotKamas"
  });
  this.slotList.push(i);
  this._scroller.refresh(!0);
};
n.prototype.getDQSlot = function (e) {
  for (var t = {}, i = 0; i < this.slotList.length; i += 1) {
    if (this.slotList[i].id === e) {
      t = this.slotList[i];
      break;
    }
  }
  return t;
};
n.prototype._updatetMainQuestPart = function () {
  var e = window.gui.playerData.quests.dailyQuests.mainQuest;
  if (!(Object.keys(e).length < 1)) {
    this._mainQuestName.setText(e.dbQuest.nameId);
    this._mainQuestText.setText(e.dbSteps[e.stepId].descriptionId);
    var t = e.objectives[0].curCompletion,
      i = e.objectives[0].maxCompletion;
    this._questProgressBar.setValue(t, i);
  }
};
n.prototype._updatetDQSlot = function (e, t) {
  function i(e) {
    return parseInt(e, 10) === t.dbQuest.id;
  }
  var n = Object.keys(window.gui.playerData.quests.dailyQuests.finished);
  if (e.logoWrapper.toggleClassName("rare", window.gui.playerData.quests.isRareDQ(t.dbQuest.categoryId)), e.logo.setClassNames(["logo", window.gui.playerData.quests.getDQClassName(t.dbQuest.categoryId)]), t.objectives) {
    var a = t.objectives[0],
      s = a.hypertext || a.text;
    e.descriptionText.clearContent();
    var r = t.questId,
      l = a.objectiveId;
    e.descriptionText.appendChild(M.process(o(s, r, l)));
  }
  if (e.toggleClassName("finished", n.some(i)), n.some(i) && e.countdown.startCountdown(), e.id = t.dbQuest.id, t.stepId) {
    var c = t.dbSteps[t.stepId];
    this._displayRewards(t, e);
    this._setKamas(c, e);
    this._setXp(c, e);
  } else {
    e.kamas.clearContent();
    e.xp.clearContent();
  }
  this._scroller.refresh(!0);
};
n.prototype._setKamas = function (e, t) {
  var i = _.calculateStepKamasRatio(e);
  t.kamas.clearContent();
  i && t.kamas.setText(S.intToString(i));
};
n.prototype._setXp = function (e, t) {
  var i = window.gui.playerData,
    n = i.characterBaseInformations.level,
    o = i.experienceFactor,
    a = _.calculateStepXpRatio(e, n, o);
  t.xp.clearContent();
  a && t.xp.setText(S.intToString(a));
};
n.prototype._displayRewards = function (e, t) {
  if (!t._processingRewards) {
    t._processingRewards = !0;
    t.rewardList.clearContent();
    for (var i = e.dbSteps[e.stepId].rewardsIds, n = window.gui.playerData.characterBaseInformations.level, o = 0, r = i.length; o < r; o += 1) {
      var l = e.dbRewards[i[o]];
      !l || l.levelMin !== -1 && n < l.levelMin || l.levelMax !== -1 && n > l.levelMax || (a(t.rewardList, l.itemsReward), s(t.rewardList, l.emotesReward));
    }
    t._processingRewards = !1;
  }
};
n.prototype.reset = function () {
  this.slotList = [];
  this.rewards = {};
  this._fakeSlot = null;
  this._pendingReroll = !1;
  this._dqList.clearContent();
};
t.on("tap", function () {
  m.open("market", {
    tabId: "shop",
    tabParams: {
      category: "bonuspack"
    }
  });
});
this._fakeSlot.toggleDisplay(!window.gui.playerData.isSubscriberAtMinLevel(N.ELITE));
i.countdown = o.appendChild(new C({
  endDate: s
}));
i.logoWrapper = i.createChild("div", {
  className: "logoWrapper"
});
i.logo = i.logoWrapper.createChild("div", {
  className: "logo"
});
i.left = i.createChild("div", {
  className: "slotLeft"
});
i.right = i.createChild("div", {
  className: "slotRight"
});
i.descriptionText = i.left.createChild("div", {
  className: "descriptionText"
});
i.rerollButton = i.right.appendChild(new E({
  className: ["greenButton", "rerollButton"]
}));
i.rerollButton.createChild("div", {
  className: "iconRerollButton"
});
i._timesReroll = 0;
i._processingRewards = !1;
h(i.rerollButton);
i.rerollButton.on("tap", function () {
  if (!e._pendingReroll && !window.gui.playerData.isFighting) {
    if (0 === e._freeRerollCount && 0 === e._paidRerollCount) {
      return m.open("DailyQuestRerollWindow", {
        isPlayerRedirected: !0
      });
    }
    var t = f("ui.dailyQuest.premiumReroll");
    e._freeRerollCount > 0 && (t = f("ui.dailyQuest.freeReroll"));
    window.gui.openConfirmPopup({
      title: f("ui.common.confirm"),
      message: g(f("ui.dailyQuest.confirmReroll"), t),
      cb: function (t) {
        t && !e._pendingReroll && (e._pendingReroll = !0, A.log("User_Life_Cycle.daily_quest_reroll", {
          times_slot_rerolled: i._timesReroll,
          is_free_reroll: e._freeRerollCount > 0,
          quest_id: i.id
        }), i._timesReroll++, window.gui.playerData.quests.rerollDQ(i.id));
      }
    });
  }
});
e._freeRerollCount > 0 && (t = f("ui.dailyQuest.freeReroll"));
window.gui.openConfirmPopup({
  title: f("ui.common.confirm"),
  message: g(f("ui.dailyQuest.confirmReroll"), t),
  cb: function (t) {
    t && !e._pendingReroll && (e._pendingReroll = !0, A.log("User_Life_Cycle.daily_quest_reroll", {
      times_slot_rerolled: i._timesReroll,
      is_free_reroll: e._freeRerollCount > 0,
      quest_id: i.id
    }), i._timesReroll++, window.gui.playerData.quests.rerollDQ(i.id));
  }
});
i.numbers = r.createChild("div", {
  className: "slotNumbers"
});
i.xp = i.numbers.createChild("div", {
  className: "slotXp"
});
i.kamas = i.numbers.createChild("div", {
  className: "slotKamas"
});
this.slotList.push(i);
this._scroller.refresh(!0);
this._mainQuestName.setText(e.dbQuest.nameId);
this._mainQuestText.setText(e.dbSteps[e.stepId].descriptionId);
this._displayRewards(t, e);
this._setKamas(c, e);
this._setXp(c, e);
e.kamas.clearContent();
e.xp.clearContent();
t.kamas.clearContent();
i && t.kamas.setText(S.intToString(i));
t.xp.clearContent();
a && t.xp.setText(S.intToString(a));
t._processingRewards = !0;
t.rewardList.clearContent();
this.slotList = [];
this.rewards = {};
this._fakeSlot = null;
this._pendingReroll = !1;
this._dqList.clearContent();
e = e || {};
s.call(this, "div", e);
this._endDate = e.endDate;
this.addClassNames("countdown");
a(n, s);
e.exports = n;
n.prototype.setEndDate = function (e) {
  this._endDate = e;
};
n.prototype.startCountdown = function () {
  if (this._endDate) {
    var e = this;
    this._interval && clearInterval(this._interval);
    this._interval = setInterval(function () {
      o(e);
    }, 1e3);
  }
};
n.prototype.stopCountdown = function () {
  clearInterval(this._interval);
};
this._interval && clearInterval(this._interval);
this._interval = setInterval(function () {
  o(e);
}, 1e3);
r.call(this, "div", {
  className: "AlmanaxTab",
  name: "almanax"
});
this._calendarDate = -1;
this._isRefreshPending = !1;
this.on("opened", this._refresh);
e.on("AlmanachCalendarDateMessage", function (e) {
  t._calendarDate = e.date;
  t._showAlmanaxNotification(e.date, e._merydeName);
});
t._calendarDate = e.date;
t._showAlmanaxNotification(e.date, e._merydeName);
o(n, r);
e.exports = n;
n.prototype._refresh = function () {
  var e = this;
  this._isRefreshPending || (this._isRefreshPending = !0, this.addClassNames("spinner"), w.getAlmanax(function (t, i, n) {
    if (t) {
      return void e._handleError();
    }
    if (n) {
      return e._updateQuestProgress(), e._isRefreshPending = !1, void e.delClassNames("spinner");
    }
    e.clearContent();
    var o = window.gui.databases.AlmanaxCalendars[e._calendarDate],
      a = o.npcId;
    g.getDataArray("Npcs", [a], function (t, n) {
      var o = n && n[0];
      !t && o || (o || t || (t = new Error("Npc data are empty.")), console.error("_refresh for npcId:", a, "date:", e._calendarDate, "error:", t), o = {});
      e._createContent();
      e._updateQuestProgress();
      e._updateAlmanaxData(i, o.nameId || "");
      e.delClassNames("spinner");
      e._isRefreshPending = !1;
    });
  }));
};
n.prototype._handleError = function () {
  this.clearContent();
  this._createRetryButton();
  this.delClassNames("spinner");
  this._isRefreshPending = !1;
};
n.prototype._createRetryButton = function () {
  var e = this.createChild("div", {
    className: "failureBox"
  });
  e.createChild("div", {
    text: h("ui.common.error") + "..."
  });
  var t = e.appendChild(new s({
      className: "greenButton",
      text: h("tablet.common.retry")
    })),
    i = this;
  t.on("tap", function () {
    i._refresh();
  });
};
n.prototype._createContent = function () {
  var e = this.createChild("div", {
      className: "col1"
    }),
    t = e.createChild("div", {
      className: "dateBlock"
    });
  this.monthText = t.createChild("div", {
    className: "monthText"
  });
  var i = t.createChild("div", {
    className: "dayBg"
  });
  this.dayNumber = i.createChild("div", {
    className: "dayNumber"
  });
  this.yearText = t.createChild("div", {
    className: "yearText"
  });
  var n = t.createChild("div", {
    className: "illusWrapper"
  });
  this.astro = n.createChild("div", {
    className: "smallIllus"
  });
  this.monthGod = n.createChild("div", {
    className: "smallIllus"
  });
  var o = t.createChild("div", {
    className: "bottomIllusWrapper"
  });
  this.bottomIllus = o.createChild("div", {
    className: "bottomIllus"
  });
  this.linkToCalendar = e.appendChild(f.process('<a href="' + h("ui.almanax.link") + '">' + h("ui.almanax.calendar") + "</a>"));
  var l,
    c = this.createChild("div", {
      className: "col2"
    });
  l = c.createChild("div");
  var u = l.createChild("div", {
      className: ["block", "saintBlock"]
    }),
    g = u.createChild("div", {
      className: "saintBg"
    });
  this.merydeIllus = g.createChild("div", {
    className: "saintIllus"
  });
  this.merydeTitle = u.createChild("div", {
    className: "title"
  });
  this.merydeDesc = u.createChild("div", {
    className: "description"
  });
  this.instructionText = u.createChild("div", {
    className: "instructionText"
  });
  l = c.createChild("div");
  var _ = l.createChild("div", {
    className: ["block", "bonusBlock"]
  });
  _.createChild("div", {
    className: ["smallIllus", "bonusIllus"]
  });
  this.bonusTitle = _.createChild("div", {
    className: "title"
  });
  this.bonusDesc = _.createChild("div", {
    className: "description"
  });
  l = c.createChild("div");
  var v = l.createChild("div", {
      className: ["block", "questBlock"]
    }),
    y = v.createChild("div", {
      className: "questContent"
    }),
    w = y.createChild("div", {
      className: "dolmanaxBg"
    }),
    b = w.createChild("div", {
      className: "dolmanaxIllus"
    });
  p.getItems([I], function (e) {
    return e ? console.error(e) : void b.setStyle("backgroundImage", p.items[I].image);
  });
  y.createChild("div", {
    className: "title",
    text: h("ui.almanax.dolmanaxQuest")
  });
  this.questDesc = y.createChild("div", {
    className: "description"
  });
  y.appendChild(new s({
    className: ["locateButton", "greenButton"],
    text: h("ui.almanax.localizeSanctuary")
  }, function () {
    window.gui.emit("CompassUpdateMessage", {
      type: m.COMPASS_TYPE_SIMPLE,
      worldX: T,
      worldY: C
    });
  }));
  var M = y.createChild("div", {
    className: "progression"
  });
  this.questProgressTitle = M.createChild("div", {
    className: "questProgressTitle"
  });
  this.questProgressBar = M.appendChild(new a({
    className: "questProgressBar"
  }));
  this.astroTooltipTx = new r("div");
  d(this.astro, this.astroTooltipTx);
  this.monthGodTooltipTx = new r("div");
  d(this.monthGod, this.monthGodTooltipTx);
  this.merydeTootipTx = new r("div");
  d(this.merydeIllus, this.merydeTootipTx);
  this.questTooltipTx = new r("div");
  d(this.questProgressBar, this.questTooltipTx);
  d(this.linkToCalendar, h("ui.almanax.goToWebsite"));
};
n.prototype._updateAlmanaxData = function (e, t) {
  var i = window.gui.databases.AlmanaxCalendars[this._calendarDate],
    n = l.getAlmanaxDate();
  this.dayNumber.setText(n.day);
  this.monthText.setText(n.monthName);
  this.yearText.setText(h("ui.common.year", n.year));
  var o = e.event,
    a = e.zodiac,
    s = e.month;
  o || console.error(new Error("_updateAlmanaxData: event data missing"));
  a || console.error(new Error("_updateAlmanaxData: zodiac data missing"));
  s || console.error(new Error("_updateAlmanaxData: month data missing"));
  a.imageUrl || console.error(new Error("_updateAlmanaxData: zodiac image missing for zodiacId " + a.id));
  this.astro.setStyle("backgroundImage", y(a.imageUrl));
  s.protectorImageUrl || console.error(new Error("_updateAlmanaxData: month image missing for monthId " + s.id));
  this.monthGod.setStyle("backgroundImage", y(s.protectorImageUrl));
  o.imageUrl || console.error(new Error("_updateAlmanaxData: event image missing for eventId " + o.id));
  this.bottomIllus.setStyle("backgroundImage", y(o.imageUrl));
  this.merydeTitle.setText(h("ui.almanax.dayMeryde", t));
  o.ephemeris || console.error(new Error("_updateAlmanaxData: event ephemeris missing for eventId " + o.id));
  this.merydeDesc.setText(o.ephemeris);
  this.instructionText.setText(h("ui.almanax.offeringTo", t));
  this.bonusTitle.setText(h("ui.almanax.dayBonus") + h("ui.common.colon") + i.nameId);
  this.bonusDesc.setHtml(i.descId);
  o.bossImageUrl || console.error(new Error("_updateAlmanaxData: event bossimageurl missing for eventId " + o.id));
  this.merydeIllus.setStyle("backgroundImage", y(o.bossImageUrl));
  a.description || console.error(new Error("_updateAlmanaxData: zodiac description missing for zodiacId " + a.id));
  this.astroTooltipTx.setText(a.description);
  u(this.astro, Boolean(a.description));
  s.protectorDesc || console.error(new Error("_updateAlmanaxData: month protector desc missing"));
  this.monthGodTooltipTx.setText(s.protectorDesc);
  u(this.monthGod, Boolean(s.protectorDesc));
  o.bossText || console.error(new Error("_updateAlmanaxData: event bosstext missing for eventId " + o.id));
  this.merydeTootipTx.setText(o.bossText);
  u(this.merydeIllus, Boolean(o.bossText));
};
n.prototype._updateQuestProgress = function () {
  if (window.gui.playerData.quests.finished[M]) {
    return this.questDesc.setText(h("ui.almanax.dolmanaxQuestDone")), this.questProgressTitle.setText(h("ui.almanax.questDone")), void this.questProgressBar.setValue(1);
  }
  this.questDesc.setText(h("ui.almanax.dolmanaxQuestDesc"));
  this.questProgressTitle.setText(h("ui.almanax.questProgress"));
  var e = window.gui.playerData.inventory.quantityList[A] || 0,
    t = Math.min(e, b);
  this.questProgressBar.setValue(t / b);
  this.questTooltipTx.setText(h("ui.almanax.calendarSheetsCollected", t, b));
};
n.prototype._showAlmanaxNotification = function (e, t) {
  if (v.getValue("almanaxLastNotif") !== e) {
    v.setValue("almanaxLastNotif", e);
    var i = l.getAlmanaxDate(),
      n = window.gui.notificationBar;
    n.newNotification("almanax_" + e, {
      type: n.notificationType.INVITATION,
      title: i.day + " " + i.monthName + " " + i.year,
      text: h("ui.almanax.offeringTo", t),
      buttons: [{
        label: h("ui.almanax.almanax"),
        action: function () {
          _.open("dailyQuest", {
            tabId: "almanax"
          });
        }
      }]
    });
  }
};
!t && o || (o || t || (t = new Error("Npc data are empty.")), console.error("_refresh for npcId:", a, "date:", e._calendarDate, "error:", t), o = {});
e._createContent();
e._updateQuestProgress();
e._updateAlmanaxData(i, o.nameId || "");
e.delClassNames("spinner");
e._isRefreshPending = !1;
this.clearContent();
this._createRetryButton();
this.delClassNames("spinner");
this._isRefreshPending = !1;
this.dayNumber = i.createChild("div", {
  className: "dayNumber"
});
this.yearText = t.createChild("div", {
  className: "yearText"
});
this.astro = n.createChild("div", {
  className: "smallIllus"
});
this.monthGod = n.createChild("div", {
  className: "smallIllus"
});
this.bottomIllus = o.createChild("div", {
  className: "bottomIllus"
});
this.linkToCalendar = e.appendChild(f.process('<a href="' + h("ui.almanax.link") + '">' + h("ui.almanax.calendar") + "</a>"));
this.merydeIllus = g.createChild("div", {
  className: "saintIllus"
});
this.merydeTitle = u.createChild("div", {
  className: "title"
});
this.merydeDesc = u.createChild("div", {
  className: "description"
});
this.instructionText = u.createChild("div", {
  className: "instructionText"
});
l = c.createChild("div");
_.createChild("div", {
  className: ["smallIllus", "bonusIllus"]
});
this.bonusTitle = _.createChild("div", {
  className: "title"
});
this.bonusDesc = _.createChild("div", {
  className: "description"
});
l = c.createChild("div");
p.getItems([I], function (e) {
  return e ? console.error(e) : void b.setStyle("backgroundImage", p.items[I].image);
});
y.createChild("div", {
  className: "title",
  text: h("ui.almanax.dolmanaxQuest")
});
this.questDesc = y.createChild("div", {
  className: "description"
});
y.appendChild(new s({
  className: ["locateButton", "greenButton"],
  text: h("ui.almanax.localizeSanctuary")
}, function () {
  window.gui.emit("CompassUpdateMessage", {
    type: m.COMPASS_TYPE_SIMPLE,
    worldX: T,
    worldY: C
  });
}));
this.questProgressTitle = M.createChild("div", {
  className: "questProgressTitle"
});
this.questProgressBar = M.appendChild(new a({
  className: "questProgressBar"
}));
this.astroTooltipTx = new r("div");
d(this.astro, this.astroTooltipTx);
this.monthGodTooltipTx = new r("div");
d(this.monthGod, this.monthGodTooltipTx);
this.merydeTootipTx = new r("div");
d(this.merydeIllus, this.merydeTootipTx);
this.questTooltipTx = new r("div");
d(this.questProgressBar, this.questTooltipTx);
d(this.linkToCalendar, h("ui.almanax.goToWebsite"));
this.dayNumber.setText(n.day);
this.monthText.setText(n.monthName);
this.yearText.setText(h("ui.common.year", n.year));
o || console.error(new Error("_updateAlmanaxData: event data missing"));
a || console.error(new Error("_updateAlmanaxData: zodiac data missing"));
s || console.error(new Error("_updateAlmanaxData: month data missing"));
a.imageUrl || console.error(new Error("_updateAlmanaxData: zodiac image missing for zodiacId " + a.id));
this.astro.setStyle("backgroundImage", y(a.imageUrl));
s.protectorImageUrl || console.error(new Error("_updateAlmanaxData: month image missing for monthId " + s.id));
this.monthGod.setStyle("backgroundImage", y(s.protectorImageUrl));
o.imageUrl || console.error(new Error("_updateAlmanaxData: event image missing for eventId " + o.id));
this.bottomIllus.setStyle("backgroundImage", y(o.imageUrl));
this.merydeTitle.setText(h("ui.almanax.dayMeryde", t));
o.ephemeris || console.error(new Error("_updateAlmanaxData: event ephemeris missing for eventId " + o.id));
this.merydeDesc.setText(o.ephemeris);
this.instructionText.setText(h("ui.almanax.offeringTo", t));
this.bonusTitle.setText(h("ui.almanax.dayBonus") + h("ui.common.colon") + i.nameId);
this.bonusDesc.setHtml(i.descId);
o.bossImageUrl || console.error(new Error("_updateAlmanaxData: event bossimageurl missing for eventId " + o.id));
this.merydeIllus.setStyle("backgroundImage", y(o.bossImageUrl));
a.description || console.error(new Error("_updateAlmanaxData: zodiac description missing for zodiacId " + a.id));
this.astroTooltipTx.setText(a.description);
u(this.astro, Boolean(a.description));
s.protectorDesc || console.error(new Error("_updateAlmanaxData: month protector desc missing"));
this.monthGodTooltipTx.setText(s.protectorDesc);
u(this.monthGod, Boolean(s.protectorDesc));
o.bossText || console.error(new Error("_updateAlmanaxData: event bosstext missing for eventId " + o.id));
this.merydeTootipTx.setText(o.bossText);
u(this.merydeIllus, Boolean(o.bossText));
this.questDesc.setText(h("ui.almanax.dolmanaxQuestDesc"));
this.questProgressTitle.setText(h("ui.almanax.questProgress"));
this.questProgressBar.setValue(t / b);
this.questTooltipTx.setText(h("ui.almanax.calendarSheetsCollected", t, b));
a.call(this, {
  className: "FeatureIntroWindow",
  title: l("ui.popup.newFeature"),
  positionInfo: {
    left: "c",
    top: "c",
    width: 520,
    height: 480
  }
});
this._featureId = 0;
r.on("FeatureEnabledMessage", function (t) {
  s.open(e.id, t.feature);
});
this.on("open", function (e) {
  e = 1;
  this._featureId = e;
  d[e] && (this._img.addClassNames(d[e].name), this._desc.setText(l(d[e].text)));
});
this._createDom();
e = 1;
this._featureId = e;
d[e] && (this._img.addClassNames(d[e].name), this._desc.setText(l(d[e].text)));
o(n, a);
e.exports = n;
n.prototype._createDom = function () {
  var e = this;
  this._img = this.windowBody.createChild("div", {
    className: "img"
  });
  this._desc = this.windowBody.createChild("div", {
    className: "desc"
  });
  var t = this.windowBody.createChild("div", {
    className: "buttons"
  });
  this._redirectButton = t.appendChild(new c({
    className: ["greenButton"],
    text: l("ui.popup.toInterface")
  }));
  this._encyclopediaButton = t.appendChild(new c({
    className: ["greenButton"],
    text: l("ui.popup.toEncyclopedia")
  }));
  this._redirectButton.on("tap", function () {
    s.open(d[e._featureId].name);
  });
  this._encyclopediaButton.on("tap", function () {
    s.open("help", {
      part: d[e._featureId].part,
      subPart: d[e._featureId].subPart
    });
  });
};
this._img = this.windowBody.createChild("div", {
  className: "img"
});
this._desc = this.windowBody.createChild("div", {
  className: "desc"
});
this._redirectButton = t.appendChild(new c({
  className: ["greenButton"],
  text: l("ui.popup.toInterface")
}));
this._encyclopediaButton = t.appendChild(new c({
  className: ["greenButton"],
  text: l("ui.popup.toEncyclopedia")
}));
this._redirectButton.on("tap", function () {
  s.open(d[e._featureId].name);
});
this._encyclopediaButton.on("tap", function () {
  s.open("help", {
    part: d[e._featureId].part,
    subPart: d[e._featureId].subPart
  });
});
a.call(this, {
  className: "LegendaryWeaponAwakeningWindow",
  title: r("ui.legendaryWeapon.titleAwakening"),
  numberSlot: 3
}, e);
this.chosenLW = null;
s(o, a);
e.exports = o;
o.prototype._setupListeners = function () {
  a.prototype._setupListeners.call(this);
  var e = this,
    t = window.gui;
  this.closeButton.on("tap", function () {
    window.dofus.sendMessage("LeaveDialogRequestMessage");
  });
  t.on("ExchangeLeaveMessage", function () {
    e.isOpened && e.close();
  });
  t.on("ExchangeObjectAddedMessage", function () {
    e.isOpened && e.chosenLW && e.validationButton.enable();
  });
  t.on("ExchangeCraftInformationObjectMessage", function (i) {
    e.isOpened && i.playerId === window.gui.playerData.id && (e._clear(), i.craftResult === c.CRAFT_SUCCESS ? t.openSimplePopup(r("ui.legendaryWeapon.successAwakening"), r("ui.craft.success")) : t.openSimplePopup(r("ui.craft.failed")));
  });
};
o.prototype._onOpen = function () {
  a.prototype._onOpen.call(this);
  this.validationButton.setText(r("ui.legendaryWeapon.confirmAwakening"));
  this.popupMessage = r("ui.legendaryWeapon.warningAwakening");
  this.storageViewer.addFilters([function (e) {
    return e.isAsleepLegendaryWeapon();
  }]);
  this.storageViewer.filterList();
};
o.prototype._reset = function () {
  a.prototype._reset.call(this);
  this.chosenLW = null;
  this.recipeIsReady = !1;
};
o.prototype._selectItem = function (e, t) {
  a.prototype._selectItem.call(this, e);
  var i = this;
  t = t || n;
  l.getItems(this.itemSelected.item.recipeIds, function (e, n) {
    return e ? t(e) : (i.upgradeWeaponList = n, i.statsChoice.show(), void i._selectElement(d.EARTH, t));
  });
};
o.prototype._getWeaponsByEffectChoice = function () {
  for (var e = window.gui.databases.TypeActions, t = {}, i = [], n = 0; n < this.upgradeWeaponList.length; n++) {
    var o = this.upgradeWeaponList[n];
    if (0 !== o.upgradeEffects.length) {
      for (var a = o.upgradeEffects[0].typeActionId, s = 0; s < o.possibleEffects.length; s++) {
        var r = o.possibleEffects[s],
          l = e[r.effectId];
        if (l && l.elementId === this.elementSelected) {
          o.possibleEffects[0].effectId === a ? i.unshift(a) : i.push(a);
          t[a] = {
            weapon: o,
            upgradeEffect: o.upgradeEffects[0]
          };
          break;
        }
      }
    }
  }
  return {
    effectsOrder: i,
    weaponsByEffectChoiceId: t
  };
};
o.prototype._addEffectsOnRawChosenLW = function (e, t, i) {
  u.createEffectInstances([p], function (e, n) {
    return e ? (i(), console.error(e)) : (t.effects.push(n[0]), void l.createItemInstances([t], function (e, t) {
      return e ? (i(), console.error(e)) : void i(t.array[0]);
    }));
  });
};
o.prototype._getAndDisplayChosenLW = function (e, t) {
  var i = this;
  a.prototype._getAndDisplayChosenLW.call(this, e, function () {
    t = t || n;
    i.chosenLW = e;
    i._displayRecipeFromWeaponId(e.weapon.id, t);
  });
};
o.prototype._refreshIngredientSlots = function (e, t) {
  a.prototype._refreshIngredientSlots.call(this, e, t);
  this.validationButton.isEnable() && (this.validationButton.disable(), window.dofus.sendMessage("ExchangeSetCraftRecipeMessage", {
    objectGID: this.chosenLW.weapon.id
  }));
};
o.prototype._validateUpgrading = function () {
  window.dofus.sendMessage("ExchangeReadyMessage", {
    ready: !0,
    step: 1
  });
};
this.closeButton.on("tap", function () {
  window.dofus.sendMessage("LeaveDialogRequestMessage");
});
t.on("ExchangeLeaveMessage", function () {
  e.isOpened && e.close();
});
t.on("ExchangeObjectAddedMessage", function () {
  e.isOpened && e.chosenLW && e.validationButton.enable();
});
t.on("ExchangeCraftInformationObjectMessage", function (i) {
  e.isOpened && i.playerId === window.gui.playerData.id && (e._clear(), i.craftResult === c.CRAFT_SUCCESS ? t.openSimplePopup(r("ui.legendaryWeapon.successAwakening"), r("ui.craft.success")) : t.openSimplePopup(r("ui.craft.failed")));
});
a.prototype._onOpen.call(this);
this.validationButton.setText(r("ui.legendaryWeapon.confirmAwakening"));
this.popupMessage = r("ui.legendaryWeapon.warningAwakening");
this.storageViewer.addFilters([function (e) {
  return e.isAsleepLegendaryWeapon();
}]);
this.storageViewer.filterList();
a.prototype._reset.call(this);
this.chosenLW = null;
this.recipeIsReady = !1;
t = t || n;
l.getItems(this.itemSelected.item.recipeIds, function (e, n) {
  return e ? t(e) : (i.upgradeWeaponList = n, i.statsChoice.show(), void i._selectElement(d.EARTH, t));
});
o.possibleEffects[0].effectId === a ? i.unshift(a) : i.push(a);
t[a] = {
  weapon: o,
  upgradeEffect: o.upgradeEffects[0]
};
t = t || n;
i.chosenLW = e;
i._displayRecipeFromWeaponId(e.weapon.id, t);
a.prototype._refreshIngredientSlots.call(this, e, t);
this.validationButton.isEnable() && (this.validationButton.disable(), window.dofus.sendMessage("ExchangeSetCraftRecipeMessage", {
  objectGID: this.chosenLW.weapon.id
}));
s.call(this, {
  className: ["LegendaryWeaponBaseWindow", e.className],
  title: e.title,
  positionInfo: {
    left: "c",
    top: "c",
    width: "90%",
    height: "90%",
    minWidth: 700,
    maxHeight: 530,
    mustAvoidToolbar: !0
  }
});
this.craftItemSlots = [];
this.upgradeWeaponList = [];
this.numberSlot = e.numberSlot;
this.itemSelected = null;
this.elementSelected = null;
this.popupMessage = "";
this.opened = !1;
this.isOpened = !1;
this.storageViewer = t;
this.storageViewer.registerView(this, {
  manualOpening: !0,
  enableSlotContext: !1,
  noExtraMargin: !0
});
this._setupListeners();
a(o, s);
e.exports = o;
o.prototype._setupListeners = function () {
  var e = this;
  this.once("open", function () {
    e._createDom();
  });
  this.on("open", function () {
    e.isOpened = !0;
    e._onOpen();
  });
  this.on("close", function () {
    e.isOpened = !1;
  });
  this.on("closed", function () {
    e._clear();
    e.storageViewer.unloadContent();
  });
  window.gui.on("disconnect", function () {
    e._reset();
    e.storageViewer.unloadContent();
  });
  this.on("slot-tap", function (t) {
    e._selectItem(t.itemInstance);
  });
};
o.prototype._createDom = function () {
  var e = this;
  this.opened = !0;
  var t = this.windowBody.createChild("div", {
      className: "LWBody"
    }),
    i = t.createChild("div", {
      className: "leftContainer"
    }),
    n = t.createChild("div", {
      className: "middleContainer"
    }),
    o = t.createChild("div", {
      className: "rightContainer"
    });
  this.statsChoice = i.createChild("div", {
    className: "statsChoice"
  });
  this.elementChoiceText = this.statsChoice.createChild("div", {
    className: "elementChoiceText"
  });
  this.wrapElementButtons = this.statsChoice.createChild("div", {
    className: "wrapElementButtons"
  });
  var a = this.wrapElementButtons.createChild("div", {
    name: _.EARTH,
    className: "earthButton"
  });
  p(a);
  a.on("tap", function () {
    w("GEN_BUTTON");
    e._selectElement(_.EARTH);
  });
  var s = this.wrapElementButtons.createChild("div", {
    name: _.FIRE,
    className: "fireButton"
  });
  p(s);
  s.on("tap", function () {
    w("GEN_BUTTON");
    e._selectElement(_.FIRE);
  });
  var l = this.wrapElementButtons.createChild("div", {
    name: _.WATER,
    className: "waterButton"
  });
  p(l);
  l.on("tap", function () {
    w("GEN_BUTTON");
    e._selectElement(_.WATER);
  });
  var m = this.wrapElementButtons.createChild("div", {
    name: _.AIR,
    className: "airButton"
  });
  p(m);
  m.on("tap", function () {
    w("GEN_BUTTON");
    e._selectElement(_.AIR);
  });
  this.effectChoiceText = this.statsChoice.createChild("div", {
    className: "effectChoiceText"
  });
  this.wrapEffectChoice = this.statsChoice.createChild("div", {
    className: "wrapEffectChoice"
  });
  var f = i.createChild("div", {
    className: "upgradedLW"
  });
  this.upgradedLW = f.appendChild(new c({
    showTitle: !0,
    noListener: !0
  }));
  this.placeHolderUpgradedLW = new h(f, {
    noHeight: !0
  });
  n.createChild("div", {
    className: "arrow"
  });
  this.storageBox = o.createChild("div", {
    className: "storageBox"
  });
  var g = o.createChild("div", {
    className: "currentLW"
  });
  this.currentLW = g.appendChild(new c({
    showTitle: !0,
    noListener: !0
  }));
  this.placeHolderLW = new h(g, {
    noHeight: !0
  });
  var v = o.createChild("div", {
    className: "craftItemContainer"
  });
  this.craftItemSlots = [];
  for (var y = 0; y < this.numberSlot; y++) {
    this.craftItemSlots.push(v.appendChild(new d({
      noDoubleTap: !0,
      forceQuantity: !0
    })));
  }
  this.validationButton = o.appendChild(new u({
    className: "button"
  }, function () {
    window.gui.openConfirmPopup({
      title: r("ui.popup.warning"),
      message: e.popupMessage,
      cb: function (t) {
        t && e._validateUpgrading();
      }
    });
  }));
};
o.prototype._onOpen = function () {
  this.opened && (this._clear(), this.elementChoiceText.setText(r("ui.legendaryWeapon.chooseElement")), this.effectChoiceText.setText(r("ui.legendaryWeapon.chooseEffect")), this.storageBox.appendChild(this.storageViewer.storageUI), this.storageViewer.clearFilters(), this.storageViewer.resetDisplay());
};
o.prototype._reset = function () {
  this.itemSelected = null;
  this.elementSelected = null;
  this.upgradeWeaponList = [];
};
o.prototype._clear = function () {
  if (this.opened) {
    for (var e = 0; e < this.wrapElementButtons.getChildren().length; e++) {
      this.wrapElementButtons.getChildren()[e].delClassNames("selectedButton");
    }
    this.statsChoice.hide();
    this.wrapEffectChoice.clearContent();
    this.storageViewer.unSelectSlot();
    this._clearIngredientSlots();
    this._displayCurrentLW(null);
    this._displayUpgradedLW(null);
    this._reset();
  }
};
o.prototype._selectItem = function (e) {
  this._clear();
  this.itemSelected = e;
  this._displayCurrentLW(e);
};
o.prototype._selectElement = function (e, t) {
  t = t || n;
  for (var i = 0; i < this.wrapElementButtons.getChildren().length; i++) {
    this.wrapElementButtons.getChildren()[i].delClassNames("selectedButton");
  }
  this.wrapElementButtons.getChild(e).addClassNames("selectedButton");
  this.elementSelected = e;
  this._displayUpgradedLW(null);
  this._clearIngredientSlots();
  this._refreshEffectChoices(t);
};
o.prototype._getWeaponsByEffectChoice = function () {
  return {};
};
o.prototype._refreshEffectChoices = function (e) {
  var t = this;
  if (e = e || n, !this.elementSelected || !this.itemSelected || 0 === this.upgradeWeaponList.length) {
    return e(new Error("Unable to find the selected element, item or upgradable weapons"));
  }
  var i = this._getWeaponsByEffectChoice(),
    o = i.weaponsByEffectChoiceId,
    a = i.effectsOrder;
  return a.length > 0 ? void v.getDataMap("Effects", a, function (i, n) {
    return i ? e(i) : (t.wrapEffectChoice.clearContent(), a.forEach(function (e) {
      var i = n[e],
        a = t.wrapEffectChoice.appendChild(new l(y(i.descriptionId, ""), {
          isRadio: !0
        }));
      a.on("change", function (e) {
        e && t._getAndDisplayChosenLW(o[i.id]);
      });
    }), e());
  }) : (t.wrapEffectChoice.clearContent(), e());
};
o.prototype._addEffectsOnRawChosenLW = function (e, t, i) {
  return i();
};
o.prototype._getAndDisplayChosenLW = function (e, t) {
  var i = this;
  if (t = t || n, !e) {
    return t(new Error("Unable to get a upgraded legendary weapon"));
  }
  for (var o = {
      objectGID: e.weapon.id,
      effects: []
    }, a = 0; a < e.weapon.possibleEffects.length; a++) {
    var s = e.weapon.possibleEffects[a].clone();
    s.effectId === f.ACTION_CHARACTER_LEARN_EMOTICON && (s.diceSide = 1);
    o.effects.push(s);
  }
  this._addEffectsOnRawChosenLW(e, o, function (e) {
    return e && i._displayUpgradedLW(e), t();
  });
};
o.prototype._upgradeAndDisplayLW = function (e, t) {
  var i = this;
  if (t = t || n, !e.item) {
    return t(new Error("The itemInstance of legendary weapon is missing the item"));
  }
  for (var o = e.getGrindLevel() - 1, a = {
      objectGID: e.item.id,
      effects: []
    }, s = 0; s < e.effects.length; s++) {
    a.effects.push(e.effects[s].clone());
  }
  var r = e.item.upgradeEffects && e.item.upgradeEffects[0];
  return r ? void v.getDataMap("UpgradeTemplates", [r.templateId], function (e, n) {
    if (e) {
      return t(e);
    }
    var s = n[r.templateId];
    if (!s || o >= s.levels.length) {
      return t();
    }
    for (var l = s.levels[o].bonusValue, c = 0; c < a.effects.length; c++) {
      var d = a.effects[c];
      d.effectId === r.typeActionId ? d.value += l : d.effectId === f.ACTION_GRIND_LEVEL && d.value++;
    }
    g.createItemInstances([a], function (e, n) {
      return e ? t(e) : (n.array.length > 0 && i._displayUpgradedLW(n.array[0]), i._displayRecipeFromTemplateLevel(s.levels[o], t));
    });
  }) : t(new Error("No upgrade effects available for weapon " + e.item.id));
};
o.prototype._displayCurrentLW = function (e) {
  e ? (this.currentLW.displayItem(e), this.currentLW.show(), this.placeHolderLW.setText(null)) : (this.currentLW.hide(), this.placeHolderLW.setText(r("ui.common.selectItem")));
};
o.prototype._displayUpgradedLW = function (e) {
  e ? (this.upgradedLW.displayItem(e), this.upgradedLW.show(), this.placeHolderUpgradedLW.setText(null)) : (this.upgradedLW.hide(), this.placeHolderUpgradedLW.setText(r("ui.search.noResult")));
};
o.prototype._displayRecipeFromWeaponId = function (e, t) {
  var i = this;
  t = t || n;
  v.getDataMap("Recipes", [e], function (n, o) {
    if (n) {
      return t(n);
    }
    var a = o[e];
    return a ? g.getItems(a.ingredientIds, function (e, o) {
      return e ? t(n) : (i._refreshIngredientSlots(o, a.quantities), t());
    }) : t();
  });
};
o.prototype._displayRecipeFromTemplateLevel = function (e, t) {
  var i = this;
  if (t = t || n, !e || !e.ingredients) {
    return t(new Error("LegendaryWeapon error: Template or ingredients are missing"));
  }
  for (var o = [], a = [], s = 0; s < e.ingredients.length; s++) {
    var r = e.ingredients[s];
    o.push(r.ingredientId);
    a.push(r.ingredientQty);
  }
  g.getItems(o, function (e, n) {
    return e ? t(e) : (i._refreshIngredientSlots(n, a), t());
  });
};
o.prototype._refreshIngredientSlots = function (e, t) {
  if (e && t) {
    var i = window.gui.playerData;
    this.validationButton.enable();
    for (var n = 0; n < this.craftItemSlots.length; n++) {
      var o = this.craftItemSlots[n];
      if (n >= e.length) {
        o.hide();
      } else {
        var a = e[n],
          s = t[n];
        o.show();
        o.setItem(a);
        o.setContextMenu("item", {});
        o.enableContextMenu(!0);
        var r = i.belongings.getItemCounts(a.id)[m.INVENTORY_QTY],
          l = (r > 9999 ? "9999+" : r) + "/" + s;
        o.setQuantity(l);
        o.toggleClassName("quantityNotEnough", r < s);
        r < s && this.validationButton.disable();
      }
    }
  }
};
o.prototype._clearIngredientSlots = function () {
  for (var e = 0; e < this.craftItemSlots.length; e++) {
    this.craftItemSlots[e].unset();
  }
  this.validationButton.disable();
};
o.prototype._validateUpgrading = function () {};
this.once("open", function () {
  e._createDom();
});
this.on("open", function () {
  e.isOpened = !0;
  e._onOpen();
});
this.on("close", function () {
  e.isOpened = !1;
});
this.on("closed", function () {
  e._clear();
  e.storageViewer.unloadContent();
});
window.gui.on("disconnect", function () {
  e._reset();
  e.storageViewer.unloadContent();
});
this.on("slot-tap", function (t) {
  e._selectItem(t.itemInstance);
});
e.isOpened = !0;
e._onOpen();
e._clear();
e.storageViewer.unloadContent();
e._reset();
e.storageViewer.unloadContent();
this.statsChoice = i.createChild("div", {
  className: "statsChoice"
});
this.elementChoiceText = this.statsChoice.createChild("div", {
  className: "elementChoiceText"
});
this.wrapElementButtons = this.statsChoice.createChild("div", {
  className: "wrapElementButtons"
});
p(a);
a.on("tap", function () {
  w("GEN_BUTTON");
  e._selectElement(_.EARTH);
});
w("GEN_BUTTON");
e._selectElement(_.EARTH);
p(s);
s.on("tap", function () {
  w("GEN_BUTTON");
  e._selectElement(_.FIRE);
});
w("GEN_BUTTON");
e._selectElement(_.FIRE);
p(l);
l.on("tap", function () {
  w("GEN_BUTTON");
  e._selectElement(_.WATER);
});
w("GEN_BUTTON");
e._selectElement(_.WATER);
p(m);
m.on("tap", function () {
  w("GEN_BUTTON");
  e._selectElement(_.AIR);
});
this.effectChoiceText = this.statsChoice.createChild("div", {
  className: "effectChoiceText"
});
this.wrapEffectChoice = this.statsChoice.createChild("div", {
  className: "wrapEffectChoice"
});
w("GEN_BUTTON");
e._selectElement(_.AIR);
this.upgradedLW = f.appendChild(new c({
  showTitle: !0,
  noListener: !0
}));
this.placeHolderUpgradedLW = new h(f, {
  noHeight: !0
});
n.createChild("div", {
  className: "arrow"
});
this.storageBox = o.createChild("div", {
  className: "storageBox"
});
this.currentLW = g.appendChild(new c({
  showTitle: !0,
  noListener: !0
}));
this.placeHolderLW = new h(g, {
  noHeight: !0
});
this.itemSelected = null;
this.elementSelected = null;
this.upgradeWeaponList = [];
this.statsChoice.hide();
this.wrapEffectChoice.clearContent();
this.storageViewer.unSelectSlot();
this._clearIngredientSlots();
this._displayCurrentLW(null);
this._displayUpgradedLW(null);
this._reset();
this._clear();
this.itemSelected = e;
this._displayCurrentLW(e);
this.wrapElementButtons.getChild(e).addClassNames("selectedButton");
this.elementSelected = e;
this._displayUpgradedLW(null);
this._clearIngredientSlots();
this._refreshEffectChoices(t);
s.effectId === f.ACTION_CHARACTER_LEARN_EMOTICON && (s.diceSide = 1);
o.effects.push(s);
t = t || n;
v.getDataMap("Recipes", [e], function (n, o) {
  if (n) {
    return t(n);
  }
  var a = o[e];
  return a ? g.getItems(a.ingredientIds, function (e, o) {
    return e ? t(n) : (i._refreshIngredientSlots(o, a.quantities), t());
  }) : t();
});
o.push(r.ingredientId);
a.push(r.ingredientQty);
o.show();
o.setItem(a);
o.setContextMenu("item", {});
o.enableContextMenu(!0);
o.setQuantity(l);
o.toggleClassName("quantityNotEnough", r < s);
r < s && this.validationButton.disable();
a.call(this, {
  className: "LegendaryWeaponUpgradingWindow",
  title: r("ui.legendaryWeapon.titleUpgrading"),
  numberSlot: 5
}, e);
this.selectedWeaponUID = null;
s(o, a);
e.exports = o;
o.prototype._setupListeners = function () {
  a.prototype._setupListeners.call(this);
  var e = this;
  this.on("open", function () {
    window.foreground.lock("legendaryWeaponInterface");
  });
  this.on("close", function () {
    window.foreground.unlock("legendaryWeaponInterface");
  });
  c.on("opened", function (t) {
    switch (t.id) {
      case "bidHouseShop":
      case "exchangeInventory":
      case "tradeInventory":
        e.close();
    }
  });
  l.on("CurrentMapMessage", function () {
    e.close();
  });
  l.on("ObjectUpgradeEffectResultMessage", function (t) {
    if (e.isOpened) {
      switch (t.status) {
        case d.UPGRADE_SUCCESS:
          window.gui.openSimplePopup(r("ui.legendaryWeapon.successUpgrading"), r("ui.craft.success"));
          break;
        case d.NOT_ENOUGH_INGREDIENTS:
          window.gui.openSimplePopup(r("ui.craft.dontHaveAllIngredient"));
          break;
        case d.OBJECT_EQUIPPED:
          window.gui.openSimplePopup(r("ui.set.objectEquipped"));
          break;
        case d.NO_WORKBENCH_NEARBY:
          window.gui.openSimplePopup(r("ui.craft.notNearCraftTable"));
          break;
        default:
          window.gui.openSimplePopup(r("ui.craft.failed"));
      }
    }
  });
  window.gui.playerData.inventory.on("itemModified", function (t) {
    e.isOpened && t.objectUID === e.selectedWeaponUID && e._selectItem(t);
  });
  window.gui.playerData.inventory.on("itemAdded", function (t) {
    e.isOpened && t.isLegendaryWeapon() && e._selectItem(t);
  });
};
o.prototype._onOpen = function () {
  a.prototype._onOpen.call(this);
  this.validationButton.setText(r("ui.legendaryWeapon.confirmUpgrading"));
  this.popupMessage = r("ui.legendaryWeapon.warningUpgrading");
  this.storageViewer.addFilters([function (e) {
    return e.isLegendaryWeapon() && !e.isAsleepLegendaryWeapon();
  }]);
  this.storageViewer.filterList();
};
o.prototype._reset = function () {
  a.prototype._reset.call(this);
  this.selectedWeaponUID = null;
};
o.prototype._selectItem = function (e, t) {
  a.prototype._selectItem.call(this, e);
  t = t || n;
  this.selectedWeaponUID = e.objectUID;
  this._upgradeAndDisplayLW(e, t);
};
o.prototype._validateUpgrading = function () {
  this.itemSelected && window.dofus.sendMessage("ObjectUpgradeEffectLevelUpRequestMessage", {
    objectUID: this.itemSelected.objectUID
  });
};
this.on("open", function () {
  window.foreground.lock("legendaryWeaponInterface");
});
this.on("close", function () {
  window.foreground.unlock("legendaryWeaponInterface");
});
c.on("opened", function (t) {
  switch (t.id) {
    case "bidHouseShop":
    case "exchangeInventory":
    case "tradeInventory":
      e.close();
  }
});
l.on("CurrentMapMessage", function () {
  e.close();
});
l.on("ObjectUpgradeEffectResultMessage", function (t) {
  if (e.isOpened) {
    switch (t.status) {
      case d.UPGRADE_SUCCESS:
        window.gui.openSimplePopup(r("ui.legendaryWeapon.successUpgrading"), r("ui.craft.success"));
        break;
      case d.NOT_ENOUGH_INGREDIENTS:
        window.gui.openSimplePopup(r("ui.craft.dontHaveAllIngredient"));
        break;
      case d.OBJECT_EQUIPPED:
        window.gui.openSimplePopup(r("ui.set.objectEquipped"));
        break;
      case d.NO_WORKBENCH_NEARBY:
        window.gui.openSimplePopup(r("ui.craft.notNearCraftTable"));
        break;
      default:
        window.gui.openSimplePopup(r("ui.craft.failed"));
    }
  }
});
window.gui.playerData.inventory.on("itemModified", function (t) {
  e.isOpened && t.objectUID === e.selectedWeaponUID && e._selectItem(t);
});
window.gui.playerData.inventory.on("itemAdded", function (t) {
  e.isOpened && t.isLegendaryWeapon() && e._selectItem(t);
});
a.prototype._onOpen.call(this);
this.validationButton.setText(r("ui.legendaryWeapon.confirmUpgrading"));
this.popupMessage = r("ui.legendaryWeapon.warningUpgrading");
this.storageViewer.addFilters([function (e) {
  return e.isLegendaryWeapon() && !e.isAsleepLegendaryWeapon();
}]);
this.storageViewer.filterList();
a.prototype._reset.call(this);
this.selectedWeaponUID = null;
a.prototype._selectItem.call(this, e);
t = t || n;
this.selectedWeaponUID = e.objectUID;
this._upgradeAndDisplayLW(e, t);
s.call(this, {
  className: "LegendaryWeaponShatterWindow",
  title: r("ui.legendaryWeapon.titleShatter"),
  positionInfo: {
    left: "c",
    top: "c",
    width: "90%",
    height: "90%",
    minWidth: 700,
    maxHeight: 530,
    mustAvoidToolbar: !0
  }
});
this.resultItemSlots = [];
this.itemSelected = null;
this.opened = !1;
this.isOpened = !1;
this.storageViewer = e;
this.storageViewer.registerView(this, {
  manualOpening: !0,
  enableSlotContext: !1,
  noExtraMargin: !0
});
this._setupListeners();
a(o, s);
e.exports = o;
o.prototype._setupListeners = function () {
  var e = this;
  this.once("open", function () {
    e._createDom();
  });
  this.on("open", function () {
    e.isOpened = !0;
    e._onOpen();
    window.foreground.lock("legendaryWeaponInterface");
  });
  this.on("close", function () {
    e.isOpened = !1;
    window.foreground.unlock("legendaryWeaponInterface");
  });
  this.on("closed", function () {
    e._clear();
    e.storageViewer.unloadContent();
  });
  window.gui.on("disconnect", function () {
    e._reset();
    e.storageViewer.unloadContent();
  });
  this.on("slot-tap", function (t) {
    e._selectItem(t.itemInstance);
  });
  p.on("CurrentMapMessage", function () {
    e.close();
  });
  m.on("opened", function (t) {
    switch (t.id) {
      case "bidHouseShop":
      case "exchangeInventory":
      case "tradeInventory":
        e.close();
    }
  });
  p.on("ObjectUpgradeEffectResultMessage", function (t) {
    if (e.isOpened) {
      switch (e._clear(), t.status) {
        case f.UPGRADE_SUCCESS:
          window.gui.openSimplePopup(r("ui.legendaryWeapon.successShatter"), r("ui.craft.success"));
          break;
        case f.NOT_ENOUGH_INGREDIENTS:
          window.gui.openSimplePopup(r("ui.craft.dontHaveAllIngredient"));
          break;
        case f.OBJECT_EQUIPPED:
          window.gui.openSimplePopup(r("ui.set.objectEquipped"));
          break;
        case f.NO_WORKBENCH_NEARBY:
          window.gui.openSimplePopup(r("ui.craft.notNearCraftTable"));
          break;
        default:
          window.gui.openSimplePopup(r("ui.craft.failed"));
      }
    }
  });
};
o.prototype._createDom = function () {
  var e = this;
  this.opened = !0;
  var t = this.windowBody.createChild("div", {
      className: "LWBody"
    }),
    i = t.createChild("div", {
      className: "leftContainer"
    }),
    n = t.createChild("div", {
      className: "rightContainer"
    }),
    o = i.createChild("div", {
      className: "currentLW"
    });
  this.currentLW = o.appendChild(new l({
    showTitle: !0,
    noListener: !0
  }));
  this.placeHolderLW = new u(o, {
    noHeight: !0
  });
  i.createChild("div", {
    className: "bottomArrow"
  });
  var a = i.createChild("div", {
    className: "resourcesContainer"
  });
  this.placeHolderResources = new u(a, {
    noHeight: !0
  });
  this.resultItemSlots = [];
  for (var s = 0; s < g; s++) {
    this.resultItemSlots.push(a.appendChild(new c({
      noDoubleTap: !0,
      forceQuantity: !0
    })));
    this.resultItemSlots[s].hide();
  }
  var h = n.createChild("div", {
    className: "warningBox"
  });
  this.warningText = h.createChild("div", {
    className: "warningText"
  });
  this.storageBox = n.createChild("div", {
    className: "storageBox"
  });
  this.validationButton = n.appendChild(new d({
    className: "button"
  }, function () {
    window.gui.openConfirmPopup({
      title: r("ui.popup.warning"),
      message: r("ui.legendaryWeapon.warningShatter"),
      cb: function (t) {
        t && e._validateShatter();
      }
    });
  }));
};
o.prototype._onOpen = function () {
  this.opened && (this._clear(), this.validationButton.setText(r("ui.legendaryWeapon.confirmShatter")), this.warningText.setText(r("ui.legendaryWeapon.infoShatter")), this.storageBox.appendChild(this.storageViewer.storageUI), this.storageViewer.clearFilters(), this.storageViewer.resetDisplay(), this.storageViewer.addFilters([function (e) {
    return e.isLegendaryWeapon();
  }]), this.storageViewer.filterList());
};
o.prototype._reset = function () {
  this.itemSelected = null;
};
o.prototype._clear = function () {
  this.opened && (this.validationButton.disable(), this.storageViewer.unSelectSlot(), this._clearIngredientSlots(), this._displayCurrentLW(null), this.placeHolderResources.setText(r("ui.search.noResult")), this._reset());
};
o.prototype._clearIngredientSlots = function () {
  for (var e = 0; e < this.resultItemSlots.length; e++) {
    this.resultItemSlots[e].unset();
    this.resultItemSlots[e].hide();
  }
};
o.prototype._displayCurrentLW = function (e) {
  e ? (this.currentLW.displayItem(e), this.currentLW.show(), this.placeHolderLW.setText(null)) : (this.currentLW.hide(), this.placeHolderLW.setText(r("ui.common.selectItem")));
};
o.prototype._selectItem = function (e, t) {
  var i = this;
  if (t = t || n, this._clear(), !e.item) {
    return t(new Error("Unable to find item in the itemInstance of legendary weapon"));
  }
  this.itemSelected = e;
  this._displayCurrentLW(e);
  var o,
    a = [];
  for (o = 0; o < e.item.shatterResults.length; o++) {
    a.push(e.item.shatterResults[o].resultResourceId);
  }
  h.getItems(a, function (n, a) {
    if (n) {
      return t(n);
    }
    for (o = 0; o < a.length; o++) {
      var s = i.resultItemSlots[o];
      s.setItem(a[o]);
      s.setQuantity(e.item.shatterResults[o].resultResourceQty);
      s.show();
    }
    return a.length > 0 && (i.placeHolderResources.setText(null), i.validationButton.enable()), t();
  });
};
o.prototype._validateShatter = function () {
  this.itemSelected && window.dofus.sendMessage("ObjectUpgradeEffectShatterRequestMessage", {
    objectUID: this.itemSelected.objectUID
  });
};
this.once("open", function () {
  e._createDom();
});
this.on("open", function () {
  e.isOpened = !0;
  e._onOpen();
  window.foreground.lock("legendaryWeaponInterface");
});
this.on("close", function () {
  e.isOpened = !1;
  window.foreground.unlock("legendaryWeaponInterface");
});
this.on("closed", function () {
  e._clear();
  e.storageViewer.unloadContent();
});
window.gui.on("disconnect", function () {
  e._reset();
  e.storageViewer.unloadContent();
});
this.on("slot-tap", function (t) {
  e._selectItem(t.itemInstance);
});
p.on("CurrentMapMessage", function () {
  e.close();
});
m.on("opened", function (t) {
  switch (t.id) {
    case "bidHouseShop":
    case "exchangeInventory":
    case "tradeInventory":
      e.close();
  }
});
p.on("ObjectUpgradeEffectResultMessage", function (t) {
  if (e.isOpened) {
    switch (e._clear(), t.status) {
      case f.UPGRADE_SUCCESS:
        window.gui.openSimplePopup(r("ui.legendaryWeapon.successShatter"), r("ui.craft.success"));
        break;
      case f.NOT_ENOUGH_INGREDIENTS:
        window.gui.openSimplePopup(r("ui.craft.dontHaveAllIngredient"));
        break;
      case f.OBJECT_EQUIPPED:
        window.gui.openSimplePopup(r("ui.set.objectEquipped"));
        break;
      case f.NO_WORKBENCH_NEARBY:
        window.gui.openSimplePopup(r("ui.craft.notNearCraftTable"));
        break;
      default:
        window.gui.openSimplePopup(r("ui.craft.failed"));
    }
  }
});
e.isOpened = !0;
e._onOpen();
window.foreground.lock("legendaryWeaponInterface");
e.isOpened = !1;
window.foreground.unlock("legendaryWeaponInterface");
e._clear();
e.storageViewer.unloadContent();
e._reset();
e.storageViewer.unloadContent();
this.currentLW = o.appendChild(new l({
  showTitle: !0,
  noListener: !0
}));
this.placeHolderLW = new u(o, {
  noHeight: !0
});
i.createChild("div", {
  className: "bottomArrow"
});
this.placeHolderResources = new u(a, {
  noHeight: !0
});
this.resultItemSlots = [];
this.resultItemSlots.push(a.appendChild(new c({
  noDoubleTap: !0,
  forceQuantity: !0
})));
this.resultItemSlots[s].hide();
this.warningText = h.createChild("div", {
  className: "warningText"
});
this.storageBox = n.createChild("div", {
  className: "storageBox"
});
this.validationButton = n.appendChild(new d({
  className: "button"
}, function () {
  window.gui.openConfirmPopup({
    title: r("ui.popup.warning"),
    message: r("ui.legendaryWeapon.warningShatter"),
    cb: function (t) {
      t && e._validateShatter();
    }
  });
}));
this.resultItemSlots[e].unset();
this.resultItemSlots[e].hide();
this.itemSelected = e;
this._displayCurrentLW(e);
s.setItem(a[o]);
s.setQuantity(e.item.shatterResults[o].resultResourceQty);
s.show();
a.call(this, {
  className: "LegendaryWeaponConversionWindow",
  title: r("ui.legendaryWeapon.titleConversion"),
  numberSlot: 1
}, e);
this.chosenLW = null;
s(o, a);
e.exports = o;
o.prototype._setupListeners = function () {
  a.prototype._setupListeners.call(this);
  var e = this;
  m.on("ObjectUpgradeEffectResultMessage", function (t) {
    e.isOpened && (0 !== t.status ? window.gui.openSimplePopup(r("ui.craft.failed")) : window.gui.openSimplePopup(r("ui.legendaryWeapon.successConversion"), r("ui.craft.success")), e.close());
  });
  m.on("ClientUIOpenedByObjectMessage", function (t) {
    t.type === f.CLIENT_UI_CONVERSION && g.open(e.id);
  });
};
o.prototype._onOpen = function () {
  a.prototype._onOpen.call(this);
  this.validationButton.setText(r("ui.legendaryWeapon.confirmConversion"));
  this.popupMessage = r("ui.legendaryWeapon.warningConversion");
  this.storageViewer.addFilters([function (e) {
    return e.isLegendaryWeapon() && !e.isAsleepLegendaryWeapon();
  }]);
  this.storageViewer.filterList();
};
o.prototype._reset = function () {
  a.prototype._reset.call(this);
  this.chosenLW = null;
};
o.prototype._selectItem = function (e, t) {
  a.prototype._selectItem.call(this, e);
  var i = this;
  t = t || n;
  u.getDataMap("Recipes", [e.id], function (n, o) {
    if (n) {
      return t(n);
    }
    var a = o[e.id];
    return a ? void u.getDataArray("Items", a.ingredientIds, function (e, n) {
      if (e) {
        return t(e);
      }
      for (var o = null, a = 0; a < n.length; a++) {
        if (n[a].typeId === c.types.cosmeticLegendaryWeapon) {
          o = n[a];
          break;
        }
      }
      return o ? l.getItems(o.recipeIds, function (e, n) {
        return e ? t(e) : (i.upgradeWeaponList = n, i.statsChoice.show(), void i._selectElement(d.EARTH, t));
      }) : t();
    }) : t(new Error("Unable to find recipes for legendary weapon"));
  });
};
o.prototype._getWeaponsByEffectChoice = function () {
  var e = window.gui.databases.TypeActions,
    t = {},
    i = [];
  if (!this.itemSelected) {
    return t;
  }
  var n,
    o = null;
  for (n = 0; n < this.itemSelected.effects.length; n++) {
    var a = this.itemSelected.effects[n];
    if (void 0 !== a.baseValue) {
      o = a.actionId;
      break;
    }
  }
  for (n = 0; n < this.upgradeWeaponList.length; n++) {
    var s = this.upgradeWeaponList[n];
    if (0 !== s.upgradeEffects.length) {
      for (var r = s.upgradeEffects[0], l = r.typeActionId, c = 0; c < s.possibleEffects.length; c++) {
        var d = s.possibleEffects[c],
          u = e[d.effectId];
        if (u && u.elementId === this.elementSelected && (s.id === this.itemSelected.id && l !== o || s.id !== this.itemSelected.id)) {
          d.effectId === l ? i.unshift(l) : i.push(l);
          t[l] = {
            weapon: s,
            upgradeEffect: r
          };
          break;
        }
      }
    }
  }
  return {
    effectsOrder: i,
    weaponsByEffectChoiceId: t
  };
};
o.prototype._addEffectsOnRawChosenLW = function (e, t, i) {
  for (var n = 1, o = 0; o < this.itemSelected.effects.length; o++) {
    var a = this.itemSelected.effects[o];
    if (a.actionId === h.ACTION_GRIND_LEVEL) {
      t.effects.push(a.clone());
      n = a.value;
      break;
    }
  }
  var s = e.weapon.upgradeEffects[0];
  u.getDataMap("UpgradeTemplates", [s.templateId], function (e, o) {
    if (e) {
      return i(e);
    }
    var a = o[s.templateId];
    if (!a) {
      return i(new Error("Unable to find template for " + s.templateId));
    }
    var r,
      c = 0;
    for (r = 0; r < Math.min(n - 1, a.levels.length); r++) {
      c += a.levels[r].bonusValue;
    }
    for (r = 0; r < t.effects.length; r++) {
      var d = t.effects[r];
      if (d.effectId === s.typeActionId) {
        d.diceNum += c;
        break;
      }
    }
    l.createItemInstances([t], function (e, t) {
      return e ? i(e) : void i(t.array[0]);
    });
  });
};
o.prototype._getAndDisplayChosenLW = function (e, t) {
  var i = this;
  a.prototype._getAndDisplayChosenLW.call(this, e, function () {
    t = t || n;
    i.chosenLW = e;
    l.getItems([p.CATALYST_ITEM], function (e, n) {
      return e ? t(e) : (i._refreshIngredientSlots(n, [_]), t());
    });
  });
};
o.prototype._validateUpgrading = function () {
  this.itemSelected && this.chosenLW && window.dofus.sendMessage("ObjectUpgradeEffectConversionRequestMessage", {
    sourceObjectUID: this.itemSelected.objectUID,
    targetObjectGID: this.chosenLW.weapon.id
  });
};
m.on("ObjectUpgradeEffectResultMessage", function (t) {
  e.isOpened && (0 !== t.status ? window.gui.openSimplePopup(r("ui.craft.failed")) : window.gui.openSimplePopup(r("ui.legendaryWeapon.successConversion"), r("ui.craft.success")), e.close());
});
m.on("ClientUIOpenedByObjectMessage", function (t) {
  t.type === f.CLIENT_UI_CONVERSION && g.open(e.id);
});
a.prototype._onOpen.call(this);
this.validationButton.setText(r("ui.legendaryWeapon.confirmConversion"));
this.popupMessage = r("ui.legendaryWeapon.warningConversion");
this.storageViewer.addFilters([function (e) {
  return e.isLegendaryWeapon() && !e.isAsleepLegendaryWeapon();
}]);
this.storageViewer.filterList();
a.prototype._reset.call(this);
this.chosenLW = null;
t = t || n;
u.getDataMap("Recipes", [e.id], function (n, o) {
  if (n) {
    return t(n);
  }
  var a = o[e.id];
  return a ? void u.getDataArray("Items", a.ingredientIds, function (e, n) {
    if (e) {
      return t(e);
    }
    for (var o = null, a = 0; a < n.length; a++) {
      if (n[a].typeId === c.types.cosmeticLegendaryWeapon) {
        o = n[a];
        break;
      }
    }
    return o ? l.getItems(o.recipeIds, function (e, n) {
      return e ? t(e) : (i.upgradeWeaponList = n, i.statsChoice.show(), void i._selectElement(d.EARTH, t));
    }) : t();
  }) : t(new Error("Unable to find recipes for legendary weapon"));
});
d.effectId === l ? i.unshift(l) : i.push(l);
t[l] = {
  weapon: s,
  upgradeEffect: r
};
t.effects.push(a.clone());
n = a.value;
t = t || n;
i.chosenLW = e;
l.getItems([p.CATALYST_ITEM], function (e, n) {
  return e ? t(e) : (i._refreshIngredientSlots(n, [_]), t());
});
t._pending = !0;
t._transition.delClassNames("highlight");
t._answer[e - 1] ? t._answer[e - 1].addClassNames("disabled") : t._answer[e + 1].addClassNames("disabled");
t._transition.addClassNames("highlight");
i._bg1.toggleClassName("disabled", 1 !== e);
i._bg2.toggleClassName("disabled", 2 !== e);
i._bg1.toggleClassName("highlight", 1 === e);
i._bg2.toggleClassName("highlight", 2 === e);
window.setTimeout(function () {
  i._bg1.toggleClassName("selected", 1 === e);
  i._bg2.toggleClassName("selected", 2 === e);
}, 301);
window.setTimeout(function () {
  t._textWrapper.delClassNames("display");
}, 1550);
window.setTimeout(function () {
  t._nextStep(e);
}, 1600);
window.setTimeout(function () {
  t._transition.delClassNames("highlight");
  t._pending = !1;
}, 2600);
i._bg1.toggleClassName("selected", 1 === e);
i._bg2.toggleClassName("selected", 2 === e);
t._transition.delClassNames("highlight");
t._pending = !1;
this._step = 0;
this._pending = !1;
this._transition = this.windowBody.createChild("div", {
  className: "transition"
});
this._question = i.createChild("div", {
  className: "question"
});
this._progressBar = i.createChild("div", {
  className: "progressBar"
});
this._progression = this._progressBar.createChild("div", {
  className: "progress"
});
this._bgWrappers = {};
o._id = n + 1;
o._id > 1 && o.hide();
o.createChild("div", {
  className: "bgLeft"
});
this._bgWrappers[n + 1] = o;
o._bg1 = o.createChild("div", {
  className: "bg1"
});
o._bg2 = o.createChild("div", {
  className: "bg2"
});
o.createChild("div", {
  className: "bgRight"
});
this._textWrapper = this.windowBody.createChild("div", {
  className: "textWrapper"
});
this._answer = {};
this._answer[1] = this._textWrapper.createChild("div", {
  className: "answer"
});
this._answer[1]._description = s.createChild("div", {
  className: "description"
});
this._answer[1]._button = this._answer[1].appendChild(new r({
  className: "greenButton"
}, e));
this._answer[1]._button._id = 1;
this._answer[1]._button._text = this._answer[1]._button.createChild("div", {
  className: "text"
});
this._answer[2] = this._textWrapper.createChild("div", {
  className: "answer"
});
this._answer[2]._description = l.createChild("div", {
  className: "description"
});
this._answer[2]._button = this._answer[2].appendChild(new r({
  className: "greenButton"
}, e));
this._answer[2]._button._id = 2;
this._answer[2]._button._text = this._answer[2]._button.createChild("div", {
  className: "text"
});
this.on("open", function (e) {
  e.relookingParams && (t._relookingParams = e.relookingParams);
  t._initForm(e);
});
e.relookingParams && (t._relookingParams = e.relookingParams);
t._initForm(e);
o(n, a);
e.exports = n;
n.prototype._initForm = function (e) {
  l.log("F_T_U_E.enters_survey", {
    timestamp_event: new c.DofusDate(c.now()).getServerDate().timestamp
  });
  var t = e.skipIntro ? 2 : 1;
  this._setProgressBar(t);
  this._setBg(t, 1);
  this._setTexts(t);
  this._step = t;
};
n.prototype._nextStep = function (e) {
  var t = s.getNextStepId(this._step, e, this._relookingParams),
    i = this._bgWrappers[this._step];
  this._answer[1].delClassNames("disabled");
  this._answer[2].delClassNames("disabled");
  i._bg1.delClassNames("highlight");
  i._bg1.delClassNames("disabled");
  i._bg1.delClassNames("selected");
  i._bg2.delClassNames("highlight");
  i._bg2.delClassNames("disabled");
  i._bg2.delClassNames("selected");
  0 !== t && this._setNewScene(t);
};
n.prototype._setTexts = function (e) {
  var t = s.getQuestion(e),
    i = s.getAnswers(e).answers,
    n = s.getAnswers(e).buttons;
  this._question.setText(t);
  this._answer[1]._description.setText(i[0]);
  this._answer[2]._description.setText(i[1]);
  this._answer[1]._button._text.setText(n[0]);
  this._answer[2]._button._text.setText(n[1]);
  this._textWrapper.addClassNames("display");
};
n.prototype._setBg = function (e, t) {
  this._bgWrappers[e].show();
  e !== t && this._bgWrappers[t].hide();
};
n.prototype._setProgressBar = function (e) {
  this._progressBar.toggleDisplay(e > 1);
  var t = e > 2 && e < 5,
    i = e > 4;
  this._progressBar.toggleClassName("step2", t);
  this._progressBar.toggleClassName("step3", i);
};
n.prototype._setNewScene = function (e) {
  this._setTexts(e);
  this._setProgressBar(e);
  this._setBg(e, this._step);
  this._step = e;
};
this._setProgressBar(t);
this._setBg(t, 1);
this._setTexts(t);
this._step = t;
this._answer[1].delClassNames("disabled");
this._answer[2].delClassNames("disabled");
i._bg1.delClassNames("highlight");
i._bg1.delClassNames("disabled");
i._bg1.delClassNames("selected");
i._bg2.delClassNames("highlight");
i._bg2.delClassNames("disabled");
i._bg2.delClassNames("selected");
0 !== t && this._setNewScene(t);
this._question.setText(t);
this._answer[1]._description.setText(i[0]);
this._answer[2]._description.setText(i[1]);
this._answer[1]._button._text.setText(n[0]);
this._answer[2]._button._text.setText(n[1]);
this._textWrapper.addClassNames("display");
this._bgWrappers[e].show();
e !== t && this._bgWrappers[t].hide();
this._progressBar.toggleClassName("step2", t);
this._progressBar.toggleClassName("step3", i);
this._setTexts(e);
this._setProgressBar(e);
this._setBg(e, this._step);
this._step = e;
u.open("characterCreation");
u.close("firstCharacterForm");
u.open("breedHighlightWindow", {
  breedId: n,
  relookingParams: i
});
u.close("firstCharacterForm");
t.getQuestion = r;
t.getAnswers = l;
t.getNextStepId = c;
n._relookingParams && (e.relookingParams = n._relookingParams);
c.open("characterCreation", e);
c.close("breedHighlightWindow");
n.orientation = w;
n._updateSprite(!0);
this._loadedHeads = {};
this._sex = Math.random() > .45 ? v : _;
this.headContainers = [];
this._setupCharacterOnCheckerboard();
this._god = this.windowBody.createChild("div", {
  className: "god"
});
d.addTooltip(f, s.getRoleText(m), {
  longTapExplanation: !0
});
f.id = m;
f.hide();
this._icons.push(f);
this._breedTitle = y.createChild("div", {
  className: "title"
});
this._breedDescription = y.createChild("div", {
  className: "breedDescription"
});
this._buttonM = M.appendChild(new r({
  className: ["sexBtn", "sexM"]
}, t));
this._buttonM._sex = _;
this._buttonF = M.appendChild(new r({
  className: ["sexBtn", "sexF"]
}, t));
this._buttonF._sex = v;
this._continue = M.appendChild(new r({
  className: "greenButton"
}, e));
this._continue.createChild("div", {
  className: "text",
  text: l("ui.classHighlight.continue")
});
this.on("open", function (e) {
  e.relookingParams && (n._relookingParams = e.relookingParams);
  n._breedId = e.breedId;
  n._loadAsyncData(i);
  this._init();
});
this.on("close", function () {
  n._reset();
});
e.relookingParams && (n._relookingParams = e.relookingParams);
n._breedId = e.breedId;
n._loadAsyncData(i);
this._init();
o(n, a);
e.exports = n;
n.prototype._init = function () {
  this.spriteStatus = {};
  var e = s.getBreedData(this._breedId),
    t = s.getBgClass(this._breedId),
    i = s.getGodClass(this._breedId),
    n = s.getTitle(this._breedId),
    o = s.getRoles(this._breedId);
  this.windowBody.toggleClassName(t, !0);
  this._god.toggleClassName(i, !0);
  this._title.setText(n);
  this._breedTitle.setText(e.longNameId);
  this._breedDescription.setText(e.gameplayDescriptionId);
  this._icons.forEach(function (e) {
    var t = o.indexOf(e.id) > -1;
    e.toggleDisplay(t);
  });
};
n.prototype._reset = function () {
  this.spriteStatus = {};
  this.windowBody.setClassNames("windowBody");
  this._god.setClassNames("god");
};
n.prototype._setupCharacterOnCheckerboard = function () {
  this.characterOnCheckerboard = this.windowBody.createChild("div", {
    className: "characterOnCheckerboard"
  });
  this.CheckerboardImage = this.characterOnCheckerboard.createChild("div", {
    className: "checkerboardImage"
  });
  this.characterDisplay = this.characterOnCheckerboard.appendChild(new h({
    scale: 3
  }));
};
n.prototype._loadAsyncData = function (e) {
  var t = this;
  p.getAllDataMap("Heads", function (i, n) {
    return i ? e(i) : (t.headsMap = n, void e());
  });
};
n.prototype._updateSprite = function (e) {
  function t(e, t, i) {
    var n = [];
    return Object.keys(i).forEach(function (o) {
      var a = i[o];
      a.breed === e && a.gender === t && n.push(o);
    }), n;
  }
  var i = s.getBreedData(this._breedId),
    n = m.parseLook(u, i[(this._sex === v ? "female" : "male") + "Look"], "Breed: " + this._breedId + " sex: " + this._sex);
  this._buttonM.toggleClassName("on", this._buttonM._sex === this._sex);
  this._buttonF.toggleClassName("on", this._buttonF._sex === this._sex);
  var o = n.skin,
    a = n.scale,
    r = t(this._breedId, this._sex, this.headsMap),
    l = r[Math.floor(Math.random() * y)];
  this._headId = l;
  var c = this.headsMap[l].skins,
    d = s.getBreedColors(this._breedId, this._sex);
  this.spriteStatus.bodySkin === o && this.spriteStatus.headSkin === c && this.spriteStatus.colorsHash === d && this.spriteStatus.orientation === this.orientation && this.spriteStatus.scale === a || (this.spriteStatus.bodySkin = o, this.spriteStatus.headSkin = c, this.spriteStatus.colorsHash = d, this.spriteStatus.orientation = this.orientation, this.spriteStatus.scale = a, this._drawCharacter(e));
};
n.prototype._buildEntityLook = function () {
  return {
    bonesId: 1,
    indexedColors: this.spriteStatus.colorsHash,
    scales: [this.spriteStatus.scale],
    skins: [this.spriteStatus.bodySkin, this.spriteStatus.headSkin],
    subentities: []
  };
};
n.prototype._drawCharacter = function (e) {
  this.lastRendering = Date.now();
  var t = this;
  this.characterDisplay.setLook(this._buildEntityLook(), {
    boneType: "characters/",
    skinType: "characters/",
    direction: this.orientation
  }, function () {
    e && f(t.characterDisplay, 300, 50);
  });
};
this.windowBody.toggleClassName(t, !0);
this._god.toggleClassName(i, !0);
this._title.setText(n);
this._breedTitle.setText(e.longNameId);
this._breedDescription.setText(e.gameplayDescriptionId);
this._icons.forEach(function (e) {
  var t = o.indexOf(e.id) > -1;
  e.toggleDisplay(t);
});
this.spriteStatus = {};
this.windowBody.setClassNames("windowBody");
this._god.setClassNames("god");
this.characterOnCheckerboard = this.windowBody.createChild("div", {
  className: "characterOnCheckerboard"
});
this.CheckerboardImage = this.characterOnCheckerboard.createChild("div", {
  className: "checkerboardImage"
});
this.characterDisplay = this.characterOnCheckerboard.appendChild(new h({
  scale: 3
}));
this._buttonM.toggleClassName("on", this._buttonM._sex === this._sex);
this._buttonF.toggleClassName("on", this._buttonF._sex === this._sex);
n = u.parseIndexedColor(o[s]).color;
a.push(u.getIndexedColor(s + 1, n.r, n.g, n.b));
t.getTitle = n;
t.getGodClass = o;
t.getBgClass = a;
t.getBreedData = s;
t.getBreedColors = r;
t.getRoles = l;
t.getRoleText = c;
this.currentStepId = -1;
this.currentSpecialStepId = -1;
this._dialogsData = null;
this._init = !1;
this._setupListeners();
this._init = !0;
this.conditionTypeEnum = d;
l(n, o);
e.exports = n;
n.prototype._setupListeners = function () {
  var e = this;
  this._init || (window.isoEngine.on("mapChange", function (t) {
    e.stopScenario();
    e.playScenario();
    t && a.ALBUERA_SUBAREA_IDS[t.subAreaId] && e.checkCondition(d.CHANGE_MAP);
  }), window.isoEngine.on("mapLoaded", function () {
    e.stopScenario();
    e.playScenario();
    e.checkCondition(d.CHANGE_MAP);
    e.checkCondition(d.MAP_LOADED);
  }), r.on("open", function (t) {
    var i = {
      windowId: t.id,
      tabId: t.extraParams && t.extraParams.tabId
    };
    e.checkCondition(d.WINDOW_OPENED, i);
  }), r.on("opened", function (t) {
    var i = {
      windowId: t.id,
      tabId: t.extraParams && t.extraParams.tabId
    };
    e.checkCondition(d.WINDOW_OPENING_FINISHED, i);
  }), r.on("closed", function (t) {
    e.checkCondition(d.WINDOW_CLOSED, {
      windowId: t.id
    });
  }), window.isoEngine.on("highlightElements", function () {
    e.checkCondition(d.HIGHLIGHT_ELEMENTS);
  }), window.isoEngine.on("movementConfirm", function (t) {
    e.checkCondition(d.MOVEMENT_CONFIRM, {
      cellId: t
    });
  }), window.isoEngine.on("fightTap", function (t) {
    e.checkCondition(d.FIGHT_TAP, {
      cellId: t
    });
  }), window.isoEngine.on("placementTap", function (t) {
    e.checkCondition(d.PLACEMENT_TAP, {
      cellId: t
    });
  }), window.gui.fightManager.on("spellCasted", function () {
    e.checkCondition(d.SPELL_CASTED);
  }), window.gui.wBody.on("dom.touchend", function () {
    e.checkCondition(d.TAP_ANYWHERE);
  }), window.gui.fightManager.on("GameFightTurnStart", function (t) {
    e.checkCondition(d.FIGHTER_TURN, {
      id: t
    });
  }), window.gui.fightManager.on("finishTurn", function () {
    e.checkCondition(d.FINISH_TURN);
  }), window.foreground.on("spellSelected", function () {
    e.checkCondition(d.SPELL_SELECTED);
  }), window.foreground.on("spellCanceled", function () {
    e.checkCondition(d.SPELL_CANCELED);
  }), window.gui.on("GameFightStartMessage", function () {
    e.checkCondition(d.FIGHT_START);
  }), window.foreground.on("fightPlacementPosition", function () {
    e.checkCondition(d.FIGHT_PLACEMENT_POSITION);
  }), window.gui.playerData.quests.on("listUpdated", function () {
    e.playScenario();
    e.checkCondition(d.QUEST_ALREADY_STARTED);
  }), window.gui.playerData.quests.on("questStarted", function (t) {
    t === a.ALBUERA_QUEST_ID ? e.changeStep(e._getCurrentStep()) : e.checkCondition(d.NEW_QUEST_START, {
      questId: t
    });
  }), window.gui.playerData.quests.on("questUpdate", function (t) {
    t === a.ALBUERA_QUEST_ID && e.changeStep(e._getCurrentStep());
  }), window.gui.playerData.quests.on("stepValidated", function (t) {
    t.questId === a.ALBUERA_QUEST_ID && e.changeStep(e._getCurrentStep());
  }), window.gui.playerData.inventory.on("weaponChanged", function () {
    e.checkCondition(d.WEAPON_CHANGED);
  }), window.gui.on("CharacterLevelUpMessage", function () {
    e.checkCondition(d.LEVEL_UP);
  }));
};
n.prototype._prepareDialogs = function (e) {
  var t = this;
  if (this._dialogsData) {
    return e();
  }
  var i,
    n = a.STEPS,
    o = a.SPECIAL_STEPS,
    r = [];
  for (i = 0; i < n.length; i++) {
    n[i].dialog && r.push(n[i].dialog.id);
  }
  for (i = 0; i < o.length; i++) {
    o[i].dialog && r.push(o[i].dialog.id);
  }
  s.getDataMap("NpcMessages", r, function (i, n) {
    return i ? e("Unable to get NPC Messages for Albuera :" + i) : (t._dialogsData = n, void e());
  });
};
n.prototype._isOnAlbueraMap = function () {
  return a.ALBUERA_SUBAREA_IDS[window.gui.playerData.position.subAreaId];
};
n.prototype.playScenario = function () {
  var e = this;
  this.currentStepId === -1 && this._isOnAlbueraMap() && this._prepareDialogs(function (t) {
    t && console.error("Albuera: playScenario -> _prepareDialogs:" + t);
    var i = e._getCurrentStep();
    e.changeStep(i);
  });
};
n.prototype.stopScenario = function () {
  this.currentStepId !== -1 && this.changeStep(-1);
};
n.prototype.checkCondition = function (e, t) {
  if (this._isOnAlbueraMap()) {
    if (this.currentSpecialStepId === -1) {
      for (var i in a.SPECIAL_STEPS) {
        a.SPECIAL_STEPS.hasOwnProperty(i) && a.SPECIAL_STEPS[i].startingCondition(e, t) && this.changeSpecialStep(i);
      }
    } else {
      var n = a.SPECIAL_STEPS[this.currentSpecialStepId];
      n.endingCondition(e, t) && this.changeSpecialStep(-1);
    }
    if (this.currentStep) {
      var o = this.currentStepId + this.currentStep.endingCondition(e, t);
      o !== this.currentStepId && this.changeStep(o);
    }
  }
};
n.prototype._getCurrentStep = function () {
  var e = window.gui.playerData.quests.active[a.ALBUERA_QUEST_ID];
  if (e) {
    for (var t = a.STEPS, i = 0; i < t.length; i++) {
      if (t[i].questStepCheckpoint === e.stepId) {
        return i;
      }
    }
  }
  return -1;
};
n.prototype.changeStep = function (e) {
  if (this.currentStepId = e, this.currentStep && (window.gui.portraitDialogUI.removeDialog(), this.currentStep.executeEnd()), this.currentStep = a.STEPS[this.currentStepId], this.currentStep) {
    var t = this.currentStep.dialog;
    !window.foreground.lockMap.loadMap && this._dialogsData && t && this._dialogsData[t.id] && window.gui.portraitDialogUI.displayDialog({
      portraitName: t.portrait,
      npcName: c("ui.albueraTutorial.portraitName"),
      content: this._dialogsData[t.id].messageId,
      rightPosition: Boolean(t.rightPosition),
      blockClick: Boolean(t.blockClick)
    });
    this.currentStep.executeStart();
  }
  this.emit("stepChanged");
};
n.prototype.changeSpecialStep = function (e) {
  var t = a.SPECIAL_STEPS[this.currentSpecialStepId];
  if (t && (window.gui.portraitDialogUI.removeDialog(), t.executeEnd()), this.currentSpecialStepId = e, t = a.SPECIAL_STEPS[this.currentSpecialStepId]) {
    var i = t.dialog;
    this._dialogsData && i && (window.gui.portraitDialogUI.displayDialog({
      portraitName: i.portrait,
      npcName: c("ui.albueraTutorial.portraitName"),
      content: this._dialogsData[i.id].messageId,
      rightPosition: Boolean(i.rightPosition),
      blockClick: Boolean(i.blockClick)
    }), t.executeStart());
  }
  this.emit("stepChanged");
};
n.prototype.isBehaviourEnabled = function (e) {
  return !this.currentStep || this.currentStep.disabledBehaviours.indexOf(e) < 0;
};
n.prototype.getDefaultAttackSpell = function () {
  return a.ATTACK_SPELLS[window.gui.playerData.characterBreed.id] || 0;
};
n.prototype.enableAttackSpell = function (e, t) {
  t = t || {};
  var i = window.gui.shortcutBar;
  i.openPanel("spell", 0);
  var n = i.getSpellSlotBySpellId(e);
  n || (console.error(new Error("Albuera: The spell id " + e + " does not exist in the shortcut bar")), n = i.getSpellSlotByIndex(0));
  i.enableSpellSlots(!1);
  n.enableBehaviour(!0);
  t.displayArrow && window.gui.hintAnimationManager.playUITap(n, {
    side: 0,
    doubleTap: !1
  });
};
n.prototype.displayHighlightedSpellButtons = function (e) {
  var t = r.getWindow("grimoire");
  if (t) {
    var i = t.tabs.tabsMap.spells;
    i && i.target.displayHighlightPlusBtn(e);
  }
};
e.stopScenario();
e.playScenario();
t && a.ALBUERA_SUBAREA_IDS[t.subAreaId] && e.checkCondition(d.CHANGE_MAP);
e.stopScenario();
e.playScenario();
e.checkCondition(d.CHANGE_MAP);
e.checkCondition(d.MAP_LOADED);
e.playScenario();
e.checkCondition(d.QUEST_ALREADY_STARTED);
!window.foreground.lockMap.loadMap && this._dialogsData && t && this._dialogsData[t.id] && window.gui.portraitDialogUI.displayDialog({
  portraitName: t.portrait,
  npcName: c("ui.albueraTutorial.portraitName"),
  content: this._dialogsData[t.id].messageId,
  rightPosition: Boolean(t.rightPosition),
  blockClick: Boolean(t.blockClick)
});
this.currentStep.executeStart();
n || (console.error(new Error("Albuera: The spell id " + e + " does not exist in the shortcut bar")), n = i.getSpellSlotByIndex(0));
i.enableSpellSlots(!1);
n.enableBehaviour(!0);
t.displayArrow && window.gui.hintAnimationManager.playUITap(n, {
  side: 0,
  doubleTap: !1
});
t.ALBUERA_QUEST_ID = 3841;
t.ALBUERA_AREA_ID = 56;
window.gui.menuBar.enableTutorialRestrictedFeatures([]);
window.isoEngine.setUnblockedCells(d);
window.isoEngine.setUnblockedNpcId(0);
window.gui.hintAnimationManager.playHintOnCell(317, {
  nbCells: 9
});
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.isoEngine.resetUnblockedCells();
window.isoEngine.resetUnblockedNpcId();
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures([]);
window.isoEngine.setUnblockedCells({});
window.isoEngine.setUnblockedNpcId(3888);
window.gui.hintAnimationManager.playNPCTap(3888, {
  animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_TOP_POINT_TO_RIGHT,
  doubleTap: !1
});
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.isoEngine.resetUnblockedCells();
window.isoEngine.resetUnblockedNpcId();
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures([]);
window.isoEngine.setUnblockedNpcId(0);
window.gui.hintAnimationManager.playHintOnCell(307, {
  nbCells: 1
});
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.isoEngine.resetUnblockedNpcId();
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures([]);
window.gui.hintAnimationManager.playMonsterTap(4192, {
  animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_TOP_POINT_TO_RIGHT,
  doubleTap: !1
});
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures([]);
window.foreground.tapOptions && "fightPlacement" === window.foreground.tapOptions.mode && setTimeout(function () {
  var e = window.foreground.tapOptions.possiblePlacements.filter(function (e) {
    return e !== window.actorManager.userActor.cellId;
  });
  window.gui.hintAnimationManager.playHintOnCell(e[0], {
    nbCells: 1
  });
}, 100);
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures([]);
o.pointToTimelineButton("fightReadyBtn");
window.isoEngine.setUnblockedCells({});
window.isoEngine.setUnblockedNpcId(0);
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.hintAnimationManager.stopHint();
window.isoEngine.resetUnblockedCells();
window.isoEngine.resetUnblockedNpcId();
window.gui.menuBar.enableTutorialRestrictedFeatures([]);
window.gui.hintAnimationManager.playHintOnCell(359, {
  nbCells: 1
});
window.isoEngine.setUnblockedCells({
  359: !0
});
window.isoEngine.setUnblockedNpcId(0);
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.hintAnimationManager.stopHint();
window.isoEngine.resetUnblockedCells();
window.isoEngine.resetUnblockedNpcId();
window.gui.menuBar.enableTutorialRestrictedFeatures([]);
window.gui.scenarioManager.enableAttackSpell(window.gui.scenarioManager.getDefaultAttackSpell(), {
  displayArrow: !0
});
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.shortcutBar.enableSpellSlots(!0);
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures([]);
window.gui.hintAnimationManager.playMonsterTap(4192, {
  animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_TOP_POINT_TO_RIGHT,
  doubleTap: !1
});
window.isoEngine.setUnblockedCells({
  374: !0
});
window.isoEngine.setUnblockedNpcId(0);
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.hintAnimationManager.stopHint();
window.isoEngine.resetUnblockedCells();
window.isoEngine.resetUnblockedNpcId();
window.gui.menuBar.enableTutorialRestrictedFeatures([]);
o.pointToTimelineButton("turnReadyBtn");
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures(["spells"]);
o.pointToMenuIcon("Spell");
window.isoEngine.setUnblockedNpcId(0);
window.isoEngine.resetUnblockedNpcId();
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures([]);
window.gui.scenarioManager.displayHighlightedSpellButtons(!0);
window.isoEngine.setUnblockedNpcId(0);
a.getWindow("grimoire").changePosition(0, 0);
window.isoEngine.resetUnblockedNpcId();
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.scenarioManager.displayHighlightedSpellButtons(!1);
window.gui.menuBar.enableTutorialRestrictedFeatures([]);
o.pointToConfirmUpgradeSpell();
window.isoEngine.setUnblockedNpcId(0);
window.isoEngine.resetUnblockedNpcId();
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures(["spells"]);
o.pointToWindowCloseButton("grimoire");
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures(["spells"]);
window.gui.hintAnimationManager.playHintOnCell(307, {
  nbCells: 1
});
window.isoEngine.setUnblockedNpcId(0);
window.isoEngine.resetUnblockedNpcId();
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures(["inventory"]);
window.isoEngine.setUnblockedNpcId(0);
o.pointToMenuIcon("Bag");
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.isoEngine.resetUnblockedNpcId();
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures([]);
window.isoEngine.setUnblockedNpcId(0);
a.getWindow("equipment").changePosition(s.windowFullScreenWidth, 0);
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.isoEngine.resetUnblockedNpcId();
window.gui.menuBar.enableTutorialRestrictedFeatures([]);
window.isoEngine.setUnblockedNpcId(0);
o.pointToStorageFirstSlotBox({
  doubleTap: !0
});
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.isoEngine.resetUnblockedNpcId();
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures([]);
window.isoEngine.setUnblockedNpcId(0);
o.pointToWindowCloseButton("equipment");
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.isoEngine.resetUnblockedNpcId();
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures(["spells"]);
window.gui.hintAnimationManager.playHintOnCell(329, {
  nbCells: 1
});
window.isoEngine.setUnblockedCells({
  329: !0
});
window.isoEngine.setUnblockedNpcId(0);
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.hintAnimationManager.stopHint();
window.isoEngine.resetUnblockedCells();
window.isoEngine.resetUnblockedNpcId();
window.gui.menuBar.enableTutorialRestrictedFeatures(["spells"]);
window.gui.scenarioManager.enableAttackSpell(0, {
  displayArrow: !0
});
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.shortcutBar.enableSpellSlots(!0);
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures(["spells"]);
window.gui.hintAnimationManager.playMonsterTap(4194, {
  animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_TOP_POINT_TO_RIGHT,
  doubleTap: !1
});
window.isoEngine.setUnblockedCells({
  316: !0
});
window.isoEngine.setUnblockedNpcId(0);
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.hintAnimationManager.stopHint();
window.isoEngine.resetUnblockedCells();
window.isoEngine.resetUnblockedNpcId();
window.gui.menuBar.enableTutorialRestrictedFeatures(["carac"]);
o.pointToMenuIcon("Carac");
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures([]);
a.getWindow("characUpdate").changePosition(0, 0);
window.gui.menuBar.enableTutorialRestrictedFeatures(["carac", "inventory", "spells"]);
window.isoEngine.setUnblockedNpcId(0);
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.isoEngine.resetUnblockedNpcId();
window.gui.menuBar.enableTutorialRestrictedFeatures(["carac", "inventory", "market", "spells"]);
window.gui.hintAnimationManager.playUITap(window.gui.shopFloatingToolbar, {
  animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.RIGHT_BOTTOM_POINT_TO_RIGHT,
  doubleTap: !1
});
window.isoEngine.setUnblockedNpcId(0);
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.isoEngine.resetUnblockedNpcId();
window.gui.menuBar.enableTutorialRestrictedFeatures(["carac", "inventory", "market", "spells"]);
window.isoEngine.setUnblockedNpcId(0);
o.pointToFirstArticleShopButton();
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.isoEngine.resetUnblockedNpcId();
window.gui.menuBar.enableTutorialRestrictedFeatures(["carac", "inventory", "market", "spells"]);
window.gui.hintAnimationManager.playInteractiveElementTap(513203, {
  animationPath: window.gui.hintAnimationManager.ANIMATION_PATH.LEFT_TOP_POINT_TO_RIGHT,
  doubleTap: !1
});
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures(["carac", "inventory", "market", "spells", "quests"]);
o.pointToMenuIcon("Book");
window.isoEngine.setUnblockedNpcId(0);
window.isoEngine.resetUnblockedNpcId();
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures(["market", "quests"]);
window.isoEngine.setUnblockedNpcId(0);
window.isoEngine.resetUnblockedNpcId();
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.menuBar.enableTutorialRestrictedFeatures(["carac", "inventory", "market", "spells", "quests", "worldMap"]);
o.pointToMenuIcon("Map");
window.isoEngine.setUnblockedNpcId(0);
window.isoEngine.resetUnblockedNpcId();
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures(["market", "worldMap"]);
window.isoEngine.setUnblockedNpcId(0);
window.isoEngine.resetUnblockedNpcId();
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.menuBar.enableTutorialRestrictedFeatures(["carac", "inventory", "market", "spells", "quests", "worldMap"]);
o.pointToChallenge();
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.hintAnimationManager.stopHint();
window.gui.menuBar.enableTutorialRestrictedFeatures(["carac", "inventory", "market", "spells", "quests", "worldMap", "Help"]);
o.pointToMenuIcon("Help");
window.isoEngine.setUnblockedNpcId(0);
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.gui.hintAnimationManager.stopHint();
window.isoEngine.resetUnblockedNpcId();
window.gui.menuBar.enableTutorialRestrictedFeatures(["carac", "inventory", "market", "spells", "quests", "worldMap", "Help"]);
window.isoEngine.setUnblockedNpcId(0);
window.gui.menuBar.disableTutorialRestrictedFeatures();
window.isoEngine.resetUnblockedNpcId();
l.call(this, "div", {
  className: "PortraitDialogUi"
});
this._init = !1;
this._createDom();
this._setupListeners();
this._init = !0;
r(n, l);
e.exports = n;
n.prototype._createDom = function () {
  if (!this._init) {
    this._portrait = this.appendChild(new l("div", {
      className: "portrait"
    }));
    var e = this.appendChild(new l("div", {
        className: "dialog"
      })),
      t = e.appendChild(new l("div", {
        className: "dialogHeader"
      }));
    this._npcName = t.appendChild(new l("div", {
      className: "dialogHeaderTitle"
    }));
    this._content = e.appendChild(new l("div", {
      className: "dialogContent"
    }));
    this.hide();
  }
};
n.prototype._setupListeners = function () {
  var e = this;
  this._init || window.gui.on("disconnect", function () {
    e.hide();
  });
};
n.prototype._setPortrait = function (e) {
  var t = this;
  o.preloadImage("ui/portrait/" + e + ".png", function (e) {
    t._portrait.setStyle("backgroundImage", e);
  });
};
n.prototype._setNpcName = function (e) {
  this._npcName.setText(e);
};
n.prototype._setDialogContent = function (e) {
  this._content.clearContent();
  e instanceof l ? this._content.appendChild(e) : this._content.appendChild(s.process(e));
};
n.prototype._refreshPosition = function (e) {
  this.setStyle("bottom", a.screenHeight - (a.mapTop + a.mapHeight) + c + "px");
  e ? this.setStyles({
    left: "",
    right: a.screenWidth - (a.mapLeft + a.mapWidth) + "px"
  }) : this.setStyles({
    left: d + "px",
    right: ""
  });
};
n.prototype.displayDialog = function (e) {
  this._setPortrait(e.portraitName);
  this._setNpcName(e.npcName);
  this._setDialogContent(e.content);
  this._refreshPosition(e.rightPosition);
  this.toggleClassName("blockClick", e.blockClick);
  this.show();
};
n.prototype.removeDialog = function () {
  this.hide();
};
this._npcName = t.appendChild(new l("div", {
  className: "dialogHeaderTitle"
}));
this._content = e.appendChild(new l("div", {
  className: "dialogContent"
}));
this.hide();
this._content.clearContent();
e instanceof l ? this._content.appendChild(e) : this._content.appendChild(s.process(e));
this.setStyle("bottom", a.screenHeight - (a.mapTop + a.mapHeight) + c + "px");
e ? this.setStyles({
  left: "",
  right: a.screenWidth - (a.mapLeft + a.mapWidth) + "px"
}) : this.setStyles({
  left: d + "px",
  right: ""
});
this._setPortrait(e.portraitName);
this._setNpcName(e.npcName);
this._setDialogContent(e.content);
this._refreshPosition(e.rightPosition);
this.toggleClassName("blockClick", e.blockClick);
this.show();
this.positionReference = e;
this.params = t;
this.elementReference = e;
this.params = t;
g.call(this, "div", {
  className: "pointerHint"
});
this.reset();
g.call(this, "div", {
  className: "HintAnimationManager"
});
this.targetedElement = null;
this._tween = null;
this.pointerHint = null;
this.fxCircles = null;
this.ANIMATION_PATH = I;
this._init = !1;
this._setupDOM();
this._setupListeners();
o.prototype.getPosition = function () {
  return {};
};
f(a, o);
a.prototype.getPosition = function () {
  return this.element && this.element.rootElement ? w(this.element.rootElement) : (console.warn("UIElement.getPosition - The element does not exist or does not have rootElement"), {});
};
f(s, o);
s.prototype.getActor = function () {
  var e = window.actorManager.getActor(this.actorId);
  return e ? e : (console.warn("ActorElement.getActor - Actor not found"), null);
};
s.prototype.getPosition = function () {
  var e = this.getActor();
  if (!e) {
    return console.warn("ActorElement.getPosition - Actor not found"), {};
  }
  var t = n(e.x + C.x, e.y + C.y);
  return {
    top: t.y,
    left: t.x,
    right: t.x,
    bottom: t.y,
    width: 0,
    height: 0
  };
};
f(r, s);
r.prototype.getActor = function () {
  var e = window.actorManager.getActorFromNpcId(this.npcId);
  return e ? e : (console.warn("NPCElement.getActor - NPC not found"), null);
};
f(l, s);
l.prototype.getActor = function () {
  var e = window.actorManager.getActorFromMonsterId(this.monsterId);
  return e ? e : (console.warn("MonsterElement.getActor - Monster not found"), null);
};
f(c, o);
c.prototype.getPosition = function () {
  if (!this.element) {
    return console.warn("InteractiveElement.getPosition - Element does not exist"), {};
  }
  var e = this.element.bbox,
    t = n(e[0] + (e[1] - e[0]) / 2, e[2] + (e[3] - e[2]) / 2);
  return {
    top: t.y,
    left: t.x,
    right: t.x,
    bottom: t.y,
    width: 0,
    height: 0
  };
};
f(d, o);
d.prototype.getPosition = function () {
  if (!this.cellId) {
    return console.warn("CellElement.getPosition - No cellId"), {};
  }
  var e = window.isoEngine.mapRenderer.getCellSceneCoordinate(this.cellId),
    t = n(e.x, e.y);
  return {
    top: t.y,
    left: t.x,
    right: t.x,
    bottom: t.y,
    width: 0,
    height: 0
  };
};
u.prototype._getPositionReference = function () {
  return {
    x: this.positionReference.x,
    y: this.positionReference.y
  };
};
u.prototype.getPosition = function () {
  return {
    x: this.x,
    y: this.y,
    alpha: this.alpha,
    rotation: this.rotation
  };
};
Object.defineProperty(u.prototype, "x", {
  get: function () {
    return this._getPositionReference().x + this.params.x;
  }
});
Object.defineProperty(u.prototype, "y", {
  get: function () {
    return this._getPositionReference().y + this.params.y;
  }
});
Object.defineProperty(u.prototype, "alpha", {
  get: function () {
    return this.params.alpha;
  }
});
Object.defineProperty(u.prototype, "rotation", {
  get: function () {
    return this.params.rotation;
  }
});
f(h, u);
h.prototype._getPositionReference = function () {
  return {
    x: this.elementReference.getPosition().left,
    y: this.elementReference.getPosition().top
  };
};
f(p, g);
p.prototype.reset = function () {
  this._x = 0;
  this._y = 0;
  this._scaleX = 1;
  this._scaleY = 1;
  this._rotation = 0;
  this._alpha = 0;
  this.refresh();
};
p.prototype.refresh = function () {
  this.setStyles({
    transform: "translate(" + this._x + "px," + this._y + "px) scale(" + this._scaleX + "," + this._scaleY + ") rotate(" + this._rotation + "deg) ",
    opacity: this._alpha
  });
};
Object.defineProperty(p.prototype, "x", {
  get: function () {
    return this._x;
  },
  set: function (e) {
    this._x = e;
    this.refresh();
  }
});
Object.defineProperty(p.prototype, "y", {
  get: function () {
    return this._y;
  },
  set: function (e) {
    this._y = e;
    this.refresh();
  }
});
Object.defineProperty(p.prototype, "scaleX", {
  get: function () {
    return this._scaleX;
  },
  set: function (e) {
    this._scaleX = e;
    this.refresh();
  }
});
Object.defineProperty(p.prototype, "scaleY", {
  get: function () {
    return this._scaleY;
  },
  set: function (e) {
    this._scaleY = e;
    this.refresh();
  }
});
Object.defineProperty(p.prototype, "rotation", {
  get: function () {
    return this._rotation;
  },
  set: function (e) {
    this._rotation = e;
    this.refresh();
  }
});
Object.defineProperty(p.prototype, "alpha", {
  get: function () {
    return this._alpha;
  },
  set: function (e) {
    this._alpha = e;
    this.refresh();
  }
});
f(m, g);
e.exports = m;
m.prototype._setupListeners = function () {
  var e = this;
  this._init || (window.gui.on("disconnect", function () {
    e.stopHint();
  }), window.isoEngine.on("mapChange", function () {
    e.stopHint();
  }), window.isoEngine.mapRenderer.on("ready", function () {
    e.currentElement && e.playTap(e.currentElement, e.currentParams);
  }), this._init = !0);
};
m.prototype._setupDOM = function () {
  this._init || (this.pointerHint = this.appendChild(new p()), this.fxCircles = this.createChild("div", {
    className: "fxCircles"
  }), this.fxCircles.createChild("div", {
    className: "circle1"
  }), this.circle2 = this.fxCircles.createChild("div", {
    className: "circle2"
  }), this.fxCircles.createChild("div", {
    className: "blurryCircle"
  }));
};
m.prototype.playCircles = function (e, t, i) {
  this.fxCircles.setStyle("transform", "translate(" + e + "px," + t + "px)");
  this.fxCircles.toggleClassName("activeAnimation", !0);
  this.circle2.toggleDisplay(i);
};
m.prototype.stopCircles = function () {
  this.fxCircles.toggleClassName("activeAnimation", !1);
  this.circle2.toggleDisplay(!0);
};
m.prototype.stopHint = function () {
  this._tween && (this._tween.playing || this._tween.starting) && this._tween.stop();
  window.isoEngine.mapRenderer.cellHintManager.stopAnimation();
  this.stopCircles();
  this.pointerHint.reset();
  this.delClassNames(["inMap"]);
};
m.prototype.playHintOnCell = function (e, t) {
  this.playCellTap(e, {
    nbCells: t.nbCells,
    animationPath: I.POINT_TO_BOTTOM
  });
};
m.prototype.playInteractiveElementTap = function (e, t) {
  this.playTap(new c(e), t);
};
m.prototype.playMonsterTap = function (e, t) {
  this.playTap(new l(e), t);
};
m.prototype.playNPCTap = function (e, t) {
  this.playTap(new r(e), t);
};
m.prototype.playUITap = function (e, t) {
  this.playTap(new a(e), t);
};
m.prototype.playCellTap = function (e, t) {
  this.playTap(new d(e), t);
};
m.prototype.playTap = function (e, t) {
  var i = this;
  if (this.stopHint(), window.foreground.lockMap.loadMap) {
    return this.currentElement = e, void (this.currentParams = t);
  }
  if (this.currentElement = null, this.currentParams = null, !(e && e instanceof o)) {
    return console.error("HintAnimationManager - The element does not exist or is not a Element");
  }
  var n,
    a = e.getPosition(),
    s = new h(e, {
      x: a.width / 2,
      y: a.height / 2,
      rotation: 0,
      alpha: 0
    });
  switch (this._tween = new v(this.pointerHint, ["x", "y", "alpha", "rotation"]), e instanceof d && t.nbCells && window.isoEngine.mapRenderer.cellHintManager.playAnimation("cases_" + t.nbCells, e.cellId), t.animationPath) {
    case I.POINT_TO_BOTTOM:
      n = new h(e, {
        x: -(M.w + T) / 2,
        y: -(M.h + T)
      });
      s = new h(e, {
        x: 0,
        y: 0,
        rotation: 0,
        alpha: 0
      });
      this.addClassNames("inMap");
      this._tween.from(new u(n, {
        x: 0,
        y: -50,
        alpha: 0,
        rotation: 90
      })).to(new u(n, {
        x: 0,
        y: 0,
        alpha: 1,
        rotation: 180
      }), 10, y.quadOut).to(new u(n, {
        x: 0,
        y: 0,
        alpha: 1,
        rotation: 180
      }), 20).to(new u(n, {
        x: 0,
        y: 30,
        alpha: 1,
        rotation: 180
      }), 20, y.quadOut).to(new u(n, {
        x: 0,
        y: 0,
        alpha: 1,
        rotation: 180
      }), 20, y.quadOut).to(new u(n, {
        x: 0,
        y: 30,
        alpha: 1,
        rotation: 180
      }), 20, y.quadOut).to(new u(n, {
        x: 0,
        y: 0,
        alpha: 1,
        rotation: 180
      }), 20, y.quadOut).to(new u(n, {
        x: 0,
        y: 30,
        alpha: 1,
        rotation: 180
      }), 20, y.quadOut).to(new u(n, {
        x: 0,
        y: 0,
        alpha: 1,
        rotation: 180
      }), 20, y.quadOut).to(new u(n, {
        x: 0,
        y: 30,
        alpha: 1,
        rotation: 140
      }), 3, y.quadOut, null, function () {
        i.playCircles(s.x - 60, s.y - 60, !1);
      }).to(new u(n, {
        x: 0,
        y: 30,
        alpha: 1,
        rotation: 180
      }), 2, y.quadOut).wait(10).to(new u(n, {
        x: 0,
        y: -150,
        alpha: 0,
        rotation: 180
      }), 20, y.quadOut);
      break;
    case I.LEFT_TOP_POINT_TO_RIGHT:
      n = new h(e, {
        x: -M.w,
        y: -M.h + T
      });
      this._tween.from(new u(n, {
        x: -50,
        y: -50,
        alpha: 0,
        rotation: 90
      })).to(new u(n, {
        x: 0,
        y: 0,
        alpha: 1,
        rotation: 140
      }), 10, y.quadOut).to(new u(n, {
        x: 0,
        y: 0,
        alpha: 1,
        rotation: 140
      }), 20).to(new u(n, {
        x: 30,
        y: 30,
        alpha: 1,
        rotation: 110
      }), 2, y.quadOut, null, function () {
        i.playCircles(s.x - 60, s.y - 60, t.doubleTap);
      }).to(new u(n, {
        x: 30,
        y: 30,
        alpha: 1,
        rotation: 140
      }), 2, y.quadOut);
      t.doubleTap && this._tween.to(new u(n, {
        x: 30,
        y: 30,
        alpha: 1,
        rotation: 110
      }), 2, y.quadOut).to(new u(n, {
        x: 30,
        y: 30,
        alpha: 1,
        rotation: 140
      }), 2, y.quadOut);
      this._tween.wait(10).to(new u(n, {
        x: -150,
        y: -150,
        alpha: 0,
        rotation: 140
      }), 20, y.quadOut);
      break;
    case I.RIGHT_BOTTOM_POINT_TO_RIGHT:
      this.pointerHint.scaleY = -1;
      n = new h(e, {
        x: a.width,
        y: a.height - T
      });
      this._tween.from(new u(n, {
        x: 50,
        y: 50,
        alpha: 0,
        rotation: 225
      })).to(new u(n, {
        x: 0,
        y: 0,
        alpha: 1,
        rotation: 245
      }), 10, y.quadOut).to(new u(n, {
        x: 0,
        y: 0,
        alpha: 1,
        rotation: 245
      }), 20).to(new u(n, {
        x: -30,
        y: -30,
        alpha: 1,
        rotation: 265
      }), 2, y.quadOut, null, function () {
        i.playCircles(s.x - 60, s.y - 60, t.doubleTap);
      }).to(new u(n, {
        x: -30,
        y: -30,
        alpha: 1,
        rotation: 245
      }), 2, y.quadOut);
      t.doubleTap && this._tween.to(new u(n, {
        x: -30,
        y: -30,
        alpha: 1,
        rotation: 265
      }), 2, y.quadOut).to(new u(n, {
        x: -30,
        y: -30,
        alpha: 1,
        rotation: 245
      }), 2, y.quadOut);
      this._tween.wait(10).to(new u(n, {
        x: 150,
        y: 150,
        alpha: 0,
        rotation: 245
      }), 20, y.quadOut);
      break;
    default:
      n = new h(e, {
        x: -M.w,
        y: a.height - T
      });
      this._tween.from(new u(n, {
        x: -50,
        y: 50,
        alpha: 0,
        rotation: 10
      })).to(new u(n, {
        x: 0,
        y: 0,
        alpha: 1,
        rotation: 55
      }), 10, y.quadOut).to(new u(n, {
        x: 0,
        y: 0,
        alpha: 1,
        rotation: 55
      }), 20).to(new u(n, {
        x: 30,
        y: -30,
        alpha: 1,
        rotation: 35
      }), 2, y.quadOut, null, function () {
        i.playCircles(s.x - 60, s.y - 60, t.doubleTap);
      }).to(new u(n, {
        x: 30,
        y: -30,
        alpha: 1,
        rotation: 55
      }), 2, y.quadOut);
      t.doubleTap && this._tween.to(new u(n, {
        x: 30,
        y: -30,
        alpha: 1,
        rotation: 35
      }), 2, y.quadOut).to(new u(n, {
        x: 30,
        y: -30,
        alpha: 1,
        rotation: 55
      }), 2, y.quadOut);
      this._tween.wait(10).to(new u(n, {
        x: -150,
        y: 150,
        alpha: 0,
        rotation: 35
      }), 20, y.quadOut);
  }
  this._tween.wait(50, function () {
    i.stopCircles();
  }).onFinish(function () {
    i.stopHint();
  }).start(!0);
};
this._x = 0;
this._y = 0;
this._scaleX = 1;
this._scaleY = 1;
this._rotation = 0;
this._alpha = 0;
this.refresh();
this._x = e;
this.refresh();
this._y = e;
this.refresh();
this._scaleX = e;
this.refresh();
this._scaleY = e;
this.refresh();
this._rotation = e;
this.refresh();
this._alpha = e;
this.refresh();
this.fxCircles.setStyle("transform", "translate(" + e + "px," + t + "px)");
this.fxCircles.toggleClassName("activeAnimation", !0);
this.circle2.toggleDisplay(i);
this.fxCircles.toggleClassName("activeAnimation", !1);
this.circle2.toggleDisplay(!0);
this._tween && (this._tween.playing || this._tween.starting) && this._tween.stop();
window.isoEngine.mapRenderer.cellHintManager.stopAnimation();
this.stopCircles();
this.pointerHint.reset();
this.delClassNames(["inMap"]);
n = new h(e, {
  x: -(M.w + T) / 2,
  y: -(M.h + T)
});
s = new h(e, {
  x: 0,
  y: 0,
  rotation: 0,
  alpha: 0
});
this.addClassNames("inMap");
this._tween.from(new u(n, {
  x: 0,
  y: -50,
  alpha: 0,
  rotation: 90
})).to(new u(n, {
  x: 0,
  y: 0,
  alpha: 1,
  rotation: 180
}), 10, y.quadOut).to(new u(n, {
  x: 0,
  y: 0,
  alpha: 1,
  rotation: 180
}), 20).to(new u(n, {
  x: 0,
  y: 30,
  alpha: 1,
  rotation: 180
}), 20, y.quadOut).to(new u(n, {
  x: 0,
  y: 0,
  alpha: 1,
  rotation: 180
}), 20, y.quadOut).to(new u(n, {
  x: 0,
  y: 30,
  alpha: 1,
  rotation: 180
}), 20, y.quadOut).to(new u(n, {
  x: 0,
  y: 0,
  alpha: 1,
  rotation: 180
}), 20, y.quadOut).to(new u(n, {
  x: 0,
  y: 30,
  alpha: 1,
  rotation: 180
}), 20, y.quadOut).to(new u(n, {
  x: 0,
  y: 0,
  alpha: 1,
  rotation: 180
}), 20, y.quadOut).to(new u(n, {
  x: 0,
  y: 30,
  alpha: 1,
  rotation: 140
}), 3, y.quadOut, null, function () {
  i.playCircles(s.x - 60, s.y - 60, !1);
}).to(new u(n, {
  x: 0,
  y: 30,
  alpha: 1,
  rotation: 180
}), 2, y.quadOut).wait(10).to(new u(n, {
  x: 0,
  y: -150,
  alpha: 0,
  rotation: 180
}), 20, y.quadOut);
n = new h(e, {
  x: -M.w,
  y: -M.h + T
});
this._tween.from(new u(n, {
  x: -50,
  y: -50,
  alpha: 0,
  rotation: 90
})).to(new u(n, {
  x: 0,
  y: 0,
  alpha: 1,
  rotation: 140
}), 10, y.quadOut).to(new u(n, {
  x: 0,
  y: 0,
  alpha: 1,
  rotation: 140
}), 20).to(new u(n, {
  x: 30,
  y: 30,
  alpha: 1,
  rotation: 110
}), 2, y.quadOut, null, function () {
  i.playCircles(s.x - 60, s.y - 60, t.doubleTap);
}).to(new u(n, {
  x: 30,
  y: 30,
  alpha: 1,
  rotation: 140
}), 2, y.quadOut);
t.doubleTap && this._tween.to(new u(n, {
  x: 30,
  y: 30,
  alpha: 1,
  rotation: 110
}), 2, y.quadOut).to(new u(n, {
  x: 30,
  y: 30,
  alpha: 1,
  rotation: 140
}), 2, y.quadOut);
this._tween.wait(10).to(new u(n, {
  x: -150,
  y: -150,
  alpha: 0,
  rotation: 140
}), 20, y.quadOut);
this.pointerHint.scaleY = -1;
n = new h(e, {
  x: a.width,
  y: a.height - T
});
this._tween.from(new u(n, {
  x: 50,
  y: 50,
  alpha: 0,
  rotation: 225
})).to(new u(n, {
  x: 0,
  y: 0,
  alpha: 1,
  rotation: 245
}), 10, y.quadOut).to(new u(n, {
  x: 0,
  y: 0,
  alpha: 1,
  rotation: 245
}), 20).to(new u(n, {
  x: -30,
  y: -30,
  alpha: 1,
  rotation: 265
}), 2, y.quadOut, null, function () {
  i.playCircles(s.x - 60, s.y - 60, t.doubleTap);
}).to(new u(n, {
  x: -30,
  y: -30,
  alpha: 1,
  rotation: 245
}), 2, y.quadOut);
t.doubleTap && this._tween.to(new u(n, {
  x: -30,
  y: -30,
  alpha: 1,
  rotation: 265
}), 2, y.quadOut).to(new u(n, {
  x: -30,
  y: -30,
  alpha: 1,
  rotation: 245
}), 2, y.quadOut);
this._tween.wait(10).to(new u(n, {
  x: 150,
  y: 150,
  alpha: 0,
  rotation: 245
}), 20, y.quadOut);
n = new h(e, {
  x: -M.w,
  y: a.height - T
});
this._tween.from(new u(n, {
  x: -50,
  y: 50,
  alpha: 0,
  rotation: 10
})).to(new u(n, {
  x: 0,
  y: 0,
  alpha: 1,
  rotation: 55
}), 10, y.quadOut).to(new u(n, {
  x: 0,
  y: 0,
  alpha: 1,
  rotation: 55
}), 20).to(new u(n, {
  x: 30,
  y: -30,
  alpha: 1,
  rotation: 35
}), 2, y.quadOut, null, function () {
  i.playCircles(s.x - 60, s.y - 60, t.doubleTap);
}).to(new u(n, {
  x: 30,
  y: -30,
  alpha: 1,
  rotation: 55
}), 2, y.quadOut);
t.doubleTap && this._tween.to(new u(n, {
  x: 30,
  y: -30,
  alpha: 1,
  rotation: 35
}), 2, y.quadOut).to(new u(n, {
  x: 30,
  y: -30,
  alpha: 1,
  rotation: 55
}), 2, y.quadOut);
this._tween.wait(10).to(new u(n, {
  x: -150,
  y: 150,
  alpha: 0,
  rotation: 35
}), 20, y.quadOut);
a.call(this, "div", {
  className: "PerformanceOverlay",
  hidden: !0
});
this._init = !1;
this._initDom();
o(n, a);
e.exports = n;
n.prototype._initDom = function () {
  this._init || (this.fps = this.createChild("div", {
    className: "fps"
  }), this.gameMemory = this.createChild("div", {
    className: "gameMemory"
  }), this._init = !0);
};
n.prototype.refresh = function (e, t) {
  var i = t && t.percentage || 0;
  this.fps.setText("FPS: " + e);
  this.gameMemory.setText("Engine cache used: " + i + "%");
};
n.prototype.display = function (e) {
  this.toggleDisplay(e);
};
this.fps.setText("FPS: " + e);
this.gameMemory.setText("Engine cache used: " + i + "%");
c.call(this, "div", {
  className: ["connectionSplashScreen", "hidding"],
  hidden: !0
});
this.currentLevel = null;
this.autoRemoveTimeout = null;
this.state = "";
e.autoRemoveTimeout = null;
e.replaceClassNames(["blocking"], ["warning"]);
r(n, c);
e.exports = n;
n.prototype._createContent = function () {
  this.lockingDiv = this.createChild("div", {
    className: "lockingDiv"
  });
  var e = this.createChild("div", {
    className: "splashScreenMsg"
  });
  this.message = e.createChild("div", {
    className: "message"
  });
  e.createChild("div", {
    className: ["spinner", "splashSpinner"]
  });
};
n.prototype._appear = function (e) {
  if (e !== this.currentLevel) {
    switch (this.currentLevel = e, this.lockingDiv || this._createContent(), this.autoRemoveTimeout = window.clearTimeout(this.autoRemoveTimeout), this.show(), s.forceReflow(this), e) {
      case u:
        this.replaceClassNames(["hidding", "warning"], ["blocking"]);
        this.autoRemoveTimeout = window.setTimeout(o, h, this);
        break;
      case d:
        this.replaceClassNames(["hidding", "blocking"], ["warning"]);
    }
  }
};
n.prototype._disappear = function () {
  this.lockingDiv && (this.currentLevel = null, this.replaceClassNames(["warning", "blocking"], ["hidding"]), window.clearTimeout(this.autoRemoveTimeout), this.autoRemoveTimeout = window.setTimeout(function (e) {
    e.hide();
  }, 500, this));
};
n.prototype.onStateChange = function (e, t) {
  if (e !== this.state) {
    switch (this.state = e, e) {
      case "UNSTABLE":
        this._appear(t || d);
        this.message.setText(a("tablet.connect.lost"));
        break;
      case "RECONNECTING":
        this._appear(this.currentLevel || d);
        this.message.setText(a("tablet.connect.retrying", t));
        break;
      case "RELOADING":
        this._appear(u);
        this.message.setText(a("tablet.connect.reloading"));
        break;
      case "CONNECTED":
      case "DISCONNECTED":
        this._disappear();
        break;
      default:
        console.error("ConnectionSplashScreen#onStateChange: invalid state: " + e);
    }
  }
};
this.message = e.createChild("div", {
  className: "message"
});
e.createChild("div", {
  className: ["spinner", "splashSpinner"]
});
this.replaceClassNames(["hidding", "warning"], ["blocking"]);
this.autoRemoveTimeout = window.setTimeout(o, h, this);
this._appear(t || d);
this.message.setText(a("tablet.connect.lost"));
this._appear(this.currentLevel || d);
this.message.setText(a("tablet.connect.retrying", t));
this._appear(u);
this.message.setText(a("tablet.connect.reloading"));
a.call(this, "div", {
  className: ["loginScreen", "screen"],
  hidden: !0
});
N = _.isWebGlSupported();
this._connectMethod = g.getValue("connectMethod", x, !0);
this._changeLangMethod = R.UPDATE_DOM;
this.once("show", function () {
  L = {
    de: u("tablet.language.de"),
    en: u("tablet.language.en"),
    es: u("tablet.language.es"),
    fr: u("tablet.language.fr"),
    it: u("tablet.language.it"),
    pt: u("tablet.language.pt")
  };
  this._createContent();
});
N && (this.on("show", this._updateContent), e.on("appLeaveBackground", function () {
  t.isVisible() && t._updateContent();
}));
e.on("NicknameRegistrationMessage", function () {
  v.open("nickname");
});
window.dofus.on("wasAlreadyConnected", function () {
  e.openSimplePopup(u("ui.connection.disconnectAccount"), u("ui.popup.warning"));
});
L = {
  de: u("tablet.language.de"),
  en: u("tablet.language.en"),
  es: u("tablet.language.es"),
  fr: u("tablet.language.fr"),
  it: u("tablet.language.it"),
  pt: u("tablet.language.pt")
};
this._createContent();
o(n, a);
e.exports = n;
n.prototype._createContent = function () {
  function e(e) {
    e.on("submit", function (e) {
      e = e || {};
      t._login(e.login, e.password, e.save);
    });
  }
  var t = this;
  if (!N) {
    return this._webGlUnsupported = this.createChild("div", {
      className: "webGlUnsupported"
    }), this._webGlUnsupported.setText(u("tablet.login.webGlUnsupported")), void console.error("WebGL is not supported");
  }
  this._splashScreenNews = [];
  this._splashScreenNews.push(new M("ballotin", "20230214", new Date("2023-02-14T15:00:00.000Z").getTime(), new Date("2023-02-20T15:00:00.000Z").getTime(), {
    fr: "https://www.dofus-touch.com/fr/mmorpg/actualites/news/1570513-sain-ballotin-amour",
    es: "https://www.dofus-touch.com/es/mmorpg/actualidad/noticias/1570515-sain-ballotin-amour",
    en: "https://www.dofus-touch.com/en/mmorpg/news/announcements/1570514-sain-ballotin-amour"
  }));
  for (var i = this._splashScreenNews.length - 1; i >= 0; i -= 1) {
    var n = this._splashScreenNews[i];
    this.appendChild(n);
  }
  var o = this.createChild("div", {
      className: "verticalPositionerWrapper"
    }),
    a = o.createChild("div", {
      className: "verticalPositioner"
    });
  a.createChild("div", {
    className: "spacer"
  });
  a.createChild("div", {
    className: "spacer"
  });
  this._leftColumn = a.createChild("div", {
    className: "leftColumn"
  });
  this._newsBlock = this._leftColumn.appendChild(new A(this));
  this._forumBlock = this._leftColumn.appendChild(new S(this));
  this._forumBlock.retractableBlock.setBoundedRetractableBlock(this._newsBlock.retractableBlock);
  this._newsBlock.retractableBlock.expand();
  this._loginForm = a.appendChild(new I(this));
  this._guestForm = a.appendChild(new T(this));
  this._tokenForm = a.appendChild(new C(this));
  a.createChild("div", {
    className: "spacer"
  });
  a.createChild("div", {
    className: "spacer"
  });
  e(this._loginForm);
  e(this._guestForm);
  e(this._tokenForm);
  this.displayAppropriateForm();
  this._createTopButtons();
  this._createBottomLinks();
  this._createSocialButtons();
  this._audioSetup();
};
n.prototype._createTopButtons = function () {
  var e = this.createChild("div", {
    className: "topButtons"
  });
  this._createPreloadMapButton(e);
  this._createLangButton(e);
};
n.prototype._createPreloadMapButton = function (e) {
  var t = [{
    getCaption: function () {
      var e = u("tablet.common.acronymGigabytes", D);
      return u("tablet.login.settings.downloadMaps", e);
    },
    cb: function () {
      v.open("preloadMap", {});
    }
  }];
  e.appendChild(new r({
    className: ["settingsButton", "simpleButton"],
    addIcon: !0
  }, function () {
    for (var i = [], n = 0; n < t.length; n++) {
      var o = t[n];
      i.push({
        caption: o.getCaption(),
        cb: o.cb
      });
    }
    l.openAround("generic", e, {
      title: "",
      actions: i
    });
  }));
};
n.prototype._createLangButton = function (e) {
  function t() {
    n._changeLanguage(this.lang, i);
  }
  var i = window.Config,
    n = this;
  this._langButton = e.createChild("div", {
    className: "langButton"
  });
  this._langFlag = this._langButton.createChild("div", {
    className: "flagText"
  });
  f(this._langButton);
  this._langButton.on("tap", function () {
    for (var e = [], o = i.language, s = 0; s < i.serverLanguages.length; s++) {
      var r = i.serverLanguages[s],
        c = new a("div", {
          className: "langLine"
        }),
        d = L[r];
      d || (console.error(new Error("No language label for language " + r)), d = r);
      c.createChild("div", {
        className: "caption",
        text: d
      });
      var u = ["langLineParent"];
      r === o && u.push("current");
      e.push({
        wuiDomChild: c,
        addClassNames: u,
        lang: r,
        cb: t
      });
    }
    l.openAround("generic", n._langButton, {
      title: "",
      actions: e
    });
  });
};
n.prototype._changeLanguage = function (e, t) {
  var i = this;
  if (e !== t.language) {
    return this._changeLangMethod === R.RELOAD_PAGE ? (g.setValue("lang", e), g.saveNow(), void window.location.reload()) : void d.initialize({
      language: e,
      chaseText: t.chaseText
    }, b, w, function (n) {
      return n ? console.error("LoginScreen getText init", n) : (t.language = e, i.backToLogin(), g.setValue("lang", e, 1), void i._updateContent());
    });
  }
};
n.prototype._createBottomLinks = function () {
  function e() {
    p.openUrlInAppBrowser(this.link);
  }
  var t = this.createChild("div", {
    className: "footer"
  });
  this._versionLabel = t.createChild("div", {
    className: "globalMenuVersion"
  });
  this._tou = t.appendChild(new r({
    className: ["link"]
  }));
  this._gcs = t.appendChild(new r({
    className: ["link"]
  }));
  this._tou.on("tap", e);
  this._gcs.on("tap", e);
};
n.prototype._createSocialButtons = function () {
  var e = this,
    t = this._leftColumn;
  c.screenHeight < O && (t = e);
  this.socialButtons = new y();
  t.appendChild(this.socialButtons);
};
n.prototype._audioSetup = function () {
  var e = g.getValue("soundPreferences", s.getDefaultParams(), !0);
  s.setupChannels(e);
  s.settings.audioPath = window.Config.assetsUrl + "/audio/";
  s.initialize();
  e.ui.muted || s.createUiSound("GEN_BUTTON");
};
n.prototype.showLoginForm = function () {
  this._loginForm.show();
  this._guestForm.hide();
  this._tokenForm.hide();
};
n.prototype.showGuestForm = function () {
  return window.Config.disabledFeatures.guest ? (this.showLoginForm(), console.error(new Error("showGuestForm: guest is disabled"))) : (this._loginForm.hide(), this._guestForm.show(), void this._tokenForm.hide());
};
n.prototype.showTokenForm = function () {
  this._loginForm.hide();
  this._guestForm.hide();
  this._tokenForm.show();
};
n.prototype.displayAppropriateForm = function () {
  if (h.hasKeyFromStorage() && !window.Config.byPassToken) {
    this.showTokenForm();
  } else if (window.Config.disabledFeatures.guest) {
    this.showLoginForm();
  } else {
    var e = g.getValue("hasAccount", !1, !0);
    e ? this.showLoginForm() : this.showGuestForm();
  }
};
n.prototype.openRegisterWindow = function (e) {
  var t = this,
    i = {
      guestAccount: e,
      onValidate: function (e) {
        t._afterValidation(e);
      }
    };
  v.open("birthdayLimit", i);
};
n.prototype._afterValidation = function (e) {
  return e ? (g.delValue("guestAccount"), g.delValue("lastIdentification"), g.setValue("hasAccount", !0), g.saveNow(), window.gui.openSimplePopup(u("ui.popup.accessDenied.unvalidatedEmail"), u("ui.common.congratulation")), this._guestForm.refresh(), void this.showLoginForm()) : this._updateContent();
};
n.prototype.backToLogin = function () {
  v.closeAll();
  window.gui.splashScreen.hide();
  window.gui.backgroundScreen.show();
  this.show();
};
n.prototype._login = function (e, t, i) {
  function n(e) {
    return e ? void ("NOTOKEN" === e.reason && o.displayAppropriateForm()) : void window.gui.initializeAfterLogin(function (e) {
      e && (console.error("initializeAfterLogin failed:", e), window.gui.openSimplePopup(u("ui.popup.connectionFailed.text")));
    });
  }
  var o = this;
  this._changeLangMethod = R.RELOAD_PAGE;
  v.open("cleanAssets", function (a) {
    return a ? n(a) : (window.gui.splashScreen.show(), e ? m.startLoginProcessWithPassword(o._connectMethod, e, t, i, n) : m.startLoginProcessWithoutPassword(o._connectMethod, {}, n));
  });
};
n.prototype._updateContent = function () {
  this.displayAppropriateForm();
  this._loginForm.refresh();
  this._guestForm.refresh();
  this._tokenForm.refresh();
  this._newsBlock.refresh();
  this._forumBlock.refresh();
  this._langFlag.setText(window.Config.language);
  this._tou.setText(u("ui.legal.tou"));
  this._gcs.setText(u("ui.legal.gcs"));
  this._tou.link = u("ui.legal.linktou");
  this._gcs.link = u("ui.legal.linkgcs");
  this.socialButtons.updateContent();
  this._versionLabel.setText(window.gui.getBuildVersion());
  this.autoProposeRegistration && (this.autoProposeRegistration = !1, window.setTimeout(this.openRegisterWindow.bind(this, this._guestForm.guestAccount), 0));
  for (var e = 0; e < this._splashScreenNews.length; e += 1) {
    var t = this._splashScreenNews[e];
    t.showSplashScreen(window.Config.language);
  }
  l.getContextMenu("generic").forceUpdateCancelButton();
};
n.prototype.proposeRegistrationAfterGuestLimit = function () {
  var e = this;
  window.gui.openConfirmPopup({
    message: u("tablet.oldGuest.limitQuestion"),
    cb: function (t) {
      t && (e.autoProposeRegistration = !0, window.gui.disconnect());
    }
  });
};
e = e || {};
t._login(e.login, e.password, e.save);
this._splashScreenNews = [];
this._splashScreenNews.push(new M("ballotin", "20230214", new Date("2023-02-14T15:00:00.000Z").getTime(), new Date("2023-02-20T15:00:00.000Z").getTime(), {
  fr: "https://www.dofus-touch.com/fr/mmorpg/actualites/news/1570513-sain-ballotin-amour",
  es: "https://www.dofus-touch.com/es/mmorpg/actualidad/noticias/1570515-sain-ballotin-amour",
  en: "https://www.dofus-touch.com/en/mmorpg/news/announcements/1570514-sain-ballotin-amour"
}));
a.createChild("div", {
  className: "spacer"
});
a.createChild("div", {
  className: "spacer"
});
this._leftColumn = a.createChild("div", {
  className: "leftColumn"
});
this._newsBlock = this._leftColumn.appendChild(new A(this));
this._forumBlock = this._leftColumn.appendChild(new S(this));
this._forumBlock.retractableBlock.setBoundedRetractableBlock(this._newsBlock.retractableBlock);
this._newsBlock.retractableBlock.expand();
this._loginForm = a.appendChild(new I(this));
this._guestForm = a.appendChild(new T(this));
this._tokenForm = a.appendChild(new C(this));
a.createChild("div", {
  className: "spacer"
});
a.createChild("div", {
  className: "spacer"
});
e(this._loginForm);
e(this._guestForm);
e(this._tokenForm);
this.displayAppropriateForm();
this._createTopButtons();
this._createBottomLinks();
this._createSocialButtons();
this._audioSetup();
this._createPreloadMapButton(e);
this._createLangButton(e);
this._langButton = e.createChild("div", {
  className: "langButton"
});
this._langFlag = this._langButton.createChild("div", {
  className: "flagText"
});
f(this._langButton);
this._langButton.on("tap", function () {
  for (var e = [], o = i.language, s = 0; s < i.serverLanguages.length; s++) {
    var r = i.serverLanguages[s],
      c = new a("div", {
        className: "langLine"
      }),
      d = L[r];
    d || (console.error(new Error("No language label for language " + r)), d = r);
    c.createChild("div", {
      className: "caption",
      text: d
    });
    var u = ["langLineParent"];
    r === o && u.push("current");
    e.push({
      wuiDomChild: c,
      addClassNames: u,
      lang: r,
      cb: t
    });
  }
  l.openAround("generic", n._langButton, {
    title: "",
    actions: e
  });
});
d || (console.error(new Error("No language label for language " + r)), d = r);
c.createChild("div", {
  className: "caption",
  text: d
});
r === o && u.push("current");
e.push({
  wuiDomChild: c,
  addClassNames: u,
  lang: r,
  cb: t
});
this._versionLabel = t.createChild("div", {
  className: "globalMenuVersion"
});
this._tou = t.appendChild(new r({
  className: ["link"]
}));
this._gcs = t.appendChild(new r({
  className: ["link"]
}));
this._tou.on("tap", e);
this._gcs.on("tap", e);
c.screenHeight < O && (t = e);
this.socialButtons = new y();
t.appendChild(this.socialButtons);
s.setupChannels(e);
s.settings.audioPath = window.Config.assetsUrl + "/audio/";
s.initialize();
e.ui.muted || s.createUiSound("GEN_BUTTON");
this._loginForm.show();
this._guestForm.hide();
this._tokenForm.hide();
this._loginForm.hide();
this._guestForm.hide();
this._tokenForm.show();
v.closeAll();
window.gui.splashScreen.hide();
window.gui.backgroundScreen.show();
this.show();
this._changeLangMethod = R.RELOAD_PAGE;
v.open("cleanAssets", function (a) {
  return a ? n(a) : (window.gui.splashScreen.show(), e ? m.startLoginProcessWithPassword(o._connectMethod, e, t, i, n) : m.startLoginProcessWithoutPassword(o._connectMethod, {}, n));
});
this.displayAppropriateForm();
this._loginForm.refresh();
this._guestForm.refresh();
this._tokenForm.refresh();
this._newsBlock.refresh();
this._forumBlock.refresh();
this._langFlag.setText(window.Config.language);
this._tou.setText(u("ui.legal.tou"));
this._gcs.setText(u("ui.legal.gcs"));
this._tou.link = u("ui.legal.linktou");
this._gcs.link = u("ui.legal.linkgcs");
this.socialButtons.updateContent();
this._versionLabel.setText(window.gui.getBuildVersion());
this.autoProposeRegistration && (this.autoProposeRegistration = !1, window.setTimeout(this.openRegisterWindow.bind(this, this._guestForm.guestAccount), 0));
c.call(this, "div", {
  className: "SplashScreenNews",
  hidden: !0
});
this._uid = e;
this._splashScreenNewsLogic = new p(s, t, e, n, i);
this._language = null;
this._href = null;
a(r._language);
r.hide();
r._href ? h.openUrlInAppBrowser(r._href) : console.error("SplashScreenNews: url missing for language", r._language);
o(r._language);
r._close();
a(r._language);
r._close();
l(n, c);
e.exports = n;
n.prototype.showSplashScreen = function (e) {
  this._language = e;
  var t = this._splashScreenNewsLogic.shouldShowFor(e);
  t && (this._interactiveImage.setClassNames(["splashscreen-image", this._uid, "lang-" + e]), this._href = this._splashScreenNewsLogic.getUrlFor(e));
  this.toggleDisplay(t);
};
n.prototype._close = function () {
  this._splashScreenNewsLogic.setShownIn(this._language);
  this._language = null;
  this._href = null;
  this.hide();
};
t && (this._interactiveImage.setClassNames(["splashscreen-image", this._uid, "lang-" + e]), this._href = this._splashScreenNewsLogic.getUrlFor(e));
this.toggleDisplay(t);
this._splashScreenNewsLogic.setShownIn(this._language);
this._language = null;
this._href = null;
this.hide();
this._urls = e;
this._uid = i || "one";
this._endMilliTimestamp = n || -1;
this._startMilliTimestamp = o || 0;
this._seed = t;
e.exports = n;
n.prototype.setShownIn = function (e) {
  var t = this._getUserPrefKey(e);
  a.setValue(t, this._seed, 1, !0);
};
n.prototype.shouldShowFor = function (e) {
  var t = this._getUserPrefKey(e),
    i = !1,
    n = s.now();
  if (this._startMilliTimestamp > n) {
    return !1;
  }
  if (this._endMilliTimestamp !== -1 && n > this._endMilliTimestamp) {
    return !1;
  }
  var o = a.getValue(t, !0, !0);
  return o !== this._seed && (i = !0), i;
};
n.prototype.getUrlFor = function (e) {
  var t = this._urls[e];
  return t || (t = this._urls[r]), t ? t : (o.error("getUrlFor: url missing for lang " + e), null);
};
n.prototype._getUserPrefKey = function (e) {
  var t = e;
  return t || (o.error(new Error("_getUserPrefKey: language missing with lang " + t)), t = r), l + "_" + this._uid + "_" + t;
};
a.call(this, "div", {
  className: ["GuestForm", "rightColumn"],
  hidden: !0
});
this.loginScreen = e;
this.guestAccount = null;
this.isAlreadyGuest = null;
this.createChild("div", {
  className: ["frame", "frame1"]
});
this.content = this.createChild("div", {
  className: "content"
});
this.content.createChild("div", {
  className: "dofusTouchLogo"
});
this._introText = n.createChild("div", {
  className: "introText"
});
this._btnPlay = n.createChild("div", {
  className: "horizontalCenter"
}).appendChild(new s({
  className: ["button", "buttonPlay"],
  sound: "OK_BUTTON"
}));
this._btnPlay.on("tap", function () {
  var n = c.getValue("guestAgreement", !1, !0),
    o = {
      onValidate: t,
      isModal: !0
    };
  if (!i.isAlreadyGuest) {
    return void u.open("legalAgreement", o);
  }
  if (!n) {
    return o.onValidate = t, void u.open("legalAgreement", o);
  }
  var a = c.getValue("lastIdentification", null, !0);
  if (a) {
    var s = Date.now() - a;
    if (s > 864e5) {
      return window.gui.openConfirmPopup({
        title: r("tablet.oldGuest.register"),
        message: r("tablet.oldGuest.registerReminder"),
        cb: function (t) {
          return t ? e.openRegisterWindow(i.guestAccount) : void i._play();
        }
      }), void i._updateLastIdentificationTime();
    }
  } else {
    i._updateLastIdentificationTime();
  }
  i._play();
});
this._connectionOptions = n.appendChild(new h(e, this));
this._createAccount = this.appendChild(new s({
  className: "formBtn"
}, function () {
  e.openRegisterWindow(i.guestAccount);
}));
this._hasAnAccount = this.appendChild(new s({
  className: "formBtn2"
}, function () {
  c.setValue("hasAccount", !0, 1);
  e.showLoginForm();
}));
this._btnVersion = this.appendChild(new s({
  className: "formBtn3"
}, function () {
  l();
}));
this.createChild("div", {
  className: "greenLine"
});
c.setValue("hasAccount", !0, 1);
e.showLoginForm();
o(n, a);
e.exports = n;
n.prototype.refresh = function () {
  this._btnPlay.enable();
  this._btnPlay.setText(r("ui.common.play"));
  this._hasAnAccount.setText(r("tablet.login.haveLogin"));
  this.content.delClassNames("contentBeta");
  this._btnVersion.delClassNames("betaPolice");
  this._btnVersion.setHtml(r("ui.login.betaAccess"));
  this._btnVersion.toggleDisplay(!window.Config.disabledFeatures.betaAccess);
  this._connectionOptions.refresh();
  this._update();
};
n.prototype._update = function () {
  this.guestAccount = c.getValue("guestAccount", null, !0);
  this.isAlreadyGuest = !!(this.guestAccount && this.guestAccount.login && this.guestAccount.password);
  var e = this.guestAccount && this.guestAccount.nickname || "guestWithNoNickname";
  this.isAlreadyGuest ? (this._createAccount.setText(r("tablet.oldGuest.register")), "guestWithNoNickname" === e ? this._introText.setText(r("tablet.oldGuest.desc.no.nick")) : this._introText.setText(r("tablet.oldGuest.desc", e))) : (this._createAccount.setText(r("tablet.login.createAccount")), this._introText.setText(r("tablet.newGuest.desc")));
};
n.prototype._createGuest = function () {
  var e = this;
  this._btnPlay.disable();
  d.createGuest(e._recaptchaResponse, function (t, i) {
    if (t) {
      var n = t.userError || r("ui.secureMode.error.default");
      return window.gui.openSimplePopup(n), console.error("GuestForm#_createGuest error:", t.error), void e._btnPlay.enable();
    }
    return e._play(i);
  });
};
n.prototype._updateLastIdentificationTime = function () {
  c.setValue("lastIdentification", Date.now(), null, !0);
};
n.prototype._play = function (e) {
  e = e || {
    login: this.guestAccount.login,
    password: this.guestAccount.password
  };
  this.emit("submit", {
    login: e.login,
    password: e.password,
    save: e.save
  });
};
this._btnPlay.enable();
this._btnPlay.setText(r("ui.common.play"));
this._hasAnAccount.setText(r("tablet.login.haveLogin"));
this.content.delClassNames("contentBeta");
this._btnVersion.delClassNames("betaPolice");
this._btnVersion.setHtml(r("ui.login.betaAccess"));
this._btnVersion.toggleDisplay(!window.Config.disabledFeatures.betaAccess);
this._connectionOptions.refresh();
this._update();
this.guestAccount = c.getValue("guestAccount", null, !0);
this.isAlreadyGuest = !!(this.guestAccount && this.guestAccount.login && this.guestAccount.password);
this._btnPlay.disable();
d.createGuest(e._recaptchaResponse, function (t, i) {
  if (t) {
    var n = t.userError || r("ui.secureMode.error.default");
    return window.gui.openSimplePopup(n), console.error("GuestForm#_createGuest error:", t.error), void e._btnPlay.enable();
  }
  return e._play(i);
});
e = e || {
  login: this.guestAccount.login,
  password: this.guestAccount.password
};
this.emit("submit", {
  login: e.login,
  password: e.password,
  save: e.save
});
window.localStorage.setItem(n, "https://earlyproxy.touch.dofus.com");
window.location.reload();
a.call(this, "div", {
  className: "ConnectionOptions"
});
this.loginScreen = e;
i = i || {};
i.forgotPassword && (this._forgottenPassword = o.appendChild(new s({
  className: "forgottenPassword"
})), this._forgottenPassword.on("tap", function () {
  l.openUrlInAppBrowser(this.link);
}));
this._connectionOptions = o.appendChild(new s({
  className: "connectionOptions"
}));
this._connectionOptions.on("tap", function () {
  var e = !n._advancedOptions.isVisible();
  n._advancedOptions.toggleDisplay(e);
  n._connectionOptions.toggleClassName("selected", e);
  e && n._update();
});
this._advancedOptions = this.createChild("div", {
  className: "advancedOptions"
});
this._advancedOptions.hide();
this._grayLine = this._advancedOptions.createChild("div", {
  className: "grayLine"
});
this.connectionMethodSelector = this._advancedOptions.appendChild(new c({
  className: ""
}));
this._advancedOptions.createChild("div", {
  className: "clearFloat"
});
this.connectionMethodSelector.on("change", function (e) {
  n.loginScreen._connectMethod = e;
  d.setValue("connectMethod", e, null, !0);
});
n._advancedOptions.toggleDisplay(e);
n._connectionOptions.toggleClassName("selected", e);
e && n._update();
n.loginScreen._connectMethod = e;
d.setValue("connectMethod", e, null, !0);
o(n, a);
e.exports = n;
n.prototype.refresh = function () {
  this._forgottenPassword && (this._forgottenPassword.setText(r("ui.login.forgottenPassword")), this._forgottenPassword.link = r("tablet.link.findPassword"));
  this._connectionOptions.setText(r("tablet.login.connectionOptions"));
  this.connectionMethodSelector.clearContent();
  for (var e in u.connectMethod) {
    this.connectionMethodSelector.addOption(r("tablet.login.connectionOption." + e), e);
  }
  this._update();
};
n.prototype._update = function () {
  this.connectionMethodSelector.select(this.loginScreen._connectMethod, !0);
};
this._forgottenPassword && (this._forgottenPassword.setText(r("ui.login.forgottenPassword")), this._forgottenPassword.link = r("tablet.link.findPassword"));
this._connectionOptions.setText(r("tablet.login.connectionOptions"));
this.connectionMethodSelector.clearContent();
s.call(this, "div", {
  className: ["TokenForm", "rightColumn"],
  hidden: !0
});
this.loginScreen = e;
this.createChild("div", {
  className: ["frame", "frame1"]
});
this.content = this.createChild("div", {
  className: "content"
});
this.content.createChild("div", {
  className: "dofusTouchLogo"
});
this._introText = i.createChild("div", {
  className: "introText"
});
this._btnPlay = i.createChild("div", {
  className: "horizontalCenter"
}).appendChild(new r({
  className: ["button", "buttonPlay"],
  sound: "OK_BUTTON"
}));
this._btnPlay.on("tap", function () {
  t._play();
});
this._connectionOptions = i.appendChild(new u(e, this));
this._guestLink = this.appendChild(new r({
  className: "formBtn"
}, function () {
  d.resetHaapiKey();
  t.loginScreen.showLoginForm();
}));
this._btnVersion = this.appendChild(new r({
  className: "formBtn2"
}, function () {
  c();
}));
this.createChild("div", {
  className: "greenLine"
});
d.resetHaapiKey();
t.loginScreen.showLoginForm();
a(n, s);
e.exports = n;
n.prototype.refresh = function () {
  var e = o.getItem("UNIQUE_NICKNAME") || d.getHaapiUsername();
  this._introText.setText(l("tablet.token.desc", e));
  this._btnPlay.setText(l("ui.common.play"));
  this._guestLink.setText(l("tablet.token.notme", e));
  this.content.delClassNames("contentBeta");
  this._btnVersion.delClassNames("betaPolice");
  this._btnVersion.setHtml(l("ui.login.betaAccess"));
  this._btnVersion.toggleDisplay(!window.Config.disabledFeatures.betaAccess);
  this._connectionOptions.refresh();
  this._update();
};
n.prototype._update = function () {};
n.prototype._play = function () {
  this.emit("submit");
};
this._introText.setText(l("tablet.token.desc", e));
this._btnPlay.setText(l("ui.common.play"));
this._guestLink.setText(l("tablet.token.notme", e));
this.content.delClassNames("contentBeta");
this._btnVersion.delClassNames("betaPolice");
this._btnVersion.setHtml(l("ui.login.betaAccess"));
this._btnVersion.toggleDisplay(!window.Config.disabledFeatures.betaAccess);
this._connectionOptions.refresh();
this._update();
a.call(this, "div", {
  className: ["LoginForm", "rightColumn"],
  hidden: !0
});
this.loginScreen = e;
this.createChild("div", {
  className: ["frame", "frame1"]
});
this.content = this.createChild("div", {
  className: ["content"]
});
this.content.createChild("div", {
  className: ["dofusTouchLogo"]
});
o.on("tap", function () {
  window.gui.openPopup({
    title: l("ui.popup.warning"),
    message: l("ui.login.usernameExplanations"),
    enablePreWrap: !0
  });
});
this._inputLogin = i.appendChild(new d({
  className: ["inputText", "whiteStyle"],
  attr: {
    type: "text"
  }
}));
this._inputLogin.on("validate", function () {
  t._inputPassword.focus();
});
this._labelPassword = i.createChild("label");
this._inputPassword = i.appendChild(new d({
  className: ["inputText", "whiteStyle"],
  attr: {
    type: "password"
  }
}));
this._inputPassword.on("validate", function () {
  t._play();
});
this._rememberName = i.appendChild(new r(""));
this._btnPlay = i.createChild("div", {
  className: ["horizontalCenter"]
}).appendChild(new s({
  className: ["button", "buttonPlay"],
  sound: "OK_BUTTON"
}));
this._btnPlay.on("tap", function () {
  t._play();
});
this._connectionOptions = i.appendChild(new p(e, this, {
  forgotPassword: !0
}));
this._guestLink = this.appendChild(new s({
  className: "formBtn"
}, function () {
  h.setValue("hasAccount", !1, 1);
  t.loginScreen.showGuestForm();
}));
this._btnVersion = this.appendChild(new s({
  className: "formBtn2"
}, function () {
  c();
}));
this.createChild("div", {
  className: "greenLine"
});
h.setValue("hasAccount", !1, 1);
t.loginScreen.showGuestForm();
o(n, a);
e.exports = n;
n.prototype.refresh = function () {
  this._labelLogin.setText(l("ui.login.username"));
  this._labelPassword.setText(l("ui.login.password"));
  this._btnPlay.setText(l("ui.common.play"));
  this._rememberName.setText(l("tablet.login.rememberMe"));
  this._guestLink.setText(l("tablet.login.noAccount"));
  this.content.delClassNames("contentBeta");
  this._btnVersion.delClassNames("betaPolice");
  this._btnVersion.setHtml(l("ui.login.betaAccess"));
  this._btnVersion.toggleDisplay(!window.Config.disabledFeatures.betaAccess);
  window.Config.disabledFeatures.guest ? (this._guestLink.toggleDisplay(!1), this._btnVersion.replaceClassNames(["formBtn2"], ["formBtn"])) : (this._guestLink.toggleDisplay(!0), this._btnVersion.replaceClassNames(["formBtn"], ["formBtn2"]));
  this._connectionOptions.refresh();
  this._update();
};
n.prototype._update = function () {
  this._rememberName.toggleActivation(!1, !0);
  this._inputLogin.setValue("");
  window.developmentMode ? this._inputPassword.setValue(window.Config.defaultPassword || "") : this._inputPassword.setValue("");
};
n.prototype._play = function () {
  u.hide();
  var e = this._inputLogin.getValue(),
    t = this._inputPassword.getValue(),
    i = this._rememberName.isActivate();
  return window.developmentMode || e && t ? void this.emit("submit", {
    login: e,
    password: t,
    save: i
  }) : window.gui.openSimplePopup(l("ui.popup.accessDenied.wrongCredentials"));
};
this._labelLogin.setText(l("ui.login.username"));
this._labelPassword.setText(l("ui.login.password"));
this._btnPlay.setText(l("ui.common.play"));
this._rememberName.setText(l("tablet.login.rememberMe"));
this._guestLink.setText(l("tablet.login.noAccount"));
this.content.delClassNames("contentBeta");
this._btnVersion.delClassNames("betaPolice");
this._btnVersion.setHtml(l("ui.login.betaAccess"));
this._btnVersion.toggleDisplay(!window.Config.disabledFeatures.betaAccess);
window.Config.disabledFeatures.guest ? (this._guestLink.toggleDisplay(!1), this._btnVersion.replaceClassNames(["formBtn2"], ["formBtn"])) : (this._guestLink.toggleDisplay(!0), this._btnVersion.replaceClassNames(["formBtn"], ["formBtn2"]));
this._connectionOptions.refresh();
this._update();
this._rememberName.toggleActivation(!1, !0);
this._inputLogin.setValue("");
window.developmentMode ? this._inputPassword.setValue(window.Config.defaultPassword || "") : this._inputPassword.setValue("");
this.loginScreen = e;
this._newsLoadedTime = 0;
this._currentPage = 0;
this._newsLang = null;
this._transitioning = !1;
this._setTimoutId = null;
this._pageCount = h;
this._carouselPages = [];
this._banners = [];
this._newsUrls = [];
this._bannerTitles = [];
this._date = [];
this._dots = [];
this.retractableBlock = this.appendChild(new c(!1));
this._carousel = i.appendChild(new d({
  onTap: l.openUrlInAppBrowser,
  bannerTitle: !0
}));
e.on("hide", function () {
  t._carousel.clear();
});
o(n, a);
e.exports = n;
n.prototype.refresh = function () {
  this.retractableBlock.show();
  this.retractableBlock.setTitle(s("tablet.login.news"));
  this._update();
};
n.prototype._update = function () {
  var e = window.Config,
    t = this;
  Date.now() - this._newsLoadedTime < u && this._newsLang === e.language || (t._carousel.update(), r.getNewsList(h, function (e, i) {
    return e || !i ? t._noNewsFallback() : i.length ? (t._newsLoadedTime = Date.now(), t._pageCount = i.length, i.forEach(function (e) {
      e.imageUrl = e.image_url;
      e.tapParam = e.url;
    }), t._currentPage = 0, void t._carousel.setPages(i)) : (t.loginScreen._forumBlock.retractableBlock.expand(), t._noNewsFallback());
  }));
};
n.prototype._noNewsFallback = function () {
  this._carousel.clear();
  this._carousel.setPages([{
    name: s("tablet.login.noNewsFallback"),
    className: "noNewsFallback",
    url: s("tablet.forum.link")
  }]);
};
this.retractableBlock.show();
this.retractableBlock.setTitle(s("tablet.login.news"));
this._update();
e.imageUrl = e.image_url;
e.tapParam = e.url;
this._carousel.clear();
this._carousel.setPages([{
  name: s("tablet.login.noNewsFallback"),
  className: "noNewsFallback",
  url: s("tablet.forum.link")
}]);
this._isExpanded = !1;
this._boundedBlock = null;
this.createChild("div", {
  className: ["frame", "frame2"]
});
r.log("HUD.Click_on_button", {
  interface_id: "ChangeLog",
  button_id: "BTN_CHANGELOG_OPEN_BEFORE_LOGIN",
  clic_parameter_key: "occurrence",
  clic_parameter_value: n,
  clic_type: "Simple_court"
}, {
  override: !0
});
this._titleBox = i.createChild("div", {
  className: "titleBox"
});
this._titleBullet = this._titleBox.createChild("div", {
  className: "titleBullet"
});
this._title = this._titleBox.createChild("div", {
  className: "title"
});
e && (this._expandButton = this._titleBox.appendChild(new s({
  className: ["greenButton", "expandButton"]
}, function () {
  t._isExpanded ? (t._retract(), t._boundedBlock && t._boundedBlock.expand()) : (t.expand(), r.log("HUD.Click_on_button", {
    interface_id: "ChangeLog",
    button_id: "BTN_CHANGELOG_OPEN_BEFORE_LOGIN",
    clic_parameter_key: "occurrence",
    clic_parameter_value: ++n,
    clic_type: "Simple_court"
  }, {
    override: !0
  }));
})), this._expandButton.createChild("div", {
  className: "expandeButtonContent",
  text: "+"
}));
this._subTitle = this._titleBox.createChild("div", {
  className: "subTitle"
});
this._retractable = i.createChild("div", {
  className: "retractable"
});
l.push(this);
o(n, a);
e.exports = n;
n.prototype.getContainer = function () {
  return this._retractable;
};
n.prototype.setTitle = function (e) {
  this._title.setText(e);
};
n.prototype.setSubTitle = function (e) {
  this._subTitle.setText(e);
};
n.prototype.expand = function () {
  for (var e = 0; e < l.length; e++) {
    var t = l[e];
    this === t ? t._expand() : t._retract();
  }
};
n.prototype._expand = function () {
  this._isExpanded || (this._retractable.addClassNames("expanded"), this._titleBox.addClassNames("expanded"), this._expandButton && (this._boundedBlock ? this._expandButton.setText("-") : this._expandButton.addClassNames("expanded")), this._isExpanded = !0);
};
n.prototype._retract = function () {
  this._isExpanded && (this._retractable.delClassNames("expanded"), this._titleBox.delClassNames("expanded"), this._expandButton && (this._boundedBlock ? this._expandButton.setText("+") : this._expandButton.delClassNames("expanded")), this._isExpanded = !1);
};
n.prototype.setBoundedRetractableBlock = function (e) {
  return this._boundedBlock || e._boundedBlock ? console.error(new Error("RetractableBlock: a block is already bounded to another one")) : (this._boundedBlock = e, void (e._boundedBlock = this));
};
d.call(this, "div", {
  className: "ForumBlock",
  hidden: !1
});
this._newsLoaded = !1;
this.retractableBlock = this.appendChild(new g(!0));
this._content = e.createChild("div", {
  className: ["forumNews"]
});
a();
c(n, d);
e.exports = n;
n.prototype.refresh = function () {
  this.retractableBlock.show();
  this.retractableBlock.setTitle(h("tablet.login.changelog"));
  this._update();
};
n.prototype._update = function () {
  var e = this;
  this._content.clearContent();
  this._content.addClassNames("spinner");
  p.getForumTopicsList(function (t, i) {
    if (t) {
      return window.developmentMode && console.error(t), e._content.delClassNames("spinner"), e._content.setHtml(h("tablet.login.forumUnreachable")), void m.allLinksOnTargetBlank(e._content);
    }
    var n = o(i);
    p.getForumPostsList(n.id, function (t, i) {
      if (e._content.delClassNames("spinner"), t) {
        return e._content.setHtml(h("tablet.login.forumUnreachable")), void m.allLinksOnTargetBlank(e._content);
      }
      var o,
        a = [n].concat(i),
        c = "";
      for (o = 0; o < a.length; o++) {
        c += 0 === o ? "<h2>" + a[o].title + "</h2><br/>" : "<br /><br /><center>* * *</center><br />";
        var d = a[o].content;
        d = s(d);
        d = u.process({
          text: d
        }).html;
        d = r(d);
        c += d;
      }
      e._content.setHtml(c);
      m.allLinksOnTargetBlank(e._content);
      var p = "",
        g = null;
      try {
        p = l(n.added_date, "yyyy-mm-dd");
      } catch (t) {
        g = t;
      }
      g && f.error("dateFormat error, topic date: " + n.added_date + " error: " + g);
      e.retractableBlock.setSubTitle(p + h("ui.common.colon") + n.title);
    });
  });
};
this.retractableBlock.show();
this.retractableBlock.setTitle(h("tablet.login.changelog"));
this._update();
this._content.clearContent();
this._content.addClassNames("spinner");
p.getForumTopicsList(function (t, i) {
  if (t) {
    return window.developmentMode && console.error(t), e._content.delClassNames("spinner"), e._content.setHtml(h("tablet.login.forumUnreachable")), void m.allLinksOnTargetBlank(e._content);
  }
  var n = o(i);
  p.getForumPostsList(n.id, function (t, i) {
    if (e._content.delClassNames("spinner"), t) {
      return e._content.setHtml(h("tablet.login.forumUnreachable")), void m.allLinksOnTargetBlank(e._content);
    }
    var o,
      a = [n].concat(i),
      c = "";
    for (o = 0; o < a.length; o++) {
      c += 0 === o ? "<h2>" + a[o].title + "</h2><br/>" : "<br /><br /><center>* * *</center><br />";
      var d = a[o].content;
      d = s(d);
      d = u.process({
        text: d
      }).html;
      d = r(d);
      c += d;
    }
    e._content.setHtml(c);
    m.allLinksOnTargetBlank(e._content);
    var p = "",
      g = null;
    try {
      p = l(n.added_date, "yyyy-mm-dd");
    } catch (t) {
      g = t;
    }
    g && f.error("dateFormat error, topic date: " + n.added_date + " error: " + g);
    e.retractableBlock.setSubTitle(p + h("ui.common.colon") + n.title);
  });
});
d = s(d);
d = u.process({
  text: d
}).html;
d = r(d);
c += d;
e._content.setHtml(c);
m.allLinksOnTargetBlank(e._content);
g && f.error("dateFormat error, topic date: " + n.added_date + " error: " + g);
e.retractableBlock.setSubTitle(p + h("ui.common.colon") + n.title);
c = new RegExp("<bbcl=([0-9]+) (" + l.join("|") + ")([ =][^>]*?)?>((?:.|[\\r\\n])*?)<bbcl=\\1 /\\2>", "gi");
d = new RegExp("\\[(" + l.join("|") + ")([ =][^\\]]*?)?\\]([^\\[]*?)\\[/\\1\\]", "gi");
u = new RegExp("\\[(" + C.join("|") + ")([ =][^\\]]*?)?\\]([\\s\\S]*?)\\[/\\1\\]", "gi");
(function () {
  for (var e = [], t = 0; t < l.length; t++) {
    "\\*" !== l[t] && e.push("/" + l[t]);
  }
  h = new RegExp("(\\[)((?:" + l.join("|") + ")(?:[ =][^\\]]*?)?)(\\])", "gi");
  p = new RegExp("(\\[)(" + e.join("|") + ")(\\])", "gi");
})();
h = new RegExp("(\\[)((?:" + l.join("|") + ")(?:[ =][^\\]]*?)?)(\\])", "gi");
p = new RegExp("(\\[)(" + e.join("|") + ")(\\])", "gi");
d = d || [];
n++;
g.lastIndex = 0;
m = _[p].match(g)[2].toLowerCase();
v && v.restrictChildrenTo && v.restrictChildrenTo.length > 0 && (v.validChildLookup[m] || (h = 'The tag "' + m + '" is not allowed as a child of the tag "' + e + '".', d.push(h)));
u = r[m] || {};
u.restrictParentsTo.length > 0 && (u.validParentLookup[e] || (h = 'The tag "' + e + '" is not allowed as a parent of the tag "' + m + '".', d.push(h)));
r = {
  anchor: {
    openTag: function (e, t) {
      var i = e || "";
      return i = i.substr(1) || "", b.test(i) || (i = ""), '<span id="post_' + i + '">';
    },
    closeTag: function (e, t) {
      return "</span>";
    }
  },
  abbr: {
    openTag: function (e, t) {
      var i = e || "";
      return i = i.substr(1) || "", i = i.replace(/<.*?>/g, ""), '<abbr title="' + i + '">';
    },
    closeTag: function (e, t) {
      return "</abbr>";
    }
  },
  acronym: {
    openTag: function (e, t) {
      var i = e || "";
      return i = i.substr(1) || "", i = i.replace(/<.*?>/g, ""), '<acronym title="' + i + '">';
    },
    closeTag: function (e, t) {
      return "</acronym>";
    }
  },
  b: {
    openTag: function (e, t) {
      return "<b>";
    },
    closeTag: function (e, t) {
      return "</b>";
    }
  },
  bbcode: {
    openTag: function (e, t) {
      return "";
    },
    closeTag: function (e, t) {
      return "";
    }
  },
  black: {
    openTag: function (e, t) {
      return '<span class="bbcode-color-black" style="color: black;">';
    },
    closeTag: function (e, t) {
      return "</span>";
    }
  },
  blue: {
    openTag: function (e, t) {
      return '<span class="bbcode-color-blue" style="color: blue;">';
    },
    closeTag: function (e, t) {
      return "</span>";
    }
  },
  br: {
    openTag: function (e, t) {
      return "<br />";
    },
    closeTag: function (e, t) {
      return "";
    }
  },
  btc: {
    openTag: function (e, t) {
      return '<span class="BTC">BTC</span>';
    },
    closeTag: function (e, t) {
      return "";
    }
  },
  center: {
    openTag: function (e, t) {
      return '<div align="center">';
    },
    closeTag: function (e, t) {
      return "</div>";
    }
  },
  code: {
    openTag: function (e, t) {
      return "<code>";
    },
    closeTag: function (e, t) {
      return "</code>";
    },
    noParse: !0
  },
  color: {
    openTag: function (e, t) {
      var i = "",
        n = e || "=black";
      return n = n.substr(1) || "black", n = n.toLowerCase(), n = n.trim(), _.lastIndex = 0, v.lastIndex = 0, _.test(n) ? i = n : v.test(n) ? "#" !== n.substr(0, 1) ? (i = "_" + n, n = "#" + n) : i = "_" + n.substr(1) : (n = "black", i = "black"), '<span class="bbcode-color-' + i + '" style="color:' + n + '">';
    },
    closeTag: function (e, t) {
      return "</span>";
    }
  },
  email: {
    openTag: function (e, t) {
      var i;
      return i = e ? e.substr(1) : t.replace(/<.*?>/g, ""), i = i.trim(), y.lastIndex = 0, y.test(i) ? '<a href="mailto:' + i + '" target="_blank">' : "<a>";
    },
    closeTag: function (e, t) {
      return "</a>";
    }
  },
  ftp: {
    openTag: function (e, t) {
      var i = "";
      return i = e ? e.substr(1) : t.replace(/<.*?>/g, ""), i = i.trim(), g.lastIndex = 0, g.test(i) ? '<a href="' + i + '" target="_blank">' : '<a target="_blank">';
    },
    closeTag: function (e, t) {
      return "</a>";
    }
  },
  glow: {
    openTag: function (e, t) {
      var i = e || "";
      i = e.substr(1) || "";
      i = i.replace(/<.*?>/g, "");
      var n = "",
        o = i.split(",")[0];
      return o = o.trim(), o = o.toLowerCase(), _.lastIndex = 0, v.lastIndex = 0, _.test(o) ? n = o : v.test(o) ? "#" !== o.substr(0, 1) ? (n = "_" + o, o = "#" + o) : n = "_" + o.substr(1) : (o = "inherit", n = "inherit"), '<span class="bbcode-bgcolor-' + n + '" style="background-color: ' + o + '">';
    },
    closeTag: function (e, t) {
      return "</span>";
    }
  },
  green: {
    openTag: function (e, t) {
      return '<span class="bbcode-color-green" style="color: green;">';
    },
    closeTag: function (e, t) {
      return "</span>";
    }
  },
  hr: {
    openTag: function (e, t) {
      return "<hr />";
    },
    closeTag: function (e, t) {
      return "";
    }
  },
  html: {
    openTag: function (e, t) {
      return "";
    },
    closeTag: function (e, t) {
      return "";
    }
  },
  i: {
    openTag: function (e, t) {
      return "<i>";
    },
    closeTag: function (e, t) {
      return "</i>";
    }
  },
  img: {
    openTag: function (e, t) {
      var i = t;
      if (i = i.trim(), f.lastIndex = 0, f.test(i) || (i = ""), !e) {
        return '<img src="' + i + '" />';
      }
      var n = e;
      n = n.trim();
      n = n.replace(/<.*?>/g, "");
      var o, a, s;
      if ((n.match(/alt=/gi) || []).length > 1) {
        return '<img src="' + i + '" />';
      }
      if ((n.match(/width=/gi) || []).length > 1) {
        return '<img src="' + i + '" />';
      }
      if ((n.match(/height=/gi) || []).length > 1) {
        return '<img src="' + i + '" />';
      }
      var r = /^(alt=.+?|width=[0-9]+?|height=[0-9]+?)?\s*(alt=.+?|width=[0-9]+?|height=[0-9]+?)?\s*(alt=.+?|width=[0-9]+?|height=[0-9]+?)$/i.exec(n);
      if (r) {
        for (var l = 1; l < r.length; l++) {
          var c = r[l] || "";
          c = c.trim();
          /alt=/i.test(c) ? o = c.substr(4) : /width=/i.test(c) ? a = c.substr(6) : /height=/i.test(c) && (s = c.substr(7));
        }
      }
      var d = '<img src="' + i + '" ';
      return o && (d += 'alt="' + o + '" '), a && (d += 'width="' + a + '" '), s && (d += 'height="' + s + '" '), d += "/>";
    },
    closeTag: function (e, t) {
      return "";
    },
    displayContent: !1
  },
  iurl: {
    openTag: function (e, t) {
      var i;
      return i = e ? e.substr(1) : t.replace(/<.*?>/g, ""), i = i.trim(), f.lastIndex = 0, f.test(i) || (i = "#"), '<a href="' + i + '" />';
    },
    closeTag: function (e, t) {
      return "";
    }
  },
  left: {
    openTag: function (e, t) {
      return '<div class="bbcode-text-left" style="text-align: left;">';
    },
    closeTag: function (e, t) {
      return "</div>";
    }
  },
  li: {
    openTag: function (e, t) {
      return "<li>";
    },
    closeTag: function (e, t) {
      return "</li>";
    },
    restrictParentsTo: ["list", "ul", "ol"]
  },
  list: {
    openTag: function (e, t) {
      var i = "<ul>",
        n = e || "";
      return n = n.trim(), n = n.replace(/<.*?>/g, ""), 0 === n.indexOf("type=") && (n = n.replace("type=", ""), n = n.trim(), /(none|disc|circle|square|decimal|decimal-leading-zero|lower-roman|upper-roman|lower-alpha|upper-alpha|lower-greek|lower-latin|upper-latin|hebrew|armenian|georgian|cjk-ideographic|hiragana|katakana|hiragana-iroha|katakana-iroha)/i.test(n) && (i = '<ul class="bbcode-list-' + n + '" style="list-style-type: ' + n + '">')), i;
    },
    closeTag: function (e, t) {
      return "</ul>";
    },
    restrictChildrenTo: ["*", "li"]
  },
  ltr: {
    openTag: function (e, t) {
      return '<div dir="ltr">';
    },
    closeTag: function (e, t) {
      return "</div>";
    }
  },
  me: {
    openTag: function (e, t) {
      var i = e || "";
      return i = i.substr(1), i = i.replace(/<.*?>/g, ""), i = i.trim(), t && (i += " "), '<div class="bbcode-color-red" style="color: red;">* ' + i + " ";
    },
    closeTag: function (e, t) {
      return "</div>";
    }
  },
  move: {
    openTag: function (e, t) {
      return "<div>";
    },
    closeTag: function (e, t) {
      return "</div>";
    }
  },
  noparse: {
    openTag: function (e, t) {
      return "";
    },
    closeTag: function (e, t) {
      return "";
    },
    noParse: !0
  },
  nobbc: {
    openTag: function (e, t) {
      return "";
    },
    closeTag: function (e, t) {
      return "";
    },
    noParse: !0
  },
  ol: {
    openTag: function (e, t) {
      return "<ol>";
    },
    closeTag: function (e, t) {
      return "</ol>";
    },
    restrictChildrenTo: ["*", "li"]
  },
  pre: {
    openTag: function (e, t) {
      return "<pre>";
    },
    closeTag: function (e, t) {
      return "</pre>";
    }
  },
  php: {
    openTag: function (e, t) {
      return "<pre>";
    },
    closeTag: function (e, t) {
      return "</pre>";
    },
    noParse: !0
  },
  quote: {
    openTag: function (e, t) {
      var i = '<div class="quoteHeader">Quote</div>',
        n = '<div class="quote">',
        o = e || "";
      if (o = o.trim(), o = o.replace(/<.*?>/g, ""), "" === o) {
        return i + n;
      }
      if (0 === o.indexOf("=")) {
        var a = o.substr(1);
        return i = '<div class="quoteHeader">', i += "Quote From: " + a, i += "</div>", i + n;
      }
      if (/author="/i.test(o)) {
        var s = o.toLowerCase(),
          r = o.substr(s.indexOf('author="') + 7);
        return r = r.replace(/"/g, ""), i = '<div class="quoteHeader">', i += "Quote From: " + r, i += "</div>", i + n;
      }
      var l,
        c,
        d,
        u = o.match(/author=/gi) || [];
      if (u.length > 1 || 0 === u.length) {
        return i + n;
      }
      if ((o.match(/link=/gi) || []).length > 1) {
        return i + n;
      }
      if ((o.match(/date=/gi) || []).length > 1) {
        return i + n;
      }
      var h = /^(author=.+?|link=.+?|date=[0-9]+?)?\s*(author=.+?|link=.+?|date=[0-9]+?)?\s*(author=.+?|link=.+?|date=[0-9]+?)$/i.exec(o);
      if (h) {
        for (var p = 1; p < h.length; p++) {
          var m = h[p] || "";
          m = m.trim();
          /author=/i.test(m) ? l = m.substr(7) : /link=/i.test(m) ? (c = m.substr(5), M.test(c) || T.test(c) || (c = void 0)) : /date=/i.test(m) && (d = Number(m.substr(5)));
        }
      }
      return l && (i = '<div class="quoteHeader">', i += "Quote From: " + l, i += "</div>"), l && c && d && (i = '<div class="quoteHeader">', i += '<a href="' + c + '">', i += "Quote from: " + l + " on ept-date=" + d, i += "</a>", i += "</div>"), i + n;
    },
    closeTag: function (e, t) {
      return "</div>";
    }
  },
  right: {
    openTag: function (e, t) {
      return '<div class="bbcode-text-right" style="text-align: right;">';
    },
    closeTag: function (e, t) {
      return "</div>";
    }
  },
  red: {
    openTag: function (e, t) {
      return '<span class="bbcode-color-red" style="color: red;">';
    },
    closeTag: function (e, t) {
      return "</span>";
    }
  },
  rtl: {
    openTag: function (e, t) {
      return '<div dir="rtl">';
    },
    closeTag: function (e, t) {
      return "</div>";
    }
  },
  s: {
    openTag: function (e, t) {
      return "<del>";
    },
    closeTag: function (e, t) {
      return "</del>";
    }
  },
  shadow: {
    openTag: function (e, t) {
      var i = "",
        n = "",
        o = "",
        a = "",
        s = /^(?:left|right|top|bottom)$/,
        r = /^[0-9]\d{0,2}$/,
        l = e || "";
      if (l = e.substr(1) || "", l = l.replace(/<.*?>/g, ""), l.indexOf(",") < 0) {
        return "<span>";
      }
      if (n = l.split(",")[0], n = n.trim(), n = n.toLowerCase(), _.lastIndex = 0, v.lastIndex = 0, _.test(n) || (v.test(n) ? "#" !== n.substr(0, 1) && (n = "#" + n) : n = "black"), o = l.split(",")[1] || "", o = o.trim()) {
        if (s.test(o)) {
          o = "left" === o ? " -2px 2px" : "right" === o ? " 2px 2px" : "top" === o ? " 0 -2px" : "bottom" === o ? " 0 2px" : " 0 0";
        } else if (r.test(o)) {
          var c = o,
            d = .0174532925 * c;
          o = " " + Math.round(4 * Math.cos(d)) + "px";
          o += " " + Math.round(-4 * Math.sin(d)) + "px";
        } else {
          o = " 0 0";
        }
      } else {
        o = " 0 0";
      }
      a = l.split(",")[2] || "";
      a = a.trim();
      a = a && r.test(a) ? " " + a + "px" : " 0";
      i = n + o + a;
      var u = i.replace(/\s/gi, "_");
      return u = u.replace(/#/gi, "_"), '<span class="bbcode-shadow-' + u + '" style="text-shadow: ' + i + '">';
    },
    closeTag: function (e, t) {
      return "</span>";
    }
  },
  size: {
    openTag: function (e, t) {
      var i = e || "";
      return i = i.substr(1) || "inherit", i = i.trim(), w.lastIndex = 0, w.test(i) || (i = "inherit"), '<span class="bbcode-size-' + i + '" style="font-size: ' + i + ' !important; line-height: 1.3em;">';
    },
    closeTag: function (e, t) {
      return "</span>";
    }
  },
  spoiler: {
    openTag: function (e, t) {
      return '<span class="spoiler">';
    },
    closeTag: function (e, t) {
      return "</span>";
    }
  },
  sub: {
    openTag: function (e, t) {
      return "<sub>";
    },
    closeTag: function (e, t) {
      return "</sub>";
    }
  },
  sup: {
    openTag: function (e, t) {
      return "<sup>";
    },
    closeTag: function (e, t) {
      return "</sup>";
    }
  },
  tt: {
    openTag: function (e, t) {
      return "<tt>";
    },
    closeTag: function (e, t) {
      return "</tt>";
    }
  },
  time: {
    openTag: function (e, t) {
      var i = t || "";
      return Number(i) ? i = "ept-date=" + i : (i = new Date(i).getTime(), i = "ept-date=" + i), i;
    },
    closeTag: function (e, t) {
      return "";
    },
    displayContent: !1
  },
  table: {
    openTag: function (e, t) {
      return "<table>";
    },
    closeTag: function (e, t) {
      return "</table>";
    },
    restrictChildrenTo: ["tbody", "thead", "tfoot", "tr"]
  },
  tbody: {
    openTag: function (e, t) {
      return "<tbody>";
    },
    closeTag: function (e, t) {
      return "</tbody>";
    },
    restrictChildrenTo: ["tr"],
    restrictParentsTo: ["table"]
  },
  tfoot: {
    openTag: function (e, t) {
      return "<tfoot>";
    },
    closeTag: function (e, t) {
      return "</tfoot>";
    },
    restrictChildrenTo: ["tr"],
    restrictParentsTo: ["table"]
  },
  thead: {
    openTag: function (e, t) {
      return "<thead>";
    },
    closeTag: function (e, t) {
      return "</thead>";
    },
    restrictChildrenTo: ["tr"],
    restrictParentsTo: ["table"]
  },
  td: {
    openTag: function (e, t) {
      return '<td valign="top">';
    },
    closeTag: function (e, t) {
      return "</td>";
    },
    restrictParentsTo: ["tr"]
  },
  th: {
    openTag: function (e, t) {
      return "<th>";
    },
    closeTag: function (e, t) {
      return "</th>";
    },
    restrictParentsTo: ["tr"]
  },
  tr: {
    openTag: function (e, t) {
      return "<tr>";
    },
    closeTag: function (e, t) {
      return "</tr>";
    },
    restrictChildrenTo: ["td", "th"],
    restrictParentsTo: ["table", "tbody", "tfoot", "thead"]
  },
  u: {
    openTag: function (e, t) {
      return "<u>";
    },
    closeTag: function (e, t) {
      return "</u>";
    }
  },
  ul: {
    openTag: function (e, t) {
      return "<ul>";
    },
    closeTag: function (e, t) {
      return "</ul>";
    },
    restrictChildrenTo: ["*", "li"]
  },
  url: {
    openTag: function (e, t) {
      var i;
      return i = e ? e.substr(1) : t.replace(/<.*?>/g, ""), i = i.trim(), f.lastIndex = 0, f.test(i) || (i = "#"), '<a href="' + i + '" target="_blank">';
    },
    closeTag: function (e, t) {
      return "</a>";
    }
  },
  white: {
    openTag: function (e, t) {
      return '<span class="bbcode-color-white" style="color: white;">';
    },
    closeTag: function (e, t) {
      return "</span>";
    }
  },
  "*": {
    openTag: function (e, t) {
      return "<li>";
    },
    closeTag: function (e, t) {
      return "</li>";
    },
    restrictParentsTo: ["list", "ul", "ol"]
  }
};
e();
i = e.substr(1) || "";
i = i.replace(/<.*?>/g, "");
n = n.trim();
n = n.replace(/<.*?>/g, "");
c = c.trim();
/alt=/i.test(c) ? o = c.substr(4) : /width=/i.test(c) ? a = c.substr(6) : /height=/i.test(c) && (s = c.substr(7));
m = m.trim();
/author=/i.test(m) ? l = m.substr(7) : /link=/i.test(m) ? (c = m.substr(5), M.test(c) || T.test(c) || (c = void 0)) : /date=/i.test(m) && (d = Number(m.substr(5)));
o = " " + Math.round(4 * Math.cos(d)) + "px";
o += " " + Math.round(-4 * Math.sin(d)) + "px";
a = l.split(",")[2] || "";
a = a.trim();
a = a && r.test(a) ? " " + a + "px" : " 0";
i = n + o + a;
window.gui.on("connected", function () {
  e.hide();
});
this.on("show", function () {
  e.addClassNames("backgroundImage");
});
this.on("hide", function () {
  e.delClassNames("backgroundImage");
});
o(n, a);
e.exports = n;
a.call(this, "div", {
  className: "splashScreen",
  hidden: !0
});
this.once("show", n.prototype._createContent);
o(n, a);
e.exports = n;
n.prototype._createContent = function () {
  this.log = this.createChild("div", {
    className: "logBox"
  });
  this.createChild("div", {
    className: "dofusLogo"
  });
  this.createChild("div", {
    className: ["spinner", "splashSpinner"]
  });
};
n.prototype.showMessage = function (e) {
  this.log.setText(e);
};
this.log = this.createChild("div", {
  className: "logBox"
});
this.createChild("div", {
  className: "dofusLogo"
});
this.createChild("div", {
  className: ["spinner", "splashSpinner"]
});
g.disable();
f.disable();
p.setText(l("ui.common.waiting"));
p.delClassNames("error");
window.dofus.sendMessage("NicknameChoiceRequestMessage", {
  nickname: e
});
window.dofus.disconnect();
s.close(n.id);
this.once("open", function () {
  h.on("change", i);
  h.on("validate", function () {
    g.tap();
  });
  g.on("tap", e);
  f.on("tap", function () {
    t();
  });
  window.gui.on("NicknameRefusedMessage", function (e) {
    p.setText(l(u[e.reason]));
    p.addClassNames("error");
    g.enable();
    f.enable();
  });
  window.gui.on("NicknameAcceptedMessage", function () {
    window.gui.openConfirmPopup({
      title: l("ui.popup.warning"),
      message: l("tablet.nickname.reconnect.popup"),
      noDisable: !0,
      cb: function (e) {
        e && t();
      }
    });
  });
});
this.on("open", function () {
  n.setTitle(l("ui.pseudoChoice.title"));
  d.setText(l("ui.pseudoChoice.help"));
  g.disable();
  f.enable();
  f.setText(l("ui.common.cancel"));
  g.setText(l("ui.common.validation"));
  h.focus();
});
this.on("close", function () {
  p.setText("");
  p.delClassNames("error");
  h.setValue("");
  h.blur();
});
h.on("change", i);
h.on("validate", function () {
  g.tap();
});
g.on("tap", e);
f.on("tap", function () {
  t();
});
window.gui.on("NicknameRefusedMessage", function (e) {
  p.setText(l(u[e.reason]));
  p.addClassNames("error");
  g.enable();
  f.enable();
});
window.gui.on("NicknameAcceptedMessage", function () {
  window.gui.openConfirmPopup({
    title: l("ui.popup.warning"),
    message: l("tablet.nickname.reconnect.popup"),
    noDisable: !0,
    cb: function (e) {
      e && t();
    }
  });
});
p.setText(l(u[e.reason]));
p.addClassNames("error");
g.enable();
f.enable();
n.setTitle(l("ui.pseudoChoice.title"));
d.setText(l("ui.pseudoChoice.help"));
g.disable();
f.enable();
f.setText(l("ui.common.cancel"));
g.setText(l("ui.common.validation"));
h.focus();
p.setText("");
p.delClassNames("error");
h.setValue("");
h.blur();
u[d.ALREADY_USED] = "ui.nickname.alreadyUsed";
u[d.SAME_AS_LOGIN] = "ui.nickname.equalsLogin";
u[d.TOO_SIMILAR_TO_LOGIN] = "ui.nickname.similarToLogin";
u[d.INVALID_NICK] = "ui.nickname.invalid";
u[d.UNKNOWN_NICK_ERROR] = "ui.nickname.unknown";
o(n, a);
e.exports = n;
T.on("blur", e);
E.on("blur", e);
D.on("blur", e);
H.on("blur", e);
q.on("blur", e);
K.on("blur", e);
ee.on("blur", e);
ie.on("change", e);
T.on("validate", function () {
  E.focus();
});
E.on("validate", function () {
  D.focus();
});
D.on("validate", function () {
  o.registerLogic.isParentEmailNeeded() ? H.focus() : q.focus();
});
H.on("validate", function () {
  q.focus();
});
q.on("validate", function () {
  K.focus();
});
K.on("validate", function () {
  ee.focus();
});
ee.on("validate", function () {
  ue.tap();
});
oe.on("tap", t);
ae.on("tap", t);
ue.on("tap", function () {
  return !!e() && (ue.disable(), se.setText(r("ui.common.waiting")), re.delClassNames("visible"), se.delClassNames("error"), o.registerLogic.hasGuestAccount() ? n() : void h.open("recaptcha", o.registerLogic.getRecaptchaData(n)));
});
this.on("open", function (e) {
  C.hide();
  x.hide();
  P.hide();
  z.hide();
  j.hide();
  v = e.onValidate;
  o.registerLogic.setValues(e);
  ue.disable();
  b.setText(r("tablet.register.email"));
  A.setText(r("ui.login.password"));
  k.setText(r("tablet.register.emailParent"));
  O.setText(r("tablet.register.confirmpwd"));
  G.setText(r("tablet.login.pseudo"));
  X.setText(r("ui.login.firstName"));
  Z.setText(r("ui.login.lastName"));
  ie.setText(r("ui.legal.accept"));
  oe.setText(r("ui.legal.tou"));
  oe.link = r("ui.legal.linktou");
  ae.setText(r("ui.legal.gcs"));
  ae.link = r("ui.legal.linkgcs");
  ue.setText(r("ui.common.validation"));
  le.setText(r("tablet.register.suggestion"));
  d.setAutomaticHide(!1);
  B.toggleDisplay(o.registerLogic.isParentEmailNeeded());
  o.registerLogic.hasGuestAccount() ? o.setTitle(r("tablet.oldGuest.register")) : o.setTitle(r("ui.login.createAccount"));
});
this.on("opened", function () {
  T.focus();
});
this.on("close", function (e) {
  return T.setValue(""), E.setValue(""), D.setValue(""), q.setValue(""), K.setValue(""), ee.setValue(""), q.enable(), se.setText(""), se.delClassNames("error"), re.delClassNames("visible"), d.setAutomaticHide(!0), o.registerLogic.resetValues(), v(e);
});
C.hide();
x.hide();
P.hide();
z.hide();
j.hide();
v = e.onValidate;
o.registerLogic.setValues(e);
ue.disable();
b.setText(r("tablet.register.email"));
A.setText(r("ui.login.password"));
k.setText(r("tablet.register.emailParent"));
O.setText(r("tablet.register.confirmpwd"));
G.setText(r("tablet.login.pseudo"));
X.setText(r("ui.login.firstName"));
Z.setText(r("ui.login.lastName"));
ie.setText(r("ui.legal.accept"));
oe.setText(r("ui.legal.tou"));
oe.link = r("ui.legal.linktou");
ae.setText(r("ui.legal.gcs"));
ae.link = r("ui.legal.linkgcs");
ue.setText(r("ui.common.validation"));
le.setText(r("tablet.register.suggestion"));
d.setAutomaticHide(!1);
B.toggleDisplay(o.registerLogic.isParentEmailNeeded());
o.registerLogic.hasGuestAccount() ? o.setTitle(r("tablet.oldGuest.register")) : o.setTitle(r("ui.login.createAccount"));
o(n, a);
e.exports = n;
this._birthDateRegistrationLimitTimestamp = null;
this._selectedBirthDateTimestamp = null;
this._guestAccount = null;
e.exports = n;
n.prototype.resetValues = function () {
  this._guestAccount = null;
  this._birthDateRegistrationLimitTimestamp = null;
  this._selectedBirthDateTimestamp = null;
};
n.prototype.setValues = function (e) {
  this._guestAccount = e.guestAccount;
  this._birthDateRegistrationLimitTimestamp = e.birthDateRegistrationLimitTimestamp;
  this._selectedBirthDateTimestamp = e.selectedBirthDateTimestamp;
};
n.prototype.hasGuestAccount = function () {
  return Boolean(this._guestAccount);
};
n.prototype.isParentEmailNeeded = function () {
  return this._selectedBirthDateTimestamp > this._birthDateRegistrationLimitTimestamp;
};
n.prototype.testEmail = function (e) {
  return /.+@.+\..+/.test(e);
};
n.prototype.testNickname = function (e) {
  return /^[a-zA-Z0-9-]*$/.test(e);
};
n.prototype.createAccount = function (e, t, i) {
  var n = this;
  t.birthDateTimestamp = this._birthDateRegistrationLimitTimestamp;
  this.hasGuestAccount() && (t.guestLogin = this._guestAccount.login, t.guestPassword = this._guestAccount.password);
  a.series([function (t) {
    return n.hasGuestAccount() ? t() : void o.createGuest(e, function (e, i) {
      return e ? t(e.error) : (n._guestAccount = i, void t());
    });
  }, function (e) {
    t.guestLogin = n._guestAccount.login;
    t.guestPassword = n._guestAccount.password;
    o.validateGuest(t, e);
  }], function (e) {
    i(e, {
      login: t.login,
      password: t.password
    });
  });
};
n.prototype.getRecaptchaData = function (e) {
  var t = r.Config,
    i = t.language || "en",
    n = t.recaptcha.ankamaUrl,
    o = n + "/" + i + "/captcha";
  return {
    origin: n,
    src: o,
    lang: i,
    callback: e
  };
};
this._guestAccount = null;
this._birthDateRegistrationLimitTimestamp = null;
this._selectedBirthDateTimestamp = null;
this._guestAccount = e.guestAccount;
this._birthDateRegistrationLimitTimestamp = e.birthDateRegistrationLimitTimestamp;
this._selectedBirthDateTimestamp = e.selectedBirthDateTimestamp;
t.birthDateTimestamp = this._birthDateRegistrationLimitTimestamp;
this.hasGuestAccount() && (t.guestLogin = this._guestAccount.login, t.guestPassword = this._guestAccount.password);
a.series([function (t) {
  return n.hasGuestAccount() ? t() : void o.createGuest(e, function (e, i) {
    return e ? t(e.error) : (n._guestAccount = i, void t());
  });
}, function (e) {
  t.guestLogin = n._guestAccount.login;
  t.guestPassword = n._guestAccount.password;
  o.validateGuest(t, e);
}], function (e) {
  i(e, {
    login: t.login,
    password: t.password
  });
});
t.guestLogin = n._guestAccount.login;
t.guestPassword = n._guestAccount.password;
o.validateGuest(t, e);
E.disable();
v && y && E.enable();
A.toggleDisplay(l);
l && (y = null);
e();
p.addTooltip(A, function () {
  return new m("div", {
    text: s("ui.register.invalidDate")
  });
});
T.on("change", i);
C.on("change", i);
I.on("change", i);
E.on("tap", function () {
  E.disable();
  u.open("register", {
    onValidate: _,
    guestAccount: n,
    birthDateRegistrationLimitTimestamp: v,
    selectedBirthDateTimestamp: y
  });
  o.close();
});
T.on("validate", function () {
  C.focus();
});
C.on("validate", function () {
  I.focus();
});
I.on("validate", function () {
  E.tap();
});
this.on("open", function (t) {
  A.hide();
  T.setPlaceholder(s("ui.common.placeholder.year"));
  C.setPlaceholder(s("ui.common.placeholder.month"));
  I.setPlaceholder(s("ui.common.placeholder.day"));
  _ = t.onValidate;
  n = t.guestAccount;
  w.show();
  b.setText(s("tablet.login.birthday"));
  E.disable();
  E.setText(s("ui.common.validation"));
  v = null;
  c.setAutomaticHide(!1);
  n ? o.setTitle(s("tablet.oldGuest.register")) : o.setTitle(s("ui.login.createAccount"));
  r.registerOpenRequest(function (t, i) {
    if (t) {
      return console.error("BirthdayLimitWindow: registerOpenRequest", t);
    }
    var n = new Date(i.value);
    v = n.getTime();
    isNaN(v) && (console.error(new Error("Invalid Date for birth date limit: dateFormat " + i.value)), v = null);
    e();
  });
});
this.on("close", function (e) {
  c.setAutomaticHide(!0);
  n = null;
  _(e);
  _ = g;
});
E.disable();
u.open("register", {
  onValidate: _,
  guestAccount: n,
  birthDateRegistrationLimitTimestamp: v,
  selectedBirthDateTimestamp: y
});
o.close();
A.hide();
T.setPlaceholder(s("ui.common.placeholder.year"));
C.setPlaceholder(s("ui.common.placeholder.month"));
I.setPlaceholder(s("ui.common.placeholder.day"));
_ = t.onValidate;
n = t.guestAccount;
w.show();
b.setText(s("tablet.login.birthday"));
E.disable();
E.setText(s("ui.common.validation"));
v = null;
c.setAutomaticHide(!1);
n ? o.setTitle(s("tablet.oldGuest.register")) : o.setTitle(s("ui.login.createAccount"));
r.registerOpenRequest(function (t, i) {
  if (t) {
    return console.error("BirthdayLimitWindow: registerOpenRequest", t);
  }
  var n = new Date(i.value);
  v = n.getTime();
  isNaN(v) && (console.error(new Error("Invalid Date for birth date limit: dateFormat " + i.value)), v = null);
  e();
});
v = n.getTime();
isNaN(v) && (console.error(new Error("Invalid Date for birth date limit: dateFormat " + i.value)), v = null);
e();
c.setAutomaticHide(!0);
n = null;
_(e);
_ = g;
l(n, d);
e.exports = n;
a.call(this, {
  className: "LegalAgreementWindow",
  title: "",
  positionInfo: {
    left: "c",
    top: "c",
    width: 525,
    height: 200,
    isFullScreen: !0
  },
  noCloseButton: !0
});
this._canceled = !0;
_.on("change", e);
f.on("tap", t);
g.on("tap", t);
w.on("tap", function () {
  y.disable();
  w.disable();
  i._canceled = !1;
  i.close();
});
y.on("tap", function () {
  i.close();
});
this.on("open", function (e) {
  h = e.onValidate;
  w.disable();
  y.enable();
  i.windowTitle.setText(s("ui.connection.legalAgreement"));
  _.setText(s("ui.legal.accept"));
  f.setText(s("ui.legal.tou"));
  f.link = s("ui.legal.linktou");
  g.setText(s("ui.legal.gcs"));
  g.link = s("ui.legal.linkgcs");
  y.setText(s("ui.common.cancel"));
  w.setText(s("ui.common.validation"));
});
this.on("close", function (e) {
  _.deactivate();
  i._canceled || (u.setValue("guestAgreement", !0, 1, !0), h(e), h = o);
});
y.disable();
w.disable();
i._canceled = !1;
i.close();
h = e.onValidate;
w.disable();
y.enable();
i.windowTitle.setText(s("ui.connection.legalAgreement"));
_.setText(s("ui.legal.accept"));
f.setText(s("ui.legal.tou"));
f.link = s("ui.legal.linktou");
g.setText(s("ui.legal.gcs"));
g.link = s("ui.legal.linkgcs");
y.setText(s("ui.common.cancel"));
w.setText(s("ui.common.validation"));
_.deactivate();
i._canceled || (u.setValue("guestAgreement", !0, 1, !0), h(e), h = o);
o(n, a);
e.exports = n;
e = e || {
  className: "preloadMapWindow",
  customClose: !0,
  positionInfo: {
    left: "c",
    top: "c",
    width: 700,
    height: 460,
    isModal: !0
  }
};
I.call(this, e);
this._clearState();
this.closeButton.on("tap", function () {
  t._tryClose();
});
i.on("step", function (e) {
  t._updateState({
    progress: e.percent,
    downloadEstimate: {
      count: e.count,
      nbTotalMaps: e.nbTotalMaps,
      secondLeft: e.secondLeft
    }
  });
});
i.on("error", function (e) {
  console.error(e);
  t._updateState({
    currentScreen: E.ERROR
  });
});
i.on("end", function () {
  t._updateState({
    currentScreen: E.DOWNLOAD_DONE
  });
});
i.on("stop", function () {
  var e = t._state.currentScreen;
  e === E.DOWNLOAD_STOP && t._tryClose();
});
this.on("open", function () {
  b.start();
  var e = !!t.windowBody.getChildCount();
  e || t._createDom();
  t._clearState();
  t._updateState({
    isWiFiActivated: n(),
    currentScreen: E.DISCLAIMER
  });
  t.startWifiCheckTimeout();
});
this.on("close", function () {
  b.stop();
  t.stopWifiCheckTimeout();
});
console.error(e);
t._updateState({
  currentScreen: E.ERROR
});
e || t._createDom();
t._clearState();
t._updateState({
  isWiFiActivated: n(),
  currentScreen: E.DISCLAIMER
});
t.startWifiCheckTimeout();
b.stop();
t.stopWifiCheckTimeout();
o.on("appGoBackground", function () {
  var e = t._state.currentScreen;
  e === E.DOWNLOAD_ACTIVE && i.stop();
});
o.on("appLeaveBackground", function () {
  var e = t._state.currentScreen;
  e === E.DOWNLOAD_ACTIVE && i.restart();
});
this._state.isWiFiActivated = e;
this._wifiState.toggleClassName("on", !!e);
this._updateWifiStateText(e);
this._advice.show();
this._wifiState.show();
this._disclaimerText.show();
this._downloadButton.show();
this._downloadButton.enable();
this._cancelButton.show();
this._downloading.show();
this._checkingAssetsText.show();
this._downloadWifiState.show();
this._progressBar.show();
this._stopButton.show();
this._stopButton.enable();
this._checkAssetsVersion();
this.closeButton.disable();
this._downloading.show();
this._stoppingDownload.show();
this._downloadWifiState.show();
this._progressBar.show();
this._stopButton.show();
this._stopButton.disable();
this._downloading.show();
this._downloadEstimate.show();
this._downloadWifiState.show();
this._progressBar.show();
this._stopButton.show();
this._stopButton.enable();
this._state.hasStartedDownloading ? this._retryDownloading() : this._startDownloading();
this._downloaded.show();
this._downloadEstimate.show();
this._downloadWifiState.show();
this._progressBar.show();
this._continueButton.show();
this._downloading.show();
this._downloadError.show();
this._retryButton.show();
this._retryButton.enable();
this._cancelButton.show();
this._state.progress = e;
this._progressBar.setValue(e);
this._state.wifiCheckTimeout && (this._state.wifiCheckTimeout = window.clearTimeout(this._state.wifiCheckTimeout));
this._state.wifiCheckTimeout = e;
y(o, I);
e.exports = o;
o.prototype._clearState = function () {
  this._state = {
    currentScreen: null,
    downloadEstimate: null,
    hasStartedDownloading: !1,
    isWiFiActivated: !1,
    previousScreen: null,
    progress: 0,
    wifiCheckTimeout: null
  };
};
o.prototype.freeContent = function () {
  this._advice = null;
  this._wifiState = null;
  this._disclaimerText = null;
  this._downloading = null;
  this._downloadingFirstLine = null;
  this._downloadingSecondLine = null;
  this._downloaded = null;
  this._downloadError = null;
  this._checkingAssetsText = null;
  this._stoppingDownload = null;
  this._downloadEstimate = null;
  this._downloadWifiState = null;
  this._progressBar = null;
  this._downloadButton = null;
  this._cancelButton = null;
  this._stopButton = null;
  this._continueButton = null;
  this._retryButton = null;
  this.windowBody.clearContent();
};
o.prototype._createDom = function () {
  var e = this,
    t = this.windowBody;
  t.createChild("div", {
    className: "screenshot"
  });
  this._advice = t.createChild("div", {
    className: "advice"
  });
  var i = t.createChild("div", {
    className: "disclaimer"
  });
  this._wifiState = i.createChild("div", {
    className: "wifiState"
  });
  this._disclaimerText = i.createChild("div", {
    className: "disclaimerText"
  });
  this._downloading = t.createChild("div", {
    className: "downloading"
  });
  this._downloadingFirstLine = this._downloading.createChild("div");
  this._downloadingSecondLine = this._downloading.createChild("div", {
    className: "redLine"
  });
  this._downloaded = t.createChild("div", {
    className: "downloaded"
  });
  this._downloadError = t.createChild("div", {
    className: "downloadError"
  });
  var n = t.createChild("div", {
    className: "preloadBarBlock"
  });
  this._checkingAssetsText = n.createChild("div");
  this._stoppingDownload = n.createChild("div");
  this._downloadEstimate = n.createChild("div");
  this._downloadWifiState = n.createChild("div", {
    className: "downloadWifiState"
  });
  this._progressBar = n.appendChild(new M({
    className: ["green"],
    epsilon: 0
  }));
  var o = t.createChild("div", {
    className: "buttonContainer"
  });
  this._downloadButton = o.appendChild(new _({
    className: ["greenButton"]
  }, function () {
    e._downloadButton.disable();
    e._updateState({
      currentScreen: E.DOWNLOAD_PREPARE
    });
  }));
  this._retryButton = o.appendChild(new _({
    className: ["greenButton"]
  }, function () {
    e._retryButton.disable();
    e._updateState({
      currentScreen: e._state.previousScreen
    });
  }));
  this._cancelButton = o.appendChild(new _({
    className: ["greenButton", "greyButton"]
  }, function () {
    e._tryClose();
  }));
  this._stopButton = o.appendChild(new _({
    className: ["greenButton", "greyButton"]
  }, function () {
    e._stopButton.disable();
    e._tryClose();
  }));
  this._continueButton = o.appendChild(new _({
    className: ["greenButton"]
  }, function () {
    e._tryClose();
  }));
  this._updateText(this._state.isWiFiActivated);
};
o.prototype._hideAll = function () {
  this._advice.hide();
  this._wifiState.hide();
  this._disclaimerText.hide();
  this._downloading.hide();
  this._downloaded.hide();
  this._downloadError.hide();
  this._checkingAssetsText.hide();
  this._stoppingDownload.hide();
  this._downloadEstimate.hide();
  this._downloadWifiState.hide();
  this._progressBar.hide();
  this._downloadButton.hide();
  this._cancelButton.hide();
  this._stopButton.hide();
  this._continueButton.hide();
  this._retryButton.hide();
};
this._advice = null;
this._wifiState = null;
this._disclaimerText = null;
this._downloading = null;
this._downloadingFirstLine = null;
this._downloadingSecondLine = null;
this._downloaded = null;
this._downloadError = null;
this._checkingAssetsText = null;
this._stoppingDownload = null;
this._downloadEstimate = null;
this._downloadWifiState = null;
this._progressBar = null;
this._downloadButton = null;
this._cancelButton = null;
this._stopButton = null;
this._continueButton = null;
this._retryButton = null;
this.windowBody.clearContent();
t.createChild("div", {
  className: "screenshot"
});
this._advice = t.createChild("div", {
  className: "advice"
});
this._wifiState = i.createChild("div", {
  className: "wifiState"
});
this._disclaimerText = i.createChild("div", {
  className: "disclaimerText"
});
this._downloading = t.createChild("div", {
  className: "downloading"
});
this._downloadingFirstLine = this._downloading.createChild("div");
this._downloadingSecondLine = this._downloading.createChild("div", {
  className: "redLine"
});
this._downloaded = t.createChild("div", {
  className: "downloaded"
});
this._downloadError = t.createChild("div", {
  className: "downloadError"
});
this._checkingAssetsText = n.createChild("div");
this._stoppingDownload = n.createChild("div");
this._downloadEstimate = n.createChild("div");
this._downloadWifiState = n.createChild("div", {
  className: "downloadWifiState"
});
this._progressBar = n.appendChild(new M({
  className: ["green"],
  epsilon: 0
}));
this._downloadButton = o.appendChild(new _({
  className: ["greenButton"]
}, function () {
  e._downloadButton.disable();
  e._updateState({
    currentScreen: E.DOWNLOAD_PREPARE
  });
}));
this._retryButton = o.appendChild(new _({
  className: ["greenButton"]
}, function () {
  e._retryButton.disable();
  e._updateState({
    currentScreen: e._state.previousScreen
  });
}));
this._cancelButton = o.appendChild(new _({
  className: ["greenButton", "greyButton"]
}, function () {
  e._tryClose();
}));
this._stopButton = o.appendChild(new _({
  className: ["greenButton", "greyButton"]
}, function () {
  e._stopButton.disable();
  e._tryClose();
}));
this._continueButton = o.appendChild(new _({
  className: ["greenButton"]
}, function () {
  e._tryClose();
}));
this._updateText(this._state.isWiFiActivated);
e._downloadButton.disable();
e._updateState({
  currentScreen: E.DOWNLOAD_PREPARE
});
e._retryButton.disable();
e._updateState({
  currentScreen: e._state.previousScreen
});
e._stopButton.disable();
e._tryClose();
this._advice.hide();
this._wifiState.hide();
this._disclaimerText.hide();
this._downloading.hide();
this._downloaded.hide();
this._downloadError.hide();
this._checkingAssetsText.hide();
this._stoppingDownload.hide();
this._downloadEstimate.hide();
this._downloadWifiState.hide();
this._progressBar.hide();
this._downloadButton.hide();
this._cancelButton.hide();
this._stopButton.hide();
this._continueButton.hide();
this._retryButton.hide();
o.prototype.startWifiCheckTimeout = function () {
  var e = this,
    t = window.setTimeout(function () {
      e._updateState({
        isWiFiActivated: n()
      });
      e.startWifiCheckTimeout();
    }, S);
  this._updateState({
    wifiCheckTimeout: t
  });
};
o.prototype.stopWifiCheckTimeout = function () {
  this._updateState({
    wifiCheckTimeout: null
  });
};
o.prototype._updateText = function (e) {
  this.setTitle(v("tablet.preload.title"));
  var t = v("tablet.common.acronymGigabytes", A);
  this._advice.setText(v("tablet.preload.advice", t));
  this._disclaimerText.setText(v("tablet.preload.disclaimer"));
  this._downloadingFirstLine.setText(v("tablet.preload.downloading"));
  this._downloadingSecondLine.setText(v("tablet.preload.downloadingWarning"));
  this._downloaded.setText(v("tablet.preload.done"));
  this._downloadError.setText(v("tablet.preload.error"));
  this._checkingAssetsText.setText(v("tablet.preload.checkingAssets"));
  this._stoppingDownload.setText(v("tablet.common.stopping"));
  this._downloadButton.setText(v("tablet.common.downloadSize", t));
  this._cancelButton.setText(v("ui.common.cancel"));
  this._stopButton.setText(v("tablet.common.stop"));
  this._continueButton.setText(v("tablet.common.continue"));
  this._retryButton.setText(v("tablet.common.retry"));
  this._updateWifiStateText(e);
};
o.prototype._updateWifiStateText = function (e) {
  var t = v(e ? "tablet.common.activated" : "tablet.common.deactivated");
  this._wifiState.setText(t);
  var i = e ? '<span class="on">' + t + "</span>" : t;
  this._downloadWifiState.setHtml(v("tablet.common.wifiState", i));
};
o.prototype._tryClose = function () {
  var e = this._state.currentScreen;
  return e === E.DOWNLOAD_PREPARE ? this._updateState({
    currentScreen: E.DOWNLOAD_STOP
  }) : e === E.DOWNLOAD_ACTIVE ? (this._updateState({
    currentScreen: E.DOWNLOAD_STOP
  }), this._mapPreloader.stop()) : void this.close();
};
o.prototype._hasStopped = function () {
  return this._state.currentScreen === E.DOWNLOAD_STOP;
};
o.prototype._checkAssetsVersion = function () {
  function e(e) {
    console.error(e);
    t._updateState({
      currentScreen: E.ERROR
    });
  }
  var t = this;
  this._updateState({
    progress: 0
  });
  g.getVersions(function (i, n) {
    return i ? e(i) : t._hasStopped() ? t._tryClose() : (t._updateState({
      progress: .33
    }), void f(n, function (i, n) {
      return i ? e(i) : t._hasStopped() ? t._tryClose() : (t._updateState({
        progress: .67
      }), void g.upgradeAssets(n, function (i) {
        return i ? e(i) : t._hasStopped() ? t._tryClose() : void t._updateState({
          progress: 1,
          currentScreen: E.DOWNLOAD_ACTIVE
        });
      }));
    }));
  });
};
o.prototype._startDownloading = function () {
  var e = this;
  e._updateState({
    hasStartedDownloading: !0,
    progress: 0,
    downloadEstimate: {
      count: 0
    }
  });
  C.getAllDataMap("Areas", function (t, i) {
    if (t) {
      return console.error(t);
    }
    if (e._hasStopped()) {
      return e._tryClose();
    }
    var n = [];
    for (var o in i) {
      n.push(i[o].id);
    }
    e._mapPreloader.preloadAreas(n);
  });
};
o.prototype._retryDownloading = function () {
  this._mapPreloader.restart();
};
e._updateState({
  isWiFiActivated: n()
});
e.startWifiCheckTimeout();
this._advice.setText(v("tablet.preload.advice", t));
this._disclaimerText.setText(v("tablet.preload.disclaimer"));
this._downloadingFirstLine.setText(v("tablet.preload.downloading"));
this._downloadingSecondLine.setText(v("tablet.preload.downloadingWarning"));
this._downloaded.setText(v("tablet.preload.done"));
this._downloadError.setText(v("tablet.preload.error"));
this._checkingAssetsText.setText(v("tablet.preload.checkingAssets"));
this._stoppingDownload.setText(v("tablet.common.stopping"));
this._downloadButton.setText(v("tablet.common.downloadSize", t));
this._cancelButton.setText(v("ui.common.cancel"));
this._stopButton.setText(v("tablet.common.stop"));
this._continueButton.setText(v("tablet.common.continue"));
this._retryButton.setText(v("tablet.common.retry"));
this._updateWifiStateText(e);
console.error(e);
t._updateState({
  currentScreen: E.ERROR
});
this._updateState({
  progress: 0
});
g.getVersions(function (i, n) {
  return i ? e(i) : t._hasStopped() ? t._tryClose() : (t._updateState({
    progress: .33
  }), void f(n, function (i, n) {
    return i ? e(i) : t._hasStopped() ? t._tryClose() : (t._updateState({
      progress: .67
    }), void g.upgradeAssets(n, function (i) {
      return i ? e(i) : t._hasStopped() ? t._tryClose() : void t._updateState({
        progress: 1,
        currentScreen: E.DOWNLOAD_ACTIVE
      });
    }));
  }));
});
e._updateState({
  hasStartedDownloading: !0,
  progress: 0,
  downloadEstimate: {
    count: 0
  }
});
C.getAllDataMap("Areas", function (t, i) {
  if (t) {
    return console.error(t);
  }
  if (e._hasStopped()) {
    return e._tryClose();
  }
  var n = [];
  for (var o in i) {
    n.push(i[o].id);
  }
  e._mapPreloader.preloadAreas(n);
});
t.upgradeAssets = function (e, t) {
  function i(t) {
    function i() {
      return o(n, d, t);
    }
    var n = e.assetsVersion;
    if (!n) {
      return t();
    }
    var a = window.wizAssets;
    return a ? c.deleteFiles(e.changedFiles, i, t) : i();
  }
  function n(t) {
    var i = e.staticDataVersion;
    return i ? void r.eraseDiskCache(function (e) {
      return e ? t(e) : void r.initializeDiskCache(function () {
        console.info("Updating staticDataVersionKey to " + i);
        o(i, u, t);
      });
    }) : t();
  }
  return e.staticDataVersion || e.assetsVersion ? void a.series([n, i], function (e) {
    return e ? t(e) : t();
  }) : t();
};
t.getVersions = function (e) {
  function t(e, t, i, o) {
    n(t, i, function (t, i) {
      return t ? o(t) : (s[e] = i, o());
    });
  }
  function i(e) {
    return t("assetsVersion", d, h, e);
  }
  function o(e) {
    return t("staticDataVersion", u, p, e);
  }
  var s = {};
  a.series([o, i], function (t) {
    return t ? e("Could not get the client assets version: " + t) : e(null, s);
  });
};
console.info("Updating staticDataVersionKey to " + i);
o(i, u, t);
u.call(this, {
  className: "CleanAssetsWindow",
  noCloseButton: !0,
  positionInfo: {
    left: "c",
    top: "c",
    width: 500,
    height: 200,
    isModal: !0
  }
});
this._createdDom = !1;
this._progressBar = null;
l(n, u);
e.exports = n;
n.prototype.freeContent = function () {
  this._progressBar = null;
  this._createdDom = !1;
  this.windowBody.clearContent();
};
n.prototype._createDom = function () {
  if (!this._createdDom) {
    this.setTitle(r("ui.cleanAssets.title"));
    var e = this.windowBody,
      t = e.createChild("div", {
        className: "descriptionBlock"
      });
    t.createChild("div", {
      text: r("ui.cleanAssets.description")
    });
    var i = e.createChild("div", {
      className: "preloadBarBlock"
    });
    this._progressBar = i.appendChild(new c({
      className: ["green"],
      epsilon: 0
    }));
    this._createdDom = !0;
  }
};
n.prototype._checkAssetsVersion = function (e) {
  var t = this;
  this._updateTheProgressBar(0);
  s.getVersions(function (i, n) {
    return i ? e(i) : (t._updateTheProgressBar(.33), void a(n, function (i, n) {
      return i ? e(i) : (t._updateTheProgressBar(.67), void s.upgradeAssets(n, function (i) {
        return i ? e(i) : (t._updateTheProgressBar(1), e());
      }));
    }));
  });
};
n.prototype._updateTheProgressBar = function (e) {
  this._progressBar && this._progressBar.setValue(e);
};
this._progressBar = null;
this._createdDom = !1;
this.windowBody.clearContent();
this._progressBar = i.appendChild(new c({
  className: ["green"],
  epsilon: 0
}));
this._createdDom = !0;
this._updateTheProgressBar(0);
s.getVersions(function (i, n) {
  return i ? e(i) : (t._updateTheProgressBar(.33), void a(n, function (i, n) {
    return i ? e(i) : (t._updateTheProgressBar(.67), void s.upgradeAssets(n, function (i) {
      return i ? e(i) : (t._updateTheProgressBar(1), e());
    }));
  }));
});
c.call(this, {
  className: "connectionQueueWindow",
  positionInfo: {
    left: "c",
    top: "c",
    width: 600,
    height: 200
  },
  noCloseButton: !0
});
this.once("open", this._createContent);
this._setupEventListeners();
r(n, c);
e.exports = n;
n.prototype._setupEventListeners = function () {
  var e = this;
  window.dofus.connectionManager.on("LoginQueueStatusMessage", function (t) {
    e._queueStatusUpdate("login", t.position, t.total);
  });
  window.dofus.connectionManager.on("QueueStatusMessage", function (t) {
    e._queueStatusUpdate("game", t.position, t.total);
  });
};
n.prototype._createContent = function () {
  this.windowTitle.setText(s("ui.queue.wait"));
  var e = this.windowBody.createChild("div", {
    className: "messageBox"
  });
  this.message = e.createChild("div", {
    className: "message"
  });
  var t = this.windowBody.createChild("div", {
      className: "buttonContainer"
    }),
    i = t.appendChild(new a(s("ui.queue.back"))),
    n = this;
  i.on("tap", function () {
    return o() ? (l.goBackToSelectionOf("server"), void d.close(n.id)) : window.dofus.disconnect();
  });
};
n.prototype._queueStatusUpdate = function (e, t, i) {
  if (0 === t) {
    return d.close(this.id);
  }
  d.open(this.id);
  var n = s("ui.queue.number", t, i),
    a = o();
  a && (n += "\n\n" + s("ui.queue.server", a._name));
  this.message.setText(n);
};
window.dofus.connectionManager.on("LoginQueueStatusMessage", function (t) {
  e._queueStatusUpdate("login", t.position, t.total);
});
window.dofus.connectionManager.on("QueueStatusMessage", function (t) {
  e._queueStatusUpdate("game", t.position, t.total);
});
a && (n += "\n\n" + s("ui.queue.server", a._name));
this.message.setText(n);
a.call(this, {
  className: "popupWindow",
  title: "Popup",
  customClose: !0,
  positionInfo: {
    left: "c",
    bottom: "c",
    width: 600,
    height: 210
  }
});
this.messageStack = [];
o(n, a);
e.exports = n;
n.prototype._createContent = function () {
  function e() {
    return t.messageStack.shift(), 0 === t.messageStack.length ? void s.close(t.id) : void t._update();
  }
  var t = this,
    i = this.windowBody.createChild("div", {
      className: "messageBox"
    });
  this.message = i.createChild("div", {
    className: "message"
  });
  var n = this.windowBody.createChild("div", {
      className: "buttonContainer"
    }),
    o = n.appendChild(new r(l("ui.common.ok")));
  o.on("tap", e);
  this.closeButton.on("tap", e);
};
n.prototype._update = function () {
  this.message || this._createContent();
  this.message.clearContent();
  var e = this.messageStack[0],
    t = e.message.split("<br>").length <= 2 ? "center" : "left";
  this.message.setStyle("text-align", t);
  this.message.setStyle("white-space", e.enablePreWrap ? "pre-wrap" : "");
  this.message.appendChild(c.process(e.message, {
    isNonChat: !0
  }));
  this.windowTitle.setText(e.title);
};
n.prototype.addContent = function (e) {
  var t = this.messageStack;
  if (t.length) {
    var i = t[t.length - 1];
    if (i.message === e.message && i.title === e.title) {
      return;
    }
  }
  t.push(e);
  1 === t.length && this._update();
};
o.on("tap", e);
this.closeButton.on("tap", e);
this.message || this._createContent();
this.message.clearContent();
this.message.setStyle("text-align", t);
this.message.setStyle("white-space", e.enablePreWrap ? "pre-wrap" : "");
this.message.appendChild(c.process(e.message, {
  isNonChat: !0
}));
this.windowTitle.setText(e.title);
t.push(e);
1 === t.length && this._update();
this.on("open", function (t) {
  var i = t.callback;
  delete t.callback;
  e.update(t, i);
});
t.on("RecaptchaRequestMessage", function (t) {
  function i(e) {
    window.dofus.send("recaptchaResponse", e);
  }
  var n = window.Config,
    o = n.recaptcha.proxyUrl,
    a = {
      origin: o,
      sitekey: t.enrichData.sitekey,
      src: o + r + "?v=" + Date.now(),
      lang: n.language || "en",
      callback: i
    };
  s.open(e.id, a);
});
delete t.callback;
e.update(t, i);
o(n, a);
e.exports = n;
n.prototype.update = function (e, t) {
  e.type = "recaptchaLoad";
  var i = this,
    n = this.recaptcha.rootElement;
  n.onload = function () {
    n.contentWindow.postMessage(e, e.origin);
  };
  window.addEventListener("message", function o(n) {
    if (n.origin === e.origin) {
      var a = n.data;
      return "recaptchaShow" === a.type ? i.recaptcha.show() : (window.removeEventListener("message", o), s.close("recaptcha"), t(a));
    }
  });
  n.src = e.src;
};
n.onload = function () {
  n.contentWindow.postMessage(e, e.origin);
};
window.addEventListener("message", function o(n) {
  if (n.origin === e.origin) {
    var a = n.data;
    return "recaptchaShow" === a.type ? i.recaptcha.show() : (window.removeEventListener("message", o), s.close("recaptcha"), t(a));
  }
});
n.src = e.src;
this._makePurchaseCb = null;
this._purchasingProduct = "";
this._keys = [];
p[1] = "UNKNOWN_ERROR";
p[2] = "ARGS_TYPE_MISMATCH";
p[3] = "ARGS_ARITY_MISMATCH";
p[4] = "IOS_VERSION_ERR";
p[5] = "INVALID_RECEIPT";
p[6] = "INVALID_TRANSACTION_STATE";
p[7] = "PURCHASE_NOT_FOUND";
p[8] = "PURCHASE_NOT_PENDING";
p[9] = "REMOTE_EXCEPTION";
p[10] = "BAD_RESPONSE";
p[11] = "BAD_SIGNATURE";
p[12] = "SEND_INTENT_FAILED";
p[13] = "USER_CANCELLED";
p[14] = "INVALID_PURCHASE";
p[15] = "MISSING_TOKEN";
p[16] = "NO_SUBSCRIPTIONS";
p[17] = "INVALID_CONSUMPTION";
p[18] = "CANNOT_PURCHASE";
p[19] = "UNKNOWN_PRODUCT_ID";
p[20] = "ALREADY_OWNED";
p[21] = "NOT_OWNED";
p[22] = "INVALID_CLIENT";
p[23] = "INVALID_PAYMENT";
p[24] = "UNAUTHORIZED";
p[25] = "RECEIPT_REFRESH_FAILED";
e.exports = a;
a.prototype._getWizPurchaseError = function (e) {
  return p[e] + " (code: " + e + ")" || e + " is not known error";
};
a.prototype._setStoreListeners = function () {
  var e = this,
    t = s();
  t.store.when("consumable").valid(function (i) {
    e._onStoreEvent(t.store.VALID, i);
  }).requested(function (i) {
    e._onStoreEvent(t.store.REQUESTED, i);
  }).initiated(function (i) {
    e._onStoreEvent(t.store.INITIATED, i);
  }).approved(function (i) {
    e._onStoreEvent(t.store.APPROVED, i);
  }).finished(function (i) {
    e._onStoreEvent(t.store.FINISHED, i);
  }).owned(function (i) {
    e._onStoreEvent(t.store.OWNED, i);
  }).downloading(function (i) {
    e._onStoreEvent(t.store.DOWNLOADING, i);
  }).downloaded(function (i) {
    e._onStoreEvent(t.store.DOWNLOADED, i);
  });
};
a.prototype._callbackStoreOrder = function (e, t) {
  return this._makePurchaseCb ? (e ? this._makePurchaseCb(o("order", e)) : this._makePurchaseCb(null, t), this._makePurchaseCb = null, void (this._purchasingProduct = "")) : void this._logger.error(o("order", 'callback called but no callbacks. Purchasing product: "' + this._purchasingProduct + '"'));
};
a.prototype._onStoreEvent = function (e, t) {
  var i = s();
  if (e === i.store.VALID && this._makePurchaseCb && this._purchasingProduct === t.id && this._callbackStoreOrder("CANCELLED"), e === i.store.APPROVED && this._makePurchaseCb && this._purchasingProduct === t.id) {
    var n = new l(this._logger, t);
    this._callbackStoreOrder(null, n.getWizPurchaseObject());
  }
};
a.prototype._storeRefresh = function (e) {
  function t(e) {
    setTimeout(function () {
      r && (e ? r(o("refresh", e)) : r(), r = null);
    }, d);
    r && (clearTimeout(n), n = null);
  }
  function i() {
    a += 1;
    var o = s();
    o.store.refresh().cancelled(function () {
      t("CANCELLED");
    }).failed(function () {
      t("FAILED");
    }).completed(function () {
      t();
    }).finished(function () {});
    n = setTimeout(function () {
      if (r) {
        return a >= h ? e(new Error("Max limit of refreshes reach.")) : void i();
      }
    }, u);
  }
  var n,
    a = 0,
    r = e;
  return this.isAvailable() ? void i() : e(new Error("not available."));
};
a.prototype._forcePurchaseCordova = function (e) {
  c = e;
};
a.prototype._setRefreshTimeout = function (e) {
  u = e;
};
a.prototype._setRefreshWaiting = function (e) {
  d = e;
};
a.prototype.isAvailable = function () {
  var e = s();
  return n() ? Boolean(e.store) : Boolean(e.wizPurchase);
};
a.prototype.setApplicationUsername = function (e, t) {
  if (!this.isAvailable()) {
    return t(new Error("not available."));
  }
  var i = s();
  if (n()) {
    return i.store.applicationUsername = e, t();
  }
  var o = this;
  i.wizPurchase.setApplicationUsername(e, function () {
    t();
  }, function (e) {
    t(new Error(o._getWizPurchaseError(e)));
  });
};
a.prototype.getProductDetails = function (e, t) {
  if (!this.isAvailable()) {
    return t(new Error("not available."));
  }
  if (!Array.isArray(e)) {
    return t(new Error("Need an array."));
  }
  var i = s();
  if (n()) {
    for (var o = new r(i.store, this._logger), a = 0; a < e.length; a += 1) {
      var l = e[a],
        c = i.store.get(l);
      o.addProduct(c);
    }
    return t(null, o.getProductsRequest());
  }
  var d = this;
  i.wizPurchase.getProductDetails(e, function (e) {
    t(null, e);
  }, function (e) {
    t(new Error(d._getWizPurchaseError(e)));
  });
};
a.prototype.register = function (e, t) {
  var i = this;
  if (!this.isAvailable()) {
    return t(new Error("not available."));
  }
  if (!Array.isArray(e)) {
    return t(new Error("Need an array."));
  }
  var a = s();
  if (!n()) {
    return t();
  }
  a.store.error(function (e) {
    i._logger.error(o("onError", e.code + ": " + e.message));
  });
  for (var r = 0; r < e.length; r += 1) {
    var l = e[r],
      c = a.store.get(l);
    c || (a.store.register({
      id: l,
      alias: l,
      type: a.store.CONSUMABLE
    }), this._keys.push(l));
  }
  this._storeRefresh(t);
};
a.prototype.finishPurchase = function (e, t) {
  if (!this.isAvailable()) {
    return t(new Error("not available."));
  }
  var i = s();
  if (n()) {
    var a = i.store.get(e);
    return a ? a.state !== i.store.APPROVED ? t(o("finishPurchase", "Cannot finish, " + e + " not APPROVED")) : (a.finish(), t()) : t(o("finishPurchase", "No product found for " + e));
  }
  var r = this;
  i.wizPurchase.finishPurchase(e, !0, function () {
    t();
  }, function (e) {
    t(new Error(r._getWizPurchaseError(e)));
  });
};
a.prototype.makePurchase = function (e, t) {
  if (!this.isAvailable()) {
    return t(new Error("not available."));
  }
  var i = this,
    o = s();
  return n() ? (this._purchasingProduct = e, this._makePurchaseCb = t, void o.store.order(e).then(function () {}).error(function (e) {
    i._callbackStoreOrder(e);
  })) : void o.wizPurchase.makePurchase(e, function (e) {
    t(null, e);
  }, function (e) {
    t(new Error(i._getWizPurchaseError(e)));
  });
};
a.prototype.restoreAllPurchases = function (e) {
  if (!this.isAvailable()) {
    return e(new Error("not available."));
  }
  var t = s();
  if (n()) {
    return e(null, []);
  }
  var i = this;
  t.wizPurchase.restoreAllPurchases(function (t) {
    return t = t || [], e(null, t);
  }, function (t) {
    e(new Error(i._getWizPurchaseError(t)));
  });
};
a.prototype.getPendingPurchases = function (e) {
  if (!this.isAvailable()) {
    return e(new Error("not available."));
  }
  var t = s();
  if (n()) {
    for (var i = [], o = 0; o < this._keys.length; o += 1) {
      var a = this._keys[o],
        r = t.store.get(a);
      if (r && r.state === t.store.APPROVED) {
        var c = new l(this._logger, r);
        i.push(c.getWizPurchaseObject());
      }
    }
    return e(null, i);
  }
  var d = this;
  t.wizPurchase.getPendingPurchases(function (t) {
    return t = t || [], e(null, t);
  }, function (t) {
    e(new Error(d._getWizPurchaseError(t)));
  });
};
a.prototype.refreshReceipt = function (e) {
  if (!this.isAvailable()) {
    return e(new Error("not available."));
  }
  var t = s();
  if (n()) {
    return this._storeRefresh(e);
  }
  var i = this;
  t.wizPurchase.refreshReceipt(function () {
    return e();
  }, function (t) {
    e(new Error(i._getWizPurchaseError(t)));
  });
};
a.prototype.isAlreadyOwnedError = function (e) {
  if (!this.isAvailable()) {
    return !1;
  }
  var t = s();
  return !n() && e === t.WizPurchaseError.ALREADY_OWNED;
};
setTimeout(function () {
  r && (e ? r(o("refresh", e)) : r(), r = null);
}, d);
r && (clearTimeout(n), n = null);
o.store.refresh().cancelled(function () {
  t("CANCELLED");
}).failed(function () {
  t("FAILED");
}).completed(function () {
  t();
}).finished(function () {});
n = setTimeout(function () {
  if (r) {
    return a >= h ? e(new Error("Max limit of refreshes reach.")) : void i();
  }
}, u);
this._store = e;
this.definition = {
  country: "",
  currency: "",
  products: {}
};
e.exports = i;
i.prototype.addProduct = function (e) {
  if (e) {
    if (e.state === this._store.REGISTERED || e.state === this._store.INVALID) {
      return void this._logger.error(new Error("Product id: " + e.id + " is " + e.state));
    }
    if (!e.priceMicros) {
      return void this._logger.error(new Error("Product id: " + e.id + " has no micro prices, state: " + e.state));
    }
    if (!e.price) {
      return void this._logger.error(new Error("Product id: " + e.id + " has no prices, state: " + e.state));
    }
    var t = {
      productId: e.id,
      description: e.description,
      priceMicros: e.priceMicros,
      price: e.price
    };
    this.definition.products[t.productId] = t;
    !this.definition.currency && e.currency && (this.definition.currency = e.currency);
    !this.definition.country && e.countryCode && (this.definition.country = e.countryCode);
    this.definition.currency && this.definition.currency !== e.currency && this._logger.error(new Error("Product id: " + e.id + " has a currency " + e.currency + " but we stored " + this.definition.currency));
  }
};
i.prototype.getProductsRequest = function () {
  return this.definition;
};
this.definition.products[t.productId] = t;
!this.definition.currency && e.currency && (this.definition.currency = e.currency);
!this.definition.country && e.countryCode && (this.definition.country = e.countryCode);
this.definition.currency && this.definition.currency !== e.currency && this._logger.error(new Error("Product id: " + e.id + " has a currency " + e.currency + " but we stored " + this.definition.currency));
t.transaction.type === n && (i = "android", a = t.transaction.purchaseToken);
t.transaction.type === o && (i = "ios", a = t.transaction.appStoreReceipt);
i || e.error(new Error("Unknown platform for " + t.transaction.type));
this._definition = {
  json: t.transaction.receipt,
  orderId: t.transaction.id,
  platform: i,
  productId: t.id,
  purchaseState: t.transaction.purchaseState,
  receipt: a,
  signature: t.transaction.signature
};
e.exports = i;
i.prototype.getWizPurchaseObject = function () {
  return this._definition;
};
window.addEventListener("touchstart", a, !1);
window.addEventListener("touchmove", o, !1);
n = !0;
window.removeEventListener("touchstart", a, !1);
window.removeEventListener("touchmove", o, !1);
n = !1;
document.documentElement.appendChild(c);
c.style.WebkitOverflowScrolling = "touch";
document.documentElement.removeChild(c);
d && s();
this.wholeSessionRoleplayFPS = new n();
this._lastTimeRoleplayFPS = 0;
this._lastSecondsRoleplayFPS = new n();
this.lastSecondsAverageRoleplayFPS = new n();
this.wholeSessionFightFPS = new n();
this._lastTimeFightFPS = 0;
this._lastSecondsFightFPS = new n();
this.lastSecondsAverageFightFPS = new n();
this._lastRequestMapChange = 0;
this.mapChangeLatency = new n();
this.mapLoadingLatency = new n();
this._setupListeners();
this._startSendingLoop();
n.prototype.setMin = function (e) {
  this.min = Math.min(e, this.min);
};
n.prototype.setMax = function (e) {
  this.max = Math.max(e, this.max);
};
n.prototype.addEntry = function (e) {
  this.setMin(e);
  this.setMax(e);
  this.entries += e;
  this.entriesNumber++;
};
n.prototype.resetEntries = function () {
  this.entries = 0;
  this.entriesNumber = 0;
};
n.prototype.resetValues = function () {
  this.min = Number.MAX_SAFE_INTEGER;
  this.max = 0;
  this.resetEntries();
};
n.prototype.getData = function () {
  return {
    min: this.min,
    max: this.max,
    average: this.entries / this.entriesNumber
  };
};
e.exports = o;
o.prototype._setupListeners = function () {
  var e = this;
  window.isoEngine.on("requestMapChange", function () {
    e._lastRequestMapChange = Date.now();
  });
  c.on("CurrentMapMessage", function () {
    e._lastRequestMapChange > 0 && e.mapChangeLatency.addEntry(Date.now() - e._lastRequestMapChange);
  });
  c.on("MapComplementaryInformationsDataMessage", function () {
    e._lastRequestMapChange > 0 && e.mapLoadingLatency.addEntry(Date.now() - e._lastRequestMapChange);
    e._lastRequestMapChange = 0;
  });
};
o.prototype._startSendingLoop = function () {
  function e() {
    t.sendLogs();
    setTimeout(function () {
      e();
    }, h);
  }
  var t = this;
  setTimeout(function () {
    e();
  }, u);
};
o.prototype.sendLogs = function () {};
o.prototype.getGPUInformation = function () {
  return a.getGPUInformation();
};
o.prototype.getLocalStorageSize = function () {
  var e = 0;
  for (var t in window.localStorage) {
    window.localStorage.hasOwnProperty(t) && (e += 2 * (localStorage[t].length + t.length));
  }
  return e / 1024;
};
o.prototype.getMemoryInformation = function () {
  var e = {
    capacity: s.capacity,
    audio: r.getMemoryInformation()
  };
  window.performance && window.performance.memory && (e.jsHeap = window.performance.memory);
  window.isoEngine.mapScene && window.isoEngine.mapScene.renderer && window.isoEngine.mapScene.renderer.textureCache && (e.game = window.isoEngine.mapScene.renderer.textureCache.getMemoryInformation());
  var t = l.getWindow("worldMap");
  return t && t.getWorldMap() && t.getWorldMap().getScene() && t.getWorldMap().getScene().renderer && t.getWorldMap().getScene().renderer.textureCache && (e.worldMap = t.getWorldMap().getScene().renderer.textureCache.getMemoryInformation()), e;
};
o.prototype.logFPS = function (e) {
  window.gui.fightManager && window.gui.fightManager.isInFight() ? (this.wholeSessionFightFPS.resetEntries(), this.wholeSessionFightFPS.addEntry(e), 0 === this._lastTimeFightFPS && (this._lastTimeFightFPS = Date.now()), Date.now() - this._lastTimeFightFPS >= d && (this._lastTimeFightFPS = Date.now(), this.lastSecondsAverageFightFPS.resetEntries(), this.lastSecondsAverageFightFPS.addEntry(Math.round(this._lastSecondsFightFPS.getData().average)), this._lastSecondsFightFPS.resetValues()), this._lastSecondsFightFPS.addEntry(e)) : (this.wholeSessionRoleplayFPS.resetEntries(), this.wholeSessionRoleplayFPS.addEntry(e), 0 === this._lastTimeRoleplayFPS && (this._lastTimeRoleplayFPS = Date.now()), Date.now() - this._lastTimeRoleplayFPS >= d && (this._lastTimeRoleplayFPS = Date.now(), this.lastSecondsAverageRoleplayFPS.resetEntries(), this.lastSecondsAverageRoleplayFPS.addEntry(Math.round(this._lastSecondsRoleplayFPS.getData().average)), this._lastSecondsRoleplayFPS.resetValues()), this._lastSecondsRoleplayFPS.addEntry(e));
  window.gui.performanceOverlay && window.gui.performanceOverlay.isVisible() && window.gui.performanceOverlay.refresh(e, this.getMemoryInformation().game);
};
this.setMin(e);
this.setMax(e);
this.entries += e;
this.entriesNumber++;
this.entries = 0;
this.entriesNumber = 0;
this.min = Number.MAX_SAFE_INTEGER;
this.max = 0;
this.resetEntries();
window.isoEngine.on("requestMapChange", function () {
  e._lastRequestMapChange = Date.now();
});
c.on("CurrentMapMessage", function () {
  e._lastRequestMapChange > 0 && e.mapChangeLatency.addEntry(Date.now() - e._lastRequestMapChange);
});
c.on("MapComplementaryInformationsDataMessage", function () {
  e._lastRequestMapChange > 0 && e.mapLoadingLatency.addEntry(Date.now() - e._lastRequestMapChange);
  e._lastRequestMapChange = 0;
});
e._lastRequestMapChange > 0 && e.mapLoadingLatency.addEntry(Date.now() - e._lastRequestMapChange);
e._lastRequestMapChange = 0;
t.sendLogs();
setTimeout(function () {
  e();
}, h);
window.performance && window.performance.memory && (e.jsHeap = window.performance.memory);
window.isoEngine.mapScene && window.isoEngine.mapScene.renderer && window.isoEngine.mapScene.renderer.textureCache && (e.game = window.isoEngine.mapScene.renderer.textureCache.getMemoryInformation());
window.gui.fightManager && window.gui.fightManager.isInFight() ? (this.wholeSessionFightFPS.resetEntries(), this.wholeSessionFightFPS.addEntry(e), 0 === this._lastTimeFightFPS && (this._lastTimeFightFPS = Date.now()), Date.now() - this._lastTimeFightFPS >= d && (this._lastTimeFightFPS = Date.now(), this.lastSecondsAverageFightFPS.resetEntries(), this.lastSecondsAverageFightFPS.addEntry(Math.round(this._lastSecondsFightFPS.getData().average)), this._lastSecondsFightFPS.resetValues()), this._lastSecondsFightFPS.addEntry(e)) : (this.wholeSessionRoleplayFPS.resetEntries(), this.wholeSessionRoleplayFPS.addEntry(e), 0 === this._lastTimeRoleplayFPS && (this._lastTimeRoleplayFPS = Date.now()), Date.now() - this._lastTimeRoleplayFPS >= d && (this._lastTimeRoleplayFPS = Date.now(), this.lastSecondsAverageRoleplayFPS.resetEntries(), this.lastSecondsAverageRoleplayFPS.addEntry(Math.round(this._lastSecondsRoleplayFPS.getData().average)), this._lastSecondsRoleplayFPS.resetValues()), this._lastSecondsRoleplayFPS.addEntry(e));
window.gui.performanceOverlay && window.gui.performanceOverlay.isVisible() && window.gui.performanceOverlay.refresh(e, this.getMemoryInformation().game);
i(1417);
i(1475);
i(1478);
i(1484);
i(1486);
i(1487);
i(1488);
i(1489);
e.exports = i(1418);
n.prototype.onArrived = function (e) {
  if (window.dofus.sendMessage("GameMapMovementConfirmMessage", null), this.emit("movementConfirm", e), this.mapRenderer.removeMovementFeedback(), this.endMovementCallback) {
    var t = this.endMovementCallback;
    this.endMovementCallback = null;
    t(null, e);
  }
};
n.prototype.cancelUserActorMovement = function (e) {
  if (this.isMovementWaitingForConfirmation) {
    return this.lastMoveRequestTime && !s.isDialogActive() && Date.now() - this.lastMoveRequestTime > u && window.gui.connectionSplashScreen.onStateChange("UNSTABLE"), this.endMovementCallback = e, void (this.isMovementCanceled = !0);
  }
  this.isMovementCanceled = !1;
  var t = this.actorManager.userActor;
  return t.moving ? (this.mapRenderer.removeMovementFeedback(), this.endMovementCallback = null, void t.cancelMovement(e)) : (this.endMovementCallback = e, this.onArrived());
};
n.prototype.cancelMoveAndDo = function (e) {
  return this.actorManager.userActor.moving || this.isMovementWaitingForConfirmation ? this.cancelUserActorMovement(e) : e();
};
n.prototype.roleplayUserActorMovement = function (e) {
  var t = this,
    i = e[e.length - 1],
    n = this.actorManager.userActor;
  if (this.isMovementWaitingForConfirmation = !1, window.gui.connectionSplashScreen.onStateChange("CONNECTED"), window.gui.emit("checkServerLag", "roleplayUserActorMovement", "stop"), this.isMovementCanceled) {
    return this.cancelUserActorMovement(this.endMovementCallback);
  }
  if (!n.moving) {
    for (var o = null, a = 0; a < e.length; a++) {
      if (e[a] === n.cellId) {
        o = a;
        break;
      }
    }
    if (null === o) {
      return n.cellId !== i && n.setDisposition(i), this.onArrived(i);
    }
    if (n.cellId === i) {
      return n.setDisposition(i), this.onArrived(i);
    }
    var s = e.slice(o);
    n.setPath(s, {
      cb: function () {
        t.emit("arrived", i);
      }
    });
    n.setCellPosition(s[s.length - 1]);
  }
  this.removeAllListeners("arrived");
  this.once("arrived", this.onArrived);
  var r = [];
  return n.isPathMatchingServerPath(e, r) ? void 0 : 0 !== r.length ? (this.endMovementCallback = null, n.switchPath(r, function () {
    t.emit("arrived", i);
  })) : (n.noMovement(), n.setDisposition(i), this.endMovementCallback = null, this.onArrived(i));
};
n.prototype._movePlayerOnMap = function (e, t, i) {
  if (i && "function" == typeof i || (i = function () {}), window.gui.playerData.inventory.isOverloaded() && !window.gui.playerData.isMutant()) {
    return void window.gui.chat.logMsg(r("tablet.inventoryFullCannotMove"));
  }
  t = t || !1;
  var n = this.actorManager.userActor,
    s = n.cellId;
  if (s === e) {
    return i(null, e), e;
  }
  for (var l = 0; l < h.length; l++) {
    if (n.look.bonesId === h[l]) {
      return null;
    }
  }
  var c = this.mapRenderer.map,
    d = n.canMoveDiagonally,
    u = this.actorManager.getOccupiedCells(),
    p = o.getPath(s, e, u, d, t);
  if (p.length <= 1) {
    return i(new Error("_movePlayerOnMap noPath:" + s + ":" + e)), null;
  }
  this.isMovementWaitingForConfirmation = !0;
  this.lastMoveRequestTime = Date.now();
  window.gui.emit("checkServerLag", "roleplayUserActorMovement", "start");
  window.dofus.sendMessage("GameMapMovementRequestMessage", {
    keyMovements: a(p),
    mapId: c.id
  });
  var m = p[p.length - 1],
    f = this;
  this.mapRenderer.addMovementFeedback(m);
  this.endMovementCallback = i;
  n.setPath(p, {
    cb: function () {
      c.id !== f.mapRenderer.map.id || f.isMapChanging || f.emit("arrived", m);
    }
  });
  var g = this.mapScene.camera;
  return g.setAcceleration(1), n.pathTween.removeOnUpdate(), n.onMovementUpdate = function () {
    g.moveTo(n.x, n.y);
  }, n.pathTween.onUpdate(n.onMovementUpdate), this.userPreviousPosition = n.cellId, n.setCellPosition(m), m;
};
n.prototype.cancelCameraMovement = function () {
  var e = this.actorManager.userActor;
  e.pathTween.removeOnUpdate(e.onMovementUpdate);
};
n.prototype.noMovement = function () {
  c.isFightMode || (console.warn("[ISO ENGINE] previous movement request has been refused, canceling movement"), this.onQuickReconnection());
};
n.prototype.getChangeMapCellAt = function (e, t, i) {
  var n = this.mapScene.convertCanvasToSceneCoordinate(e, t);
  if (!this.mapRenderer.isReady) {
    return -1;
  }
  var o = this.mapRenderer.getCellId(n.x, n.y);
  return this.mapRenderer.getChangeMapFlags(o.cell)[i] ? o.cell : -1;
};
n.prototype._requestMapChange = function (e, t) {
  window.foreground.lock("loadMap");
  window.dofus.sendMessage("ChangeMapMessage", {
    mapId: e
  });
  this.emit("requestMapChange");
  this.launchMapTransition(t);
  var i = this;
  this.changeMapTimeout = window.setTimeout(function () {
    l.unlockMessages();
    i.changeMapTimeout = null;
    var e = window.foreground;
    e.unlock("loadMap");
    e.hideBorderArrow();
    i.cancelMapTransition(t);
  }, d);
};
n.prototype.gotoNeighbourMap = function (e, t, i, n) {
  function o(i, n) {
    i || n !== t || a._requestMapChange(a.mapRenderer.map[e + "NeighbourId"], e);
  }
  var a = this;
  if (this.actorManager.userActor.moving) {
    return this.cancelUserActorMovement(function () {
      a.gotoNeighbourMap(e, t, i, n);
    });
  }
  var s = this._movePlayerOnMap(t, !1, o);
  s === t && window.foreground.showBorderArrow(e, i, n);
};
n.prototype.clearPendingMovement = function () {
  this.isMovementWaitingForConfirmation = !1;
  this.endMovementCallback = null;
  this.isMovementCanceled = !1;
};
this.endMovementCallback = null;
t(null, e);
n.setPath(s, {
  cb: function () {
    t.emit("arrived", i);
  }
});
n.setCellPosition(s[s.length - 1]);
this.removeAllListeners("arrived");
this.once("arrived", this.onArrived);
this.isMovementWaitingForConfirmation = !0;
this.lastMoveRequestTime = Date.now();
window.gui.emit("checkServerLag", "roleplayUserActorMovement", "start");
window.dofus.sendMessage("GameMapMovementRequestMessage", {
  keyMovements: a(p),
  mapId: c.id
});
this.mapRenderer.addMovementFeedback(m);
this.endMovementCallback = i;
n.setPath(p, {
  cb: function () {
    c.id !== f.mapRenderer.map.id || f.isMapChanging || f.emit("arrived", m);
  }
});
window.foreground.lock("loadMap");
window.dofus.sendMessage("ChangeMapMessage", {
  mapId: e
});
this.emit("requestMapChange");
this.launchMapTransition(t);
l.unlockMessages();
i.changeMapTimeout = null;
e.unlock("loadMap");
e.hideBorderArrow();
i.cancelMapTransition(t);
this.isMovementWaitingForConfirmation = !1;
this.endMovementCallback = null;
this.isMovementCanceled = !1;
t.appendChild(e);
this.mapScene = new l({
  canvas: e,
  name: "mapScene",
  l: -s.HORIZONTAL_OFFSET,
  t: -s.VERTICAL_OFFSET,
  w: s.MAP_SCENE_WIDTH,
  h: s.MAP_SCENE_HEIGHT,
  canvasWidth: 0,
  canvasHeight: 0,
  maxZoom: s.MAX_ZOOM_MAP,
  pixelRatio: s.PIXEL_RATIO,
  textureRatio: s.PRERENDER_RATIO_MAP,
  cameraAcceleration: 1.15,
  nbCacheableSprites: s.MAX_SPRITES_BUFFER_MAP,
  textureMemoryCacheSize: s.MAX_TEXTURE_MEMORY_MAP,
  prerenderQualityRatio: s.PRERENDER_RATIO_MAP,
  adjustToCanvasRatio: !0,
  usePrecisionRendering: !0
});
this.renderer = this.mapScene.renderer;
this.background = new d(i);
this.actorManager = new u({
  isoEngine: this,
  scene: this.mapScene
});
this.mapRenderer = new c(this.mapScene, this.background);
this.highlightedElements = {};
this.isInGame = !1;
this.isMovementWaitingForConfirmation = !1;
this.endMovementCallback = null;
this.isMovementCanceled = !1;
this.unblockedCells = null;
this.unblockedNpcId = -1;
this.isMapChanging = !1;
this.interactiveMessageStack = [];
this.actionQueue = new g();
this.lastContextualMenuSkillId = null;
r.start();
this.mapScene.camera.setZoom(0);
this._initGridOverlayLayers();
this._previousTurn = !1;
this._isUserTurn = !1;
window.gui.on("CurrentMapMessage", function () {
  n.isMapChanging = !0;
  n.interactiveMessageStack = [];
});
this.on("mapLoaded", function () {
  n.isMapChanging = !1;
});
this.on("actorLoaded", function () {
  n.pendingInteractiveUseStart();
});
this.on("GameFightStartMessage", function () {
  n._resetFightPositionLayer();
});
this.on("GameFightEndMessage", function () {
  n._resetFightPositionLayer();
  n._resetSpellRangeLayer();
  n._resetSpellEffectLayer();
  n._resetWalkLayer();
  n._resetWalkAreaLayer();
  n._resetEnemyWalkAreaLayer();
  o.removeTargetHighlights();
  window.foreground.confirmBox.close();
  this._isUserTurn = !1;
});
v.on("gameContextChanged", this.onGameContextChanged.bind(this));
this._initLoadingProgress();
this.bitmapFonts = null;
this._currentBannerTweens = {
  backTween: null,
  textTween: null
};
n.isMapChanging = !0;
n.interactiveMessageStack = [];
n._resetFightPositionLayer();
n._resetSpellRangeLayer();
n._resetSpellEffectLayer();
n._resetWalkLayer();
n._resetWalkAreaLayer();
n._resetEnemyWalkAreaLayer();
o.removeTargetHighlights();
window.foreground.confirmBox.close();
this._isUserTurn = !1;
o(n, a);
e.exports = n;
n.prototype._loadBitmapFonts = function () {
  if (null === this.bitmapFonts) {
    var e = this;
    f.loadModel("bitmapFonts", "atlas", function (t, i) {
      var n = e.mapScene.createTexture(i, "atlas", "mimap", "permanent");
      e.bitmapFonts = {
        characters: {
          dimensions: t.characters,
          texture: n
        },
        numbers: {
          dimensions: t.numbers,
          texture: n
        }
      };
    });
  }
};
n.prototype.initialize = function () {
  h.initialize(this);
  this.mapRenderer.initialize();
  this.actionQueue.initialize();
  p.loadMissingTemplatesInfo();
  this._loadBitmapFonts();
};
n.prototype._activateMapScene = function () {
  return this.isInGame === !1 && (r.addScene(this.mapScene), r.addScene(this.actorManager), this.isInGame = !0, !0);
};
n.prototype._deactivateMapScene = function () {
  return this.isInGame === !0 && (this.mapScene.clear(0, 0, 0, 0), r.removeScene(this.mapScene), r.removeScene(this.actorManager), this.clearUserMovementZone(), this.background.resetAndClear(), this.releaseMap(), this.interactiveDisconnect(), this.isInGame = !1, !0);
};
n.prototype.disconnect = function () {
  _.unlockMessages();
  this.emit("disconnect");
  this._deactivateMapScene();
  this.mapTransitionDisconnect();
  this.background && this.background.gridAnimator && this.background.gridAnimator.clear();
  this.clearPendingMovement();
  this.actionQueue.clear();
  this.actorManager.turnNicknamesOff();
  this.interactiveMessageStack = [];
};
n.prototype.transmitMessage = function (e) {
  this.emit(e._messageType, e);
};
n.prototype.releaseMap = function (e) {
  this.isInGame !== !1 && (v.isRoleplayMode && this.actorManager.removeAllActors(), this.cleanupChallenges(), this.background.releaseMap(), this.mapRenderer.releaseMap(e), this.actionQueue.clear());
};
n.prototype.onGameContextChanged = function () {
  this.clearHighlights();
  this.clearPendingMovement();
  this.actionQueue.clear();
  this.interactiveMessageStack = [];
  v.isFightMode ? (this.cleanupChallenges(), r.removeScene(this.actorManager)) : (r.addScene(this.actorManager), this.actorManager.userActor.show(), this.clearUserMovementZone(), this.background.deleteAllZones());
};
n.prototype.setInteractiveBlink = function (e) {
  this.interactiveBlink = e;
};
n.prototype._updateMapInfoData = function (e, t) {
  this.mapRenderer.setStatedElements(e.statedElements);
  this.addChallenges(e.fights);
  this.mapRenderer.setInteractiveElements(e.interactiveElements);
  this.mapRenderer.updateObstacles(e.obstacles);
  t && t.noMovementWaitReset || (this.isMovementWaitingForConfirmation = !1);
};
n.prototype.onQuickReconnection = function (e) {
  if (!window.gui.isConnected) {
    return e && e();
  }
  if (window.gui.playerData && window.gui.playerData.isFighting) {
    return e && e();
  }
  if (this.endMovementCallback = null, this.isMovementCanceled = !1, this.isMovementWaitingForConfirmation = !1, this.mapRenderer.removeMovementFeedback(), this.actionQueue.clear(), this.isMapChanging = !0, this.interactiveMessageStack = [], m.isDialogActive()) {
    return e && e();
  }
  window.foreground.lock("quickReconnection");
  this.lastMoveRequestTime = null;
  this.actorManager.pause();
  window.dofus.sendMessage("MapInformationsRequestMessage", {
    mapId: this.mapRenderer.mapId
  });
  var t = this;
  this.once("mapLoaded", function () {
    if (window.foreground.unlock("quickReconnection"), t.userPreviousPosition) {
      var i = t.userPreviousPosition;
      window.dofus.sendMessage("GameMapMovementCancelMessage", {
        cellId: i
      });
      var n = t.actorManager.userActor;
      n.noMovement();
      n.setDisposition(i, n.direction);
    }
    return t.actorManager.unpause(), e && e();
  });
};
n.prototype.attackActor = function (e) {
  var t = window.gui.fightManager.isInFight();
  if (!t) {
    var i = this.actorManager.actors,
      n = i[e];
    if (n) {
      var o = n.cellId,
        a = this.actorManager.userActor,
        s = function () {
          window.dofus.sendMessage("GameRolePlayAttackMonsterRequestMessage", {
            monsterGroupId: e
          });
        };
      return a.cellId === o ? s() : void this._movePlayerOnMap(o, !1, s);
    }
  }
};
n.prototype.updateDimensions = function (e) {
  this.mapScene.setCanvasDimensions(e.mapWidth, e.mapHeight, e.mapLeft, e.mapTop, "absolute") && this.mapScene.camera.setZoom(0);
  this.isInGame && this.mapScene.requireCompleteRefresh();
};
n.prototype.useItem = function (e, t, i) {
  var n = this.mapScene.convertCanvasToSceneCoordinate(e, t),
    o = this.mapRenderer.getCellId(n.x, n.y).cell,
    a = this.actorManager.getActorsOnCell(o);
  a.length && a[0].actorId >= 0 ? window.dofus.sendMessage("ObjectUseOnCharacterMessage", {
    characterId: a[0].actorId,
    objectUID: i
  }) : window.dofus.sendMessage("ObjectUseOnCellMessage", {
    cells: o,
    objectUID: i
  });
};
n.prototype.sendToFightSequence = function (e) {
  this.emit(e._messageType, e);
};
n.prototype.transformAndSendToFightSequence = function (e) {
  var t = window.gui,
    i = t.fightManager.fightState;
  if (i === y.BATTLE) {
    var n = {
      _messageType: "messageSequence",
      isFakeSequence: !0,
      sequence: [{
        _messageType: "SequenceStartMessage"
      }, e, {
        _messageType: "SequenceEndMessage"
      }]
    };
    this.emit("messageSequence", n);
  } else {
    t.transmitFightSequenceMessage(e);
  }
};
h.initialize(this);
this.mapRenderer.initialize();
this.actionQueue.initialize();
p.loadMissingTemplatesInfo();
this._loadBitmapFonts();
_.unlockMessages();
this.emit("disconnect");
this._deactivateMapScene();
this.mapTransitionDisconnect();
this.background && this.background.gridAnimator && this.background.gridAnimator.clear();
this.clearPendingMovement();
this.actionQueue.clear();
this.actorManager.turnNicknamesOff();
this.interactiveMessageStack = [];
this.clearHighlights();
this.clearPendingMovement();
this.actionQueue.clear();
this.interactiveMessageStack = [];
v.isFightMode ? (this.cleanupChallenges(), r.removeScene(this.actorManager)) : (r.addScene(this.actorManager), this.actorManager.userActor.show(), this.clearUserMovementZone(), this.background.deleteAllZones());
this.mapRenderer.setStatedElements(e.statedElements);
this.addChallenges(e.fights);
this.mapRenderer.setInteractiveElements(e.interactiveElements);
this.mapRenderer.updateObstacles(e.obstacles);
t && t.noMovementWaitReset || (this.isMovementWaitingForConfirmation = !1);
window.foreground.lock("quickReconnection");
this.lastMoveRequestTime = null;
this.actorManager.pause();
window.dofus.sendMessage("MapInformationsRequestMessage", {
  mapId: this.mapRenderer.mapId
});
n.noMovement();
n.setDisposition(i, n.direction);
this.mapScene.setCanvasDimensions(e.mapWidth, e.mapHeight, e.mapLeft, e.mapTop, "absolute") && this.mapScene.camera.setZoom(0);
this.isInGame && this.mapScene.requireCompleteRefresh();
this.mapId = null;
this.map = null;
this.mapScene = e;
this.background = t;
this.grid = new o();
this._pingHighlight = {};
w.on("gameContextChanged", this.onGameContextChanged.bind(this));
this.graphics = [];
this.statedElements = [];
this.interactiveElements = {};
this.identifiedElements = {};
this.objects = {};
this.animatedElements = [];
this.paddockProperties = null;
this.cellHintManager = new g();
this.isReady = !1;
y.on("PaddockPropertiesMessage", function (e) {
  i.paddockProperties = e.properties;
});
s(n, a);
e.exports = n;
n.prototype.initialize = function () {
  f.initialize();
  this.cellHintManager.initialize();
};
n.prototype.setMap = function (e, t) {
  var i = e.mapData;
  this.map = i;
  this.mapId = i.id;
  this.grid.initialize(i.cells, w.isRoleplayMode);
  this.loadMap(e, t);
};
n.prototype.releaseMap = function (e) {
  e !== this.mapId && (this.mapScene.clean(), this.isReady = !1, this.graphics = [], this.statedElements = [], this.interactiveElements = {}, this.identifiedElements = {}, this.objects = {}, this.animatedElements = [], this.paddockProperties = null, this.mapId = null, this.map = null);
};
n.prototype.stopAnimatedElements = function () {
  for (var e = this.animatedElements, t = 0; t < e.length; t++) {
    e[t].stop();
  }
};
n.prototype.startAnimatedElements = function () {
  for (var e = this.animatedElements, t = 0; t < e.length; t++) {
    e[t].animate();
  }
};
n.prototype.loadMap = function (e, t) {
  for (var i = e.mapData, n = e.msg, o = {}, a = n.statedElements, s = 0; s < a.length; s++) {
    o[a[s].elementId] = !0;
  }
  this.graphics = [];
  this.statedElements = [];
  this.animatedElements = [];
  var r = new b(this, t);
  r.nAssetsToLoad += 1;
  var c = new h({
    id: "mapSceneStaticSprites" + this.mapId,
    scene: this.mapScene,
    holdsStatics: !0
  });
  this.graphics.push(c);
  var p = i.atlasLayout,
    m = p.graphicsPositions;
  r.loadAtlas(p, c);
  for (var f, g = i.midgroundLayer, _ = Object.keys(g), v = 0; v < _.length; v++) {
    for (var y = _[v], C = g[y], I = 0; I < C.length; I++) {
      var A = C[I];
      A.position = parseInt(y, 10);
      A.layer = l.MAP_LAYER_PLAYGROUND;
      A.scene = this.mapScene;
      var S = A.hue;
      if (S[0] = 1 + S[0] / 127, S[1] = 1 + S[1] / 127, S[2] = 1 + S[2] / 127, S[3] = 1, A.look) {
        if (A.id && o[A.id]) {
          f = r.loadStatedElement(A);
          this.statedElements.push(f);
        } else {
          if (!A.anim) {
            console.warn("[MapRenderer.loadMap] Animated Graphic skipped", A);
            continue;
          }
          f = r.loadAnimatedGraphic(A);
          this.animatedElements.push(f);
          this.graphics.push(f);
        }
      } else {
        if (!A.g) {
          console.warn("[MapRenderer.loadMap] Element of unidentified type skipped", A);
          continue;
        }
        f = c.addSprite(A, m[A.g]);
      }
      f.id && (this.identifiedElements[f.id] = f);
    }
  }
  c.finalize(p.width, p.height);
  var x = this,
    L = E + i.id + ".jpg";
  if (r.nAssetsToLoad += 1, d.loadTexture(L, function (e) {
    x.background.updateMap(e);
    r.notifyAssetAsLoaded();
  }, this.mapScene.renderer, "linear"), i.foreground) {
    var O = new u({
      x: -l.HORIZONTAL_OFFSET,
      y: -l.VERTICAL_OFFSET,
      w: l.MAP_SCENE_WIDTH,
      h: l.MAP_SCENE_HEIGHT,
      scene: this.mapScene,
      layer: l.MAP_LAYER_FOREGROUND
    });
    this.graphics.push(O);
    var R = N + i.id + ".png";
    r.nAssetsToLoad += 1;
    d.loadTexture(R, function (e) {
      if ("empty_texture" === e.id) {
        O.remove();
        var t = x.graphics.indexOf(O);
        t !== -1 && x.graphics.splice(t, 1);
      } else {
        O.texture = e;
        O.forceRefresh();
      }
      r.notifyAssetAsLoaded();
    }, this.mapScene.renderer, "linear");
  }
  r.notifyAssetAsLoaded();
  var D = T.getValue("tacticModeEngaged", !1);
  D && w.isFightMode && M.turnOn();
};
n.prototype.onGameContextChanged = function () {
  this.removeMovementFeedback();
  w.isFightMode ? this.switchGameContextFight() : this.switchGameContextRoleplay();
};
n.prototype.switchGameContextFight = function () {
  this.stopAnimatedElements();
  for (var e = 0; e < this.statedElements.length; e++) {
    var t = this.statedElements[e];
    t.changeState(1, !0);
  }
  for (var i in this.objects) {
    this.objects[i].remove();
  }
  this.objects = {};
  this.map && this.grid.initialize(this.map.cells, !1);
};
n.prototype.switchGameContextRoleplay = function () {
  this.startAnimatedElements();
  this.map && this.grid.initialize(this.map.cells, !0);
};
n.prototype.addObjects = function (e) {
  if (!this.isReady) {
    var t = this,
      i = this.mapId;
    return this.once("ready", function () {
      t.mapId === i && t.addObjects(e);
    });
  }
  for (var n = 0; n < e.length; n++) {
    var o = e[n];
    if (o.img) {
      var a = this.getCellSceneCoordinate(o.cellId);
      o.x = a.x - D / 2;
      o.y = a.y - D / 2 + B;
      o.position = o.cellId;
      o.w = D;
      o.h = D;
      o.scene = this.mapScene;
      var s = this.mapScene.createTexture(o.img, "object:" + o.objectGID),
        r = new u(o, s);
      this.objects[o.cellId] = r;
    } else {
      console.error("createObjectGfx: no img for " + JSON.stringify(o));
    }
  }
};
n.prototype.removeObjects = function (e) {
  for (var t = 0; t < e.length; t++) {
    var i = e[t],
      n = this.objects[i];
    n && (n.remove(), delete this.objects[i]);
  }
};
n.prototype.setInteractiveElements = function (e) {
  function t(e) {
    return e.element === i.elementId;
  }
  this.interactiveElements = {};
  this.calligraphyElements = {};
  for (var i = {}, n = C[this.mapId] ? C[this.mapId] : [], o = 0, a = e.length; o < a; o++) {
    i = e[o];
    n.some(t) ? this.calligraphyElements[i.elementId] = i : this.interactiveElements[i.elementId] = i;
  }
};
n.prototype.updateInteractiveElements = function (e) {
  function t(e) {
    return e.element === n.elementId;
  }
  for (var i = this.interactiveElements, n = {}, o = C[this.mapId] ? C[this.mapId] : [], a = 0; a < e.length; a++) {
    if (n = e[a], o.some(t)) {
      this.calligraphyElements[n.elementId] = n;
    } else {
      var s = i[n.elementId];
      s ? (s.disabledSkills = n.disabledSkills, s.enabledSkills = n.enabledSkills) : console.warn("Interactive element id " + n.elementId + " does not exist.");
    }
  }
};
n.prototype.setStatedElements = function (e) {
  for (var t = 0, i = e.length; t < i; t++) {
    var n = e[t],
      o = this.identifiedElements[n.elementId];
    o ? o instanceof c && (w.isFightMode ? (o.state = -1, o.changeState(1)) : o.changeState ? o.changeState(n.elementState) : o.state = n.elementState) : console.warn("stated element not identified:" + n.elementId + ", cellId=" + n.elementCellId);
  }
};
n.prototype.updateStatedElements = function (e) {
  for (var t = this.identifiedElements, i = 0, n = e.length; i < n; i++) {
    var o = e[i],
      a = t[o.elementId];
    a ? a.changeState ? a.changeState(o.elementState) : (console.warn("Identified element " + o.elementId + " is not a stated element."), a.state = o.elementState) : console.warn("Identified element " + o.elementId + " not found.");
  }
};
n.prototype.getPaddockProperties = function () {
  return this.paddockProperties;
};
n.prototype.isPaddock = function (e) {
  var t = e.id;
  if (!t) {
    return !1;
  }
  var i = this.interactiveElements[t];
  return !!i && i.elementTypeId === l.ELEMENT_TYPE_ID.PADDOCK;
};
n.prototype.addArrowsOnCellsOneShot = function (e, t, i, n) {
  for (var o = [], a = 0; a < e.length; a++) {
    o[a] = this.getCellSceneCoordinate(e[a]);
    o[a].x += t || 0;
    o[a].y += i || 0;
  }
  p.addArrowsOneShot(o, e, n, this.mapScene);
};
n.prototype.addTapFeedback = function (e, t) {
  f.addTapFeedback({
    x: e,
    y: t
  });
};
n.prototype.addMovementFeedback = function (e) {
  var t = this.getCellSceneCoordinate(e);
  f.addMovementFeedback({
    x: t.x,
    y: t.y,
    position: e
  });
};
n.prototype.removeTapFeedback = function () {
  f.removeTapFeedback();
};
n.prototype.removeMovementFeedback = function () {
  f.removeMovementFeedback();
};
n.prototype.addArrowOnCell = function (e, t, i, n, o) {
  var a = this.getCellSceneCoordinate(e);
  a.x += t || 0;
  a.y += i || 0;
  p.addArrow(a, e, n, this.mapScene, o);
};
n.prototype.addArrowOnGraphic = function (e, t, i, n, o) {
  if (!e || !e.bbox) {
    return console.warn("addArrowOnGraphic: invalid graphic entity");
  }
  var a = {
    x: (e.bbox[0] + e.bbox[1]) / 2 + (t || 0),
    y: (e.bbox[2] + e.bbox[3]) / 2 + (i || 0)
  };
  p.addArrow(a, null, n, this.mapScene, o);
};
n.prototype.addArrowsSequence = function (e, t, i, n) {
  for (var o = [], a = 0; a < e.length; a++) {
    o[a] = this.getCellSceneCoordinate(e[a]);
    o[a].x += t || 0;
    o[a].y += i || 0;
  }
  p.addArrowsSequence(o, e, n, this.mapScene);
};
n.prototype.removeArrows = function () {
  p.removeArrows();
};
n.prototype.addPingPictoOnCell = function (e, t, i) {
  var n = this.getCellSceneCoordinate(e);
  m.addPingPicto(e, n, e, t, i);
};
n.prototype.removePingPicto = function (e) {
  m.removePingPicto(e);
};
n.prototype.removeAllPingPictos = function () {
  m.removeAllPingPictos();
};
n.prototype.addCellHighlight = function (e, t, i, n) {
  i = i || x;
  n = n || L;
  for (var o = 0, a = t.length; o < a; o += 1) {
    var s = t[o],
      r = "rgba(" + i.r + "," + i.g + "," + i.b + "," + i.a + ")",
      l = "rgba(" + n.r + "," + n.g + "," + n.b + "," + n.a + ")";
    window.background.addZone(new v([s], {
      color: r,
      outline: l
    }), e);
  }
};
n.prototype.addPingHighlight = function (e, t, i) {
  function n(n) {
    o._pingHighlight[e] ? (o._pingHighlight[e].texture = n, o._pingHighlight[e].forceRefresh()) : n.release();
    i && a.openPingBox(e, t);
  }
  if (e) {
    t = t || 1;
    var o = this,
      a = window.gui.pingSystem;
    this._pingHighlight[e] && this.deletePingHighlight(e);
    var s = window.isoEngine.mapRenderer.getCellSceneCoordinate(e);
    this._pingHighlight[e] = new u({
      layer: l.MAP_LAYER_BACKGROUND,
      x: s.x - l.CELL_WIDTH / 2,
      y: s.y - l.CELL_HEIGHT / 2,
      w: l.CELL_WIDTH,
      h: l.CELL_HEIGHT,
      scene: o.mapScene
    });
    var r = P[t];
    d.loadTexture(r, n, this.mapScene.renderer);
  }
};
n.prototype.deletePingHighlights = function () {
  var e = this;
  Object.keys(this._pingHighlight).forEach(function (t) {
    e._pingHighlight[t].remove();
    e._pingHighlight[t] = null;
  });
};
n.prototype.deletePingHighlight = function (e) {
  this._pingHighlight[e] && (this._pingHighlight[e].remove(), this._pingHighlight[e] = null);
};
n.prototype.deleteCellHighlight = function (e) {
  window.background.deleteZoneById(e);
};
n.prototype.updateObstacles = function (e) {
  if (!this.isReady) {
    var t = this,
      i = this.mapId;
    return void this.once("ready", function () {
      t.mapId === i && t.updateObstacles(e);
    });
  }
  if (!this.map) {
    return void console.error(new Error("map is null, isReady is " + this.isReady));
  }
  for (var n = this.map.cells, o = 0, a = e.length; o < a; o++) {
    var s = e[o],
      r = s.obstacleCellId,
      l = n[r],
      c = l.l;
    s.state === O ? l.l |= 1 : s.state === R && (l.l &= 254);
    this.grid.updateCellState(r, l, c);
    _.updateCellPath(r, l);
  }
};
n.prototype.isWalkable = function (e) {
  var t = w.isFightMode ? 5 : 1;
  return 1 === (this.map.cells[e].l & t);
};
n.prototype.isFarmCell = function (e) {
  return 32 === (32 & this.map.cells[e].l);
};
n.prototype.isVisibleCell = function (e) {
  return 64 === (64 & this.map.cells[e].l);
};
n.prototype.getChangeMapFlags = function (e) {
  return this.map ? k.getChangeMapFlags(this.map.cells, this.mapId, e) : (console.error(new Error("map is null, isReady is " + this.isReady)), {});
};
n.prototype.getFirstMapFlag = function (e) {
  var t = window.gui.scenarioManager,
    i = this.getChangeMapFlags(e);
  return i.left && t.isBehaviourEnabled(I.LEFT_SLIDE_CHANGEMAP) ? "left" : i.right && t.isBehaviourEnabled(I.RIGHT_SLIDE_CHANGEMAP) ? "right" : i.top && t.isBehaviourEnabled(I.TOP_SLIDE_CHANGEMAP) ? "top" : i.bottom && t.isBehaviourEnabled(I.BOTTOM_SLIDE_CHANGEMAP) ? "bottom" : null;
};
n.prototype.getCellId = function (e, t) {
  return this.grid.getCellAtSceneCoordinate({
    x: e,
    y: t
  });
};
n.prototype.getCellSceneCoordinate = function (e) {
  var t = r.getCellCoord(e);
  if (this.isReady) {
    if (!this.map) {
      return console.error(new Error("map is null, cannot add cell elevation.")), t;
    }
    t.y -= this.map.cells[e].f || 0;
  }
  return t;
};
n.prototype.hideStatedElements = function () {
  for (var e = 0; e < this.statedElements.length; e++) {
    this.statedElements[e].hide();
  }
};
n.prototype.showStatedElements = function () {
  for (var e = 0; e < this.statedElements.length; e++) {
    this.statedElements[e].show();
  }
};
n.prototype.hideGraphics = function () {
  for (var e = 0; e < this.graphics.length; e++) {
    this.graphics[e].hide();
  }
};
n.prototype.showGraphics = function () {
  for (var e = 0; e < this.graphics.length; e++) {
    this.graphics[e].show();
  }
};
f.initialize();
this.cellHintManager.initialize();
this.map = i;
this.mapId = i.id;
this.grid.initialize(i.cells, w.isRoleplayMode);
this.loadMap(e, t);
this.graphics = [];
this.statedElements = [];
this.animatedElements = [];
A.position = parseInt(y, 10);
A.layer = l.MAP_LAYER_PLAYGROUND;
A.scene = this.mapScene;
f = r.loadStatedElement(A);
this.statedElements.push(f);
f = r.loadAnimatedGraphic(A);
this.animatedElements.push(f);
this.graphics.push(f);
x.background.updateMap(e);
r.notifyAssetAsLoaded();
r.nAssetsToLoad += 1;
d.loadTexture(R, function (e) {
  if ("empty_texture" === e.id) {
    O.remove();
    var t = x.graphics.indexOf(O);
    t !== -1 && x.graphics.splice(t, 1);
  } else {
    O.texture = e;
    O.forceRefresh();
  }
  r.notifyAssetAsLoaded();
}, this.mapScene.renderer, "linear");
O.texture = e;
O.forceRefresh();
this.removeMovementFeedback();
w.isFightMode ? this.switchGameContextFight() : this.switchGameContextRoleplay();
this.objects = {};
this.map && this.grid.initialize(this.map.cells, !1);
this.startAnimatedElements();
this.map && this.grid.initialize(this.map.cells, !0);
o.x = a.x - D / 2;
o.y = a.y - D / 2 + B;
o.position = o.cellId;
o.w = D;
o.h = D;
o.scene = this.mapScene;
this.interactiveElements = {};
this.calligraphyElements = {};
i = e[o];
n.some(t) ? this.calligraphyElements[i.elementId] = i : this.interactiveElements[i.elementId] = i;
o[a] = this.getCellSceneCoordinate(e[a]);
o[a].x += t || 0;
o[a].y += i || 0;
a.x += t || 0;
a.y += i || 0;
p.addArrow(a, e, n, this.mapScene, o);
o[a] = this.getCellSceneCoordinate(e[a]);
o[a].x += t || 0;
o[a].y += i || 0;
i = i || x;
n = n || L;
o._pingHighlight[e] ? (o._pingHighlight[e].texture = n, o._pingHighlight[e].forceRefresh()) : n.release();
i && a.openPingBox(e, t);
e._pingHighlight[t].remove();
e._pingHighlight[t] = null;
s.state === O ? l.l |= 1 : s.state === R && (l.l &= 254);
this.grid.updateCellState(r, l, c);
_.updateCellPath(r, l);
this.cells = [];
this.bounds = [];
this.cellId = void 0;
this.grid = [];
this.scenePositions = [];
e.exports = o;
o.prototype.getCoordinateGridFromCellId = function (e) {
  var t = e % b - ~~(e / M),
    i = t + p,
    n = t + ~~(e / b);
  return {
    i: i,
    j: n
  };
};
o.prototype.getCoordinateCellIdFromGrid = function (e) {
  return this.grid[e.i][e.j].cellId;
};
o.prototype.getCoordinateGridFromScene = function (e) {
  var t = (e.x - u) * _,
    i = (e.y - h) * v,
    n = g * t - g * i + m,
    o = g * t + g * i,
    a = Math.max(0, Math.min(y - 1, ~~n)),
    s = Math.max(0, Math.min(w - 1, ~~o));
  return {
    i: a,
    j: s,
    dx: n - a,
    dy: o - s
  };
};
o.prototype.getCoordinateSceneFromGrid = function (e) {
  var t = e.i - m,
    i = e.j;
  return {
    x: (g * t + g * i) / _ + c / 2 + u,
    y: (g * i - g * t) / v + h
  };
};
o.prototype.getSceneCoordinateFromCellId = function (e) {
  return this.getCoordinateSceneFromGrid(this.getCoordinateGridFromCellId(e));
};
o.prototype.getCellAtSceneCoordinate = function (e) {
  var t = this.getCoordinateGridFromScene(e),
    i = this.grid[t.i][t.j],
    n = i.cells;
  if (0 === n.length) {
    return this.getClosestCell(t, e);
  }
  for (var o = t.dx, a = t.dy, s = i.bounds, r = 0, l = s.length; r < l; r += 1) {
    var c = s[r];
    if (c[0] <= o && o <= c[1] && c[2] <= a && a <= c[3]) {
      return {
        cell: n[r],
        dist: 0
      };
    }
  }
  return this.getClosestCell(t, e);
};
o.prototype.getClosestCell = function (e, t) {
  for (var i, n, o, s, r = e.i, l = e.j, c = t.x, d = t.y, u = 0, h = {
      cell: -1,
      dist: 1 / 0
    }; h.cell === -1;) {
    for (o = Math.max(l - u, 0), s = Math.min(l + u, w - 1), n = Math.min(r + u, y - 1), i = Math.max(r - u, 0); i <= n; i += 1) {
      a(this.grid[i][o].cells, this.scenePositions, c, d, h);
      a(this.grid[i][s].cells, this.scenePositions, c, d, h);
    }
    for (i = Math.max(r - u, 0), n = Math.min(r + u, y - 1), s = Math.min(l + u - 1, w - 1), o = Math.max(l - u + 1, 0); o <= s; o += 1) {
      a(this.grid[i][o].cells, this.scenePositions, c, d, h);
      a(this.grid[n][o].cells, this.scenePositions, c, d, h);
    }
    u += 1;
  }
  return h;
};
o.prototype.getNearbyCellInZone = function (e, t, i, n) {
  if (!n || 0 === n.length) {
    return console.error(new Error('"zone" is not an array')), null;
  }
  if (void 0 !== n[e]) {
    return e;
  }
  for (var o = null, a = [], s = l.getNeighbourCells(e, !0), r = 0; r < s.length; r++) {
    void 0 !== s[r] && void 0 !== n[s[r]] && a.push(s[r]);
  }
  var c = 1 / 0;
  for (r = 0; r < a.length; r++) {
    var d = a[r],
      u = this.scenePositions[d],
      h = (u.x - t) * _,
      p = (u.y - i) * v,
      m = h * h + p * p;
    m < c && (c = m, o = d);
  }
  return o;
};
o.prototype.updateCellState = function (e, t, i) {
  var n = t.l;
  0 === (1 & n) ? 0 !== (1 & i) && this._removeCell(e, t) : 0 === (1 & i) && this._addCell(e, t);
};
o.prototype._removeCell = function (e, t) {
  delete this.scenePositions[e];
  var i = this.useAltitude && t.f || 0,
    n = this.getCoordinateGridFromCellId(e);
  if (0 === i) {
    s(this.grid[n.i][n.j], e);
  } else {
    var o = i / d,
      a = Math.floor(n.i + o),
      r = Math.floor(n.j - o);
    if (a >= y || r >= w) {
      return;
    }
    var l = a + 1,
      c = r + 1;
    if (l < 0 || c < 0) {
      return;
    }
    a >= 0 && (r >= 0 && s(this.grid[a][r], e), c < w && s(this.grid[a][c], e));
    l < y && (r >= 0 && s(this.grid[l][r], e), c < w && s(this.grid[l][c], e));
  }
};
o.prototype._addCell = function (e, t) {
  var i,
    n = this.getCoordinateGridFromCellId(e);
  this.grid[n.i][n.j].cellId = e;
  var o = this.useAltitude && t.f || 0,
    a = this.getCoordinateSceneFromGrid(n);
  if (a.y -= o, this.scenePositions[e] = a, 0 === o) {
    i = this.grid[n.i][n.j];
    i.cells.push(e);
    i.bounds.push([0, 1, 0, 1]);
  } else {
    var s = o / d,
      r = n.i + s,
      l = n.j - s,
      c = Math.floor(r),
      u = Math.floor(l);
    if (c >= y || u >= w) {
      return;
    }
    var h = c + 1,
      p = u + 1;
    if (h < 0 || p < 0) {
      return;
    }
    var m = r - c,
      f = l - u;
    c >= 0 && (u >= 0 && (i = this.grid[c][u], i.cells.push(e), i.bounds.push([m, 1, f, 1])), p < w && (i = this.grid[c][p], i.cells.push(e), i.bounds.push([m, 1, 0, f])));
    h < y && (u >= 0 && (i = this.grid[h][u], i.cells.push(e), i.bounds.push([0, m, f, 1])), p < w && (i = this.grid[h][p], i.cells.push(e), i.bounds.push([0, m, 0, f])));
  }
};
o.prototype.initialize = function (e, t) {
  this.cellList = e;
  this.useAltitude = t;
  this.grid = [];
  this.scenePositions = [];
  for (var i = 0; i < y; i += 1) {
    var o = new Array(w);
    this.grid[i] = o;
    for (var a = 0; a < w; a += 1) {
      o[a] = new n();
    }
  }
  for (var s = e.length - 1; s >= 0; s -= 1) {
    var r = e[s];
    0 !== (1 & r.l) && this._addCell(s, r);
  }
};
a(this.grid[i][o].cells, this.scenePositions, c, d, h);
a(this.grid[i][s].cells, this.scenePositions, c, d, h);
a(this.grid[i][o].cells, this.scenePositions, c, d, h);
a(this.grid[n][o].cells, this.scenePositions, c, d, h);
a >= 0 && (r >= 0 && s(this.grid[a][r], e), c < w && s(this.grid[a][c], e));
l < y && (r >= 0 && s(this.grid[l][r], e), c < w && s(this.grid[l][c], e));
i = this.grid[n.i][n.j];
i.cells.push(e);
i.bounds.push([0, 1, 0, 1]);
c >= 0 && (u >= 0 && (i = this.grid[c][u], i.cells.push(e), i.bounds.push([m, 1, f, 1])), p < w && (i = this.grid[c][p], i.cells.push(e), i.bounds.push([m, 1, 0, f])));
h < y && (u >= 0 && (i = this.grid[h][u], i.cells.push(e), i.bounds.push([0, m, f, 1])), p < w && (i = this.grid[h][p], i.cells.push(e), i.bounds.push([0, m, 0, f])));
this.cellList = e;
this.useAltitude = t;
this.grid = [];
this.scenePositions = [];
a.call(this, e, t);
this.state = -1;
this.animated = !1;
o(n, a);
e.exports = n;
n.prototype.changeState = function (e, t) {
  function i() {
    o.assignSymbol(l, c);
    n.animated = c;
  }
  if (this.state !== e) {
    var n = this,
      o = this.animManager,
      a = this.state;
    if (this.state = e, !o.isVoidAnimManager) {
      var r = {
          id: "AnimState" + a + "_to_AnimState" + e + "_0",
          base: "AnimState" + a + "_to_AnimState" + e,
          direction: 0
        },
        l = {
          id: "AnimState" + e + "_0",
          base: "AnimState" + e,
          direction: 0
        },
        c = s[e] || !1;
      !t && o.template && o.template.exposedSymbols[r.id] ? (this.animated = !0, o.assignSymbol(r, !1, i)) : i();
    }
  }
};
o.assignSymbol(l, c);
n.animated = c;
s.call(this, e);
this._updatedSprites = [];
this._atlasTexture = null;
this._spriteByteSize = this.renderer.getNbBytesPerSprite();
this._vertexBuffer = null;
this._floatView = null;
this._longView = null;
this._sprites = [];
this._vertexBufferCreated = !1;
this._vertexBufferIndexPerPosition = new Array(l + 1);
r.call(this, e);
this.batch = i;
this.renderer = i.renderer;
h = h * b - p * M;
p = T * M + p * b;
m = m * b - f * M;
f = C * M + f * b;
g = g * b - _ * M;
_ = I * M + _ * b;
v = v * b - y * M;
y = A * M + y * b;
this.x0 = h + a;
this.y0 = p + s;
this.x1 = m + a;
this.y1 = f + s;
this.x2 = g + a;
this.y2 = _ + s;
this.x3 = v + a;
this.y3 = y + s;
this.bbox[0] = Math.min(this.x0, this.x1, this.x2, this.x3);
this.bbox[1] = Math.max(this.x0, this.x1, this.x2, this.x3);
this.bbox[2] = Math.min(this.y0, this.y1, this.y2, this.y3);
this.bbox[3] = Math.max(this.y0, this.y1, this.y2, this.y3);
this.graphicInAtlas = t;
this.spriteIndex = 0;
a(n, s);
e.exports = n;
n.prototype.holdsStatics = !0;
n.prototype.setTexture = function (e) {
  this._atlasTexture = e;
  this._updatedSprites.push(this);
  this.forceRefresh();
};
n.prototype.draw = function (e, t) {
  if (null !== this._atlasTexture && !(e.layer > this.layer || t.layer < this.layer)) {
    var i;
    e.layer < this.layer ? i = 0 : (i = Math.round(e.position), i < 0 ? i = 0 : i > l && (i = l));
    var n;
    t.layer > this.layer ? n = l : (n = Math.round(t.position), n < 0 ? n = 0 : n > l && (n = l));
    var o = this._vertexBufferIndexPerPosition[i],
      a = this._vertexBufferIndexPerPosition[n];
    o !== a && this.renderer.drawSpriteSubBatch(this.id, o, a);
  }
};
a(o, r);
o.prototype.isWithinBounds = function (e, t) {
  return this.bbox[0] <= e && e <= this.bbox[1] && this.bbox[2] <= t && t <= this.bbox[3];
};
o.prototype.render = function () {
  null !== this.batch._atlasTexture && this.renderer.drawSpriteSubBatch(this.batch.id, 6 * this.spriteIndex, 6 * this.spriteIndex + 6);
};
o.prototype.forceRefresh = function () {
  this.isOutdated === !1 && (this.isOutdated = !0, this.batch._updatedSprites.push(this), this.batch.forceRefresh());
};
n.prototype.addSprite = function (e, t) {
  var i = new o(e, t, this);
  return this._sprites.push(i), i;
};
n.prototype.finalize = function (e, t) {
  this._createVertexBuffer(e, t);
  this._updatedSprites.push(this);
  this.forceRefresh();
};
n.prototype.refreshAnimation = function (e) {
  if (this.isOutdated = !1, 0 !== this._updatedSprites.length) {
    for (var t = 0; t < this._updatedSprites.length; t += 1) {
      var i = this._updatedSprites[t];
      this._updateSpriteHighlight(i);
      void 0 !== e && e.push(i.bbox.slice());
      i.isOutdated = !1;
    }
    var n = this.id,
      o = this.renderer.getBufferData(n);
    if (void 0 === o) {
      var a = this._atlasTexture;
      if (null !== a && this._vertexBufferCreated) {
        var s = this._floatView,
          r = !1;
        this.renderer.loadSpriteBuffer(n, s, a, this.bbox, r);
        this.renderer.lockBuffer(n);
      }
    }
    this._updatedSprites.length = 0;
  }
};
n.prototype._updateSpriteHighlight = function (e) {
  var t = e.spriteIndex * this._spriteByteSize,
    i = t / 4,
    n = this._longView.subarray(i, i + this._spriteByteSize / 4),
    o = e.tint,
    a = Math.max(-128, Math.min(127, 64 * o[0])),
    s = Math.max(-128, Math.min(127, 64 * o[1])),
    r = Math.max(-128, Math.min(127, 64 * o[2])),
    l = Math.max(-128, Math.min(127, 64 * o[3])),
    c = (l << 24 & 4278190080) + (r << 16 & 16711680) + (s << 8 & 65280) + (255 & a);
  n[3] = n[8] = n[13] = c;
  n[18] = n[23] = n[28] = c;
  this.renderer.updateVertexBuffer(this.id, n, t);
};
n.prototype._createVertexBuffer = function (e, t) {
  this._vertexBuffer = new window.ArrayBuffer(this._spriteByteSize * this._sprites.length);
  this._floatView = new window.Float32Array(this._vertexBuffer);
  this._longView = new window.Uint32Array(this._vertexBuffer);
  for (var i = this._floatView, n = this._longView, o = this._longView, a = 1 / 0, s = -(1 / 0), r = 1 / 0, c = -(1 / 0), d = 0, u = 0; u < this._sprites.length; u += 1) {
    var h = this._sprites[u],
      p = h.graphicInAtlas,
      m = u * this._spriteByteSize / 4;
    for (h.spriteIndex = u; d < h._position;) {
      this._vertexBufferIndexPerPosition[d] = 6 * u;
      d += 1;
    }
    this._vertexBufferIndexPerPosition[d] = 6 * u + 6;
    var f = h.bbox;
    f[0] < a && (a = f[0]);
    f[1] > s && (s = f[1]);
    f[2] < r && (r = f[2]);
    f[3] > c && (c = f[3]);
    i[m + 0] = h.x0;
    i[m + 1] = h.y0;
    i[m + 5] = h.x2;
    i[m + 6] = h.y2;
    i[m + 10] = h.x3;
    i[m + 11] = h.y3;
    i[m + 15] = h.x0;
    i[m + 16] = h.y0;
    i[m + 20] = h.x3;
    i[m + 21] = h.y3;
    i[m + 25] = h.x1;
    i[m + 26] = h.y1;
    var g = p.sx / e * 65535 & 65535,
      _ = p.sy / t * 4294901760 & 4294901760,
      v = (p.sx + p.sw) / e * 65535 & 65535,
      y = (p.sy + p.sh) / t * 4294901760 & 4294901760;
    n[m + 2] = g + _;
    n[m + 7] = g + y;
    n[m + 12] = v + y;
    n[m + 17] = g + _;
    n[m + 22] = v + y;
    n[m + 27] = v + _;
    var w = h.tint,
      b = Math.max(-128, Math.min(127, 64 * w[0])),
      M = Math.max(-128, Math.min(127, 64 * w[1])),
      T = Math.max(-128, Math.min(127, 64 * w[2])),
      C = Math.max(-128, Math.min(127, 64 * w[3])),
      I = (C << 24 & 4278190080) + (T << 16 & 16711680) + (M << 8 & 65280) + (255 & b);
    o[m + 3] = o[m + 8] = o[m + 13] = I;
    o[m + 18] = o[m + 23] = o[m + 28] = I;
    o[m + 4] = o[m + 9] = o[m + 14] = 0;
    o[m + 19] = o[m + 24] = o[m + 29] = 0;
  }
  for (; d <= l;) {
    this._vertexBufferIndexPerPosition[d] = 6 * u;
    d += 1;
  }
  this.bbox[0] = a;
  this.bbox[1] = s;
  this.bbox[2] = r;
  this.bbox[3] = c;
  this._vertexBufferCreated = !0;
};
n.prototype.clear = function () {
  this.renderer.releaseBuffer(this.id);
  this._atlasTexture && this._atlasTexture.release();
};
this._atlasTexture = e;
this._updatedSprites.push(this);
this.forceRefresh();
this._createVertexBuffer(e, t);
this._updatedSprites.push(this);
this.forceRefresh();
this._updateSpriteHighlight(i);
void 0 !== e && e.push(i.bbox.slice());
i.isOutdated = !1;
this.renderer.loadSpriteBuffer(n, s, a, this.bbox, r);
this.renderer.lockBuffer(n);
n[3] = n[8] = n[13] = c;
n[18] = n[23] = n[28] = c;
this.renderer.updateVertexBuffer(this.id, n, t);
this._vertexBuffer = new window.ArrayBuffer(this._spriteByteSize * this._sprites.length);
this._floatView = new window.Float32Array(this._vertexBuffer);
this._longView = new window.Uint32Array(this._vertexBuffer);
this._vertexBufferIndexPerPosition[d] = 6 * u;
d += 1;
f[0] < a && (a = f[0]);
f[1] > s && (s = f[1]);
f[2] < r && (r = f[2]);
f[3] > c && (c = f[3]);
i[m + 0] = h.x0;
i[m + 1] = h.y0;
i[m + 5] = h.x2;
i[m + 6] = h.y2;
i[m + 10] = h.x3;
i[m + 11] = h.y3;
i[m + 15] = h.x0;
i[m + 16] = h.y0;
i[m + 20] = h.x3;
i[m + 21] = h.y3;
i[m + 25] = h.x1;
i[m + 26] = h.y1;
n[m + 2] = g + _;
n[m + 7] = g + y;
n[m + 12] = v + y;
n[m + 17] = g + _;
n[m + 22] = v + y;
n[m + 27] = v + _;
o[m + 3] = o[m + 8] = o[m + 13] = I;
o[m + 18] = o[m + 23] = o[m + 28] = I;
o[m + 4] = o[m + 9] = o[m + 14] = 0;
o[m + 19] = o[m + 24] = o[m + 29] = 0;
this._vertexBufferIndexPerPosition[d] = 6 * u;
d += 1;
this.bbox[0] = a;
this.bbox[1] = s;
this.bbox[2] = r;
this.bbox[3] = c;
this._vertexBufferCreated = !0;
this.renderer.releaseBuffer(this.id);
this._atlasTexture && this._atlasTexture.release();
u.call(this, e, t);
this._centerX = e.w / 2;
this._centerY = e.h;
this.orientation = e.orientation;
this.tween = null;
this._startAnimation(i);
y = e;
o();
_ = [];
(N.playing || N.starting) && (N.reset(0, null), N.stop());
(x.playing || x.starting) && x.stop();
s();
a(e[o], t[o], i, n);
N.reset(I, function () {
  ++o >= e.length && (o = 0);
  r(e, t, i, n, o);
});
N.start();
++o >= e.length && (o = 0);
r(e, t, i, n, o);
x.reset(I, function () {
  s();
});
x.start();
h(n, u);
Object.defineProperty(n.prototype, "centerX", {
  get: function () {
    return this._centerX;
  },
  set: function (e) {
    this._centerX = e;
    this.forceRefresh();
  }
});
Object.defineProperty(n.prototype, "centerY", {
  get: function () {
    return this._centerY;
  },
  set: function (e) {
    this._centerY = e;
    this.forceRefresh();
  }
});
n.prototype._startAnimation = function (e) {
  var t = A[this.orientation] || 0;
  this.rotation = t * Math.PI / 180;
  this.tween && (this.tween.stop(), this.tween = null);
  var i = this.centerY - S,
    n = this.centerY + S;
  return this.tween = new m(this, ["alpha", "centerY"]).from({
    alpha: 0,
    centerY: i
  }).to({
    alpha: 1,
    centerY: i
  }, C).to({
    alpha: 1,
    centerY: n
  }, T, p.trigo, E).to({
    alpha: 0,
    centerY: n
  }, C).to({
    alpha: 0,
    centerY: n
  }, T).start(e || !0), this;
};
n.prototype.stop = function () {
  this.tween.stop();
};
n.prototype.render = function () {
  var e = this.renderer;
  e.save();
  e.translate(this._x, this._y);
  e.rotate(this._rotation);
  e.translate(-this._centerX, -this._centerY);
  e.multiplyColor(this.tint[0], this.tint[1], this.tint[2], this.tint[3]);
  e.drawImage(this.texture, 0, 0, this.w, this.h);
  e.restore();
};
n.prototype.generateCurrentFrameData = function () {
  return [-this._centerX, this.w - this._centerX, -this._centerY, this.h - this._centerY];
};
t.addArrow = a;
this._centerX = e;
this.forceRefresh();
this._centerY = e;
this.forceRefresh();
this.rotation = t * Math.PI / 180;
this.tween && (this.tween.stop(), this.tween = null);
e.save();
e.translate(this._x, this._y);
e.rotate(this._rotation);
e.translate(-this._centerX, -this._centerY);
e.multiplyColor(this.tint[0], this.tint[1], this.tint[2], this.tint[3]);
e.drawImage(this.texture, 0, 0, this.w, this.h);
e.restore();
t.removeArrows = s;
t.addArrowsSequence = l;
t.addArrowsOneShot = c;
t.addPingPicto = function (e, t, i, l, c) {
  if (!s[c]) {
    return void console.error("[IsoEngine.addPingPicto] No base for type", c);
  }
  var d = new a({
    layer: n.MAP_LAYER_ICONS,
    x: t.x,
    y: t.y,
    scene: window.isoEngine.mapScene
  });
  o.loadAnimationManager(d, "embedded", "ping", function (e) {
    e.assignSymbol({
      base: s[c][l],
      direction: -1
    }, !1);
  });
  r[e] = {
    front: d
  };
  var u = 70,
    h = 0,
    p = window.actorManager.getActorsOnCell(i);
  if (p.length > 0) {
    var m = p[0].bbox;
    h = m ? m[2] - t.y : -100;
    h -= u;
    t.y + h < 0 && (h = m ? m[3] - t.y : 100, h += u);
  } else {
    h = -u;
    t.y + h < 0 && (h = u);
  }
  d.y = t.y + h;
  window.isoEngine.mapRenderer.addPingHighlight(i, c);
};
t.removePingPicto = function (e) {
  window.isoEngine.mapRenderer.deletePingHighlight(e);
  var t = r[e];
  return t ? (t.front && t.front.remove(), void delete r[e]) : void console.warn("IsoEngine removePing: There no ping picto with the id", e);
};
t.removeAllPingPictos = function () {
  for (var e in r) {
    r.hasOwnProperty(e) && t.removePingPicto(e);
  }
};
o.loadAnimationManager(d, "embedded", "ping", function (e) {
  e.assignSymbol({
    base: s[c][l],
    direction: -1
  }, !1);
});
r[e] = {
  front: d
};
h = m ? m[2] - t.y : -100;
h -= u;
t.y + h < 0 && (h = m ? m[3] - t.y : 100, h += u);
h = -u;
t.y + h < 0 && (h = u);
d.y = t.y + h;
window.isoEngine.mapRenderer.addPingHighlight(i, c);
e === g.TAP_MARKER && (t.layer = p.MAP_LAYER_TAP_FEEDBACK);
h.call(this, t);
this.setWhiteListedness(!0);
this.infos = e;
_[a.id] = s;
m.loadAnimationManager(s, "embedded", "tapFeedback");
s(g.MOVEMENT_MARKER);
s(g.TURN_MARKER_RED);
s(g.TURN_MARKER_BLUE);
u(n, h);
n.prototype.play = function (e) {
  var t = this.infos,
    i = this,
    n = t.isLoop,
    o = function () {
      i.remove(!1);
    };
  n && (o = void 0);
  this.animManager.assignSymbol({
    base: t.animationName,
    direction: -1
  }, n, o);
  (e.position || 0 === e.position) && (this.position = e.position);
  this.x = e.x;
  this.y = e.y;
  this.show();
};
t.initialize = function () {
  o();
};
t.addMovementFeedback = r;
t.removeMovementFeedback = l;
t.addTapFeedback = c;
t.removeTapFeedback = d;
t.addTurnFeedback = function (e, t) {
  var i = t === f.TEAM_CHALLENGER ? g.TURN_MARKER_RED : g.TURN_MARKER_BLUE;
  a(i, e);
};
t.moveRedFeedback = function (e, t) {
  var i = _[3];
  i.x = e;
  i.y = t;
};
t.moveBlueFeedback = function (e, t) {
  var i = _[4];
  i.x = e;
  i.y = t;
};
n && (o = void 0);
this.animManager.assignSymbol({
  base: t.animationName,
  direction: -1
}, n, o);
(e.position || 0 === e.position) && (this.position = e.position);
this.x = e.x;
this.y = e.y;
this.show();
i.x = e;
i.y = t;
i.x = e;
i.y = t;
this._init = !1;
this._isLoaded = !1;
this._loadingCallback = null;
this._tween = null;
this.animation = null;
e.exports = n;
n.prototype._loadAnimations = function () {
  var e = this;
  this.animation = new o({
    layer: a.MAP_LAYER_BACKGROUND,
    scene: window.isoEngine.mapRenderer.mapScene,
    sx: .5,
    sy: .5
  });
  this.animation.setWhiteListedness(!0);
  s.loadAnimationManager(this.animation, "embedded", "cases", function () {
    return e._isLoaded = !0, e._loadingCallback && e._loadingCallback();
  });
};
n.prototype.playAnimation = function (e, t) {
  var i = this,
    n = window.isoEngine.mapRenderer.getCellSceneCoordinate(t);
  return this._isLoaded ? (this._isLoaded = !0, this._cleanTween(), this.animation.animManager.assignSymbol({
    base: e,
    direction: -1
  }, !0), this.animation.position = t, this.animation.x = n.x, this.animation.y = n.y, this.animation.show(), void (this._tween = new r(this.animation, ["alpha"]).from({
    alpha: 0
  }).to({
    alpha: 1
  }, 30).start())) : void (this._loadingCallback = function () {
    i.playAnimation(e, t);
  });
};
n.prototype.stopAnimation = function () {
  var e = this;
  this._isLoaded && (this._cleanTween(), this._tween = new r(this.animation, ["alpha"]).from({
    alpha: 1
  }).to({
    alpha: 0
  }, 30).onFinish(function () {
    e.animation && e.animation.remove();
  }).start());
};
n.prototype._cleanTween = function () {
  this._tween && (this._tween.playing || this._tween.starting) && this._tween.stop();
};
n.prototype.initialize = function () {
  this._init || (this._loadAnimations(), this._init = !0);
};
this.animation = new o({
  layer: a.MAP_LAYER_BACKGROUND,
  scene: window.isoEngine.mapRenderer.mapScene,
  sx: .5,
  sy: .5
});
this.animation.setWhiteListedness(!0);
s.loadAnimationManager(this.animation, "embedded", "cases", function () {
  return e._isLoaded = !0, e._loadingCallback && e._loadingCallback();
});
this.i = e;
this.j = t;
this.floor = -1;
this.zone = -1;
this.speed = 1;
this.weight = 0;
this.candidateRef = null;
this.i = e;
this.j = t;
this.w = i;
this.d = n;
this.path = o;
o.push(d);
e.candidateRef = d;
s(d, u) && l(u, f, t, i, n, e);
s(d, m) && l(m, f, t, i, n, e);
s(d, h) && l(h, f, t, i, n, e);
s(d, p) && l(p, f, t, i, n, e);
t.push(m(i.x, i.y));
i.x += a;
t.push(m(i.x, i.y));
i.y += s;
t.push(m(i.x, i.y));
i.x += a;
i.y += s;
i = l;
t.push(r);
t.fillPathGrid = function (e) {
  C = e.cells[0].z || 0;
  T = !0;
  for (var t = 0; t < _; t += 1) {
    for (var i = y[t], n = 0; n < v; n += 1) {
      var a = m(t - 1, n - 1),
        s = i[n],
        r = e.cells[a];
      o(r, s);
    }
  }
};
t.updateCellPath = function (e, t) {
  var i = h.getMapPointFromCellId(e),
    n = y[i.x + 1][i.y + 1];
  o(t, n);
};
t.getPath = function (e, t, i, n, o) {
  var r, l;
  n = void 0 === n || Boolean(n);
  var d = p(e),
    u = p(t),
    h = d.x + 1,
    g = d.y + 1,
    _ = y[h][g];
  if (_.zone === -1) {
    for (var v = null, w = 1 / 0, b = 1 / 0, M = -1; M <= 1; M += 1) {
      for (var T = -1; T <= 1; T += 1) {
        if (0 !== M || 0 !== T) {
          var C = y[h + M][g + T];
          if (C.zone !== -1) {
            var I = Math.abs(C.f - _.f),
              A = Math.abs(M) + Math.abs(T);
            (null === v || I < b || I <= b && A < w) && (v = C, w = A, b = I);
          }
        }
      }
    }
    return null !== v ? [e, m(v.i - 1, v.j - 1)] : (console.error(new Error("[pathFinder.getPath] Player is stuck in " + h + "/" + g)), [e]);
  }
  var S,
    E,
    N = u.x + 1,
    x = u.y + 1;
  for (E in i) {
    S = p(E);
    y[S.x + 1][S.y + 1].weight += f;
  }
  for (var L = [], O = [], R = Math.sqrt((h - N) * (h - N) + (g - x) * (g - x)), D = new a(h, g, 0, R, null), P = null, B = D; D.i !== N || D.j !== x;) {
    c(D, N, x, L, n);
    var k = L.length;
    if (0 === k) {
      D = B;
      break;
    }
    var F = 1 / 0,
      H = 0;
    for (r = 0; r < k; r += 1) {
      l = L[r];
      l.w + l.d < F && (D = l, F = l.w + l.d, H = r);
    }
    if (O.push(D), L.splice(H, 1), 0 === D.d || o && D.d < 1.5 && s(y[N][x], y[D.i][D.j])) {
      if (null === P || D.w < P.w) {
        P = D;
        B = D;
        var z = [];
        for (r = 0; r < L.length; r += 1) {
          l = L[r];
          l.w + l.d < P.w ? z.push(l) : y[l.i][l.j].candidateRef = null;
        }
        L = z;
      }
    } else {
      D.d < B.d && (B = D);
    }
  }
  for (r = 0; r < L.length; r += 1) {
    l = L[r];
    y[l.i][l.j].candidateRef = null;
  }
  for (var W = 0; W < O.length; W += 1) {
    D = O[W];
    y[D.i][D.j].candidateRef = null;
  }
  for (E in i) {
    S = p(E);
    y[S.x + 1][S.y + 1].weight -= f;
  }
  for (var G = []; null !== B;) {
    G.unshift(m(B.i - 1, B.j - 1));
    B = B.path;
  }
  return G;
};
t.getAccessibleCells = function (e, t) {
  e += 1;
  t += 1;
  var i = y[e][t],
    n = y[e - 1][t],
    o = y[e][t - 1],
    a = y[e][t + 1],
    r = y[e + 1][t],
    l = [];
  return s(i, n) && l.push({
    i: n.i - 1,
    j: n.j - 1
  }), s(i, r) && l.push({
    i: r.i - 1,
    j: r.j - 1
  }), s(i, o) && l.push({
    i: o.i - 1,
    j: o.j - 1
  }), s(i, a) && l.push({
    i: a.i - 1,
    j: a.j - 1
  }), l;
};
t.compressPath = function (e) {
  for (var t, i, n = [], o = e[0], a = -1, s = 0; s < e.length; s++) {
    var r,
      l = e[s],
      c = p(l);
    r = 0 === s ? -1 : c.y === i ? c.x > t ? 7 : 3 : c.x === t ? c.y > i ? 1 : 5 : c.x > t ? c.y > i ? 0 : 6 : c.y > i ? 2 : 4;
    r !== a && (n.push(o + (r << 12)), a = r);
    o = l;
    t = c.x;
    i = c.y;
  }
  return n.push(o + (a << 12)), n;
};
t.normalizePath = function (e) {
  return d(e) ? e : u(e);
};
t.logPath = function (e) {
  e = e || [];
  var t,
    i,
    n = [];
  for (t = 0; t < 33; t += 1) {
    for (n.push([]), i = 0; i < 34; i += 1) {
      void 0 === m(t, i) ? n[t][i] = "    " : n[t][i] = "[  ]";
    }
  }
  for (var o = 0, a = e.length; o < a; o += 1) {
    var s = e[o],
      r = p(s),
      l = o < 10 ? "0" : "";
    n[r.x][r.y] = "[" + l + o + "]";
  }
  var c = "";
  for (i = 0; i < 34; i += 1) {
    for (t = 0; t < 33; t += 1) {
      c += n[t][i];
    }
    c += "\n";
  }
  return c;
};
C = e.cells[0].z || 0;
T = !0;
S = p(E);
y[S.x + 1][S.y + 1].weight += f;
l = L[r];
l.w + l.d < F && (D = l, F = l.w + l.d, H = r);
P = D;
B = D;
l = L[r];
l.w + l.d < P.w ? z.push(l) : y[l.i][l.j].candidateRef = null;
l = L[r];
y[l.i][l.j].candidateRef = null;
D = O[W];
y[D.i][D.j].candidateRef = null;
S = p(E);
y[S.x + 1][S.y + 1].weight -= f;
G.unshift(m(B.i - 1, B.j - 1));
B = B.path;
e += 1;
t += 1;
r = 0 === s ? -1 : c.y === i ? c.x > t ? 7 : 3 : c.x === t ? c.y > i ? 1 : 5 : c.x > t ? c.y > i ? 0 : 6 : c.y > i ? 2 : 4;
r !== a && (n.push(o + (r << 12)), a = r);
o = l;
t = c.x;
i = c.y;
e.exports = n;
n.prototype.destroy = function () {
  null !== this.gfx && this.gfx.remove();
  this._lineBatch && (this._lineBatch.remove(), this._lineBatch = null);
  this._boxBatch && (this._boxBatch.remove(), this._boxBatch = null);
};
null !== this.gfx && this.gfx.remove();
this._lineBatch && (this._lineBatch.remove(), this._lineBatch = null);
this._boxBatch && (this._boxBatch.remove(), this._boxBatch = null);
o(i.x + ":" + i.y + ":H", t);
o(i.x + 1 + ":" + i.y + ":V", t);
o(i.x + ":" + (i.y + 1) + ":H", t);
o(i.x + ":" + i.y + ":V", t);
r[0] = ~~r[0];
r[1] = ~~r[1];
this.mapRenderer = e;
this.onLoadedCallback = t;
this.nAssetsLoaded = 0;
this.nAssetsToLoad = 0;
this._atlas = document.createElement("canvas");
this._atlasContext = this._atlas.getContext("2d");
this.obsolete = !1;
null !== u && (u.obsolete = !0);
e.exports = n;
n.prototype.notifyAssetAsLoaded = function () {
  if (this.nAssetsLoaded += 1, window.isoEngine.showLoadingProgress(this.nAssetsLoaded / this.nAssetsToLoad), this.nAssetsLoaded === this.nAssetsToLoad) {
    if (this.onLoadedCallback(), this.onLoadedCallback = null, this.obsolete) {
      return;
    }
    this.mapRenderer.isReady = !0;
    this.mapRenderer.emit("ready");
    this.obsolete = !0;
  }
};
n.prototype.loadStatedElement = function (e) {
  var t = new a(e),
    i = this;
  return this.nAssetsToLoad += 1, o.loadAnimationManager(t, "bone", e.look + "/state", function () {
    t.changeState(t.state, !0);
    i.notifyAssetAsLoaded();
  }), t;
};
n.prototype.loadAnimatedGraphic = function (e) {
  var t = new r(e),
    i = this;
  return this.nAssetsToLoad += 1, o.loadAnimationManager(t, "bone", e.look + "/motion", function () {
    s.isFightMode ? t.stop() : t.animate();
    i.notifyAssetAsLoaded();
  }), t;
};
n.prototype.loadAtlas = function (e, t) {
  function i() {
    if (r += 1, r === s) {
      var e = c.mapRenderer.mapScene,
        i = c.mapRenderer.mapId,
        n = e.createTexture(c._atlas, "mapAtlas" + i, "linear");
      c._atlas.width = 1;
      c._atlas.height = 1;
      t.setTexture(n);
    }
    c.notifyAssetAsLoaded();
  }
  function n(e, t) {
    l.loadImage(e, function (e) {
      if (!c.obsolete) {
        var n = t.sx,
          o = t.sy,
          a = t.sw,
          s = t.sh,
          r = t.cx || 0,
          l = t.cy || 0,
          d = t.cw || a,
          u = t.ch || s;
        r + d > e.width && (d = e.width - r);
        l + u > e.height && (u = e.height - l);
        c._atlasContext.drawImage(e, r, l, d, u, n, o, a, s);
        i();
      }
    });
  }
  this._atlas.width = e.width;
  this._atlas.height = e.height;
  var o = e.graphicsPositions,
    a = Object.keys(o),
    s = a.length,
    r = 0;
  this.nAssetsToLoad += s;
  for (var c = this, u = 0; u < a.length; u += 1) {
    var h = a[u],
      p = o[h],
      m = p.jpg ? "jpg" : "png",
      f = m + "/" + h + "." + m,
      g = d + f;
    n(g, p);
  }
};
this.mapRenderer.isReady = !0;
this.mapRenderer.emit("ready");
this.obsolete = !0;
t.changeState(t.state, !0);
i.notifyAssetAsLoaded();
s.isFightMode ? t.stop() : t.animate();
i.notifyAssetAsLoaded();
c._atlas.width = 1;
c._atlas.height = 1;
t.setTexture(n);
r + d > e.width && (d = e.width - r);
l + u > e.height && (u = e.height - l);
c._atlasContext.drawImage(e, r, l, d, u, n, o, a, s);
i();
this._atlas.width = e.width;
this._atlas.height = e.height;
a.call(this, e, e.animManager);
this.animStatic = !!e.astc;
this.delayMin = e.dmin || 0;
this.delayMax = e.dmax || 0;
this._timeout = null;
this._stopped = !0;
o(n, a);
e.exports = n;
n.prototype.animate = function () {
  this._stopped && (this._stopped = !1, this.delayMax ? (this.animStatic && this.animManager.assignSymbol(s, !1), this._animateShoot()) : this._animateLoop());
};
n.prototype.stop = function () {
  this._stopped = !0;
  this._timeout && (window.clearTimeout(this._timeout), this._timeout = null);
  this.delayMax || this.animManager.assignSymbol(s, !1);
};
n.prototype.remove = function () {
  this.stop();
  a.prototype.remove.call(this);
};
n.prototype._animateLoop = function () {
  this.animManager.assignSymbol(r, !0);
};
n.prototype._animateShoot = function () {
  var e = this;
  if (!this._stopped) {
    var t = 1e3 * (this.delayMin + (this.delayMax - this.delayMin) * Math.random());
    this._timeout = window.setTimeout(function () {
      e._stopped || e.animManager.assignSymbol(r, !1, function () {
        e._stopped || (e.animStatic && e.animManager.assignSymbol(s, !1), e._animateShoot());
      });
    }, t);
  }
};
this._stopped = !0;
this._timeout && (window.clearTimeout(this._timeout), this._timeout = null);
this.delayMax || this.animManager.assignSymbol(s, !1);
this.stop();
a.prototype.remove.call(this);
e.exports = n;
n.prototype.getChangeMapFlags = function (e, t, i) {
  e[i] || this._logger.error(new Error('Cannot find cell data for "' + t + '" on cell "' + i + '"'));
  var n = e[i] || {},
    l = n.c || 0;
  return 0 === l ? {
    left: !1,
    right: !1,
    top: !1,
    bottom: !1
  } : {
    left: r(i, l),
    right: a(i, l),
    top: o(i, l),
    bottom: s(i, l)
  };
};
l.call(this, e, e.scene.renderer.getEmptyTexture());
this.zones = [];
this.displayGrid = !1;
this.tacticalMode = !1;
this.gridLines = null;
this.tacticalBoxes = null;
this.gridAnimator = null;
this.isDebugMode = !1;
_.on("gameContextChanged", this.onGameContextChanged.bind(this));
g.on("alwaysShowGrid", function (e) {
  _.isFightMode || t.toggleGrid(e);
});
g.on("fightAlwaysShowGrid", function (e) {
  _.isFightMode && t.toggleGrid(e);
});
r(n, l);
e.exports = n;
n.prototype.resetAndClear = function () {
  this.displayGrid = !1;
};
n.prototype.clear = function () {
  this.texture ? (this.texture.release(), this.texture = null) : console.warn("[Background.clear] Clearing background although no texture was ever set");
};
n.prototype.releaseMap = function () {
  this.deleteAllZones();
  this.gridLines && (this.gridLines.remove(), this.gridLines = null);
};
n.prototype.updateMap = function (e) {
  this._cleared = !1;
  this.texture = e;
  this.show();
  this.gridLines || this.generateWalkableGrid();
};
n.prototype.onGameContextChanged = function () {
  var e = _.isFightMode ? g.fightAlwaysShowGrid : g.alwaysShowGrid;
  this.generateWalkableGrid();
  this.toggleGrid(e);
};
n.prototype.toggleGrid = function (e) {
  if (this.displayGrid !== e && (this.displayGrid = e, null !== this.gridLines)) {
    if (e) {
      this.gridLines.show();
      new m(this.gridLines, ["alpha"]).to({
        alpha: 1
      }, 20).start();
    } else {
      var t = this;
      new m(this.gridLines, ["alpha"]).to({
        alpha: 0
      }, 15).start().onFinish(function () {
        t.gridLines && t.gridLines.hide();
      });
    }
  }
};
n.prototype.generateWalkableGrid = function () {
  this.gridAnimator || (this.gridAnimator = new h());
  var e = window.isoEngine.mapRenderer;
  if (e.map && e.map.cells) {
    for (var t = e.map.cells, i = _.isRoleplayMode, n = {}, o = [], r = [], l = 0; l < a.NB_CELLS; l++) {
      var p = e.isWalkable(l);
      if (p) {
        var f = t[l],
          g = s.cellCoord[l],
          v = (i && f.f || 0) + w,
          I = g.x,
          A = I - M,
          S = I + M,
          E = g.y - v,
          N = E + T,
          x = E + y,
          L = I + "." + E + "-" + S + "." + N,
          O = I + "." + x + "-" + S + "." + N,
          R = I + "." + x + "-" + A + "." + N,
          D = I + "." + E + "-" + A + "." + N;
        void 0 === n[L] && (n[L] = !0, r.push(new c(I, E, S, N)));
        void 0 === n[O] && (n[O] = !0, r.push(new c(S, N, I, x)));
        void 0 === n[R] && (n[R] = !0, r.push(new c(I, x, A, N)));
        void 0 === n[D] && (n[D] = !0, r.push(new c(A, N, I, E)));
        var P = new d(I, E, S, N, I, x, A, N);
        P.cellId = l;
        o.push(P);
      }
    }
    this.gridLines && this.gridLines.remove();
    this.gridLines = new u({
      scene: window.isoEngine.mapScene,
      x: 0,
      y: 0,
      position: 3,
      lines: r,
      lineWidth: 2,
      hue: C,
      layer: b,
      id: "combatGrid"
    });
    this.gridLines.alpha = 0;
    this.displayGrid ? (this.gridLines.show(), new m(this.gridLines, ["alpha"]).to({
      alpha: 1
    }, 20).start()) : this.gridLines.hide();
    this.isDebugMode && (this.initDebugOverlay(), this.cellIdOverlay.clear(), this.cellIdOverlay.generateOverlay());
  }
};
n.prototype.setGridColor = function (e) {
  this.gridLines.hue = e;
};
n.prototype.initDebugOverlay = function () {
  if (!this.cellIdOverlay) {
    var e = {
      scene: this.scene,
      layer: a.MAP_LAYER_FOREGROUND,
      position: 1,
      x: -a.HORIZONTAL_OFFSET,
      y: -a.VERTICAL_OFFSET,
      w: a.MAP_SCENE_WIDTH,
      h: a.MAP_SCENE_HEIGHT,
      id: "cellIdOverlay"
    };
    this.cellIdOverlay = new f(e);
  }
};
n.prototype.toggleDebugMode = function (e) {
  this.isDebugMode = !this.isDebugMode;
  this.initDebugOverlay();
  this.isDebugMode ? this.cellIdOverlay.generateOverlay(e) : this.cellIdOverlay.clear();
};
n.prototype.highlightDebugCells = function (e, t) {
  this.isDebugMode && this.cellIdOverlay && this.cellIdOverlay.colorCells(e, t);
};
n.prototype.deleteAllZones = function () {
  for (var e = 0; e < this.zones.length; e++) {
    this.zones[e].destroy();
  }
  this.zones = [];
};
n.prototype.addZone = function (e, t) {
  this.zones.push(e);
  e.id = t;
};
n.prototype.deleteZone = function (e) {
  e.destroy();
  var t = this.zones.indexOf(e);
  return t === -1 ? console.warn("Removing a non existing zone") : void this.zones.splice(t, 1);
};
n.prototype.deleteZoneById = function (e, t) {
  for (var i = 0; i < this.zones.length;) {
    this.zones[i].id === e ? (t && t(this.zones[i]), this.zones[i].destroy(), this.zones.splice(i, 1)) : i++;
  }
};
n.prototype.getDataOfZoneId = function (e) {
  for (var t = 0; t < this.zones.length; t++) {
    if (this.zones[t].id === e) {
      return this.zones[t].data;
    }
  }
  return null;
};
this.deleteAllZones();
this.gridLines && (this.gridLines.remove(), this.gridLines = null);
this._cleared = !1;
this.texture = e;
this.show();
this.gridLines || this.generateWalkableGrid();
this.generateWalkableGrid();
this.toggleGrid(e);
this.gridLines.show();
new m(this.gridLines, ["alpha"]).to({
  alpha: 1
}, 20).start();
void 0 === n[L] && (n[L] = !0, r.push(new c(I, E, S, N)));
void 0 === n[O] && (n[O] = !0, r.push(new c(S, N, I, x)));
void 0 === n[R] && (n[R] = !0, r.push(new c(I, x, A, N)));
void 0 === n[D] && (n[D] = !0, r.push(new c(A, N, I, E)));
P.cellId = l;
o.push(P);
this.gridLines && this.gridLines.remove();
this.gridLines = new u({
  scene: window.isoEngine.mapScene,
  x: 0,
  y: 0,
  position: 3,
  lines: r,
  lineWidth: 2,
  hue: C,
  layer: b,
  id: "combatGrid"
});
this.gridLines.alpha = 0;
this.displayGrid ? (this.gridLines.show(), new m(this.gridLines, ["alpha"]).to({
  alpha: 1
}, 20).start()) : this.gridLines.hide();
this.isDebugMode && (this.initDebugOverlay(), this.cellIdOverlay.clear(), this.cellIdOverlay.generateOverlay());
this.isDebugMode = !this.isDebugMode;
this.initDebugOverlay();
this.isDebugMode ? this.cellIdOverlay.generateOverlay(e) : this.cellIdOverlay.clear();
this.zones.push(e);
e.id = t;
n.prototype.colorCurrentDragCell = function (e, t, i) {
  if (i.data) {
    var n = window.foreground.convertScreenToCanvasCoordinate(e, t - I),
      o = window.isoEngine.mapScene.convertCanvasToSceneCoordinate(n.x, n.y),
      a = window.isoEngine.mapRenderer.getCellId(o.x, o.y),
      s = a.cell;
    window.isoEngine.cellHover(s, i.data.id);
  }
};
n.prototype.dragCellRelease = function (e, t, i) {
  if (_.isFightMode) {
    if (!i.data) {
      return;
    }
    var n = o(e, t - I);
    window.isoEngine.cellHoverRelease(n.cell);
  }
};
n.prototype.addGridAnimation = function (e) {
  return this.gridAnimator.addGridAnimation(e);
};
n.prototype.removeGridLayer = function (e) {
  this.gridAnimator ? this.gridAnimator.removeGridLayer(e) : this.gridAnimator = new h();
};
n.prototype.addTargetHighLights = function (e, t, i, n, o, a) {
  var s = new p(e, t, i);
  A.push(s);
  s.animate(n, o);
  a && s.hide();
};
n.prototype.removeTargetHighlights = function () {
  A.forEach(function (e) {
    e.stopped === !1 && (e.stop(), e.remove());
  });
  A = [];
};
n.prototype.hideTargetHighlights = function () {
  A.forEach(function (e) {
    e.hide();
  });
};
n.prototype.showTargetHighlights = function () {
  A.forEach(function (e) {
    e.show();
  });
};
A.push(s);
s.animate(n, o);
a && s.hide();
A.forEach(function (e) {
  e.stopped === !1 && (e.stop(), e.remove());
});
A = [];
this._gridOverlay = new o();
this._gridOverlay.hide();
this._layers = new s();
this._layersBeingRemoved = new s();
e.exports = n;
n.prototype.addGridAnimation = function (e) {
  if (0 === Object.keys(e).length) {
    return console.error(new Error("Trying to add animation with no cells!")), null;
  }
  this._gridOverlay.show();
  var t = new a(e, this._gridOverlay);
  return t.playAnimation(), t._listReference = this._layers.addFront(t), this._resetBoundingBox(), t;
};
n.prototype.removeGridLayer = function (e) {
  if (e) {
    e._listReference ? (this._layers.removeByReference(e._listReference), e._listReference = null) : console.error(new Error("GA: _listReference is missing."));
    for (var t, i, n = e.cellInfos, o = Object.keys(n), s = {}, c = this._layers.first; null !== c; c = c.next) {
      for (t = 0; t < o.length; t++) {
        i = o[t];
        c.object.cellInfos[i] && void 0 === s[i] && (s[i] = c.object.cellInfos[i]);
      }
    }
    for (t = 0; t < o.length; t++) {
      i = o[t];
      var d = n[i];
      void 0 === s[i] && (s[i] = new r(i, d.distanceToPlayer, l.empty));
    }
    e._listReference = this._layersBeingRemoved.add(e);
    var u = this,
      h = new a(s, this._gridOverlay);
    h.playAnimation(function () {
      u._resetBoundingBox();
      u._layersBeingRemoved.removeByReference(e._listReference);
      e._listReference = null;
    });
  }
};
n.prototype._resetBoundingBox = function () {
  this._gridOverlay._bbox = [1 / 0, -(1 / 0), 1 / 0, -(1 / 0)];
  for (var e = this._layersBeingRemoved.first; null !== e; e = e.next) {
    this._expandToFitBox(e.object);
  }
  if (0 === this._layers.length) {
    this._gridOverlay.hide();
  } else {
    for (this._layers.length > 64 && console.error("layers are likely leaking"), e = this._layers.first; null !== e; e = e.next) {
      this._expandToFitBox(e.object);
    }
  }
};
n.prototype.clear = function () {
  this._layers.clear();
};
n.prototype._expandToFitPoint = function (e, t) {
  var i = this._gridOverlay._bbox;
  i[0] > e && (i[0] = e);
  i[2] > t && (i[2] = t);
  i[1] < e && (i[1] = e);
  i[3] < t && (i[3] = t);
};
n.prototype._expandToFitBox = function (e) {
  var t = this._gridOverlay._bbox,
    i = e.bbox[0] - 43;
  i < t[0] && (t[0] = i);
  var n = e.bbox[1] + 43;
  n > t[1] && (t[1] = n);
  var o = e.bbox[2] - 22;
  o < t[2] && (t[2] = o);
  var a = e.bbox[3] + 22;
  a > t[3] && (t[3] = a);
};
i = o[t];
c.object.cellInfos[i] && void 0 === s[i] && (s[i] = c.object.cellInfos[i]);
u._resetBoundingBox();
u._layersBeingRemoved.removeByReference(e._listReference);
e._listReference = null;
i[0] > e && (i[0] = e);
i[2] > t && (i[2] = t);
i[1] < e && (i[1] = e);
i[3] < t && (i[3] = t);
a.call(this, e);
this._bbox = [1 / 0, -(1 / 0), 1 / 0, -(1 / 0)];
this._boxByteSize = this.renderer.getNbBytesPerBox();
this.createGrid();
this.forceRefresh();
this._updated = !1;
s(n, a);
e.exports = n;
n.prototype.createGrid = function () {
  this.spriteBoxes = [];
  this._vertexBuffer = new window.ArrayBuffer(r.NB_CELLS * this._boxByteSize);
  for (var e = 0; e < r.NB_CELLS; e++) {
    var t = l.cellCoord[e],
      i = t.x,
      n = i - h,
      a = i + h,
      s = t.y - r.GRID_ALTITUDE_OFFSET,
      d = s + p,
      m = s + u,
      f = new c(i, s, a, d, i, m, n, d),
      g = e * this._boxByteSize,
      _ = new window.Float32Array(this._vertexBuffer, g, this._boxByteSize / 4),
      v = new window.Uint32Array(this._vertexBuffer, g, this._boxByteSize / 4),
      y = new o(e, f, _, v, this);
    this.spriteBoxes[y.cellId] = y;
  }
};
n.prototype._expandToFitPoint = function (e, t) {
  this._bbox[0] > e && (this._bbox[0] = e);
  this._bbox[1] < e && (this._bbox[1] = e);
  this._bbox[2] > t && (this._bbox[2] = t);
  this._bbox[3] < t && (this._bbox[3] = t);
};
n.prototype._expandToFitBox = function (e) {
  this._expandToFitPoint(e.x0, e.y0);
  this._expandToFitPoint(e.x1, e.y1);
  this._expandToFitPoint(e.x2, e.y2);
  this._expandToFitPoint(e.x3, e.y3);
};
n.prototype.draw = function () {
  this.renderer.drawBoxBatch(this.id);
};
n.prototype.render = function () {
  this.renderer.save();
  this.draw(this.renderer);
  this.renderer.restore();
};
n.prototype.remove = function () {};
n.prototype.generateCurrentFrameData = function () {
  this._updated && (this.renderer.releaseBuffer(this.id), this._updated = !1);
  var e = this.renderer.getBufferData(this.id);
  if (void 0 === e) {
    var t = this.id,
      i = !1;
    this.renderer.loadSpriteBuffer(t, this._vertexBuffer, null, this._bbox, i);
    this.renderer.lockBuffer(this.id);
  }
  return this._bbox;
};
n.prototype.clear = function () {
  this.renderer.releaseBuffer(this.id);
};
this.spriteBoxes = [];
this._vertexBuffer = new window.ArrayBuffer(r.NB_CELLS * this._boxByteSize);
this._bbox[0] > e && (this._bbox[0] = e);
this._bbox[1] < e && (this._bbox[1] = e);
this._bbox[2] > t && (this._bbox[2] = t);
this._bbox[3] < t && (this._bbox[3] = t);
this._expandToFitPoint(e.x0, e.y0);
this._expandToFitPoint(e.x1, e.y1);
this._expandToFitPoint(e.x2, e.y2);
this._expandToFitPoint(e.x3, e.y3);
this.renderer.save();
this.draw(this.renderer);
this.renderer.restore();
this.renderer.loadSpriteBuffer(t, this._vertexBuffer, null, this._bbox, i);
this.renderer.lockBuffer(this.id);
this.r = r.r;
this.g = r.g;
this.b = r.b;
this.a = r.a;
this.sx = r.sx;
this.sy = r.sy;
this.rotation = 0;
this.gridOverlay = a;
this._translateX = t.x0;
this._translateY = t.y1;
this._box = t;
this._vertexBuffer = i;
this._colorBuffer = n;
this._restore();
this._translate();
this._fillVertexBuffer();
this.tween = new o(this, ["sx", "sy", "r", "g", "b", "a"]);
this.tween.onUpdate(function () {
  l.setBuffer();
});
this._transformState = s.empty;
e.exports = n;
Object.defineProperty(n.prototype, "cellId", {
  get: function () {
    return this._cellId;
  }
});
n.prototype.animate = function (e, t) {
  this._transformState = e;
  var i = 11;
  return this.tween.reset().wait(t).to(e, i, a.backOut, 2.3).start(), t + i;
};
n.prototype._restore = function () {
  this._x0 = 0;
  this._y0 = -21.5;
  this._x1 = -43;
  this._y1 = 0;
  this._x2 = 0;
  this._y2 = 21.5;
  this._x3 = 43;
  this._y3 = 0;
};
n.prototype._translate = function () {
  this._x0 += this._translateX;
  this._x1 += this._translateX;
  this._x2 += this._translateX;
  this._x3 += this._translateX;
  this._y0 += this._translateY;
  this._y1 += this._translateY;
  this._y2 += this._translateY;
  this._y3 += this._translateY;
};
n.prototype._rotate = function () {
  if (0 !== this.rotation) {
    var e = Math.cos(this.rotation),
      t = Math.sin(this.rotation),
      i = this._x0,
      n = this._x1,
      o = this._x2,
      a = this._x3;
    this._x0 = e * i - t * this._y0;
    this._y0 = t * i + e * this._y0;
    this._x1 = e * n - t * this._y1;
    this._y1 = t * n + e * this._y1;
    this._x2 = e * o - t * this._y2;
    this._y2 = t * o + e * this._y2;
    this._x3 = e * a - t * this._y3;
    this._y3 = t * a + e * this._y3;
  }
};
n.prototype._scale = function () {
  this._x0 *= this.sx;
  this._x1 *= this.sx;
  this._x2 *= this.sx;
  this._x3 *= this.sx;
  this._y0 *= this.sy;
  this._y1 *= this.sy;
  this._y2 *= this.sy;
  this._y3 *= this.sy;
};
n.prototype.setBuffer = function () {
  this._restore();
  this._scale();
  this._rotate();
  this._translate();
  this._fillVertexBuffer();
  this.gridOverlay._updated = !0;
  this.gridOverlay.forceRefresh();
};
n.prototype._fillVertexBuffer = function () {
  var e = Math.max(-128, Math.min(127, 64 * this.r)),
    t = Math.max(-128, Math.min(127, 64 * this.g)),
    i = Math.max(-128, Math.min(127, 64 * this.b)),
    n = Math.max(-128, Math.min(127, 64 * this.a)),
    o = (n << 24 & 4278190080) + (i << 16 & 16711680) + (t << 8 & 65280) + (255 & e);
  this._vertexBuffer[0] = this._x0;
  this._vertexBuffer[1] = this._y0;
  this._colorBuffer[3] = o;
  this._vertexBuffer[5] = this._x1;
  this._vertexBuffer[6] = this._y1;
  this._colorBuffer[8] = o;
  this._vertexBuffer[10] = this._x2;
  this._vertexBuffer[11] = this._y2;
  this._colorBuffer[13] = o;
  this._vertexBuffer[15] = this._x2;
  this._vertexBuffer[16] = this._y2;
  this._colorBuffer[18] = o;
  this._vertexBuffer[20] = this._x3;
  this._vertexBuffer[21] = this._y3;
  this._colorBuffer[23] = o;
  this._vertexBuffer[25] = this._x0;
  this._vertexBuffer[26] = this._y0;
  this._colorBuffer[28] = o;
};
this._x0 = 0;
this._y0 = -21.5;
this._x1 = -43;
this._y1 = 0;
this._x2 = 0;
this._y2 = 21.5;
this._x3 = 43;
this._y3 = 0;
this._x0 += this._translateX;
this._x1 += this._translateX;
this._x2 += this._translateX;
this._x3 += this._translateX;
this._y0 += this._translateY;
this._y1 += this._translateY;
this._y2 += this._translateY;
this._y3 += this._translateY;
this._x0 = e * i - t * this._y0;
this._y0 = t * i + e * this._y0;
this._x1 = e * n - t * this._y1;
this._y1 = t * n + e * this._y1;
this._x2 = e * o - t * this._y2;
this._y2 = t * o + e * this._y2;
this._x3 = e * a - t * this._y3;
this._y3 = t * a + e * this._y3;
this._x0 *= this.sx;
this._x1 *= this.sx;
this._x2 *= this.sx;
this._x3 *= this.sx;
this._y0 *= this.sy;
this._y1 *= this.sy;
this._y2 *= this.sy;
this._y3 *= this.sy;
this._restore();
this._scale();
this._rotate();
this._translate();
this._fillVertexBuffer();
this.gridOverlay._updated = !0;
this.gridOverlay.forceRefresh();
this._vertexBuffer[0] = this._x0;
this._vertexBuffer[1] = this._y0;
this._colorBuffer[3] = o;
this._vertexBuffer[5] = this._x1;
this._vertexBuffer[6] = this._y1;
this._colorBuffer[8] = o;
this._vertexBuffer[10] = this._x2;
this._vertexBuffer[11] = this._y2;
this._colorBuffer[13] = o;
this._vertexBuffer[15] = this._x2;
this._vertexBuffer[16] = this._y2;
this._colorBuffer[18] = o;
this._vertexBuffer[20] = this._x3;
this._vertexBuffer[21] = this._y3;
this._colorBuffer[23] = o;
this._vertexBuffer[25] = this._x0;
this._vertexBuffer[26] = this._y0;
this._colorBuffer[28] = o;
this.cellInfos = e;
this._gridOverlay = t;
this.bbox = [1 / 0, -(1 / 0), 1 / 0, -(1 / 0)];
this._listReference = null;
e.exports = n;
n.prototype.playAnimation = function (e) {
  for (var t = -(1 / 0), i = this._gridOverlay.spriteBoxes, n = Object.keys(this.cellInfos), a = 0; a < n.length; a++) {
    var s = n[a],
      r = this.cellInfos[s],
      l = i[s],
      c = r.transformState;
    if (l.transformState !== c) {
      var d = l.animate(c, .6 * r.distanceToPlayer);
      t < d && (t = d);
      this._expandToFitBox(l);
    }
  }
  if (e) {
    if (t <= 0) {
      return e();
    }
    new o(t, e).start();
  }
};
n.prototype._expandToFitPoint = function (e, t) {
  this.bbox[0] > e && (this.bbox[0] = e);
  this.bbox[2] > t && (this.bbox[2] = t);
  this.bbox[1] < e && (this.bbox[1] = e);
  this.bbox[3] < t && (this.bbox[3] = t);
};
n.prototype._expandToFitBox = function (e) {
  this._expandToFitPoint(e._x0, e._y0);
  this._expandToFitPoint(e._x1, e._y1);
  this._expandToFitPoint(e._x2, e._y2);
  this._expandToFitPoint(e._x3, e._y3);
};
t < d && (t = d);
this._expandToFitBox(l);
this.bbox[0] > e && (this.bbox[0] = e);
this.bbox[2] > t && (this.bbox[2] = t);
this.bbox[1] < e && (this.bbox[1] = e);
this.bbox[3] < t && (this.bbox[3] = t);
this._expandToFitPoint(e._x0, e._y0);
this._expandToFitPoint(e._x1, e._y1);
this._expandToFitPoint(e._x2, e._y2);
this._expandToFitPoint(e._x3, e._y3);
o.call(this, n);
this.red = 0;
this.green = 0;
this.blue = 0;
this.stopped = !1;
this._defineShape(i);
this._tween = new r(this, ["scaleX", "scaleY", "red", "green", "blue", "alpha"]);
this._tween.onUpdate(function () {
  var e = a.tint;
  e[0] = a.red;
  e[1] = a.green;
  e[2] = a.blue;
});
e[0] = a.red;
e[1] = a.green;
e[2] = a.blue;
a(n, o);
e.exports = n;
n.prototype.draw = function () {
  this.renderer.drawBoxBatch(this.id);
};
n.prototype._defineShape = function (e) {
  this._x0 = 16;
  this._y0 = e;
  this._x1 = 23;
  this._y1 = -s.VERTICAL_OFFSET;
  this._x2 = -23;
  this._y2 = -s.VERTICAL_OFFSET;
  this._x3 = -16;
  this._y3 = e;
  this._x4 = 20;
  this._y4 = -s.VERTICAL_OFFSET;
  this._x5 = -20;
  this._y5 = -s.VERTICAL_OFFSET;
  this._bbox = [this._x2, this._x1, this._y1, this._y0];
  var t = this.renderer.getNbBytesPerVertex(),
    i = new window.ArrayBuffer(12 * t);
  this._vertexBuffer = new window.Float32Array(i);
  this._colorBuffer = new window.Uint32Array(i);
  var n = 1077952576,
    o = 4210752;
  this._vertexBuffer[0] = this._x0;
  this._vertexBuffer[1] = this._y0;
  this._colorBuffer[3] = o;
  this._vertexBuffer[5] = this._x1;
  this._vertexBuffer[6] = this._y1;
  this._colorBuffer[8] = o;
  this._vertexBuffer[10] = this._x4;
  this._vertexBuffer[11] = this._y4;
  this._colorBuffer[13] = n;
  this._vertexBuffer[15] = this._x0;
  this._vertexBuffer[16] = this._y0;
  this._colorBuffer[18] = o;
  this._vertexBuffer[20] = this._x4;
  this._vertexBuffer[21] = this._y4;
  this._colorBuffer[23] = n;
  this._vertexBuffer[25] = this._x5;
  this._vertexBuffer[26] = this._y5;
  this._colorBuffer[28] = n;
  this._vertexBuffer[30] = this._x0;
  this._vertexBuffer[31] = this._y0;
  this._colorBuffer[33] = o;
  this._vertexBuffer[35] = this._x5;
  this._vertexBuffer[36] = this._y5;
  this._colorBuffer[38] = n;
  this._vertexBuffer[40] = this._x3;
  this._vertexBuffer[41] = this._y3;
  this._colorBuffer[43] = o;
  this._vertexBuffer[45] = this._x2;
  this._vertexBuffer[46] = this._y2;
  this._colorBuffer[48] = o;
  this._vertexBuffer[50] = this._x3;
  this._vertexBuffer[51] = this._y3;
  this._colorBuffer[53] = o;
  this._vertexBuffer[55] = this._x5;
  this._vertexBuffer[56] = this._y5;
  this._colorBuffer[58] = n;
};
n.prototype.animate = function (e, t) {
  var i = {
      scaleX: e.sx,
      scaleY: e.sy,
      red: e.r,
      green: e.g,
      blue: e.b,
      alpha: e.a
    },
    n = {
      scaleX: t.sx,
      scaleY: t.sy,
      red: t.r,
      green: t.g,
      blue: t.b,
      alpha: t.a
    },
    o = this;
  this._tween.reset().from({
    scaleX: e.sx / 2,
    scaleY: e.sy,
    red: e.r,
    green: e.g,
    blue: e.b,
    alpha: 0
  }, l.polyOut, 4).to(i, 6).onFinish(function () {
    this.stopped || o._tween.reset().from(i).to(n, 20, l.trigo, 1).start(!0);
  }).start();
};
n.prototype.stop = function () {
  this._tween.stop();
  this.stopped = !0;
};
n.prototype.generateCurrentFrameData = function () {
  var e = this.renderer.getBufferData(this.id);
  if (void 0 === e) {
    var t = this.id,
      i = !1;
    this.renderer.loadSpriteBuffer(t, this._vertexBuffer, null, this._bbox, i);
    this.renderer.lockBuffer(this.id);
  }
  return this._bbox;
};
n.prototype.clear = function () {
  this.renderer.releaseBuffer(this.id);
};
this._x0 = 16;
this._y0 = e;
this._x1 = 23;
this._y1 = -s.VERTICAL_OFFSET;
this._x2 = -23;
this._y2 = -s.VERTICAL_OFFSET;
this._x3 = -16;
this._y3 = e;
this._x4 = 20;
this._y4 = -s.VERTICAL_OFFSET;
this._x5 = -20;
this._y5 = -s.VERTICAL_OFFSET;
this._bbox = [this._x2, this._x1, this._y1, this._y0];
this._vertexBuffer = new window.Float32Array(i);
this._colorBuffer = new window.Uint32Array(i);
this._vertexBuffer[0] = this._x0;
this._vertexBuffer[1] = this._y0;
this._colorBuffer[3] = o;
this._vertexBuffer[5] = this._x1;
this._vertexBuffer[6] = this._y1;
this._colorBuffer[8] = o;
this._vertexBuffer[10] = this._x4;
this._vertexBuffer[11] = this._y4;
this._colorBuffer[13] = n;
this._vertexBuffer[15] = this._x0;
this._vertexBuffer[16] = this._y0;
this._colorBuffer[18] = o;
this._vertexBuffer[20] = this._x4;
this._vertexBuffer[21] = this._y4;
this._colorBuffer[23] = n;
this._vertexBuffer[25] = this._x5;
this._vertexBuffer[26] = this._y5;
this._colorBuffer[28] = n;
this._vertexBuffer[30] = this._x0;
this._vertexBuffer[31] = this._y0;
this._colorBuffer[33] = o;
this._vertexBuffer[35] = this._x5;
this._vertexBuffer[36] = this._y5;
this._colorBuffer[38] = n;
this._vertexBuffer[40] = this._x3;
this._vertexBuffer[41] = this._y3;
this._colorBuffer[43] = o;
this._vertexBuffer[45] = this._x2;
this._vertexBuffer[46] = this._y2;
this._colorBuffer[48] = o;
this._vertexBuffer[50] = this._x3;
this._vertexBuffer[51] = this._y3;
this._colorBuffer[53] = o;
this._vertexBuffer[55] = this._x5;
this._vertexBuffer[56] = this._y5;
this._colorBuffer[58] = n;
this._tween.stop();
this.stopped = !0;
this.renderer.loadSpriteBuffer(t, this._vertexBuffer, null, this._bbox, i);
this.renderer.lockBuffer(this.id);
r.call(this, e);
this.indexText = document.createElement("canvas");
this.indexText.width = e.w;
this.indexText.height = e.h;
this.indexTextContext = this.indexText.getContext("2d");
this.indexTextContext.font = "20px Verdana";
this.indexTextContext.fillStyle = "rgba(0,0,0,0.6)";
this.indexTextContext.textAlign = "center";
s(n, r);
e.exports = n;
n.prototype.generateOverlay = function (e) {
  this._generateOverlay(e);
};
n.prototype._generateOverlay = function (e, t, i) {
  var n = window.isoEngine.mapRenderer;
  if (n.map && n.map.cells) {
    var s = n.map.cells;
    "string" == typeof e && (this.indexTextContext.fillStyle = e);
    this.indexTextContext.clearRect(0, 0, this.indexText.width, this.indexText.height);
    for (var r = 0; r < o.NB_CELLS; r++) {
      var l = n.isWalkable(r);
      if (l) {
        var h = s[r],
          p = a.cellCoord[r],
          m = h.f ? h.f + d : d,
          f = p.x,
          g = p.y - m;
        if (t && t.indexOf(r) >= 0) {
          var _ = this.indexTextContext.fillStyle;
          this.indexTextContext.fillStyle = i;
          this.indexTextContext.fillText(r, f + u + 10, g + c);
          this.indexTextContext.fillStyle = _;
        } else {
          this.indexTextContext.fillText(r, f + u + 10, g + c);
        }
      }
    }
    this.texture && this.texture.release();
    this.texture = window.isoEngine.mapScene.createTexture(this.indexText);
    this.show();
  }
};
n.prototype.clear = function () {
  this.texture ? (this.texture.release(), this.texture = null) : console.warn("[CellIdOverlay.clear] Clearing CellIdOverlay although no texture was ever set");
  this.hide();
};
n.prototype.colorCells = function (e, t) {
  this._generateOverlay(null, e, t);
};
"string" == typeof e && (this.indexTextContext.fillStyle = e);
this.indexTextContext.clearRect(0, 0, this.indexText.width, this.indexText.height);
this.indexTextContext.fillStyle = i;
this.indexTextContext.fillText(r, f + u + 10, g + c);
this.indexTextContext.fillStyle = _;
this.texture && this.texture.release();
this.texture = window.isoEngine.mapScene.createTexture(this.indexText);
this.show();
this.texture ? (this.texture.release(), this.texture = null) : console.warn("[CellIdOverlay.clear] Clearing CellIdOverlay although no texture was ever set");
this.hide();
a.prototype.actorManager = this;
this.isoEngine = e.isoEngine;
this.scene = e.scene;
this.isTransparentModeOn = !1;
this.isCreatureModeOn = !1;
this.paused = !0;
this.actors = {};
this._occupiedCells = {};
this.followers = [];
this.customAnimMethods = {};
this.userId = 0;
this.userActor = new a({
  data: {
    _type: "GameRolePlayCharacterInformations"
  },
  scene: this.scene,
  actorManager: this
});
this.userActor.setWhiteListedness(!0);
this.fighterIndicator = null;
this._onIdAdded = {};
this._queuedToCarryActors = {};
this._nickNamesOn = !1;
this._fullNicknameLabelCount = 0;
this._setupListeners();
e.exports = o;
o.prototype.getOccupiedCells = function () {
  return this._occupiedCells;
};
o.prototype.getActorsOnCell = function (e) {
  return this.getOccupiedCells()[e] || [];
};
o.prototype.getActorsOnCellByTypes = function (e) {
  for (var t = this.getActorsOnCell(e), i = {
      onlinePlayer: [],
      npc: [],
      other: []
    }, n = 0; n < t.length; n += 1) {
    var o = t[n];
    o.isNPC() ? i.npc.push(o) : o.isPlayer() ? i.onlinePlayer.push(o) : i.other.push(o);
  }
  return i;
};
o.prototype._setupListeners = function () {
  var e = this;
  this.isoEngine.on("GameFightSynchronizeMessage", function (t) {
    for (var i = t.fighters, n = 0, o = i.length; n < o; n++) {
      var a = i[n];
      if (a.alive) {
        var s = a.contextualId,
          r = e.getActor(s);
        if (r) {
          var l = a.disposition.cellId;
          l === -1 || r.cellId === l || r.moving || r.setDisposition(l, null);
        } else {
          e.addEmptyActor(a);
        }
      }
    }
  });
  f.on("gameContextChanged", this.onGameContextChanged.bind(this));
  s.on("maxTitlesOrnaments", this.optionModifiedMaxTitlesOrnaments.bind(this));
  m.on("MapNpcsQuestStatusUpdateMessage", function (t) {
    e.updateQuestIcons(t);
  });
};
o.prototype.optionModifiedMaxTitlesOrnaments = function () {
  this.resetNicknames();
};
o.prototype.resetNicknames = function () {
  var e = window.isoEngine.mapRenderer;
  this._nickNamesOn && (e.isReady ? (this.turnNicknamesOff(), this.turnNicknamesOn()) : e.once("ready", this.resetNicknames.bind(this)));
};
o.prototype.onGameContextChanged = function () {
  f.isRoleplayMode && this.cleanupActorAnimations();
  this.resetNicknames();
};
o.prototype.removeInvisibilityOfAllActors = function () {
  var e = u.VISIBLE;
  this.userActor.setInvisibility(e);
  for (var t in this.actors) {
    this.actors[t].setInvisibility(e);
  }
};
o.prototype.cleanupActorAnimations = function () {
  this.userActor.cleanupAnimations();
  for (var e in this.actors) {
    this.actors[e].cleanupAnimations();
  }
};
o.prototype.isActorInvisible = function (e) {
  var t = this.getActor(e);
  return !!t && t.isInvisible;
};
o.prototype.getActor = function (e) {
  var t = e === this.userId ? this.userActor : this.actors[e];
  return t;
};
o.prototype.getActorFromNpcId = function (e) {
  var t = this.actors;
  for (var i in t) {
    var n = t[i];
    if (n.isNPC() && (n.data.npcId === e || e === -1)) {
      return n;
    }
  }
  return null;
};
o.prototype.getActorFromMonsterId = function (e) {
  var t = this.actors;
  for (var i in t) {
    var n = t[i],
      o = n.data || {},
      a = o.staticInfos;
    if (o.creatureGenericId && o.creatureGenericId === e) {
      return n;
    }
    if (a && a.mainCreatureLightInfos && (a.mainCreatureLightInfos.creatureGenericId === e || e === -1)) {
      return n;
    }
  }
  return null;
};
o.prototype.getActorData = function (e, t) {
  var i = this.getActor(e);
  return i ? t(null, i.data) : t(new Error("actorNotFound"));
};
o.prototype.pause = function () {
  this.paused = !0;
};
o.prototype.unpause = function () {
  this.paused = !1;
};
o.prototype.setUserCharacterData = function (e) {
  var t = e.id,
    i = e.entityLook;
  this.userId = t;
  this.userActor.actorId = t;
  this.userActor.actorManager = this;
  this.userActor.data.name = e.name;
  this.userActor.data.playerId = t;
  this.setActorLook(t, i, {}, null);
};
o.prototype.switchUserActor = function (e) {
  if (this.userId !== e) {
    var t = this.getActor(e);
    if (!t) {
      return console.error("switchUserActor: No actor with id", e);
    }
    var i = this.userActor.isDead,
      n = this.userId;
    this.actors[n] = this.userActor;
    this.userId = e;
    this.userActor = t;
    delete this.actors[e];
    i ? this.removeActor(n) : window.isoEngine.tryDisplayUserMovementZone();
  }
};
o.prototype.setActorLook = function (e, t, i, o) {
  var a = o || n,
    s = this.getActor(e);
  if (!s) {
    return console.warn("amsal: No actor with id", e), a();
  }
  if (s.animated || s.emoteAnimated && s.hasSameLook(t)) {
    return a();
  }
  t || console.error(new Error("amsal: The look is missing."));
  var r = I[e];
  return r || (I[e] = _.createFifo(), r = I[e]), r.push(function (e) {
    function n(e, t) {
      s.staticAnim(function () {
        return e(), t();
      });
    }
    return s.riderEntity = null, s.setLook(t, i, function () {
      var t = s.animManager;
      s.isFollower && (t.audioVol = C);
      var i = s.look;
      if (s.carriedEntity) {
        var o = s.riderEntity || s.animManager;
        return o.addAnimation({
          base: "carrying",
          direction: -1
        }, function () {
          return o.addAnimationModifier("AnimStatique", "AnimStatiqueCarrying"), o.addAnimationModifier("AnimMarche", "AnimMarcheCarrying"), o.addAnimationModifier("AnimCourse", "AnimCourseCarrying"), o.addAnimationModifier("AnimHit", "AnimHitCarrying"), o.addAnimationModifier("AnimTacle", "AnimTacleCarrying"), n(e, a);
        });
      }
      return 1 === i.bonesId && i.skins && i.skins[0] && d[i.skins[0]] && t.addAnimationModifier("AnimStatique", "AnimStatique" + i.skins[0]), n(e, a);
    });
  });
};
o.prototype.getIndexedVisibleActors = function (e) {
  var t = {};
  for (var i in this.actors) {
    if (this.actors.hasOwnProperty(i)) {
      var n = this.actors[i],
        o = !n.isInvisible;
      e && e.showAlsoInvisibleInMyTeam && (o = _.isActorVisibleToUser(i));
      o && (t[n.cellId] = n);
    }
  }
  return t[this.userActor.cellId] = this.userActor, t;
};
o.prototype.addToFifo = function (e, t) {
  var i = this.getActor(e);
  if (!i) {
    return t();
  }
  var n = I[e];
  return n || (I[e] = _.createFifo(), n = I[e]), n.push(t);
};
o.prototype.removeAllActors = function () {
  this.cleanupActorAnimations();
  var e = window.gui.playerData.characters.mainCharacterId;
  e > 0 && this.switchUserActor(e);
  for (var t in this.actors) {
    this.actors[t].removeTeamCircle();
    this.actors[t].remove();
  }
  this.actors = {};
  this._occupiedCells = {};
  this.followers = [];
  this.customAnimMethods = {};
};
o.prototype.updateMapInfoData = function (e, t) {
  var i = this;
  if (!window.gui.isConnected) {
    return t && t();
  }
  var n = this.userActor;
  if (window.gui.playerData.isSpectator || n.show(), f.isFightMode) {
    return t && t();
  }
  var o,
    a,
    s,
    r = e.actors,
    l = r.length,
    c = 0;
  for (o = 0; o < l; o++) {
    s = r[o];
    a = this.getActor(s.contextualId);
    a || (c += 1);
    var d = s.staticInfos && s.staticInfos.underlings;
    c += d ? d.length : 0;
  }
  this.checkCreatureMode(c);
  v.each(r, function (e, t) {
    var o = e.contextualId;
    o === i.userId && (n.removeIcons(), i.isoEngine.userPreviousPosition = e.disposition.cellId);
    a = i.getActor(o);
    a ? a.updateData(e) : a = i.addEmptyActor(e);
    e.staticInfos && e.staticInfos.underlings && i.addActorFollowers(a, e.staticInfos.underlings);
    a.animated && a.staticAnim();
    i.setActorLook(o, e.look, {}, function () {
      for (var i = e.humanoidInfo ? e.humanoidInfo.options : [], n = 0; n < i.length; n++) {
        var a = i[n];
        if ("HumanOptionEmote" === a._type) {
          return window.isoEngine.playEmoteFromOption(o, a, t);
        }
      }
      return t();
    });
  }, function (e) {
    return e && console.warn("An emote could not be played ", e), i.resetNicknames(), t && t();
  });
};
o.prototype.updateQuestIcons = function (e) {
  if (e.mapId === this.isoEngine.mapRenderer.mapId) {
    var t,
      i = this.actors,
      n = e.npcsIdsWithQuest;
    for (var o in i) {
      t = i[o];
      t.isNPC() && n.indexOf(t.actorId) === -1 && t.removeQuestIcon();
    }
    for (var a = 0; a < n.length; a++) {
      t = this.getActor(n[a]);
      t && t.addQuestIcon(e.questFlags[a]);
    }
  }
};
o.prototype.addActor = function (e, t) {
  var i = this,
    n = e.contextualId,
    o = !0,
    a = this.getActor(n);
  a ? (a.updateData(e), o = !1) : a = this.addEmptyActor(e);
  var s = function () {
    for (var t in i._queuedToCarryActors) {
      var n = i.getActor(t);
      n === a && (n.carryCharacter(i._queuedToCarryActors[t]), delete i._queuedToCarryActors[t]);
    }
    var o = e.disposition && e.disposition.carryingCharacterId;
    if (o) {
      var s = i.getActor(o);
      s ? s.carryCharacter(a) : i._queuedToCarryActors[o] = a;
    }
  };
  this.setActorLook(n, e.look, {}, function () {
    return e.staticInfos && e.staticInfos.underlings && i.addActorFollowers(a, e.staticInfos.underlings), s(), t && t(i.actors[n]);
  });
  var r = a.getFighter();
  return window.gui.playerData.isFighting && !a.isFollower && r && a.addTeamCircle(), this.addedActor(a.actorId), this._attachOrUpdateNicknameLabel(a, o), a;
};
o.prototype._attachOrUpdateNicknameLabel = function (e, t) {
  var i = this._nickNamesOn && e.isPlayer() && e.isDisplayed && !e.isInvisible;
  i && (t || !e.nicknameLabel ? this._attachNicknameLabel(e) : ("full" === e.nicknameLabel.getType() && this._fullNicknameLabelCount--, e.updateNicknameLabel(f.isRoleplayMode && this._fullNicknameLabelCount < s.maxTitlesOrnaments), "full" === e.nicknameLabel.getType() && this._fullNicknameLabelCount++));
};
o.prototype.addEmptyActor = function (e) {
  var t = e.contextualId,
    i = this.getActor(t);
  if (i) {
    return i;
  }
  var n = e.disposition,
    o = n.cellId,
    s = n.direction;
  return i = new a({
    actorId: t,
    position: o,
    cellId: o,
    direction: s,
    data: e,
    scene: this.scene,
    layer: this.isTransparentModeOn ? c.MAP_LAYER_TRANSPARENT : c.MAP_LAYER_PLAYGROUND,
    alpha: this.isTransparentModeOn ? c.TRANSPARENT_MODE_ALPHA : 1,
    actorManager: this
  }), this.actors[t] = i, i.startAnimBehaviour(), i.setDisposition(o, s), i;
};
o.prototype.removeActor = function (e, t) {
  var i,
    n = this;
  if (e === this.userId) {
    if (i = this.userActor, !i.isDead) {
      return;
    }
  } else {
    i = this.actors[e];
  }
  return i ? t || !i.moving && !i.animated ? void i.remove() : void i.pathTween.onceFinish(function () {
    n.getActor(e) && n.removeActor(e);
  }) : console.warn("[ACTOR MANAGER] removeActor: actor not found", e);
};
o.prototype._removeActor = function (e) {
  var t = !1;
  e.fighterIndicator && e.fighterIndicator.remove();
  e.removeTurnNumber();
  var i = e.actorId;
  this.removeActorOccupation(e);
  this.customAnimMethods[i] && delete this.customAnimMethods[i];
  e.nicknameLabel && ("full" === e.nicknameLabel.getType() && (this._fullNicknameLabelCount--, t = !0), e.removeNicknameLabel());
  e.removeTeamCircle();
  delete this.actors[i];
  e.followers && this.removeActorFollowers(e);
  t && this.refreshNicknames();
};
o.prototype.removeActors = function (e, t) {
  for (var i = 0, n = e.length; i < n; i++) {
    this.removeActor(e[i], t);
  }
};
o.prototype.resetActors = function () {
  this.removeAllActors();
  this.userActor.show();
};
o.prototype.actorMovement = function (e, t) {
  var i = e.actorId,
    n = e.keyMovements,
    o = n[n.length - 1],
    a = window.isoEngine;
  if (f.isRoleplayMode && i === this.userId) {
    return a.roleplayUserActorMovement(n);
  }
  var s = this.getActor(i);
  return s ? (s.setCellPosition(o), this.paused ? (s.position = o, t && t()) : (2 === n.length && (n = l.normalizePath(n)), n.length > 1 ? void (this.isoEngine.mapRenderer.isReady ? s.setPath(n, {
    slide: e.slide,
    cb: t
  }) : s.setDisposition(o)) : t && t())) : (this.addEmptyActor({
    contextualId: i,
    disposition: {
      cellId: o,
      direction: 1
    }
  }), t && t());
};
o.prototype.setActorsDisposition = function (e, t) {
  for (var i = 0, n = e.length; i < n; i++) {
    var o = e[i];
    if (o.cellId !== -1) {
      var a = o.id,
        s = this.getActor(a);
      if (!s) {
        if (t) {
          continue;
        }
        if (!o.cellId && 0 !== o.cellId) {
          continue;
        }
        var r = window.gui.fightManager.getFighter(a);
        if (r && r.data && !r.data.alive) {
          continue;
        }
        s = this.addEmptyActor({
          contextualId: a,
          disposition: o
        });
      }
      s.cellId === o.cellId && s.direction === o.direction || (s.setDisposition(o.cellId, o.direction), s.emoteAnimated && s.lastEmoteAnim && s.loadAndPlayAnimation({
        base: "AnimEmote",
        type: s.lastEmoteAnim
      }, {
        loop: !1,
        isEmoteAnimated: !0
      }));
    }
  }
};
o.prototype.removeActorOccupation = function (e) {
  var t = e.cellId;
  if (null !== t) {
    var i = this._occupiedCells[t];
    if (void 0 === i) {
      return;
    }
    var n = i.indexOf(e);
    n === -1 ? console.warn("[ActorManager.removeActorOccupation] Trying to remove an actor from an empty cell", e) : 1 === i.length ? delete this._occupiedCells[t] : i.splice(n, 1);
  }
};
o.prototype.addActorOccupation = function (e) {
  var t = e.cellId,
    i = this._occupiedCells[t];
  if (void 0 === i) {
    this._occupiedCells[t] = [e];
  } else {
    var n = i.indexOf(e);
    n === -1 ? i.push(e) : console.warn("[ActorManager.addActorOccupation] Trying to add an actor to a cell that it already belongs to", e);
  }
};
o.prototype.computeFollowerPosition = function (e) {
  var t = r.getMapPointFromCellId(e);
  t.i = t.x;
  t.j = t.y;
  for (var i = 1; Math.random() < i;) {
    var n = l.getAccessibleCells(t.i, t.j),
      o = n.length;
    if (0 === o) {
      break;
    }
    for (var a = [], s = 0, c = 0; c < o; c++) {
      var d = n[c],
        u = r.getCellIdFromMapPoint(d.i, d.j),
        h = void 0 === this._occupiedCells[u] ? 1 : y;
      a[c] = h;
      s += h;
    }
    for (var p = 0, m = s * Math.random() - a[0]; m > 0 && p < o;) {
      p += 1;
      m -= a[p];
    }
    t = n[p === o ? p - 1 : p];
    e = r.getCellIdFromMapPoint(t.i, t.j);
    i = this._occupiedCells[e] ? .995 : .8;
  }
  return e;
};
o.prototype.addActorFollowers = function (e, t, i) {
  var n = t.length;
  if (0 !== n && (s.showAllMonsters || i)) {
    null === e.followers && (e.followers = []);
    for (var o = e.actorId, a = 0; a < n; a++) {
      var r = t[a],
        l = o + ":follower:" + a,
        c = this.getActor(l);
      if (!c) {
        var d = this.computeFollowerPosition(e.cellId);
        c = this.addEmptyActor({
          contextualId: l,
          disposition: {
            cellId: d,
            direction: 1 + 2 * Math.round(3 * Math.random())
          }
        });
        c.isFollower = !0;
        i === !0 ? c.isolationCoefficient = T : (c.isolationCoefficient = M, r.staticInfos && r.staticInfos.isMiniBoss ? c.addIcon("miniBoss") : c.removeIcon("miniBoss"), r.staticInfos || console.error("ActorManager#addActorFollowers: no staticInfos", "actorId:", o, "followerId:", l));
        e.followers.push(c);
        c.groupBoss = e;
        c.data = e.data;
        this.followers.push(c);
      }
      this.setActorLook(l, r.look, {}, null);
    }
  }
};
o.prototype.removeActorFollowers = function (e, t) {
  var i = e.followers;
  e.followers = [];
  var n = [];
  if (i && i.length) {
    for (var o = 0; o < i.length; o++) {
      var a = i[o];
      n.push(a.actorId);
      var s = this.followers.indexOf(a);
      s !== -1 && this.followers.splice(s, 1);
    }
    this.removeActors(n, t);
  }
};
o.prototype.addAnimBehaviourToActor = function (e, t) {
  var i = this.actors[e];
  return i ? this.customAnimMethods[e] ? console.warn("ActorManager.addAnimBehaviourToActor: actor " + e + " already has a custom animation") : this.followers.indexOf(i) !== -1 ? console.error(new Error("ActorManager.addAnimBehaviourToActor: cannot add an anim behaviour to a follower")) : "function" != typeof t ? console.error(new Error("ActorManager.addAnimBehaviourToActor: animationMethod is not a function")) : void (this.customAnimMethods[e] = t) : console.error(new Error("ActorManager.addAnimBehaviourToActor: actor " + e + " unknown"));
};
o.prototype._moveFollower = function (e) {
  if (e.moving !== !0) {
    var t = e.cellId,
      i = r.getMapPointFromCellId(t),
      n = r.getMapPointFromCellId(e.groupBoss.cellId),
      o = i.x,
      a = i.y,
      s = n.x - o,
      c = n.y - a,
      d = Math.sqrt(s * s + c * c);
    if (1 === this._occupiedCells[t].length) {
      var u = .95 / (1 + (d - 1) * e.isolationCoefficient);
      if (e.groupBoss.moving === !0 && (u *= .8), Math.random() < u) {
        return;
      }
    }
    for (var h, p = {
        i: i.x,
        j: i.y
      }, m = [t], f = 1; Math.random() < f;) {
      var g = l.getAccessibleCells(p.i, p.j),
        _ = g.length;
      if (0 === _) {
        return;
      }
      for (var v = [], b = 0, M = 0; M < _; M++) {
        var T = g[M],
          C = r.getCellIdFromMapPoint(T.i, T.j),
          I = void 0 === this._occupiedCells[C] ? 1 : y,
          A = T.i - p.i,
          S = T.j - p.j;
        I *= 0 === A && 0 === S ? y * y : 0 === A ? Math.pow(w, c / S) : Math.pow(w, s / A);
        v[M] = I;
        b += I;
      }
      for (var E = 0, N = b * Math.random() - v[0]; N > 0 && E < _;) {
        E += 1;
        N -= v[E];
      }
      p = g[E === _ ? E - 1 : E];
      h = r.getCellIdFromMapPoint(p.i, p.j);
      m.push(h);
      f = 1 - 1 / (1 + .5 * d);
    }
    e.setCellPosition(h);
    e.setPath(m);
  }
};
o.prototype.refresh = function () {
  for (var e in this.customAnimMethods) {
    this.customAnimMethods[e]();
  }
  var t = this.followers.length;
  if (t > 0) {
    var i = Object.keys(this.actors).length;
    if (Math.random() > Math.min(.1, b / i)) {
      return;
    }
    for (var n = 0; n < t; n++) {
      this._moveFollower(this.followers[n]);
    }
  }
};
o.prototype.updateActorsAggressableStatus = function (e, t) {
  for (var i = 0; i < e.length; i++) {
    var n = e[i],
      o = t[i],
      a = this.getActor(n);
    if (a && a.data.humanoidInfo && a.data.humanoidInfo.options) {
      for (var s = a.data.humanoidInfo.options, r = 0; r < s.length; r++) {
        var l = s[r];
        if ("HumanOptionAlliance" === l._type) {
          l.aggressable = o;
          a.addConquestIcon(l);
          break;
        }
      }
    }
  }
};
o.prototype.addSmileyOnActor = function (e, t) {
  var i = this.getActor(e);
  i && i.addSmileyIcon(t);
};
o.prototype.setReadyIconOnActor = function (e, t) {
  void 0 === t && (t = !1);
  var i = this.getActor(e);
  i && (t ? i.addReadyIconOnActor() : i.removeReadyIconOnActor());
};
o.prototype.removeReadyIcon = function () {
  for (var e = Object.keys(this.actors), t = e.length, i = 0; i < t; i++) {
    var n = this.actors[e[i]];
    n.removeReadyIconOnActor();
  }
  this.userActor.removeReadyIconOnActor();
};
o.prototype.setTransparentMode = function (e) {
  if (this.isTransparentModeOn !== e) {
    var t, i;
    e ? (t = c.MAP_LAYER_TRANSPARENT, i = c.TRANSPARENT_MODE_ALPHA) : (t = c.MAP_LAYER_PLAYGROUND, i = 1);
    for (var n in this.actors) {
      var o = this.actors[n];
      o.layer = t;
      o.alpha = i;
    }
    this.userActor.layer = t;
    this.userActor.alpha = i;
    this.isTransparentModeOn = e;
  }
};
o.prototype.checkCreatureMode = function (e) {
  var t = Object.keys(this.actors).length + e + 1,
    i = s.maxActorsBeforeCreatureMode < t;
  i = i || g.getValue("creatureMode", !1);
  this.setCreatureMode(i);
};
o.prototype.onMaxActorsBeforeCreatureModeChange = function (e) {
  var t = Object.keys(this.actors).length + 1,
    i = e < t;
  i = i || g.getValue("creatureMode", !1);
  this.setCreatureMode(i);
};
o.prototype.setCreatureMode = function (e) {
  if (e !== this.isCreatureModeOn) {
    if (!e) {
      return this._exitCreatureMode();
    }
    this.isCreatureModeOn = !0;
    this.userActor.carriedEntity || this.userActor.setCreatureLook({}, null);
    for (var t in this.actors) {
      var i = this.actors[t];
      i.setCreatureLook({}, null);
      i.fighterIndicator && (i.fighterIndicator.y = i.bbox[2] - i.y);
    }
    this.userActor.carriedEntity && this.userActor.setCreatureLook({}, null);
  }
};
o.prototype._exitCreatureMode = function () {
  if (this.isCreatureModeOn) {
    this.isCreatureModeOn = !1;
    this.userActor.carriedEntity || this.userActor.useRealLook();
    for (var e in this.actors) {
      var t = this.actors[e];
      t.useRealLook();
      t.fighterIndicator && (t.fighterIndicator.y = t.bbox[2] - t.y);
    }
    this.userActor.carriedEntity && this.userActor.useRealLook();
  }
};
o.prototype.getPlayers = function (e) {
  var t = [];
  for (var i in this.actors) {
    var n = this.actors[i];
    n.data && (n.data.playerId || 0 === n.data.playerId) && t.push(n);
  }
  return e && t.push(this.userActor), t;
};
o.prototype.getActorsIDList = function () {
  var e = [];
  for (var t in this.actors) {
    var i = this.actors[t];
    e.push(i.actorId);
  }
  return e.push(this.userActor.actorId), e;
};
o.prototype.turnIndicatorOff = function () {
  window.isoEngine.mapRenderer.removeMovementFeedback();
};
o.prototype.turnIndicatorOn = function (e) {
  if (window.isoEngine.mapRenderer.map) {
    this.turnIndicatorOff();
    var t = this.getActor(e.id);
    if (t) {
      var i = t.getFighterData(),
        n = t.getTeamId(),
        o = e.data.disposition.cellId;
      if (o !== -1) {
        if (i.isCarryied && t.parentActor) {
          var a = t.parentActor.bbox[2] + (t.bbox[3] - t.bbox[2]);
          h.addTurnFeedback({
            x: t.parentActor.x,
            y: a,
            position: o
          }, n);
        } else {
          h.addTurnFeedback({
            x: t.x,
            y: t.y,
            position: o
          }, n);
        }
      }
    }
  }
};
o.prototype.removeTeamCircles = function () {
  this.userActor.removeTeamCircle();
  for (var e = 0; e < this.actors.length; e++) {
    var t = this.actors[e];
    t.removeTeamCircle();
  }
};
o.prototype.selectionIndicatorOff = function (e) {
  var t = this.getActor(e.id);
  t && t.fighterIndicator && t.fighterIndicator.remove();
};
o.prototype.selectionIndicatorOn = function (e) {
  var t = this.getActor(e.id);
  t && (t.fighterIndicator && t.fighterIndicator.remove(), e.data.disposition.cellId !== -1 && (t.fighterIndicator = new p(t.x, t.bbox[2] - 12)));
};
o.prototype.removeAllFighterIndicators = function () {
  this.userActor.fighterIndicator && this.userActor.fighterIndicator.remove();
  for (var e = 0; e < this.actors.length; e++) {
    var t = this.actors[e];
    t.fighterIndicator && t.fighterIndicator.remove();
  }
};
o.prototype.turnNumberOn = function (e, t) {
  function i(e, i) {
    i || (i = e === o.userActor.actorId ? o.userActor : o.actors[e]);
    "" === t ? i.removeTurnNumber() : i.addTurnNumber(t);
  }
  var n,
    o = this;
  n = e === this.userActor.actorId ? this.userActor : this.actors[e];
  n ? i(e, n) : this._onIdAdded[e] = i;
};
o.prototype.areNicknamesOn = function () {
  return this._nickNamesOn;
};
o.prototype.turnNicknamesOn = function () {
  this._nickNamesOn = !0;
  this._attachNicknameLabel(this.userActor);
  for (var e in this.actors) {
    var t = this.actors[e];
    t.isPlayer() && t.isDisplayed && !t.isInvisible && this._attachNicknameLabel(t);
  }
};
o.prototype.refreshNickname = function (e) {
  return e.nicknameLabel ? void (e.moving || "full" === e.nicknameLabel.getType() || (e.updateNicknameLabel(f.isRoleplayMode && this._fullNicknameLabelCount < s.maxTitlesOrnaments), "full" === e.nicknameLabel.getType() && this._fullNicknameLabelCount++)) : void console.warn("Tried to refresh non existing nickname label");
};
o.prototype.refreshNicknames = function () {
  this.refreshNickname(this.userActor);
  for (var e in this.actors) {
    var t = this.actors[e];
    t.isPlayer() && t.isDisplayed && !t.isInvisible && this.refreshNickname(t);
  }
};
o.prototype._attachNicknameLabel = function (e) {
  f.isRoleplayMode && this._fullNicknameLabelCount < s.maxTitlesOrnaments ? (e.addNicknameLabel(!0), e.nicknameLabel && "full" === e.nicknameLabel.getType() && this._fullNicknameLabelCount++, e.moving && e.nicknameLabel.set(e, "name")) : e.addNicknameLabel(!1);
};
o.prototype.turnNicknamesOff = function () {
  this._nickNamesOn = !1;
  for (var e in this.actors) {
    this.actors[e].removeNicknameLabel();
  }
  this.userActor.removeNicknameLabel();
  this._fullNicknameLabelCount = 0;
};
o.prototype.debugActorIdsOn = function () {
  for (var e in this.actors) {
    this.actors[e].addNicknameLabel(!1, e);
  }
  this.userActor.addNicknameLabel(!1, this.userActor.actorId);
};
o.prototype.debugActorIdsOff = function () {
  for (var e in this.actors) {
    this.actors[e].removeNicknameLabel();
  }
  this.userActor.removeNicknameLabel();
};
o.prototype.addedActor = function (e) {
  var t = this._onIdAdded[e];
  t && (t(e), delete this._onIdAdded[e]);
};
o.prototype.allTurnNumbersOff = function () {
  for (var e in this.actors) {
    this.actors[e].removeTurnNumber();
  }
  this.userActor.removeTurnNumber();
};
o.prototype.removeAllCarryStatus = function (e) {
  for (var t in this.actors) {
    this.actors[t].carriedEntity && e.removeCarrying(this.actors[t]);
  }
  this.userActor.carriedEntity && e.removeCarrying(this.userActor);
};
o.prototype.refreshFighter = function (e) {
  var t = window.actorManager.getActor(e.informations.contextualId);
  t && (window.gui.transmitFightSequenceMessage(e), t.setDisposition(e.informations.disposition.cellId, e.informations.disposition.direction), this.setActorLook(t.actorId, e.informations.look, {
    noSmokeAnimation: !0
  }, function () {
    t.applyLook({
      look: e.informations.look
    });
  }));
};
o.prototype.refreshActorsLook = function () {
  for (var e in this.actors) {
    var t = this.actors[e];
    t.refreshLook();
  }
  this.userActor.refreshLook();
};
o.prototype.clearQueuedToCarryActors = function () {
  this._queuedToCarryActors = {};
};
o.prototype.playAnimationOnNpcId = function (e, t, i) {
  i = i || n;
  var o = this.getActorFromNpcId(e);
  return o ? o.playCustomAnimation(t, i) : i(new Error("NPC not found with ID: " + e));
};
this.isoEngine.on("GameFightSynchronizeMessage", function (t) {
  for (var i = t.fighters, n = 0, o = i.length; n < o; n++) {
    var a = i[n];
    if (a.alive) {
      var s = a.contextualId,
        r = e.getActor(s);
      if (r) {
        var l = a.disposition.cellId;
        l === -1 || r.cellId === l || r.moving || r.setDisposition(l, null);
      } else {
        e.addEmptyActor(a);
      }
    }
  }
});
f.on("gameContextChanged", this.onGameContextChanged.bind(this));
s.on("maxTitlesOrnaments", this.optionModifiedMaxTitlesOrnaments.bind(this));
m.on("MapNpcsQuestStatusUpdateMessage", function (t) {
  e.updateQuestIcons(t);
});
f.isRoleplayMode && this.cleanupActorAnimations();
this.resetNicknames();
this.userId = t;
this.userActor.actorId = t;
this.userActor.actorManager = this;
this.userActor.data.name = e.name;
this.userActor.data.playerId = t;
this.setActorLook(t, i, {}, null);
this.actors[n] = this.userActor;
this.userId = e;
this.userActor = t;
delete this.actors[e];
i ? this.removeActor(n) : window.isoEngine.tryDisplayUserMovementZone();
e && e.showAlsoInvisibleInMyTeam && (o = _.isActorVisibleToUser(i));
o && (t[n.cellId] = n);
this.actors[t].removeTeamCircle();
this.actors[t].remove();
this.actors = {};
this._occupiedCells = {};
this.followers = [];
this.customAnimMethods = {};
s = r[o];
a = this.getActor(s.contextualId);
a || (c += 1);
this.checkCreatureMode(c);
v.each(r, function (e, t) {
  var o = e.contextualId;
  o === i.userId && (n.removeIcons(), i.isoEngine.userPreviousPosition = e.disposition.cellId);
  a = i.getActor(o);
  a ? a.updateData(e) : a = i.addEmptyActor(e);
  e.staticInfos && e.staticInfos.underlings && i.addActorFollowers(a, e.staticInfos.underlings);
  a.animated && a.staticAnim();
  i.setActorLook(o, e.look, {}, function () {
    for (var i = e.humanoidInfo ? e.humanoidInfo.options : [], n = 0; n < i.length; n++) {
      var a = i[n];
      if ("HumanOptionEmote" === a._type) {
        return window.isoEngine.playEmoteFromOption(o, a, t);
      }
    }
    return t();
  });
}, function (e) {
  return e && console.warn("An emote could not be played ", e), i.resetNicknames(), t && t();
});
o === i.userId && (n.removeIcons(), i.isoEngine.userPreviousPosition = e.disposition.cellId);
a = i.getActor(o);
a ? a.updateData(e) : a = i.addEmptyActor(e);
e.staticInfos && e.staticInfos.underlings && i.addActorFollowers(a, e.staticInfos.underlings);
a.animated && a.staticAnim();
i.setActorLook(o, e.look, {}, function () {
  for (var i = e.humanoidInfo ? e.humanoidInfo.options : [], n = 0; n < i.length; n++) {
    var a = i[n];
    if ("HumanOptionEmote" === a._type) {
      return window.isoEngine.playEmoteFromOption(o, a, t);
    }
  }
  return t();
});
t = i[o];
t.isNPC() && n.indexOf(t.actorId) === -1 && t.removeQuestIcon();
t = this.getActor(n[a]);
t && t.addQuestIcon(e.questFlags[a]);
e.fighterIndicator && e.fighterIndicator.remove();
e.removeTurnNumber();
this.removeActorOccupation(e);
this.customAnimMethods[i] && delete this.customAnimMethods[i];
e.nicknameLabel && ("full" === e.nicknameLabel.getType() && (this._fullNicknameLabelCount--, t = !0), e.removeNicknameLabel());
e.removeTeamCircle();
delete this.actors[i];
e.followers && this.removeActorFollowers(e);
t && this.refreshNicknames();
this.removeAllActors();
this.userActor.show();
t.i = t.x;
t.j = t.y;
a[c] = h;
s += h;
p += 1;
m -= a[p];
t = n[p === o ? p - 1 : p];
e = r.getCellIdFromMapPoint(t.i, t.j);
i = this._occupiedCells[e] ? .995 : .8;
c = this.addEmptyActor({
  contextualId: l,
  disposition: {
    cellId: d,
    direction: 1 + 2 * Math.round(3 * Math.random())
  }
});
c.isFollower = !0;
i === !0 ? c.isolationCoefficient = T : (c.isolationCoefficient = M, r.staticInfos && r.staticInfos.isMiniBoss ? c.addIcon("miniBoss") : c.removeIcon("miniBoss"), r.staticInfos || console.error("ActorManager#addActorFollowers: no staticInfos", "actorId:", o, "followerId:", l));
e.followers.push(c);
c.groupBoss = e;
c.data = e.data;
this.followers.push(c);
I *= 0 === A && 0 === S ? y * y : 0 === A ? Math.pow(w, c / S) : Math.pow(w, s / A);
v[M] = I;
b += I;
E += 1;
N -= v[E];
p = g[E === _ ? E - 1 : E];
h = r.getCellIdFromMapPoint(p.i, p.j);
m.push(h);
f = 1 - 1 / (1 + .5 * d);
e.setCellPosition(h);
e.setPath(m);
l.aggressable = o;
a.addConquestIcon(l);
o.layer = t;
o.alpha = i;
this.userActor.layer = t;
this.userActor.alpha = i;
this.isTransparentModeOn = e;
i = i || g.getValue("creatureMode", !1);
this.setCreatureMode(i);
i = i || g.getValue("creatureMode", !1);
this.setCreatureMode(i);
this.isCreatureModeOn = !0;
this.userActor.carriedEntity || this.userActor.setCreatureLook({}, null);
i.setCreatureLook({}, null);
i.fighterIndicator && (i.fighterIndicator.y = i.bbox[2] - i.y);
this.isCreatureModeOn = !1;
this.userActor.carriedEntity || this.userActor.useRealLook();
t.useRealLook();
t.fighterIndicator && (t.fighterIndicator.y = t.bbox[2] - t.y);
i || (i = e === o.userActor.actorId ? o.userActor : o.actors[e]);
"" === t ? i.removeTurnNumber() : i.addTurnNumber(t);
n = e === this.userActor.actorId ? this.userActor : this.actors[e];
n ? i(e, n) : this._onIdAdded[e] = i;
this._nickNamesOn = !0;
this._attachNicknameLabel(this.userActor);
this.userActor.removeNicknameLabel();
this._fullNicknameLabelCount = 0;
i(1442);
i(1444);
i(1449);
i(1450);
i(1451);
i(1452);
i(1453);
i(1454);
e.exports = i(1443);
o.prototype.getAnimSymbol = function (e, t) {
  return t || 0 === t || (t = this.direction), {
    id: e + "_" + s[t],
    base: e,
    direction: t
  };
};
o.prototype.finalizeAnimationSymbol = function (e) {
  e.direction || 0 === e.direction || (e.direction = this.direction);
};
o.prototype.loadAndPlayAnimation = function (e, t, i) {
  function n() {
    t.loop ? o.loopAnim(e, i) : o.oneShootAnim(e, {
      backToStatic: !1,
      isEmoteAnimated: t.isEmoteAnimated
    }, i);
  }
  var o = this;
  t = t || {};
  this.finalizeAnimationSymbol(e);
  this.animManager.addAnimation(e, n);
};
o.prototype.staticAnim = function (e) {
  var t = e || n;
  this.animSymbol = this.getAnimSymbol("AnimStatique");
  this.animManager.assignSymbol(this.animSymbol, !1, t);
  this.animated = !1;
  this.emoteAnimated = !1;
};
o.prototype.loopAnim = function (e, t) {
  this.animSymbol = e;
  this.animated = !0;
  this.emoteAnimated = !1;
  this.animManager.assignSymbol(e, !0, t);
};
o.prototype.oneShootAnim = function (e, t, i) {
  var n = this;
  t = t || {};
  this.finalizeAnimationSymbol(e);
  this.animSymbol = e;
  this.animated = !0;
  this.animManager.assignSymbol(e, !1, function () {
    return t.backToStatic && n.staticAnim(), n.animated = !1, n.emoteAnimated = Boolean(t.isEmoteAnimated), i && i();
  });
};
o.prototype.cleanupAnimations = function () {
  this.animManager.cleanupAnimations();
};
o.prototype.death = function (e) {
  var t = this;
  this.moving && (console.warn("kill a moving actor"), this.pathTween.stop());
  this.animated && console.warn("kill an animated actor");
  var i = this.getAnimSymbol("AnimMort");
  return this.animSymbol = i, this.animated = !0, t.actorManager.userActor === this && this.animManager.cleanupAnimationsAndRemoveSubentities(), this.isDead = !0, this.animManager.assignSymbol(i, !1, function () {
    return t.isDead ? (t.animated = !1, t.emoteAnimated = !1, t.fighterIndicator && t.fighterIndicator.remove(), t.removeTeamCircle(), t.actorManager.removeActor(t.actorId), void (t.actorManager.userActor.isDead || !window.gui.fightManager.isFightersTurn(t.actorManager.userActor.actorId) || window.gui.fightManager.getIsTurnEndRequestPending() || window.isoEngine.displayUserMovementZone())) : void t.staticAnim();
  }), e && e();
};
o.prototype.testAnimation = function (e, t) {
  var i = e.animationString,
    n = e.direction,
    o = this.getAnimSymbol(i, n);
  this.animSymbol = o;
  var s = this;
  return this.animManager.addAnimation(o, function () {
    return s.animated = !0, s.animManager.addAnimation(o, function () {
      return s.animManager.assignSymbol(o, !0), t(s.animManager.template.hasAnimation(o.id) ? "playing: " + o.id : s.animManager.isMissingTemplates(o) ? "animation " + o.id + " inside " + a.MISSING_ANIM_PATH + ". Skipping..." : "animation not found: " + o.id);
    });
  });
};
o.prototype.removeCustomAnimTimeout = function () {
  this.customAnimTimeout && (this.actorState = r.IDLE, clearTimeout(this.customAnimTimeout), this.customAnimTimeout = null);
};
o.prototype.playCustomAnimation = function (e, t) {
  t = t || n;
  var i = this,
    o = this.getAnimSymbol(e.animationName, e.direction);
  this.animated = !0;
  this.removeCustomAnimTimeout();
  this.actorState = r.PLAYING_ANIMATION;
  this.customAnimTimeout = setTimeout(function () {
    return i ? void i.animManager.addAnimation(o, function () {
      i.animManager.assignSymbol(o, e.loop, function () {
        i.customAnimTimeout && clearTimeout(i.customAnimTimeout);
        i.customAnimTimeout = setTimeout(function () {
          return i ? (i.actorState = r.IDLE, i.staticAnim(), i.animated = !1, t()) : t(new Error("Actor has been removed while customAnimTimeout is still active"));
        }, e.duration);
      });
    }) : t(new Error("Actor has been removed while customAnimTimeout is still active"));
  }, e.delay);
};
o.prototype.startAnimBehaviour = function () {
  function e() {
    return l + Math.floor(Math.random() * c);
  }
  function t() {
    var e = 0;
    for (u = 0; u < a.length; u++) {
      e += a[u].animWeight;
    }
    var t = Math.floor(Math.random() * e) + 1,
      i = 0;
    for (u = 0; u < a.length; u++) {
      if (i += a[u].animWeight, a[u].animWeight > 0 && t <= i || u >= a.length) {
        return a[u].animName;
      }
    }
    return d || "AnimStatique";
  }
  function i() {
    if (o !== n.animManager && (o = n.animManager, n.actorState = r.IDLE, s = 0), n.actorState !== r.PLAYING_ANIMATION) {
      if (n.actorState === r.IDLE && Date.now() >= s) {
        var i = e();
        s = Date.now() + i;
        d ? n.playCustomAnimation({
          animationName: d,
          direction: n.direction,
          loop: !0,
          duration: i,
          delay: 0
        }, function () {
          n.actorState = r.WAITING_FOR_NEXT_ANIMATION;
        }) : n.actorState = r.WAITING_FOR_NEXT_ANIMATION;
      }
      n.actorState === r.WAITING_FOR_NEXT_ANIMATION && Date.now() >= s && n.playCustomAnimation({
        animationName: t(),
        direction: n.direction,
        loop: !1,
        duration: 0,
        delay: 0
      });
    }
  }
  if (this.data.npcData && !(this.data.npcData.animFunList.length <= 0)) {
    var n = this,
      o = this.animManager,
      a = n.data.npcData.animFunList,
      s = 0,
      d = null;
    this.actorState = r.IDLE;
    var u;
    for (u = 0; u < a.length; u++) {
      if (0 === a[u].animWeight) {
        d = a[u].animName;
        break;
      }
    }
    window.actorManager.addAnimBehaviourToActor(this.actorId, i);
  }
};
t = t || {};
this.finalizeAnimationSymbol(e);
this.animManager.addAnimation(e, n);
this.animSymbol = this.getAnimSymbol("AnimStatique");
this.animManager.assignSymbol(this.animSymbol, !1, t);
this.animated = !1;
this.emoteAnimated = !1;
this.animSymbol = e;
this.animated = !0;
this.emoteAnimated = !1;
this.animManager.assignSymbol(e, !0, t);
t = t || {};
this.finalizeAnimationSymbol(e);
this.animSymbol = e;
this.animated = !0;
this.animManager.assignSymbol(e, !1, function () {
  return t.backToStatic && n.staticAnim(), n.animated = !1, n.emoteAnimated = Boolean(t.isEmoteAnimated), i && i();
});
this.moving && (console.warn("kill a moving actor"), this.pathTween.stop());
this.animated && console.warn("kill an animated actor");
this.animated = !0;
this.removeCustomAnimTimeout();
this.actorState = r.PLAYING_ANIMATION;
this.customAnimTimeout = setTimeout(function () {
  return i ? void i.animManager.addAnimation(o, function () {
    i.animManager.assignSymbol(o, e.loop, function () {
      i.customAnimTimeout && clearTimeout(i.customAnimTimeout);
      i.customAnimTimeout = setTimeout(function () {
        return i ? (i.actorState = r.IDLE, i.staticAnim(), i.animated = !1, t()) : t(new Error("Actor has been removed while customAnimTimeout is still active"));
      }, e.duration);
    });
  }) : t(new Error("Actor has been removed while customAnimTimeout is still active"));
}, e.delay);
i.customAnimTimeout && clearTimeout(i.customAnimTimeout);
i.customAnimTimeout = setTimeout(function () {
  return i ? (i.actorState = r.IDLE, i.staticAnim(), i.animated = !1, t()) : t(new Error("Actor has been removed while customAnimTimeout is still active"));
}, e.duration);
s = Date.now() + i;
d ? n.playCustomAnimation({
  animationName: d,
  direction: n.direction,
  loop: !0,
  duration: i,
  delay: 0
}, function () {
  n.actorState = r.WAITING_FOR_NEXT_ANIMATION;
}) : n.actorState = r.WAITING_FOR_NEXT_ANIMATION;
e = e || {};
e.data = e.data || {};
l.call(this, e);
this.actorId = void 0 === e.actorId ? null : e.actorId;
this.cellId = null;
this._step = 0;
this.path = [];
this.moving = !1;
this.animated = !1;
this.emoteAnimated = !1;
this.lastEmoteAnim = null;
this.speedAdjust = 0;
this.tints = null;
this.data = {};
this.groupBoss = null;
this.isInvisible = !1;
this.detectedAnimationTween = null;
this.followers = null;
this.isFollower = !1;
this.isLocked = !1;
this.isRiding = !1;
this.isDead = !1;
this.canMoveDiagonally = !0;
this.isolationCoefficient = 0;
this.pathTween = new s(this, ["step"]);
this.riderEntity = null;
this.carriedActor = null;
this.carriedEntity = null;
this.parentActor = null;
this.circleGraphic = null;
this.icons = {};
this.realLook = null;
this.actorManager = e.actorManager;
this.fighterIndicator = null;
this._turnNumberLabel = null;
this.nicknameLabel = null;
this._questIconLoadingStartTime = null;
this.x = u.DEFAULT_ACTOR_X;
this.y = u.DEFAULT_ACTOR_Y;
this.updateData(e.data);
a(o, l);
e.exports = o;
o.prototype.hasFullNicknameLabelData = function () {
  var e = this.data;
  if (!e.humanoidInfo) {
    return !1;
  }
  for (var t = e.humanoidInfo.options || [], i = !1, n = 0; n < t.length; n++) {
    var o = t[n];
    if ("HumanOptionOrnament" === o._type || "HumanOptionTitle" === o._type) {
      i = !0;
      break;
    }
  }
  var a = e.alignmentInfos && 0 !== e.alignmentInfos.alignmentGrade;
  return i || a;
};
Object.defineProperty(o.prototype, "step", {
  get: function () {
    return this._step;
  },
  set: function (e) {
    this._step = e;
    this.forceRefresh();
  }
});
o.prototype._isCandidateToHideTheMountInFight = function (e) {
  return e ? Boolean(l.getLookOfRider(e)) && this.isPlayer() && !d.showMountsInFight && !c.isRoleplayMode : (console.error(new Error("The look is missing.")), !1);
};
o.prototype.setLook = function (e, t, i) {
  var o = i || n;
  return e || console.error(new Error("Assigning falsy look to realLook")), this.realLook = e, this.isRiding = !!l.getLookOfRider(e), this.speedAdjust = void 0 !== e.speed ? e.speed : u.DEFAULT_ACTOR_SPEED, this.actorManager.isCreatureModeOn && !t.useRealLook ? this.setCreatureLook(t, o) : this._isCandidateToHideTheMountInFight(e) ? l.prototype.setLook.call(this, l.getLookWithoutMount(e), t, o) : void l.prototype.setLook.call(this, e, t, o);
};
o.prototype.applyLook = function (e) {
  return this.actorManager.isCreatureModeOn ? (e.look || console.error(new Error("Assigning falsy look to realLook")), void (this.realLook = e.look)) : (e.animationManager && 1 === e.look.bonesId && e.look.skins[0] && e.animationManager.addAnimationModifier("AnimStatique", "AnimStatique" + e.look.skins[0]), e.animationManager && e.animationManager !== this.animationManager && (this.animManager.clear(), this.setAnimManager(e.animationManager)), this.staticAnim(), this._isCandidateToHideTheMountInFight(e.look) ? this.look = l.getLookWithoutMount(e.look) : this.look = e.look, this.look || console.error(new Error("Assigning falsy look to realLook")), void (this.realLook = this.look));
};
o.prototype.useRealLook = function () {
  return this.realLook ? void this.actorManager.setActorLook(this.actorId, this.realLook, {
    useRealLook: !0
  }, null) : void console.warn("actorId " + this.actorId + " not real look yet...");
};
o.prototype.updateData = function (e) {
  var t = window.isoEngine,
    i = e.disposition;
  if (i) {
    var n = !0;
    window.actorManager.paused && window.actorManager.userActor !== this && (this.position = i.cellId, this.cellId = i.cellId);
    this.moving && this.actorManager.userActor === this && c.isRoleplayMode && (n = !t.isMovementWaitingForConfirmation);
    n && this.setDisposition(i.cellId, i.direction);
  }
  switch (void 0 !== e.alive && (this.isDead = !e.alive), e.npcId && (this.data.npcId = e.npcId, this.data.npcData = e._npcData), e.name && (this.data.name = e.name), e.contextualId && (this.data.actorId = e.contextualId), e.look && void 0 !== e.look.speed && (this.speedAdjust = e.look.speed), e._type) {
    case "GameRolePlayCharacterInformations":
      this.data.accountId = e.accountId;
      this.data.playerId = e.contextualId;
      this.data.humanoidInfo = e.humanoidInfo;
      this.data.alignmentInfos = e.alignmentInfos;
      this.processHumanoidOptions();
      break;
    case "GameRolePlayMutantInformations":
      this.data.accountId = e.accountId;
      this.data.playerId = e.contextualId;
      this.data.humanoidInfo = e.humanoidInfo;
      this.data.monsterId = e.monsterId;
      this.data.powerLevel = e.powerLevel;
      this.processHumanoidOptions();
      break;
    case "GameRolePlayNpcWithQuestInformations":
      this.addQuestIcon(e.questFlag);
      break;
    case "GameFightMonsterInformations":
    case "GameFightMonsterWithAlignmentInformations":
      this.data.contextualId = e.contextualId;
      this.data.isBoss = e._isBoss;
      this.data.isSummon = e.stats && e.stats.summoned;
      this.data.creatureGenericId = e.creatureGenericId;
      break;
    case "GameRolePlayGroupMonsterInformations":
      this.data.ageBonus = e.ageBonus;
      this.data.alignmentSide = e.alignmentSide;
      this.data.contextualId = e.contextualId;
      this.data.hasHardcoreDrop = e.hasHardcoreDrop;
      this.data.keyRingBonus = e.keyRingBonus;
      this.data.lootShare = e.lootShare;
      this.data.staticInfos = e.staticInfos;
      this.data.scaleLevel = e.scaleLevel;
      e.hasHardcoreDrop && this.addIcon("hardcoreDrop");
      var o = e.staticInfos.mainCreatureLightInfos.staticInfos;
      if (o && o.isMiniBoss) {
        this.addIcon("miniBoss");
      } else if (!d.showAllMonsters) {
        var a = e.staticInfos.underlings;
        if (a) {
          for (var s = 0; s < a.length; s++) {
            a[s].staticInfos.isMiniBoss && this.addIcon("miniBoss");
          }
        }
      }
      break;
    case "GameRolePlayPrismInformations":
      this.data.prism = e.prism;
      this.data.contextualId = e.contextualId;
      break;
    case "GameRolePlayTaxCollectorInformations":
      this.data.contextualId = e.contextualId;
      this.data.taxCollectorAttack = e.taxCollectorAttack;
      var r = e.identification.guildIdentity;
      this.data.guild = {
        guildLevel: e.guildLevel,
        guildEmblem: r.guildEmblem,
        guildId: r.guildId,
        guildName: r.guildName
      };
      this.data.taxCollector = {
        lastNameId: e.identification.lastNameId,
        firstNameId: e.identification.firstNameId
      };
      break;
    case "FightTeamInformations":
    case "FightAllianceTeamInformations":
    case "FightTeamLightInformations":
      this.data.fightId = e.fightId;
      this.data.teamId = e.teamId;
      this.data.leaderId = e.leaderId;
      this.data.teamSide = e.teamSide;
      this.data.teamTypeId = e.teamTypeId;
      this.data.teamMembers = e.teamMembers;
      break;
    case "GameFightCharacterInformations":
      this.data.playerId = e.contextualId;
      break;
    case "PaddockObject":
      this.data.durability = e.durability;
      break;
    case "GameRolePlayMountInformations":
      this.data.level = e.level;
      this.data.ownerName = e.ownerName;
  }
  this.data.type = e._type;
};
o.prototype.updateRestrictions = function (e) {
  if (this.data.humanoidInfo && (this.data.humanoidInfo.restrictions = e), this.canMoveDiagonally = !e.cantWalk8Directions, this.canMoveDiagonally === !1 && 0 === (1 & this.direction)) {
    var t = this.direction + 1;
    t > 7 && (t = 1);
    this.setDisposition(this.position, t);
  }
};
o.prototype.processHumanoidOptions = function () {
  if (this.actorManager.removeActorFollowers(this, !0), this.data.humanoidInfo && this.data.humanoidInfo.options) {
    for (var e = this.data.humanoidInfo.options, t = 0; t < e.length; t++) {
      var i = e[t];
      "HumanOptionAlliance" === i._type ? this.addConquestIcon(i) : "HumanOptionFollowers" === i._type && this.actorManager.addActorFollowers(this, i.followingCharactersLook, !0);
    }
  }
};
o.prototype.remove = function () {
  this.removeIcons();
  this.removeCustomAnimTimeout();
  (this.pathTween.playing || this.pathTween.starting) && this.pathTween.stop();
  this.actorManager._removeActor(this);
  l.prototype.remove.call(this);
};
o.prototype.getFighter = function () {
  return window.gui.fightManager.getFighter(this.actorId);
};
o.prototype.getFighterData = function () {
  var e = this.getFighter();
  return e ? e.data : (console.warn("Fighter " + this.actorId + " could not be found."), new r());
};
o.prototype.isNPC = function () {
  return Boolean(this.data && this.data.npcId);
};
o.prototype.getTeamId = function () {
  var e = this.getFighter();
  return e ? this.getFighterData().teamId : -1;
};
o.prototype.isPlayer = function () {
  return this.data.playerId && !this.isFollower;
};
o.prototype.refreshLook = function (e) {
  this.actorManager.setActorLook(this.actorId, this.realLook, {}, e);
};
o.prototype.hasSameLook = function (e) {
  return !(!e || !this.realLook) && this.realLook.bonesId === e.bonesId;
};
this._step = e;
this.forceRefresh();
window.actorManager.paused && window.actorManager.userActor !== this && (this.position = i.cellId, this.cellId = i.cellId);
this.moving && this.actorManager.userActor === this && c.isRoleplayMode && (n = !t.isMovementWaitingForConfirmation);
n && this.setDisposition(i.cellId, i.direction);
this.data.accountId = e.accountId;
this.data.playerId = e.contextualId;
this.data.humanoidInfo = e.humanoidInfo;
this.data.alignmentInfos = e.alignmentInfos;
this.processHumanoidOptions();
this.data.accountId = e.accountId;
this.data.playerId = e.contextualId;
this.data.humanoidInfo = e.humanoidInfo;
this.data.monsterId = e.monsterId;
this.data.powerLevel = e.powerLevel;
this.processHumanoidOptions();
this.data.contextualId = e.contextualId;
this.data.isBoss = e._isBoss;
this.data.isSummon = e.stats && e.stats.summoned;
this.data.creatureGenericId = e.creatureGenericId;
this.data.ageBonus = e.ageBonus;
this.data.alignmentSide = e.alignmentSide;
this.data.contextualId = e.contextualId;
this.data.hasHardcoreDrop = e.hasHardcoreDrop;
this.data.keyRingBonus = e.keyRingBonus;
this.data.lootShare = e.lootShare;
this.data.staticInfos = e.staticInfos;
this.data.scaleLevel = e.scaleLevel;
e.hasHardcoreDrop && this.addIcon("hardcoreDrop");
this.data.prism = e.prism;
this.data.contextualId = e.contextualId;
this.data.contextualId = e.contextualId;
this.data.taxCollectorAttack = e.taxCollectorAttack;
this.data.guild = {
  guildLevel: e.guildLevel,
  guildEmblem: r.guildEmblem,
  guildId: r.guildId,
  guildName: r.guildName
};
this.data.taxCollector = {
  lastNameId: e.identification.lastNameId,
  firstNameId: e.identification.firstNameId
};
this.data.fightId = e.fightId;
this.data.teamId = e.teamId;
this.data.leaderId = e.leaderId;
this.data.teamSide = e.teamSide;
this.data.teamTypeId = e.teamTypeId;
this.data.teamMembers = e.teamMembers;
this.data.level = e.level;
this.data.ownerName = e.ownerName;
t > 7 && (t = 1);
this.setDisposition(this.position, t);
this.removeIcons();
this.removeCustomAnimTimeout();
(this.pathTween.playing || this.pathTween.starting) && this.pathTween.stop();
this.actorManager._removeActor(this);
l.prototype.remove.call(this);
this.c = e;
this.x = t;
this.y = i;
this.d = n;
this.a = o;
this.m = a;
o.prototype.setCellPosition = function (e) {
  return this.isInvisibleInFight() ? console.warn("We can not change the position of an invisible actor in a fight") : (this.actorManager.removeActorOccupation(this), this.cellId = e, this.actorManager.addActorOccupation(this), void (this.carriedActor && this.carriedActor.setCellPosition(e)));
};
o.prototype.setOnScreenPosition = function (e) {
  var t = this.actorManager.isoEngine,
    i = t.mapRenderer.map,
    n = s.cellCoord[e],
    o = 0;
  i && (r.isRoleplayMode ? o = i.cells[e].f || 0 : this._positionCircle());
  this.position = e;
  this.x = n.x;
  this.y = n.y - o;
  this._positionIcons();
};
o.prototype.setDisposition = function (e, t, i) {
  function n() {
    return (o.position !== e || o.direction !== t || window.gui.fightManager.isInFight()) && (o.emoteAnimated = !1), !e && 0 !== e || e === -1 || (o.setOnScreenPosition(e), o.setCellPosition(e)), (t || 0 === t) && (o.direction = t), o.animated || o.emoteAnimated || (o.staticAnim(), a && !e && (o.emoteAnimated = !0)), i && i();
  }
  var o = this,
    a = this.emoteAnimated;
  return i && this.moving ? this.cancelMovement(n) : (this.moving && this.cancelMovement(), void n());
};
o.prototype.noMovement = function () {
  this.moving && (this.pathTween.removeOnFinish(), this.pathTween.stop(), this.moving = !1, this.isLocked && (this.isLocked = !1), this.step = 0, this.path = []);
};
o.prototype.cancelMovement = function (e) {
  var t = this;
  this.pathTween.removeOnFinish();
  this.pathTween.stop();
  var i = ~~this.step,
    n = i + 1,
    o = this.path[i].m * (1 - this.step + i),
    a = this.path[n].c;
  this.pathTween.reset().from({
    step: this.step
  }).to({
    step: n
  }, o);
  this.pathTween.start(!1);
  this.pathTween.onceFinish(function () {
    if (t.moving = !1, t.step = 0, t.path = [], t.setCellPosition(a), t.actorId === window.gui.playerData.id && window.dofus.sendMessage("GameMapMovementCancelMessage", {
      cellId: a
    }), t.moving || t.setDisposition(a), e) {
      return e();
    }
  });
};
o.prototype.switchPath = function (e, t) {
  var i = this;
  this.pathTween.removeOnFinish();
  this.pathTween.stop();
  var n = ~~this.step,
    o = n + 1,
    a = this.path[n].m * (1 - (this.step - n));
  this.pathTween.reset().from({
    step: this.step
  }).to({
    step: o
  }, a);
  this.pathTween.start(!1);
  this.pathTween.onceFinish(function () {
    return i.moving = !1, i.step = 0, i.path = [], 1 === e.length ? (i.setDisposition(e[0]), t()) : (i.setPath(e, {
      cb: t
    }), void i.setCellPosition(e[e.length - 1]));
  });
};
o.prototype.isPathMatchingServerPath = function (e, t) {
  var i = e[e.length - 1],
    n = this.path;
  if (n[n.length - 1].c === i) {
    return !0;
  }
  var o;
  for (o = n.length - 2; o >= 0 && n[o].c !== i; o--) {
    ;
  }
  var a = ~~this.step;
  if (a >= o) {
    return !1;
  }
  for (var s = n[a + 1].c, r = e.length - 1; r >= 0 && (t.unshift(e[r]), e[r] !== s); r--) {
    ;
  }
  return !1;
};
o.prototype.refreshAnimation = function (e) {
  if (this.moving === !0) {
    var t = ~~this._step,
      i = this._step - t,
      n = this.path[t];
    if (n) {
      var o = this.path[t + 1] || this.path[t];
      this._x = n.x + (o.x - n.x) * i;
      this._y = n.y + (o.y - n.y) * i;
      i > .5 && this._position !== o.c && (this.position = o.c);
      this.animSymbol.id === n.a.id && this.direction === n.d || (this.animSymbol = n.a, this.direction = n.d, this.animManager.assignSymbol(this.animSymbol, !0));
    }
  }
  this._refreshAnimation(e);
  this._positionIcons();
  this._positionCircle();
};
o.prototype._startPath = function (e) {
  var t = this,
    i = this.path,
    n = i[0].m;
  this.step = 0;
  this.pathTween.reset().from({
    step: 0
  }).to({
    step: 1
  }, n);
  for (var o = 1, a = this.path.length - 1; o < a; o++) {
    n = i[o].m;
    this.pathTween.to({
      step: o + 1
    }, n);
  }
  this.animManager.isTemporary || (this.animSymbol = i[0].a, this.animManager.assignSymbol(this.animSymbol, !0));
  this.moving ? console.warn('[Actor._startPath] error: actor "' + this.actorId + '" is already moving.') : (this.pathTween.start(!1), this.pathTween.onceFinish(function () {
    t.moving = !1;
    r.isRoleplayMode && l.hasFullNicknameLabelData(t) && t.nicknameLabel && t._hadFullNicknameLabel && "name" === t.nicknameLabel.getType() && t.nicknameLabel.set(t, "full");
    var i = t.path[t.path.length - 1];
    return t.animSymbol = i.a, t._x = i.x, t._y = i.y, t.animManager.assignSymbol(t.animSymbol, !0), e && e();
  }));
  this.moving = !0;
  this.nicknameLabel && "full" === this.nicknameLabel.getType() && this.nicknameLabel.set(this, "name");
};
o.prototype.walkToSceneCoordinate = function (e, t, i, o, a) {
  var s = this.getAnimSymbol("AnimMarche", i),
    r = this.getAnimSymbol("AnimStatique", i);
  this.path = [new n(this.cellId, this._x, this._y, i, s, o), new n(this.cellId, e, t, i, r, 0)];
  this._startPath(a);
};
o.prototype.setPath = function (e, t) {
  var i = t && t.cb,
    o = this.actorManager.isoEngine;
  if (!o.mapRenderer.isReady) {
    return console.warn("setPath: renderer was not ready"), i();
  }
  if (e.length <= 1) {
    return i && i();
  }
  var a = t && t.slide,
    l = t && t.forceWalk;
  this.path = [];
  this.step = 0;
  var u, h, p, m;
  m = a ? d.slide : this.isRiding ? d.mounted : e.length > 3 && !l ? d.running : d.walking;
  var f,
    g = (1 + this.speedAdjust / 10 || .001) * c,
    _ = null;
  if (o.mapRenderer.map) {
    _ = o.mapRenderer.map.cells;
  } else {
    var v = "actorId: " + this.actorId;
    console.error(new Error("Actor#setPath: map is null, cells are unknown " + v));
  }
  for (var y = 0; y < e.length; y++) {
    var w = e[y],
      b = 0;
    r.isFightMode ? b = 0 : _ && _[w] && _[w].f && (b = _[w].f);
    var M,
      T = s.cellCoord[w];
    0 === y ? f = 1 : T.y === p ? (M = m.horizontal, f = T.x > h ? 0 : 4) : T.x === h ? (M = m.vertical, f = T.y > p ? 2 : 6) : (M = m.linear, f = T.x > h ? T.y > p ? 1 : 7 : T.y > p ? 3 : 5);
    M /= g;
    a && (f = this.direction);
    var C = this.getAnimSymbol(m.symbolId, f);
    y > 0 && (u.d = f, u.a = C, u.m = M);
    this.path.push(new n(w, T.x, T.y - b, f, C, M));
    u = this.path[this.path.length - 1];
    h = T.x;
    p = T.y;
  }
  var I = this.animManager,
    A = I.isTemporary ? {} : I.template.exposedSymbols,
    S = this.getAnimSymbol("AnimStatique", f),
    E = this.getAnimSymbol("AnimStatique_to_" + this.path[0].a.base, this.path[0].a.direction),
    N = this.getAnimSymbol(m.symbolId + "_to_" + S.base, f);
  this.emoteAnimated = !1;
  var x, L;
  A[E.id] && (x = this.path[0], L = I.getSymbolDuration(E.id), this.path.unshift(new n(x.c, x.x, x.y, x.d, E, L)));
  A[N.id] && (x = this.path[this.path.length - 1], L = I.getSymbolDuration(N.id), x.a = N, x.m = L, this.path.push(new n(x.c, x.x, x.y, x.d, S, x.m)));
  this.path[this.path.length - 1].a = S;
  this._startPath(i);
};
i && (r.isRoleplayMode ? o = i.cells[e].f || 0 : this._positionCircle());
this.position = e;
this.x = n.x;
this.y = n.y - o;
this._positionIcons();
this.pathTween.removeOnFinish();
this.pathTween.stop();
this.pathTween.reset().from({
  step: this.step
}).to({
  step: n
}, o);
this.pathTween.start(!1);
this.pathTween.onceFinish(function () {
  if (t.moving = !1, t.step = 0, t.path = [], t.setCellPosition(a), t.actorId === window.gui.playerData.id && window.dofus.sendMessage("GameMapMovementCancelMessage", {
    cellId: a
  }), t.moving || t.setDisposition(a), e) {
    return e();
  }
});
this.pathTween.removeOnFinish();
this.pathTween.stop();
this.pathTween.reset().from({
  step: this.step
}).to({
  step: o
}, a);
this.pathTween.start(!1);
this.pathTween.onceFinish(function () {
  return i.moving = !1, i.step = 0, i.path = [], 1 === e.length ? (i.setDisposition(e[0]), t()) : (i.setPath(e, {
    cb: t
  }), void i.setCellPosition(e[e.length - 1]));
});
this._x = n.x + (o.x - n.x) * i;
this._y = n.y + (o.y - n.y) * i;
i > .5 && this._position !== o.c && (this.position = o.c);
this.animSymbol.id === n.a.id && this.direction === n.d || (this.animSymbol = n.a, this.direction = n.d, this.animManager.assignSymbol(this.animSymbol, !0));
this._refreshAnimation(e);
this._positionIcons();
this._positionCircle();
this.step = 0;
this.pathTween.reset().from({
  step: 0
}).to({
  step: 1
}, n);
n = i[o].m;
this.pathTween.to({
  step: o + 1
}, n);
this.animManager.isTemporary || (this.animSymbol = i[0].a, this.animManager.assignSymbol(this.animSymbol, !0));
this.moving ? console.warn('[Actor._startPath] error: actor "' + this.actorId + '" is already moving.') : (this.pathTween.start(!1), this.pathTween.onceFinish(function () {
  t.moving = !1;
  r.isRoleplayMode && l.hasFullNicknameLabelData(t) && t.nicknameLabel && t._hadFullNicknameLabel && "name" === t.nicknameLabel.getType() && t.nicknameLabel.set(t, "full");
  var i = t.path[t.path.length - 1];
  return t.animSymbol = i.a, t._x = i.x, t._y = i.y, t.animManager.assignSymbol(t.animSymbol, !0), e && e();
}));
this.moving = !0;
this.nicknameLabel && "full" === this.nicknameLabel.getType() && this.nicknameLabel.set(this, "name");
t.moving = !1;
r.isRoleplayMode && l.hasFullNicknameLabelData(t) && t.nicknameLabel && t._hadFullNicknameLabel && "name" === t.nicknameLabel.getType() && t.nicknameLabel.set(t, "full");
this.path = [new n(this.cellId, this._x, this._y, i, s, o), new n(this.cellId, e, t, i, r, 0)];
this._startPath(a);
this.path = [];
this.step = 0;
0 === y ? f = 1 : T.y === p ? (M = m.horizontal, f = T.x > h ? 0 : 4) : T.x === h ? (M = m.vertical, f = T.y > p ? 2 : 6) : (M = m.linear, f = T.x > h ? T.y > p ? 1 : 7 : T.y > p ? 3 : 5);
M /= g;
a && (f = this.direction);
y > 0 && (u.d = f, u.a = C, u.m = M);
this.path.push(new n(w, T.x, T.y - b, f, C, M));
u = this.path[this.path.length - 1];
h = T.x;
p = T.y;
A[E.id] && (x = this.path[0], L = I.getSymbolDuration(E.id), this.path.unshift(new n(x.c, x.x, x.y, x.d, E, L)));
A[N.id] && (x = this.path[this.path.length - 1], L = I.getSymbolDuration(N.id), x.a = N, x.m = L, this.path.push(new n(x.c, x.x, x.y, x.d, S, x.m)));
this.path[this.path.length - 1].a = S;
this._startPath(i);
i(1446);
e.exports = i(1447);
n.prototype.updatePosition = function (e, t) {
  this.x = e - this.w / 2;
  this.y = t - this.h;
};
n.prototype.setTexture = function (e) {
  this.hide();
  this.clearTexture();
  this.w = e.width;
  this.h = e.height;
  "none" === this._textureId ? this.texture = window.isoEngine.mapScene.createTexture(e, this.id, "nearest", "throwable") : this.texture = window.isoEngine.mapScene.createTexture(e, this._textureId, "nearest", "archivable");
};
n.prototype.clearTexture = function () {
  this.texture && (this.texture.release(), this.texture = null);
};
n.prototype.clear = function () {
  this.clearTexture();
};
this.x = e - this.w / 2;
this.y = t - this.h;
this.hide();
this.clearTexture();
this.w = e.width;
this.h = e.height;
"none" === this._textureId ? this.texture = window.isoEngine.mapScene.createTexture(e, this.id, "nearest", "throwable") : this.texture = window.isoEngine.mapScene.createTexture(e, this._textureId, "nearest", "archivable");
a.call(this, e, e.scene.renderer.getEmptyTexture());
this._charName = null;
this._title = null;
this._titleId = null;
this._ornamentId = null;
this._ornamentAssetId = null;
this._guild = null;
this._gender = null;
this._alliance = null;
this._alignment = null;
this._nicknameLabelCanvas = new p();
this._textCanvas = this._nicknameLabelCanvas.getTextCanvas();
this._canvas = this._nicknameLabelCanvas.getCanvas();
this._guildEmblem = new l({
  width: 40,
  height: 40
});
this._allianceEmblem = new l({
  width: 40,
  height: 40
});
this._textureId = "none";
o(n, a);
e.exports = n;
n.hasFullNicknameLabelData = function (e) {
  var t = e.data;
  if (!t.humanoidInfo) {
    return !1;
  }
  for (var i = t.humanoidInfo.options || [], n = !1, o = 0; o < i.length; o++) {
    var a = i[o];
    if ("HumanOptionOrnament" === a._type || "HumanOptionTitle" === a._type) {
      n = !0;
      break;
    }
  }
  var s = t.alignmentInfos && 0 !== t.alignmentInfos.alignmentGrade;
  return n || s;
};
n.prototype.getType = function () {
  return this._type;
};
n.prototype.set = function (e, t) {
  this._nicknameLabelCanvas.clearAll();
  this._type = t;
  this.hasOrnament = !1;
  this.hasGuild = !1;
  this.hasAlliance = !1;
  this.hasTitle = !1;
  this.hasWings = !1;
  var i = e.data,
    n = {};
  if (n.name = i.name, "full" === t) {
    for (var o, a, s, r, l = i.humanoidInfo.options || [], c = 0; c < l.length; c += 1) {
      var d = l[c];
      "HumanOptionGuild" === d._type ? (s = d.guildInformations, this.hasGuild = !0) : "HumanOptionAlliance" === d._type ? (r = d.allianceInformations, this.hasAlliance = !0) : "HumanOptionOrnament" === d._type ? (a = d.ornamentId, this.hasOrnament = !0) : "HumanOptionTitle" === d._type && (o = d.titleId, this.hasTitle = !0);
    }
    i.alignmentInfos && 0 !== i.alignmentInfos.alignmentGrade && (this.hasWings = !0);
    var u = i.alignmentInfos.characterPower - i.actorId,
      h = window.gui.playerData.getLevelDiff(u);
    this.setAttributes({
      charName: i.name,
      titleId: o,
      ornamentId: a,
      guild: s,
      alliance: r,
      gender: i.humanoidInfo.sex,
      alignmentInfos: i.alignmentInfos,
      levelDiff: h
    });
    this.hasNameOnly = !1;
    n.gender = i.humanoidInfo.sex;
    n.guild = s;
    n.alliance = r;
    n.alignment = i.alignmentInfos;
    n.titleId = o;
    n.ornamentId = a;
  } else {
    this.setAttributes({
      charName: i.name
    });
    this.hasNameOnly = !0;
  }
  this._setTextureId(n);
  this.displayOnActor(e);
};
n.prototype._setTextureId = function (e) {
  this._textureId = e.name;
  this.hasNameOnly || (this.hasGuild && (this._textureId += ".g" + e.guild.guildId), this.hasAlliance && (this._textureId += ".a" + e.alliance.allianceId), this.hasTitle && (this._textureId += ".t" + e.titleId), this.hasWings ? this._textureId += ".w" + e.alignment.alignmentSide + "." + e.alignment.alignmentGrade : this.hasOrnament && (this._textureId += ".o" + e.ornamentId));
};
n.prototype.setAttributes = function (e) {
  e = e || {};
  this._charName = e.hasOwnProperty("charName") ? e.charName : null;
  this._guild = e.hasOwnProperty("guild") ? e.guild : null;
  this._alliance = e.hasOwnProperty("alliance") ? e.alliance : null;
  this._alignment = e.hasOwnProperty("alignmentInfos") ? e.alignmentInfos : null;
  this._levelDiff = e.levelDiff;
  this._ornamentId = e.hasOwnProperty("ornamentId") ? e.ornamentId : null;
  this._ornamentAssetId = e.hasOwnProperty("ornamentAssetId") ? e.ornamentAssetId : null;
  this._title = e.hasOwnProperty("title") ? e.title : null;
  this._titleId = e.hasOwnProperty("titleId") ? e.titleId : null;
  this._gender = e.hasOwnProperty("gender") ? e.gender : null;
};
n.prototype.changeAttributes = function (e) {
  e = e || {};
  for (var t in e) {
    this.hasOwnProperty("_" + t) && (this["_" + t] = e[t]);
  }
};
n.prototype.displayOnActor = function (e) {
  var t = this,
    i = function (i) {
      if (window.actorManager.getActor(e.actorId)) {
        if (i) {
          return console.error(i);
        }
        t.hasWings ? t._nicknameLabelCanvas.updateWithWings() : t._nicknameLabelCanvas.update();
        t.setTexture(t._canvas);
        var n = e.bbox,
          o = n[0] + (n[1] - n[0]) / 2,
          a = n[2];
        t.x = o - t.w / 2;
        t.y = a - t.h;
        t.show();
      }
    };
  this.display(i);
};
n.prototype.display = function (e) {
  var t = this;
  t.hide();
  this._preload(function (i) {
    return i ? e(i) : (t._calculateDimension(), !t._ornamentAssetId || t._alignment && 0 !== t._alignment.alignmentGrade ? (t._resizeTextCanvas(t._textWidth, t._textHeight, 0, 0), t._displayText(), t._alignment && 0 !== t._alignment.alignmentGrade ? t._displayWings(e) : e()) : (1 === t._textCanvas.width && t._displayTextAndOrnament(), e()));
  });
};
n.prototype._loadOrnament = function (e) {
  var t = this;
  r.series([function (e) {
    return t._ornamentId ? void d.getData("Ornaments", t._ornamentId, function (i, n) {
      return i ? e(i) : n ? (t._ornamentAssetId = n.assetId, void e()) : e("staticContent.getData Ornaments - ornamentData is " + n);
    }) : e();
  }, function (e) {
    return t._ornamentAssetId ? void c.loadModel("ornaments", "ornament_" + t._ornamentAssetId, function (i, n) {
      t._jsonObj = i;
      t._image = n;
      e();
    }) : e();
  }], e);
};
n.prototype._preload = function (e) {
  var t = this;
  r.parallel([function (e) {
    t._loadOrnament(e);
  }, function (e) {
    return t._titleId ? void d.getData("Titles", t._titleId, function (i, n) {
      return i ? e(i) : n ? (t._title = t._gender ? n.nameFemaleId : n.nameMaleId, void e()) : e("staticContent.getData Titles - titleData is " + n);
    }) : e();
  }, function (e) {
    return t._guild && t._guild.guildEmblem ? void t._guildEmblem.setValue(t._guild.guildEmblem, !0, e) : e();
  }, function (e) {
    return t._alliance && t._alliance.allianceEmblem ? void t._allianceEmblem.setValue(t._alliance.allianceEmblem, !0, e) : e();
  }, function (e) {
    if (!t._alignment || 0 === t._alignment.alignmentGrade) {
      return e();
    }
    var i = window.gui.playerData.alignment;
    i.getTopWings(t._alignment, function (i) {
      i && (t._topWingsInfo = i);
      e();
    });
  }, function (e) {
    if (!t._alignment || 0 === t._alignment.alignmentGrade) {
      return e();
    }
    var i = window.gui.playerData.alignment;
    i.getBottomWings(t._alignment, function (i) {
      i && (t._bottomWingsInfo = i);
      e();
    });
  }], e);
};
n.prototype._calculateDimension = function () {
  var e = this._textCanvas.getContext("2d"),
    t = [],
    i = 0,
    n = 0;
  if (e.font = w, this._nameWidth = e.measureText(this._charName).width, t.push(this._nameWidth), n = _, this.hasNameOnly ? (m = 0, f = 0, M = 3, T = 0) : (m = 160, f = 40, M = 10, T = 5), this.hasGuild) {
    var o = this._guild.guildName;
    e.font = y;
    this._guildNameWidth = e.measureText(o).width;
    t.push(this._guildNameWidth + A);
    t.push(this._nameWidth + A);
    n += T + g;
  }
  if (this.hasAlliance && (t.push(this._guildNameWidth + 2 * A), t.push(this._nameWidth + 2 * A)), this.hasTitle) {
    e.font = b;
    var a = this._title,
      s = e.measureText(a).width;
    t.push(s);
    n += T + v;
  }
  i = Math.max.apply(null, t) + 2 * M;
  n += 2 * M;
  i = Math.round(i);
  n = Math.round(n);
  this._textWidth = Math.max(i, m);
  this._textHeight = Math.max(n, f);
  this._diffWidth = this._textWidth - m;
  this._diffHeight = this._textHeight - f;
};
n.prototype._displayText = function () {
  var e = this._textWidth,
    t = this._textHeight;
  this._nicknameLabelCanvas.displayTextBackground(e, t);
  var i = Math.max(this._guildNameWidth || 0, this._nameWidth),
    n = i + (this.hasGuild ? A : 0) + (this.hasAlliance ? A : 0),
    o = Math.round(i / 2),
    a = Math.round((e - n) / 2) + (this._guild ? A : 0),
    s = M;
  if (this.hasNameOnly && (s = 0), this.hasGuild && (s += g, this._nicknameLabelCanvas.displayText(this._guild.guildName, a + o, s, y, "#ffffff"), s += T), this._charName && (s += _, this._nicknameLabelCanvas.displayText(this._charName, a + o, s, w, "#ffffff"), s += T), this.hasTitle) {
    s += v;
    var r = this._title;
    this._nicknameLabelCanvas.displayText(r, Math.round(e / 2), s, b, "#00B346");
  }
  this.hasGuild && this._nicknameLabelCanvas.displayImage(this._guildEmblem.getContext().canvas, a - A, M, 40, 40);
  this.hasAlliance && this._nicknameLabelCanvas.displayImage(this._allianceEmblem.getContext().canvas, a + i + I, M, 40, 40);
};
n.prototype._displayWings = function (e) {
  this._alignment && this._alignment.alignmentSide !== u.ALIGNMENT_NEUTRAL && 0 !== this._alignment.alignmentGrade && (this._glowMargin = 20, this._opacity = this._levelDiff === -1 ? .6 : 1, this._shadowBlur = 1 === this._levelDiff ? this._glowMargin : 0, this._shadowColor = this._alignment.alignmentSide === u.ALIGNMENT_ANGEL ? "#ffffff" : "#ff0018", this._getWingsImages(e));
};
n.prototype._getWingsImages = function (e) {
  var t = this;
  r.parallel([function (e) {
    h.loadImage(t._topWingsInfo.imagePath, function (i) {
      t._nicknameLabelCanvas.displayWingPart(i, t._topWingsInfo, !0);
      e();
    });
  }, function (e) {
    return t._bottomWingsInfo ? void h.loadImage(t._bottomWingsInfo.imagePath, function (i) {
      t._nicknameLabelCanvas.displayWingPart(i, t._bottomWingsInfo, !1);
      e();
    }) : e();
  }], e);
};
n.prototype._displayTextAndOrnament = function () {
  var e = this._diffWidth,
    t = this._diffHeight,
    i = this._jsonObj;
  if (i) {
    var n = this._image,
      o = Math.round(e / 2),
      a = Math.round(t / 2);
    for (var s in i.symbols) {
      var r = i.symbols[s];
      if (r.className && r.className.indexOf("ornament_") !== -1) {
        this._resizeOrnament(r);
        for (var l = r.children.length - 1; l >= 0; l--) {
          var c = r.children[l],
            d = c.id,
            u = i.symbols[d],
            h = c.matrices[0],
            p = i.matrices[h],
            g = p[0],
            _ = p[1],
            v = p[2],
            y = p[3],
            w = p[4],
            b = p[5];
          switch (c.name) {
            case "left":
              b += a;
              break;
            case "right":
              w += e;
              b += a;
              break;
            case "picto":
              w += o;
              break;
            case "top":
              w += o;
              break;
            case "bottom":
              w += o;
              b += t;
          }
          this._nicknameLabelCanvas.saveAndTransform(g, _, v, y, w, b);
          this._nicknameLabelCanvas.displayTextAndOrnament(c.name, n, u, e, t, m, f);
          "bg" === c.name && this._displayText();
          this._nicknameLabelCanvas.restore();
        }
      }
    }
  }
};
n.prototype._resizeTextCanvas = function (e, t, i, n) {
  var o = this._textCanvas.getContext("2d");
  this._textCanvas.width = e;
  this._textCanvas.height = t;
  o.clearRect(0, 0, e, t);
  o.translate(i, n);
};
n.prototype._resizeOrnament = function (e) {
  var t = 1 / 0,
    i = 1 / 0,
    n = -(1 / 0),
    o = -(1 / 0);
  if (e.children.length) {
    for (var a = e.children.length - 1; a >= 0; a--) {
      var s = e.children[a],
        r = s.id,
        l = this._jsonObj.symbols[r];
      if (l.isGraphic) {
        var c = s.matrices[0],
          d = this._jsonObj.matrices[c],
          u = d[4] + l.x || 0,
          h = d[5] + l.y || 0;
        t = Math.min(t, h);
        i = Math.min(i, u);
        n = Math.max(n, u + l.w);
        o = Math.max(o, h + l.h);
      }
    }
    var p = Math.round(n - i + this._diffWidth),
      m = Math.round(o - t + this._diffHeight);
    this._resizeTextCanvas(p, m, -i, -t);
  }
};
this._nicknameLabelCanvas.clearAll();
this._type = t;
this.hasOrnament = !1;
this.hasGuild = !1;
this.hasAlliance = !1;
this.hasTitle = !1;
this.hasWings = !1;
this.setAttributes({
  charName: i.name,
  titleId: o,
  ornamentId: a,
  guild: s,
  alliance: r,
  gender: i.humanoidInfo.sex,
  alignmentInfos: i.alignmentInfos,
  levelDiff: h
});
this.hasNameOnly = !1;
n.gender = i.humanoidInfo.sex;
n.guild = s;
n.alliance = r;
n.alignment = i.alignmentInfos;
n.titleId = o;
n.ornamentId = a;
this.setAttributes({
  charName: i.name
});
this.hasNameOnly = !0;
this._setTextureId(n);
this.displayOnActor(e);
this._textureId = e.name;
this.hasNameOnly || (this.hasGuild && (this._textureId += ".g" + e.guild.guildId), this.hasAlliance && (this._textureId += ".a" + e.alliance.allianceId), this.hasTitle && (this._textureId += ".t" + e.titleId), this.hasWings ? this._textureId += ".w" + e.alignment.alignmentSide + "." + e.alignment.alignmentGrade : this.hasOrnament && (this._textureId += ".o" + e.ornamentId));
e = e || {};
this._charName = e.hasOwnProperty("charName") ? e.charName : null;
this._guild = e.hasOwnProperty("guild") ? e.guild : null;
this._alliance = e.hasOwnProperty("alliance") ? e.alliance : null;
this._alignment = e.hasOwnProperty("alignmentInfos") ? e.alignmentInfos : null;
this._levelDiff = e.levelDiff;
this._ornamentId = e.hasOwnProperty("ornamentId") ? e.ornamentId : null;
this._ornamentAssetId = e.hasOwnProperty("ornamentAssetId") ? e.ornamentAssetId : null;
this._title = e.hasOwnProperty("title") ? e.title : null;
this._titleId = e.hasOwnProperty("titleId") ? e.titleId : null;
this._gender = e.hasOwnProperty("gender") ? e.gender : null;
t.hasWings ? t._nicknameLabelCanvas.updateWithWings() : t._nicknameLabelCanvas.update();
t.setTexture(t._canvas);
t.x = o - t.w / 2;
t.y = a - t.h;
t.show();
t.hide();
this._preload(function (i) {
  return i ? e(i) : (t._calculateDimension(), !t._ornamentAssetId || t._alignment && 0 !== t._alignment.alignmentGrade ? (t._resizeTextCanvas(t._textWidth, t._textHeight, 0, 0), t._displayText(), t._alignment && 0 !== t._alignment.alignmentGrade ? t._displayWings(e) : e()) : (1 === t._textCanvas.width && t._displayTextAndOrnament(), e()));
});
t._jsonObj = i;
t._image = n;
e();
i && (t._topWingsInfo = i);
e();
i && (t._bottomWingsInfo = i);
e();
e.font = y;
this._guildNameWidth = e.measureText(o).width;
t.push(this._guildNameWidth + A);
t.push(this._nameWidth + A);
n += T + g;
t.push(s);
n += T + v;
i = Math.max.apply(null, t) + 2 * M;
n += 2 * M;
i = Math.round(i);
n = Math.round(n);
this._textWidth = Math.max(i, m);
this._textHeight = Math.max(n, f);
this._diffWidth = this._textWidth - m;
this._diffHeight = this._textHeight - f;
this.hasGuild && this._nicknameLabelCanvas.displayImage(this._guildEmblem.getContext().canvas, a - A, M, 40, 40);
this.hasAlliance && this._nicknameLabelCanvas.displayImage(this._allianceEmblem.getContext().canvas, a + i + I, M, 40, 40);
t._nicknameLabelCanvas.displayWingPart(i, t._topWingsInfo, !0);
e();
t._nicknameLabelCanvas.displayWingPart(i, t._bottomWingsInfo, !1);
e();
w += e;
b += a;
w += o;
b += t;
this._nicknameLabelCanvas.saveAndTransform(g, _, v, y, w, b);
this._nicknameLabelCanvas.displayTextAndOrnament(c.name, n, u, e, t, m, f);
"bg" === c.name && this._displayText();
this._nicknameLabelCanvas.restore();
this._textCanvas.width = e;
this._textCanvas.height = t;
o.clearRect(0, 0, e, t);
o.translate(i, n);
t = Math.min(t, h);
i = Math.min(i, u);
n = Math.max(n, u + l.w);
o = Math.max(o, h + l.h);
this._canvas = document.createElement("canvas");
this._ctx = this._canvas.getContext("2d");
this._topCanvas = document.createElement("canvas");
this._topCtx = this._topCanvas.getContext("2d");
this._bottomCanvas = document.createElement("canvas");
this._bottomCtx = this._bottomCanvas.getContext("2d");
this._textCanvas = document.createElement("canvas");
this._textCtx = this._textCanvas.getContext("2d");
this._canvas.width = 1;
this._canvas.height = 1;
this._topCanvas.width = 1;
this._topCanvas.height = 1;
this._bottomCanvas.width = 1;
this._bottomCanvas.height = 1;
this._bottomOffset = 0;
this._textCanvas.width = 1;
this._textCanvas.height = 1;
this._textOffset = 0;
this._top = !1;
this._bottom = !1;
this._text = !1;
this._canvasHasContents = !1;
e.width = 1;
e.height = 1;
e.exports = i;
i.prototype.displayTextBackground = function (e, t) {
  var i = this._textCtx;
  i.fillStyle = "rgba(0, 0, 0, 0.8)";
  var n = 5;
  i.beginPath();
  i.moveTo(n, 0);
  i.lineTo(e - n, 0);
  i.quadraticCurveTo(e, 0, e, n);
  i.lineTo(e, t - n);
  i.quadraticCurveTo(e, t, e - n, t);
  i.lineTo(n, t);
  i.quadraticCurveTo(0, t, 0, t - n);
  i.lineTo(0, n);
  i.quadraticCurveTo(0, 0, n, 0);
  i.closePath();
  i.fill();
  i.textAlign = "center";
};
i.prototype.displayText = function (e, t, i, n, o) {
  var a = this._textCtx;
  a.font = n;
  a.fillStyle = o;
  a.fillText(e, t, i);
};
i.prototype.displayImage = function (e, t, i, n, o) {
  this._textCtx.drawImage(e, t, i, n, o);
};
i.prototype._syncCanvas = function (e, t, i) {
  var n = document.createElement("canvas"),
    o = n.getContext("2d");
  n.width = Math.max(this._canvas.width, t.width);
  var a = 0;
  t.width > this._canvas.width && (a = t.width / 2 - this._canvas.width / 2);
  var s = n.width / 2 - t.width / 2;
  e ? (n.height = this._canvas.height + t.height + i, o.drawImage(t, s, 0), this._canvasHasContents && o.drawImage(this._canvas, a, t.height + i)) : (n.height = this._canvas.height + t.height + i, o.drawImage(t, s, this._canvas.height + i), this._canvasHasContents && o.drawImage(this._canvas, 0, 0));
  this._canvas.width = n.width;
  this._canvas.height = n.height;
  this._ctx.drawImage(n, 0, 0);
};
i.prototype.updateWithWings = function () {
  n(this._canvas);
  this._top ? (this._canvasHasContents = !0, this._syncCanvas(!1, this._textCanvas, 0), this._syncCanvas(!0, this._topCanvas, this._textOffset)) : this._syncCanvas(!1, this._textCanvas, 0);
  this._bottom && this._syncCanvas(!1, this._bottomCanvas, this._bottomOffset);
};
i.prototype.update = function () {
  n(this._canvas);
  this._syncCanvas(!1, this._textCanvas, 0);
};
i.prototype.clearAll = function () {
  n(this._canvas);
  this._canvasHasContents = !1;
  n(this._topCanvas);
  this._top = !1;
  this._textOffset = 0;
  n(this._bottomCanvas);
  this._bottom = !1;
  this._bottomOffset = 0;
  n(this._textCanvas);
  this._text = !1;
};
i.prototype.displayWingPart = function (e, t, i) {
  var o = document.createElement("canvas"),
    a = o.getContext("2d");
  o.height = e.height;
  o.width = e.width;
  a.drawImage(e, 0, 0);
  i ? (n(this._topCanvas), this._textOffset = -(t.top + o.height), this._topCanvas.width = o.width, this._topCanvas.height = o.height, this._topCtx.drawImage(o, 0, 0), this._top = !0) : (n(this._bottomCanvas), this._bottomOffset = t.top - o.height, this._bottomCanvas.width = o.width, this._bottomCanvas.height = o.height, this._bottomCtx.drawImage(o, 0, 0), this._bottom = !0);
};
i.prototype.saveAndTransform = function (e, t, i, n, o, a) {
  var s = this._textCtx;
  s.save();
  s.transform(e, t, i, n, o, a);
  this._isTransformed = !0;
};
i.prototype.restore = function () {
  var e = this._textCtx;
  this._isTransformed && (this._isTransformed = !1, e.restore());
};
i.prototype.displayTextAndOrnament = function (e, t, i, n, o, a, s) {
  var r = this._textCtx;
  if ("bg" === e) {
    var l = i.sw / i.w,
      c = i.sh / i.h,
      d = .5 * a - i.x,
      u = .5 * s - i.y,
      h = i.w + i.x - .5 * a,
      p = i.h + i.y - .5 * s;
    r.drawImage(t, i.sx, i.sy, d * l, u * c, i.x, i.y, d, u);
    r.drawImage(t, i.sx + d * l, i.sy, h * l, u * c, i.x + d + n, i.y, h, u);
    r.drawImage(t, i.sx, i.sy + u * c, d * l, p * c, i.x, i.y + u + o, d, p);
    r.drawImage(t, i.sx + d * l, i.sy + u * c, h * l, p * c, i.x + d + n, i.y + u + o, h, p);
    r.drawImage(t, i.sx + d * l, i.sy, 1 * l, u * c, i.x + d, i.y, n, u);
    r.drawImage(t, i.sx + d * l, i.sy + u * c, 1 * l, p * c, i.x + d, i.y + u + o, n, p);
    r.drawImage(t, i.sx, i.sy + u * c, d * l, 1 * c, i.x, i.y + u, d, o);
    r.drawImage(t, i.sx + d * l, i.sy + u * c, d * l, 1 * c, i.x + d + n, i.y + u, d, o);
  } else {
    r.drawImage(t, i.sx, i.sy, i.sw, i.sh, i.x, i.y, i.w, i.h);
  }
};
i.prototype.getCanvas = function () {
  return this._canvas;
};
i.prototype.getTextCanvas = function () {
  return this._textCanvas;
};
i.beginPath();
i.moveTo(n, 0);
i.lineTo(e - n, 0);
i.quadraticCurveTo(e, 0, e, n);
i.lineTo(e, t - n);
i.quadraticCurveTo(e, t, e - n, t);
i.lineTo(n, t);
i.quadraticCurveTo(0, t, 0, t - n);
i.lineTo(0, n);
i.quadraticCurveTo(0, 0, n, 0);
i.closePath();
i.fill();
i.textAlign = "center";
a.font = n;
a.fillStyle = o;
a.fillText(e, t, i);
e ? (n.height = this._canvas.height + t.height + i, o.drawImage(t, s, 0), this._canvasHasContents && o.drawImage(this._canvas, a, t.height + i)) : (n.height = this._canvas.height + t.height + i, o.drawImage(t, s, this._canvas.height + i), this._canvasHasContents && o.drawImage(this._canvas, 0, 0));
this._canvas.width = n.width;
this._canvas.height = n.height;
this._ctx.drawImage(n, 0, 0);
n(this._canvas);
this._top ? (this._canvasHasContents = !0, this._syncCanvas(!1, this._textCanvas, 0), this._syncCanvas(!0, this._topCanvas, this._textOffset)) : this._syncCanvas(!1, this._textCanvas, 0);
this._bottom && this._syncCanvas(!1, this._bottomCanvas, this._bottomOffset);
n(this._canvas);
this._syncCanvas(!1, this._textCanvas, 0);
n(this._canvas);
this._canvasHasContents = !1;
n(this._topCanvas);
this._top = !1;
this._textOffset = 0;
n(this._bottomCanvas);
this._bottom = !1;
this._bottomOffset = 0;
n(this._textCanvas);
this._text = !1;
o.height = e.height;
o.width = e.width;
a.drawImage(e, 0, 0);
i ? (n(this._topCanvas), this._textOffset = -(t.top + o.height), this._topCanvas.width = o.width, this._topCanvas.height = o.height, this._topCtx.drawImage(o, 0, 0), this._top = !0) : (n(this._bottomCanvas), this._bottomOffset = t.top - o.height, this._bottomCanvas.width = o.width, this._bottomCanvas.height = o.height, this._bottomCtx.drawImage(o, 0, 0), this._bottom = !0);
s.save();
s.transform(e, t, i, n, o, a);
this._isTransformed = !0;
r.drawImage(t, i.sx, i.sy, d * l, u * c, i.x, i.y, d, u);
r.drawImage(t, i.sx + d * l, i.sy, h * l, u * c, i.x + d + n, i.y, h, u);
r.drawImage(t, i.sx, i.sy + u * c, d * l, p * c, i.x, i.y + u + o, d, p);
r.drawImage(t, i.sx + d * l, i.sy + u * c, h * l, p * c, i.x + d + n, i.y + u + o, h, p);
r.drawImage(t, i.sx + d * l, i.sy, 1 * l, u * c, i.x + d, i.y, n, u);
r.drawImage(t, i.sx + d * l, i.sy + u * c, 1 * l, p * c, i.x + d, i.y + u + o, n, p);
r.drawImage(t, i.sx, i.sy + u * c, d * l, 1 * c, i.x, i.y + u, d, o);
r.drawImage(t, i.sx + d * l, i.sy + u * c, d * l, 1 * c, i.x + d + n, i.y + u, d, o);
n.prototype.openPlayerContextualMenu = function (e) {
  var t = this.data;
  if (!t || !t.accountId) {
    return void console.error("openPlayerContextualMenu was called on non player actor", this.actorId);
  }
  var i = this.cellId;
  window.gui.openContextualMenu("player", {
    accountId: t.accountId,
    playerId: t.playerId,
    playerName: t.name,
    cellId: i,
    isMutant: "GameRolePlayMutantInformations" === t.type,
    humanoidInfoOptions: t.humanoidInfo && t.humanoidInfo.options,
    alignmentInfos: t.alignmentInfos,
    isInteractiveRequired: !0
  }, e);
};
n.prototype.openNpcContextualMenu = function (e) {
  var t = this.data;
  if (!t || !t.npcData) {
    return void console.error("openNpcContextualMenu was called on non npc actor", this.actorId);
  }
  var i = window.isoEngine,
    n = i.mapRenderer.map.id,
    o = this.actorId;
  return window.gui.scenarioManager.checkCondition(window.gui.scenarioManager.conditionTypeEnum.NPC_INTERACTION, {
    npcId: t.npcId
  }), 0 === t.npcData.actions.length ? void i.highlightActorOnAction(o) : 1 === t.npcData.actions.length && window.gui.playerData.isAlive() ? (i.highlightActorOnAction(o), a(t.npcData, this.actorId, n, t.npcData.actions[0])) : void window.gui.openContextualMenu("npc", {
    actorId: o,
    npcId: t.npcId,
    npcData: t.npcData,
    mapId: n
  }, e);
};
n.prototype.tap = function (e, t) {
  var i = this.actorId,
    n = this.cellId,
    a = this.data,
    r = this.scene.convertSceneToCanvasCoordinate(e, t),
    l = {
      x: r.x,
      y: r.y,
      isCanvasCoordinate: !0
    },
    c = window.actorManager.getActorsOnCell(n).length,
    d = window.actorManager.getActorsOnCellByTypes(n),
    u = d.onlinePlayer,
    h = u.length,
    p = d.npc,
    m = d.other;
  if (1 === c) {
    switch (a.type) {
      case "GameRolePlayGroupMonsterInformations":
        window.gui.openContextualMenu("monster", a, l);
        break;
      case "GameRolePlayPrismInformations":
        window.gui.openContextualMenu("prism", a, l);
        break;
      case "GameRolePlayTaxCollectorInformations":
        a.mapId = window.isoEngine.mapRenderer.map.id;
        window.gui.openContextualMenu("taxCollector", a, l);
        break;
      case "GameRolePlayNpcInformations":
      case "GameRolePlayNpcWithQuestInformations":
        var f = window.isoEngine,
          g = f.mapRenderer.map.id,
          _ = a.npcId;
        if (!_) {
          return;
        }
        var v = a.npcData;
        if (!v) {
          return console.error("NPC id", _, "missing in database on mapId", g);
        }
        this.openNpcContextualMenu(l);
        break;
      case "GameRolePlayCharacterInformations":
      case "GameRolePlayMutantInformations":
        1 === h ? this.openPlayerContextualMenu(l) : this.isFollower || console.error("nbOnlinePlayersOnCell has an unexpected value (< 1): ", h, this.actorId);
        break;
      case "FightTeamInformations":
      case "FightAllianceTeamInformations":
      case "FightTeamLightInformations":
        window.gui.openContextualMenu("fightTeam", a, l);
        break;
      case "GameFightMutantInformations":
      case "GameFightCharacterInformations":
        window.gui.openContextualMenu("player", {
          playerId: a.playerId,
          playerName: a.name,
          isMutant: "GameFightMutantInformations" === a.type
        }, l);
        break;
      case "GameRolePlayMountInformations":
        var y = [{
          caption: o("ui.mount.viewMountDetails"),
          cb: function () {
            s.getWindow("mount").showPaddockMount(i);
          }
        }];
        window.gui.openContextualMenu("generic", {
          title: (a.name || o("ui.common.noName")) + "\n" + o("ui.mount.mountOf", a.ownerName) + "\n" + o("ui.common.rank", a.level),
          actions: y
        }, l);
        break;
      case "GameFightMonsterInformations":
      case "GameFightMonsterWithAlignmentInformations":
      case "GameFightTaxCollectorInformations":
        return void window.gui.openContextualMenu("fightSwap", a, l);
      case "PaddockObject":
        window.gui.openContextualMenu("paddockObject", {
          cellId: n,
          paddockObjectName: this.data.name
        }, l);
    }
  } else {
    window.gui.openContextualMenu("playersList", {
      coordinates: l,
      actors: u,
      npc: p[0],
      monster: m[0]
    });
  }
};
a.mapId = window.isoEngine.mapRenderer.map.id;
window.gui.openContextualMenu("taxCollector", a, l);
n.prototype._stopDetectedAnimation = function () {
  this.detectedAnimationTween && (this.detectedAnimationTween.stop(), this.detectedAnimationTween = null);
};
n.prototype.isInvisibleInFight = function () {
  var e = window.gui.fightManager;
  return !!e.isInFight() && this.isInvisible && !e.isFighterOnUsersTeam(this.actorId);
};
n.prototype.setInvisibility = function (e, t) {
  if (this.showTeamCircle(1 !== e), this._stopDetectedAnimation(), 3 === e) {
    this.removeHighlight();
    this.isInvisible = !1;
    this.actorManager.addActorOccupation(this);
  } else {
    var i = this.actorManager.userActor.getTeamId();
    t === i ? this.setHighlight(s) : (this.setHighlight(a), this.actorManager.turnIndicatorOff());
    this.isInvisible = !0;
    this.actorManager.removeActorOccupation(this);
  }
};
n.prototype.invisibleDetectedAnimation = function () {
  var e = {
    red: 0,
    green: 0,
    blue: 0,
    alpha: 1
  };
  this.setHighlight(e);
  this._stopDetectedAnimation();
  this.detectedAnimationTween = new o(this.highlight, ["alpha"]).from({
    alpha: 1
  }).to({
    alpha: 0
  }, 30).start(!1);
};
this.removeHighlight();
this.isInvisible = !1;
this.actorManager.addActorOccupation(this);
t === i ? this.setHighlight(s) : (this.setHighlight(a), this.actorManager.turnIndicatorOff());
this.isInvisible = !0;
this.actorManager.removeActorOccupation(this);
this.setHighlight(e);
this._stopDetectedAnimation();
this.detectedAnimationTween = new o(this.highlight, ["alpha"]).from({
  alpha: 1
}).to({
  alpha: 0
}, 30).start(!1);
n.prototype.addSubentity = function (e, t, i) {
  var n = this;
  o.prototype.addSubentity.call(this, e, t, function (t) {
    return e.bindingPointCategory === r && (n.riderEntity = t), i && i(t);
  });
};
n.prototype.carryCharacter = function (e) {
  var t = this;
  if (this.animManager.isTemporary) {
    return console.warn("Actor animManager is not ready."), void window.setTimeout(function () {
      t.carryCharacter(e);
    }, 2e3);
  }
  var i = window.actorManager,
    n = {
      animManager: e.animManager,
      bindingPoint: "carried_3_0",
      symbolModifier: a[l],
      bindingPointCategory: l
    };
  e.getFighterData().isCarryied = !0;
  e.parentActor = t;
  t.carriedEntity = n;
  t.carriedActor = e;
  var o = !i.isCreatureModeOn && this.riderEntity || this.animManager;
  o.addAnimation({
    base: "carrying",
    direction: -1
  }, function () {
    i.isCreatureModeOn || (o.addAnimationModifier("AnimStatique", "AnimStatiqueCarrying"), o.addAnimationModifier("AnimMarche", "AnimMarcheCarrying"), o.addAnimationModifier("AnimCourse", "AnimCourseCarrying"), o.addAnimationModifier("AnimHit", "AnimHitCarrying"), o.addAnimationModifier("AnimTacle", "AnimTacleCarrying"));
    o.addSubentity(n);
    e.setDisposition(t.cellId);
    e.y = -1e3;
    t.staticAnim();
  });
};
e.getFighterData().isCarryied = !0;
e.parentActor = t;
t.carriedEntity = n;
t.carriedActor = e;
i.isCreatureModeOn || (o.addAnimationModifier("AnimStatique", "AnimStatiqueCarrying"), o.addAnimationModifier("AnimMarche", "AnimMarcheCarrying"), o.addAnimationModifier("AnimCourse", "AnimCourseCarrying"), o.addAnimationModifier("AnimHit", "AnimHitCarrying"), o.addAnimationModifier("AnimTacle", "AnimTacleCarrying"));
o.addSubentity(n);
e.setDisposition(t.cellId);
e.y = -1e3;
t.staticAnim();
r.prototype._getIcon = function (e, t) {
  return this.icons.hasOwnProperty(t) ? this.icons[t][e] : null;
};
r.prototype._setIcon = function (e, t, i) {
  this.icons.hasOwnProperty(i) || (this.icons[i] = {});
  this.icons[i][t] = e;
};
r.prototype.addConquestIcon = function (e) {
  var t = window.gui.playerData,
    i = !1,
    o = t.characters.mainCharacter.characteristics;
  if (o) {
    var a = o && o.alignmentInfos.aggressable;
    i = a !== g.NON_AGGRESSABLE;
  } else {
    console.error(new Error("characteristics of the player are null, isPlayerAggressable will be false"));
  }
  var s,
    r = e.aggressable !== g.NON_AGGRESSABLE,
    l = e.aggressable === g.PvP_ENABLED_AGGRESSABLE || e.aggressable === g.PvP_ENABLED_NON_AGGRESSABLE;
  if (i && t.alliance.hasAlliance() && r && !l) {
    var c = p.entities.prism[t.position.subAreaId];
    if (c && c.prism && c.prism.state === f.PRISM_STATE_VULNERABLE) {
      var d = e.allianceInformations.allianceId,
        u = t.alliance.current.allianceId,
        h = c.getAlliance().allianceId,
        m = this.actorId === t.id;
      switch (e.aggressable) {
        case g.AvA_DISQUALIFIED:
          m && (s = "disqualified");
          break;
        case g.AvA_PREQUALIFIED_AGGRESSABLE:
          s = m ? "prequalified" : n(d, u, h);
          break;
        case g.AvA_ENABLED_AGGRESSABLE:
          s = m ? "ally" : n(d, u, h);
      }
    }
  }
  this._getIcon(s, b.AVA) || (this.removeIconCategory(b.AVA), s && this.addIcon(s, b.AVA));
};
r.prototype.addSmileyIcon = function (e) {
  var t = this,
    i = window.gui.databases.Smileys[e];
  if (!i) {
    return console.error("Smiley " + e + " details are not available, it could not be displayed");
  }
  var n = b.SMILEY;
  this.removeIconCategory(n);
  this.addIcon(i.gfxId, n);
  (S.playing || S.starting) && S.stop();
  S.reset(I, function () {
    t.removeIconCategory(n);
  });
  S.start();
};
r.prototype.addReadyIconOnActor = function () {
  this.addIcon("Social_tx_fightState", b.UI);
};
r.prototype.removeReadyIconOnActor = function () {
  this.removeIconCategory(b.UI);
};
r.prototype.addQuestIcon = function (e, t) {
  t = t || function (e) {
    if (e) {
      return console.error("addQuestIcon:", e);
    }
  };
  var i = this,
    n = this._questIconLoadingStartTime = Date.now();
  s(e, function (e, o) {
    if (e) {
      return t(e);
    }
    if (!o) {
      return t();
    }
    if (i._getIcon(o, b.QUEST)) {
      return t();
    }
    if (n !== i._questIconLoadingStartTime) {
      return t();
    }
    var a = new c({
      layer: l.MAP_LAYER_ICONS,
      x: i.x,
      y: i.y,
      offsetY: 0,
      scene: i.scene
    });
    h.loadAnimationManager(a, "embedded", "quest", function (e) {
      var s = i._questIconLoadingStartTime;
      return i._questIconLoadingStartTime = null, n !== s ? (a.remove(), t()) : (e.assignSymbol({
        base: o,
        direction: -1
      }, !0), i.removeQuestIcon(), i._setIcon(a, o, b.QUEST), i._positionIcons(), t());
    });
  });
};
r.prototype.addIcon = function (e, t) {
  function i(e) {
    return r._cleared ? void e.release() : (r.w = e.element.width, r.h = e.element.height, r.texture = e, a._positionIcons(), void r.forceRefresh());
  }
  t = t || b.DEFAULT;
  var n = this._getIcon(e, t);
  if (!n) {
    var o;
    switch (t) {
      case b.SMILEY:
        o = "gfx/smilies/";
        break;
      case b.UI:
        o = "ui/";
        break;
      default:
        e = M[e];
        o = "gfx/icons/conquestIcon/";
    }
    if (!e) {
      return console.warn('Icon type "' + e + '" is unknown and could not be displayed.');
    }
    var a = this,
      s = o + e + ".png",
      r = new d({
        layer: l.MAP_LAYER_ICONS,
        x: this.x,
        y: this.y,
        w: 0,
        h: 0,
        scene: this.scene
      });
    this._setIcon(r, e, t);
    u.loadTexture(s, i, this.scene.renderer);
  }
};
r.prototype._positionIcons = function () {
  var e = 0;
  for (var t in b) {
    var i,
      n = b[t],
      o = 0,
      a = 0;
    for (i in this.icons[n]) {
      var s = this.icons[n][i].w;
      o += s ? s : 0;
      a++;
    }
    if (0 !== a) {
      o += T * (a - 1);
      var r = ~~(.5 * -o),
        l = 0;
      for (i in this.icons[n]) {
        var c = this.icons[n][i],
          d = c.h ? c.h : 0;
        l = Math.max(l, c.h ? c.h : 50);
        var u = this.bbox ? this.bbox[2] - this.y - d - 10 : -100;
        u -= e;
        this.y + u < 0 && (u = this.bbox ? this.bbox[3] - this.y + 10 : 100, u += e);
        c.x = this.x + r;
        c.y = this.y + u;
        c.position = this.position;
        r += c.w + T;
      }
      e += l + C;
    }
  }
  if (1 === window.gui.fightManager.fightState && this.updateTurnIndicatorPosition(), this.fighterIndicator && (this.fighterIndicator.x = this.x, this.fighterIndicator.y = this.bbox[2] - 10), this._turnNumberLabel && this._turnNumberLabel.updatePosition(this.x, this.y), this.nicknameLabel) {
    var h = this.bbox,
      p = h[0] + (h[1] - h[0]) / 2,
      m = h[2];
    this.nicknameLabel.updatePosition(p, m);
  }
};
r.prototype._calculateNicknameYOffset = function () {
  var e;
  return e = this.bbox[2] - w + y > 0 ? this.bbox[2] - w : this.y + y;
};
r.prototype.removeQuestIcon = function () {
  this._questIconLoadingStartTime = null;
  this.removeIconCategory(b.QUEST);
};
r.prototype.removeIcon = function (e, t) {
  var i = this._getIcon(e, t);
  i && (i.remove(), delete this.icons[t][e]);
};
r.prototype.removeIconCategory = function (e) {
  for (var t in this.icons[e]) {
    this.removeIcon(t, e);
  }
};
r.prototype.removeIcons = function () {
  for (var e in b) {
    var t = b[e];
    this.removeIconCategory(t);
  }
};
this.icons.hasOwnProperty(i) || (this.icons[i] = {});
this.icons[i][t] = e;
this.removeIconCategory(n);
this.addIcon(i.gfxId, n);
(S.playing || S.starting) && S.stop();
S.reset(I, function () {
  t.removeIconCategory(n);
});
S.start();
e = M[e];
o = "gfx/icons/conquestIcon/";
this._setIcon(r, e, t);
u.loadTexture(s, i, this.scene.renderer);
o += s ? s : 0;
a++;
u -= e;
this.y + u < 0 && (u = this.bbox ? this.bbox[3] - this.y + 10 : 100, u += e);
c.x = this.x + r;
c.y = this.y + u;
c.position = this.position;
r += c.w + T;
this._questIconLoadingStartTime = null;
this.removeIconCategory(b.QUEST);
p[o] = n.creatureBonesId;
p[a] = n.creatureBonesId;
r.prototype.getCreatureBones = function () {
  switch (this.data.type) {
    case "FightTeamInformations":
    case "FightAllianceTeamInformations":
    case "FightTeamLightInformations":
    case "GameRolePlayNpcInformations":
    case "GameRolePlayNpcWithQuestInformations":
      return 0;
    case "GameFightCharacterInformations":
    case "GameRolePlayCharacterInformations":
    case "GameRolePlayHumanoidInformations":
      var e = l.getLookWithoutMount(this.realLook);
      if (!e) {
        return console.error(new Error("getCreatureBones: look missing")), 666;
      }
      var t = e.bonesId;
      if (!d[t]) {
        return 1749;
      }
      var i = e.skins[0],
        n = o()[i];
      return n ? n : (console.error("getCreatureBones not found for:", t), 666);
    case "GameRolePlayPrismInformations":
      return 2247;
    case "GameRolePlayTaxCollectorInformations":
    case "GameFightTaxCollectorInformations":
      return 1813;
    case "GameRolePlayGroupMonsterInformations":
    case "GameFightMonsterInformations":
    case "GameFightMonsterWithAlignmentInformations":
      return this.data.isBoss ? 1748 : u.indexOf(this.data.creatureGenericId) >= 0 ? 2247 : this.data.isSummon ? 1765 : 1747;
    case "GameRolePlayMountInformations":
      return 1749;
    case "GameFightMutantInformations":
    case "GameRolePlayMutantInformations":
      return 1747;
    default:
      return console.error("getCreatureBones: unrecognized data type:", this.data.type), 666;
  }
};
r.prototype.setCreatureLook = function (e, t) {
  var i = t || n,
    o = "GameRolePlayPrismInformations" === this.data.type,
    r = "GameRolePlayTaxCollectorInformations" === this.data.type,
    d = this.data.humanoidInfo || o || r,
    u = this.realLook && this.realLook.bonesId === h;
  if (c.isRoleplayMode && !d || u) {
    return this.realLook ? this.setLook(this.realLook, {
      useRealLook: !0
    }, i) : i();
  }
  var p = this.getCreatureBones();
  if (!p) {
    return i();
  }
  var m = {
      bonesId: p,
      skins: [],
      indexedColors: [],
      scales: [90],
      subentities: []
    },
    f = this;
  return l.prototype.setLook.call(this, m, e, function () {
    return f.animManager.addAnimationModifier("AnimArme", a), f.animManager.addAnimationModifier("AnimAttaque", a), f.animManager.addAnimationModifier("AnimTacle", "AnimHit"), f.animManager.addAnimationModifier("AnimEmote", s), f.animManager.addAnimationModifier("AnimConsulter", "AnimAttaque0"), f.animManager.addAnimationModifier("AnimCueillir0", "AnimAttaque0"), f.animManager.addAnimationModifier("AnimCueillirSol0", "AnimAttaque0"), f.animManager.addAnimationModifier("AnimDrop", "AnimAttaque0"), f.animManager.addAnimationModifier("AnimFaucher", "AnimAttaque0"), f.animManager.addAnimationModifier("AnimHache", "AnimAttaque0"), f.animManager.addAnimationModifier("AnimPeche", "AnimAttaque0"), f.animManager.addAnimationModifier("AnimPickup", "AnimAttaque0"), f.animManager.addAnimationModifier("AnimPioche", "AnimAttaque0"), f.animManager.addAnimationModifier("AnimPuiser", "AnimAttaque0"), f.animManager.addAnimationModifier("AnimThrow", "AnimAttaque0"), f.staticAnim(i);
  });
};
n.prototype.addTeamCircle = function () {
  function e(e) {
    n.circleGraphic ? (n.circleGraphic.w = e.element.width, n.circleGraphic.h = e.element.height, n.circleGraphic.texture = e, n._positionCircle(), n.circleGraphic.forceRefresh()) : e.release();
  }
  if (!this.circleGraphic) {
    var t = this.getFighter();
    if (t) {
      var i = t.data.teamId,
        n = this;
      this.circleGraphic = new s({
        layer: a.MAP_LAYER_BACKGROUND,
        x: this.x,
        y: this.y,
        w: 0,
        h: 0,
        scene: this.scene
      });
      var r;
      0 === i ? r = u : 1 === i ? r = h : console.error("invalid team number");
      o.loadTexture(r, e, this.scene.renderer);
    }
  }
};
n.prototype.removeTeamCircle = function () {
  this.circleGraphic && (this.circleGraphic.remove(), this.circleGraphic = null);
};
n.prototype._positionCircle = function () {
  this.circleGraphic && (this.circleGraphic.x = this.x - a.CELL_WIDTH / 2, this.circleGraphic.y = this.y - a.CELL_HEIGHT / 2, this.circleGraphic.position = this.position, this.circleGraphic.forceRefresh());
};
n.prototype.showTeamCircle = function (e) {
  this.circleGraphic && (e ? this.circleGraphic.show() : this.circleGraphic.hide());
};
n.prototype.updateTurnIndicatorPosition = function () {
  var e = window.gui.fightManager.getFighter(this.actorId);
  e && e.data.alive && window.gui.fightManager.currentFighterId === e.id && (e.data.teamId === l.TEAM_CHALLENGER ? r.moveRedFeedback(this.x, this.y) : r.moveBlueFeedback(this.x, this.y));
};
n.prototype.addTurnNumber = function (e) {
  this.removeTurnNumber();
  this._turnNumberLabel = new c(this.x, this.y, e);
};
n.prototype.removeTurnNumber = function () {
  this._turnNumberLabel && (this._turnNumberLabel.remove(), this._turnNumberLabel = null);
};
n.prototype.addNicknameLabel = function (e) {
  this.nicknameLabel || (this.nicknameLabel = new d());
  this.updateNicknameLabel(e);
};
n.prototype.updateNicknameLabel = function (e) {
  e = e || !1;
  e = e && d.hasFullNicknameLabelData(this);
  e ? (this.nicknameLabel.set(this, "full"), this._hadFullNicknameLabel = !0) : (this.nicknameLabel.set(this, "name"), this._hadFullNicknameLabel = !1);
};
n.prototype.removeNicknameLabel = function () {
  this.nicknameLabel && (this.nicknameLabel.remove(), this.nicknameLabel = null);
  this._hadFullNicknameLabel = !1;
};
0 === i ? r = u : 1 === i ? r = h : console.error("invalid team number");
o.loadTexture(r, e, this.scene.renderer);
this.removeTurnNumber();
this._turnNumberLabel = new c(this.x, this.y, e);
this.nicknameLabel || (this.nicknameLabel = new d());
this.updateNicknameLabel(e);
e = e || !1;
e = e && d.hasFullNicknameLabelData(this);
e ? (this.nicknameLabel.set(this, "full"), this._hadFullNicknameLabel = !0) : (this.nicknameLabel.set(this, "name"), this._hadFullNicknameLabel = !1);
this.nicknameLabel && (this.nicknameLabel.remove(), this.nicknameLabel = null);
this._hadFullNicknameLabel = !1;
s(n, o);
e.exports = n;
n.prototype.updatePosition = function (e, t) {
  this._textImage.x = e - c;
  this._textImage.y = t - d;
};
this._textImage.x = e - c;
this._textImage.y = t - d;
this._text = i;
this._textImage = new o(i);
this._x = e;
this._y = t;
this._textImage.x = e;
this._textImage.y = t;
this._isCentered = !1;
e.exports = n;
n.prototype.updatePosition = function (e, t) {
  this._textImage.x = e;
  this._textImage.y = t;
};
n.prototype.clearTexture = function () {
  this._textImage.clear();
};
n.prototype.resetPosition = function () {
  this._textImage.x = this._x;
  this._textImage.y = this._y;
  this._isCentered = !1;
};
n.prototype.updateText = function (e) {
  if (e !== this._text) {
    var t = this.getForegroundColor(),
      i = this.getBackgroundColor();
    this.clearTexture();
    this._textImage = new o(e);
    this.resetPosition();
    this._text = e;
    this._centerText();
    this.setForegroundColor(t);
    this.setBackgroundColor(i);
  }
};
n.prototype.remove = function () {
  this._textImage.clear();
  this._textImage = null;
};
n.prototype._centerText = function () {
  this._textImage.x = this._textImage.x - this._textImage.canvas.width / 2;
  this._isCentered = !0;
};
n.prototype.setForegroundColor = function (e) {
  this._textImage.setForegroundColor(e);
};
n.prototype.setBackgroundColor = function (e) {
  this._textImage.setBackgroundColor(e);
};
n.prototype.getForegroundColor = function () {
  return this._textImage.getForegroundColor();
};
n.prototype.getBackgroundColor = function () {
  return this._textImage.getBackgroundColor();
};
this._textImage.x = e;
this._textImage.y = t;
this._textImage.x = this._x;
this._textImage.y = this._y;
this._isCentered = !1;
this.clearTexture();
this._textImage = new o(e);
this.resetPosition();
this._text = e;
this._centerText();
this.setForegroundColor(t);
this.setBackgroundColor(i);
this._textImage.clear();
this._textImage = null;
this._textImage.x = this._textImage.x - this._textImage.canvas.width / 2;
this._isCentered = !0;
this._text = e;
this.canvas = document.createElement("canvas");
this.canvas.height = t.h = r + c + 2;
this.canvasContext = this.canvas.getContext("2d");
this.canvasContext.font = r + "px " + d;
this.canvas.width = t.w = Math.ceil(this.canvasContext.measureText(e.toString()).width) + c;
this.canvasContext.font = r + "px " + d;
this.canvasContext.shadowBlur = 2;
this.canvasContext.shadowColor = "rgba(0, 0, 0, 1)";
this.canvasContext.shadowOffsetX = 1;
this.canvasContext.shadowOffsetY = 1;
a.call(this, t);
this.setForegroundColor("rgb(255, 255, 255)");
this.show();
o(n, a);
e.exports = n;
n.prototype.resetTexture = function () {
  this._setTexture();
};
n.prototype.setForegroundColor = function (e) {
  this._foregroundColor = e;
  this.canvasContext.fillStyle = e;
  this.canvasContext.textAlign = "left";
  this.canvasContext.fillText(this._text, 1, r - c);
  this._setTexture();
};
n.prototype.setBackgroundColor = function (e) {
  this._backgroundColor = e;
  this.canvasContext.fillStyle = e;
  this.canvasContext.fillRect(0, 0, this.canvas.width, this.canvas.height);
  this.canvasContext.fillRect(0, 0, this.canvas.width, this.canvas.height);
  this.setForegroundColor(this._foregroundColor);
};
n.prototype.getForegroundColor = function () {
  return this._foregroundColor;
};
n.prototype.getBackgroundColor = function () {
  return this._backgroundColor;
};
n.prototype.clear = function () {
  this.texture ? (this.texture.release(), this.texture = null) : console.warn("[CanvasText.clear] Clearing CanvasText, but it was already clear");
  this.hide();
};
n.prototype._setTexture = function () {
  this.texture && this.texture.release();
  this.texture = window.isoEngine.mapScene.createTexture(this.canvas);
};
this._foregroundColor = e;
this.canvasContext.fillStyle = e;
this.canvasContext.textAlign = "left";
this.canvasContext.fillText(this._text, 1, r - c);
this._setTexture();
this._backgroundColor = e;
this.canvasContext.fillStyle = e;
this.canvasContext.fillRect(0, 0, this.canvas.width, this.canvas.height);
this.canvasContext.fillRect(0, 0, this.canvas.width, this.canvas.height);
this.setForegroundColor(this._foregroundColor);
this.texture ? (this.texture.release(), this.texture = null) : console.warn("[CanvasText.clear] Clearing CanvasText, but it was already clear");
this.hide();
this.texture && this.texture.release();
this.texture = window.isoEngine.mapScene.createTexture(this.canvas);
this.vertices = [{
  x: -40,
  y: 60,
  r: 1,
  g: 0,
  b: 0,
  a: 1
}, {
  x: 40,
  y: 60,
  r: 1,
  g: 0,
  b: 0,
  a: 1
}, {
  x: -30,
  y: 50,
  r: 1,
  g: 1,
  b: 0,
  a: .3
}, {
  x: 30,
  y: 50,
  r: 1,
  g: 1,
  b: 0,
  a: .3
}, {
  x: -40,
  y: 40,
  r: 1,
  g: 0,
  b: 0,
  a: 1
}, {
  x: -30,
  y: 45,
  r: 1,
  g: 1,
  b: 0,
  a: .3
}, {
  x: 30,
  y: 45,
  r: 1,
  g: 1,
  b: 0,
  a: .3
}, {
  x: 40,
  y: 40,
  r: 1,
  g: 0,
  b: 0,
  a: 1
}, {
  x: 0,
  y: 10,
  r: 1,
  g: 1,
  b: 0,
  a: .5
}, {
  x: 0,
  y: 0,
  r: 1,
  g: 0,
  b: 0,
  a: 1
}];
this.triangles = [[1, 0, 2], [2, 0, 4], [4, 5, 2], [8, 5, 4], [4, 9, 8], [8, 9, 7], [7, 6, 8], [3, 6, 7], [7, 1, 3], [2, 3, 1], [3, 2, 5], [5, 6, 3], [5, 8, 6]];
o.call(this, i);
this._indicatorByteSize = this.renderer.getNbBytesPerVertex() * this.triangles.length * l;
this.updated = !0;
this.red = 1;
this.green = 1;
this.blue = 0;
this.alpha = 1;
this.sx = .4;
this.sy = .4;
this.rotation = Math.PI;
this._buffer = new window.ArrayBuffer(this._indicatorByteSize);
this._vertexBuffer = new window.Float32Array(this._buffer);
this._colorBuffer = new window.Uint32Array(this._buffer);
this.loadIndicator();
this.renderer.releaseBuffer(i.id);
this.forceRefresh();
a(n, o);
e.exports = n;
n.prototype.loadIndicator = function () {
  for (var e = 1 / 0, t = -(1 / 0), i = 1 / 0, n = -(1 / 0), o = 0; o < this.triangles.length; o++) {
    for (var a = 0; a < l; a++) {
      var s = (o * l + a) * c,
        r = this.vertices[this.triangles[o][a]],
        d = r.x,
        u = r.y,
        h = Math.max(-128, Math.min(127, 64 * r.r)),
        p = Math.max(-128, Math.min(127, 64 * this.green)),
        m = Math.max(-128, Math.min(127, 64 * r.b)),
        f = Math.max(-128, Math.min(127, 64 * (this.alpha && r.a))),
        g = (f << 24 & 4278190080) + (m << 16 & 16711680) + (p << 8 & 65280) + (255 & h);
      this._vertexBuffer[s] = d;
      this._vertexBuffer[s + 1] = u;
      this._colorBuffer[s + 3] = g;
      e > d ? e = d : t < d && (t = d);
      i > u ? i = u : n < u && (n = u);
    }
  }
  this._bbox = [e, t, i, n];
  this.updated = !0;
};
n.prototype.render = function () {
  this.renderer.save();
  this.renderer.translate(this._x, this._y);
  0 !== this._rotation && this.renderer.rotate(this._rotation);
  this.renderer.scale(this._scaleX, this._scaleY);
  this.updated && (this.renderer.drawBoxBatch(this.id), this.renderer.releaseBuffer(this.id), this.updated = !1, this.forceRefresh());
  this.renderer.restore();
};
n.prototype.generateCurrentFrameData = function () {
  var e = this.renderer.getBufferData(this.id);
  if (void 0 === e) {
    var t = this.id,
      i = !1;
    this.renderer.loadSpriteBuffer(t, this._vertexBuffer, null, this._bbox, i);
    this.renderer.lockBuffer(this.id);
  }
  return this._bbox;
};
n.prototype.clear = function () {
  this.renderer.releaseBuffer(this.id);
};
n.prototype.remove = function () {
  this.tween && this.tween.stop();
  o.prototype.remove.call(this);
};
this._vertexBuffer[s] = d;
this._vertexBuffer[s + 1] = u;
this._colorBuffer[s + 3] = g;
e > d ? e = d : t < d && (t = d);
i > u ? i = u : n < u && (n = u);
this._bbox = [e, t, i, n];
this.updated = !0;
this.renderer.save();
this.renderer.translate(this._x, this._y);
0 !== this._rotation && this.renderer.rotate(this._rotation);
this.renderer.scale(this._scaleX, this._scaleY);
this.updated && (this.renderer.drawBoxBatch(this.id), this.renderer.releaseBuffer(this.id), this.updated = !1, this.forceRefresh());
this.renderer.restore();
this.renderer.loadSpriteBuffer(t, this._vertexBuffer, null, this._bbox, i);
this.renderer.lockBuffer(this.id);
this.tween && this.tween.stop();
o.prototype.remove.call(this);
window.gui.transmitFightSequenceMessage(e);
i.oneShootAnim({
  base: "AnimTacle"
}, {
  backToStatic: !0
}, t);
window.gui.transmitFightSequenceMessage(e);
e._summon.show();
t();
i.applyLook(e._loadedLook);
t();
window.actorManager.refreshFighter(e);
t();
f = !0;
g = !1;
_ = 0;
v = null;
y = !1;
w = null;
b = [];
M = null;
E.clearMarks();
window.actorManager.removeAllFighterIndicators();
window.actorManager.allTurnNumbersOff();
window.actorManager.removeAllCarryStatus(x);
console.error("fightManager#finishFightSequence", t);
e();
e && console.error("sequenceAnimationEnd error:", e);
t();
console.error("sequenceAnimationEnd catch error:", n);
t();
d();
t.initialize = function (e) {
  function t(e) {
    E.syncMarks(e.marks);
  }
  e.on("messageSequence", m);
  e.on("GameFightTurnReadyRequestMessage", u);
  e.on("GameFightSynchronizeMessage", function (e) {
    _ = b.length;
    v = e;
    f && h(!1);
  });
  e.on("disconnect", function () {
    d();
  });
  e.on("GameFightLeaveMessage", function (t) {
    var i = t.charId === window.actorManager.userId,
      n = window.gui,
      o = n.fightManager.fightState;
    if (o === O.BATTLE) {
      var a = n.fightManager.getFighter(t.charId);
      if (a && a.data.alive) {
        var s = {
          _messageType: "messageSequence",
          sequence: [{
            _messageType: "SequenceStartMessage"
          }, {
            _messageType: "_GameActionFightLeaveMessage",
            actionId: 0,
            sourceId: 0,
            targetId: t.charId
          }, {
            _messageType: "SequenceEndMessage"
          }]
        };
        e.emit("messageSequence", s);
      }
    }
    n.transmitFightSequenceMessage(t);
    i && e.emit("GameFightEndMessage", {
      _messageType: "GameFightEndMessage"
    });
  });
  e.on("FighterStatsListMessage", function (t) {
    e.transformAndSendToFightSequence(t);
  });
  e.on("GameActionFightNoSpellCastMessage", function (t) {
    e.transformAndSendToFightSequence(t);
  });
  e.on("GameFightEndMessage", function (e) {
    window.actorManager.removeInvisibilityOfAllActors();
    w = e;
    p();
  });
  e.on("GameFightSpectateMessage", t);
  e.on("GameFightResumeMessage", t);
  e.on("GameFightResumeWithSlavesMessage", t);
  e.on("GameContextDestroyMessage", function () {
    L.isRoleplayMode || (!f && y ? window.gui.transmitFightSequenceMessage(w) : window.gui.transmitMessage({
      _messageType: "GameFightEndMessage"
    }), d());
  });
};
t.getCellIdsAffectedByMarks = E.getCellIdsAffectedByMarks;
e.on("messageSequence", m);
e.on("GameFightTurnReadyRequestMessage", u);
e.on("GameFightSynchronizeMessage", function (e) {
  _ = b.length;
  v = e;
  f && h(!1);
});
e.on("disconnect", function () {
  d();
});
e.on("GameFightLeaveMessage", function (t) {
  var i = t.charId === window.actorManager.userId,
    n = window.gui,
    o = n.fightManager.fightState;
  if (o === O.BATTLE) {
    var a = n.fightManager.getFighter(t.charId);
    if (a && a.data.alive) {
      var s = {
        _messageType: "messageSequence",
        sequence: [{
          _messageType: "SequenceStartMessage"
        }, {
          _messageType: "_GameActionFightLeaveMessage",
          actionId: 0,
          sourceId: 0,
          targetId: t.charId
        }, {
          _messageType: "SequenceEndMessage"
        }]
      };
      e.emit("messageSequence", s);
    }
  }
  n.transmitFightSequenceMessage(t);
  i && e.emit("GameFightEndMessage", {
    _messageType: "GameFightEndMessage"
  });
});
e.on("FighterStatsListMessage", function (t) {
  e.transformAndSendToFightSequence(t);
});
e.on("GameActionFightNoSpellCastMessage", function (t) {
  e.transformAndSendToFightSequence(t);
});
e.on("GameFightEndMessage", function (e) {
  window.actorManager.removeInvisibilityOfAllActors();
  w = e;
  p();
});
e.on("GameFightSpectateMessage", t);
e.on("GameFightResumeMessage", t);
e.on("GameFightResumeWithSlavesMessage", t);
e.on("GameContextDestroyMessage", function () {
  L.isRoleplayMode || (!f && y ? window.gui.transmitFightSequenceMessage(w) : window.gui.transmitMessage({
    _messageType: "GameFightEndMessage"
  }), d());
});
_ = b.length;
v = e;
f && h(!1);
n.transmitFightSequenceMessage(t);
i && e.emit("GameFightEndMessage", {
  _messageType: "GameFightEndMessage"
});
window.actorManager.removeInvisibilityOfAllActors();
w = e;
p();
n.position = a.cellId;
n.direction = a.direction;
n.bonesId = s.bonesId;
i.direction = a(t, n).direction;
e.addAnimation(s, i);
p = c === q.TOWARD_POSITION2 ? r(a, l) : r(l, a);
h.rotation = W[o] ? p + Math.PI : p;
t._trailGfxs = x;
t._trailGfxsOrientation = d;
console.error(o);
l = [];
h(e, t, i, n, l);
e.removeWaitingRequest();
h.direction = m;
t._casterOrientation = m;
y && !v.targetGfxId && (v.targetGfxId2 && console.error(new Error("Message contains a targetGfdId2 and ")), l(e, t, y, "targetGfx2", 1, _));
t._spellAnimSymbol = {
  base: "AnimAttaque",
  type: 403
};
v.missileGfxId && d(e, t, v.missileGfxId);
t._spellAnimSymbol = n(o, h && h.bonesId, v.animId, t._weaponTypeId);
v.trailGfxId && p(e, t, h, f);
t._spellAnimSymbol && s(e, c, t._spellAnimSymbol, i);
s(e, t.sourceId, {
  base: "AnimDrop"
}, i);
t._direction = a(t.sourceId, i).direction;
s(e, t.sourceId, {
  base: "AnimThrow"
}, i);
t._throwingProjectile = c(e, t.sourceId, G);
t._direction = a(t.sourceId, i).direction;
i.hide();
t._summon = i;
s(e, t.targetId, {
  base: "AnimMort"
}, i);
t._animSymbol = "AnimMort";
s(e, t.targetId, {
  base: "AnimHit"
}, i);
t._animSymbol = "AnimHit";
E.prototype.runSequence = function (e, t) {
  var i = L(e);
  this.nAssetsToLoad = 1;
  this.nAssetsLoaded = 0;
  var n = this;
  this.onAssetsLoaded = function () {
    if (n.nAssetsLoaded += 1, n.nAssetsLoaded === n.nAssetsToLoad) {
      return t();
    }
  };
  this.reduceNumberOfAssetsToLoad = function () {
    if (n.nAssetsToLoad -= 1, n.nAssetsLoaded === n.nAssetsToLoad) {
      return t();
    }
  };
  for (var o = 0; o < e.length; o++) {
    var a = e[o],
      s = V[a._messageType];
    s && s(this, a, i);
  }
  this.onAssetsLoaded();
};
E.prototype.addAnimation = function (e, t) {
  this.nAssetsToLoad += 1;
  e.animManager.addAnimation(t, this.onAssetsLoaded);
};
E.prototype.loadAnimationManager = function (e, t) {
  this.nAssetsToLoad += 1;
  k.loadAnimationManager(e, "bone", t, this.onAssetsLoaded);
};
E.prototype.loadActor = function (e) {
  return this.nAssetsToLoad += 1, window.actorManager.addActor(e, this.onAssetsLoaded);
};
E.prototype.loadLook = function (e, t, i) {
  this.nAssetsToLoad += 1;
  var n = this.onAssetsLoaded,
    o = {
      addToSprite: !1
    };
  t._isCandidateToHideTheMountInFight(i) && (i = H.getLookWithoutMount(i));
  k.loadLook(t, i, o, function (t) {
    e._loadedLook = {
      animationManager: t,
      look: i
    };
    n();
  });
};
E.prototype.addWaitingRequest = function () {
  this.nAssetsToLoad += 1;
};
E.prototype.removeWaitingRequest = function () {
  this.reduceNumberOfAssetsToLoad();
};
e.exports = E;
this.nAssetsToLoad = 1;
this.nAssetsLoaded = 0;
this.onAssetsLoaded = function () {
  if (n.nAssetsLoaded += 1, n.nAssetsLoaded === n.nAssetsToLoad) {
    return t();
  }
};
this.reduceNumberOfAssetsToLoad = function () {
  if (n.nAssetsToLoad -= 1, n.nAssetsLoaded === n.nAssetsToLoad) {
    return t();
  }
};
this.nAssetsToLoad += 1;
e.animManager.addAnimation(t, this.onAssetsLoaded);
this.nAssetsToLoad += 1;
k.loadAnimationManager(e, "bone", t, this.onAssetsLoaded);
t._isCandidateToHideTheMountInFight(i) && (i = H.getLookWithoutMount(i));
k.loadLook(t, i, o, function (t) {
  e._loadedLook = {
    animationManager: t,
    look: i
  };
  n();
});
e._loadedLook = {
  animationManager: t,
  look: i
};
n();
f = {};
g = null;
i.position = n.cellId;
i.direction = n.direction;
i.isSummoned = !0;
g && (g.targetId = t);
g = e;
g._deadIds = [];
g._lifeVariationMsgs = [];
g._pointVariationMsgs = [];
this.sourceX = 0;
this.sourceY = 0;
this.targetX = 0;
this.targetY = 0;
this.x = 0;
this.y = 0;
this.incX = 0;
this.incY = 0;
this.error = 0;
this.deltaError = 0;
this._stop = !1;
this.cb = null;
e.exports = i;
i.prototype.set = function (e, t, i, n) {
  this.sourceX = ~~e || 0;
  this.sourceY = ~~t || 0;
  this.targetX = ~~i || 0;
  this.targetY = ~~n || 0;
};
i.prototype.exec = function (e) {
  var t = [];
  e && "function" == typeof e || (e = function (e, i) {
    t.push([e, i]);
  });
  this.cb = e;
  this._stop = !1;
  this.error = 0;
  this.deltaError = 0;
  this.x = this.sourceX;
  this.y = this.sourceY;
  var i = this.targetX - this.sourceX,
    n = this.targetY - this.sourceY,
    o = Math.abs(i),
    a = Math.abs(n);
  this.incX = i > 0 ? 1 : -1;
  this.incY = n > 0 ? 1 : -1;
  var s;
  for (0 === i && 0 === n ? (this._stop = !0, s = null) : 0 === i ? s = this._vertical : 0 === n ? s = this._horizontal : o === a ? s = this._equalSlope : o > a ? (s = this._xSlope, this.deltaError = a / o) : (s = this._ySlope, this.deltaError = o / a); !this._stop;) {
    s.apply(this);
    this.x === this.targetX && this.y === this.targetY && (this._stop = !0);
    this.cb(this.x, this.y, !0);
  }
  return t;
};
i.prototype.stop = function () {
  this._stop = !0;
};
i.prototype._horizontal = function () {
  this.x += this.incX;
};
i.prototype._vertical = function () {
  this.y += this.incY;
};
i.prototype._equalSlope = function () {
  this.x += this.incX;
  this.y += this.incY;
};
i.prototype._xSlope = function () {
  this.error += this.deltaError;
  this.error >= .5 && (this.y += this.incY, this.error -= 1);
  this.x += this.incX;
};
i.prototype._ySlope = function () {
  this.error += this.deltaError;
  this.error >= .5 && (this.x += this.incX, this.error -= 1);
  this.y += this.incY;
};
this.sourceX = ~~e || 0;
this.sourceY = ~~t || 0;
this.targetX = ~~i || 0;
this.targetY = ~~n || 0;
e && "function" == typeof e || (e = function (e, i) {
  t.push([e, i]);
});
this.cb = e;
this._stop = !1;
this.error = 0;
this.deltaError = 0;
this.x = this.sourceX;
this.y = this.sourceY;
this.incX = i > 0 ? 1 : -1;
this.incY = n > 0 ? 1 : -1;
s.apply(this);
this.x === this.targetX && this.y === this.targetY && (this._stop = !0);
this.cb(this.x, this.y, !0);
this.x += this.incX;
this.y += this.incY;
this.error += this.deltaError;
this.error >= .5 && (this.y += this.incY, this.error -= 1);
this.x += this.incX;
this.error += this.deltaError;
this.error >= .5 && (this.x += this.incX, this.error -= 1);
this.y += this.incY;
a.call(this, e, e.animManager);
this.actorId = void 0 !== e.actorId ? e.actorId : null;
this.path = [];
this.step = 0;
this.moving = !1;
o(n, a);
e.exports = n;
n.prototype.isFx = !0;
n.prototype.isTapped = function () {
  return !1;
};
n.prototype.tap = function () {};
n.prototype.refreshAnimation = function (e) {
  if (this.moving === !0) {
    var t = this.path,
      i = this.step,
      n = ~~i,
      o = this.prevCoords,
      a = {
        x: r([this.source[0], this.bezier[0], this.target[0]], i / this.pathLength),
        y: r([this.source[1], this.bezier[1], this.target[1]], i / this.pathLength)
      };
    this.x = a.x;
    this.y = a.y;
    var s = a.x - o.x,
      l = a.y - o.y;
    this.rotation = Math.atan2(l, s);
    var c = t[n];
    c !== this.prevPos && (this.position = c);
    this.prevPos = c;
    this.prevCoords = a;
  }
  this._refreshAnimation(e);
};
n.prototype._startPath = function (e) {
  this.animManager.assignSymbol(h, !0);
  this.moving = !0;
  var t = this;
  new s(this, ["step"]).from({
    step: 0
  }).to({
    step: this.pathLength
  }, this.duration).start().onFinish(function () {
    return t.remove(), e();
  });
};
n.prototype.launch = function (e, t, i, n, o) {
  var a = window.isoEngine.mapRenderer.map;
  if (!a) {
    return o(new Error("map is null, isReady is " + window.isoEngine.mapRenderer.isReady));
  }
  var s = a.cells,
    r = this.position,
    l = [r],
    h = d.getMapPointFromCellId(r),
    p = d.getMapPointFromCellId(e);
  u.set(h.x, h.y, p.x, p.y);
  u.exec(function (e, t) {
    l.push(d.getCellIdFromMapPoint(e, t));
  });
  this.path = l;
  this.pathLength = l.length;
  this.mirrored = h.x > p.x;
  this.scaleY = this.mirrored ? -1 : 1;
  var m = c.getCellCoord(r),
    f = c.getCellCoord(e),
    g = Math.abs(f.x - m.x),
    _ = Math.abs(f.y - m.y),
    v = Math.sqrt(g * g + _ * _);
  this.duration = v / 10 * t / 1e3 * 24;
  m.y -= (s[r].f || 0) + n;
  f.y -= (s[e].f || 0) + n;
  m = [m.x, m.y];
  f = [f.x, f.y];
  this.source = m;
  this.target = f;
  this.bezier = [(m[0] + f[0]) / 2, (m[1] + f[1]) / 2 - v * i];
  this.prevPos = r;
  this.prevCoords = {
    x: 2 * m[0] - this.bezier[0],
    y: 2 * m[1] - this.bezier[1]
  };
  this._startPath(o);
};
this.x = a.x;
this.y = a.y;
c !== this.prevPos && (this.position = c);
this.prevPos = c;
this.prevCoords = a;
this.animManager.assignSymbol(h, !0);
this.moving = !0;
u.set(h.x, h.y, p.x, p.y);
u.exec(function (e, t) {
  l.push(d.getCellIdFromMapPoint(e, t));
});
this.path = l;
this.pathLength = l.length;
this.mirrored = h.x > p.x;
this.scaleY = this.mirrored ? -1 : 1;
this.duration = v / 10 * t / 1e3 * 24;
m.y -= (s[r].f || 0) + n;
f.y -= (s[e].f || 0) + n;
m = [m.x, m.y];
f = [f.x, f.y];
this.source = m;
this.target = f;
this.bezier = [(m[0] + f[0]) / 2, (m[1] + f[1]) / 2 - v * i];
this.prevPos = r;
this.prevCoords = {
  x: 2 * m[0] - this.bezier[0],
  y: 2 * m[1] - this.bezier[1]
};
this._startPath(o);
e.exports = i;
e.exports.prepare = n;
g && (e._targetGfx && m.playTargetGfxFirst && i(), e._targetGfx2 && m.playTargetGfxFirst2 && l());
m.casterGfxId && t.push(function (t) {
  return n.playGfx(e._casterGfx, e._casterGfxOrientation, m.casterGfxShowUnder, h), t();
});
e._missileGfx && e.destinationCellId !== -1 && t.push(function (t) {
  e._missileGfx.launch(e.destinationCellId, void 0 !== m.missileSpeed ? m.missileSpeed + 10 : 10, (m.missileCurvature || 0) / 10, m.missileGfxYOffset || 0, t);
});
m.trailGfxId && t.push(function (t) {
  n.playGfxTrailAnimation(e._trailGfxs, e._trailGfxsOrientation, m.trailGfxShowUnder, h, t);
});
g && (e._targetGfx && !m.playTargetGfxFirst && i(), e._targetGfx2 && !m.playTargetGfxFirst2 && l());
v && o.actionOrMovementPointVariationBatch(e._pointVariationMsgs, t);
(_ || v) && t.push(function (e) {
  new a(15, e).start();
});
t.push(function (t) {
  return window.gui.transmitFightSequenceMessage(e), t();
});
e.position += i ? -.1 : .1;
e.animManager.assignSymbol({
  base: "FX",
  direction: t
}, !1, function () {
  if (e.remove(), o) {
    return o();
  }
});
t.playGfx = n;
t.playGfxTrailAnimation = function (e, t, i, n, r) {
  for (var l = 0, c = 0; c < e.length; c += 1) {
    o(e[c], t, i, l, n);
    l += s;
  }
  new a(l, r).start();
};
o(e[c], t, i, l, n);
l += s;
new d(o.highlight, ["red", "green", "blue"]).from({
  red: 1,
  green: 1,
  blue: 1
}).to({
  red: 4,
  green: 4,
  blue: 4
}, 3, u.polyOut, 4).to({
  red: 1,
  green: 1,
  blue: 1
}, 8, u.polyOut, 4).start();
new d(o, ["scaleX", "scaleY"]).from({
  scaleX: .2,
  scaleY: .2
}).to({
  scaleX: 1.8,
  scaleY: 1.8
}, 4, u.polyOut, 4).to({
  scaleX: 1,
  scaleY: 1
}, 10, u.polyOut, 4).start();
new d(o, ["y", "rotation"]).from({
  y: o.y,
  rotation: e
}).to({
  y: o.y,
  rotation: e
}, 8).to({
  y: o.y - 60,
  rotation: t
}, 30, u.polyOut, 7).start();
new d(o, ["alpha"]).from({
  alpha: 0
}).to({
  alpha: 1
}, 3, u.polyOut, 4).to({
  alpha: 0
}, 38, u.polyIn, 4).start().onFinish(function () {
  o.remove();
});
o.show();
r = e.actionId === m.ACTION_CHARACTER_DEBOOST_MOVEMENT_POINTS || e.actionId === m.ACTION_CHARACTER_DEBOOST_ACTION_POINTS ? "-" + e.delta : e.delta ? e.delta > 0 ? "+" + e.delta : e.delta : e.shieldLoss ? "-" + e.shieldLoss : "-" + e.loss;
o({
  x: i.x,
  y: i.y - 70,
  maxRotation: .3,
  color: t,
  pointVariation: r,
  targetId: e.targetId
});
T[m.ACTION_CHARACTER_ACTION_POINTS_USE] = w;
T[m.ACTION_CHARACTER_MOVEMENT_POINTS_USE] = b;
T[m.ACTION_CHARACTER_MOVEMENT_POINTS_LOST] = b;
T[m.ACTION_CHARACTER_ACTION_POINTS_LOST] = w;
T[m.ACTION_CHARACTER_BOOST_ACTION_POINTS] = w;
T[m.ACTION_CHARACTER_DEBOOST_ACTION_POINTS] = w;
T[m.ACTION_CHARACTER_BOOST_MOVEMENT_POINTS] = b;
T[m.ACTION_CHARACTER_DEBOOST_MOVEMENT_POINTS] = b;
T[m.ACTION_CHARACTER_ACTION_POINTS_WIN] = w;
t.createPointVariationLabel = o;
t.lifePointVariation = function (e, t, i) {
  return e.shieldLoss ? (s(e, t, M), i()) : e._spell && e._spell.critical === f.CRITICAL_HIT ? (s(e, t, y), i()) : (s(e, t, e.criticalHit ? y : v), i());
};
t.actionOrMovementPointVariation = function (e, t) {
  p.showApMpUsed || e.actionId === m.ACTION_CHARACTER_ACTION_POINTS_LOST || e.actionId === m.ACTION_CHARACTER_MOVEMENT_POINTS_LOST ? s(e, t, T[e.actionId]) : s(e, t, null);
};
t.buffVariation = function (e, t) {
  "FightTemporaryBoostEffect" === e.effect._type && (e.effect.actionId = e.actionId, s(e.effect, t, T[e.actionId]));
  t.push(function (t) {
    window.gui.transmitFightSequenceMessage(e, t);
  });
};
t.lifePointVariationBatch = function (e, t, i) {
  g.each(e, function (e, t) {
    return e.shieldLoss ? (e._labelColor = M, t()) : e._spell && e._spell.critical === f.CRITICAL_HIT ? (e._labelColor = y, t()) : (e._labelColor = e.criticalHit ? y : v, t());
  }, function (n) {
    return r(e, t), i(n);
  });
};
t.actionOrMovementPointVariationBatch = function (e, t) {
  for (var i = 0; i < e.length; i++) {
    var n = e[i];
    n._labelColor = T[n.actionId];
  }
  r(e, t);
};
"FightTemporaryBoostEffect" === e.effect._type && (e.effect.actionId = e.actionId, s(e.effect, t, T[e.actionId]));
t.push(function (t) {
  window.gui.transmitFightSequenceMessage(e, t);
});
e.id = "textSpriteCount" + s++;
a.call(this, e);
this.characterDimensions = t.dimensions;
this.texture = t.texture;
this._characterByteSize = this.renderer.getNbBytesPerSprite();
this._bbox = [1 / 0, -(1 / 0), 1 / 0, -(1 / 0)];
this.textWidth = 0;
this.textHeight = 0;
r = i[o];
" " === r ? this.textWidth += c : (l = this.characterDimensions[r], this.textWidth += l.w, l.h > this.textHeight && (this.textHeight = l.h));
this.characterPositions[o] = {
  x: d,
  y: u + h
};
d += l.w;
o(n, a);
e.exports = n;
n.prototype._createVertexBuffer = function (e, t) {
  var i = e.length;
  this._vertexBuffer = new window.ArrayBuffer(i * this._characterByteSize);
  this._floatView = new window.Float32Array(this._vertexBuffer);
  this._longView = new window.Uint32Array(this._vertexBuffer);
  for (var n = this._floatView, o = this._longView, a = this._longView, s = this.texture.element.width, r = this.texture.element.height, l = 0; l < e.length; l += 1) {
    var c = e[l];
    if (" " !== c) {
      var d = this.characterPositions[l],
        u = this.characterDimensions[c],
        h = l * this._characterByteSize / 4,
        p = d.x,
        m = d.x + u.w,
        f = d.y,
        g = d.y + u.h;
      n[h + 0] = p;
      n[h + 1] = f;
      n[h + 5] = p;
      n[h + 6] = g;
      n[h + 10] = m;
      n[h + 11] = g;
      n[h + 15] = p;
      n[h + 16] = f;
      n[h + 20] = m;
      n[h + 21] = g;
      n[h + 25] = m;
      n[h + 26] = f;
      var _ = u.x / s * 65535 & 65535,
        v = u.y / r * 4294901760 & 4294901760,
        y = (u.x + u.w) / s * 65535 & 65535,
        w = (u.y + u.h) / r * 4294901760 & 4294901760;
      o[h + 2] = _ + v;
      o[h + 7] = _ + w;
      o[h + 12] = y + w;
      o[h + 17] = _ + v;
      o[h + 22] = y + w;
      o[h + 27] = y + v;
      var b = 1077952576;
      a[h + 3] = a[h + 8] = a[h + 13] = b;
      a[h + 18] = a[h + 23] = a[h + 28] = b;
      var M = Math.max(-128, Math.min(127, 128 * t[0])),
        T = Math.max(-128, Math.min(127, 128 * t[1])),
        C = Math.max(-128, Math.min(127, 128 * t[2])),
        I = Math.max(-128, Math.min(127, 128 * t[3])),
        A = (I << 24 & 4278190080) + (C << 16 & 16711680) + (T << 8 & 65280) + (255 & M);
      a[h + 4] = a[h + 9] = a[h + 14] = A;
      a[h + 19] = a[h + 24] = a[h + 29] = A;
    }
  }
  this.renderer.releaseBuffer(this.id);
  this.forceRefresh();
};
n.prototype.draw = function () {
  this.renderer.drawSpriteBatch(this.id);
};
n.prototype.generateCurrentFrameData = function () {
  var e = this.renderer.getBufferData(this.id);
  if (void 0 === e) {
    var t = this._floatView,
      i = !1;
    this.renderer.loadSpriteBuffer(this.id, t, this.texture, this.bbox, i);
    this.renderer.lockBuffer(this.id);
  }
  return this._bbox;
};
n.prototype.clear = function () {
  this.renderer.releaseBuffer(this.id);
};
this._vertexBuffer = new window.ArrayBuffer(i * this._characterByteSize);
this._floatView = new window.Float32Array(this._vertexBuffer);
this._longView = new window.Uint32Array(this._vertexBuffer);
n[h + 0] = p;
n[h + 1] = f;
n[h + 5] = p;
n[h + 6] = g;
n[h + 10] = m;
n[h + 11] = g;
n[h + 15] = p;
n[h + 16] = f;
n[h + 20] = m;
n[h + 21] = g;
n[h + 25] = m;
n[h + 26] = f;
o[h + 2] = _ + v;
o[h + 7] = _ + w;
o[h + 12] = y + w;
o[h + 17] = _ + v;
o[h + 22] = y + w;
o[h + 27] = y + v;
a[h + 3] = a[h + 8] = a[h + 13] = b;
a[h + 18] = a[h + 23] = a[h + 28] = b;
a[h + 4] = a[h + 9] = a[h + 14] = A;
a[h + 19] = a[h + 24] = a[h + 29] = A;
this.renderer.releaseBuffer(this.id);
this.forceRefresh();
this.renderer.loadSpriteBuffer(this.id, t, this.texture, this.bbox, i);
this.renderer.lockBuffer(this.id);
t.mapMovement = function (e, t) {
  t.push(function (t) {
    n(e.actorId);
    window.gui.transmitFightSequenceMessage(e);
    window.actorManager.actorMovement(e, t);
  });
};
t.slideMovement = function (e, t) {
  e.startCellId !== -1 && e.endCellId !== -1 && t.push(function (t) {
    n(e.actorId);
    window.gui.transmitFightSequenceMessage(e);
    window.actorManager.actorMovement({
      actorId: e.targetId,
      keyMovements: [e.startCellId, e.endCellId],
      slide: !0
    }, t);
  });
};
t.teleport = function (e, t) {
  if (e.cellId !== -1) {
    var n = window.actorManager.getActor(e.targetId);
    n && t.push(function (t) {
      return window.gui.transmitFightSequenceMessage(e), n.setDisposition(e.cellId), i(e.targetId), t();
    });
  }
};
t.exchangePositions = function (e, t) {
  var n = window.actorManager.getActor(e.sourceId),
    o = window.actorManager.getActor(e.targetId);
  t.push(function (t) {
    return window.gui.transmitFightSequenceMessage(e), n && n.setDisposition(e.casterCellId), o && o.setDisposition(e.targetCellId), i(e.sourceId), i(e.targetId), t();
  });
};
n(e.actorId);
window.gui.transmitFightSequenceMessage(e);
window.actorManager.actorMovement(e, t);
n(e.actorId);
window.gui.transmitFightSequenceMessage(e);
window.actorManager.actorMovement({
  actorId: e.targetId,
  keyMovements: [e.startCellId, e.endCellId],
  slide: !0
}, t);
c.x = C.x;
c.y = C.y + f.y;
c.position = _ + f.position;
c.animManager.assignSymbol(m, !1);
T.gfx = c;
t.addMark = function (e, t) {
  t.push(function (t) {
    n(e.mark, t);
  });
};
t.removeMark = function (e, t) {
  delete g[e.markId];
  var i = window.background;
  t.push(function (t) {
    return i.deleteZoneById("mark:" + e.markId, function (e) {
      var t = e.gfx;
      e.gfx = null;
      t && t.animManager.assignSymbol(m, !1, function () {
        t.remove();
      });
    }), t();
  });
};
t.triggerGlyphTrap = function (e, t) {
  t.push(function (t) {
    var i = window.background.getDataOfZoneId("mark:" + e.markId);
    return i ? (e._spellId = i.spellId, window.gui.transmitFightSequenceMessage(e), t()) : (console.warn("No data found for zone: mark:" + e.markId), t());
  });
};
t.syncMarks = function (e) {
  p.each(e, function (e, t) {
    a(e, t);
  }, function (e) {
    if (e) {
      return console.error("Could not sync marks", e);
    }
  });
};
t.clearMarks = function () {
  g = {};
};
t.getCellIdsAffectedByMarks = function () {
  for (var e = {}, t = Object.keys(g), i = 0; i < t.length; i++) {
    for (var n = g[t[i]], a = 0; a < n.cells.length; a++) {
      for (var s = o(n.cells[a]), r = 0; r < s.length; r += 1) {
        var l = s[r];
        e[l] || (e[l] = []);
        e[l].push(n);
      }
    }
  }
  return e;
};
e.gfx = null;
t && t.animManager.assignSymbol(m, !1, function () {
  t.remove();
});
e[l] || (e[l] = []);
e[l].push(n);
t.setVisibility = function (e, t) {
  var i = window.actorManager,
    n = i.getActor(e.targetId);
  n && t.push(function (t) {
    window.gui.transmitFightSequenceMessage(e);
    var i = n.getFighterData();
    return n.setInvisibility(e.state, i.teamId), t();
  });
};
t.vanish = function (e, t) {
  var i = window.actorManager,
    n = i.getActor(e.targetId);
  return n ? void t.push(function (t) {
    window.gui.transmitFightSequenceMessage(e);
    n.oneShootAnim({
      base: "AnimVanish"
    }, {
      backToStatic: !1
    }, function () {
      return i.removeActor(e.targetId), t();
    });
  }) : console.warn("No found actor with id " + e.targetId);
};
t.detected = function (e, t) {
  var i = window.actorManager,
    n = i.getActor(e.targetId);
  if (!n) {
    return console.error("No found actor with id " + e.targetId);
  }
  var o = n.getFighterData(),
    a = i.userActor.getFighterData();
  o.teamId !== a.teamId && t.push(function (e) {
    return n.invisibleDetectedAnimation(), e();
  });
};
window.gui.transmitFightSequenceMessage(e);
n.oneShootAnim({
  base: "AnimVanish"
}, {
  backToStatic: !1
}, function () {
  return i.removeActor(e.targetId), t();
});
t.removeAnimationModifier("AnimStatique");
t.removeAnimationModifier("AnimMarche");
t.removeAnimationModifier("AnimCourse");
t.removeAnimationModifier("AnimHit");
t.removeAnimationModifier("AnimTacle");
t.removeSubentity(e.carriedEntity);
1 === e.look.bonesId && e.look.skins && e.look.skins[0] && t.addAnimationModifier("AnimStatique", "AnimStatique" + e.look.skins[0]);
e.carriedActor ? e.carriedActor.parentActor = null : console.warn("attempted to drop actor that did not exist.");
e.carriedEntity = null;
e.carriedActor = null;
t.carryCharacter = function (e, t) {
  var i = window.actorManager,
    n = i.getActor(e.sourceId),
    a = i.getActor(e.targetId);
  if (n && a) {
    var r = {
        base: "AnimPickup",
        direction: e._direction
      },
      l = !i.isCreatureModeOn && n.riderEntity || n.animManager,
      c = {
        animManager: a.animManager,
        bindingPoint: "carried_3_0",
        symbolModifier: o[s],
        bindingPointCategory: s
      };
    a.parentActor = n;
    n.carriedEntity = c;
    n.carriedActor = a;
    a.getFighterData().isCarryied = !0;
    t.push(function (e) {
      i.isCreatureModeOn || (l.addAnimationModifier("AnimStatique", "AnimStatiqueCarrying"), l.addAnimationModifier("AnimMarche", "AnimMarcheCarrying"), l.addAnimationModifier("AnimCourse", "AnimCourseCarrying"), l.addAnimationModifier("AnimHit", "AnimHitCarrying"), l.addAnimationModifier("AnimTacle", "AnimTacleCarrying"));
      l.addSubentity(c);
      a.setDisposition(n.cellId);
      a.y = -1e3;
      n.oneShootAnim(r, {
        backToStatic: !0
      }, e);
    });
  }
};
t.removeCarrying = n;
t.throwCharacter = function (e, t) {
  var i = window.actorManager,
    o = i.getActor(e.targetId),
    s = i.getActor(e.sourceId);
  if (s && o) {
    var r = e.cellId,
      l = {
        base: "AnimThrow",
        direction: e._direction
      };
    o.getFighterData().isCarryied = !1;
    t.push(function (e) {
      s.oneShootAnim(l, {
        backToStatic: !1
      }, function () {
        n(s);
        o.setDisposition(r);
        s.staticAnim();
      });
      var t = new a(7, e);
      t.start(!1);
    });
    r !== -1 && (t.push(function (t) {
      e._throwingProjectile.launch(r, 13, .3, 70, t);
    }), t.push(function (t) {
      return o.setDisposition(r), window.gui.transmitFightSequenceMessage(e), t();
    }));
  }
};
t.dropCharacter = function (e, t) {
  var i = window.actorManager,
    o = i.getActor(e.sourceId),
    a = i.getActor(e.targetId);
  if (o) {
    var s = {
      base: "AnimDrop",
      direction: e._direction
    };
    a.getFighterData().isCarryied = !1;
    t.push(function (t) {
      o.oneShootAnim(s, {
        backToStatic: !1
      }, function () {
        return n(o), a.setDisposition(e.cellId), o.staticAnim(), window.gui.transmitFightSequenceMessage(e), t();
      });
    });
  }
};
a.parentActor = n;
n.carriedEntity = c;
n.carriedActor = a;
a.getFighterData().isCarryied = !0;
t.push(function (e) {
  i.isCreatureModeOn || (l.addAnimationModifier("AnimStatique", "AnimStatiqueCarrying"), l.addAnimationModifier("AnimMarche", "AnimMarcheCarrying"), l.addAnimationModifier("AnimCourse", "AnimCourseCarrying"), l.addAnimationModifier("AnimHit", "AnimHitCarrying"), l.addAnimationModifier("AnimTacle", "AnimTacleCarrying"));
  l.addSubentity(c);
  a.setDisposition(n.cellId);
  a.y = -1e3;
  n.oneShootAnim(r, {
    backToStatic: !0
  }, e);
});
i.isCreatureModeOn || (l.addAnimationModifier("AnimStatique", "AnimStatiqueCarrying"), l.addAnimationModifier("AnimMarche", "AnimMarcheCarrying"), l.addAnimationModifier("AnimCourse", "AnimCourseCarrying"), l.addAnimationModifier("AnimHit", "AnimHitCarrying"), l.addAnimationModifier("AnimTacle", "AnimTacleCarrying"));
l.addSubentity(c);
a.setDisposition(n.cellId);
a.y = -1e3;
n.oneShootAnim(r, {
  backToStatic: !0
}, e);
o.getFighterData().isCarryied = !1;
t.push(function (e) {
  s.oneShootAnim(l, {
    backToStatic: !1
  }, function () {
    n(s);
    o.setDisposition(r);
    s.staticAnim();
  });
  var t = new a(7, e);
  t.start(!1);
});
r !== -1 && (t.push(function (t) {
  e._throwingProjectile.launch(r, 13, .3, 70, t);
}), t.push(function (t) {
  return o.setDisposition(r), window.gui.transmitFightSequenceMessage(e), t();
}));
n(s);
o.setDisposition(r);
s.staticAnim();
a.getFighterData().isCarryied = !1;
t.push(function (t) {
  o.oneShootAnim(s, {
    backToStatic: !1
  }, function () {
    return n(o), a.setDisposition(e.cellId), o.staticAnim(), window.gui.transmitFightSequenceMessage(e), t();
  });
});
this._queue = [];
this._actionMap = {};
this._isActive = !1;
this._currentActionId = null;
this._endOfQueueOnly = !1;
e.exports = n;
n.prototype.initialize = function () {
  s || a.getAllDataMap("Interactives", function (e, t) {
    if (e) {
      return void console.error(new Error("ActionQueue.staticContent.getAllDataMap: " + e));
    }
    s = {};
    for (var i in t) {
      1 !== t[i].actionId && (s[i] = !0);
    }
    s[o.UNSPECIFIED] = !0;
  });
};
n.prototype.enqueue = function (e, t, i) {
  return !!this.canQueueMore() && (this._isActive ? !!this._actionMap[e] || (this._queue.push({
    actionId: e,
    action: i,
    endOfQueueOnly: t
  }), this._actionMap[e] = !0, !0) : (this._isActive = !0, this._actionMap[e] = !0, this._currentActionId = e, this._endOfQueueOnly = t, i(), !0));
};
n.prototype.enqueueInteractive = function (e, t, i) {
  var n = s && s[t] || !1;
  return this.enqueue(e, n, i);
};
n.prototype.dequeue = function (e) {
  if (this._isActive && this._isCurrentAction(e)) {
    delete this._actionMap[e];
    var t = this._queue.shift();
    if (!t) {
      return void this.clear();
    }
    this._currentActionId = t.actionId;
    this._endOfQueueOnly = t.endOfQueueOnly;
    t.action();
  }
};
n.prototype.canQueueMore = function () {
  if (!this._isActive) {
    return !0;
  }
  var e;
  return e = this._queue.length > 0 ? !this._queue[this._queue.length - 1].endOfQueueOnly : !this._endOfQueueOnly;
};
n.prototype.isActive = function () {
  return this._isActive;
};
n.prototype._isCurrentAction = function (e) {
  return this._currentActionId === e;
};
n.prototype.clear = function () {
  this._queue = [];
  this._actionMap = {};
  this._isActive = !1;
  this._currentActionId = null;
  this._endOfQueueOnly = !1;
};
this._currentActionId = t.actionId;
this._endOfQueueOnly = t.endOfQueueOnly;
t.action();
this._queue = [];
this._actionMap = {};
this._isActive = !1;
this._currentActionId = null;
this._endOfQueueOnly = !1;
o.to(n, 12);
o.to(i, 12);
d.prototype._isElementClicked = function (e, t, i) {
  if (!e.isWithinBounds(t, i)) {
    return !1;
  }
  var n = H,
    o = z;
  t -= n / 2;
  i -= o / 2;
  var a = e.renderer;
  null === G && (G = a.startTextureUsage(n, o, 1, "clickedInteractive"));
  a.startTextureRendering(G, t, t + n, i, i + o, !0);
  e.render();
  var s = a.gl;
  s.readPixels(0, 0, n, o, s.RGBA, s.UNSIGNED_BYTE, W);
  a.stopTextureRendering();
  for (var r = W.length, l = 0, c = 3; c < r; c += 4) {
    l += W[c];
  }
  return l > 8;
};
d.prototype._getAllInteractives = function () {
  for (var e = this.mapRenderer, t = e.identifiedElements, i = e.interactiveElements, n = this.actorManager.actors, a = [], s = Object.keys(i), r = 0; r < s.length; r += 1) {
    var l = s[r],
      c = i[l];
    if (0 !== c.enabledSkills.length || 0 !== c.disabledSkills.length) {
      var d = t[l];
      d && a.push(d);
    }
  }
  for (var u = Object.keys(n), h = 0; h < u.length; h += 1) {
    a.push(n[u[h]]);
  }
  return a.push(this.actorManager.userActor), a.sort(o), a;
};
d.prototype.setUnblockedNpcId = function (e) {
  this.unblockedNpcId = e;
};
d.prototype.resetUnblockedNpcId = function () {
  this.unblockedNpcId = -1;
};
d.prototype._tapInteractive = function (e, t) {
  var i,
    n = this.mapRenderer.interactiveElements,
    o = this._getAllInteractives(),
    r = window.gui.playerData.isAlive(),
    l = null,
    c = null,
    d = null;
  for (i = 0; i < o.length; i++) {
    var u = o[i];
    if (this._isElementClicked(u, e, t)) {
      if (u.actorId) {
        if (u.isNPC()) {
          if (!l) {
            var h = u.data.npcData && u.data.npcData.actions && u.data.npcData.actions.length > 0;
            (r || h) && (l = u);
          }
        } else {
          d || (d = u);
        }
      } else {
        c || (c = u);
      }
    }
  }
  var p;
  if (p = this.actorManager.isTransparentModeOn ? d || c || l : l || c || d, null === p) {
    return this._lastTapId = null, !1;
  }
  var m = !1,
    f = p.id || p.actorId;
  if (this.unblockedNpcId === -1 || p === l && p.data.npcId === this.unblockedNpcId) {
    var g = y([p._position, window.gui.playerData.position.mapId, f]);
    g === this._lastTapId ? (m = !0, this._lastTapId = null) : this._lastTapId = g;
    this.clearHighlights(null, L.DEFAULT);
    var _ = this.actionQueue.isActive();
    if (p.tap) {
      return _ || (m && p.actorId && "GameRolePlayGroupMonsterInformations" === p.data.type ? window.isoEngine.attackActor(p.actorId) : p.tap(e, t)), !0;
    }
    var v = n[p.id];
    if (!v) {
      return !0;
    }
    var w, b;
    if (1 === v.enabledSkills.length) {
      b = v.enabledSkills[0];
      var M = b.skillId;
      a(M) || s(M) || (w = b);
    }
    if (_ && !w) {
      for (i = 0; i < v.enabledSkills.length; i++) {
        if (b = v.enabledSkills[i], b.skillId === this.lastContextualMenuSkillId) {
          w = b;
          break;
        }
      }
    }
    if (w) {
      var T = this,
        C = this.actionQueue.enqueueInteractive(v.elementId, v.elementTypeId, function () {
          for (var e = !1, t = 0; t < v.enabledSkills.length; t++) {
            var i = v.enabledSkills[t];
            if (i.skillId === w.skillId) {
              e = !0;
              break;
            }
          }
          return e ? void T.queueUseInteractive(v.elementId, w.skillInstanceUid) : (T.actionQueue.clear(), T.clearHighlights(null, L.QUEUE));
        });
      return C ? (this._addHighlight(p, L.QUEUE), !0) : (!_ && 1 === v.enabledSkills.length && w && (this.instantUseInteractive(v.elementId, w.skillInstanceUid), this._addHighlight(p)), !0);
    }
    if (_) {
      return !0;
    }
    if (this._addHighlight(p), m) {
      for (var I = 0; I < R.length; I++) {
        if (v.elementTypeId === R[I].elementTypeId) {
          for (var A = 0; A < v.enabledSkills.length; A++) {
            if (v.enabledSkills[A].skillId === R[I].skillId) {
              return this.instantUseInteractive(v.elementId, v.enabledSkills[A].skillInstanceUid), !0;
            }
          }
        }
      }
    }
    var S = window.foreground.convertSceneToScreenCoordinate(e, t);
    return window.gui.openContextualMenu("interactive", v, {
      x: S.x,
      y: S.y
    }), !0;
  }
};
d.prototype._addHighlight = function (e, t) {
  t = t || L.DEFAULT;
  e.highlight = N;
  this.highlightedElements[t] || (this.highlightedElements[t] = []);
  this.highlightedElements[t].push(e);
};
d.prototype._clearHighlightType = function (e) {
  var t = this.highlightedElements[e];
  if (t) {
    for (var i = 0; i < t.length; i++) {
      t[i].highlight = null;
    }
    this.highlightedElements[e] = [];
  }
};
d.prototype.clearHighlights = function (e, t) {
  if (e) {
    var i = this,
      n = new A(e, function () {
        i.clearHighlights(null, t);
      });
    return n.start();
  }
  if (t) {
    this._clearHighlightType(t);
  } else {
    for (var o in this.highlightedElements) {
      this._clearHighlightType(o);
    }
    this.highlightedElements = {};
  }
};
d.prototype.queueUseInteractive = function (e, t) {
  this.clearHighlights(null, L.DEFAULT);
  this._useInteractive(e, t);
};
d.prototype.instantUseInteractive = function (e, t) {
  this.clearHighlights(x);
  this._useInteractive(e, t);
};
d.prototype.useInteractive = function (e, t) {
  this.clearHighlights();
  this._useInteractive(e, t);
};
d.prototype._useInteractive = function (e, t) {
  var i = this,
    n = this.mapRenderer.identifiedElements[e],
    o = n.position,
    a = this.actorManager.userActor,
    s = function () {
      var n = u.getOrientation(a.cellId, o, !1);
      a.setDisposition(null, n);
      C(e);
      i._interactiveUseTrackServerAnswer(e, t);
      window.dofus.sendMessage("InteractiveUseRequestMessage", {
        elemId: e,
        skillInstanceUid: t
      });
    };
  return u.areCellsNeighbours(a.cellId, o, {
    allowDiagonal: !0,
    useHeightCell: !0
  }) ? s() : void this._movePlayerOnMap(o, !0, s);
};
d.prototype.onInteractiveUseErrorMessage = function (e) {
  var t = e.elemId;
  void 0 !== B[t] && (window.clearTimeout(B[t]), delete B[t]);
  this.actionQueue.dequeue(t);
  var i = this.mapRenderer.identifiedElements[t];
  i && (i.highlight = null);
};
d.prototype._interactiveUseTrackServerAnswer = function (e) {
  var t = this;
  B[e] = window.setTimeout(function () {
    console.warn("Server has been too slow to answer to an interactiveUseRequest: we are not waiting for him");
    delete B[e];
    t.actionQueue.dequeue(e);
  }, P);
};
d.prototype.isWaitingForInteractiveUseServerAnswer = function () {
  return Object.keys(B).length > 0;
};
d.prototype.pendingInteractiveUseStart = function () {
  for (var e = 0; e < this.interactiveMessageStack.length; e++) {
    this.interactiveUseStart(this.interactiveMessageStack[e]);
  }
  this.interactiveMessageStack = [];
};
d.prototype.interactiveUseStart = function (e) {
  var t = this;
  if (this.isMapChanging) {
    return void this.interactiveMessageStack.push(e);
  }
  var i = e.entityId === window.gui.playerData.id,
    n = 0 !== e.duration;
  i && (void 0 !== B[e.elemId] && (window.clearTimeout(B[e.elemId]), delete B[e.elemId]), null !== k && (console.error("interactiveUseStart: InteractiveUseStart received but was waiting an InteractiveUseEnded"), this._userStopUsingInteractive()));
  var o = this.actorManager.getActor(e.entityId);
  if (!o) {
    return i ? console.error("interactiveUseStart: user actor is not ready") : console.warn("interactiveUseStart: no actor with id " + e.entityId);
  }
  var a = o.cellId,
    s = this.mapRenderer.identifiedElements[e.elemId];
  if (!s) {
    return i ? console.error("interactiveUseStart: no interactive with id " + e.elemId) : console.warn("interactiveUseStart: no interactive with id " + e.elemId);
  }
  var l = s.position,
    c = e._useAnimation;
  if (!c || "AnimStatique" === c) {
    return void (i && t.actionQueue.dequeue(e.elemId));
  }
  s.highlight = null;
  var d = u.getOrientation(a, l, !1),
    p = null;
  if (i || u.areCellsNeighbours(a, l, {
    allowDiagonal: !0,
    useHeightCell: !0
  })) {
    i || (p = a);
  } else {
    var m = h.getPath(a, l, this.actorManager.getOccupiedCells(), !0, !0);
    p = m && m[m.length - 1];
  }
  o.setDisposition(p, d, function () {
    var a = D[c],
      s = T.getLookWithoutMount(o.look);
    return null !== s && a && 1 === s.bonesId && s.skins && s.skins[0] ? (s.skins.push(a), b.loadLook(o, o.look, {}, function () {
      o.loadAndPlayAnimation({
        base: c
      }, {
        loop: n
      });
    })) : o.loadAndPlayAnimation({
      base: c
    }, {
      loop: n
    }), n ? void (i ? (o.isLocked = !0, F = c, k = window.setTimeout(function () {
      t._userStopUsingInteractive(e.elemId);
    }, 100 * e.duration * 2)) : window.setTimeout(function () {
      r(o, c);
      o.staticAnim();
    }, 100 * e.duration)) : void (i && t.actionQueue.dequeue(e.elemId));
  });
};
d.prototype.interactiveUseEndedMessage = function (e) {
  this._userStopUsingInteractive(e.elemId);
};
d.prototype._userStopUsingInteractive = function (e) {
  null !== k && (clearTimeout(k), k = null);
  var t = this.actorManager.userActor;
  D[F] && r(t, F);
  t.isLocked = !1;
  t.staticAnim();
  this.actionQueue.dequeue(e);
};
d.prototype.updateInteractiveElements = function (e) {
  this.mapRenderer.updateInteractiveElements(e);
};
d.prototype.updateObstacles = function (e) {
  this.mapRenderer.updateObstacles(e);
};
d.prototype.updateStatedElements = function (e) {
  this.mapRenderer.updateStatedElements(e);
};
d.prototype.addObjects = function (e) {
  this.mapRenderer.addObjects(e);
};
d.prototype.removeObjects = function (e) {
  this.mapRenderer.removeObjects(e);
};
d.prototype._removeArrowsNowAndLater = function (e) {
  this.removeArrows();
  this.arrowTimeout && (window.clearTimeout(this.arrowTimeout), this.arrowTimeout = null);
  var t = this;
  this.arrowTimeout = window.setTimeout(function () {
    t.arrowTimeout = null;
    t.removeArrows();
  }, e);
};
d.prototype.addArrowOnCell = function (e, t, i, n, o) {
  this.mapRenderer.addArrowOnCell(e, t, i, n, o);
};
d.prototype.addArrowOnGraphic = function (e, t, i, n, o) {
  this.mapRenderer.addArrowOnGraphic(e, t, i, n, o);
};
d.prototype.addArrowsSequence = function (e, t, i, n) {
  this.mapRenderer.addArrowsSequence(e, t, i, n);
};
t -= n / 2;
i -= o / 2;
null === G && (G = a.startTextureUsage(n, o, 1, "clickedInteractive"));
a.startTextureRendering(G, t, t + n, i, i + o, !0);
e.render();
s.readPixels(0, 0, n, o, s.RGBA, s.UNSIGNED_BYTE, W);
a.stopTextureRendering();
g === this._lastTapId ? (m = !0, this._lastTapId = null) : this._lastTapId = g;
this.clearHighlights(null, L.DEFAULT);
t = t || L.DEFAULT;
e.highlight = N;
this.highlightedElements[t] || (this.highlightedElements[t] = []);
this.highlightedElements[t].push(e);
this.clearHighlights(null, L.DEFAULT);
this._useInteractive(e, t);
this.clearHighlights(x);
this._useInteractive(e, t);
this.clearHighlights();
this._useInteractive(e, t);
a.setDisposition(null, n);
C(e);
i._interactiveUseTrackServerAnswer(e, t);
window.dofus.sendMessage("InteractiveUseRequestMessage", {
  elemId: e,
  skillInstanceUid: t
});
void 0 !== B[t] && (window.clearTimeout(B[t]), delete B[t]);
this.actionQueue.dequeue(t);
console.warn("Server has been too slow to answer to an interactiveUseRequest: we are not waiting for him");
delete B[e];
t.actionQueue.dequeue(e);
r(o, c);
o.staticAnim();
D[F] && r(t, F);
t.isLocked = !1;
t.staticAnim();
this.actionQueue.dequeue(e);
this.removeArrows();
this.arrowTimeout && (window.clearTimeout(this.arrowTimeout), this.arrowTimeout = null);
t.arrowTimeout = null;
t.removeArrows();
d.prototype._addArrowOnActor = function (e, t, i) {
  var n = t ? "monster" : "npc",
    o = "upLeft",
    a = U[o][n],
    s = a[0],
    r = a[1];
  e.y + r < q && (o = "downLeft", a = U[o][n], s = a[0], r = a[1]);
  i && this._removeArrowsNowAndLater(i);
  this.mapRenderer.addArrowOnCell(e.cellId, s * c.CELL_WIDTH, r * c.CELL_HEIGHT, o);
};
d.prototype.addArrowOnNpc = function (e, t) {
  var i = this.actorManager.getActorFromNpcId(e);
  return i ? void this._addArrowOnActor(i, !1, t) : console.warn("NPC not found with ID: " + e);
};
d.prototype.addArrowOnMonster = function (e, t) {
  var i = this.actorManager.getActorFromMonsterId(e);
  return i ? void this._addArrowOnActor(i, !0, t) : console.warn("Monster not found with ID: " + e);
};
d.prototype.addArrowOnInteractiveElement = function (e, t, i, n) {
  var o = this.mapRenderer.interactiveElements[e],
    a = this.mapRenderer.identifiedElements[e];
  if (!a || !o) {
    return console.warn("Element not found with ID: " + e);
  }
  var s = a.bbox,
    r = (s[0] - s[1]) / 2,
    l = (s[2] - s[3]) / 2,
    c = "up",
    d = "Left";
  s[2] < q && (l = -l, c = "down");
  s[0] < q && (r = -r, d = "Right");
  t && this._removeArrowsNowAndLater(t);
  this.addArrowOnGraphic(a, r + i, l + n, c + d);
};
d.prototype.removeArrows = function () {
  this.mapRenderer.removeArrows();
};
d.prototype.highlightAllInteractives = function (e) {
  e = e || 1;
  var t = this.mapRenderer.interactiveElements,
    i = this.mapRenderer.identifiedElements,
    n = window.gui.fightManager.isInFight();
  for (var o in t) {
    var a = t[o],
      s = i[o],
      r = s instanceof _;
    s && (n && !r || 0 === a.enabledSkills.length && 0 === a.disabledSkills.length || l(s, e));
  }
  this.emit("highlightElements");
};
d.prototype.highlightInteractivesWithDifferentType = function () {
  var e,
    t,
    i = this.mapRenderer.interactiveElements,
    n = this.mapRenderer.identifiedElements,
    o = {};
  for (e in i) {
    var a = i[e],
      s = n[e];
    s && 0 !== a.enabledSkills.length && (t = a.elementTypeId, o[t] || (o[t] = []), o[t].push(s));
  }
  var r = [];
  for (t in o) {
    if (~~t === O.UNSPECIFIED) {
      r = r.concat(o[t]);
    } else {
      var c = o[t].length,
        d = ~~(Math.random() * c);
      r.push(o[t][d]);
    }
  }
  for (var u = 0; u < r.length; u++) {
    l(r[u], 5);
  }
};
d.prototype.displayNumericalValue = function (e) {
  var t = this.actorManager.getActor(e.entityId);
  if (!t) {
    return console.error("No entity with id", e.entityId);
  }
  var i = t.x,
    n = t.y - 80;
  v.createPointVariationLabel({
    x: i,
    y: n,
    pointVariation: "+" + e.value,
    color: [.2, -.1, -.2, 0],
    maxRotation: .4
  });
  e.valueOfBonus && v.createPointVariationLabel({
    x: i,
    y: n,
    pointVariation: "+" + e.valueOfBonus,
    color: [.7, 0, -.3, 0],
    maxRotation: .4,
    targetId: e.entityId
  });
};
e.y + r < q && (o = "downLeft", a = U[o][n], s = a[0], r = a[1]);
i && this._removeArrowsNowAndLater(i);
this.mapRenderer.addArrowOnCell(e.cellId, s * c.CELL_WIDTH, r * c.CELL_HEIGHT, o);
s[2] < q && (l = -l, c = "down");
s[0] < q && (r = -r, d = "Right");
t && this._removeArrowsNowAndLater(t);
this.addArrowOnGraphic(a, r + i, l + n, c + d);
v.createPointVariationLabel({
  x: i,
  y: n,
  pointVariation: "+" + e.value,
  color: [.2, -.1, -.2, 0],
  maxRotation: .4
});
e.valueOfBonus && v.createPointVariationLabel({
  x: i,
  y: n,
  pointVariation: "+" + e.valueOfBonus,
  color: [.7, 0, -.3, 0],
  maxRotation: .4,
  targetId: e.entityId
});
d.prototype.displayTextBanner = function (e) {
  if (this.bitmapFonts && !window.gui.fightManager.isInactive) {
    var t = p(e),
      i = m(e),
      n = this.mapScene,
      o = n.w / 2,
      a = n.h / 2,
      s = this.bitmapFonts.characters,
      r = new f({
        x: o,
        y: a,
        scene: n,
        text: t,
        fallbackText: i,
        position: 2 * Y + 1,
        layer: c.MAP_LAYER_POINT_LABELS,
        bitmapFont: s,
        color: [.2, .5, -.2, 0],
        isHudElement: !0
      }),
      l = s.dimensions.bann,
      d = r.textWidth,
      u = r.textHeight,
      h = l.h,
      _ = l.w,
      v = 2,
      y = Math.floor(_ / 2 - v),
      w = l.x,
      b = l.y,
      M = new g({
        x: o,
        y: a - u / 2,
        scene: n,
        position: 2 * Y,
        layer: c.MAP_LAYER_POINT_LABELS,
        texture: s.texture,
        controlPoints: [{
          x: -d / 2 - y,
          u: w,
          y: 0,
          v: b
        }, {
          x: -d / 2,
          u: w + y,
          y: 0,
          v: b
        }, {
          x: d / 2,
          u: w + y + v,
          y: h,
          v: b + h
        }, {
          x: d / 2 + y,
          u: w + _,
          y: h,
          v: b + h
        }],
        isHudElement: !0
      }),
      T = new S(r, ["y", "alpha"]).from({
        y: a - 30,
        alpha: 0
      }).to({
        y: a - 30,
        alpha: 0
      }, 4).to({
        y: a,
        alpha: 1
      }, 8, E.backOut, 2).to({
        y: a,
        alpha: 1
      }, 17).to({
        y: a - 30,
        alpha: 0
      }, 8, E.backIn, 2).onFinish(function () {
        r.remove();
      }).start(),
      C = new S(M, ["scaleX", "alpha"]).from({
        scaleX: .7,
        alpha: 0
      }).to({
        scaleX: 1,
        alpha: 1
      }, 8, E.backOut, 2).to({
        scaleX: 1,
        alpha: 1
      }, 24).to({
        scaleX: .7,
        alpha: 0
      }, 8, E.backIn, 2).onFinish(function () {
        M.remove();
      }).start();
    Y += 1;
    null !== this._currentBannerTweens.backTween && (this._currentBannerTweens.backTween.starting || this._currentBannerTweens.backTween.playing) && (this._currentBannerTweens.backTween.reset().to({
      scaleX: .7,
      alpha: 0
    }, 8, E.polyOut, 2).start(), this._currentBannerTweens.textTween.reset().to({
      y: a - 30,
      alpha: 0
    }, 8, E.polyOut, 2).start());
    this._currentBannerTweens.backTween = C;
    this._currentBannerTweens.textTween = T;
  }
};
d.prototype.highlightActorOnAction = function (e, t) {
  var i = this.actorManager.getActor(e);
  return i ? (this._addHighlight(i), void this.clearHighlights(t || x)) : console.warn("Actor with id " + e + " to highlight not found.");
};
d.prototype.interactiveDisconnect = function () {
  for (var e = Object.keys(B), t = 0; t < e.length; t++) {
    window.clearTimeout(B[e[t]]);
    delete B[e[t]];
  }
  this.actionQueue.clear();
};
Y += 1;
null !== this._currentBannerTweens.backTween && (this._currentBannerTweens.backTween.starting || this._currentBannerTweens.backTween.playing) && (this._currentBannerTweens.backTween.reset().to({
  scaleX: .7,
  alpha: 0
}, 8, E.polyOut, 2).start(), this._currentBannerTweens.textTween.reset().to({
  y: a - 30,
  alpha: 0
}, 8, E.polyOut, 2).start());
this._currentBannerTweens.backTween = C;
this._currentBannerTweens.textTween = T;
window.clearTimeout(B[e[t]]);
delete B[e[t]];
e.id = "grid9ScaleCount" + s++;
a.call(this, e);
this._spriteByteSize = this.renderer.getNbBytesPerSprite();
this._bbox = [1 / 0, -(1 / 0), 1 / 0, -(1 / 0)];
this.controlPoints = e.controlPoints;
this.w = i.x - t.x;
this.h = i.y - t.y;
this._bbox[0] = t.x;
this._bbox[1] = i.x;
this._bbox[2] = t.y;
this._bbox[3] = i.y;
this.texture = e.texture;
this._createVertexBuffer();
o(n, a);
e.exports = n;
n.prototype._populateSpriteVertexBuffer = function (e, t, i, n, o, a, s, r, l) {
  var c = this._floatView,
    d = this._longView,
    u = this._longView,
    h = this.texture.element.width,
    p = this.texture.element.height,
    m = e * this._spriteByteSize / 4;
  c[m + 0] = t;
  c[m + 1] = a;
  c[m + 5] = t;
  c[m + 6] = r;
  c[m + 10] = n;
  c[m + 11] = r;
  c[m + 15] = t;
  c[m + 16] = a;
  c[m + 20] = n;
  c[m + 21] = r;
  c[m + 25] = n;
  c[m + 26] = a;
  var f = i / h * 65535 & 65535,
    g = o / h * 65535 & 65535,
    _ = s / p * 4294901760 & 4294901760,
    v = l / p * 4294901760 & 4294901760;
  d[m + 2] = f + _;
  d[m + 7] = f + v;
  d[m + 12] = g + v;
  d[m + 17] = f + _;
  d[m + 22] = g + v;
  d[m + 27] = g + _;
  var y = 1077952576;
  u[m + 3] = u[m + 8] = u[m + 13] = y;
  u[m + 18] = u[m + 23] = u[m + 28] = y;
};
n.prototype._createVertexBuffer = function () {
  this._vertexBuffer = new window.ArrayBuffer(9 * this._spriteByteSize);
  this._floatView = new window.Float32Array(this._vertexBuffer);
  this._longView = new window.Uint32Array(this._vertexBuffer);
  var e = this.controlPoints[0],
    t = this.controlPoints[1],
    i = this.controlPoints[2],
    n = this.controlPoints[3];
  this._populateSpriteVertexBuffer(0, e.x, e.u, t.x, t.u, e.y, e.v, t.y, t.v);
  this._populateSpriteVertexBuffer(1, t.x, t.u, i.x, i.u, e.y, e.v, t.y, t.v);
  this._populateSpriteVertexBuffer(2, i.x, i.u, n.x, n.u, e.y, e.v, t.y, t.v);
  this._populateSpriteVertexBuffer(3, e.x, e.u, t.x, t.u, t.y, t.v, i.y, i.v);
  this._populateSpriteVertexBuffer(4, t.x, t.u, i.x, i.u, t.y, t.v, i.y, i.v);
  this._populateSpriteVertexBuffer(5, i.x, i.u, n.x, n.u, t.y, t.v, i.y, i.v);
  this._populateSpriteVertexBuffer(6, e.x, e.u, t.x, t.u, i.y, i.v, n.y, n.v);
  this._populateSpriteVertexBuffer(7, t.x, t.u, i.x, i.u, i.y, i.v, n.y, n.v);
  this._populateSpriteVertexBuffer(8, i.x, i.u, n.x, n.u, i.y, i.v, n.y, n.v);
  this.renderer.releaseBuffer(this.id);
  this.forceRefresh();
};
n.prototype.draw = function () {
  this.renderer.drawSpriteBatch(this.id);
};
n.prototype.generateCurrentFrameData = function () {
  var e = this.renderer.getBufferData(this.id);
  if (void 0 === e) {
    var t = this._floatView,
      i = !1;
    this.renderer.loadSpriteBuffer(this.id, t, this.texture, this.bbox, i);
    this.renderer.lockBuffer(this.id);
  }
  return this._bbox;
};
n.prototype.clear = function () {
  this.renderer.releaseBuffer(this.id);
};
c[m + 0] = t;
c[m + 1] = a;
c[m + 5] = t;
c[m + 6] = r;
c[m + 10] = n;
c[m + 11] = r;
c[m + 15] = t;
c[m + 16] = a;
c[m + 20] = n;
c[m + 21] = r;
c[m + 25] = n;
c[m + 26] = a;
d[m + 2] = f + _;
d[m + 7] = f + v;
d[m + 12] = g + v;
d[m + 17] = f + _;
d[m + 22] = g + v;
d[m + 27] = g + _;
u[m + 3] = u[m + 8] = u[m + 13] = y;
u[m + 18] = u[m + 23] = u[m + 28] = y;
this._vertexBuffer = new window.ArrayBuffer(9 * this._spriteByteSize);
this._floatView = new window.Float32Array(this._vertexBuffer);
this._longView = new window.Uint32Array(this._vertexBuffer);
this._populateSpriteVertexBuffer(0, e.x, e.u, t.x, t.u, e.y, e.v, t.y, t.v);
this._populateSpriteVertexBuffer(1, t.x, t.u, i.x, i.u, e.y, e.v, t.y, t.v);
this._populateSpriteVertexBuffer(2, i.x, i.u, n.x, n.u, e.y, e.v, t.y, t.v);
this._populateSpriteVertexBuffer(3, e.x, e.u, t.x, t.u, t.y, t.v, i.y, i.v);
this._populateSpriteVertexBuffer(4, t.x, t.u, i.x, i.u, t.y, t.v, i.y, i.v);
this._populateSpriteVertexBuffer(5, i.x, i.u, n.x, n.u, t.y, t.v, i.y, i.v);
this._populateSpriteVertexBuffer(6, e.x, e.u, t.x, t.u, i.y, i.v, n.y, n.v);
this._populateSpriteVertexBuffer(7, t.x, t.u, i.x, i.u, i.y, i.v, n.y, n.v);
this._populateSpriteVertexBuffer(8, i.x, i.u, n.x, n.u, i.y, i.v, n.y, n.v);
this.renderer.releaseBuffer(this.id);
this.forceRefresh();
this.renderer.loadSpriteBuffer(this.id, t, this.texture, this.bbox, i);
this.renderer.lockBuffer(this.id);
t.emaNeurt = function (e) {
  return t.trueName(e, "‮");
};
t.trueName = function n(e, t) {
  var o = (typeof e)[0],
    a = "";
  if (t) {
    if ("object" == typeof t && (t = t.valueOf()), "string" != typeof t) {
      throw new TypeError("Invalid type for salt: must be a string");
    }
    a = t;
  }
  var s = e;
  if ("o" === o && null !== e && (s = e.valueOf()), o = (typeof s)[0], "o" !== o || null === s) {
    return a.concat(o, s);
  }
  if (s instanceof Date) {
    return a.concat("d", s.toJSON());
  }
  if (s instanceof RegExp) {
    return a.concat("r", s.toString());
  }
  if ("f" === o) {
    throw new TypeError("Invalid type: function");
  }
  i(s) && (o = "a");
  var r, l;
  r = Object.keys(s);
  r.sort();
  for (var c = 0; c < r.length; c += 1) {
    l = r[c];
    a = a.concat(o, l, n(s[l]));
  }
  return a;
};
r = Object.keys(s);
r.sort();
l = r[c];
a = a.concat(o, l, n(s[l]));
T = null;
A = null;
n(!1);
C = null;
o();
l.prototype.fightTurnStart = function (e) {
  this._previousTurn = this._isUserTurn;
  this._isUserTurn = e;
  window.background.hideTargetHighlights();
  this._resetFightPositionLayer();
  this._previousTurn !== this._isUserTurn && (e ? this._enemyToUserTurn() : this._userToEnemyTurn());
  this._resetWalkLayer();
  a();
};
l.prototype._switchTurn = function (e, t, i, n, o) {
  if (this._spellRangeLayer) {
    for (var a = {}, s = this._spellRangeLayer.cellInfos, r = Object.keys(s), l = 0; l < r.length; l++) {
      var c = s[r[l]];
      c.transformState === e ? a[c.cellId] = new m(c.cellId, c.distanceToPlayer, t) : c.transformState === i && (a[c.cellId] = new m(c.cellId, c.distanceToPlayer, n));
    }
    0 !== Object.keys(a).length && this._resetSpellRangeLayer(a);
  }
  if (this._spellEffectLayer) {
    for (a = {}, s = this._spellEffectLayer.cellInfos, r = Object.keys(s), l = 0; l < r.length; l++) {
      c = s[r[l]];
      a[c.cellId] = new m(c.cellId, c.distanceToPlayer, o);
    }
    this._resetSpellEffectLayer(a);
  }
};
l.prototype._enemyToUserTurn = function () {
  window.background.showTargetHighlights();
  window.foreground.confirmBox.show();
  window.gui.damagePreview.show();
  this._switchTurn(f.inSightEnemyTurn, f.inSight, f.outSightEnemyTurn, f.outSight, f.areaOfEffect);
};
l.prototype._userToEnemyTurn = function () {
  this._switchTurn(f.inSight, f.inSightEnemyTurn, f.outSight, f.outSightEnemyTurn, f.areaOfEffectEnemyTurn);
};
l.prototype.touchCancel = function () {
  this.clearHighlights();
  a();
};
l.prototype.touchMove = function (e, t, i) {
  var n = this.mapScene.convertCanvasToSceneCoordinate(e, t),
    o = this.mapRenderer.getCellId(n.x, n.y).cell;
  if (T !== o) {
    if (window.gui.pingSystem.isActive()) {
      return T && this.mapRenderer.deletePingHighlight(T), T = o, this.mapRenderer.addPingHighlight(o, this.getContext(o));
    }
    T = o;
    "fight" === i.mode && void 0 !== i.spellId ? this.displayEffectZone(o) : "fight" === i.mode && this._isUserTurn && (this.actorManager.getActorsOnCell(o).length > 0 ? this._resetWalkLayer() : (window.foreground.confirmBox.close(), A = this._displayPathInFight(o)));
  }
};
l.prototype._displayPathInFight = function (e) {
  var t = this.actorManager.userActor,
    i = t.cellId;
  C = C || c.getReachableZone(t, i);
  var a = e;
  if (!C[e]) {
    var s = h.getMapPointFromCellId(i),
      l = h.getMapPointFromCellId(a);
    S.set(s.x, s.y, l.x, l.y);
    S.exec(function (e, t) {
      var i = h.getCellIdFromMapPoint(e, t);
      C[i] ? a = i : S.stop();
    });
  }
  var d = t.getFighterData(),
    u = d.stats,
    p = r(i, a, C, u.movementPoints);
  if (!p) {
    return o();
  }
  for (var g = p.reachable[p.reachable.length - 1], _ = {}, v = 0; v < p.reachable.length; v++) {
    _[p.reachable[v]] = new m(p.reachable[v], p.reachableMap[p.reachable[v]], f.walkable);
  }
  for (var y = 0; y < p.unreachable.length; y++) {
    _[p.unreachable[y]] = new m(p.unreachable[y], p.unreachableMap[p.unreachable[y]], f.unwalkable);
  }
  return p.reachable.length > 0 && (_[g] = new m(g, 0, f.walkableLast)), window.background.removeTargetHighlights(), this._resetWalkLayer(_), p.costMP > 0 || p.costAP > 0 ? n("tackle", {
    ap: p.costAP,
    mp: p.costMP
  }) : n(!1), p;
};
l.prototype.touchEnd = function (e, t, i) {
  i = i || {};
  i.canvasX = e;
  i.canvasY = t;
  var n = this.mapScene.convertCanvasToSceneCoordinate(e, t),
    o = this.mapRenderer,
    a = o.getCellId(n.x, n.y),
    s = o.getCellSceneCoordinate(a.cell);
  (!this.unblockedCells || this.unblockedCells[a.cell] || this._tapInteractive(n.x, n.y)) && (window.gui.pingSystem.isActive() || o.addTapFeedback(s.x, s.y), this._touchEnd(n.x, n.y, a, i));
};
this._previousTurn = this._isUserTurn;
this._isUserTurn = e;
window.background.hideTargetHighlights();
this._resetFightPositionLayer();
this._previousTurn !== this._isUserTurn && (e ? this._enemyToUserTurn() : this._userToEnemyTurn());
this._resetWalkLayer();
a();
c = s[r[l]];
a[c.cellId] = new m(c.cellId, c.distanceToPlayer, o);
window.background.showTargetHighlights();
window.foreground.confirmBox.show();
window.gui.damagePreview.show();
this._switchTurn(f.inSightEnemyTurn, f.inSight, f.outSightEnemyTurn, f.outSight, f.areaOfEffect);
this.clearHighlights();
a();
T = o;
"fight" === i.mode && void 0 !== i.spellId ? this.displayEffectZone(o) : "fight" === i.mode && this._isUserTurn && (this.actorManager.getActorsOnCell(o).length > 0 ? this._resetWalkLayer() : (window.foreground.confirmBox.close(), A = this._displayPathInFight(o)));
S.set(s.x, s.y, l.x, l.y);
S.exec(function (e, t) {
  var i = h.getCellIdFromMapPoint(e, t);
  C[i] ? a = i : S.stop();
});
i = i || {};
i.canvasX = e;
i.canvasY = t;
l.prototype.setUnblockedCells = function (e) {
  this.unblockedCells = e;
};
l.prototype.resetUnblockedCells = function () {
  this.unblockedCells = null;
};
l.prototype.cellHover = function (e) {
  window.gui.playerData.isFighting && E !== e && (E = e, this.displayEffectZone(e, {
    showDamagePreview: !0
  }));
};
l.prototype.cellHoverRelease = function (e) {
  var t = this._shouldSkipConfirmBox(_.confirmBoxWhenDragCasting, e);
  this._spellRangeLayer && this._spellRangeLayer.cellInfos.hasOwnProperty(e) ? t ? (this._castSpellImmediately(e), this.clearSpellDisplay()) : this._castSpellImmediatelyConfirm(e) : this.clearSpellDisplay();
  this._isUserTurn && t && this.displayUserMovementZone();
};
l.prototype._touchEnd = function (e, t, i, n) {
  n.hasOwnProperty("mode") && (window.gui.pingSystem.isActive() ? this._tapPing(i) : "fightPlacement" === n.mode ? this._tapFightPlacement(e, t, i, n) : "fight" === n.mode && void 0 !== n.spellId ? this._tapFightWithSpell(e, t, i, n) : "fight" === n.mode && this._isUserTurn ? this._tapFight(e, t, i, n) : "roleplay" === n.mode && this._tapRoleplay(e, t, i, n), a());
};
l.prototype.isCellEmpty = function (e) {
  var t = this.actorManager.getActorsOnCell(e);
  return !(t.length > 0);
};
l.prototype.getContext = function (e) {
  var t = this.actorManager.getActorsOnCell(e);
  if (!this.isCellEmpty(e)) {
    var i = window.gui.fightManager,
      n = t[0].getFighter();
    if (!n || !n.id) {
      return M.PING_TARGET_NOTHING;
    }
    var o = i.isFighterOnUsersTeam(n.id),
      a = t[0].getFighter().isSummon() && o;
    if (a) {
      return M.PING_TARGET_SUMMON_ALLY;
    }
    if (this.actorManager.userActor.actorId === t[0].actorId) {
      return M.PING_TARGET_YOURSELF;
    }
    if (o) {
      return M.PING_TARGET_ALLY;
    }
    if (!o) {
      return M.PING_TARGET_ENNEMY;
    }
  }
  return M.PING_TARGET_NOTHING;
};
l.prototype._tapPing = function (e) {
  var t = window.gui.pingSystem;
  if (!t.isPingBoxOpen()) {
    T && this.mapRenderer.deletePingHighlight(T);
    var i = e.cell;
    this.mapRenderer.addPingHighlight(i, this.getContext(i), !0);
  }
};
l.prototype._tapRoleplay = function (e, t, i, n) {
  var o = this,
    a = n.canvasX,
    s = n.canvasY,
    r = n.changeMapRequest,
    l = this.mapRenderer,
    c = this.actorManager.userActor,
    d = this.actionQueue.isActive();
  if (d) {
    var u = this._tapInteractive(e, t);
    if (!u && !c.moving && (r = r || l.getFirstMapFlag(i.cell))) {
      var h = !0,
        p = this.actionQueue.enqueue("changeMap", h, function () {
          o.gotoNeighbourMap(r, i.cell, a, s);
        });
      return void (p && window.foreground.showBorderArrow(r, a, s));
    }
  } else {
    this.lastContextualMenuSkillId = null;
  }
  if (!c.isLocked) {
    if (c.moving || this.isMovementWaitingForConfirmation) {
      if (window.foreground.hideBorderArrow(), d && !r && this._tapInteractive(e, t)) {
        return;
      }
      return this.clearHighlights(), this.actionQueue.clear(), void this.cancelUserActorMovement(function () {
        o._touchEnd(e, t, i, n);
      });
    }
    if (!r) {
      if (this._tapInteractive(e, t)) {
        return;
      }
      var m = this.actorManager.getActorsOnCell(i.cell);
      if (m[0] && m[0].position === i) {
        return void (0 === i.dist && m[0].tap(e, t, l.camera));
      }
    }
    this.clearHighlights();
    var f = i.cell;
    return (r = r || l.getFirstMapFlag(i.cell)) ? this.gotoNeighbourMap(r, i.cell, a, s) : void this._movePlayerOnMap(f);
  }
};
l.prototype._tapFightWithSpell = function (e, t, i, n) {
  var o = i.cell;
  if (!this.unblockedCells || this.unblockedCells[o]) {
    window.foreground.fightIsUserTurn ? n.hideConfirmWindow = !1 : n.hideConfirmWindow = !0;
    var a = this._shouldSkipConfirmBox(_.confirmBoxWhenClickCasting, o);
    a ? this._castSpell(o, e, t, n) : this._castSpellConfirm(o, e, t, n);
  }
};
l.prototype._shouldSkipConfirmBox = function (e, t) {
  var i = !1;
  return e === y.NEVER ? i = !0 : e === y.EMPTY_ONLY ? i = !this.isCellEmpty(t) : e === y.ALWAYS && (i = !1), i;
};
l.prototype.displayUserMovementZone = function () {
  if (this.mapRenderer.isReady && !window.gui.playerData.isSpectator) {
    this.clearSpellDisplay();
    var e = this.actorManager.userActor,
      t = e.cellId,
      i = C || c.getReachableZone(e, t);
    this.clearUserMovementZone();
    var n,
      o = {},
      a = window.isoEngine.actorManager.userActor.cellId;
    for (var s in i) {
      if (i.hasOwnProperty(s)) {
        var r,
          l = g.getDistance(a, s);
        r = i[s].reachable ? i[s].isTackled ? f.walkAreaRequiresAP : f.walkArea : f.walkAreaRestricted;
        o[s] = new m(~~s, l, r);
        n = !0;
      }
    }
    n && this._resetWalkAreaLayer(o);
  }
};
l.prototype.tryDisplayUserMovementZone = function () {
  return this._spellRangeLayer ? void this.displaySpellRange() : void this.displayUserMovementZone();
};
l.prototype.displayEnemyMovementZone = function (e) {
  if (this.mapRenderer.isReady) {
    this.clearSpellDisplay();
    var t = this.actorManager.getActor(e.id);
    if (t) {
      var i = t.cellId,
        n = c.getReachableZone(t, i);
      this._resetWalkAreaLayer();
      for (var o, a = {}, s = Object.keys(n), r = 0; r < s.length; r++) {
        var l,
          d = s[r],
          u = g.getDistance(i, d);
        l = n[d].reachable ? n[d].isTackled ? f.enemyWalkAreaRequiresAP : f.enemyWalkArea : f.enemyWalkAreaRestricted;
        a[d] = new m(~~d, u, l);
        o = !0;
      }
      o && this._resetEnemyWalkAreaLayer(a);
    }
  }
};
l.prototype.removeEnemyMovementZone = function () {
  this._resetEnemyWalkAreaLayer();
  this._isUserTurn && (window.foreground.isSpellSelected() ? window.foreground._displaySpellRange() : this.displayUserMovementZone());
};
l.prototype._tapFight = function (e, t, i) {
  function n(e) {
    return e ? (h.unshift(l), window.gui.emit("checkServerLag", "fightAction", "start"), u.emit("fightTap", r), window.dofus.sendMessage("GameMapMovementRequestMessage", {
      keyMovements: d(h),
      mapId: s
    }), u._resetWalkLayer(), void a()) : void u._resetWalkLayer();
  }
  var s = this.mapRenderer.map.id,
    r = i.cell,
    l = this.actorManager.userActor.cellId,
    c = window.foreground.confirmBox,
    u = this;
  if (!this.unblockedCells || this.unblockedCells[r]) {
    if (this.actorManager.getActorsOnCell(r).length > 0 || !this._isUserTurn) {
      return o(), this._resetWalkLayer(), void c.close();
    }
    if (A || (A = this._displayPathInFight(r)), !A || 0 === A.reachable.length || !T && A.reachable.indexOf(r) === -1 && A.unreachable.indexOf(r) === -1) {
      return o(), this._resetWalkLayer(), void c.close();
    }
    var h = A && A.reachable;
    if (h && h.indexOf(r) > -1) {
      var p = {
          mp: A.costMP,
          ap: A.costAP
        },
        m = v(["move", p, h, r, s]);
      _.confirmBoxWhenWalking ? c.open("move", p, m, {
        startHidden: !1,
        allowDoubleTap: !0
      }, n) : n(!0);
    } else {
      u._resetWalkLayer();
    }
  }
};
l.prototype._tapFightPlacement = function (e, t, i, n) {
  var o = this.actorManager.getActorsOnCell(i.cell);
  if (o.length) {
    var a = o[0];
    return void (window.gui.fightManager.isFighterOnUsersTeam(a.actorId) && a.tap(e, t, this.mapRenderer.camera));
  }
  var s = i.cell,
    r = n.possiblePlacements || [],
    l = r.indexOf(s);
  l !== -1 && (this.emit("placementTap", s), window.dofus.sendMessage("GameFightPlacementPositionRequestMessage", {
    cellId: s
  }), p("FIGHT_POSITION"));
};
this._spellRangeLayer && this._spellRangeLayer.cellInfos.hasOwnProperty(e) ? t ? (this._castSpellImmediately(e), this.clearSpellDisplay()) : this._castSpellImmediatelyConfirm(e) : this.clearSpellDisplay();
this._isUserTurn && t && this.displayUserMovementZone();
r = i[s].reachable ? i[s].isTackled ? f.walkAreaRequiresAP : f.walkArea : f.walkAreaRestricted;
o[s] = new m(~~s, l, r);
n = !0;
l = n[d].reachable ? n[d].isTackled ? f.enemyWalkAreaRequiresAP : f.enemyWalkArea : f.enemyWalkAreaRestricted;
a[d] = new m(~~d, u, l);
o = !0;
this._resetEnemyWalkAreaLayer();
this._isUserTurn && (window.foreground.isSpellSelected() ? window.foreground._displaySpellRange() : this.displayUserMovementZone());
l.prototype.holdStart = function () {
  this.highlightAllInteractives(5);
  N = this._getAllInteractives();
  x = null;
};
l.prototype.holdEnd = function () {
  this.clearHighlights();
  this.removeEnemyMovementZone();
  window.gui.damagePreview.cancel();
};
l.prototype.holdAndMove = function (e, t) {
  for (var i = this.mapScene.convertCanvasToSceneCoordinate(e, t), n = null, o = 0; o < N.length; o++) {
    var a = N[o];
    if (this._isElementClicked(a, i.x, i.y)) {
      n = a;
      break;
    }
  }
  return n ? x === n ? n : (x = n, this.clearHighlights(), this._addHighlight(n), n) : (x = null, void this.clearHighlights());
};
this.highlightAllInteractives(5);
N = this._getAllInteractives();
x = null;
this.clearHighlights();
this.removeEnemyMovementZone();
window.gui.damagePreview.cancel();
i = Math.max(0, i);
s = Math.max(0, s);
this.cellId = e;
this.from = t;
this.availableMp = i;
this.availableAp = n;
this.costMP = o;
this.costAP = a;
this.distance = s;
this.damagingMarks = r;
this.availableMp = e.mp;
this.availableAp = e.ap;
this.costMP = t.mp;
this.costAP = t.ap;
this.pathNodes = i;
this.reachable = n;
this.isTackled = o;
this.path = null;
m.push(g);
f[t] = g;
d.prototype.update = function (e, t, i) {
  for (var n = 0; n < this.pathNodes.length; n += 1) {
    var o = l(e, this.pathNodes[n]);
    if (o === b.SAME || o === b.WORSE) {
      return !1;
    }
    if (o === b.BETTER) {
      this.pathNodes[n] = e;
      break;
    }
  }
  return this.availableAp = e.availableAp, this.availableMp = e.availableMp, this.costMP = e.costMP, this.costAP = e.costAP, this.reachable = t, this.isTackled = i, !0;
};
t.getReachableZone = h;
e.exports.getCellDistance = n;
e.exports.getDistance = o;
this.reachable = [];
this.unreachable = [];
this.costMP = 0;
this.costAP = 0;
this.reachableMap = {};
this.unreachableMap = {};
e.exports = i;
i.prototype.addNode = function (e, t, i) {
  t.reachable ? (this.reachable.push(e), this.reachableMap[e] = i) : (this.unreachable.push(e), this.unreachableMap[e] = i);
  this.costMP = t.costMP;
  this.costAP = t.costAP;
};
t.reachable ? (this.reachable.push(e), this.reachableMap[e] = i) : (this.unreachable.push(e), this.unreachableMap[e] = i);
this.costMP = t.costMP;
this.costAP = t.costAP;
o.prototype._initGridOverlayLayers = function () {
  this._fightPositionLayer = null;
  this._spellRangeLayer = null;
  this._spellEffectLayer = null;
  this._walkLayer = null;
  this._walkAreaLayer = null;
  this._enemyWalkAreaLayer = null;
};
o.prototype._resetFightPositionLayer = function (e) {
  this.background.removeGridLayer(this._fightPositionLayer);
  this._fightPositionLayer = e ? this.background.addGridAnimation(e) : null;
};
o.prototype._resetSpellRangeLayer = function (e) {
  this.background.removeGridLayer(this._spellRangeLayer);
  this._spellRangeLayer = e ? this.background.addGridAnimation(e) : null;
};
o.prototype._resetSpellEffectLayer = function (e) {
  this.background.removeGridLayer(this._spellEffectLayer);
  this._spellEffectLayer = e ? this.background.addGridAnimation(e) : null;
};
o.prototype._resetWalkLayer = function (e) {
  this.background.removeGridLayer(this._walkLayer);
  this._walkLayer = e ? this.background.addGridAnimation(e) : null;
};
o.prototype._resetWalkAreaLayer = function (e) {
  this.background.removeGridLayer(this._walkAreaLayer);
  this._walkAreaLayer = e ? this.background.addGridAnimation(e) : null;
};
o.prototype._resetEnemyWalkAreaLayer = function (e) {
  this.background.removeGridLayer(this._enemyWalkAreaLayer);
  this._enemyWalkAreaLayer = e ? this.background.addGridAnimation(e) : null;
};
o.prototype.clearUserMovementZone = o.prototype._resetWalkAreaLayer;
o.prototype.setCurrentSpell = function (e) {
  m = e;
};
o.prototype.isOutsight = function (e) {
  return !f || !f.hasOwnProperty(e) || f[e].transformState === u.outSight || f[e].transformState === u.outSightEnemyTurn;
};
o.prototype.displaySpellRange = function () {
  if (this.mapRenderer.map && this.mapRenderer.map.cells && m && !this.actorManager.userActor.isDead) {
    this.clearUserMovementZone();
    for (var e = this.mapRenderer.map.cells, t = this.actorManager.userActor.cellId, i = a.getSpellRange(e, t, m), o = window.actorManager.getIndexedVisibleActors(), s = {}, l = {}, c = window.foreground.fightIsUserTurn ? u.outSight : u.outSightEnemyTurn, h = window.foreground.fightIsUserTurn ? u.inSight : u.inSightEnemyTurn, p = 0; p < i.length; p++) {
      var g = r.getCellIdFromMapPoint(i[p][0], i[p][1]);
      if (void 0 !== g && !s[g]) {
        if (m.needFreeCell && o[g]) {
          l[g] = i[p][2];
          s[g] = new d(g, i[p][2], c);
        } else {
          var _ = e[g].l || 0;
          3 === (7 & _) && (s[g] = new d(g, i[p][2], h), l[g] = i[p][2]);
        }
      }
    }
    m.castTestLos && n(e, s, t, o);
    f = s;
    this._resetSpellRangeLayer(s);
    this._spellEffectLayer && this._resetSpellEffectLayer(this._spellEffectLayer.cellInfos);
    this._walkLayer && (this._resetWalkLayer(), window.foreground.confirmBox.hide(), window.gui.damagePreview.hide());
  }
};
e.exports.getCell = n;
o.prototype.displayEffectZone = function (e, t) {
  t = t || {};
  var i = window.gui.damagePreview;
  if (this.background.removeTargetHighlights(), t.showDamagePreview && i.cancel(), f && m) {
    if (!f.hasOwnProperty(e)) {
      return void this._resetSpellEffectLayer();
    }
    if (f[e].transformState === u.outSight || f[e].transformState === u.outSightEnemyTurn) {
      return void this._resetSpellEffectLayer();
    }
    if (this.mapRenderer.map && this.mapRenderer.map.cells) {
      for (var n = this.actorManager.userActor.cellId, o = this.mapRenderer.map.cells, s = a.getSpellEffectZone(o, n, e, m.zoneEffect), r = Object.keys(s), l = 0; l < r.length; l++) {
        n = r[l];
        var c = this.actorManager.getActorsOnCell(n);
        if (c.length > 0) {
          var d = c[0],
            h = d.getTeamId();
          0 === h ? this.background.addTargetHighLights(n, d._x, d._y, u.redTeamStart, u.redTeamEnd, !window.foreground.fightIsUserTurn) : this.background.addTargetHighLights(n, d._x, d._y, u.blueTeamStart, u.blueTeamEnd, !window.foreground.fightIsUserTurn);
        }
      }
      t.showDamagePreview && i.preview(m.spellId, e);
      this._resetSpellEffectLayer(s);
    }
  }
};
o.prototype._castSpell = function (e, t, i, n) {
  var o = this.mapRenderer.grid.getNearbyCellInZone(e, t, i, f);
  return null === o ? (window.foreground.deselectSpell(), window.gui.shortcutBar.deselectCurrentSlot(), void this.clearSpellDisplay()) : (this.displayEffectZone(o), window.gui.emit("checkServerLag", "fightAction", "start"), window.gui.fightManager.castSpell(m.spellId, o, n.characterId), m = null, this.clearSpellDisplay(), window.gui.shortcutBar.deselectCurrentSlot(), void window.gui.damagePreview.confirm());
};
o.prototype._castSpellConfirm = function (e, t, i, n) {
  var o = window.gui,
    a = o.damagePreview,
    r = this.mapRenderer.grid.getNearbyCellInZone(e, t, i, f);
  if (null === r) {
    return window.foreground.deselectSpell(), void o.shortcutBar.deselectCurrentSlot();
  }
  this.displayEffectZone(r);
  var l = s(["spell", m.spellId, e, r]),
    c = this;
  window.foreground.confirmBox.open("spell", m, l, {
    startHidden: n.hideConfirmWindow,
    allowDoubleTap: p.confirmBoxAllowDoubleTap
  }, function (e) {
    return e ? (o.emit("checkServerLag", "fightAction", "start"), o.fightManager.castSpell(m.spellId, r, n.characterId), m = null, c.clearSpellDisplay(), o.shortcutBar.deselectCurrentSlot(), void a.confirm()) : (c.clearSpellDisplay(), void o.shortcutBar.deselectCurrentSlot());
  }, function () {
    c.isOutsight(r) ? a.cancel() : a.preview(m.spellId, r, {
      hasConfirmBox: !0
    });
  });
};
o.prototype._castSpellImmediately = function (e) {
  if (f && m) {
    if (null === e) {
      return window.foreground.deselectSpell(), void window.gui.shortcutBar.deselectCurrentSlot();
    }
    window.gui.emit("checkServerLag", "fightAction", "start");
    window.gui.fightManager.castSpell(m.spellId, e, window.gui.playerData.characters.controlledCharacterId);
    this.clearSpellDisplay();
    m = null;
    window.gui.shortcutBar.deselectCurrentSlot();
    window.gui.damagePreview.confirm();
  }
};
o.prototype._castSpellImmediatelyConfirm = function (e) {
  var t = window.gui,
    i = t.damagePreview,
    n = window.foreground;
  if (f && m) {
    if (null === e) {
      return n.deselectSpell(), void t.shortcutBar.deselectCurrentSlot();
    }
    var o = s(["spell", m.spellId, e, e]),
      a = this;
    n.confirmBox.open("spell", m, o, {
      startHidden: !n.fightIsUserTurn
    }, function (n) {
      return n ? (t.emit("checkServerLag", "fightAction", "start"), t.fightManager.castSpell(m.spellId, e, t.playerData.characters.controlledCharacterId), m = null, a.clearSpellDisplay(), t.shortcutBar.deselectCurrentSlot(), void i.confirm()) : (a.clearSpellDisplay(), void t.shortcutBar.deselectCurrentSlot());
    }, function () {
      a.isOutsight(e) ? i.cancel() : i.preview(m.spellId, e, {
        hasConfirmBox: !0
      });
    });
  }
};
o.prototype.displayFightPositions = function (e) {
  for (var t = {}, i = 0, n = 0; n < e.positionsForChallengers.length; n++) {
    var o = e.positionsForChallengers[n];
    t[o] = new d(o, i, u.fullRed);
  }
  for (var a = 0; a < e.positionsForDefenders.length; a++) {
    o = e.positionsForDefenders[a];
    t[o] = new d(o, i, u.fullBlue);
  }
  this._resetFightPositionLayer(t);
};
o.prototype.clearSpellDisplay = function () {
  this.background.removeTargetHighlights();
  this._resetSpellEffectLayer();
  this._resetSpellRangeLayer();
};
this._fightPositionLayer = null;
this._spellRangeLayer = null;
this._spellEffectLayer = null;
this._walkLayer = null;
this._walkAreaLayer = null;
this._enemyWalkAreaLayer = null;
this.background.removeGridLayer(this._fightPositionLayer);
this._fightPositionLayer = e ? this.background.addGridAnimation(e) : null;
this.background.removeGridLayer(this._spellRangeLayer);
this._spellRangeLayer = e ? this.background.addGridAnimation(e) : null;
this.background.removeGridLayer(this._spellEffectLayer);
this._spellEffectLayer = e ? this.background.addGridAnimation(e) : null;
this.background.removeGridLayer(this._walkLayer);
this._walkLayer = e ? this.background.addGridAnimation(e) : null;
this.background.removeGridLayer(this._walkAreaLayer);
this._walkAreaLayer = e ? this.background.addGridAnimation(e) : null;
this.background.removeGridLayer(this._enemyWalkAreaLayer);
this._enemyWalkAreaLayer = e ? this.background.addGridAnimation(e) : null;
l[g] = i[p][2];
s[g] = new d(g, i[p][2], c);
m.castTestLos && n(e, s, t, o);
f = s;
this._resetSpellRangeLayer(s);
this._spellEffectLayer && this._resetSpellEffectLayer(this._spellEffectLayer.cellInfos);
this._walkLayer && (this._resetWalkLayer(), window.foreground.confirmBox.hide(), window.gui.damagePreview.hide());
t.showDamagePreview && i.preview(m.spellId, e);
this._resetSpellEffectLayer(s);
window.gui.emit("checkServerLag", "fightAction", "start");
window.gui.fightManager.castSpell(m.spellId, e, window.gui.playerData.characters.controlledCharacterId);
this.clearSpellDisplay();
m = null;
window.gui.shortcutBar.deselectCurrentSlot();
window.gui.damagePreview.confirm();
o = e.positionsForDefenders[a];
t[o] = new d(o, i, u.fullBlue);
this.background.removeTargetHighlights();
this._resetSpellEffectLayer();
this._resetSpellRangeLayer();
d = Math.abs(r.x - l.x);
c.x = l.x > r.x ? 1 : -1;
c.y = l.y > r.y ? 1 : -1;
s.push({
  x: Math.floor(r.x + c.x),
  y: Math.floor(r.y + c.y)
});
r.x += c.x;
r.y += c.y;
Math.abs(r.x - l.x) > Math.abs(r.y - l.y) && (h = o, p = a);
d = Math.abs(r[h] - l[h]);
c[h] = l[h] >= r[h] ? 1 : -1;
c[p] = l[p] > r[p] ? Math.abs(r[p] - l[p]) / d : -Math.abs(r[p] - l[p]) / d;
r.x += c.x;
r.y += c.y;
_[e] && (console.warn("Fight with id " + e + " already exist."), _[e].remove());
this.id = e;
this.teams = {};
_[e] = this;
o.prototype.addTeam = function (e, t) {
  this.teams[e] = {
    id: e,
    contextualId: n(this.id, e),
    icons: {},
    options: {},
    cellId: t
  };
};
o.prototype.remove = function () {
  for (var e in this.teams) {
    var t = this.teams[e];
    window.actorManager.removeActor(t.contextualId);
    for (var i in t.icons) {
      t.icons[i].remove();
    }
  }
  delete _[this.id];
};
o.prototype._createIcon = function (e, t, i) {
  function n(i) {
    return _[o.id] ? s.icons[t] ? i.release() : (s.icons[t] = new p({
      layer: r.MAP_LAYER_ICONS,
      w: i.element.width,
      h: i.element.height,
      scene: a
    }, i), s.options[t] || s.icons[t].hide(), void o._updateIconsPosition(e)) : i.release();
  }
  var o = this,
    a = window.isoEngine.mapScene,
    s = this.teams[e];
  return s ? g.indexOf(t) === -1 ? console.error(new Error("Unknown fightOption:" + t)) : s.icons[t] ? (console.warn("Icon " + t + " already exists for team " + e + " in fight " + this.id), void s.icons[t].show()) : void h.loadTexture(i, n, a.renderer) : console.error(new Error("No team with id " + e + " in fight " + this.id));
};
o.prototype._updateIconsPosition = function (e) {
  var t = this.teams[e];
  if (!t) {
    return console.error(new Error("No team with id " + e + " in fight " + this.id));
  }
  var i = 0,
    n = 0;
  for (var o in t.icons) {
    t.icons[o].isDisplayed && i++;
    n = Math.max(t.icons[o].w, n);
  }
  var a = .1 * n,
    s = window.isoEngine.mapRenderer.grid.getSceneCoordinateFromCellId(t.cellId),
    l = s.x - (n + a) / 2 * (i - 1),
    c = 0;
  for (o in t.icons) {
    t.icons[o].isDisplayed && (t.icons[o].x = l + c * (n + a) - t.icons[o].w / 2, t.icons[o].y = s.y - 2.1 * r.CELL_HEIGHT, c++);
  }
};
o.prototype.setFightOption = function (e, t, i) {
  var n = this.teams[e];
  if (!n) {
    return console.error(new Error("No team with id " + e + " in fight " + this.id));
  }
  if (void 0 === n.options[t]) {
    return n.options[t] = i, void this._createIcon(e, t, "ui/spectator/fightOption" + t + ".png");
  }
  if (n.options[t] = i, n.icons[t]) {
    var o = i ? "show" : "hide";
    n.icons[t][o]();
    this._updateIconsPosition(e);
  }
};
o.prototype.challengeOptionChange = function (e, t, i) {
  var n = this.teams[e];
  return n ? void (g.indexOf(t) !== -1 && this.setFightOption(e, t, i)) : console.error(new Error("No team with id " + e + " in fight " + this.id));
};
t.icons[o].isDisplayed && i++;
n = Math.max(t.icons[o].w, n);
n.icons[t][o]();
this._updateIconsPosition(e);
s.prototype.showChallenge = function (e) {
  for (var t = this.actorManager, i = e.fightId, s = e.fightTeams, r = e.fightTeamsPositions, l = e.fightTeamsOptions, c = new o(i), d = 0; d < s.length; d++) {
    var u = s[d],
      h = a(e, u);
    u.fightId = i;
    u.look = {
      bonesId: h,
      scales: [100],
      skins: [],
      indexedColors: []
    };
    u.disposition = {
      cellId: r[d],
      direction: 0
    };
    u.contextualId = n(i, u.teamId);
    t.addEmptyActor(u);
    c.addTeam(u.teamId, r[d]);
    t.setActorLook(u.contextualId, u.look, {}, null);
    for (var p in l[d]) {
      void 0 !== f[p] && l[d][p] && c.setFightOption(u.teamId, f[p], !0);
    }
  }
};
s.prototype.addChallenges = function (e) {
  for (var t = 0; t < e.length; t++) {
    this.showChallenge(e[t]);
  }
};
s.prototype.removeChallenge = function (e) {
  var t = _[e];
  return t ? void t.remove() : console.warn("No challenge with id " + e);
};
s.prototype.cleanupChallenges = function () {
  for (var e in _) {
    _[e].remove();
  }
};
s.prototype.challengeOptionChange = function (e, t, i, n) {
  var o = _[e];
  return o ? void o.challengeOptionChange(t, i, n) : console.warn("No challenge with id " + e);
};
s.prototype.updateFightTeam = function (e) {
  if (!m.isFightMode) {
    var t = e.fightId,
      i = e.team;
    i.fightId = t;
    var o = i.teamId,
      a = n(t, o),
      s = this.actorManager.getActor(a);
    return s ? void s.updateData(i) : console.warn("No fight id " + a);
  }
};
u.fightId = i;
u.look = {
  bonesId: h,
  scales: [100],
  skins: [],
  indexedColors: []
};
u.disposition = {
  cellId: r[d],
  direction: 0
};
u.contextualId = n(i, u.teamId);
t.addEmptyActor(u);
c.addTeam(u.teamId, r[d]);
t.setActorLook(u.contextualId, u.look, {}, null);
o.prototype.checkAndConstructAnimType = function (e, t) {
  if (!this.actorManager.isCreatureModeOn && t) {
    if (0 === e.emoteId) {
      return void t.staticAnim();
    }
    var i = e._emote;
    if (i) {
      var n = i.defaultAnim;
      if (n = n.substring(0, 1).toUpperCase() + n.substring(1) + "_0", !i.eight_directions) {
        var o = 2 * ~~(t.direction / 2) + 1;
        o !== t.direction && t.setDisposition(null, o);
      }
      return n;
    }
  }
};
o.prototype.playEmoteFromOption = function (e, t, i) {
  var n = this,
    o = t.emoteId || 0,
    a = this.actorManager.getActor(e);
  if (!a) {
    return i();
  }
  var s = _[o] || window.gui.playerData.emoteData.list[o];
  if (s) {
    if (s.aura) {
      return i();
    }
    this.playEmote({
      actorId: a.actorId,
      emoteId: o,
      _emote: s
    }, i);
  } else {
    m.getDataMap("Emoticons", [o], function (a, s) {
      return a ? i(a) : s[o] ? (_[o] = s[o], n.playEmoteFromOption(e, t, i)) : i();
    });
  }
};
o.prototype.playEmote = function (e, t) {
  t = t || n;
  var i = this.actorManager.getActor(e.actorId),
    o = this.checkAndConstructAnimType(e, i);
  return o ? (i.lastEmoteAnim = e._emote.persistancy ? o : null, void this.actorManager.addToFifo(i.actorId, function (e) {
    e();
    i.loadAndPlayAnimation({
      base: "AnimEmote",
      type: o
    }, {
      loop: !1,
      isEmoteAnimated: !0
    }, t);
  })) : t();
};
o.prototype.playRelookedEmote = function (e) {
  var t = this;
  window.actorManager.setActorLook(e.actorId, e.look, {
    noSmokeAnimation: !0
  }, function () {
    t.playEmote(e);
  });
};
o.prototype.playLevelUpAnimation = function (e) {
  var t = this.actorManager.getActor(e);
  if (t) {
    var i,
      n = t.look;
    if (n && n.skins && n.skins[0]) {
      var o = n.skins[0];
      i = (1 & o).toString();
    } else {
      i = Math.random() < .5 ? "0" : "1";
    }
    var a;
    if (n && 1 === n.bonesId) {
      a = "AnimEmoteInterface_" + i;
    } else if (t.isRiding) {
      var s = l.getLookOfRider(n);
      s && 2 === s.bonesId && (a = "AnimLevelUpRiding");
    }
    a && t.loadAndPlayAnimation({
      base: a,
      direction: 1
    }, {
      loop: !1
    });
    c("LEVEL_UP");
    var r = t.x,
      p = t.y,
      m = "LEVEL UP",
      _ = this.bitmapFonts.characters,
      v = new h({
        x: r,
        y: p,
        scene: this.mapScene,
        text: m,
        fallbackText: m,
        layer: d.MAP_LAYER_POINT_LABELS,
        bitmapFont: _,
        color: [.3, .5, -.1, 0]
      });
    v.scaleX = .7;
    v.scaleY = .7;
    new f(v, ["y", "alpha"]).from({
      y: p,
      alpha: 0
    }).to({
      y: p,
      alpha: 0
    }, 9).to({
      y: p - 40,
      alpha: 1
    }, 8, g.backOut, 2).to({
      y: p - 40,
      alpha: 1
    }, 16).to({
      y: p - 90,
      alpha: 0
    }, 12, g.backIn, 2).onFinish(function () {
      v.remove();
    }).start();
    var y = new u(t.position, r, p);
    y.red = 1;
    y.green = 1;
    y.blue = .9;
    new f(y, ["scaleX", "scaleY", "alpha"]).from({
      scaleX: .3,
      scaleY: .3,
      alpha: 0
    }).to({
      scaleX: 1,
      scaleY: 1,
      alpha: 1.7
    }, 7, g.polyOut, 4).to({
      scaleX: .3,
      scaleY: 1,
      alpha: 1.7
    }, 20, g.polyOut, 2).to({
      scaleX: .3,
      scaleY: 1,
      alpha: 0
    }, 7, g.polyOut, 2).onFinish(function () {
      y.remove();
    }).start();
  }
};
o.prototype.playRoleplaySpellAnim = function (e, t) {
  var i = new s();
  i.runSequence([e], function () {
    var i = [];
    r(e, i);
    a.series(i, t);
  });
};
e();
i.loadAndPlayAnimation({
  base: "AnimEmote",
  type: o
}, {
  loop: !1,
  isEmoteAnimated: !0
}, t);
a && t.loadAndPlayAnimation({
  base: a,
  direction: 1
}, {
  loop: !1
});
c("LEVEL_UP");
v.scaleX = .7;
v.scaleY = .7;
new f(v, ["y", "alpha"]).from({
  y: p,
  alpha: 0
}).to({
  y: p,
  alpha: 0
}, 9).to({
  y: p - 40,
  alpha: 1
}, 8, g.backOut, 2).to({
  y: p - 40,
  alpha: 1
}, 16).to({
  y: p - 90,
  alpha: 0
}, 12, g.backIn, 2).onFinish(function () {
  v.remove();
}).start();
y.red = 1;
y.green = 1;
y.blue = .9;
new f(y, ["scaleX", "scaleY", "alpha"]).from({
  scaleX: .3,
  scaleY: .3,
  alpha: 0
}).to({
  scaleX: 1,
  scaleY: 1,
  alpha: 1.7
}, 7, g.polyOut, 4).to({
  scaleX: .3,
  scaleY: 1,
  alpha: 1.7
}, 20, g.polyOut, 2).to({
  scaleX: .3,
  scaleY: 1,
  alpha: 0
}, 7, g.polyOut, 2).onFinish(function () {
  y.remove();
}).start();
r(e, i);
a.series(i, t);
r = s * o + n;
l = r < 100 ? " " : "";
l += r;
l += r < 10 ? " " : "";
u += p ? "%c" + l + "%c├───┤" : "───┤%c" + l + "%c├";
t[r] ? h.push("background-color: #FF0") : c && 2 !== (2 & c.cells[r].l) ? h.push("background-color: #00F") : c && 0 === (1 & c.cells[r].l) ? h.push("background-color: #113; color: #779") : d.cellId === r ? h.push("background-color: #CD8; color: #072") : this.actorManager.getActorsOnCell(r).length > 0 ? h.push("background-color: #F88") : h.push("background-color: #FFF");
h.push("background-color: #FFF, color: #000");
h.unshift(u);
console.log.apply(window.console, h);
this.progressEgg = new f({
  scene: e,
  position: 5,
  alpha: 1,
  x: e.w / 2,
  y: e.h / 2,
  isHudElement: !0,
  id: "loadingProgressEgg"
});
this.progressEgg.setAnimManager(new g(this.progressEgg, new _(""), 1.7, 0));
this.progressEggFrameTween = new h(this.progressEgg.animManager, ["frame"]);
this.hide();
c.sx += i;
s[l] = c;
n.prototype.loadAssets = function (e) {
  var t = this.progressEgg.animManager,
    i = this.progressEgg.renderer;
  u.loadTemplate("loader", "loadingLogo", "", function (i) {
    t.template = i;
    t.assignSymbol({
      base: "loadeur",
      direction: -1
    }, !1);
    t.tween.stop();
    t.frame = 0;
    e();
  }, i, "archivable");
};
n.prototype.hide = function () {
  this.progressEgg.hide();
  this.progressEgg.animManager.clear();
};
n.prototype.show = function () {
  this.progressEgg.show();
};
r.prototype._initLoadingProgress = function () {
  this._loadingProgress = new n(this.mapScene);
  this._resetTransition();
};
r.prototype._resetTransition = function () {
  this._loadingFadeInTransitionRunning = !1;
  this._loadingProgressVisible = !1;
  this._waitingForMessage = !1;
  this._mapLoadingMessage = null;
  this._isMapLoading = !1;
  this._mapSceneTransitionGraphic = null;
};
r.prototype.showLoadingProgress = function (e) {
  var t = this._loadingProgress.progressEgg,
    i = t.animManager.nbFrames;
  this._loadingProgressVisible === !1 ? (this._loadingProgressVisible = !0, t.x = this.mapScene.w / 2, t.y = this.mapScene.h / 2, this._loadingProgress.show(), this._loadingProgress.progressEggFrameTween.reset().from({
    frame: 0
  }).to({
    frame: .4 * i
  }, 30, p.polyIn, 2).start()) : this._loadingProgress.progressEggFrameTween.reset().from({
    frame: t.animManager.frame
  }).to({
    frame: (.7 * e + .4) * i
  }, 5).start();
};
r.prototype._hideLoadingProgress = function () {
  this._loadingProgressVisible = !1;
  this._loadingProgress.hide();
};
r.prototype.mapTransitionDisconnect = function () {
  this._mapSceneTransitionGraphic && (this._mapSceneTransitionGraphic.remove(), this._resetTransition());
};
r.prototype._makeUserActorWalkInDirection = function (e, t) {
  this.makeActorWalkInDirection(this.actorManager.userActor, e, t);
};
r.prototype.makeActorWalkInDirection = function (e, t, i, n) {
  if (e) {
    var o;
    switch (t) {
      case "top":
        o = 6;
        break;
      case "bottom":
        o = 2;
        break;
      case "left":
        o = 4;
        break;
      case "right":
        o = 0;
        break;
      default:
        o = 0;
    }
    var a = s.ANGLE_PER_DIRECTION[o];
    i && (a += Math.PI);
    var r = Math.cos(a) * b,
      l = Math.sin(a) * b;
    e.walkToSceneCoordinate(e.x + r, e.y + l, o, M, n);
  } else if (console.error(new Error("makeActorWalkInDirection: actor is " + e)), n) {
    return n();
  }
};
r.prototype.launchMapTransition = function (e) {
  var t = this;
  this._loadingProgress.loadAssets(function () {
    t.mapScene.setShader("mapTransition");
    t.emit("launchMapTransition", e);
    t._activateMapScene() ? (t._loadingProgress.progressEgg.alpha = 1, t.mapScene.renderingParams.ratio = 1, t._saveImageForTransition("black"), t._startLoading()) : t._loadingFadeInTransitionRunning === !1 && (t._isMapLoading ? t._startLoading() : (e && t._makeUserActorWalkInDirection(e, !1), t._runLoadingFadeInTransition()));
  });
};
r.prototype.cancelMapTransition = function (e) {
  this.emit("cancelMapTransition", e);
  this.actorManager.userActor.setOnScreenPosition(this.actorManager.userActor.position);
  this._makeUserActorWalkInDirection(e, !0);
  this._waitingForMessage && this._runLoadingFadeOutTransition();
  this._mapLoadingMessage = null;
  this._waitingForMessage = !1;
};
r.prototype._saveImageForTransition = function (e) {
  var t = w,
    i = t * this.mapScene.h / this.mapScene.w,
    n = this.mapScene.renderer,
    o = n.startTextureUsage(t, i, 1, null, "linear");
  if (n.startTextureRendering(o, 0, t, 0, i, !1), "black" === e) {
    this.mapScene.clear(0, 0, 0, 1);
  } else {
    var a = t / this.mapScene.w;
    n.save();
    n.scale(a, a);
    this.mapScene.render();
    n.restore();
  }
  var s = !0;
  n.stopTextureRendering(s);
  null === this._mapSceneTransitionGraphic ? this._mapSceneTransitionGraphic = new m({
    w: this.mapScene.w,
    h: this.mapScene.h,
    scene: this.mapScene,
    position: 0,
    isHudElement: !0,
    alpha: 1
  }, o.texture) : (this._mapSceneTransitionGraphic.clear(), this._mapSceneTransitionGraphic.texture = o.texture, this._mapSceneTransitionGraphic.show());
};
r.prototype._runLoadingFadeInTransition = function () {
  this._loadingFadeInTransitionRunning = !0;
  this._waitingForMessage = !0;
  this.showLoadingProgress(0);
  new h(this._loadingProgress.progressEgg, ["alpha", "scaleX", "scaleY"]).from({
    alpha: 0,
    scaleX: .8,
    scaleY: .8
  }).to({
    alpha: 1,
    scaleX: 1,
    scaleY: 1
  }, 15, p.backOut, 1.5).start();
  this.mapScene.renderingParams.ratio = 0;
  var e = this;
  new h(this.mapScene.renderingParams, ["ratio"]).from({
    ratio: 0
  }).to({
    ratio: 1
  }, 15, p.polyInOut, 3).start().onFinish(function () {
    e._saveImageForTransition("current");
    e._loadingFadeInTransitionRunning = !1;
    e._startLoading();
  });
};
r.prototype._runLoadingFadeOutTransition = function () {
  var e = this,
    t = this.mapScene;
  new h(this._loadingProgress.progressEgg, ["alpha", "scaleX", "scaleY"]).from({
    alpha: 1,
    scaleX: 1,
    scaleY: 1
  }).to({
    alpha: 0,
    scaleX: .8,
    scaleY: .8
  }, 10, p.backIn, 1.5).start();
  new h(this._mapSceneTransitionGraphic, ["alpha"]).from({
    alpha: 1
  }).to({
    alpha: 0
  }, 10).onFinish(function () {
    null !== e._mapSceneTransitionGraphic && (e._mapSceneTransitionGraphic.remove(), e._mapSceneTransitionGraphic = null);
  }).start();
  new h(t.renderingParams, ["ratio"]).from({
    ratio: 1
  }).to({
    ratio: 0
  }, 25, p.polyInOut, 2).onFinish(function () {
    t.setShader("unfiltering");
    t.renderingParams.ratio = .15;
    e._hideLoadingProgress();
  }).start();
  y.isRoleplayMode && this.makeActorWalkIn(this.actorManager.userActor);
};
r.prototype.makeActorWalkIn = function (e, t, i) {
  t = t || 100;
  var n,
    o = this.mapScene,
    a = e.x,
    r = e.y,
    l = Math.abs(o.l - a),
    c = Math.abs(o.l + o.w - a),
    d = Math.abs(o.t - r),
    u = Math.abs(o.t + o.h - r),
    h = l < t,
    p = c < t,
    m = d < t,
    f = u < t;
  if (h) {
    n = m ? 1 : f ? 7 : 0;
  } else if (p) {
    n = m ? 3 : f ? 5 : 4;
  } else if (m) {
    n = 2;
  } else {
    if (!f) {
      return;
    }
    n = 6;
  }
  var g = s.ANGLE_PER_DIRECTION[n];
  e.x -= Math.cos(g) * b;
  e.y -= Math.sin(g) * b;
  e.walkToSceneCoordinate(a, r, n, M, i);
};
r.prototype.loadMap = function (e) {
  this.changeMapTimeout ? (window.clearTimeout(this.changeMapTimeout), this.changeMapTimeout = null) : window.foreground.lock("loadMap");
  this._mapLoadingMessage = e;
  this._loadingFadeInTransitionRunning === !1 && (this._waitingForMessage ? this._startLoading() : this.launchMapTransition());
};
r.prototype.reloadMap = function (e) {
  var t = this;
  return this.mapRenderer.isReady ? (this._updateMapInfoData(e, {
    noMovementWaitReset: !0
  }), window.foreground.show(), window.foreground.unlock("loadMap"), this.actorManager.updateMapInfoData(e, function () {
    t.emit("actorLoaded");
  }), this.emit("mapLoaded", {
    isReload: !0
  }), void (this.interactiveBlink && this.highlightInteractivesWithDifferentType())) : void this.mapRenderer.once("ready", function () {
    t.reloadMap(e);
  });
};
t.template = i;
t.assignSymbol({
  base: "loadeur",
  direction: -1
}, !1);
t.tween.stop();
t.frame = 0;
e();
this.progressEgg.hide();
this.progressEgg.animManager.clear();
this._loadingProgress = new n(this.mapScene);
this._resetTransition();
this._loadingFadeInTransitionRunning = !1;
this._loadingProgressVisible = !1;
this._waitingForMessage = !1;
this._mapLoadingMessage = null;
this._isMapLoading = !1;
this._mapSceneTransitionGraphic = null;
this._loadingProgressVisible = !1;
this._loadingProgress.hide();
t.mapScene.setShader("mapTransition");
t.emit("launchMapTransition", e);
t._activateMapScene() ? (t._loadingProgress.progressEgg.alpha = 1, t.mapScene.renderingParams.ratio = 1, t._saveImageForTransition("black"), t._startLoading()) : t._loadingFadeInTransitionRunning === !1 && (t._isMapLoading ? t._startLoading() : (e && t._makeUserActorWalkInDirection(e, !1), t._runLoadingFadeInTransition()));
this.emit("cancelMapTransition", e);
this.actorManager.userActor.setOnScreenPosition(this.actorManager.userActor.position);
this._makeUserActorWalkInDirection(e, !0);
this._waitingForMessage && this._runLoadingFadeOutTransition();
this._mapLoadingMessage = null;
this._waitingForMessage = !1;
n.save();
n.scale(a, a);
this.mapScene.render();
n.restore();
n.stopTextureRendering(s);
null === this._mapSceneTransitionGraphic ? this._mapSceneTransitionGraphic = new m({
  w: this.mapScene.w,
  h: this.mapScene.h,
  scene: this.mapScene,
  position: 0,
  isHudElement: !0,
  alpha: 1
}, o.texture) : (this._mapSceneTransitionGraphic.clear(), this._mapSceneTransitionGraphic.texture = o.texture, this._mapSceneTransitionGraphic.show());
this._loadingFadeInTransitionRunning = !0;
this._waitingForMessage = !0;
this.showLoadingProgress(0);
new h(this._loadingProgress.progressEgg, ["alpha", "scaleX", "scaleY"]).from({
  alpha: 0,
  scaleX: .8,
  scaleY: .8
}).to({
  alpha: 1,
  scaleX: 1,
  scaleY: 1
}, 15, p.backOut, 1.5).start();
this.mapScene.renderingParams.ratio = 0;
e._saveImageForTransition("current");
e._loadingFadeInTransitionRunning = !1;
e._startLoading();
new h(this._loadingProgress.progressEgg, ["alpha", "scaleX", "scaleY"]).from({
  alpha: 1,
  scaleX: 1,
  scaleY: 1
}).to({
  alpha: 0,
  scaleX: .8,
  scaleY: .8
}, 10, p.backIn, 1.5).start();
new h(this._mapSceneTransitionGraphic, ["alpha"]).from({
  alpha: 1
}).to({
  alpha: 0
}, 10).onFinish(function () {
  null !== e._mapSceneTransitionGraphic && (e._mapSceneTransitionGraphic.remove(), e._mapSceneTransitionGraphic = null);
}).start();
new h(t.renderingParams, ["ratio"]).from({
  ratio: 1
}).to({
  ratio: 0
}, 25, p.polyInOut, 2).onFinish(function () {
  t.setShader("unfiltering");
  t.renderingParams.ratio = .15;
  e._hideLoadingProgress();
}).start();
y.isRoleplayMode && this.makeActorWalkIn(this.actorManager.userActor);
t.setShader("unfiltering");
t.renderingParams.ratio = .15;
e._hideLoadingProgress();
e.x -= Math.cos(g) * b;
e.y -= Math.sin(g) * b;
e.walkToSceneCoordinate(a, r, n, M, i);
this.changeMapTimeout ? (window.clearTimeout(this.changeMapTimeout), this.changeMapTimeout = null) : window.foreground.lock("loadMap");
this._mapLoadingMessage = e;
this._loadingFadeInTransitionRunning === !1 && (this._waitingForMessage ? this._startLoading() : this.launchMapTransition());
r.prototype._startLoading = function () {
  var e = this._mapLoadingMessage;
  if (null !== e) {
    this._mapLoadingMessage = null;
    this._waitingForMessage = !1;
    this.emit("mapChange", e);
    this.actorManager.userActor.staticAnim();
    this.actorManager.pause();
    var t = e.mapId,
      i = e.obstacleMapId;
    if (t !== C) {
      this.releaseMap(C);
      C = t;
      this._isMapLoading = !0;
      var n = this,
        r = s.MAP_PATH + i + ".json",
        l = s.MAP_PATH + t + ".json",
        u = null,
        h = null;
      c.series([function (e) {
        return i ? void d.loadJson(r, function (t) {
          return u = t, e();
        }) : e();
      }, function (e) {
        d.loadJson(l, function (t) {
          return h = t, u && (h.obstacleMapId = i, h.cells = u.cells, h.midgroundLayer = o(h.midgroundLayer, u.midgroundLayer), h.atlasLayout = a(h.atlasLayout, u.atlasLayout)), e();
        });
      }], function (t) {
        return t ? window.dofus.disconnect("LOADING_MAP_ERROR " + t) : h === s.EMPTY_JSON ? window.dofus.disconnect("ASSET_MISSING") : void (h.id === C && (null === T ? (T = {
          msg: e,
          mapData: h
        }, n._loadMapAssets()) : T = {
          msg: e,
          mapData: h
        }));
      });
    }
  }
};
r.prototype._loadMapAssets = function () {
  var e = T.msg,
    t = T.mapData,
    i = this;
  this.mapRenderer.setMap(T, function () {
    return null !== T && C !== t.id ? void i._loadMapAssets() : (window.foreground.show(), window.foreground.unlock("loadMap"), l.fillPathGrid(t), i._updateMapInfoData(e), i.actorManager.updateMapInfoData(e, function () {
      i.emit("actorLoaded");
    }), i.actorManager.unpause(), i.actorManager.userActor.moving = !1, v.unlockMessages(), i.emit("mapLoaded"), i._runLoadingFadeOutTransition(), i.interactiveBlink && i.highlightInteractivesWithDifferentType(), C = null, T = null, void (i._isMapLoading = !1));
  });
};
this._mapLoadingMessage = null;
this._waitingForMessage = !1;
this.emit("mapChange", e);
this.actorManager.userActor.staticAnim();
this.actorManager.pause();
this.releaseMap(C);
C = t;
this._isMapLoading = !0;